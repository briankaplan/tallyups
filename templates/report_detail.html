<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="Tallyups Report Detail - View and edit expense report">
<meta name="theme-color" content="#0b0d10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Report Detail - Tallyups</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
<!-- Legendary Design System -->
<link rel="stylesheet" href="/static/css/legendary/index.css">
<script src="/static/js/unified-header.js"></script>
<script src="/static/js/design-system.js"></script>
<script src="/static/js/app-shell.js" defer></script>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REPORT DETAIL PAGE - Legendary Design System
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

body {
  padding-top: var(--header-height, 60px);
  padding-bottom: calc(80px + var(--safe-bottom, 0px));
}

/* Page Container */
.report-page {
  min-height: 100vh;
  background: var(--bg-primary);
}

.report-container {
  max-width: 1600px;
  margin: 0 auto;
  padding: var(--space-6);
}

/* Page Header with Stats */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-6);
  padding: var(--space-5) var(--space-6);
  background: var(--glass-subtle);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-2xl);
  margin-bottom: var(--space-6);
  flex-wrap: wrap;
}

.header-left {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  flex: 1;
  min-width: 0;
}

.back-link {
  display: inline-flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-2) var(--space-4);
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  color: var(--text-secondary);
  font-size: var(--text-sm);
  font-weight: var(--weight-medium);
  text-decoration: none;
  transition: all var(--duration-fast) var(--ease-out);
}

.back-link:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
  border-color: var(--brand-primary);
}

.back-link svg {
  width: 16px;
  height: 16px;
}

.report-title {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  font-size: var(--text-xl);
  font-weight: var(--weight-bold);
  color: var(--brand-primary);
  margin: 0;
}

.report-title svg {
  width: 24px;
  height: 24px;
  opacity: 0.8;
}

/* Stats Row */
.header-stats {
  display: flex;
  gap: var(--space-6);
  flex-wrap: wrap;
}

.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-1);
  padding: var(--space-3) var(--space-4);
  background: var(--bg-secondary);
  border-radius: var(--radius-xl);
  min-width: 80px;
}

.stat-value {
  font-family: var(--font-display);
  font-size: var(--text-xl);
  font-weight: var(--weight-bold);
  color: var(--text-primary);
  line-height: 1;
}

.stat-value.highlight {
  color: var(--brand-primary);
}

.stat-label {
  font-size: var(--text-xs);
  font-weight: var(--weight-medium);
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: var(--tracking-wide);
}

/* Header Actions */
.header-actions {
  display: flex;
  gap: var(--space-3);
}

/* Toolbar */
.toolbar {
  display: flex;
  gap: var(--space-3);
  margin-bottom: var(--space-5);
  flex-wrap: wrap;
  align-items: center;
}

.toolbar-spacer {
  flex: 1;
}

/* Progress Bar */
.progress-container {
  display: none;
  align-items: center;
  gap: var(--space-3);
}

.progress-container.active {
  display: flex;
}

.progress-bar {
  width: 200px;
  height: 6px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
  border-radius: var(--radius-full);
  transition: width var(--duration-base) var(--ease-out);
}

.progress-text {
  font-size: var(--text-sm);
  color: var(--text-secondary);
  font-weight: var(--weight-medium);
}

/* Expense Table */
.table-container {
  background: var(--bg-elevated);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-2xl);
  overflow: hidden;
}

.expense-table {
  width: 100%;
  border-collapse: collapse;
}

.expense-table th,
.expense-table td {
  padding: var(--space-3) var(--space-4);
  text-align: left;
  border-bottom: 1px solid var(--border-secondary);
}

.expense-table th {
  background: var(--bg-tertiary);
  color: var(--text-tertiary);
  font-size: var(--text-xs);
  font-weight: var(--weight-semibold);
  text-transform: uppercase;
  letter-spacing: var(--tracking-wide);
  position: sticky;
  top: 0;
  z-index: 10;
}

.expense-table tbody tr {
  transition: background var(--duration-fast) var(--ease-out);
}

.expense-table tbody tr:hover {
  background: rgba(0, 255, 163, 0.03);
}

.expense-table tbody tr.selected {
  background: rgba(0, 255, 163, 0.08);
}

.expense-table tbody tr:last-child td {
  border-bottom: none;
}

/* Column styles */
.col-check {
  width: 48px;
  text-align: center;
}

.row-check {
  width: 18px;
  height: 18px;
  accent-color: var(--brand-primary);
  cursor: pointer;
}

.col-receipt {
  width: 60px;
  text-align: center;
}

.receipt-thumb {
  width: 44px;
  height: 44px;
  object-fit: cover;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-primary);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
}

.receipt-thumb:hover {
  transform: scale(1.08);
  border-color: var(--brand-primary);
  box-shadow: var(--shadow-md);
}

.no-receipt {
  width: 44px;
  height: 44px;
  border-radius: var(--radius-lg);
  background: var(--bg-tertiary);
  border: 1px dashed var(--border-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
}

.no-receipt:hover {
  border-color: var(--brand-primary);
  background: rgba(0, 255, 163, 0.08);
}

.no-receipt svg {
  width: 20px;
  height: 20px;
  stroke: var(--text-tertiary);
}

.col-date {
  width: 100px;
  white-space: nowrap;
  color: var(--text-secondary);
  font-size: var(--text-sm);
}

.col-description {
  min-width: 200px;
  font-weight: var(--weight-medium);
  color: var(--text-primary);
}

.col-amount {
  width: 110px;
  text-align: right;
  font-family: var(--font-mono);
  font-weight: var(--weight-semibold);
  font-size: var(--text-base);
}

.col-amount.negative {
  color: var(--error);
}

.col-amount.positive {
  color: var(--success);
}

.col-category {
  width: 130px;
}

.category-badge {
  display: inline-block;
  padding: var(--space-1) var(--space-3);
  background: var(--bg-tertiary);
  border-radius: var(--radius-full);
  font-size: var(--text-xs);
  font-weight: var(--weight-medium);
  color: var(--text-secondary);
}

.col-note {
  min-width: 280px;
}

/* AI Note */
.ai-note {
  display: flex;
  align-items: flex-start;
  gap: var(--space-2);
}

.ai-note-text {
  flex: 1;
  font-size: var(--text-sm);
  line-height: var(--leading-relaxed);
  color: var(--text-primary);
}

.ai-note-text.empty {
  color: var(--text-tertiary);
  font-style: italic;
}

/* Inline Edit */
.inline-edit {
  flex: 1;
  display: none;
}

.inline-edit.active {
  display: block;
}

.inline-edit textarea {
  width: 100%;
  min-height: 64px;
  padding: var(--space-3);
  background: var(--bg-primary);
  border: 1px solid var(--brand-primary);
  border-radius: var(--radius-lg);
  color: var(--text-primary);
  font-family: inherit;
  font-size: var(--text-sm);
  line-height: var(--leading-relaxed);
  resize: vertical;
  transition: box-shadow var(--duration-fast) var(--ease-out);
}

.inline-edit textarea:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 255, 163, 0.2);
}

.inline-edit-actions {
  display: flex;
  gap: var(--space-2);
  margin-top: var(--space-2);
}

.inline-edit-btn {
  padding: var(--space-1-5) var(--space-3);
  border-radius: var(--radius-md);
  font-size: var(--text-xs);
  font-weight: var(--weight-semibold);
  cursor: pointer;
  border: none;
  transition: all var(--duration-fast) var(--ease-out);
}

.inline-edit-btn.save {
  background: var(--brand-primary);
  color: #000;
}

.inline-edit-btn.save:hover {
  background: var(--brand-primary-400);
}

.inline-edit-btn.cancel {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
}

.inline-edit-btn.cancel:hover {
  background: var(--bg-hover);
}

/* Note Actions */
.note-actions {
  display: flex;
  gap: var(--space-1);
  flex-shrink: 0;
}

.note-action {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-md);
  background: transparent;
  border: 1px solid transparent;
  color: var(--text-tertiary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--duration-fast) var(--ease-out);
}

.note-action:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
  border-color: var(--border-primary);
}

.note-action.generate:hover {
  background: rgba(91, 127, 255, 0.15);
  color: var(--brand-secondary);
  border-color: var(--brand-secondary);
}

.note-action svg {
  width: 16px;
  height: 16px;
}

/* Status Badge */
.col-status {
  width: 80px;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: var(--space-1);
  padding: var(--space-1) var(--space-2-5);
  border-radius: var(--radius-full);
  font-size: var(--text-xs);
  font-weight: var(--weight-semibold);
  text-transform: uppercase;
  letter-spacing: var(--tracking-wide);
}

.status-badge.good {
  background: var(--success-dim);
  color: var(--success);
}

.status-badge.pending {
  background: var(--warning-dim);
  color: var(--warning);
}

.status-badge.missing {
  background: var(--error-dim);
  color: var(--error);
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: var(--space-16);
  color: var(--text-tertiary);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: var(--space-4);
  opacity: 0.5;
}

.empty-state-text {
  font-size: var(--text-lg);
  margin-bottom: var(--space-6);
}

/* Loading */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-secondary);
  border-top-color: var(--brand-primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Bottom Bar */
.bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: calc(70px + var(--safe-bottom, 0px));
  padding-bottom: var(--safe-bottom, 0px);
  background: var(--glass-strong);
  backdrop-filter: var(--blur-lg);
  -webkit-backdrop-filter: var(--blur-lg);
  border-top: 1px solid var(--border-primary);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-left: var(--space-6);
  padding-right: var(--space-6);
  z-index: var(--z-sticky);
}

.selected-count {
  font-size: var(--text-sm);
  color: var(--text-secondary);
}

.selected-count strong {
  color: var(--brand-primary);
  font-weight: var(--weight-bold);
}

.bottom-actions {
  display: flex;
  gap: var(--space-3);
}

/* Modal Overlay */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: var(--blur-lg);
  -webkit-backdrop-filter: var(--blur-lg);
  z-index: var(--z-modal);
  display: none;
  align-items: center;
  justify-content: center;
  padding: var(--space-6);
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: var(--bg-elevated);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-2xl);
  width: 100%;
  max-width: 800px;
  max-height: 85vh;
  overflow-y: auto;
  animation: modalIn 0.3s var(--ease-spring);
}

@keyframes modalIn {
  from { transform: scale(0.95) translateY(10px); opacity: 0; }
  to { transform: scale(1) translateY(0); opacity: 1; }
}

.modal-header {
  padding: var(--space-5) var(--space-6);
  border-bottom: 1px solid var(--border-secondary);
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  background: var(--bg-elevated);
  z-index: 10;
}

.modal-title {
  font-size: var(--text-lg);
  font-weight: var(--weight-bold);
  color: var(--brand-primary);
}

.modal-close {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
}

.modal-close:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.modal-body {
  padding: var(--space-6);
}

.modal-footer {
  padding: var(--space-4) var(--space-6);
  border-top: 1px solid var(--border-secondary);
  display: flex;
  justify-content: flex-end;
  gap: var(--space-3);
  position: sticky;
  bottom: 0;
  background: var(--bg-elevated);
}

/* Receipt Picker */
.receipt-picker-search {
  display: flex;
  gap: var(--space-3);
  margin-bottom: var(--space-5);
}

.receipt-picker-search input {
  flex: 1;
  padding: var(--space-3) var(--space-4);
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  color: var(--text-primary);
  font-size: var(--text-sm);
  transition: all var(--duration-fast) var(--ease-out);
}

.receipt-picker-search input:focus {
  outline: none;
  border-color: var(--brand-primary);
  box-shadow: 0 0 0 3px rgba(0, 255, 163, 0.15);
}

.receipt-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: var(--space-4);
  max-height: 400px;
  overflow-y: auto;
}

.receipt-card {
  background: var(--bg-secondary);
  border: 2px solid var(--border-primary);
  border-radius: var(--radius-xl);
  padding: var(--space-3);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
}

.receipt-card:hover {
  border-color: var(--brand-primary);
  transform: translateY(-2px);
}

.receipt-card.selected {
  border-color: var(--brand-primary);
  background: rgba(0, 255, 163, 0.08);
}

.receipt-card-img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-2);
  background: var(--bg-tertiary);
}

.receipt-card-info {
  font-size: var(--text-xs);
}

.receipt-card-merchant {
  font-weight: var(--weight-semibold);
  color: var(--text-primary);
  margin-bottom: var(--space-1);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.receipt-card-details {
  color: var(--text-tertiary);
  display: flex;
  justify-content: space-between;
}

/* Receipt Preview */
.receipt-preview {
  text-align: center;
}

.receipt-preview img {
  max-width: 100%;
  max-height: 70vh;
  border-radius: var(--radius-xl);
  border: 1px solid var(--border-primary);
}

/* Toast Container */
.toast-container {
  position: fixed;
  bottom: calc(80px + var(--safe-bottom, 0px));
  right: var(--space-6);
  z-index: var(--z-toast);
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.toast {
  background: var(--bg-elevated);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-xl);
  padding: var(--space-3) var(--space-5);
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: var(--space-3);
  animation: slideIn 0.3s var(--ease-spring);
  max-width: 400px;
}

.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--error); }
.toast.warning { border-color: var(--warning); }
.toast.info { border-color: var(--brand-secondary); }

@keyframes slideIn {
  from { transform: translateX(100px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .report-container {
    padding: var(--space-4);
  }

  .page-header {
    flex-direction: column;
    align-items: stretch;
    gap: var(--space-4);
    padding: var(--space-4);
  }

  .header-left {
    flex-wrap: wrap;
  }

  .header-stats {
    justify-content: center;
  }

  .header-actions {
    justify-content: center;
  }

  .toolbar {
    flex-direction: column;
    align-items: stretch;
  }

  .table-container {
    overflow-x: auto;
  }

  .expense-table {
    min-width: 900px;
  }

  .bottom-bar {
    flex-direction: column;
    height: auto;
    padding: var(--space-4);
    gap: var(--space-3);
  }

  .bottom-actions {
    width: 100%;
    justify-content: center;
  }
}
</style>
</head>
<body>

<!-- Main Content -->
<main class="report-page">
  <div class="report-container">

    <!-- Page Header with Stats -->
    <header class="page-header">
      <div class="header-left">
        <a href="/reports-dashboard" class="back-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Reports
        </a>
        <h1 class="report-title" id="report-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
          </svg>
          <span id="report-name">Loading...</span>
        </h1>
      </div>

      <div class="header-stats">
        <div class="stat-item">
          <span class="stat-value" id="stat-count">0</span>
          <span class="stat-label">Expenses</span>
        </div>
        <div class="stat-item">
          <span class="stat-value highlight" id="stat-total">$0.00</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-receipts">0%</span>
          <span class="stat-label">Receipts</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="stat-notes">0%</span>
          <span class="stat-label">Notes</span>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn btn-outline" onclick="exportReport('excel')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Export
        </button>
      </div>
    </header>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn btn-secondary" id="auto-notes-btn" onclick="generateAllNotes()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"/>
          <path d="M2 17l10 5 10-5"/>
          <path d="M2 12l10 5 10-5"/>
        </svg>
        Auto AI Notes
      </button>
      <button class="btn btn-ghost" onclick="selectAll()">Select All</button>
      <button class="btn btn-ghost" onclick="selectNone()">Clear</button>

      <div class="toolbar-spacer"></div>

      <div class="progress-container" id="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <span class="progress-text" id="progress-text"></span>
      </div>
    </div>

    <!-- Expense Table -->
    <div class="table-container">
      <table class="expense-table" id="expense-table">
        <thead>
          <tr>
            <th class="col-check"><input type="checkbox" id="check-all" onchange="toggleAll(this)"></th>
            <th class="col-receipt">Receipt</th>
            <th class="col-date">Date</th>
            <th>Description</th>
            <th class="col-amount">Amount</th>
            <th class="col-category">Category</th>
            <th class="col-note">AI Note</th>
            <th class="col-status">Status</th>
          </tr>
        </thead>
        <tbody id="expense-tbody">
          <tr>
            <td colspan="8" class="empty-state">
              <div class="loading-spinner"></div>
              <p style="margin-top: 12px;">Loading expenses...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</main>

<!-- Bottom Actions Bar -->
<div class="bottom-bar">
  <div class="selected-count">
    <strong id="selected-count">0</strong> selected
  </div>
  <div class="bottom-actions">
    <button class="btn btn-secondary" onclick="generateSelectedNotes()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
        <path d="M2 17l10 5 10-5"/>
        <path d="M2 12l10 5 10-5"/>
      </svg>
      Generate Notes
    </button>
    <button class="btn btn-ghost" onclick="removeSelected()">Remove from Report</button>
  </div>
</div>

<!-- Receipt Picker Modal -->
<div class="modal-overlay" id="receipt-picker-modal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Attach Receipt</h3>
      <button class="modal-close" onclick="closeReceiptPicker()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="receipt-picker-search">
        <input type="text" id="receipt-search" placeholder="Search by merchant, amount, or date..." oninput="searchReceipts()">
        <button class="btn btn-outline" onclick="loadMatchingReceipts()">Find Best Match</button>
      </div>
      <div class="receipt-grid" id="receipt-grid">
        <!-- Receipts will be loaded here -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeReceiptPicker()">Cancel</button>
      <button class="btn btn-primary" id="attach-receipt-btn" onclick="attachSelectedReceipt()" disabled>Attach Receipt</button>
    </div>
  </div>
</div>

<!-- Receipt Preview Modal -->
<div class="modal-overlay" id="receipt-preview-modal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h3 class="modal-title" id="preview-title">Receipt Preview</h3>
      <button class="modal-close" onclick="closeReceiptPreview()">&times;</button>
    </div>
    <div class="modal-body receipt-preview">
      <img id="preview-image" src="" alt="Receipt">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeReceiptPreview()">Close</button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<script>
// Get report ID from URL
const reportId = window.location.pathname.split('/').pop();
let expenses = [];
let selectedExpenses = new Set();
let selectedReceiptId = null;
let currentTransactionIndex = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadReport();
});

// Load report data
async function loadReport() {
  try {
    const response = await fetch(`/api/reports/${reportId}/items`);
    if (!response.ok) throw new Error('Failed to load report');

    const data = await response.json();

    document.getElementById('report-name').textContent = data.report_name || reportId;
    document.title = `${data.report_name || 'Report'} - Tallyups`;

    expenses = data.items || [];
    renderExpenses();
    updateStats();

  } catch (err) {
    console.error('Failed to load report:', err);
    showToast('Failed to load report', 'error');
  }
}

// Render expenses table
function renderExpenses() {
  const tbody = document.getElementById('expense-tbody');

  if (!expenses.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <p class="empty-state-text">No expenses in this report yet</p>
          <a href="/library" class="btn btn-primary">Add from Library</a>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = expenses.map((exp, i) => {
    const hasReceipt = exp.receipt_url || exp.r2_url;
    const hasNote = exp.ai_note && exp.ai_note.trim();
    const receiptThumb = hasReceipt ?
      `<img src="${exp.receipt_url || exp.r2_url}" class="receipt-thumb" onclick="previewReceipt('${exp.receipt_url || exp.r2_url}', '${escapeHtml(exp.chase_description)}')" onerror="this.style.display='none'">` :
      `<div class="no-receipt" onclick="openReceiptPicker(${exp._index})" title="Click to attach receipt">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </div>`;

    const status = hasReceipt && hasNote ? 'good' : (hasReceipt || hasNote ? 'pending' : 'missing');
    const statusLabel = status === 'good' ? 'Ready' : (status === 'pending' ? 'Partial' : 'Needs Work');

    return `
      <tr data-index="${exp._index}" class="${selectedExpenses.has(exp._index) ? 'selected' : ''}">
        <td class="col-check">
          <input type="checkbox" class="row-check" ${selectedExpenses.has(exp._index) ? 'checked' : ''} onchange="toggleSelect(${exp._index}, this)">
        </td>
        <td class="col-receipt">${receiptThumb}</td>
        <td class="col-date">${formatDate(exp.chase_date)}</td>
        <td class="col-description">${escapeHtml(exp.chase_description || '')}</td>
        <td class="col-amount ${(exp.chase_amount || 0) < 0 ? 'negative' : 'positive'}">$${Math.abs(exp.chase_amount || 0).toFixed(2)}</td>
        <td class="col-category">
          <span class="category-badge">${exp.chase_category || 'Uncategorized'}</span>
        </td>
        <td class="col-note">
          <div class="ai-note" id="note-${exp._index}">
            <span class="ai-note-text ${!hasNote ? 'empty' : ''}" id="note-text-${exp._index}">
              ${hasNote ? escapeHtml(exp.ai_note) : 'No note - click to generate'}
            </span>
            <div class="inline-edit" id="note-edit-${exp._index}">
              <textarea id="note-input-${exp._index}">${escapeHtml(exp.ai_note || '')}</textarea>
              <div class="inline-edit-actions">
                <button class="inline-edit-btn save" onclick="saveNote(${exp._index})">Save</button>
                <button class="inline-edit-btn cancel" onclick="cancelEdit(${exp._index})">Cancel</button>
              </div>
            </div>
            <div class="note-actions">
              <button class="note-action generate" onclick="generateNote(${exp._index})" title="Generate AI Note">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                  <path d="M2 17l10 5 10-5"/>
                </svg>
              </button>
              <button class="note-action" onclick="startEdit(${exp._index})" title="Edit Note">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
            </div>
          </div>
        </td>
        <td class="col-status">
          <span class="status-badge ${status}">${statusLabel}</span>
        </td>
      </tr>
    `;
  }).join('');
}

// Update stats
function updateStats() {
  const total = expenses.reduce((sum, e) => sum + Math.abs(e.chase_amount || 0), 0);
  const withReceipts = expenses.filter(e => e.receipt_url || e.r2_url).length;
  const withNotes = expenses.filter(e => e.ai_note && e.ai_note.trim()).length;

  document.getElementById('stat-count').textContent = expenses.length;
  document.getElementById('stat-total').textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('stat-receipts').textContent = expenses.length ? Math.round(withReceipts / expenses.length * 100) + '%' : '0%';
  document.getElementById('stat-notes').textContent = expenses.length ? Math.round(withNotes / expenses.length * 100) + '%' : '0%';
}

// Selection functions
function toggleSelect(index, checkbox) {
  if (checkbox.checked) {
    selectedExpenses.add(index);
  } else {
    selectedExpenses.delete(index);
  }
  updateSelectedCount();
  document.querySelector(`tr[data-index="${index}"]`)?.classList.toggle('selected', checkbox.checked);
}

function toggleAll(checkbox) {
  if (checkbox.checked) {
    expenses.forEach(e => selectedExpenses.add(e._index));
  } else {
    selectedExpenses.clear();
  }
  document.querySelectorAll('.row-check').forEach(cb => cb.checked = checkbox.checked);
  document.querySelectorAll('#expense-tbody tr').forEach(tr => tr.classList.toggle('selected', checkbox.checked));
  updateSelectedCount();
}

function selectAll() {
  document.getElementById('check-all').checked = true;
  toggleAll(document.getElementById('check-all'));
}

function selectNone() {
  document.getElementById('check-all').checked = false;
  toggleAll(document.getElementById('check-all'));
}

function updateSelectedCount() {
  document.getElementById('selected-count').textContent = selectedExpenses.size;
}

// Inline editing
function startEdit(index) {
  document.getElementById(`note-text-${index}`).style.display = 'none';
  document.getElementById(`note-edit-${index}`).classList.add('active');
  document.getElementById(`note-input-${index}`).focus();
}

function cancelEdit(index) {
  document.getElementById(`note-text-${index}`).style.display = '';
  document.getElementById(`note-edit-${index}`).classList.remove('active');
}

async function saveNote(index) {
  const textarea = document.getElementById(`note-input-${index}`);
  const note = textarea.value.trim();

  try {
    const response = await fetch(`/api/notes/${index}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ note })
    });

    if (!response.ok) throw new Error('Failed to save note');

    // Update local data
    const exp = expenses.find(e => e._index === index);
    if (exp) exp.ai_note = note;

    // Update UI
    const textEl = document.getElementById(`note-text-${index}`);
    textEl.textContent = note || 'No note - click to generate';
    textEl.classList.toggle('empty', !note);

    cancelEdit(index);
    updateStats();
    showToast('Note saved', 'success');

  } catch (err) {
    console.error('Failed to save note:', err);
    showToast('Failed to save note', 'error');
  }
}

// Generate AI notes
async function generateNote(index) {
  const exp = expenses.find(e => e._index === index);
  if (!exp) return;

  const noteText = document.getElementById(`note-text-${index}`);
  noteText.innerHTML = '<span class="loading-spinner"></span> Generating...';

  try {
    const response = await fetch('/api/notes/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ _index: index })
    });

    if (!response.ok) throw new Error('Failed to generate note');

    const data = await response.json();

    // Update local data
    exp.ai_note = data.note;

    // Update UI
    noteText.textContent = data.note || 'No note generated';
    noteText.classList.toggle('empty', !data.note);
    document.getElementById(`note-input-${index}`).value = data.note || '';

    updateStats();
    showToast('Note generated', 'success');

  } catch (err) {
    console.error('Failed to generate note:', err);
    noteText.textContent = 'Failed to generate';
    noteText.classList.add('empty');
    showToast('Failed to generate note', 'error');
  }
}

async function generateSelectedNotes() {
  if (selectedExpenses.size === 0) {
    showToast('No expenses selected', 'warning');
    return;
  }

  await generateBatchNotes(Array.from(selectedExpenses));
}

async function generateAllNotes() {
  // Get all expenses without notes
  const needNotes = expenses.filter(e => !e.ai_note || !e.ai_note.trim()).map(e => e._index);

  if (needNotes.length === 0) {
    showToast('All expenses already have notes', 'info');
    return;
  }

  await generateBatchNotes(needNotes);
}

async function generateBatchNotes(indexes) {
  const progressContainer = document.getElementById('progress-container');
  const progressFill = document.getElementById('progress-fill');
  const progressText = document.getElementById('progress-text');
  const btn = document.getElementById('auto-notes-btn');

  progressContainer.classList.add('active');
  btn.disabled = true;

  let completed = 0;
  const total = indexes.length;

  // Process in batches of 5
  const batchSize = 5;
  for (let i = 0; i < indexes.length; i += batchSize) {
    const batch = indexes.slice(i, i + batchSize);

    try {
      const response = await fetch('/api/notes/batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          indexes: batch,
          skip_existing: false
        })
      });

      if (response.ok) {
        const data = await response.json();

        // Update UI for each result
        data.results?.forEach(result => {
          if (result.success && result.note) {
            const exp = expenses.find(e => e._index === result._index);
            if (exp) exp.ai_note = result.note;

            const noteText = document.getElementById(`note-text-${result._index}`);
            if (noteText) {
              noteText.textContent = result.note;
              noteText.classList.remove('empty');
            }
            const noteInput = document.getElementById(`note-input-${result._index}`);
            if (noteInput) noteInput.value = result.note;
          }
        });

        completed += batch.length;
      }
    } catch (err) {
      console.error('Batch error:', err);
      completed += batch.length;
    }

    // Update progress
    const pct = Math.round(completed / total * 100);
    progressFill.style.width = pct + '%';
    progressText.textContent = `${completed}/${total}`;
  }

  progressContainer.classList.remove('active');
  progressText.textContent = '';
  btn.disabled = false;

  updateStats();
  showToast(`Generated ${completed} notes`, 'success');
}

// Receipt picker
function openReceiptPicker(transactionIndex) {
  currentTransactionIndex = transactionIndex;
  selectedReceiptId = null;
  document.getElementById('attach-receipt-btn').disabled = true;
  document.getElementById('receipt-picker-modal').classList.add('active');
  loadAvailableReceipts();
}

function closeReceiptPicker() {
  document.getElementById('receipt-picker-modal').classList.remove('active');
}

async function loadAvailableReceipts() {
  const grid = document.getElementById('receipt-grid');
  grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><div class="loading-spinner"></div><p style="margin-top: 12px; color: var(--text-tertiary);">Loading receipts...</p></div>';

  try {
    const response = await fetch('/api/incoming/pending?limit=50');
    if (!response.ok) throw new Error('Failed to load receipts');

    const data = await response.json();
    const receipts = data.receipts || [];

    if (receipts.length === 0) {
      grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-tertiary);">No unmatched receipts available</div>';
      return;
    }

    grid.innerHTML = receipts.map(r => `
      <div class="receipt-card" data-id="${r.id}" onclick="selectReceipt(${r.id}, this)">
        <img src="${r.receipt_image_url || ''}" class="receipt-card-img" alt="Receipt" onerror="this.src='/static/img/no-receipt.svg'">
        <div class="receipt-card-info">
          <div class="receipt-card-merchant">${escapeHtml(r.ocr_merchant || r.merchant || r.subject || 'Unknown')}</div>
          <div class="receipt-card-details">
            <span>${r.ocr_amount ? '$' + r.ocr_amount.toFixed(2) : (r.amount ? '$' + r.amount.toFixed(2) : '')}</span>
            <span>${formatDate(r.ocr_date || r.received_date)}</span>
          </div>
        </div>
      </div>
    `).join('');

  } catch (err) {
    console.error('Failed to load receipts:', err);
    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--error);">Failed to load receipts</div>';
  }
}

async function loadMatchingReceipts() {
  if (!currentTransactionIndex) return;

  const exp = expenses.find(e => e._index === currentTransactionIndex);
  if (!exp) return;

  const grid = document.getElementById('receipt-grid');
  grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><div class="loading-spinner"></div><p style="margin-top: 12px; color: var(--text-tertiary);">Finding best matches...</p></div>';

  try {
    const response = await fetch(`/api/incoming/match-candidates?amount=${Math.abs(exp.chase_amount)}&date=${exp.chase_date}&description=${encodeURIComponent(exp.chase_description || '')}`);
    if (!response.ok) throw new Error('Failed to find matches');

    const data = await response.json();
    const receipts = data.receipts || [];

    if (receipts.length === 0) {
      grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-tertiary);">No matching receipts found</div>';
      return;
    }

    grid.innerHTML = receipts.map(r => `
      <div class="receipt-card" data-id="${r.id}" onclick="selectReceipt(${r.id}, this)">
        <img src="${r.receipt_image_url || ''}" class="receipt-card-img" alt="Receipt" onerror="this.src='/static/img/no-receipt.svg'">
        <div class="receipt-card-info">
          <div class="receipt-card-merchant">${escapeHtml(r.ocr_merchant || r.merchant || r.subject || 'Unknown')}</div>
          <div class="receipt-card-details">
            <span>${r.ocr_amount ? '$' + r.ocr_amount.toFixed(2) : (r.amount ? '$' + r.amount.toFixed(2) : '')}</span>
            <span>${r.match_score ? 'Score: ' + r.match_score + '%' : ''}</span>
          </div>
        </div>
      </div>
    `).join('');

  } catch (err) {
    console.error('Failed to find matches:', err);
    loadAvailableReceipts();
  }
}

function selectReceipt(id, element) {
  document.querySelectorAll('.receipt-card').forEach(c => c.classList.remove('selected'));
  element.classList.add('selected');
  selectedReceiptId = id;
  document.getElementById('attach-receipt-btn').disabled = false;
}

async function attachSelectedReceipt() {
  if (!selectedReceiptId || !currentTransactionIndex) return;

  try {
    const response = await fetch('/api/transactions/attach-receipt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        transaction_index: currentTransactionIndex,
        incoming_receipt_id: selectedReceiptId
      })
    });

    if (!response.ok) throw new Error('Failed to attach receipt');

    const data = await response.json();

    // Update local data
    const exp = expenses.find(e => e._index === currentTransactionIndex);
    const r2Url = data.r2_url || data.receipt_url;
    if (exp && r2Url) {
      exp.r2_url = r2Url;
    }

    closeReceiptPicker();
    renderExpenses();
    updateStats();
    showToast('Receipt attached', 'success');

  } catch (err) {
    console.error('Failed to attach receipt:', err);
    showToast('Failed to attach receipt', 'error');
  }
}

function searchReceipts() {
  const query = document.getElementById('receipt-search').value.toLowerCase();
  document.querySelectorAll('.receipt-card').forEach(card => {
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(query) ? '' : 'none';
  });
}

// Receipt preview
function previewReceipt(url, title) {
  document.getElementById('preview-title').textContent = title || 'Receipt';
  document.getElementById('preview-image').src = url;
  document.getElementById('receipt-preview-modal').classList.add('active');
}

function closeReceiptPreview() {
  document.getElementById('receipt-preview-modal').classList.remove('active');
}

// Export
async function exportReport(format) {
  window.location.href = `/api/reports/${reportId}/export/${format}`;
  showToast('Exporting report...', 'info');
}

// Remove selected from report
async function removeSelected() {
  if (selectedExpenses.size === 0) {
    showToast('No expenses selected', 'warning');
    return;
  }

  if (!confirm(`Remove ${selectedExpenses.size} expense(s) from this report?`)) return;

  let removed = 0;
  for (const index of selectedExpenses) {
    try {
      const response = await fetch(`/api/reports/${reportId}/remove`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ _index: index })
      });
      if (response.ok) removed++;
    } catch (err) {
      console.error('Failed to remove:', err);
    }
  }

  selectedExpenses.clear();
  loadReport();
  showToast(`Removed ${removed} expense(s)`, 'success');
}

// Utility functions
function formatDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;

  const icons = {
    success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>',
    error: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>',
    warning: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4M12 17h.01"/><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>',
    info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>'
  };
  toast.innerHTML = `${icons[type] || icons.info}<span>${message}</span>`;

  container.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Close modals on escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeReceiptPicker();
    closeReceiptPreview();
  }
});

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('active');
    }
  });
});
</script>

</body>
</html>
