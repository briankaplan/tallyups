<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <meta name="description" content="AI-powered expense management - TallyUps">
  <meta name="theme-color" content="#000000">

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TallyUps">

  <title>TallyUps - Dashboard</title>

  <!-- Legendary Design System -->
  <link rel="stylesheet" href="/static/css/legendary/index.css">

  <!-- Unified Header & App Shell -->
  <script src="/static/js/unified-header.js"></script>
  <script src="/static/js/design-system.js"></script>
  <script src="/static/js/app-shell.js" defer></script>

  <!-- Icons -->
  <link rel="icon" type="image/svg+xml" href="/static/icon.svg">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TALLYUPS DASHBOARD - Legendary Design System
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    body {
      padding-top: var(--header-height, 60px);
    }

    .dashboard-page {
      min-height: 100vh;
      background: var(--bg-primary);
    }

    .dashboard-container {
      max-width: 1440px;
      margin: 0 auto;
      padding: var(--space-6) var(--space-6);
      padding-bottom: calc(var(--space-10) + var(--safe-bottom, 0px));
    }

    /* Page Header */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
      margin-bottom: var(--space-8);
      flex-wrap: wrap;
    }

    .page-header-left {
      flex: 1;
      min-width: 0;
    }

    .dashboard-title {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: var(--weight-bold);
      color: var(--text-primary);
      margin: 0;
      letter-spacing: var(--tracking-tight);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .dashboard-title-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
      border-radius: var(--radius-xl);
      font-size: 24px;
    }

    .dashboard-subtitle {
      font-size: var(--text-base);
      color: var(--text-secondary);
      margin-top: var(--space-1);
    }

    .page-header-right {
      display: flex;
      gap: var(--space-3);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: var(--space-5);
      margin-bottom: var(--space-8);
    }

    .stat-card {
      position: relative;
      padding: var(--space-5) var(--space-6);
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-2xl);
      overflow: hidden;
      transition: all var(--duration-base) var(--ease-out);
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
      border-color: var(--brand-primary);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
    }

    .stat-card.business::before {
      background: linear-gradient(90deg, #10B981, #34D399);
    }

    .stat-card.sec::before {
      background: linear-gradient(90deg, #6366F1, #818CF8);
    }

    .stat-card.personal::before {
      background: linear-gradient(90deg, #F59E0B, #FBBF24);
    }

    .stat-card.receipts::before {
      background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-3);
    }

    .stat-label {
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: var(--tracking-wider);
    }

    .stat-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      color: var(--text-tertiary);
    }

    .stat-icon svg {
      width: 18px;
      height: 18px;
    }

    .stat-value {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: var(--weight-bold);
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: var(--space-2);
      letter-spacing: var(--tracking-tight);
    }

    .stat-footer {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .stat-change {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-0-5) var(--space-2);
      font-size: var(--text-xs);
      font-weight: var(--weight-semibold);
      border-radius: var(--radius-full);
    }

    .stat-change.positive {
      background: var(--success-dim);
      color: var(--success);
    }

    .stat-change.negative {
      background: var(--error-dim);
      color: var(--error);
    }

    .stat-period {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: var(--space-4);
      margin-bottom: var(--space-8);
      overflow-x: auto;
      padding-bottom: var(--space-2);
      -webkit-overflow-scrolling: touch;
    }

    .quick-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-4) var(--space-5);
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-xl);
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
      min-width: 100px;
      text-decoration: none;
    }

    .quick-action:hover {
      transform: translateY(-2px);
      border-color: var(--brand-primary);
      box-shadow: var(--shadow-md);
    }

    .quick-action-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      font-size: 20px;
    }

    .quick-action-label {
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      color: var(--text-primary);
      text-align: center;
    }

    /* Section Header */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-5);
    }

    .section-title {
      font-family: var(--font-display);
      font-size: var(--text-xl);
      font-weight: var(--weight-bold);
      color: var(--text-primary);
      margin: 0;
    }

    /* Filters */
    .filters-bar {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-5);
      overflow-x: auto;
      padding-bottom: var(--space-2);
      -webkit-overflow-scrolling: touch;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-sm);
      font-weight: var(--weight-medium);
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-full);
      cursor: pointer;
      white-space: nowrap;
      transition: all var(--duration-fast) var(--ease-out);
      user-select: none;
    }

    .filter-chip:hover {
      background: var(--bg-hover);
      border-color: var(--brand-primary);
      color: var(--text-primary);
    }

    .filter-chip.active {
      background: var(--brand-primary);
      color: #000;
      border-color: var(--brand-primary);
      font-weight: var(--weight-semibold);
    }

    .filter-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      font-size: var(--text-xs);
      font-weight: var(--weight-bold);
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
    }

    .filter-chip.active .filter-badge {
      background: rgba(0, 0, 0, 0.2);
      color: #000;
    }

    /* Receipts Grid */
    .receipts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: var(--space-5);
    }

    /* Receipt Card */
    .receipt-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-2xl);
      overflow: hidden;
      transition: all var(--duration-base) var(--ease-out);
      cursor: pointer;
    }

    .receipt-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
      border-color: var(--brand-primary);
    }

    .receipt-card-inner {
      display: flex;
      gap: var(--space-4);
      padding: var(--space-4);
    }

    .receipt-thumb {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
      border-radius: var(--radius-lg);
      background: var(--bg-tertiary);
      overflow: hidden;
    }

    .receipt-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .receipt-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .receipt-merchant {
      font-size: var(--text-base);
      font-weight: var(--weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--space-1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .receipt-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: var(--text-sm);
      color: var(--text-tertiary);
    }

    .receipt-amount {
      font-family: var(--font-mono);
      font-weight: var(--weight-semibold);
      color: var(--text-primary);
    }

    .receipt-status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-0-5) var(--space-2);
      font-size: var(--text-xs);
      font-weight: var(--weight-semibold);
      border-radius: var(--radius-full);
    }

    .receipt-status-badge.verified {
      background: var(--success-dim);
      color: var(--success);
    }

    .receipt-status-badge.pending {
      background: var(--warning-dim);
      color: var(--warning);
    }

    .receipt-status-badge.mismatch {
      background: var(--error-dim);
      color: var(--error);
    }

    .receipt-business {
      font-size: var(--text-xs);
      font-weight: var(--weight-medium);
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: var(--tracking-wide);
    }

    /* Empty State */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: var(--space-16);
      color: var(--text-tertiary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--space-4);
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: var(--text-lg);
      margin-bottom: var(--space-6);
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-secondary);
      border-top-color: var(--brand-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* FAB */
    .fab {
      position: fixed;
      bottom: calc(var(--space-6) + var(--safe-bottom, 0px));
      right: var(--space-6);
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
      border: none;
      border-radius: var(--radius-full);
      color: #000;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      z-index: var(--z-sticky);
      transition: all var(--duration-fast) var(--ease-spring);
    }

    .fab:hover {
      transform: scale(1.08) translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .fab svg {
      width: 24px;
      height: 24px;
    }

    /* Mobile */
    @media (max-width: 768px) {
      .dashboard-container {
        padding: var(--space-4);
      }

      .page-header {
        flex-direction: column;
        align-items: stretch;
      }

      .page-header-right {
        justify-content: flex-end;
      }

      .dashboard-title {
        font-size: var(--text-2xl);
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .quick-actions {
        gap: var(--space-3);
      }

      .quick-action {
        min-width: 85px;
        padding: var(--space-3);
      }

      .receipts-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <main class="dashboard-page">
    <div class="dashboard-container">

      <!-- Page Header -->
      <header class="page-header">
        <div class="page-header-left">
          <h1 class="dashboard-title">
            <span class="dashboard-title-icon">ğŸ“Š</span>
            Dashboard
          </h1>
          <p class="dashboard-subtitle">Welcome back! Here's your expense overview.</p>
        </div>
        <div class="page-header-right">
          <button class="btn btn-primary" onclick="window.location='/scanner'">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            Scan Receipt
          </button>
        </div>
      </header>

      <!-- Stats Grid -->
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card business" onclick="filterByBusiness('Business')">
          <div class="stat-card-header">
            <div class="stat-label">Business</div>
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
              </svg>
            </div>
          </div>
          <div class="stat-value" id="business-total">$0.00</div>
          <div class="stat-footer">
            <span class="stat-change positive" id="business-change">+0%</span>
            <span class="stat-period">vs last month</span>
          </div>
        </div>

        <div class="stat-card sec" onclick="filterByBusiness('Secondary')">
          <div class="stat-card-header">
            <div class="stat-label">Secondary</div>
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
              </svg>
            </div>
          </div>
          <div class="stat-value" id="sec-total">$0.00</div>
          <div class="stat-footer">
            <span class="stat-change positive" id="sec-change">+0%</span>
            <span class="stat-period">vs last month</span>
          </div>
        </div>

        <div class="stat-card personal" onclick="filterByBusiness('Personal')">
          <div class="stat-card-header">
            <div class="stat-label">Personal</div>
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
          </div>
          <div class="stat-value" id="personal-total">$0.00</div>
          <div class="stat-footer">
            <span class="stat-change positive" id="personal-change">+0%</span>
            <span class="stat-period">vs last month</span>
          </div>
        </div>

        <div class="stat-card receipts" onclick="window.location='/library'">
          <div class="stat-card-header">
            <div class="stat-label">Receipts Captured</div>
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <path d="M14 2v6h6"/>
              </svg>
            </div>
          </div>
          <div class="stat-value" id="receipts-count">0</div>
          <div class="stat-footer">
            <span class="stat-change positive" id="receipts-week">+0</span>
            <span class="stat-period">this week</span>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <a href="/scanner" class="quick-action">
          <div class="quick-action-icon">ğŸ“¸</div>
          <span class="quick-action-label">Scan</span>
        </a>
        <a href="/inbox" class="quick-action">
          <div class="quick-action-icon">ğŸ“¥</div>
          <span class="quick-action-label">Inbox</span>
        </a>
        <a href="/library" class="quick-action">
          <div class="quick-action-icon">ğŸ“š</div>
          <span class="quick-action-label">Library</span>
        </a>
        <a href="/reports-dashboard" class="quick-action">
          <div class="quick-action-icon">ğŸ“Š</div>
          <span class="quick-action-label">Reports</span>
        </a>
        <a href="/reconciler" class="quick-action">
          <div class="quick-action-icon">ğŸ”</div>
          <span class="quick-action-label">Reconciler</span>
        </a>
        <a href="/settings" class="quick-action">
          <div class="quick-action-icon">âš™ï¸</div>
          <span class="quick-action-label">Settings</span>
        </a>
      </div>

      <!-- Recent Receipts Section -->
      <div class="section-header">
        <h2 class="section-title">Recent Activity</h2>
        <a href="/library" class="btn btn-ghost">View All â†’</a>
      </div>

      <!-- Filters -->
      <div class="filters-bar" id="filters-bar">
        <div class="filter-chip active" data-filter="all">
          All
          <span class="filter-badge" id="filter-all-count">0</span>
        </div>
        <div class="filter-chip" data-filter="needs-review">
          Needs Review
          <span class="filter-badge" id="filter-review-count">0</span>
        </div>
        <div class="filter-chip" data-filter="verified">
          Verified
          <span class="filter-badge" id="filter-verified-count">0</span>
        </div>
        <div class="filter-chip" data-filter="mismatch">
          Mismatch
          <span class="filter-badge" id="filter-mismatch-count">0</span>
        </div>
      </div>

      <!-- Receipts Grid -->
      <div class="receipts-grid" id="receipts-grid">
        <div class="empty-state">
          <div class="loading-spinner"></div>
          <p style="margin-top: 16px;">Loading receipts...</p>
        </div>
      </div>

    </div>
  </main>

  <!-- FAB for quick scan -->
  <button class="fab" onclick="window.location='/scanner'" title="Scan Receipt">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
  </button>

  <script>
    // Dashboard State
    let allReceipts = [];
    let currentFilter = 'all';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardStats();
      loadRecentReceipts();
      setupFilterListeners();
    });

    // Load dashboard statistics
    async function loadDashboardStats() {
      try {
        const response = await fetch('/api/dashboard/stats');
        if (!response.ok) throw new Error('Failed to load stats');

        const data = await response.json();
        const biz = data.by_business || {};

        // Get totals from by_business
        const business = biz['Business'] || {};
        const sec = biz['Secondary'] || {};
        const personal = biz['Personal'] || {};

        // Update stats
        document.getElementById('business-total').textContent = formatCurrency(business.total || 0);
        document.getElementById('sec-total').textContent = formatCurrency(sec.total || 0);
        document.getElementById('personal-total').textContent = formatCurrency(personal.total || 0);
        document.getElementById('receipts-count').textContent = formatNumber(data.total_receipts || 0);

        // Calculate change from monthly trends
        const trends = data.monthly_trends || [];
        if (trends.length >= 2) {
          const current = trends[trends.length - 1]?.total || 0;
          const previous = trends[trends.length - 2]?.total || 1;
          const change = Math.round(((current - previous) / previous) * 100);
          updateChange('business-change', change);
          updateChange('sec-change', change);
          updateChange('personal-change', change);
        }

        // Calculate receipts this week from weekly activity
        const weekly = data.weekly_activity || [];
        const thisWeek = weekly.length > 0 ? weekly[weekly.length - 1]?.with_receipt || 0 : 0;
        document.getElementById('receipts-week').textContent = `+${thisWeek}`;

      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    // Load recent receipts
    async function loadRecentReceipts() {
      const grid = document.getElementById('receipts-grid');

      try {
        const response = await fetch('/api/transactions?limit=20&has_receipt=1');
        if (!response.ok) throw new Error('Failed to load receipts');

        const data = await response.json();
        allReceipts = data.transactions || [];

        // Update filter counts
        updateFilterCounts();

        // Render receipts
        renderReceipts(allReceipts);

      } catch (err) {
        console.error('Failed to load receipts:', err);
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <p class="empty-state-text">No receipts found</p>
            <a href="/scanner" class="btn btn-primary">Scan your first receipt</a>
          </div>
        `;
      }
    }

    // Render receipts
    function renderReceipts(receipts) {
      const grid = document.getElementById('receipts-grid');

      if (!receipts.length) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <p class="empty-state-text">No receipts match this filter</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = receipts.slice(0, 12).map(r => {
        const statusClass = getStatusClass(r);
        const statusLabel = getStatusLabel(r);

        return `
          <div class="receipt-card" onclick="openReceipt(${r._index})">
            <div class="receipt-card-inner">
              <div class="receipt-thumb">
                ${r.r2_url ? `<img src="${r.r2_url}" alt="Receipt" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span style="display:none">ğŸ“„</span>` : 'ğŸ“„'}
              </div>
              <div class="receipt-content">
                <div class="receipt-merchant">${escapeHtml(r.chase_description || 'Unknown')}</div>
                <div class="receipt-meta">
                  <span class="receipt-amount">$${Math.abs(r.chase_amount || 0).toFixed(2)}</span>
                  <span>${formatDate(r.chase_date)}</span>
                </div>
                <div class="receipt-meta" style="margin-top: 4px;">
                  <span class="receipt-status-badge ${statusClass}">${statusLabel}</span>
                  <span class="receipt-business">${r.business_type || 'Uncategorized'}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Filter functionality
    function setupFilterListeners() {
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');

          currentFilter = chip.dataset.filter;
          applyFilter();
        });
      });
    }

    function applyFilter() {
      let filtered = allReceipts;

      switch (currentFilter) {
        case 'needs-review':
          filtered = allReceipts.filter(r => r.verification_status === 'needs_review' || !r.verification_status);
          break;
        case 'verified':
          filtered = allReceipts.filter(r => r.verification_status === 'verified');
          break;
        case 'mismatch':
          filtered = allReceipts.filter(r => r.verification_status === 'mismatch');
          break;
      }

      renderReceipts(filtered);
    }

    function updateFilterCounts() {
      document.getElementById('filter-all-count').textContent = allReceipts.length;
      document.getElementById('filter-review-count').textContent = allReceipts.filter(r => r.verification_status === 'needs_review' || !r.verification_status).length;
      document.getElementById('filter-verified-count').textContent = allReceipts.filter(r => r.verification_status === 'verified').length;
      document.getElementById('filter-mismatch-count').textContent = allReceipts.filter(r => r.verification_status === 'mismatch').length;
    }

    function filterByBusiness(businessType) {
      window.location = `/library?business_type=${encodeURIComponent(businessType)}`;
    }

    // Utility functions
    function formatCurrency(amount) {
      return '$' + Math.abs(amount).toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      });
    }

    function formatNumber(num) {
      return num.toLocaleString('en-US');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function updateChange(elementId, changeValue) {
      const el = document.getElementById(elementId);
      if (!el) return;

      const isPositive = changeValue >= 0;
      el.textContent = (isPositive ? '+' : '') + changeValue + '%';
      el.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
    }

    function getStatusClass(receipt) {
      if (receipt.verification_status === 'verified') return 'verified';
      if (receipt.verification_status === 'mismatch') return 'mismatch';
      return 'pending';
    }

    function getStatusLabel(receipt) {
      if (receipt.verification_status === 'verified') return 'âœ“ Verified';
      if (receipt.verification_status === 'mismatch') return 'âš  Mismatch';
      return 'â—· Pending';
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function openReceipt(index) {
      // Use the app-shell receipt viewer if available
      if (window.AppShell && typeof window.AppShell.openReceiptViewer === 'function') {
        window.AppShell.openReceiptViewer(index);
      } else {
        window.location = `/reconciler?index=${index}`;
      }
    }
  </script>

</body>
</html>
