<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
<meta name="description" content="Tallyups Reports - Beautiful expense reporting">
<meta name="theme-color" content="#0b0d10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Reports - TallyUps</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">

<!-- Legendary Design System -->
<link rel="stylesheet" href="/static/css/legendary/index.css">
<script src="/static/js/csrf.js"></script>
<script src="/static/js/unified-header.js" defer></script>
<script src="/static/js/app-shell.js" defer></script>

<style>
/* Page Layout */
.reports-page {
  min-height: 100vh;
  background: var(--bg-primary);
  padding-top: calc(var(--header-height, 64px) + var(--space-6));
  padding-bottom: calc(var(--space-20) + var(--safe-bottom));
}

.reports-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 var(--space-6);
}

/* Page Header */
.page-header {
  margin-bottom: var(--space-8);
}

.page-title {
  font-family: var(--font-display);
  font-size: var(--text-3xl);
  font-weight: var(--weight-bold);
  color: var(--text-primary);
  margin: 0 0 var(--space-2) 0;
}

.page-subtitle {
  font-size: var(--text-base);
  color: var(--text-tertiary);
  margin: 0;
}

/* Stats Row */
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--space-4);
  margin-bottom: var(--space-8);
}

@media (max-width: 768px) {
  .stats-row { grid-template-columns: repeat(2, 1fr); }
}

.stat-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-xl);
  padding: var(--space-5);
  text-align: center;
  transition: all var(--duration-fast) var(--ease-out);
}

.stat-card:hover {
  border-color: var(--brand-primary);
  transform: translateY(-2px);
}

.stat-value {
  font-family: var(--font-display);
  font-size: var(--text-2xl);
  font-weight: var(--weight-bold);
  color: var(--brand-primary);
  margin-bottom: var(--space-1);
}

.stat-label {
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: var(--tracking-wide);
}

/* Quick Actions */
.quick-actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--space-4);
  margin-bottom: var(--space-10);
}

@media (max-width: 900px) {
  .quick-actions { grid-template-columns: repeat(2, 1fr); }
}

.quick-action {
  background: linear-gradient(135deg, rgba(0, 255, 163, 0.08), rgba(91, 127, 255, 0.04));
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-xl);
  padding: var(--space-5);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-spring);
  text-align: left;
}

.quick-action:hover {
  border-color: var(--brand-primary);
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg), var(--glow-sm);
}

.quick-action:active {
  transform: translateY(-1px);
}

.quick-action__icon {
  font-size: var(--text-2xl);
  margin-bottom: var(--space-3);
}

.quick-action__title {
  font-size: var(--text-sm);
  font-weight: var(--weight-semibold);
  color: var(--text-primary);
  margin-bottom: var(--space-1);
}

.quick-action__desc {
  font-size: var(--text-xs);
  color: var(--text-tertiary);
}

/* Main Content Grid */
.content-grid {
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: var(--space-6);
}

@media (max-width: 1000px) {
  .content-grid {
    grid-template-columns: 1fr;
  }
}

/* Section Cards */
.section-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-2xl);
  overflow: hidden;
}

.section-header {
  padding: var(--space-5) var(--space-6);
  border-bottom: 1px solid var(--border-secondary);
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.section-icon {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-lg);
  background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--text-lg);
}

.section-title {
  font-size: var(--text-lg);
  font-weight: var(--weight-semibold);
  color: var(--text-primary);
  margin: 0;
}

.section-body {
  padding: var(--space-6);
}

/* Report Builder Form */
.form-group {
  margin-bottom: var(--space-5);
}

.form-label {
  display: block;
  font-size: var(--text-xs);
  font-weight: var(--weight-semibold);
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: var(--tracking-wide);
  margin-bottom: var(--space-2);
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-3);
}

.form-input {
  width: 100%;
  padding: var(--space-3) var(--space-4);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  color: var(--text-primary);
  font-size: var(--text-sm);
  transition: all var(--duration-fast) var(--ease-out);
}

.form-input:focus {
  outline: none;
  border-color: var(--brand-primary);
  box-shadow: 0 0 0 3px rgba(0, 255, 163, 0.15);
}

.form-select {
  width: 100%;
  padding: var(--space-3) var(--space-4);
  padding-right: var(--space-10);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  color: var(--text-primary);
  font-size: var(--text-sm);
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  transition: all var(--duration-fast) var(--ease-out);
}

.form-select:focus {
  outline: none;
  border-color: var(--brand-primary);
  box-shadow: 0 0 0 3px rgba(0, 255, 163, 0.15);
}

/* Business Pills */
.pill-group {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
}

.pill {
  padding: var(--space-2) var(--space-4);
  border-radius: var(--radius-full);
  font-size: var(--text-xs);
  font-weight: var(--weight-semibold);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-primary);
}

.pill:hover {
  border-color: var(--brand-primary);
  color: var(--text-primary);
}

.pill.active {
  background: var(--brand-primary);
  color: #000;
  border-color: var(--brand-primary);
}

/* Export Format Buttons */
.format-group {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--space-2);
}

.format-btn {
  padding: var(--space-3);
  border-radius: var(--radius-lg);
  font-size: var(--text-xs);
  font-weight: var(--weight-semibold);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-1);
}

.format-btn svg {
  width: 20px;
  height: 20px;
  stroke: currentColor;
}

.format-btn:hover {
  border-color: var(--brand-primary);
  color: var(--text-primary);
}

.format-btn.active {
  background: var(--brand-primary);
  color: #000;
  border-color: var(--brand-primary);
}

/* Generate Button */
.btn-generate {
  width: 100%;
  padding: var(--space-4);
  border-radius: var(--radius-xl);
  font-size: var(--text-base);
  font-weight: var(--weight-semibold);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-spring);
  background: linear-gradient(135deg, var(--brand-primary), #00cc6a);
  color: #000;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  box-shadow: 0 4px 20px rgba(0, 255, 163, 0.25);
  margin-top: var(--space-6);
}

.btn-generate:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 28px rgba(0, 255, 163, 0.35);
}

.btn-generate:active {
  transform: translateY(0);
}

.btn-generate svg {
  width: 20px;
  height: 20px;
}

/* Recent Reports List */
.report-list {
  display: flex;
  flex-direction: column;
}

.report-item {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-4) var(--space-6);
  border-bottom: 1px solid var(--border-secondary);
  transition: all var(--duration-fast) var(--ease-out);
  cursor: pointer;
}

.report-item:last-child {
  border-bottom: none;
}

.report-item:hover {
  background: var(--bg-hover);
}

.report-item__icon {
  width: 44px;
  height: 44px;
  border-radius: var(--radius-lg);
  background: linear-gradient(135deg, rgba(0, 255, 163, 0.15), rgba(91, 127, 255, 0.1));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--text-xl);
  flex-shrink: 0;
}

.report-item__info {
  flex: 1;
  min-width: 0;
}

.report-item__name {
  font-size: var(--text-sm);
  font-weight: var(--weight-semibold);
  color: var(--text-primary);
  margin-bottom: var(--space-1);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.report-item__meta {
  display: flex;
  gap: var(--space-3);
  font-size: var(--text-xs);
  color: var(--text-tertiary);
}

.report-item__actions {
  display: flex;
  gap: var(--space-2);
  opacity: 0;
  transition: opacity var(--duration-fast) var(--ease-out);
}

.report-item:hover .report-item__actions {
  opacity: 1;
}

.action-btn {
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-md);
  font-size: var(--text-xs);
  font-weight: var(--weight-medium);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-primary);
}

.action-btn:hover {
  border-color: var(--brand-primary);
  color: var(--brand-primary);
}

.action-btn--danger {
  border-color: var(--error);
  color: var(--error);
}

.action-btn--danger:hover {
  background: var(--error);
  border-color: var(--error);
  color: white;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: var(--space-10) var(--space-6);
  color: var(--text-tertiary);
}

.empty-state__icon {
  font-size: var(--text-4xl);
  margin-bottom: var(--space-4);
  opacity: 0.5;
}

.empty-state__text {
  font-size: var(--text-sm);
}

/* Loading State */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-3);
  padding: var(--space-10);
  color: var(--text-tertiary);
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-primary);
  border-top-color: var(--brand-primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Toast */
.toast-container {
  position: fixed;
  bottom: calc(var(--space-6) + var(--safe-bottom));
  right: var(--space-6);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.toast {
  background: var(--bg-elevated);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-xl);
  padding: var(--space-4) var(--space-5);
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: var(--space-3);
  animation: slideIn 0.3s var(--ease-spring);
  max-width: 360px;
}

.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--error); }
.toast.warning { border-color: var(--warning); }

.toast__icon {
  font-size: var(--text-lg);
}

.toast__message {
  font-size: var(--text-sm);
  color: var(--text-primary);
}

@keyframes slideIn {
  from { transform: translateX(100px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: var(--blur-lg);
  z-index: 200;
  display: none;
  align-items: center;
  justify-content: center;
  padding: var(--space-6);
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: var(--bg-elevated);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-2xl);
  width: 100%;
  max-width: 640px;
  max-height: 85vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  animation: modalIn 0.3s var(--ease-spring);
}

@keyframes modalIn {
  from { transform: scale(0.95) translateY(20px); opacity: 0; }
  to { transform: scale(1) translateY(0); opacity: 1; }
}

.modal__header {
  padding: var(--space-5) var(--space-6);
  border-bottom: 1px solid var(--border-secondary);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal__title {
  font-size: var(--text-lg);
  font-weight: var(--weight-semibold);
  color: var(--text-primary);
  margin: 0;
}

.modal__close {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-lg);
  background: var(--bg-tertiary);
  border: none;
  color: var(--text-secondary);
  font-size: var(--text-xl);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--duration-fast) var(--ease-out);
}

.modal__close:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.modal__body {
  padding: var(--space-6);
  overflow-y: auto;
  flex: 1;
}

.modal__footer {
  padding: var(--space-4) var(--space-6);
  border-top: 1px solid var(--border-secondary);
  display: flex;
  justify-content: flex-end;
  gap: var(--space-3);
}

.btn-secondary {
  padding: var(--space-3) var(--space-5);
  border-radius: var(--radius-lg);
  font-size: var(--text-sm);
  font-weight: var(--weight-medium);
  cursor: pointer;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border-primary);
  transition: all var(--duration-fast) var(--ease-out);
}

.btn-secondary:hover {
  border-color: var(--text-tertiary);
}

.btn-primary {
  padding: var(--space-3) var(--space-5);
  border-radius: var(--radius-lg);
  font-size: var(--text-sm);
  font-weight: var(--weight-semibold);
  cursor: pointer;
  background: var(--brand-primary);
  color: #000;
  border: none;
  transition: all var(--duration-fast) var(--ease-out);
}

.btn-primary:hover {
  background: var(--brand-primary-400);
}

/* Preview Table */
.preview-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--space-4);
  margin-bottom: var(--space-6);
  padding: var(--space-4);
  background: var(--bg-tertiary);
  border-radius: var(--radius-lg);
}

/* Math Breakdown */
.math-breakdown {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--space-3);
  margin-bottom: var(--space-6);
  padding: var(--space-4);
  background: var(--bg-tertiary);
  border-radius: var(--radius-lg);
}

.math-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-md);
  background: var(--bg-secondary);
}

.math-row__label {
  font-size: var(--text-xs);
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: var(--tracking-wide);
}

.math-row__value {
  font-size: var(--text-sm);
  font-weight: var(--weight-semibold);
  color: var(--text-primary);
}

.math-row--purchases .math-row__value { color: var(--error); }
.math-row--returns .math-row__value { color: var(--success); }
.math-row--payments .math-row__value { color: var(--brand-secondary); }

.math-total {
  grid-column: 1 / -1;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-3) var(--space-4);
  background: linear-gradient(135deg, rgba(0, 255, 163, 0.1), rgba(91, 127, 255, 0.05));
  border-radius: var(--radius-lg);
  border: 1px solid var(--brand-primary);
}

.math-total__label {
  font-size: var(--text-sm);
  font-weight: var(--weight-semibold);
  color: var(--text-primary);
}

.math-total__value {
  font-size: var(--text-lg);
  font-weight: var(--weight-bold);
  color: var(--brand-primary);
}

.preview-stat {
  text-align: center;
}

.preview-stat__value {
  font-size: var(--text-xl);
  font-weight: var(--weight-bold);
  color: var(--brand-primary);
}

.preview-stat__label {
  font-size: var(--text-xs);
  color: var(--text-tertiary);
}

.preview-table {
  width: 100%;
  border-collapse: collapse;
  font-size: var(--text-sm);
}

.preview-table th,
.preview-table td {
  padding: var(--space-3) var(--space-4);
  text-align: left;
  border-bottom: 1px solid var(--border-secondary);
}

.preview-table th {
  color: var(--text-tertiary);
  font-weight: var(--weight-semibold);
  font-size: var(--text-xs);
  text-transform: uppercase;
  letter-spacing: var(--tracking-wide);
}

.preview-table td {
  color: var(--text-primary);
}

.preview-table tr:hover td {
  background: var(--bg-hover);
}

.preview-more {
  text-align: center;
  padding: var(--space-4);
  color: var(--text-tertiary);
  font-size: var(--text-sm);
}
</style>
</head>
<body>

<main class="reports-page">
  <div class="reports-container">

    <!-- Page Header -->
    <header class="page-header">
      <h1 class="page-title">Reports</h1>
      <p class="page-subtitle">Generate and export expense reports</p>
    </header>

    <!-- Stats Row -->
    <div class="stats-row" id="stats-row">
      <div class="stat-card">
        <div class="stat-value" id="stat-total">$0</div>
        <div class="stat-label">Total YTD</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-transactions">0</div>
        <div class="stat-label">Transactions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-match">0%</div>
        <div class="stat-label">Match Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-pending">0</div>
        <div class="stat-label">Pending</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <button class="quick-action" onclick="generateQuickReport('this_month', 'Down Home')">
        <div class="quick-action__icon">üè†</div>
        <div class="quick-action__title">Down Home - This Month</div>
        <div class="quick-action__desc">Current month expenses</div>
      </button>
      <button class="quick-action" onclick="generateQuickReport('this_month', 'Music City Rodeo')">
        <div class="quick-action__icon">ü§†</div>
        <div class="quick-action__title">Music City Rodeo</div>
        <div class="quick-action__desc">Current month expenses</div>
      </button>
      <button class="quick-action" onclick="generateQuickReport('ytd', 'all')">
        <div class="quick-action__icon">üìä</div>
        <div class="quick-action__title">Year to Date</div>
        <div class="quick-action__desc">All businesses</div>
      </button>
      <button class="quick-action" onclick="generateQuickReport('last_quarter', 'all')">
        <div class="quick-action__icon">üìà</div>
        <div class="quick-action__title">Last Quarter</div>
        <div class="quick-action__desc">Quarterly summary</div>
      </button>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">

      <!-- Recent Reports -->
      <div class="section-card">
        <div class="section-header">
          <div class="section-icon">üìã</div>
          <h2 class="section-title">Recent Reports</h2>
        </div>
        <div class="report-list" id="report-list">
          <div class="loading">
            <div class="spinner"></div>
            Loading reports...
          </div>
        </div>
      </div>

      <!-- Report Builder -->
      <div class="section-card">
        <div class="section-header">
          <div class="section-icon">‚ú®</div>
          <h2 class="section-title">Create Report</h2>
        </div>
        <div class="section-body">
          <form id="report-form" onsubmit="generateCustomReport(event)">

            <!-- Business Type -->
            <div class="form-group">
              <label class="form-label">Business</label>
              <div class="pill-group" id="business-pills">
                <button type="button" class="pill active" data-value="all">All</button>
                <button type="button" class="pill" data-value="Down Home">Down Home</button>
                <button type="button" class="pill" data-value="Music City Rodeo">MCR</button>
                <button type="button" class="pill" data-value="Personal">Personal</button>
              </div>
              <input type="hidden" id="business-type" name="business_type" value="all">
            </div>

            <!-- Date Range -->
            <div class="form-group">
              <label class="form-label">Date Range</label>
              <div class="form-row">
                <input type="date" class="form-input" id="date-from" name="date_from" required>
                <input type="date" class="form-input" id="date-to" name="date_to" required>
              </div>
            </div>

            <!-- Report Type -->
            <div class="form-group">
              <label class="form-label">Report Type</label>
              <select class="form-select" id="report-type" name="report_type">
                <option value="expense_detail">Expense Detail</option>
                <option value="business_summary">Business Summary</option>
                <option value="reconciliation">Reconciliation</option>
                <option value="vendor_analysis">Vendor Analysis</option>
              </select>
            </div>

            <!-- Export Format -->
            <div class="form-group">
              <label class="form-label">Format</label>
              <div class="format-group" id="format-btns">
                <button type="button" class="format-btn active" data-format="excel">
                  <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>
                  Excel
                </button>
                <button type="button" class="format-btn" data-format="pdf">
                  <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>
                  PDF
                </button>
                <button type="button" class="format-btn" data-format="csv">
                  <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>
                  CSV
                </button>
                <button type="button" class="format-btn" data-format="quickbooks">
                  <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                  QB
                </button>
              </div>
              <input type="hidden" id="format" name="format" value="excel">
            </div>

            <!-- Generate Button -->
            <button type="submit" class="btn-generate">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Generate Report
            </button>
          </form>
        </div>
      </div>

    </div>
  </div>
</main>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Preview Modal -->
<div class="modal-overlay" id="preview-modal">
  <div class="modal">
    <div class="modal__header">
      <h3 class="modal__title" id="preview-title">Report Preview</h3>
      <button class="modal__close" onclick="closePreview()">&times;</button>
    </div>
    <div class="modal__body" id="preview-body">
      <div class="loading">
        <div class="spinner"></div>
        Loading...
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn-secondary" onclick="closePreview()">Cancel</button>
      <button class="btn-primary" id="preview-download-btn">Download</button>
    </div>
  </div>
</div>

<script>
// State
let selectedBusiness = 'all';
let selectedFormat = 'excel';
let currentReportId = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  initDatePickers();
  initPills();
  initFormatBtns();
  loadStats();
  loadReports();
});

function initDatePickers() {
  const today = new Date();
  const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  document.getElementById('date-from').value = formatDate(firstOfMonth);
  document.getElementById('date-to').value = formatDate(today);
}

function formatDate(d) {
  return d.toISOString().split('T')[0];
}

function initPills() {
  document.querySelectorAll('.pill').forEach(pill => {
    pill.addEventListener('click', () => {
      document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      selectedBusiness = pill.dataset.value;
      document.getElementById('business-type').value = selectedBusiness;
    });
  });
}

function initFormatBtns() {
  document.querySelectorAll('.format-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedFormat = btn.dataset.format;
      document.getElementById('format').value = selectedFormat;
    });
  });
}

async function loadStats() {
  try {
    const res = await fetch('/api/reports/stats');
    if (res.ok) {
      const data = await res.json();
      document.getElementById('stat-total').textContent = '$' + (data.total_amount || 0).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
      document.getElementById('stat-transactions').textContent = (data.total_transactions || 0).toLocaleString();
      document.getElementById('stat-match').textContent = (data.match_rate || 0).toFixed(0) + '%';
      document.getElementById('stat-pending').textContent = (data.pending_review || 0).toLocaleString();
    }
  } catch (e) { console.error('Stats error:', e); }
}

async function loadReports() {
  const container = document.getElementById('report-list');
  try {
    const res = await fetch('/reports/list');
    if (!res.ok) throw new Error('Failed');
    const data = await res.json();

    if (!data.reports || data.reports.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state__icon">üìã</div>
          <div class="empty-state__text">No reports yet. Create your first one!</div>
        </div>
      `;
      return;
    }

    container.innerHTML = data.reports.slice(0, 8).map(r => `
      <div class="report-item" onclick="viewReport('${r.report_id}')">
        <div class="report-item__icon">üìÑ</div>
        <div class="report-item__info">
          <div class="report-item__name">${r.report_name || r.report_id}</div>
          <div class="report-item__meta">
            <span>${r.business_type || 'All'}</span>
            <span>${r.expense_count || 0} items</span>
            <span>$${(r.total_amount || 0).toLocaleString()}</span>
          </div>
        </div>
        <div class="report-item__actions">
          <button class="action-btn" onclick="event.stopPropagation(); downloadReport('${r.report_id}', 'excel')">Excel</button>
          <button class="action-btn" onclick="event.stopPropagation(); downloadReport('${r.report_id}', 'csv')">CSV</button>
          <button class="action-btn action-btn--danger" onclick="event.stopPropagation(); deleteReport('${r.report_id}', '${(r.report_name || r.report_id).replace(/'/g, "\\'")}')">Delete</button>
        </div>
      </div>
    `).join('');
  } catch (e) {
    console.error('Load error:', e);
    container.innerHTML = `<div class="empty-state"><div class="empty-state__text" style="color: var(--error);">Failed to load reports</div></div>`;
  }
}

async function generateQuickReport(period, business) {
  const today = new Date();
  let dateFrom, dateTo;

  switch (period) {
    case 'this_month':
      dateFrom = new Date(today.getFullYear(), today.getMonth(), 1);
      dateTo = today;
      break;
    case 'ytd':
      dateFrom = new Date(today.getFullYear(), 0, 1);
      dateTo = today;
      break;
    case 'last_quarter':
      const q = Math.floor(today.getMonth() / 3);
      dateFrom = new Date(today.getFullYear(), (q - 1) * 3, 1);
      dateTo = new Date(today.getFullYear(), q * 3, 0);
      break;
    default:
      dateFrom = new Date(today.getFullYear(), today.getMonth(), 1);
      dateTo = today;
  }

  await generateReport({
    business_type: business,
    date_from: formatDate(dateFrom),
    date_to: formatDate(dateTo),
    report_type: 'expense_detail',
    format: 'excel'
  });
}

async function generateCustomReport(e) {
  e.preventDefault();
  const form = new FormData(e.target);
  await generateReport({
    business_type: form.get('business_type'),
    date_from: form.get('date_from'),
    date_to: form.get('date_to'),
    report_type: form.get('report_type'),
    format: form.get('format')
  });
}

async function generateReport(params) {
  showToast('Generating report...', 'info');
  try {
    const res = await csrfFetch('/api/reports/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params)
    });

    if (!res.ok) throw new Error((await res.json()).error || 'Failed');

    const contentType = res.headers.get('content-type');
    if (contentType?.includes('application/json')) {
      const data = await res.json();
      if (data.download_url) window.location.href = data.download_url;
      showToast('Report generated!', 'success');
    } else {
      const blob = await res.blob();
      const filename = res.headers.get('content-disposition')?.match(/filename="?([^"]+)"?/)?.[1] || `report.${params.format}`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Downloaded!', 'success');
    }
    loadReports();
  } catch (e) {
    showToast(e.message || 'Failed to generate', 'error');
  }
}

async function viewReport(id) {
  currentReportId = id;
  const modal = document.getElementById('preview-modal');
  const body = document.getElementById('preview-body');
  modal.classList.add('active');
  body.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

  try {
    const res = await fetch(`/reports/${id}`);
    if (!res.ok) throw new Error('Failed');
    const data = await res.json();

    document.getElementById('preview-title').textContent = data.report_name || id;

    // Calculate math breakdown
    let purchases = 0;  // Regular expenses (negative amounts, not payments)
    let returns = 0;    // Refunds/credits (positive amounts, not payments)
    let payments = 0;   // Credit card payments
    let purchaseCount = 0;
    let returnCount = 0;
    let paymentCount = 0;

    if (data.expenses?.length) {
      data.expenses.forEach(e => {
        const amount = parseFloat(e['Chase Amount'] || 0);
        const desc = (e['Chase Description'] || '').toLowerCase();

        // Payment detection: Chase payments, autopay, balance transfers
        const isPayment = desc.includes('payment') ||
                          desc.includes('autopay') ||
                          desc.includes('automatic payment') ||
                          desc.includes('thank you');

        if (isPayment) {
          payments += Math.abs(amount);
          paymentCount++;
        } else if (amount > 0) {
          // Positive = return/refund
          returns += amount;
          returnCount++;
        } else {
          // Negative = purchase/charge
          purchases += Math.abs(amount);
          purchaseCount++;
        }
      });
    }

    const netTotal = purchases - returns;

    let html = `
      <div class="preview-summary">
        <div class="preview-stat">
          <div class="preview-stat__value">${data.count || 0}</div>
          <div class="preview-stat__label">Transactions</div>
        </div>
        <div class="preview-stat">
          <div class="preview-stat__value">$${netTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
          <div class="preview-stat__label">Net Total</div>
        </div>
        <div class="preview-stat">
          <div class="preview-stat__value">${data.business_type || 'All'}</div>
          <div class="preview-stat__label">Business</div>
        </div>
      </div>

      <div class="math-breakdown">
        <div class="math-row math-row--purchases">
          <span class="math-row__label">Purchases (${purchaseCount})</span>
          <span class="math-row__value">-$${purchases.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>
        <div class="math-row math-row--returns">
          <span class="math-row__label">Returns (${returnCount})</span>
          <span class="math-row__value">+$${returns.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>
        ${payments > 0 ? `
        <div class="math-row math-row--payments">
          <span class="math-row__label">Payments (${paymentCount})</span>
          <span class="math-row__value">$${payments.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>
        ` : ''}
        <div class="math-total">
          <span class="math-total__label">Net Expenses</span>
          <span class="math-total__value">$${netTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>
      </div>
    `;

    if (data.expenses?.length) {
      html += `
        <table class="preview-table">
          <thead><tr><th>Date</th><th>Description</th><th style="text-align:right">Amount</th></tr></thead>
          <tbody>
            ${data.expenses.slice(0, 15).map(e => {
              const amount = parseFloat(e['Chase Amount'] || 0);
              const amountClass = amount > 0 ? 'color: var(--success)' : '';
              return `
              <tr>
                <td>${e['Chase Date'] || ''}</td>
                <td>${(e['Chase Description'] || '').substring(0, 35)}${(e['Chase Description'] || '').length > 35 ? '...' : ''}</td>
                <td style="text-align:right; ${amountClass}">${amount > 0 ? '+' : '-'}$${Math.abs(amount).toFixed(2)}</td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
        ${data.expenses.length > 15 ? `<div class="preview-more">Showing 15 of ${data.expenses.length}</div>` : ''}
      `;
    }
    body.innerHTML = html;
  } catch (e) {
    body.innerHTML = '<div class="empty-state"><div class="empty-state__text" style="color:var(--error)">Failed to load</div></div>';
  }
}

function closePreview() {
  document.getElementById('preview-modal').classList.remove('active');
}

function downloadReport(id, format) {
  const urls = {
    excel: `/api/reports/${id}/export/excel`,
    csv: `/api/reports/${id}/export/csv`,
    pdf: `/api/reports/${id}/export/pdf`
  };
  window.location.href = urls[format] || urls.excel;
  showToast('Downloading...', 'info');
}

async function deleteReport(id, name) {
  if (!confirm(`Delete report "${name}"?\n\nThis will unlink all transactions from this report. The transactions themselves will NOT be deleted.`)) {
    return;
  }

  showToast('Deleting report...', 'info');
  try {
    const res = await csrfFetch(`/api/reports/${id}`, {
      method: 'DELETE'
    });

    if (!res.ok) {
      const data = await res.json();
      throw new Error(data.error || 'Failed to delete report');
    }

    showToast('Report deleted!', 'success');
    loadReports();
    loadStats();
  } catch (e) {
    showToast(e.message || 'Failed to delete', 'error');
  }
}

document.getElementById('preview-download-btn').addEventListener('click', () => {
  if (currentReportId) { downloadReport(currentReportId, 'excel'); closePreview(); }
});

function showToast(msg, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚óâ' };
  toast.innerHTML = `<span class="toast__icon">${icons[type]}</span><span class="toast__message">${msg}</span>`;
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}

document.getElementById('preview-modal').addEventListener('click', e => {
  if (e.target.classList.contains('modal-overlay')) closePreview();
});

document.addEventListener('keydown', e => { if (e.key === 'Escape') closePreview(); });
</script>

</body>
</html>
