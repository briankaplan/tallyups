# ReceiptAI Docker Compose Configuration
# =======================================
# For local development and testing
#
# Usage:
#   docker-compose up -d           # Start all services
#   docker-compose logs -f web     # View web logs
#   docker-compose down            # Stop all services

version: '3.8'

services:
  # ==========================================================================
  # Web Application
  # ==========================================================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - FLASK_ENV=development
      - RAILWAY_ENVIRONMENT=development
      - DB_READ_ONLY=false
      - MYSQL_URL=mysql://root:receiptai_dev@mysql:3306/receiptai
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-bkreceipts}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      # Mount source code for hot reload in development
      - .:/app
      # Persist data directory
      - receiptai_data:/app/data
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - receiptai_network

  # ==========================================================================
  # MySQL Database (Local Development Only)
  # ==========================================================================
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=receiptai_dev
      - MYSQL_DATABASE=receiptai
    ports:
      - "3306:3306"
    volumes:
      # Persist database
      - mysql_data:/var/lib/mysql
      # Initialize with schema
      - ./migrations/001_initial_schema.sql:/docker-entrypoint-initdb.d/001_initial_schema.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-preceiptai_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - receiptai_network

  # ==========================================================================
  # Redis Cache (Optional)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - receiptai_network
    profiles:
      - with-cache

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  receiptai_data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  receiptai_network:
    driver: bridge
