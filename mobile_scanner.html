<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tallyups">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/static/css/design-system.css">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
  <title>Tallyups Scanner</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    :root {
      --bg: #000000;
      --bg-card: #111111;
      --bg-elevated: #1a1a1a;
      --accent: #00ff88;
      --accent-dim: rgba(0, 255, 136, 0.15);
      --text: #ffffff;
      --text-dim: #666666;
      --text-secondary: #999999;
      --border: #222222;
      --success: #00ff88;
      --warning: #ffaa00;
      --error: #ff4444;
      --glass: rgba(255, 255, 255, 0.05);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
      touch-action: pan-y;
    }

    /* PWA Install Banner */
    .install-banner {
      position: fixed;
      bottom: calc(70px + var(--safe-bottom));
      left: 16px;
      right: 16px;
      background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));
      border: 1px solid var(--accent);
      border-radius: 20px;
      padding: 16px 20px;
      display: none;
      align-items: center;
      gap: 14px;
      z-index: 150;
      box-shadow: 0 8px 32px rgba(0, 255, 136, 0.2);
      animation: slideUp 0.4s ease-out;
    }

    .install-banner.visible {
      display: flex;
    }

    .install-banner-icon {
      width: 48px;
      height: 48px;
      background: var(--accent);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .install-banner-icon svg {
      width: 24px;
      height: 24px;
      color: #000;
    }

    .install-banner-content {
      flex: 1;
    }

    .install-banner-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .install-banner-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .install-banner-btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    /* iOS Install Modal */
    .ios-install-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .ios-install-modal.visible { display: flex; }
    .ios-install-content {
      background: var(--bg-elevated);
      border-radius: 24px;
      padding: 32px 24px;
      max-width: 340px;
      width: 100%;
      text-align: center;
      border: 1px solid var(--border);
    }
    .ios-install-icon {
      width: 80px;
      height: 80px;
      background: var(--accent);
      border-radius: 20px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ios-install-icon svg { width: 40px; height: 40px; color: #000; }
    .ios-install-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .ios-install-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }
    .ios-install-steps {
      text-align: left;
      margin-bottom: 24px;
    }
    .ios-step {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .ios-step:last-child { border-bottom: none; }
    .ios-step-num {
      width: 28px;
      height: 28px;
      background: var(--accent);
      color: #000;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }
    .ios-step-text {
      font-size: 15px;
      line-height: 1.4;
    }
    .ios-step-text svg {
      width: 18px;
      height: 18px;
      vertical-align: middle;
      margin: 0 2px;
    }
    .ios-install-btn {
      width: 100%;
      background: var(--accent);
      color: #000;
      border: none;
      padding: 16px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .install-banner-close {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-dim);
    }

    /* Offline Banner */
    .offline-banner {
      position: fixed;
      top: calc(var(--safe-top) + 60px);
      left: 16px;
      right: 16px;
      background: var(--warning);
      color: #000;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
      z-index: 160;
      animation: slideDown 0.3s ease-out;
    }

    .offline-banner.visible {
      display: flex;
    }

    .offline-banner svg {
      width: 16px;
      height: 16px;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: calc(var(--safe-top) + 8px) 20px 12px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.98) 60%, transparent);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Top Navigation Links */
    .nav-links {
      display: none;
      gap: 4px;
      margin-left: auto;
      margin-right: 16px;
    }
    @media (min-width: 1024px) {
      .nav-links { display: flex; }
    }
    .nav-link-btn {
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid transparent;
      transition: all 0.15s;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .nav-link-btn:hover {
      background: rgba(0, 255, 136, 0.15);
      color: var(--text);
    }
    .nav-link-btn.active {
      background: rgba(0, 255, 136, 0.15);
      color: var(--accent);
      border-color: rgba(0, 255, 136, 0.2);
    }
    .nav-link-btn svg { width: 16px; height: 16px; }

    /* Mobile Bottom Navigation */
    .mobile-nav {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(17, 17, 17, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      padding: 8px 0 calc(8px + var(--safe-bottom));
      z-index: 200;
    }
    @media (min-width: 1024px) {
      .mobile-nav { display: none; }
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 4px;
      text-decoration: none;
      color: var(--text-dim);
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }
    .nav-item svg {
      width: 22px;
      height: 22px;
      transition: transform 0.2s ease;
    }
    .nav-item span {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .nav-item.active {
      color: var(--accent);
    }
    .nav-item.active svg {
      transform: scale(1.1);
    }
    .nav-item.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: var(--accent);
      border-radius: 0 0 3px 3px;
    }
    .nav-item:active {
      transform: scale(0.95);
    }
    .nav-item .nav-badge {
      position: absolute;
      top: 4px;
      right: 50%;
      transform: translateX(12px);
      min-width: 16px;
      height: 16px;
      background: var(--error);
      border-radius: 8px;
      font-size: 10px;
      font-weight: 700;
      color: white;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    .nav-item .nav-badge.visible {
      display: flex;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg {
      width: 18px;
      height: 18px;
      color: #000;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--glass);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    .status-dot.offline {
      background: var(--warning);
    }

    .status-dot.syncing {
      background: var(--accent);
      animation: spin 1s linear infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.85); }
    }

    /* Main Container */
    .main {
      height: 100%;
      padding-top: calc(var(--safe-top) + 64px);
      padding-bottom: calc(80px + var(--safe-bottom));
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    @media (min-width: 1024px) {
      .main { padding-bottom: calc(20px + var(--safe-bottom)); }
    }

    /* Camera View */
    .camera-view {
      position: relative;
      width: 100%;
      padding: 16px;
    }

    .camera-frame {
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
      background: var(--bg-card);
      border-radius: 28px;
      overflow: hidden;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
    }

    .camera-frame.has-image {
      border-color: var(--accent);
      box-shadow: 0 0 60px var(--accent-dim), inset 0 0 30px rgba(0, 255, 136, 0.05);
    }

    .camera-frame.drag-over {
      border-color: var(--accent);
      background: var(--accent-dim);
      transform: scale(1.02);
    }

    #video-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    #image-preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      display: none;
    }

    .camera-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      padding: 40px;
    }

    .scan-icon {
      width: 100px;
      height: 100px;
      border: 2px dashed var(--border);
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .scan-icon svg {
      width: 44px;
      height: 44px;
      color: var(--text-dim);
    }

    .scan-hint {
      text-align: center;
    }

    .scan-hint h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text);
    }

    .scan-hint p {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* Corner markers */
    .corner-markers {
      position: absolute;
      inset: 24px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .camera-frame.has-image .corner-markers {
      opacity: 1;
    }

    .corner {
      position: absolute;
      width: 28px;
      height: 28px;
      border-color: var(--accent);
      border-style: solid;
      border-width: 0;
    }

    .corner.tl { top: 0; left: 0; border-top-width: 3px; border-left-width: 3px; border-top-left-radius: 10px; }
    .corner.tr { top: 0; right: 0; border-top-width: 3px; border-right-width: 3px; border-top-right-radius: 10px; }
    .corner.bl { bottom: 0; left: 0; border-bottom-width: 3px; border-left-width: 3px; border-bottom-left-radius: 10px; }
    .corner.br { bottom: 0; right: 0; border-bottom-width: 3px; border-right-width: 3px; border-bottom-right-radius: 10px; }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 12px;
      padding: 0 16px;
      margin-top: 20px;
    }

    .action-btn {
      flex: 1;
      height: 60px;
      border: none;
      border-radius: 18px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(255,255,255,0.3) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .action-btn:active::before {
      opacity: 1;
    }

    .action-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
      pointer-events: none;
    }

    .action-btn svg {
      width: 22px;
      height: 22px;
      transition: transform 0.2s ease;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, var(--accent), #00cc6a);
      color: #000;
      box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
    }

    .action-btn.primary:active {
      transform: scale(0.96);
      box-shadow: 0 2px 10px rgba(0, 255, 136, 0.2);
    }

    .action-btn.primary svg {
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }

    .action-btn.secondary {
      background: var(--bg-elevated);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .action-btn.secondary:active {
      background: var(--border);
      transform: scale(0.96);
    }

    /* Pending uploads badge */
    .pending-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 22px;
      height: 22px;
      background: var(--warning);
      color: #000;
      border-radius: 11px;
      font-size: 12px;
      font-weight: 800;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
    }

    .pending-badge.visible {
      display: flex;
    }

    /* AI Extraction Panel */
    .extraction-panel {
      padding: 16px;
      display: none;
    }

    .extraction-panel.visible {
      display: block;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--accent-dim);
      border-radius: 24px;
      font-size: 13px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 18px;
    }

    .ai-badge svg {
      width: 16px;
      height: 16px;
    }

    .extraction-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid var(--border);
    }

    .field-group {
      margin-bottom: 22px;
    }

    .field-group:last-child {
      margin-bottom: 0;
    }

    .field-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 10px;
    }

    .field-input {
      width: 100%;
      height: 56px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 0 18px;
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
      outline: none;
      transition: all 0.2s;
      -webkit-appearance: none;
    }

    .field-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-dim);
    }

    .field-input::placeholder {
      color: var(--text-dim);
      font-weight: 500;
    }

    .field-input.ai-filled {
      border-color: var(--accent);
      background: linear-gradient(135deg, var(--accent-dim), transparent);
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    /* Amount field */
    .amount-input {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -1px;
      text-align: center;
    }

    /* Business chips */
    .business-chips {
      display: flex;
      gap: 10px;
    }

    .biz-chip {
      flex: 1;
      padding: 16px 12px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .biz-chip:active {
      transform: scale(0.96);
    }

    .biz-chip.selected {
      background: var(--accent-dim);
      border-color: var(--accent);
    }

    .biz-chip-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }

    .biz-chip-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
    }

    .biz-chip.selected .biz-chip-label {
      color: var(--accent);
    }

    /* Transaction match */
    .match-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .match-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .match-header svg {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    .match-header span {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent);
    }

    .match-card {
      background: var(--bg);
      border: 2px solid var(--accent);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .match-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .match-merchant {
      font-size: 16px;
      font-weight: 700;
    }

    .match-meta {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .match-amount {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
    }

    /* Submit section */
    .submit-section {
      padding: 20px 16px;
      padding-bottom: calc(20px + var(--safe-bottom));
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      background: linear-gradient(to top, var(--bg) 85%, transparent);
    }

    .submit-btn {
      width: 100%;
      height: 60px;
      background: linear-gradient(135deg, var(--accent), #00cc6a);
      color: #000;
      border: none;
      border-radius: 18px;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 255, 136, 0.35);
      -webkit-tap-highlight-color: transparent;
    }

    .submit-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(255,255,255,0.4) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .submit-btn:active::before {
      opacity: 1;
    }

    .submit-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
      pointer-events: none;
    }

    .submit-btn:active {
      transform: scale(0.97);
      box-shadow: 0 2px 12px rgba(0, 255, 136, 0.25);
    }

    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
    }

    .submit-btn svg {
      width: 22px;
      height: 22px;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }

    /* Save to Device Button */
    .submit-section {
      display: flex;
      gap: 12px;
    }

    .save-device-btn {
      width: 60px;
      height: 60px;
      background: var(--bg-card);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 18px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .save-device-btn:active {
      transform: scale(0.95);
      background: var(--bg);
    }

    .save-device-btn svg {
      width: 20px;
      height: 20px;
    }

    .save-device-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .submit-btn {
      flex: 1;
    }

    
    /* Processing Overlay */
    .processing-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.97);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 28px;
      z-index: 200;
    }

    .processing-overlay.visible {
      display: flex;
    }

    .ai-processing {
      width: 100px;
      height: 100px;
      position: relative;
    }

    .ai-ring {
      position: absolute;
      inset: 0;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .ai-ring:nth-child(2) {
      inset: 10px;
      animation-direction: reverse;
      animation-duration: 0.75s;
      border-top-color: var(--warning);
    }

    .ai-ring:nth-child(3) {
      inset: 20px;
      animation-duration: 1.25s;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .processing-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .processing-step {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Success Modal */
    .success-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.97);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 24px;
    }

    .success-modal.visible {
      display: flex;
    }

    .success-card {
      background: var(--bg-card);
      border-radius: 28px;
      padding: 48px 32px;
      text-align: center;
      max-width: 340px;
      width: 100%;
      border: 1px solid var(--border);
      animation: scaleIn 0.3s ease-out;
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .success-icon {
      width: 88px;
      height: 88px;
      background: var(--accent-dim);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 28px;
      animation: successPop 0.4s ease-out 0.2s both;
    }

    @keyframes successPop {
      0% { transform: scale(0); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .success-icon svg {
      width: 44px;
      height: 44px;
      color: var(--accent);
    }

    .success-card h3 {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 10px;
    }

    .success-card p {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 36px;
      line-height: 1.6;
    }

    .success-actions {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .success-btn {
      width: 100%;
      height: 56px;
      border-radius: 16px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
    }

    .success-btn:active {
      transform: scale(0.97);
    }

    .success-btn.primary {
      background: var(--accent);
      color: #000;
    }

    .success-btn.secondary {
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
    }

    /* History View */
    .history-view {
      padding: 16px;
      display: none;
    }

    .history-view.visible {
      display: block;
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .history-header h2 {
      font-size: 24px;
      font-weight: 800;
    }

    .history-stats {
      display: flex;
      gap: 20px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      font-weight: 600;
    }

    /* Filter Chips */
    .history-filters {
      display: flex;
      gap: 8px;
      padding: 0 0 16px 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .history-filters::-webkit-scrollbar {
      display: none;
    }

    .filter-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-dim);
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      transition: all 0.2s;
      cursor: pointer;
    }

    .filter-chip:active {
      transform: scale(0.95);
    }

    .filter-chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
    }

    .filter-chip svg {
      opacity: 0.7;
    }

    .filter-chip.active svg {
      opacity: 1;
    }

    .filter-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .filter-dot.pending {
      background: var(--warning);
    }

    .filter-dot.accepted {
      background: var(--success);
    }

    /* Refresh Button */
    .refresh-inbox-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
    }

    .refresh-inbox-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .refresh-inbox-btn:active {
      transform: scale(0.98);
    }

    .refresh-inbox-btn.loading svg {
      animation: spin 1s linear infinite;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .history-item {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 18px;
      display: flex;
      gap: 16px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .history-item:active {
      transform: scale(0.98);
      background: var(--bg-elevated);
    }

    .history-thumb {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      object-fit: cover;
      background: var(--bg);
    }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .history-merchant {
      font-size: 16px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-amount {
      font-size: 17px;
      font-weight: 800;
    }

    .history-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .history-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--accent-dim);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
    }

    .history-status.pending {
      background: rgba(255, 170, 0, 0.15);
      color: var(--warning);
    }

    .history-status.accepted,
    .history-status.synced {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .history-status.rejected {
      background: rgba(255, 68, 68, 0.15);
      color: var(--error);
    }

    /* History Item Status Border */
    .history-item.pending {
      border-left: 3px solid var(--warning);
    }

    .history-item.accepted,
    .history-item.synced {
      border-left: 3px solid var(--accent);
    }

    .history-item.rejected {
      border-left: 3px solid var(--error);
      opacity: 0.7;
    }

    /* Source Icon */
    .history-source {
      display: flex;
      align-items: center;
      opacity: 0.6;
    }

    .history-source svg {
      display: block;
    }

    /* Thumbnail Placeholder */
    .history-thumb-placeholder {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      flex-shrink: 0;
    }

    /* Confidence Badge */
    .confidence-badge {
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 700;
    }

    .confidence-badge.high {
      background: rgba(0, 255, 136, 0.15);
      color: var(--accent);
    }

    .confidence-badge.medium {
      background: rgba(255, 170, 0, 0.15);
      color: var(--warning);
    }

    .confidence-badge.low {
      background: rgba(255, 68, 68, 0.15);
      color: var(--error);
    }

    /* Receipt Detail Modal */
    .receipt-detail-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: none;
      flex-direction: column;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .receipt-detail-modal.visible {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .receipt-detail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .receipt-detail-title {
      font-size: 17px;
      font-weight: 700;
    }

    .receipt-detail-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-card);
      border: none;
      color: var(--text);
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .receipt-detail-body {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .receipt-detail-image {
      width: 100%;
      max-height: 50vh;
      object-fit: contain;
      background: #000;
    }

    .receipt-detail-data {
      padding: 20px;
      background: var(--bg);
    }

    .receipt-detail-merchant {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .receipt-detail-amount {
      font-size: 28px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .receipt-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }

    .receipt-detail-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .receipt-detail-value {
      font-size: 14px;
      font-weight: 600;
      text-align: right;
      max-width: 60%;
    }

    .receipt-detail-notes {
      margin-top: 16px;
      padding: 16px;
      background: var(--bg-card);
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-secondary);
    }

    .receipt-detail-footer {
      padding: 16px 20px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      background: var(--bg);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    .receipt-detail-btn {
      flex: 1;
      padding: 16px;
      border-radius: 14px;
      border: none;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s;
    }

    .receipt-detail-btn:active {
      transform: scale(0.96);
    }

    .receipt-detail-btn.delete {
      background: rgba(255, 78, 106, 0.15);
      color: var(--error);
    }

    .receipt-detail-btn.sync {
      background: var(--accent);
      color: #000;
    }

    .receipt-detail-btn.synced {
      background: var(--bg-card);
      color: var(--text-secondary);
    }

    /* Swipe-to-delete indicator */
    .history-item {
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .history-delete-hint {
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: var(--text-dim);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .history-item:active .history-delete-hint {
      opacity: 1;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 80px 24px;
    }

    .empty-icon {
      width: 100px;
      height: 100px;
      background: var(--bg-card);
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .empty-icon svg {
      width: 44px;
      height: 44px;
      color: var(--text-dim);
    }

    .empty-state h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 15px;
      color: var(--text-secondary);
    }

    /* Toast */
    .toast {
      position: fixed;
      top: calc(var(--safe-top) + 70px);
      left: 16px;
      right: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      transform: translateY(-120%);
      opacity: 0;
      transition: all 0.3s ease-out;
      z-index: 170;
    }

    .toast.visible {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .toast-icon svg {
      width: 16px;
      height: 16px;
    }

    .toast.success .toast-icon {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .toast.error .toast-icon {
      background: rgba(255, 68, 68, 0.15);
      color: var(--error);
    }

    .toast.info .toast-icon {
      background: rgba(255, 170, 0, 0.15);
      color: var(--warning);
    }

    .toast-text {
      font-size: 15px;
      font-weight: 600;
    }

    /* Hidden inputs */
    #file-input, #batch-input {
      display: none;
    }

    /* Voice button */
    .voice-btn {
      position: absolute;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 6px 24px rgba(0, 255, 136, 0.35);
      transition: all 0.2s;
      z-index: 10;
    }

    .voice-btn:active {
      transform: scale(0.92);
    }

    .voice-btn svg {
      width: 26px;
      height: 26px;
      color: #000;
    }

    .voice-btn.recording {
      background: var(--error);
      animation: pulseRecord 1s infinite;
    }

    @keyframes pulseRecord {
      0%, 100% { box-shadow: 0 6px 24px rgba(255, 68, 68, 0.35); }
      50% { box-shadow: 0 6px 48px rgba(255, 68, 68, 0.6); }
    }

    /* Retake button */
    .retake-btn {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 44px;
      height: 44px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
    }

    .retake-btn.visible {
      display: flex;
    }

    .retake-btn svg {
      width: 22px;
      height: 22px;
      color: var(--text);
    }

    /* Flash toggle */
    .flash-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 44px;
      height: 44px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
    }

    .flash-btn.visible {
      display: flex;
    }

    .flash-btn.active {
      background: var(--warning);
    }

    .flash-btn svg {
      width: 22px;
      height: 22px;
      color: var(--text);
    }

    .flash-btn.active svg {
      color: #000;
    }

    /* Live Camera Mode */
    .camera-frame.live-mode #video-preview {
      display: block;
    }

    .camera-frame.live-mode .camera-placeholder {
      display: none;
    }

    /* Receipt Frame Detection Overlay */
    .frame-detection-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 5;
    }

    .frame-detection-overlay svg {
      width: 100%;
      height: 100%;
    }

    .detected-frame {
      fill: none;
      stroke: var(--accent);
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 0;
      transition: opacity 0.3s, d 0.2s;
    }

    .detected-frame.visible {
      opacity: 1;
      animation: framePulse 1.5s ease-in-out infinite;
    }

    @keyframes framePulse {
      0%, 100% { stroke-opacity: 1; }
      50% { stroke-opacity: 0.5; }
    }

    /* Batch Mode */
    .batch-mode-banner {
      position: fixed;
      top: calc(60px + var(--safe-top));
      left: 16px;
      right: 16px;
      background: linear-gradient(135deg, var(--accent), #00cc6b);
      color: #000;
      padding: 12px 16px;
      border-radius: 14px;
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 100;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4);
    }

    .batch-mode-banner.visible {
      display: flex;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .batch-count {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .batch-count-number {
      background: #000;
      color: var(--accent);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
    }

    .batch-done-btn {
      background: #000;
      color: var(--accent);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }

    /* Batch Mode Toggle Button */
    .batch-toggle {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s;
    }

    .batch-toggle:hover {
      background: var(--bg-card);
      border-color: var(--accent);
    }

    .batch-toggle.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    .batch-toggle svg {
      width: 18px;
      height: 18px;
    }

    /* Quick Capture Animation */
    .quick-capture-flash {
      position: absolute;
      inset: 0;
      background: #fff;
      opacity: 0;
      pointer-events: none;
      z-index: 20;
    }

    .quick-capture-flash.flash {
      animation: captureFlash 0.3s ease-out;
    }

    @keyframes captureFlash {
      0% { opacity: 0.8; }
      100% { opacity: 0; }
    }

    /* Batch Queue Thumbnails */
    .batch-queue {
      display: none;
      gap: 8px;
      padding: 12px 16px;
      overflow-x: auto;
      background: var(--bg-elevated);
      border-top: 1px solid var(--border);
    }

    .batch-queue.visible {
      display: flex;
    }

    .batch-thumbnail {
      width: 60px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      position: relative;
      border: 2px solid var(--border);
    }

    .batch-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .batch-thumbnail .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 22px;
      height: 22px;
      background: var(--error);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .batch-thumbnail.processing {
      border-color: var(--accent);
    }

    .batch-thumbnail.processing::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0, 255, 136, 0.3);
      animation: processingPulse 1s ease-in-out infinite;
    }

    @keyframes processingPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    /* Haptic feedback visual */
    .haptic-flash {
      position: fixed;
      inset: 0;
      background: var(--accent);
      opacity: 0;
      pointer-events: none;
      z-index: 300;
      transition: opacity 0.1s;
    }

    .haptic-flash.active {
      opacity: 0.15;
    }

    /* Tip Section */
    .tip-section {
      background: var(--bg-elevated);
      border-radius: 16px;
      padding: 16px;
      margin-top: 16px;
      border: 1px solid var(--border);
    }

    .tip-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--accent);
    }

    .tip-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 15px;
    }

    .tip-label {
      color: var(--text-secondary);
    }

    .tip-percent {
      margin-left: 8px;
      color: var(--text-dim);
      font-size: 13px;
    }

    .tip-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .tip-btn {
      flex: 1;
      padding: 10px 8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .tip-btn:active {
      transform: scale(0.95);
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    .tip-btn.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    /* Purpose Prompt */
    .purpose-prompt {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 136, 0.05));
      border: 1px solid var(--accent);
      border-radius: 16px;
      padding: 16px;
      margin-top: 16px;
    }

    .purpose-header {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      text-align: center;
    }

    .purpose-header span {
      color: var(--accent);
    }

    .purpose-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .purpose-btn {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .purpose-btn:active {
      transform: scale(0.95);
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    /* OCR Speed Indicator */
    .ocr-speed {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.7);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      color: var(--accent);
      font-weight: 600;
    }

    /* Location Badge */
    .location-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    .location-badge svg {
      width: 14px;
      height: 14px;
      color: var(--accent);
    }

    /* Duplicate Warning Modal */
    .duplicate-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      z-index: 250;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .duplicate-modal.visible { display: flex; }
    .duplicate-content {
      background: var(--bg-card);
      border: 2px solid var(--warning);
      border-radius: 24px;
      padding: 24px;
      max-width: 340px;
      width: 100%;
      text-align: center;
    }
    .duplicate-icon {
      width: 64px;
      height: 64px;
      background: rgba(255, 170, 0, 0.2);
      border-radius: 50%;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .duplicate-icon svg { width: 32px; height: 32px; color: var(--warning); }
    .duplicate-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .duplicate-subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; }
    .duplicate-match {
      background: var(--bg-elevated);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 20px;
      text-align: left;
    }
    .duplicate-match-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 6px;
    }
    .duplicate-match-row:last-child { margin-bottom: 0; }
    .duplicate-match-label { color: var(--text-secondary); }
    .duplicate-actions { display: flex; gap: 12px; }
    .duplicate-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .duplicate-btn.secondary {
      background: var(--bg-elevated);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .duplicate-btn.primary {
      background: var(--warning);
      color: #000;
    }

    /* Quality Warning */
    .quality-warning {
      background: rgba(255, 68, 68, 0.15);
      border: 1px solid var(--error);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 12px;
    }
    .quality-warning.visible { display: flex; }
    .quality-warning svg { width: 20px; height: 20px; color: var(--error); flex-shrink: 0; }
    .quality-warning-text { font-size: 13px; color: var(--text); }

    /* Split Receipt Section */
    .split-section {
      background: var(--bg-elevated);
      border-radius: 16px;
      padding: 16px;
      margin-top: 16px;
      border: 1px solid var(--border);
    }
    .split-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .split-header span { font-size: 14px; font-weight: 600; }
    .split-toggle {
      width: 44px;
      height: 24px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      position: relative;
      cursor: pointer;
    }
    .split-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: var(--text-dim);
      border-radius: 50%;
      transition: all 0.2s;
    }
    .split-toggle.active { background: var(--accent-dim); border-color: var(--accent); }
    .split-toggle.active::after { left: 22px; background: var(--accent); }
    .split-options { display: none; gap: 8px; margin-top: 12px; }
    .split-options.visible { display: flex; flex-wrap: wrap; }
    .split-chip {
      padding: 8px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .split-chip.active { background: var(--accent); color: #000; border-color: var(--accent); }
    .split-chip input {
      width: 50px;
      background: transparent;
      border: none;
      color: inherit;
      font-size: 13px;
      text-align: center;
    }

    /* Voice Notes */
    .voice-section {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }
    .voice-btn {
      width: 48px;
      height: 48px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .voice-btn svg { width: 20px; height: 20px; color: var(--text); }
    .voice-btn.recording {
      background: var(--error);
      border-color: var(--error);
      animation: pulse 1s infinite;
    }
    .voice-btn.recording svg { color: #fff; }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .voice-status {
      flex: 1;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .voice-status.recording { color: var(--error); font-weight: 600; }
    .voice-playback {
      display: none;
      align-items: center;
      gap: 8px;
    }
    .voice-playback.visible { display: flex; }
    .voice-play {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .voice-play svg { width: 14px; height: 14px; color: #000; }
    .voice-duration { font-size: 12px; color: var(--text-secondary); }
    .voice-delete {
      width: 24px;
      height: 24px;
      background: transparent;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .voice-delete svg { width: 16px; height: 16px; color: var(--text-dim); }

    /* Quick Templates */
    .templates-section {
      position: absolute;
      bottom: calc(70px + var(--safe-bottom));
      left: 0;
      right: 0;
      padding: 0 16px 16px;
      display: none;
    }
    .templates-section.visible { display: block; }
    .templates-header {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    .templates-grid {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }
    .template-card {
      flex-shrink: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 18px;
      cursor: pointer;
      transition: all 0.15s;
      min-width: 100px;
      text-align: center;
    }
    .template-card:active {
      transform: scale(0.95);
      background: var(--accent);
      border-color: var(--accent);
    }
    .template-card:active * { color: #000 !important; }
    .template-icon { font-size: 24px; margin-bottom: 6px; }
    .template-name { font-size: 13px; font-weight: 600; }
    .template-amount { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

    /* App shell spacing for bottom nav */
    body { padding-bottom: 80px; }
  </style>
  <!-- Design System & App Shell -->
  <link rel="stylesheet" href="/static/css/design-system.css">
  <script src="/static/js/app-shell.js" defer></script>
<script src="/static/js/design-system.js"></script>
</head>
<body>
  <!-- Haptic Flash -->
  <div class="haptic-flash" id="haptic-flash"></div>

  <!-- Offline Banner -->
  <div class="offline-banner" id="offline-banner">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <line x1="1" y1="1" x2="23" y2="23"></line>
      <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path>
      <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path>
      <path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path>
      <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path>
      <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
      <line x1="12" y1="20" x2="12.01" y2="20"></line>
    </svg>
    Offline - Receipts will sync when connected
  </div>

  <!-- Install Banner -->
  <div class="install-banner" id="install-banner">
    <button class="install-banner-close" onclick="dismissInstall()"></button>
    <div class="install-banner-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    </div>
    <div class="install-banner-content">
      <div class="install-banner-title">Install Tallyups</div>
      <div class="install-banner-desc">Add to home screen for the best experience</div>
    </div>
    <button class="install-banner-btn" onclick="installApp()">Install</button>
  </div>

  <!-- Duplicate Warning Modal -->
  <div class="duplicate-modal" id="duplicate-modal">
    <div class="duplicate-content">
      <div class="duplicate-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
      </div>
      <div class="duplicate-title">Possible Duplicate</div>
      <div class="duplicate-subtitle">This receipt may already exist</div>
      <div class="duplicate-match">
        <div class="duplicate-match-row">
          <span class="duplicate-match-label">Merchant</span>
          <span id="dup-merchant"></span>
        </div>
        <div class="duplicate-match-row">
          <span class="duplicate-match-label">Amount</span>
          <span id="dup-amount"></span>
        </div>
        <div class="duplicate-match-row">
          <span class="duplicate-match-label">Date</span>
          <span id="dup-date"></span>
        </div>
      </div>
      <div class="duplicate-actions">
        <button class="duplicate-btn secondary" onclick="closeDuplicateModal()">Save Anyway</button>
        <button class="duplicate-btn primary" onclick="useDuplicate()">Use Existing</button>
      </div>
    </div>
  </div>

  <!-- iOS Install Modal -->
  <div class="ios-install-modal" id="ios-install-modal" onclick="closeIosInstall(event)">
    <div class="ios-install-content" onclick="event.stopPropagation()">
      <div class="ios-install-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      </div>
      <div class="ios-install-title">Add to Home Screen</div>
      <div class="ios-install-subtitle">Install Tallyups for the best experience</div>
      <div class="ios-install-steps">
        <div class="ios-step">
          <div class="ios-step-num">1</div>
          <div class="ios-step-text">Tap the <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> Share button below</div>
        </div>
        <div class="ios-step">
          <div class="ios-step-num">2</div>
          <div class="ios-step-text">Scroll down and tap <strong>"Add to Home Screen"</strong></div>
        </div>
        <div class="ios-step">
          <div class="ios-step-num">3</div>
          <div class="ios-step-text">Tap <strong>"Add"</strong> in the top right</div>
        </div>
      </div>
      <button class="ios-install-btn" onclick="closeIosInstall()">Got it</button>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
        </div>
        Tallyups
      </div>

      <!-- Desktop Navigation Links -->
      <nav class="nav-links">
        <a href="/" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Home
        </a>
        <a href="/viewer" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
          Reconcile
        </a>
        <a href="/library" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          Library
        </a>
        <a href="/scanner" class="nav-link-btn active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
          Scan
        </a>
        <a href="/incoming" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg>
          Inbox
        </a>
        <a href="/reports" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Reports
        </a>
        <a href="/gmail" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Gmail
        </a>
      </nav>

      <div class="status-pill" id="status-pill">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Ready</span>
      </div>
    </div>
  </header>

  <!-- Batch Mode Banner -->
  <div class="batch-mode-banner" id="batch-banner">
    <div class="batch-count">
      <span class="batch-count-number" id="batch-count">0</span>
      <span>receipts captured</span>
    </div>
    <button class="batch-done-btn" id="batch-done-btn">Done</button>
  </div>

  <!-- Main Content -->
  <main class="main">
    <!-- Camera View -->
    <section class="camera-view" id="camera-view">
      <div class="camera-frame" id="camera-frame">
        <video id="video-preview" autoplay playsinline muted></video>
        <img id="image-preview" alt="Receipt">

        <!-- Frame Detection Overlay -->
        <div class="frame-detection-overlay" id="frame-overlay">
          <svg viewBox="0 0 100 100" preserveAspectRatio="none">
            <path id="detected-frame" class="detected-frame" d="M10,10 L90,10 L90,90 L10,90 Z"/>
          </svg>
        </div>

        <!-- Quick Capture Flash -->
        <div class="quick-capture-flash" id="capture-flash"></div>

        <!-- Batch Mode Toggle -->
        <button class="batch-toggle" id="batch-toggle" title="Batch scanning mode">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          Batch
        </button>

        <!-- Retake button -->
        <button class="retake-btn" id="retake-btn" title="Retake">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="1 4 1 10 7 10"></polyline>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
          </svg>
        </button>

        <!-- Flash toggle -->
        <button class="flash-btn" id="flash-btn" title="Toggle flash">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
          </svg>
        </button>

        <div class="camera-placeholder" id="camera-placeholder">
          <div class="scan-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
          </div>
          <div class="scan-hint">
            <h2>Scan Receipt</h2>
            <p>Tap to capture or drag & drop.<br>AI extracts everything automatically.</p>
          </div>
        </div>

        <div class="corner-markers">
          <div class="corner tl"></div>
          <div class="corner tr"></div>
          <div class="corner bl"></div>
          <div class="corner br"></div>
        </div>

        <!-- Voice Button -->
        <button class="voice-btn" id="voice-btn" title="Voice note">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
          </svg>
        </button>
      </div>

      <div class="quick-actions">
        <button class="action-btn primary" id="capture-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="4" fill="currentColor"></circle>
          </svg>
          Capture
        </button>
        <button class="action-btn secondary" id="gallery-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
          Gallery
          <span class="pending-badge" id="pending-badge">0</span>
        </button>
      </div>

      <!-- Batch Queue (shows thumbnails of captured receipts) -->
      <div class="batch-queue" id="batch-queue"></div>

      <!-- Quick Templates -->
      <div class="templates-section visible" id="templates-section">
        <div class="templates-header">Quick Add</div>
        <div class="templates-grid">
          <div class="template-card" onclick="useTemplate('Coffee', 5.50, 'Meals')">
            <div class="template-icon"></div>
            <div class="template-name">Coffee</div>
            <div class="template-amount">~$5.50</div>
          </div>
          <div class="template-card" onclick="useTemplate('Parking', 20, 'Travel')">
            <div class="template-icon"></div>
            <div class="template-name">Parking</div>
            <div class="template-amount">~$20</div>
          </div>
          <div class="template-card" onclick="useTemplate('Gas', 50, 'Travel')">
            <div class="template-icon"></div>
            <div class="template-name">Gas</div>
            <div class="template-amount">~$50</div>
          </div>
          <div class="template-card" onclick="useTemplate('Uber', 25, 'Travel')">
            <div class="template-icon"></div>
            <div class="template-name">Uber</div>
            <div class="template-amount">~$25</div>
          </div>
          <div class="template-card" onclick="useTemplate('Lunch', 15, 'Meals')">
            <div class="template-icon"></div>
            <div class="template-name">Lunch</div>
            <div class="template-amount">~$15</div>
          </div>
          <div class="template-card" onclick="useTemplate('Supplies', 30, 'Supplies')">
            <div class="template-icon"></div>
            <div class="template-name">Supplies</div>
            <div class="template-amount">~$30</div>
          </div>
        </div>
      </div>

      <input type="file" id="file-input" accept="image/*,application/pdf">
      <input type="file" id="batch-input" accept="image/*" multiple>
    </section>

    <!-- AI Extraction Panel -->
    <section class="extraction-panel" id="extraction-panel">
      <div class="ai-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
          <path d="M2 17l10 5 10-5"></path>
          <path d="M2 12l10 5 10-5"></path>
        </svg>
        AI Extracted
      </div>

      <!-- Quality Warning -->
      <div class="quality-warning" id="quality-warning">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <span class="quality-warning-text" id="quality-text">Image may be blurry - results might be less accurate</span>
      </div>

      <div class="extraction-card">
        <div class="field-group">
          <label class="field-label">Amount</label>
          <input type="text" class="field-input amount-input" id="amount-input" placeholder="$0.00" inputmode="decimal">
        </div>

        <div class="field-group">
          <label class="field-label">Merchant</label>
          <input type="text" class="field-input" id="merchant-input" placeholder="Store name">
        </div>

        <div class="field-row">
          <div class="field-group">
            <label class="field-label">Date</label>
            <input type="date" class="field-input" id="date-input">
          </div>
          <div class="field-group">
            <label class="field-label">Category</label>
            <select class="field-input" id="category-select">
              <option value="">Auto</option>
              <option value="Food & Dining">Food & Dining</option>
              <option value="Gas/Automotive">Gas</option>
              <option value="Shopping">Shopping</option>
              <option value="Travel">Travel</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Subscriptions">Subscriptions</option>
              <option value="Professional Services">Services</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">Business</label>
          <div class="business-chips">
            <div class="biz-chip" data-biz="Down Home">
              <div class="biz-chip-icon"></div>
              <div class="biz-chip-label">Down Home</div>
            </div>
            <div class="biz-chip" data-biz="Music City Rodeo">
              <div class="biz-chip-icon"></div>
              <div class="biz-chip-label">MCR</div>
            </div>
            <div class="biz-chip" data-biz="Personal">
              <div class="biz-chip-icon"></div>
              <div class="biz-chip-label">Personal</div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <label class="field-label" id="notes-label">Notes</label>
          <input type="text" class="field-input" id="notes-input" placeholder="Add context...">
        </div>

        <!-- Tip Section (shows when tip detected) -->
        <div class="tip-section" id="tip-section" style="display: none;">
          <div class="tip-header">
            <span> Tip Detected</span>
          </div>
          <div class="tip-row">
            <span class="tip-label">Subtotal:</span>
            <span id="tip-subtotal">$0.00</span>
          </div>
          <div class="tip-row">
            <span class="tip-label">Tip:</span>
            <span id="tip-amount">$0.00</span>
            <span id="tip-percent" class="tip-percent">0%</span>
          </div>
          <div class="tip-buttons">
            <button class="tip-btn" onclick="adjustTip(15)">15%</button>
            <button class="tip-btn" onclick="adjustTip(18)">18%</button>
            <button class="tip-btn" onclick="adjustTip(20)">20%</button>
            <button class="tip-btn" onclick="adjustTip(25)">25%</button>
          </div>
        </div>

        <!-- Purpose Prompt (shows when category unknown) -->
        <div class="purpose-prompt" id="purpose-prompt" style="display: none;">
          <div class="purpose-header">What is <span id="purpose-merchant">this</span> for?</div>
          <div class="purpose-buttons">
            <button class="purpose-btn" onclick="setPurpose('Meals', 'Music City Rodeo')"> MCR Meal</button>
            <button class="purpose-btn" onclick="setPurpose('Meals', 'Down Home')"> DH Meal</button>
            <button class="purpose-btn" onclick="setPurpose('Travel')"> Travel</button>
            <button class="purpose-btn" onclick="setPurpose('Supplies')"> Supplies</button>
            <button class="purpose-btn" onclick="setPurpose('', 'Personal')"> Personal</button>
          </div>
        </div>

        <!-- Split Receipt Section -->
        <div class="split-section" id="split-section">
          <div class="split-header">
            <span> Split Between Businesses</span>
            <div class="split-toggle" id="split-toggle" onclick="toggleSplit()"></div>
          </div>
          <div class="split-options" id="split-options">
            <div class="split-chip active" data-biz="Down Home" onclick="selectSplit(this)">
               DH <input type="text" value="50%" onclick="event.stopPropagation()" onchange="updateSplitPercent('Down Home', this.value)">
            </div>
            <div class="split-chip active" data-biz="Music City Rodeo" onclick="selectSplit(this)">
               MCR <input type="text" value="50%" onclick="event.stopPropagation()" onchange="updateSplitPercent('Music City Rodeo', this.value)">
            </div>
          </div>
        </div>

        <!-- Voice Notes Section -->
        <div class="voice-section" id="voice-section">
          <button class="voice-btn" id="voice-record-btn" onclick="toggleVoiceRecording()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            </svg>
          </button>
          <span class="voice-status" id="voice-status">Tap to add voice note</span>
          <div class="voice-playback" id="voice-playback">
            <button class="voice-play" id="voice-play" onclick="playVoiceNote()">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
            </button>
            <span class="voice-duration" id="voice-duration">0:00</span>
            <button class="voice-delete" onclick="deleteVoiceNote()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>

        <!-- Transaction Match -->
        <div class="match-section" id="match-section" style="display: none;">
          <div class="match-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span>Matched Transaction</span>
          </div>
          <div class="match-card">
            <div class="match-info">
              <div class="match-merchant" id="match-merchant"></div>
              <div class="match-meta" id="match-meta"></div>
            </div>
            <div class="match-amount" id="match-amount"></div>
          </div>
        </div>
      </div>

      <div class="submit-section">
        <button class="save-device-btn" id="save-device-btn" disabled title="Save to Photos">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <span>Save</span>
        </button>
        <button class="submit-btn" id="submit-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13"></path>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
          </svg>
          Save Receipt
        </button>
      </div>
    </section>

    <!-- History View -->
    <section class="history-view" id="history-view">
      <div class="history-header">
        <h2>Inbox</h2>
        <div class="history-stats">
          <div class="stat">
            <div class="stat-value" id="stat-count">0</div>
            <div class="stat-label">Today</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="stat-total">$0</div>
            <div class="stat-label">Total</div>
          </div>
        </div>
      </div>
      <!-- Filter Chips -->
      <div class="history-filters" id="history-filters">
        <button class="filter-chip active" data-filter="all" onclick="setHistoryFilter('all')">All</button>
        <button class="filter-chip" data-filter="pending" onclick="setHistoryFilter('pending')">
          <span class="filter-dot pending"></span>Pending
        </button>
        <button class="filter-chip" data-filter="accepted" onclick="setHistoryFilter('accepted')">
          <span class="filter-dot accepted"></span>Accepted
        </button>
        <button class="filter-chip" data-filter="inbox" onclick="setHistoryFilter('inbox')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
            <path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/>
          </svg>
          Email
        </button>
        <button class="filter-chip" data-filter="local" onclick="setHistoryFilter('local')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          Scanned
        </button>
      </div>
      <!-- Refresh Button -->
      <button class="refresh-inbox-btn" id="refresh-inbox-btn" onclick="refreshInbox()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
        </svg>
        <span>Refresh</span>
      </button>
      <div class="history-list" id="history-list"></div>
    </section>
  </main>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-nav">
    <a href="/" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
      <span>Home</span>
    </a>
    <a href="/viewer" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 11l3 3L22 4"/>
        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
      </svg>
      <span>Review</span>
    </a>
    <a href="/scanner" class="nav-item active">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
        <circle cx="12" cy="13" r="4"/>
      </svg>
      <span>Scan</span>
    </a>
    <a href="/incoming" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
        <path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/>
      </svg>
      <span>Inbox</span>
      <span class="nav-badge" id="inbox-badge">0</span>
    </a>
    <a href="/reports" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="16" y1="13" x2="8" y2="13"/>
        <line x1="16" y1="17" x2="8" y2="17"/>
        <polyline points="10 9 9 9 8 9"/>
      </svg>
      <span>Reports</span>
    </a>
  </nav>

  <!-- Processing Overlay -->
  <div class="processing-overlay" id="processing-overlay">
    <div class="ai-processing">
      <div class="ai-ring"></div>
      <div class="ai-ring"></div>
      <div class="ai-ring"></div>
    </div>
    <div class="processing-text" id="processing-text">Analyzing receipt...</div>
    <div class="processing-step" id="processing-step">Extracting text</div>
  </div>

  <!-- Success Modal -->
  <div class="success-modal" id="success-modal">
    <div class="success-card">
      <div class="success-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <h3>Receipt Saved!</h3>
      <p id="success-message">Your receipt has been added and is ready for matching.</p>
      <div class="success-actions">
        <button class="success-btn primary" id="scan-another-btn">Scan Another</button>
        <button class="success-btn secondary" id="view-history-btn">View History</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toast-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
    <span class="toast-text" id="toast-text">Saved!</span>
  </div>

  <!-- Receipt Detail Modal -->
  <div class="receipt-detail-modal" id="receipt-detail-modal">
    <div class="receipt-detail-header">
      <span class="receipt-detail-title">Receipt Details</span>
      <button class="receipt-detail-close" onclick="closeReceiptDetail()"></button>
    </div>
    <div class="receipt-detail-body">
      <img class="receipt-detail-image" id="detail-image" src="" alt="Receipt">
      <div class="receipt-detail-data">
        <div class="receipt-detail-merchant" id="detail-merchant"></div>
        <div class="receipt-detail-amount" id="detail-amount">$0.00</div>
        <div class="receipt-detail-row">
          <span class="receipt-detail-label">Date</span>
          <span class="receipt-detail-value" id="detail-date"></span>
        </div>
        <div class="receipt-detail-row">
          <span class="receipt-detail-label">Business</span>
          <span class="receipt-detail-value" id="detail-business"></span>
        </div>
        <div class="receipt-detail-row">
          <span class="receipt-detail-label">Status</span>
          <span class="receipt-detail-value" id="detail-status"></span>
        </div>
        <div class="receipt-detail-row">
          <span class="receipt-detail-label">Scanned</span>
          <span class="receipt-detail-value" id="detail-scanned"></span>
        </div>
        <div class="receipt-detail-notes" id="detail-notes" style="display:none;"></div>
      </div>
    </div>
    <div class="receipt-detail-footer">
      <button class="receipt-detail-btn delete" onclick="deleteCurrentReceipt()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        Delete
      </button>
      <button class="receipt-detail-btn sync" id="detail-sync-btn" onclick="resyncReceipt()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        Sync
      </button>
    </div>
  </div>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const API_BASE = window.location.origin;
    const SOURCE_TAG = 'mobile_scanner_pwa';
    // Authentication is handled via session cookies (credentials: 'include')
    const DB_NAME = 'TallyupsDB';
    const DB_VERSION = 1;

    // ========================================
    // STATE
    // ========================================
    let currentImage = { data: null, blob: null };
    let selectedBusiness = '';
    let matchedTransaction = null;
    let history = [];
    let inboxReceipts = [];  // Server-side inbox receipts
    let isOnline = navigator.onLine;
    let deferredPrompt = null;
    let db = null;
    let cameraStream = null;
    let flashEnabled = false;
    let currentDetailReceipt = null;
    let historyFilter = 'all';  // 'all', 'local', 'inbox', 'pending'

    // Enhanced capture state
    let captureLocation = null;
    let calendarEvents = [];
    let tipAmount = 0;
    let subtotal = 0;
    let ocrStartTime = 0;

    // Batch mode state
    let batchMode = false;
    let batchQueue = [];  // Array of {id, blob, dataUrl, status: 'pending'|'processing'|'done'}
    let liveCameraActive = false;

    // ========================================
    // DOM ELEMENTS
    // ========================================
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);

    // ========================================
    // INITIALIZATION
    // ========================================
    document.addEventListener('DOMContentLoaded', async () => {
      await initDB();
      await loadHistory();
      await loadInboxReceipts();  // Fetch from server inbox
      setupEventListeners();
      setupPWA();
      setupOfflineDetection();
      setupDragDrop();
      checkConnection();
      renderHistory();
      $('date-input').value = new Date().toISOString().split('T')[0];
    });

    // ========================================
    // INDEXED DB FOR OFFLINE STORAGE
    // ========================================
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };

        request.onupgradeneeded = (e) => {
          const database = e.target.result;

          // Receipts store
          if (!database.objectStoreNames.contains('receipts')) {
            const store = database.createObjectStore('receipts', { keyPath: 'id', autoIncrement: true });
            store.createIndex('synced', 'synced');
            store.createIndex('timestamp', 'timestamp');
          }

          // Pending uploads store
          if (!database.objectStoreNames.contains('pending')) {
            database.createObjectStore('pending', { keyPath: 'id', autoIncrement: true });
          }
        };
      });
    }

    async function saveToIndexedDB(receipt) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction('receipts', 'readwrite');
        const store = tx.objectStore('receipts');
        const request = store.add(receipt);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function loadHistory() {
      return new Promise((resolve) => {
        if (!db) {
          history = JSON.parse(localStorage.getItem('receiptHistory') || '[]');
          resolve();
          return;
        }

        const tx = db.transaction('receipts', 'readonly');
        const store = tx.objectStore('receipts');
        const request = store.getAll();

        request.onsuccess = () => {
          history = request.result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          resolve();
        };
        request.onerror = () => {
          history = [];
          resolve();
        };
      });
    }

    async function updateReceiptSync(id, synced) {
      return new Promise((resolve) => {
        const tx = db.transaction('receipts', 'readwrite');
        const store = tx.objectStore('receipts');
        const getRequest = store.get(id);

        getRequest.onsuccess = () => {
          const receipt = getRequest.result;
          if (receipt) {
            receipt.synced = synced;
            delete receipt.pendingData;
            store.put(receipt);
          }
          resolve();
        };
      });
    }

    // ========================================
    // INBOX INTEGRATION
    // ========================================
    async function loadInboxReceipts() {
      if (!isOnline) {
        console.log('[Inbox] Offline - using cached data');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/incoming/receipts?status=all&limit=100`, {
          credentials: 'include'
        });

        if (!response.ok) {
          console.log('[Inbox] Could not fetch receipts:', response.status);
          return;
        }

        const data = await response.json();
        if (data.ok && data.receipts) {
          inboxReceipts = data.receipts.map(r => ({
            id: r.id,
            serverId: r.id,
            merchant: r.merchant || 'Unknown',
            amount: parseFloat(r.amount) || 0,
            date: r.received_date || r.created_at,
            timestamp: r.created_at || r.received_date,
            category: r.category || 'Uncategorized',
            business: r.business_type || 'Personal',
            notes: r.description || r.subject || '',
            thumbnail: r.receipt_url || r.thumbnail || '',
            status: r.status,  // pending, accepted, rejected
            synced: true,
            source: r.source || 'email',
            fromEmail: r.from_email,
            subject: r.subject,
            confidence: r.confidence_score
          }));

          console.log(`[Inbox] Loaded ${inboxReceipts.length} receipts from server`);
          updateInboxBadge();
        }
      } catch (error) {
        console.error('[Inbox] Error fetching receipts:', error);
      }
    }

    function updateInboxBadge() {
      const pendingCount = inboxReceipts.filter(r => r.status === 'pending').length;
      const badge = $('inbox-badge');
      if (badge) {
        badge.textContent = pendingCount;
        badge.classList.toggle('visible', pendingCount > 0);
      }
    }

    async function pushToInbox(receiptData) {
      /**
       * Push a scanned receipt to the server inbox.
       * This creates an entry in incoming_receipts table.
       */
      try {
        const formData = new FormData();
        formData.append('file', receiptData.blob, `receipt_${Date.now()}.jpg`);
        formData.append('merchant', receiptData.merchant || '');
        formData.append('amount', String(receiptData.amount || 0));
        formData.append('date', receiptData.date || new Date().toISOString().split('T')[0]);
        formData.append('category', receiptData.category || '');
        formData.append('business', receiptData.business || 'Personal');
        formData.append('notes', receiptData.notes || '');
        formData.append('source', SOURCE_TAG);

        const response = await fetch(`${API_BASE}/mobile-upload`, {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });

        const result = await response.json();

        if (result.ok || result.id) {
          console.log('[Inbox] Receipt pushed to inbox:', result.id);
          return { success: true, id: result.id, data: result };
        } else {
          throw new Error(result.error || 'Upload failed');
        }
      } catch (error) {
        console.error('[Inbox] Error pushing to inbox:', error);
        return { success: false, error: error.message };
      }
    }

    function getFilteredHistory() {
      /**
       * Get combined and filtered history from local + inbox.
       */
      let combined = [];

      // Add local receipts
      const localReceipts = history.map(r => ({
        ...r,
        sourceType: 'local',
        displayStatus: r.synced ? 'synced' : 'pending'
      }));

      // Add inbox receipts (avoid duplicates by serverId)
      const localServerIds = new Set(history.filter(r => r.serverId).map(r => r.serverId));
      const inboxOnly = inboxReceipts
        .filter(r => !localServerIds.has(r.serverId))
        .map(r => ({
          ...r,
          sourceType: 'inbox',
          displayStatus: r.status
        }));

      combined = [...localReceipts, ...inboxOnly];

      // Sort by timestamp (newest first)
      combined.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Apply filter
      switch (historyFilter) {
        case 'local':
          return combined.filter(r => r.sourceType === 'local');
        case 'inbox':
          return combined.filter(r => r.sourceType === 'inbox');
        case 'pending':
          return combined.filter(r => r.status === 'pending' || r.displayStatus === 'pending');
        case 'accepted':
          return combined.filter(r => r.status === 'accepted' || r.displayStatus === 'synced');
        default:
          return combined;
      }
    }

    // ========================================
    // PWA SETUP
    // ========================================
    function setupPWA() {
      // Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            console.log('[PWA] Service worker registered');

            // Listen for messages from SW
            navigator.serviceWorker.addEventListener('message', (e) => {
              if (e.data.type === 'SYNC_UPLOADS') {
                syncPendingUploads();
              }
            });
          })
          .catch(err => console.log('[PWA] SW registration failed:', err));
      }

      // Detect iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

      // Install prompt (Android/Chrome)
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;

        // Show install banner if not dismissed
        if (!localStorage.getItem('installDismissed')) {
          setTimeout(() => {
            $('install-banner').classList.add('visible');
          }, 3000);
        }
      });

      // For iOS: Show install banner after delay (since beforeinstallprompt doesn't fire)
      if (isIOS && !isInStandaloneMode && !localStorage.getItem('installDismissed')) {
        setTimeout(() => {
          $('install-banner').classList.add('visible');
        }, 3000);
      }

      // Detect if running as PWA
      if (isInStandaloneMode) {
        console.log('[PWA] Running in standalone mode');
      }
    }

    // iOS detection helper
    const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    window.installApp = async () => {
      if (!deferredPrompt) {
        // iOS - show the install guide modal
        if (isIOS()) {
          $('ios-install-modal').classList.add('visible');
          $('install-banner').classList.remove('visible');
        } else {
          showToast('Use browser menu to install', 'info');
        }
        return;
      }

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        showToast('Installing Tallyups...', 'success');
        hapticFeedback();
      }

      deferredPrompt = null;
      $('install-banner').classList.remove('visible');
    };

    window.closeIosInstall = (e) => {
      if (e && e.target !== e.currentTarget) return;
      $('ios-install-modal').classList.remove('visible');
      localStorage.setItem('installDismissed', 'true');
    };

    window.dismissInstall = () => {
      $('install-banner').classList.remove('visible');
      localStorage.setItem('installDismissed', 'true');
    };

    // ========================================
    // OFFLINE DETECTION
    // ========================================
    function setupOfflineDetection() {
      window.addEventListener('online', () => {
        isOnline = true;
        $('offline-banner').classList.remove('visible');
        $('status-dot').classList.remove('offline');
        $('status-text').textContent = 'Connected';
        showToast('Back online!', 'success');
        syncPendingUploads();
      });

      window.addEventListener('offline', () => {
        isOnline = false;
        $('offline-banner').classList.add('visible');
        $('status-dot').classList.add('offline');
        $('status-text').textContent = 'Offline';
      });
    }

    // ========================================
    // DRAG & DROP
    // ========================================
    function setupDragDrop() {
      const frame = $('camera-frame');

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
        frame.addEventListener(event, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      frame.addEventListener('dragenter', () => frame.classList.add('drag-over'));
      frame.addEventListener('dragleave', () => frame.classList.remove('drag-over'));
      frame.addEventListener('dragover', () => frame.classList.add('drag-over'));

      frame.addEventListener('drop', (e) => {
        frame.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect({ target: { files } });
        }
      });
    }

    // ========================================
    // HAPTIC FEEDBACK
    // ========================================
    function hapticFeedback(type = 'light') {
      // Visual feedback
      const flash = $('haptic-flash');
      flash.classList.add('active');
      setTimeout(() => flash.classList.remove('active'), 100);

      // Native haptic if available
      if ('vibrate' in navigator) {
        switch (type) {
          case 'light': navigator.vibrate(10); break;
          case 'medium': navigator.vibrate(20); break;
          case 'heavy': navigator.vibrate([30, 10, 30]); break;
          case 'success': navigator.vibrate([10, 50, 10, 50, 30]); break;
          case 'error': navigator.vibrate([50, 30, 50]); break;
        }
      }
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    function setupEventListeners() {
      // Camera capture
      $('capture-btn').onclick = () => {
        hapticFeedback();
        $('file-input').setAttribute('capture', 'environment');
        $('file-input').click();
      };

      // Gallery
      $('gallery-btn').onclick = () => {
        hapticFeedback();
        $('file-input').removeAttribute('capture');
        $('file-input').click();
      };

      // File selected
      $('file-input').onchange = handleFileSelect;

      // Retake
      $('retake-btn').onclick = () => {
        hapticFeedback();
        resetScanner();
      };

      // Business chips
      $$('.biz-chip').forEach(chip => {
        chip.onclick = () => {
          hapticFeedback();
          $$('.biz-chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
          selectedBusiness = chip.dataset.biz;
        };
      });

      // Amount formatting
      $('amount-input').onblur = () => {
        const val = parseFloat($('amount-input').value.replace(/[^0-9.-]/g, ''));
        if (!isNaN(val)) {
          $('amount-input').value = '$' + val.toFixed(2);
          findMatchingTransaction(val);
        }
      };

      // Submit
      $('submit-btn').onclick = () => {
        hapticFeedback('medium');
        submitReceipt();
      };

      // Save to Device
      $('save-device-btn').onclick = () => {
        hapticFeedback('medium');
        saveToDevice();
      };

      // Success modal
      $('scan-another-btn').onclick = () => {
        hapticFeedback();
        resetScanner();
      };

      $('view-history-btn').onclick = () => {
        hapticFeedback();
        $('success-modal').classList.remove('visible');
        switchView('history');
      };

      // Navigation - let native <a> tags work without interference
      // Only add haptic feedback, don't block navigation
      $$('.nav-item').forEach(item => {
        item.addEventListener('click', () => hapticFeedback('light'));
      });

      // Voice capture
      setupVoiceCapture();

      // Batch mode toggle
      $('batch-toggle').onclick = () => {
        hapticFeedback();
        toggleBatchMode();
      };

      // Batch done button
      $('batch-done-btn').onclick = () => {
        hapticFeedback('medium');
        finishBatchMode();
      };

      // Long press on camera frame to start live preview
      let longPressTimer = null;
      $('camera-placeholder').addEventListener('touchstart', (e) => {
        longPressTimer = setTimeout(() => {
          hapticFeedback('heavy');
          startLiveCamera();
        }, 500);
      });
      $('camera-placeholder').addEventListener('touchend', () => {
        clearTimeout(longPressTimer);
      });
    }

    // ========================================
    // BATCH MODE
    // ========================================
    function toggleBatchMode() {
      batchMode = !batchMode;
      $('batch-toggle').classList.toggle('active', batchMode);

      if (batchMode) {
        $('batch-banner').classList.add('visible');
        $('batch-queue').classList.add('visible');
        showToast('Batch mode ON - scan multiple receipts', 'info');
      } else {
        $('batch-banner').classList.remove('visible');
        $('batch-queue').classList.remove('visible');
        batchQueue = [];
        updateBatchUI();
      }
    }

    function addToBatch(blob, dataUrl) {
      const id = Date.now();
      batchQueue.push({ id, blob, dataUrl, status: 'pending' });
      updateBatchUI();

      // Flash effect
      const flash = $('capture-flash');
      flash.classList.add('flash');
      setTimeout(() => flash.classList.remove('flash'), 300);

      // Process in background
      processBatchItem(id);
    }

    function updateBatchUI() {
      $('batch-count').textContent = batchQueue.length;

      const queueEl = $('batch-queue');
      queueEl.innerHTML = batchQueue.map(item => `
        <div class="batch-thumbnail ${item.status}" data-id="${item.id}">
          <img src="${item.dataUrl}" alt="Receipt">
          <button class="remove-btn" onclick="removeBatchItem(${item.id})"></button>
        </div>
      `).join('');
    }

    function removeBatchItem(id) {
      hapticFeedback();
      batchQueue = batchQueue.filter(item => item.id !== id);
      updateBatchUI();
    }

    async function processBatchItem(id) {
      const item = batchQueue.find(i => i.id === id);
      if (!item) return;

      item.status = 'processing';
      updateBatchUI();

      try {
        // Upload to server inbox
        const formData = new FormData();
        formData.append('file', item.blob, `batch_${id}.jpg`);
        formData.append('source', SOURCE_TAG + '_batch');

        const response = await fetch(`${API_BASE}/api/incoming/upload`, {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });

        if (response.ok) {
          item.status = 'done';
          hapticFeedback('success');
        } else {
          item.status = 'error';
        }
      } catch (e) {
        console.error('Batch upload error:', e);
        item.status = 'error';
      }

      updateBatchUI();
    }

    async function finishBatchMode() {
      const pending = batchQueue.filter(i => i.status === 'pending' || i.status === 'processing');
      if (pending.length > 0) {
        showToast(`Processing ${pending.length} receipts...`, 'info');
        await Promise.all(pending.map(i => processBatchItem(i.id)));
      }

      const done = batchQueue.filter(i => i.status === 'done').length;
      showToast(`${done} receipts uploaded to inbox!`, 'success');

      batchMode = false;
      batchQueue = [];
      $('batch-toggle').classList.remove('active');
      $('batch-banner').classList.remove('visible');
      $('batch-queue').classList.remove('visible');
      updateBatchUI();
    }

    // ========================================
    // LIVE CAMERA
    // ========================================
    async function startLiveCamera() {
      if (liveCameraActive) return;

      try {
        const constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        };

        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = $('video-preview');
        video.srcObject = cameraStream;
        await video.play();

        liveCameraActive = true;
        $('camera-frame').classList.add('live-mode');
        $('flash-btn').classList.add('visible');

        showToast('Live camera active - tap to capture', 'success');

        // Update capture button behavior for live mode
        $('capture-btn').onclick = captureFromLiveCamera;

        // Start frame detection (simplified)
        startFrameDetection();

      } catch (err) {
        console.error('Camera error:', err);
        showToast('Camera not available', 'error');
      }
    }

    function stopLiveCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }

      liveCameraActive = false;
      $('camera-frame').classList.remove('live-mode');
      $('flash-btn').classList.remove('visible');
      $('video-preview').srcObject = null;

      // Restore normal capture behavior
      $('capture-btn').onclick = () => {
        hapticFeedback();
        $('file-input').setAttribute('capture', 'environment');
        $('file-input').click();
      };
    }

    async function captureFromLiveCamera() {
      if (!liveCameraActive) return;

      hapticFeedback('medium');

      // Flash effect
      const flash = $('capture-flash');
      flash.classList.add('flash');
      setTimeout(() => flash.classList.remove('flash'), 300);

      const video = $('video-preview');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);

      // Convert to blob
      const blob = await new Promise(resolve => {
        canvas.toBlob(resolve, 'image/jpeg', 0.9);
      });

      const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

      if (batchMode) {
        // Add to batch queue
        addToBatch(blob, dataUrl);
      } else {
        // Stop camera and process single image
        stopLiveCamera();

        currentImage.blob = blob;
        currentImage.data = dataUrl;

        $('image-preview').src = dataUrl;
        $('image-preview').style.display = 'block';
        $('camera-placeholder').style.display = 'none';
        $('camera-frame').classList.add('has-image');
        $('retake-btn').classList.add('visible');

        ocrStartTime = performance.now();
        captureGeolocation();
        fetchTodayCalendarEvents();
        await processOCR();
      }
    }

    function startFrameDetection() {
      // Simple frame detection - show corners when receipt-like content is detected
      // This is a simplified version - real implementation would use OpenCV.js
      const framePath = $('detected-frame');

      // For now, just show animated corners as visual feedback
      framePath.classList.add('visible');

      // Could add actual edge detection with OpenCV.js for production
    }

    // ========================================
    // VOICE CAPTURE
    // ========================================
    function setupVoiceCapture() {
      let isRecording = false;
      let recognition = null;

      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
          isRecording = true;
          $('voice-btn').classList.add('recording');
          hapticFeedback('medium');
          showToast('Listening...', 'info');
        };

        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          $('notes-input').value = transcript;
          $('notes-input').classList.add('ai-filled');
        };

        recognition.onend = () => {
          isRecording = false;
          $('voice-btn').classList.remove('recording');
          if ($('notes-input').value) {
            hapticFeedback('success');
            showToast('Voice note added!', 'success');
          }
        };

        recognition.onerror = (event) => {
          isRecording = false;
          $('voice-btn').classList.remove('recording');
          hapticFeedback('error');
          if (event.error === 'not-allowed') {
            showToast('Microphone access denied', 'error');
          } else if (event.error !== 'no-speech') {
            showToast('Voice error: ' + event.error, 'error');
          }
        };
      }

      $('voice-btn').onclick = () => {
        if (!recognition) {
          showToast('Voice not supported', 'error');
          return;
        }
        hapticFeedback();
        if (isRecording) {
          recognition.stop();
        } else {
          recognition.start();
        }
      };
    }

    // ========================================
    // VIEW MANAGEMENT
    // ========================================
    function switchView(view) {
      $$('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view === view));

      $('camera-view').style.display = view === 'scan' ? 'block' : 'none';
      $('extraction-panel').style.display = (view === 'scan' && currentImage.data) ? 'block' : 'none';
      $('history-view').classList.toggle('visible', view === 'history');

      if (view === 'history') renderHistory();
    }

    // ========================================
    // FILE HANDLING
    // ========================================
    async function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      ocrStartTime = performance.now();
      hapticFeedback('medium');

      // Start geolocation capture immediately (parallel)
      captureGeolocation();

      // Start calendar fetch (parallel)
      fetchTodayCalendarEvents();

      const reader = new FileReader();
      reader.onload = async (ev) => {
        currentImage.data = ev.target.result;
        currentImage.blob = file;

        // Optimize image before display (resize for speed)
        const optimizedBlob = await optimizeImage(file);
        if (optimizedBlob) currentImage.blob = optimizedBlob;

        $('image-preview').src = currentImage.data;
        $('image-preview').style.display = 'block';
        $('camera-placeholder').style.display = 'none';
        $('camera-frame').classList.add('has-image');
        $('retake-btn').classList.add('visible');
        $('save-device-btn').disabled = false;

        // Hide templates when image captured
        const templatesSection = $('templates-section');
        if (templatesSection) templatesSection.classList.remove('visible');

        // Analyze image quality
        try {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = Math.min(img.width, 800); // Downsample for analysis
            canvas.height = Math.min(img.height, 800);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const quality = analyzeImageQuality(canvas);
            showQualityWarning(quality.issues);
          };
          img.src = currentImage.data;
        } catch (e) {
          console.log('Quality check skipped:', e);
        }

        await processOCR();
      };
      reader.readAsDataURL(file);
    }

    // ========================================
    // GEOLOCATION CAPTURE
    // ========================================
    async function captureGeolocation() {
      if (!navigator.geolocation) return;

      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: false,
            timeout: 5000,
            maximumAge: 300000 // 5 min cache
          });
        });

        captureLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: new Date().toISOString()
        };

        // Reverse geocode for location name (non-blocking)
        reverseGeocode(captureLocation.lat, captureLocation.lng);

        console.log('[Location] Captured:', captureLocation);
      } catch (err) {
        console.log('[Location] Not available:', err.message);
        captureLocation = null;
      }
    }

    async function reverseGeocode(lat, lng, merchant = '') {
      try {
        // Use smart location lookup API for better restaurant/business identification
        const url = `${API_BASE}/location/nearby?lat=${lat}&lng=${lng}&merchant=${encodeURIComponent(merchant)}`;
        const res = await fetch(url);

        if (res.ok) {
          const data = await res.json();

          // Best match is if merchant name matches a nearby place
          if (data.best_match) {
            captureLocation.name = data.best_match.name;
            captureLocation.type = data.best_match.type;
            captureLocation.category = data.best_match.category;
            captureLocation.city = data.best_match.city;
            captureLocation.matched = true;
            console.log('[Location] Matched:', data.best_match.name);
          } else if (data.closest) {
            // Otherwise use closest place
            captureLocation.name = data.closest.name;
            captureLocation.type = data.closest.type;
            captureLocation.category = data.closest.category;
            captureLocation.city = data.closest.city;
            captureLocation.distance = data.closest.distance_m;
            console.log('[Location] Closest:', data.closest.name, `(${data.closest.distance_m}m)`);
          }

          // Store all nearby places for suggestions
          captureLocation.nearby = data.places || [];

          // Auto-fill category if detected from location
          if (captureLocation.category && !$('category-select').value) {
            $('category-select').value = captureLocation.category;
            console.log('[Location] Auto-category:', captureLocation.category);
          }
        }
      } catch (e) {
        // Fallback to basic OpenStreetMap
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
          if (res.ok) {
            const data = await res.json();
            if (data.address) {
              captureLocation.name = data.address.amenity || data.address.shop || data.address.restaurant || data.address.road || '';
              captureLocation.city = data.address.city || data.address.town || data.address.village || '';
            }
          }
        } catch (e2) {}
      }
    }

    // ========================================
    // IMAGE OPTIMIZATION
    // ========================================
    async function optimizeImage(file) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const maxSize = 1600; // Max dimension for speed
          let w = img.width, h = img.height;

          if (w > maxSize || h > maxSize) {
            if (w > h) { h = (h / w) * maxSize; w = maxSize; }
            else { w = (w / h) * maxSize; h = maxSize; }
          }

          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);

          canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.85);
        };
        img.onerror = () => resolve(null);
        img.src = URL.createObjectURL(file);
      });
    }

    // ========================================
    // CALENDAR INTEGRATION
    // ========================================
    async function fetchTodayCalendarEvents() {
      if (!isOnline) return;

      try {
        const today = new Date().toISOString().split('T')[0];
        const res = await fetch(`${API_BASE}/api/calendar/events?date=${today}`);
        if (res.ok) {
          const data = await res.json();
          calendarEvents = data.events || [];
          console.log('[Calendar] Events today:', calendarEvents.length);
        }
      } catch (e) {
        console.log('[Calendar] Not available');
        calendarEvents = [];
      }
    }

    function findCalendarContext(merchant, date) {
      if (!calendarEvents.length) return null;

      // Try to match calendar event with merchant/receipt
      const lowerMerchant = (merchant || '').toLowerCase();
      for (const event of calendarEvents) {
        const title = (event.title || '').toLowerCase();
        const location = (event.location || '').toLowerCase();
        if (title.includes(lowerMerchant) || lowerMerchant.includes(title) ||
            location.includes(lowerMerchant)) {
          return event;
        }
      }
      return null;
    }

    // ========================================
    // OCR PROCESSING
    // ========================================
    async function processOCR() {
      showProcessing('Analyzing receipt...', 'Detecting text');

      try {
        const formData = new FormData();
        formData.append('file', currentImage.blob);

        // Add location data if available
        if (captureLocation) {
          formData.append('location_lat', captureLocation.lat);
          formData.append('location_lng', captureLocation.lng);
          if (captureLocation.name) formData.append('location_name', captureLocation.name);
        }

        updateProcessing('Analyzing receipt...', 'Running AI extraction');

        const response = await fetch(`${API_BASE}/ocr`, {
          method: 'POST',
          body: formData
        });

        const ocrTime = Math.round(performance.now() - ocrStartTime);
        console.log(`[Speed] OCR completed in ${ocrTime}ms`);

        if (response.ok) {
          const data = await response.json();
          console.log('OCR Result:', data);

          updateProcessing('Analyzing receipt...', 'Populating fields');

          // Fill form with AI highlighting
          if (data.merchant) {
            $('merchant-input').value = data.merchant;
            $('merchant-input').classList.add('ai-filled');

            // Try to match with calendar event
            const calEvent = findCalendarContext(data.merchant, data.date);
            if (calEvent && !data.note) {
              data.note = ` ${calEvent.title}`;
            }

            // Re-lookup location with merchant name for better matching
            if (captureLocation?.lat && !captureLocation.matched) {
              reverseGeocode(captureLocation.lat, captureLocation.lng, data.merchant);
            }
          }

          // Use location name if merchant not found by OCR
          if (!data.merchant && captureLocation?.name) {
            $('merchant-input').value = captureLocation.name;
            $('merchant-input').classList.add('ai-filled');
          }

          if (data.total) {
            const amt = parseFloat(data.total);
            $('amount-input').value = '$' + amt.toFixed(2);
            $('amount-input').classList.add('ai-filled');

            // Store subtotal for tip calculation
            if (data.subtotal) {
              subtotal = parseFloat(data.subtotal);
              tipAmount = amt - subtotal;
              if (tipAmount > 0) {
                showTipSection(subtotal, tipAmount, amt);
              }
            }

            findMatchingTransaction(amt);
          }

          if (data.date) {
            $('date-input').value = formatDateForInput(data.date);
            $('date-input').classList.add('ai-filled');
          }

          if (data.category) {
            $('category-select').value = data.category;
          } else {
            // Show purpose prompt if category unclear
            showPurposePrompt(data.merchant);
          }

          // Calendar context note
          if (data.note) {
            $('notes-input').value = data.note;
            $('notes-input').classList.add('ai-filled');
            $('notes-label').innerHTML = 'Notes <span style="font-size:10px;background:var(--accent);color:#000;padding:2px 6px;border-radius:4px;margin-left:6px;"> Calendar</span>';
            showToast('Calendar context added!', 'success');
          }

          // Show speed feedback
          const speedMsg = ocrTime < 2000 ? ' Super fast!' : ocrTime < 4000 ? ' Done' : ' Complete';
          showToast(`${speedMsg} (${(ocrTime/1000).toFixed(1)}s)`, 'success');

          // Check for duplicates after OCR extraction
          if (data.merchant && data.total && data.date) {
            checkForDuplicate(data.merchant, data.total, formatDateForInput(data.date));
          }

          hapticFeedback('success');
        } else {
          showToast('Could not read receipt. Fill manually.', 'error');
          hapticFeedback('error');
        }
      } catch (err) {
        console.error('OCR error:', err);
        showToast('AI unavailable. Fill manually.', 'error');
        hapticFeedback('error');
      }

      hideProcessing();
      $('extraction-panel').classList.add('visible');
    }

    // ========================================
    // TIP SECTION
    // ========================================
    function showTipSection(sub, tip, total) {
      const tipSection = $('tip-section');
      if (!tipSection) return;

      tipSection.style.display = 'block';
      $('tip-subtotal').textContent = '$' + sub.toFixed(2);
      $('tip-amount').textContent = '$' + tip.toFixed(2);
      $('tip-percent').textContent = Math.round((tip / sub) * 100) + '%';
    }

    function adjustTip(percent) {
      if (!subtotal) return;

      tipAmount = subtotal * (percent / 100);
      const newTotal = subtotal + tipAmount;

      $('tip-amount').textContent = '$' + tipAmount.toFixed(2);
      $('tip-percent').textContent = percent + '%';
      $('amount-input').value = '$' + newTotal.toFixed(2);

      hapticFeedback('light');
    }

    // ========================================
    // PURPOSE PROMPT
    // ========================================
    function showPurposePrompt(merchant) {
      const prompt = $('purpose-prompt');
      if (!prompt) return;

      // Only show for uncategorized
      if ($('category-select').value) return;

      prompt.style.display = 'block';
      $('purpose-merchant').textContent = merchant || 'this purchase';
    }

    function setPurpose(category, business) {
      $('category-select').value = category || '';
      if (business) selectedBusiness = business;
      $('purpose-prompt').style.display = 'none';
      hapticFeedback('light');
    }

    // ========================================
    // QUICK TEMPLATES
    // ========================================
    function useTemplate(merchant, amount, category) {
      hapticFeedback('medium');

      // Fill in the form fields
      $('merchant-input').value = merchant;
      $('amount-input').value = amount.toFixed(2);
      $('category-select').value = category;

      // Set current date
      const today = new Date().toISOString().split('T')[0];
      $('date-input').value = today;

      // Show extraction panel without image
      showExtractionPanel();

      // Hide templates section
      const templatesSection = $('templates-section');
      if (templatesSection) templatesSection.classList.remove('visible');

      // Check for duplicates
      checkForDuplicate(merchant, amount, today);

      showToast(` ${merchant} template loaded`);
    }

    // ========================================
    // SPLIT RECEIPT
    // ========================================
    let splitEnabled = false;
    let splitPercentages = { 'Down Home': 50, 'Music City Rodeo': 50 };

    function toggleSplit() {
      splitEnabled = !splitEnabled;
      const toggle = $('split-toggle');
      const options = $('split-options');

      if (toggle) toggle.classList.toggle('active', splitEnabled);
      if (options) options.style.display = splitEnabled ? 'flex' : 'none';

      hapticFeedback('light');
    }

    function selectSplit(chip) {
      chip.classList.toggle('active');
      updateSplitDisplay();
      hapticFeedback('light');
    }

    function updateSplitPercent(business, value) {
      const percent = parseInt(value) || 0;
      splitPercentages[business] = Math.min(100, Math.max(0, percent));

      // Auto-adjust other business if only two
      const businesses = Object.keys(splitPercentages);
      if (businesses.length === 2) {
        const other = businesses.find(b => b !== business);
        splitPercentages[other] = 100 - splitPercentages[business];

        // Update the other input
        const otherChip = document.querySelector(`.split-chip[data-biz="${other}"] input`);
        if (otherChip) otherChip.value = splitPercentages[other] + '%';
      }
    }

    function updateSplitDisplay() {
      const activeChips = document.querySelectorAll('.split-chip.active');
      const count = activeChips.length;

      if (count > 0) {
        const equalSplit = Math.floor(100 / count);
        activeChips.forEach((chip, i) => {
          const input = chip.querySelector('input');
          const biz = chip.dataset.biz;
          const percent = i === count - 1 ? 100 - (equalSplit * (count - 1)) : equalSplit;
          if (input) input.value = percent + '%';
          if (biz) splitPercentages[biz] = percent;
        });
      }
    }

    function getSplitData() {
      if (!splitEnabled) return null;

      const result = {};
      document.querySelectorAll('.split-chip.active').forEach(chip => {
        const biz = chip.dataset.biz;
        const input = chip.querySelector('input');
        if (biz && input) {
          result[biz] = parseInt(input.value) || 0;
        }
      });

      return Object.keys(result).length > 0 ? result : null;
    }

    // ========================================
    // VOICE NOTES
    // ========================================
    let mediaRecorder = null;
    let audioChunks = [];
    let voiceNoteBlob = null;
    let voiceNoteUrl = null;
    let isRecording = false;
    let recordingStartTime = null;

    async function toggleVoiceRecording() {
      if (isRecording) {
        stopVoiceRecording();
      } else {
        await startVoiceRecording();
      }
    }

    async function startVoiceRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => {
          audioChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          voiceNoteBlob = new Blob(audioChunks, { type: 'audio/webm' });
          voiceNoteUrl = URL.createObjectURL(voiceNoteBlob);

          // Update UI
          $('voice-playback').style.display = 'flex';
          $('voice-status').textContent = 'Voice note recorded';

          const duration = Math.round((Date.now() - recordingStartTime) / 1000);
          $('voice-duration').textContent = `0:${duration.toString().padStart(2, '0')}`;

          // Stop all tracks
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();

        $('voice-record-btn').classList.add('recording');
        $('voice-status').textContent = 'Recording...';
        $('voice-playback').style.display = 'none';

        hapticFeedback('medium');
      } catch (err) {
        console.error('Voice recording error:', err);
        showToast(' Microphone access denied');
      }
    }

    function stopVoiceRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        $('voice-record-btn').classList.remove('recording');
        hapticFeedback('light');
      }
    }

    function playVoiceNote() {
      if (voiceNoteUrl) {
        const audio = new Audio(voiceNoteUrl);
        audio.play();
        hapticFeedback('light');
      }
    }

    function deleteVoiceNote() {
      if (voiceNoteUrl) {
        URL.revokeObjectURL(voiceNoteUrl);
      }
      voiceNoteBlob = null;
      voiceNoteUrl = null;

      $('voice-playback').style.display = 'none';
      $('voice-status').textContent = 'Tap to add voice note';

      hapticFeedback('light');
      showToast(' Voice note deleted');
    }

    // ========================================
    // DUPLICATE DETECTION
    // ========================================
    let duplicateTransaction = null;

    async function checkForDuplicate(merchant, amount, date) {
      if (!isOnline) return false;

      try {
        const response = await fetch(`${API_BASE}/api/transactions`);
        if (!response.ok) return false;

        const transactions = await response.json();
        const searchMerchant = (merchant || '').toLowerCase().trim();
        const searchAmount = parseFloat(amount) || 0;
        const searchDate = date || '';

        // Look for similar transactions
        const duplicates = transactions.filter(t => {
          const txMerchant = (t['Chase Description'] || t['Merchant'] || '').toLowerCase();
          const txAmount = Math.abs(parseFloat(t['Chase Amount'] || t['Amount'] || 0));
          const txDate = t['Chase Date'] || t['Date'] || '';
          const hasReceipt = t['Receipt File'] && t['Receipt File'].trim();

          // Match criteria: similar merchant, same amount, same date, already has receipt
          const merchantMatch = txMerchant.includes(searchMerchant) || searchMerchant.includes(txMerchant);
          const amountMatch = Math.abs(txAmount - searchAmount) < 0.02;
          const dateMatch = txDate === searchDate || !searchDate;

          return merchantMatch && amountMatch && hasReceipt;
        });

        if (duplicates.length > 0) {
          duplicateTransaction = duplicates[0];
          showDuplicateModal(duplicateTransaction);
          return true;
        }

        return false;
      } catch (err) {
        console.error('Duplicate check error:', err);
        return false;
      }
    }

    function showDuplicateModal(transaction) {
      $('dup-merchant').textContent = transaction['Chase Description'] || transaction['Merchant'] || '';
      $('dup-amount').textContent = '$' + Math.abs(parseFloat(transaction['Chase Amount'] || transaction['Amount'] || 0)).toFixed(2);
      $('dup-date').textContent = transaction['Chase Date'] || transaction['Date'] || '';

      $('duplicate-modal').classList.add('show');
      hapticFeedback('warning');
    }

    function closeDuplicateModal() {
      $('duplicate-modal').classList.remove('show');
      duplicateTransaction = null;
    }

    function useDuplicate() {
      // Link to existing transaction instead of creating new
      if (duplicateTransaction) {
        matchedTransaction = duplicateTransaction;
        $('match-section').style.display = 'block';
        $('match-merchant').textContent = duplicateTransaction['Chase Description'] || 'Unknown';
        $('match-meta').textContent = duplicateTransaction['Chase Date'] || '';
        $('match-amount').textContent = '$' + Math.abs(parseFloat(duplicateTransaction['Chase Amount'])).toFixed(2);
      }
      closeDuplicateModal();
      showToast(' Using existing transaction');
    }

    // ========================================
    // IMAGE QUALITY CHECK
    // ========================================
    function analyzeImageQuality(canvas) {
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      let brightness = 0;
      let contrast = 0;
      let blurScore = 0;

      // Calculate average brightness
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        brightness += (r + g + b) / 3;
      }
      brightness = brightness / (data.length / 4);

      // Simple edge detection for blur (Laplacian variance)
      const width = canvas.width;
      const height = canvas.height;
      let edgeSum = 0;
      let edgeCount = 0;

      for (let y = 1; y < height - 1; y += 2) {
        for (let x = 1; x < width - 1; x += 2) {
          const idx = (y * width + x) * 4;
          const center = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;

          const top = (data[idx - width * 4] + data[idx - width * 4 + 1] + data[idx - width * 4 + 2]) / 3;
          const bottom = (data[idx + width * 4] + data[idx + width * 4 + 1] + data[idx + width * 4 + 2]) / 3;
          const left = (data[idx - 4] + data[idx - 3] + data[idx - 2]) / 3;
          const right = (data[idx + 4] + data[idx + 5] + data[idx + 6]) / 3;

          const laplacian = Math.abs(4 * center - top - bottom - left - right);
          edgeSum += laplacian;
          edgeCount++;
        }
      }

      blurScore = edgeCount > 0 ? edgeSum / edgeCount : 0;

      const issues = [];

      // Too dark
      if (brightness < 50) {
        issues.push('Image is too dark');
      }
      // Too bright / overexposed
      else if (brightness > 220) {
        issues.push('Image is overexposed');
      }

      // Blurry (low edge variance)
      if (blurScore < 10) {
        issues.push('Image may be blurry');
      }

      return {
        brightness,
        blurScore,
        issues,
        isGood: issues.length === 0
      };
    }

    function showQualityWarning(issues) {
      const warning = $('quality-warning');
      const text = $('quality-text');

      if (issues.length > 0 && warning && text) {
        text.textContent = issues.join('  ');
        warning.style.display = 'flex';
      } else if (warning) {
        warning.style.display = 'none';
      }
    }

    // ========================================
    // SMART MATCHING
    // ========================================
    async function findMatchingTransaction(amount) {
      if (!isOnline) return;

      try {
        const response = await fetch(`${API_BASE}/api/transactions`);
        if (!response.ok) return;

        const transactions = await response.json();
        const merchant = $('merchant-input').value.toLowerCase();

        const matches = transactions.filter(t => {
          const txAmt = Math.abs(parseFloat(t['Chase Amount'] || 0));
          const amtMatch = Math.abs(txAmt - amount) < 0.01;
          const hasReceipt = t['Receipt File'] && t['Receipt File'].trim();
          return amtMatch && !hasReceipt;
        });

        if (matches.length > 0) {
          matchedTransaction = matches[0];
          $('match-section').style.display = 'block';
          $('match-merchant').textContent = matchedTransaction['Chase Description'] || 'Unknown';
          $('match-meta').textContent = matchedTransaction['Chase Date'] || '';
          $('match-amount').textContent = '$' + Math.abs(parseFloat(matchedTransaction['Chase Amount'])).toFixed(2);
          hapticFeedback('light');
        } else {
          $('match-section').style.display = 'none';
          matchedTransaction = null;
        }
      } catch (err) {
        console.error('Match error:', err);
      }
    }

    // ========================================
    // SAVE TO DEVICE
    // ========================================
    async function saveToDevice() {
      if (!currentImage.blob) {
        showToast('Capture a receipt first', 'error');
        return;
      }

      const merchant = $('merchant-input').value.trim() || 'Receipt';
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      const filename = `${merchant}_${timestamp}.jpg`;

      // Try Web Share API first (best for iOS - allows saving to Photos)
      if (navigator.canShare && navigator.canShare({ files: [new File([currentImage.blob], filename, { type: 'image/jpeg' })] })) {
        try {
          const file = new File([currentImage.blob], filename, { type: 'image/jpeg' });
          await navigator.share({
            files: [file],
            title: 'Receipt',
            text: `Receipt from ${merchant}`
          });
          showToast('Receipt shared!', 'success');
          hapticFeedback('success');
          return;
        } catch (err) {
          // User cancelled or share failed, fall through to download
          if (err.name !== 'AbortError') {
            console.log('Share failed, trying download:', err);
          }
        }
      }

      // Fallback: Download the file
      try {
        const url = URL.createObjectURL(currentImage.blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Receipt saved to Downloads', 'success');
        hapticFeedback('success');
      } catch (err) {
        console.error('Download failed:', err);
        showToast('Could not save receipt', 'error');
        hapticFeedback('error');
      }
    }

    // ========================================
    // SUBMISSION
    // ========================================
    async function submitReceipt() {
      const merchant = $('merchant-input').value.trim();
      const amount = parseFloat($('amount-input').value.replace(/[^0-9.-]/g, ''));

      if (!currentImage.blob) {
        showToast('Capture a receipt first', 'error');
        hapticFeedback('error');
        return;
      }

      if (!merchant) {
        showToast('Enter merchant name', 'error');
        hapticFeedback('error');
        $('merchant-input').focus();
        return;
      }

      if (isNaN(amount) || amount <= 0) {
        showToast('Enter a valid amount', 'error');
        hapticFeedback('error');
        $('amount-input').focus();
        return;
      }

      showProcessing('Saving receipt...', 'Uploading image');

      const receiptData = {
        merchant,
        amount,
        date: $('date-input').value,
        category: $('category-select').value || '',
        business: selectedBusiness,
        notes: $('notes-input').value || '',
        thumbnail: currentImage.data,
        timestamp: new Date().toISOString(),
        synced: false
      };

      try {
        if (isOnline) {
          const formData = new FormData();
          formData.append('file', currentImage.blob, `receipt_${Date.now()}.jpg`);
          formData.append('merchant', merchant);
          formData.append('amount', amount.toFixed(2));
          formData.append('date', $('date-input').value);
          formData.append('category', $('category-select').value || '');
          formData.append('business', selectedBusiness);
          formData.append('notes', $('notes-input').value || '');
          formData.append('source', SOURCE_TAG);

          // Add split data if enabled
          const splitData = getSplitData();
          if (splitData) {
            formData.append('split', JSON.stringify(splitData));
          }

          // Add voice note if recorded
          if (voiceNoteBlob) {
            formData.append('voice_note', voiceNoteBlob, `voice_${Date.now()}.webm`);
          }

          updateProcessing('Saving receipt...', 'Processing data');

          const response = await fetch(`${API_BASE}/mobile-upload`, {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            receiptData.synced = true;
            receiptData.serverId = result.id;
          }
        }
      } catch (err) {
        console.error('Upload error:', err);
        receiptData.pendingData = {
          imageData: currentImage.data,
          category: $('category-select').value,
          notes: $('notes-input').value
        };
      }

      // Save to IndexedDB
      const id = await saveToIndexedDB(receiptData);
      receiptData.id = id;
      history.unshift(receiptData);

      hideProcessing();

      // Update pending badge
      updatePendingBadge();

      // Success feedback
      hapticFeedback('success');
      $('success-message').textContent = receiptData.synced
        ? (matchedTransaction ? `Matched to "${matchedTransaction['Chase Description']}"` : 'Receipt saved and synced!')
        : 'Saved offline. Will sync when connected.';
      $('success-modal').classList.add('visible');

      // Request background sync
      if ('serviceWorker' in navigator && 'sync' in window.registration) {
        navigator.serviceWorker.ready.then(reg => {
          reg.sync.register('receipt-upload');
        });
      }
    }

    // ========================================
    // SYNC PENDING UPLOADS
    // ========================================
    async function syncPendingUploads() {
      if (!isOnline) return;

      $('status-dot').classList.add('syncing');
      $('status-text').textContent = 'Syncing...';

      const pending = history.filter(h => !h.synced && h.pendingData);
      let synced = 0;

      for (const item of pending) {
        try {
          const response = await fetch(item.pendingData.imageData);
          const blob = await response.blob();

          const formData = new FormData();
          formData.append('file', blob, `receipt_${item.id}.jpg`);
          formData.append('merchant', item.merchant);
          formData.append('amount', item.amount.toFixed(2));
          formData.append('date', item.date);
          formData.append('category', item.pendingData.category || '');
          formData.append('business', item.business || '');
          formData.append('notes', item.pendingData.notes || '');
          formData.append('source', SOURCE_TAG);

          const uploadResponse = await fetch(`${API_BASE}/mobile-upload`, {
            method: 'POST',
            body: formData
          });

          if (uploadResponse.ok) {
            item.synced = true;
            delete item.pendingData;
            await updateReceiptSync(item.id, true);
            synced++;
          }
        } catch (err) {
          console.error('Sync error:', err);
        }
      }

      $('status-dot').classList.remove('syncing');
      $('status-text').textContent = 'Connected';

      if (synced > 0) {
        showToast(`${synced} receipt${synced > 1 ? 's' : ''} sent to Inbox`, 'success');
        hapticFeedback('success');
      }

      updatePendingBadge();
      renderHistory();
    }

    function updatePendingBadge() {
      const pending = history.filter(h => !h.synced).length;
      const badge = $('pending-badge');
      if (pending > 0) {
        badge.textContent = pending;
        badge.classList.add('visible');
      } else {
        badge.classList.remove('visible');
      }
    }

    // ========================================
    // HISTORY
    // ========================================
    function setHistoryFilter(filter) {
      historyFilter = filter;

      // Update filter chip UI
      $$('.filter-chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
      });

      hapticFeedback('light');
      renderHistory();
    }

    async function refreshInbox() {
      const btn = $('refresh-inbox-btn');
      btn.classList.add('loading');

      try {
        await loadInboxReceipts();
        await loadHistory();
        renderHistory();
        showToast('Inbox refreshed', 'success');
      } catch (error) {
        showToast('Refresh failed', 'error');
      } finally {
        btn.classList.remove('loading');
      }
    }

    function renderHistory() {
      // Get combined & filtered history
      const filteredItems = getFilteredHistory();

      // Calculate today's stats from ALL items (not filtered)
      const allItems = getFilteredHistory.call({ historyFilter: 'all' }) || [...history, ...inboxReceipts];
      const todayItems = allItems.filter(h => {
        const d = new Date(h.timestamp);
        const today = new Date();
        return d.toDateString() === today.toDateString();
      });

      const todayTotal = todayItems.reduce((sum, h) => sum + (parseFloat(h.amount) || 0), 0);

      $('stat-count').textContent = todayItems.length;
      $('stat-total').textContent = '$' + todayTotal.toFixed(0);

      if (filteredItems.length === 0) {
        const emptyMessage = historyFilter === 'all'
          ? 'No receipts yet'
          : `No ${historyFilter} receipts`;
        const emptySubtext = historyFilter === 'all'
          ? 'Scan a receipt or check your email inbox'
          : 'Try a different filter';

        $('history-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                <path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/>
              </svg>
            </div>
            <h3>${emptyMessage}</h3>
            <p>${emptySubtext}</p>
          </div>
        `;
        return;
      }

      $('history-list').innerHTML = filteredItems.slice(0, 50).map((item, index) => {
        // Determine status styling
        const statusClass = item.status === 'accepted' ? 'accepted'
          : item.status === 'rejected' ? 'rejected'
          : item.status === 'pending' || !item.synced ? 'pending'
          : 'synced';

        const statusText = item.status === 'accepted' ? 'Accepted'
          : item.status === 'rejected' ? 'Rejected'
          : item.status === 'pending' ? 'Pending'
          : !item.synced ? 'Uploading...'
          : 'In Inbox';

        // Source icon
        const sourceIcon = item.sourceType === 'inbox' || item.source === 'email'
          ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
               <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
               <polyline points="22,6 12,13 2,6"/>
             </svg>`
          : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
               <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
               <circle cx="12" cy="13" r="4"/>
             </svg>`;

        // Thumbnail or placeholder
        const thumbSrc = item.thumbnail || item.receipt_url || '';
        const thumbHtml = thumbSrc
          ? `<img class="history-thumb" src="${thumbSrc}" alt="" loading="lazy" onerror="this.style.display='none'">`
          : `<div class="history-thumb-placeholder">
               <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24">
                 <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                 <circle cx="8.5" cy="8.5" r="1.5"/>
                 <polyline points="21 15 16 10 5 21"/>
               </svg>
             </div>`;

        // Confidence badge for email receipts
        const confidenceBadge = item.confidence
          ? `<span class="confidence-badge ${item.confidence >= 90 ? 'high' : item.confidence >= 70 ? 'medium' : 'low'}">${item.confidence}%</span>`
          : '';

        return `
          <div class="history-item ${statusClass}" onclick="openReceiptDetail(${index}, '${item.sourceType || 'local'}')">
            ${thumbHtml}
            <div class="history-content">
              <div class="history-row">
                <span class="history-merchant">${item.merchant || 'Unknown'}</span>
                <span class="history-amount">${item.amount ? '$' + parseFloat(item.amount).toFixed(2) : ''}</span>
              </div>
              <div class="history-meta">
                <span class="history-source">${sourceIcon}</span>
                <span>${formatRelativeDate(item.timestamp)}</span>
                ${item.business ? `<span>${item.business}</span>` : ''}
                <span class="history-status ${statusClass}">${statusText}</span>
                ${confidenceBadge}
              </div>
            </div>
          </div>
        `;
      }).join('');

      updatePendingBadge();
    }

    // ========================================
    // RECEIPT DETAIL MODAL
    // ========================================
    function openReceiptDetail(index) {
      hapticFeedback('light');
      const item = history[index];
      if (!item) return;

      currentDetailReceipt = { ...item, index };

      // Populate the modal
      $('detail-image').src = item.thumbnail || item.image || '';
      $('detail-merchant').textContent = item.merchant || 'Unknown';
      $('detail-amount').textContent = '$' + parseFloat(item.amount || 0).toFixed(2);
      $('detail-date').textContent = item.date ? formatFullDate(item.date) : formatFullDate(item.timestamp);
      $('detail-business').textContent = item.business || 'Personal';
      $('detail-status').textContent = item.synced ? 'In Inbox' : 'Pending sync';
      $('detail-scanned').textContent = formatFullDate(item.timestamp);

      // Notes
      if (item.notes) {
        $('detail-notes').style.display = 'block';
        $('detail-notes').textContent = item.notes;
      } else {
        $('detail-notes').style.display = 'none';
      }

      // Update sync button state
      const syncBtn = $('detail-sync-btn');
      if (item.synced) {
        syncBtn.classList.remove('sync');
        syncBtn.classList.add('synced');
        syncBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          In Inbox
        `;
      } else {
        syncBtn.classList.add('sync');
        syncBtn.classList.remove('synced');
        syncBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          Sync Now
        `;
      }

      // Show modal
      $('receipt-detail-modal').classList.add('visible');
    }

    function closeReceiptDetail() {
      $('receipt-detail-modal').classList.remove('visible');
      currentDetailReceipt = null;
    }

    function formatFullDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    }

    async function deleteCurrentReceipt() {
      if (!currentDetailReceipt) return;

      hapticFeedback('medium');

      // Confirm deletion
      if (!confirm('Delete this receipt? This cannot be undone.')) {
        return;
      }

      try {
        // Delete from IndexedDB
        if (db && currentDetailReceipt.id) {
          await deleteFromIndexedDB(currentDetailReceipt.id);
        }

        // Remove from history array
        history.splice(currentDetailReceipt.index, 1);

        // Also remove from localStorage backup
        localStorage.setItem('receiptHistory', JSON.stringify(history));

        hapticFeedback('success');
        showToast('Receipt deleted', 'success');
        closeReceiptDetail();
        renderHistory();
      } catch (e) {
        console.error('Delete error:', e);
        hapticFeedback('error');
        showToast('Failed to delete', 'error');
      }
    }

    async function deleteFromIndexedDB(id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction('receipts', 'readwrite');
        const store = tx.objectStore('receipts');
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    async function resyncReceipt() {
      if (!currentDetailReceipt || currentDetailReceipt.synced) return;

      hapticFeedback('medium');
      const syncBtn = $('detail-sync-btn');
      const originalHtml = syncBtn.innerHTML;
      syncBtn.innerHTML = `<span style="display:inline-block;animation:spin 1s linear infinite;"></span> Syncing...`;
      syncBtn.disabled = true;

      try {
        // Try to sync the pending data
        if (currentDetailReceipt.pendingData) {
          const formData = new FormData();
          if (currentDetailReceipt.pendingData.blob) {
            formData.append('receipt', currentDetailReceipt.pendingData.blob, 'receipt.jpg');
          }
          formData.append('merchant', currentDetailReceipt.merchant || '');
          formData.append('amount', currentDetailReceipt.amount || '');
          formData.append('date', currentDetailReceipt.date || '');
          formData.append('notes', currentDetailReceipt.notes || '');
          formData.append('business', currentDetailReceipt.business || '');
          formData.append('source', SOURCE_TAG);

          const response = await fetch(`${API_BASE}/api/scanner/upload`, {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            await updateReceiptSync(currentDetailReceipt.id, true);
            currentDetailReceipt.synced = true;
            history[currentDetailReceipt.index].synced = true;
            hapticFeedback('success');
            showToast('Receipt synced!', 'success');
            openReceiptDetail(currentDetailReceipt.index); // Refresh modal
            renderHistory();
          } else {
            throw new Error('Sync failed');
          }
        }
      } catch (e) {
        console.error('Resync error:', e);
        hapticFeedback('error');
        showToast('Sync failed - try again later', 'error');
        syncBtn.innerHTML = originalHtml;
        syncBtn.disabled = false;
      }
    }

    // ========================================
    // UTILITIES
    // ========================================
    function formatDateForInput(dateStr) {
      const date = new Date(dateStr);
      return !isNaN(date.getTime()) ? date.toISOString().split('T')[0] : $('date-input').value;
    }

    function formatRelativeDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function showProcessing(text, step) {
      $('processing-text').textContent = text;
      $('processing-step').textContent = step;
      $('processing-overlay').classList.add('visible');
    }

    function updateProcessing(text, step) {
      $('processing-text').textContent = text;
      $('processing-step').textContent = step;
    }

    function hideProcessing() {
      $('processing-overlay').classList.remove('visible');
    }

    function showToast(message, type = 'success') {
      const toast = $('toast');
      $('toast-text').textContent = message;
      toast.className = 'toast ' + type;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 3000);
    }

    function resetScanner() {
      currentImage = { data: null, blob: null };
      matchedTransaction = null;
      duplicateTransaction = null;
      selectedBusiness = '';

      $('image-preview').style.display = 'none';
      $('camera-placeholder').style.display = 'flex';
      $('camera-frame').classList.remove('has-image');
      $('extraction-panel').classList.remove('visible');
      $('success-modal').classList.remove('visible');
      $('match-section').style.display = 'none';
      $('retake-btn').classList.remove('visible');
      $('save-device-btn').disabled = true;

      // Reset form
      $('merchant-input').value = '';
      $('merchant-input').classList.remove('ai-filled');
      $('amount-input').value = '';
      $('amount-input').classList.remove('ai-filled');
      $('date-input').value = new Date().toISOString().split('T')[0];
      $('date-input').classList.remove('ai-filled');
      $('category-select').value = '';
      $('notes-input').value = '';
      $('notes-input').classList.remove('ai-filled');
      $('notes-label').innerHTML = 'Notes';
      $$('.biz-chip').forEach(c => c.classList.remove('selected'));
      $('file-input').value = '';

      // Reset new features
      deleteVoiceNote();
      splitEnabled = false;
      const splitToggle = $('split-toggle');
      const splitOptions = $('split-options');
      if (splitToggle) splitToggle.classList.remove('active');
      if (splitOptions) splitOptions.style.display = 'none';

      // Hide quality warning
      const qualityWarning = $('quality-warning');
      if (qualityWarning) qualityWarning.style.display = 'none';

      // Show templates section again
      const templatesSection = $('templates-section');
      if (templatesSection) templatesSection.classList.add('visible');
    }

    async function checkConnection() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        if (response.ok) {
          isOnline = true;
          $('status-text').textContent = 'Connected';
          $('status-dot').classList.remove('offline');
          syncPendingUploads();
        } else {
          isOnline = false;
          $('status-text').textContent = 'Offline';
          $('status-dot').classList.add('offline');
        }
      } catch {
        isOnline = false;
        $('status-text').textContent = 'Offline';
        $('status-dot').classList.add('offline');
      }
    }
  </script>
</body>
</html>
