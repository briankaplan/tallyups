<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tallyups">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/receipt-icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/receipt-icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/receipt-icon-512.png">
  <title>Tallyups Scanner</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    :root {
      --bg: #000000;
      --bg-card: #111111;
      --bg-elevated: #1a1a1a;
      --accent: #00ff88;
      --accent-dim: rgba(0, 255, 136, 0.15);
      --text: #ffffff;
      --text-dim: #666666;
      --text-secondary: #999999;
      --border: #222222;
      --success: #00ff88;
      --warning: #ffaa00;
      --error: #ff4444;
      --glass: rgba(255, 255, 255, 0.05);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
      touch-action: pan-y;
    }

    /* PWA Install Banner */
    .install-banner {
      position: fixed;
      bottom: calc(70px + var(--safe-bottom));
      left: 16px;
      right: 16px;
      background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));
      border: 1px solid var(--accent);
      border-radius: 20px;
      padding: 16px 20px;
      display: none;
      align-items: center;
      gap: 14px;
      z-index: 150;
      box-shadow: 0 8px 32px rgba(0, 255, 136, 0.2);
      animation: slideUp 0.4s ease-out;
    }

    .install-banner.visible {
      display: flex;
    }

    .install-banner-icon {
      width: 48px;
      height: 48px;
      background: var(--accent);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .install-banner-icon svg {
      width: 24px;
      height: 24px;
      color: #000;
    }

    .install-banner-content {
      flex: 1;
    }

    .install-banner-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .install-banner-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .install-banner-btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    .install-banner-close {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-dim);
    }

    /* Offline Banner */
    .offline-banner {
      position: fixed;
      top: calc(var(--safe-top) + 60px);
      left: 16px;
      right: 16px;
      background: var(--warning);
      color: #000;
      padding: 10px 16px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
      z-index: 160;
      animation: slideDown 0.3s ease-out;
    }

    .offline-banner.visible {
      display: flex;
    }

    .offline-banner svg {
      width: 16px;
      height: 16px;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: calc(var(--safe-top) + 8px) 20px 12px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.98) 60%, transparent);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg {
      width: 18px;
      height: 18px;
      color: #000;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--glass);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    .status-dot.offline {
      background: var(--warning);
    }

    .status-dot.syncing {
      background: var(--accent);
      animation: spin 1s linear infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.85); }
    }

    /* Main Container */
    .main {
      height: 100%;
      padding-top: calc(var(--safe-top) + 64px);
      padding-bottom: calc(70px + var(--safe-bottom));
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Camera View */
    .camera-view {
      position: relative;
      width: 100%;
      padding: 16px;
    }

    .camera-frame {
      position: relative;
      width: 100%;
      aspect-ratio: 3/4;
      background: var(--bg-card);
      border-radius: 28px;
      overflow: hidden;
      border: 2px solid var(--border);
      transition: all 0.3s ease;
    }

    .camera-frame.has-image {
      border-color: var(--accent);
      box-shadow: 0 0 60px var(--accent-dim), inset 0 0 30px rgba(0, 255, 136, 0.05);
    }

    .camera-frame.drag-over {
      border-color: var(--accent);
      background: var(--accent-dim);
      transform: scale(1.02);
    }

    #video-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    #image-preview {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
      display: none;
    }

    .camera-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      padding: 40px;
    }

    .scan-icon {
      width: 100px;
      height: 100px;
      border: 2px dashed var(--border);
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .scan-icon svg {
      width: 44px;
      height: 44px;
      color: var(--text-dim);
    }

    .scan-hint {
      text-align: center;
    }

    .scan-hint h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text);
    }

    .scan-hint p {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* Corner markers */
    .corner-markers {
      position: absolute;
      inset: 24px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .camera-frame.has-image .corner-markers {
      opacity: 1;
    }

    .corner {
      position: absolute;
      width: 28px;
      height: 28px;
      border-color: var(--accent);
      border-style: solid;
      border-width: 0;
    }

    .corner.tl { top: 0; left: 0; border-top-width: 3px; border-left-width: 3px; border-top-left-radius: 10px; }
    .corner.tr { top: 0; right: 0; border-top-width: 3px; border-right-width: 3px; border-top-right-radius: 10px; }
    .corner.bl { bottom: 0; left: 0; border-bottom-width: 3px; border-left-width: 3px; border-bottom-left-radius: 10px; }
    .corner.br { bottom: 0; right: 0; border-bottom-width: 3px; border-right-width: 3px; border-bottom-right-radius: 10px; }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 12px;
      padding: 0 16px;
      margin-top: 20px;
    }

    .action-btn {
      flex: 1;
      height: 60px;
      border: none;
      border-radius: 18px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.15s ease;
      position: relative;
      overflow: hidden;
    }

    .action-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
      pointer-events: none;
    }

    .action-btn svg {
      width: 22px;
      height: 22px;
    }

    .action-btn.primary {
      background: var(--accent);
      color: #000;
    }

    .action-btn.primary:active {
      transform: scale(0.96);
      filter: brightness(0.85);
    }

    .action-btn.secondary {
      background: var(--bg-elevated);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .action-btn.secondary:active {
      background: var(--border);
      transform: scale(0.96);
    }

    /* Pending uploads badge */
    .pending-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 22px;
      height: 22px;
      background: var(--warning);
      color: #000;
      border-radius: 11px;
      font-size: 12px;
      font-weight: 800;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
    }

    .pending-badge.visible {
      display: flex;
    }

    /* AI Extraction Panel */
    .extraction-panel {
      padding: 16px;
      display: none;
    }

    .extraction-panel.visible {
      display: block;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--accent-dim);
      border-radius: 24px;
      font-size: 13px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 18px;
    }

    .ai-badge svg {
      width: 16px;
      height: 16px;
    }

    .extraction-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid var(--border);
    }

    .field-group {
      margin-bottom: 22px;
    }

    .field-group:last-child {
      margin-bottom: 0;
    }

    .field-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 10px;
    }

    .field-input {
      width: 100%;
      height: 56px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 0 18px;
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
      outline: none;
      transition: all 0.2s;
      -webkit-appearance: none;
    }

    .field-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-dim);
    }

    .field-input::placeholder {
      color: var(--text-dim);
      font-weight: 500;
    }

    .field-input.ai-filled {
      border-color: var(--accent);
      background: linear-gradient(135deg, var(--accent-dim), transparent);
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    /* Amount field */
    .amount-input {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -1px;
      text-align: center;
    }

    /* Business chips */
    .business-chips {
      display: flex;
      gap: 10px;
    }

    .biz-chip {
      flex: 1;
      padding: 16px 12px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .biz-chip:active {
      transform: scale(0.96);
    }

    .biz-chip.selected {
      background: var(--accent-dim);
      border-color: var(--accent);
    }

    .biz-chip-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }

    .biz-chip-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
    }

    .biz-chip.selected .biz-chip-label {
      color: var(--accent);
    }

    /* Transaction match */
    .match-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .match-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .match-header svg {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    .match-header span {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent);
    }

    .match-card {
      background: var(--bg);
      border: 2px solid var(--accent);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .match-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .match-merchant {
      font-size: 16px;
      font-weight: 700;
    }

    .match-meta {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .match-amount {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
    }

    /* Submit section */
    .submit-section {
      padding: 20px 16px;
      padding-bottom: calc(20px + var(--safe-bottom));
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      background: linear-gradient(to top, var(--bg) 85%, transparent);
    }

    .submit-btn {
      width: 100%;
      height: 60px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 18px;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.15s;
      position: relative;
      overflow: hidden;
    }

    .submit-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
    }

    .submit-btn:active {
      transform: scale(0.97);
    }

    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .submit-btn svg {
      width: 22px;
      height: 22px;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: calc(70px + var(--safe-bottom));
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-around;
      padding-top: 10px;
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px 24px;
      color: var(--text-dim);
      text-decoration: none;
      transition: color 0.2s;
      position: relative;
    }

    .nav-item.active {
      color: var(--accent);
    }

    .nav-item svg {
      width: 26px;
      height: 26px;
    }

    .nav-item span {
      font-size: 11px;
      font-weight: 700;
    }

    /* Processing Overlay */
    .processing-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.97);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 28px;
      z-index: 200;
    }

    .processing-overlay.visible {
      display: flex;
    }

    .ai-processing {
      width: 100px;
      height: 100px;
      position: relative;
    }

    .ai-ring {
      position: absolute;
      inset: 0;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .ai-ring:nth-child(2) {
      inset: 10px;
      animation-direction: reverse;
      animation-duration: 0.75s;
      border-top-color: var(--warning);
    }

    .ai-ring:nth-child(3) {
      inset: 20px;
      animation-duration: 1.25s;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .processing-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .processing-step {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Success Modal */
    .success-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.97);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 24px;
    }

    .success-modal.visible {
      display: flex;
    }

    .success-card {
      background: var(--bg-card);
      border-radius: 28px;
      padding: 48px 32px;
      text-align: center;
      max-width: 340px;
      width: 100%;
      border: 1px solid var(--border);
      animation: scaleIn 0.3s ease-out;
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .success-icon {
      width: 88px;
      height: 88px;
      background: var(--accent-dim);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 28px;
      animation: successPop 0.4s ease-out 0.2s both;
    }

    @keyframes successPop {
      0% { transform: scale(0); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .success-icon svg {
      width: 44px;
      height: 44px;
      color: var(--accent);
    }

    .success-card h3 {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 10px;
    }

    .success-card p {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 36px;
      line-height: 1.6;
    }

    .success-actions {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .success-btn {
      width: 100%;
      height: 56px;
      border-radius: 16px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
    }

    .success-btn:active {
      transform: scale(0.97);
    }

    .success-btn.primary {
      background: var(--accent);
      color: #000;
    }

    .success-btn.secondary {
      background: var(--bg);
      color: var(--text);
      border: 2px solid var(--border);
    }

    /* History View */
    .history-view {
      padding: 16px;
      display: none;
    }

    .history-view.visible {
      display: block;
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .history-header h2 {
      font-size: 24px;
      font-weight: 800;
    }

    .history-stats {
      display: flex;
      gap: 20px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      font-weight: 600;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .history-item {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 18px;
      display: flex;
      gap: 16px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .history-item:active {
      transform: scale(0.98);
      background: var(--bg-elevated);
    }

    .history-thumb {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      object-fit: cover;
      background: var(--bg);
    }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .history-merchant {
      font-size: 16px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-amount {
      font-size: 17px;
      font-weight: 800;
    }

    .history-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .history-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--accent-dim);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
    }

    .history-status.pending {
      background: rgba(255, 170, 0, 0.15);
      color: var(--warning);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 80px 24px;
    }

    .empty-icon {
      width: 100px;
      height: 100px;
      background: var(--bg-card);
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .empty-icon svg {
      width: 44px;
      height: 44px;
      color: var(--text-dim);
    }

    .empty-state h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 15px;
      color: var(--text-secondary);
    }

    /* Toast */
    .toast {
      position: fixed;
      top: calc(var(--safe-top) + 70px);
      left: 16px;
      right: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      transform: translateY(-120%);
      opacity: 0;
      transition: all 0.3s ease-out;
      z-index: 170;
    }

    .toast.visible {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .toast-icon svg {
      width: 16px;
      height: 16px;
    }

    .toast.success .toast-icon {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .toast.error .toast-icon {
      background: rgba(255, 68, 68, 0.15);
      color: var(--error);
    }

    .toast.info .toast-icon {
      background: rgba(255, 170, 0, 0.15);
      color: var(--warning);
    }

    .toast-text {
      font-size: 15px;
      font-weight: 600;
    }

    /* Hidden inputs */
    #file-input, #batch-input {
      display: none;
    }

    /* Voice button */
    .voice-btn {
      position: absolute;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 6px 24px rgba(0, 255, 136, 0.35);
      transition: all 0.2s;
      z-index: 10;
    }

    .voice-btn:active {
      transform: scale(0.92);
    }

    .voice-btn svg {
      width: 26px;
      height: 26px;
      color: #000;
    }

    .voice-btn.recording {
      background: var(--error);
      animation: pulseRecord 1s infinite;
    }

    @keyframes pulseRecord {
      0%, 100% { box-shadow: 0 6px 24px rgba(255, 68, 68, 0.35); }
      50% { box-shadow: 0 6px 48px rgba(255, 68, 68, 0.6); }
    }

    /* Retake button */
    .retake-btn {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 44px;
      height: 44px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
    }

    .retake-btn.visible {
      display: flex;
    }

    .retake-btn svg {
      width: 22px;
      height: 22px;
      color: var(--text);
    }

    /* Flash toggle */
    .flash-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 44px;
      height: 44px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
    }

    .flash-btn.visible {
      display: flex;
    }

    .flash-btn.active {
      background: var(--warning);
    }

    .flash-btn svg {
      width: 22px;
      height: 22px;
      color: var(--text);
    }

    .flash-btn.active svg {
      color: #000;
    }

    /* Haptic feedback visual */
    .haptic-flash {
      position: fixed;
      inset: 0;
      background: var(--accent);
      opacity: 0;
      pointer-events: none;
      z-index: 300;
      transition: opacity 0.1s;
    }

    .haptic-flash.active {
      opacity: 0.15;
    }
  </style>
</head>
<body>
  <!-- Haptic Flash -->
  <div class="haptic-flash" id="haptic-flash"></div>

  <!-- Offline Banner -->
  <div class="offline-banner" id="offline-banner">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <line x1="1" y1="1" x2="23" y2="23"></line>
      <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path>
      <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path>
      <path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path>
      <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path>
      <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
      <line x1="12" y1="20" x2="12.01" y2="20"></line>
    </svg>
    Offline - Receipts will sync when connected
  </div>

  <!-- Install Banner -->
  <div class="install-banner" id="install-banner">
    <button class="install-banner-close" onclick="dismissInstall()">√ó</button>
    <div class="install-banner-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    </div>
    <div class="install-banner-content">
      <div class="install-banner-title">Install Tallyups</div>
      <div class="install-banner-desc">Add to home screen for the best experience</div>
    </div>
    <button class="install-banner-btn" onclick="installApp()">Install</button>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
        </div>
        Tallyups
      </div>
      <div class="status-pill" id="status-pill">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Ready</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <!-- Camera View -->
    <section class="camera-view" id="camera-view">
      <div class="camera-frame" id="camera-frame">
        <video id="video-preview" autoplay playsinline muted></video>
        <img id="image-preview" alt="Receipt">

        <!-- Retake button -->
        <button class="retake-btn" id="retake-btn" title="Retake">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="1 4 1 10 7 10"></polyline>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
          </svg>
        </button>

        <!-- Flash toggle -->
        <button class="flash-btn" id="flash-btn" title="Toggle flash">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
          </svg>
        </button>

        <div class="camera-placeholder" id="camera-placeholder">
          <div class="scan-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
          </div>
          <div class="scan-hint">
            <h2>Scan Receipt</h2>
            <p>Tap to capture or drag & drop.<br>AI extracts everything automatically.</p>
          </div>
        </div>

        <div class="corner-markers">
          <div class="corner tl"></div>
          <div class="corner tr"></div>
          <div class="corner bl"></div>
          <div class="corner br"></div>
        </div>

        <!-- Voice Button -->
        <button class="voice-btn" id="voice-btn" title="Voice note">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
            <line x1="12" y1="19" x2="12" y2="23"></line>
            <line x1="8" y1="23" x2="16" y2="23"></line>
          </svg>
        </button>
      </div>

      <div class="quick-actions">
        <button class="action-btn primary" id="capture-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="4" fill="currentColor"></circle>
          </svg>
          Capture
        </button>
        <button class="action-btn secondary" id="gallery-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
          Gallery
          <span class="pending-badge" id="pending-badge">0</span>
        </button>
      </div>

      <input type="file" id="file-input" accept="image/*,application/pdf">
      <input type="file" id="batch-input" accept="image/*" multiple>
    </section>

    <!-- AI Extraction Panel -->
    <section class="extraction-panel" id="extraction-panel">
      <div class="ai-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
          <path d="M2 17l10 5 10-5"></path>
          <path d="M2 12l10 5 10-5"></path>
        </svg>
        AI Extracted
      </div>

      <div class="extraction-card">
        <div class="field-group">
          <label class="field-label">Amount</label>
          <input type="text" class="field-input amount-input" id="amount-input" placeholder="$0.00" inputmode="decimal">
        </div>

        <div class="field-group">
          <label class="field-label">Merchant</label>
          <input type="text" class="field-input" id="merchant-input" placeholder="Store name">
        </div>

        <div class="field-row">
          <div class="field-group">
            <label class="field-label">Date</label>
            <input type="date" class="field-input" id="date-input">
          </div>
          <div class="field-group">
            <label class="field-label">Category</label>
            <select class="field-input" id="category-select">
              <option value="">Auto</option>
              <option value="Food & Dining">Food & Dining</option>
              <option value="Gas/Automotive">Gas</option>
              <option value="Shopping">Shopping</option>
              <option value="Travel">Travel</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Subscriptions">Subscriptions</option>
              <option value="Professional Services">Services</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">Business</label>
          <div class="business-chips">
            <div class="biz-chip" data-biz="Down Home">
              <div class="biz-chip-icon">üè†</div>
              <div class="biz-chip-label">Down Home</div>
            </div>
            <div class="biz-chip" data-biz="Music City Rodeo">
              <div class="biz-chip-icon">üé∏</div>
              <div class="biz-chip-label">MCR</div>
            </div>
            <div class="biz-chip" data-biz="Personal">
              <div class="biz-chip-icon">üë§</div>
              <div class="biz-chip-label">Personal</div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <label class="field-label" id="notes-label">Notes</label>
          <input type="text" class="field-input" id="notes-input" placeholder="Add context...">
        </div>

        <!-- Transaction Match -->
        <div class="match-section" id="match-section" style="display: none;">
          <div class="match-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span>Matched Transaction</span>
          </div>
          <div class="match-card">
            <div class="match-info">
              <div class="match-merchant" id="match-merchant">‚Äî</div>
              <div class="match-meta" id="match-meta">‚Äî</div>
            </div>
            <div class="match-amount" id="match-amount">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="submit-section">
        <button class="submit-btn" id="submit-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13"></path>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
          </svg>
          Save Receipt
        </button>
      </div>
    </section>

    <!-- History View -->
    <section class="history-view" id="history-view">
      <div class="history-header">
        <h2>Recent</h2>
        <div class="history-stats">
          <div class="stat">
            <div class="stat-value" id="stat-count">0</div>
            <div class="stat-label">Today</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="stat-total">$0</div>
            <div class="stat-label">Total</div>
          </div>
        </div>
      </div>
      <div class="history-list" id="history-list"></div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="#" class="nav-item active" data-view="scan">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="3" y1="9" x2="21" y2="9"></line>
      </svg>
      <span>Scan</span>
    </a>
    <a href="#" class="nav-item" data-view="history">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <span>History</span>
    </a>
  </nav>

  <!-- Processing Overlay -->
  <div class="processing-overlay" id="processing-overlay">
    <div class="ai-processing">
      <div class="ai-ring"></div>
      <div class="ai-ring"></div>
      <div class="ai-ring"></div>
    </div>
    <div class="processing-text" id="processing-text">Analyzing receipt...</div>
    <div class="processing-step" id="processing-step">Extracting text</div>
  </div>

  <!-- Success Modal -->
  <div class="success-modal" id="success-modal">
    <div class="success-card">
      <div class="success-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <h3>Receipt Saved!</h3>
      <p id="success-message">Your receipt has been added and is ready for matching.</p>
      <div class="success-actions">
        <button class="success-btn primary" id="scan-another-btn">Scan Another</button>
        <button class="success-btn secondary" id="view-history-btn">View History</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toast-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
    <span class="toast-text" id="toast-text">Saved!</span>
  </div>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const API_BASE = window.location.origin;
    const SOURCE_TAG = 'mobile_scanner_pwa';
    const DB_NAME = 'TallyupsDB';
    const DB_VERSION = 1;

    // ========================================
    // STATE
    // ========================================
    let currentImage = { data: null, blob: null };
    let selectedBusiness = '';
    let matchedTransaction = null;
    let history = [];
    let isOnline = navigator.onLine;
    let deferredPrompt = null;
    let db = null;
    let cameraStream = null;
    let flashEnabled = false;

    // ========================================
    // DOM ELEMENTS
    // ========================================
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelectorAll(sel);

    // ========================================
    // INITIALIZATION
    // ========================================
    document.addEventListener('DOMContentLoaded', async () => {
      await initDB();
      await loadHistory();
      setupEventListeners();
      setupPWA();
      setupOfflineDetection();
      setupDragDrop();
      checkConnection();
      renderHistory();
      $('date-input').value = new Date().toISOString().split('T')[0];
    });

    // ========================================
    // INDEXED DB FOR OFFLINE STORAGE
    // ========================================
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };

        request.onupgradeneeded = (e) => {
          const database = e.target.result;

          // Receipts store
          if (!database.objectStoreNames.contains('receipts')) {
            const store = database.createObjectStore('receipts', { keyPath: 'id', autoIncrement: true });
            store.createIndex('synced', 'synced');
            store.createIndex('timestamp', 'timestamp');
          }

          // Pending uploads store
          if (!database.objectStoreNames.contains('pending')) {
            database.createObjectStore('pending', { keyPath: 'id', autoIncrement: true });
          }
        };
      });
    }

    async function saveToIndexedDB(receipt) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction('receipts', 'readwrite');
        const store = tx.objectStore('receipts');
        const request = store.add(receipt);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function loadHistory() {
      return new Promise((resolve) => {
        if (!db) {
          history = JSON.parse(localStorage.getItem('receiptHistory') || '[]');
          resolve();
          return;
        }

        const tx = db.transaction('receipts', 'readonly');
        const store = tx.objectStore('receipts');
        const request = store.getAll();

        request.onsuccess = () => {
          history = request.result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          resolve();
        };
        request.onerror = () => {
          history = [];
          resolve();
        };
      });
    }

    async function updateReceiptSync(id, synced) {
      return new Promise((resolve) => {
        const tx = db.transaction('receipts', 'readwrite');
        const store = tx.objectStore('receipts');
        const getRequest = store.get(id);

        getRequest.onsuccess = () => {
          const receipt = getRequest.result;
          if (receipt) {
            receipt.synced = synced;
            delete receipt.pendingData;
            store.put(receipt);
          }
          resolve();
        };
      });
    }

    // ========================================
    // PWA SETUP
    // ========================================
    function setupPWA() {
      // Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            console.log('[PWA] Service worker registered');

            // Listen for messages from SW
            navigator.serviceWorker.addEventListener('message', (e) => {
              if (e.data.type === 'SYNC_UPLOADS') {
                syncPendingUploads();
              }
            });
          })
          .catch(err => console.log('[PWA] SW registration failed:', err));
      }

      // Install prompt
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;

        // Show install banner if not dismissed
        if (!localStorage.getItem('installDismissed')) {
          setTimeout(() => {
            $('install-banner').classList.add('visible');
          }, 3000);
        }
      });

      // Detect if running as PWA
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('[PWA] Running in standalone mode');
      }
    }

    window.installApp = async () => {
      if (!deferredPrompt) {
        // iOS instructions
        showToast('Tap Share ‚Üí Add to Home Screen', 'info');
        return;
      }

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        showToast('Installing Tallyups...', 'success');
        hapticFeedback();
      }

      deferredPrompt = null;
      $('install-banner').classList.remove('visible');
    };

    window.dismissInstall = () => {
      $('install-banner').classList.remove('visible');
      localStorage.setItem('installDismissed', 'true');
    };

    // ========================================
    // OFFLINE DETECTION
    // ========================================
    function setupOfflineDetection() {
      window.addEventListener('online', () => {
        isOnline = true;
        $('offline-banner').classList.remove('visible');
        $('status-dot').classList.remove('offline');
        $('status-text').textContent = 'Connected';
        showToast('Back online!', 'success');
        syncPendingUploads();
      });

      window.addEventListener('offline', () => {
        isOnline = false;
        $('offline-banner').classList.add('visible');
        $('status-dot').classList.add('offline');
        $('status-text').textContent = 'Offline';
      });
    }

    // ========================================
    // DRAG & DROP
    // ========================================
    function setupDragDrop() {
      const frame = $('camera-frame');

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
        frame.addEventListener(event, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      frame.addEventListener('dragenter', () => frame.classList.add('drag-over'));
      frame.addEventListener('dragleave', () => frame.classList.remove('drag-over'));
      frame.addEventListener('dragover', () => frame.classList.add('drag-over'));

      frame.addEventListener('drop', (e) => {
        frame.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect({ target: { files } });
        }
      });
    }

    // ========================================
    // HAPTIC FEEDBACK
    // ========================================
    function hapticFeedback(type = 'light') {
      // Visual feedback
      const flash = $('haptic-flash');
      flash.classList.add('active');
      setTimeout(() => flash.classList.remove('active'), 100);

      // Native haptic if available
      if ('vibrate' in navigator) {
        switch (type) {
          case 'light': navigator.vibrate(10); break;
          case 'medium': navigator.vibrate(20); break;
          case 'heavy': navigator.vibrate([30, 10, 30]); break;
          case 'success': navigator.vibrate([10, 50, 10, 50, 30]); break;
          case 'error': navigator.vibrate([50, 30, 50]); break;
        }
      }
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    function setupEventListeners() {
      // Camera capture
      $('capture-btn').onclick = () => {
        hapticFeedback();
        $('file-input').setAttribute('capture', 'environment');
        $('file-input').click();
      };

      // Gallery
      $('gallery-btn').onclick = () => {
        hapticFeedback();
        $('file-input').removeAttribute('capture');
        $('file-input').click();
      };

      // File selected
      $('file-input').onchange = handleFileSelect;

      // Retake
      $('retake-btn').onclick = () => {
        hapticFeedback();
        resetScanner();
      };

      // Business chips
      $$('.biz-chip').forEach(chip => {
        chip.onclick = () => {
          hapticFeedback();
          $$('.biz-chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
          selectedBusiness = chip.dataset.biz;
        };
      });

      // Amount formatting
      $('amount-input').onblur = () => {
        const val = parseFloat($('amount-input').value.replace(/[^0-9.-]/g, ''));
        if (!isNaN(val)) {
          $('amount-input').value = '$' + val.toFixed(2);
          findMatchingTransaction(val);
        }
      };

      // Submit
      $('submit-btn').onclick = () => {
        hapticFeedback('medium');
        submitReceipt();
      };

      // Success modal
      $('scan-another-btn').onclick = () => {
        hapticFeedback();
        resetScanner();
      };

      $('view-history-btn').onclick = () => {
        hapticFeedback();
        $('success-modal').classList.remove('visible');
        switchView('history');
      };

      // Navigation
      $$('.nav-item').forEach(item => {
        item.onclick = e => {
          e.preventDefault();
          hapticFeedback('light');
          switchView(item.dataset.view);
        };
      });

      // Voice capture
      setupVoiceCapture();
    }

    // ========================================
    // VOICE CAPTURE
    // ========================================
    function setupVoiceCapture() {
      let isRecording = false;
      let recognition = null;

      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
          isRecording = true;
          $('voice-btn').classList.add('recording');
          hapticFeedback('medium');
          showToast('Listening...', 'info');
        };

        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          $('notes-input').value = transcript;
          $('notes-input').classList.add('ai-filled');
        };

        recognition.onend = () => {
          isRecording = false;
          $('voice-btn').classList.remove('recording');
          if ($('notes-input').value) {
            hapticFeedback('success');
            showToast('Voice note added!', 'success');
          }
        };

        recognition.onerror = (event) => {
          isRecording = false;
          $('voice-btn').classList.remove('recording');
          hapticFeedback('error');
          if (event.error === 'not-allowed') {
            showToast('Microphone access denied', 'error');
          } else if (event.error !== 'no-speech') {
            showToast('Voice error: ' + event.error, 'error');
          }
        };
      }

      $('voice-btn').onclick = () => {
        if (!recognition) {
          showToast('Voice not supported', 'error');
          return;
        }
        hapticFeedback();
        if (isRecording) {
          recognition.stop();
        } else {
          recognition.start();
        }
      };
    }

    // ========================================
    // VIEW MANAGEMENT
    // ========================================
    function switchView(view) {
      $$('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view === view));

      $('camera-view').style.display = view === 'scan' ? 'block' : 'none';
      $('extraction-panel').style.display = (view === 'scan' && currentImage.data) ? 'block' : 'none';
      $('history-view').classList.toggle('visible', view === 'history');

      if (view === 'history') renderHistory();
    }

    // ========================================
    // FILE HANDLING
    // ========================================
    async function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      hapticFeedback('medium');

      const reader = new FileReader();
      reader.onload = async (ev) => {
        currentImage.data = ev.target.result;
        currentImage.blob = file;

        $('image-preview').src = currentImage.data;
        $('image-preview').style.display = 'block';
        $('camera-placeholder').style.display = 'none';
        $('camera-frame').classList.add('has-image');
        $('retake-btn').classList.add('visible');

        await processOCR();
      };
      reader.readAsDataURL(file);
    }

    // ========================================
    // OCR PROCESSING
    // ========================================
    async function processOCR() {
      showProcessing('Analyzing receipt...', 'Detecting text');

      try {
        const formData = new FormData();
        formData.append('file', currentImage.blob);

        updateProcessing('Analyzing receipt...', 'Running AI extraction');

        const response = await fetch(`${API_BASE}/ocr`, {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          console.log('OCR Result:', data);

          updateProcessing('Analyzing receipt...', 'Populating fields');

          // Fill form with AI highlighting
          if (data.merchant) {
            $('merchant-input').value = data.merchant;
            $('merchant-input').classList.add('ai-filled');
          }
          if (data.total) {
            const amt = parseFloat(data.total);
            $('amount-input').value = '$' + amt.toFixed(2);
            $('amount-input').classList.add('ai-filled');
            findMatchingTransaction(amt);
          }
          if (data.date) {
            $('date-input').value = formatDateForInput(data.date);
            $('date-input').classList.add('ai-filled');
          }
          if (data.category) {
            $('category-select').value = data.category;
          }

          // Calendar context note
          if (data.note) {
            $('notes-input').value = data.note;
            $('notes-input').classList.add('ai-filled');
            $('notes-label').innerHTML = 'Notes <span style="font-size:10px;background:var(--accent);color:#000;padding:2px 6px;border-radius:4px;margin-left:6px;">üìÖ Calendar</span>';
            showToast('Calendar context added!', 'success');
          }

          hapticFeedback('success');
        } else {
          showToast('Could not read receipt. Fill manually.', 'error');
          hapticFeedback('error');
        }
      } catch (err) {
        console.error('OCR error:', err);
        showToast('AI unavailable. Fill manually.', 'error');
        hapticFeedback('error');
      }

      hideProcessing();
      $('extraction-panel').classList.add('visible');
    }

    // ========================================
    // SMART MATCHING
    // ========================================
    async function findMatchingTransaction(amount) {
      if (!isOnline) return;

      try {
        const response = await fetch(`${API_BASE}/csv`);
        if (!response.ok) return;

        const transactions = await response.json();
        const merchant = $('merchant-input').value.toLowerCase();

        const matches = transactions.filter(t => {
          const txAmt = Math.abs(parseFloat(t['Chase Amount'] || 0));
          const amtMatch = Math.abs(txAmt - amount) < 0.01;
          const hasReceipt = t['Receipt File'] && t['Receipt File'].trim();
          return amtMatch && !hasReceipt;
        });

        if (matches.length > 0) {
          matchedTransaction = matches[0];
          $('match-section').style.display = 'block';
          $('match-merchant').textContent = matchedTransaction['Chase Description'] || 'Unknown';
          $('match-meta').textContent = matchedTransaction['Chase Date'] || '';
          $('match-amount').textContent = '$' + Math.abs(parseFloat(matchedTransaction['Chase Amount'])).toFixed(2);
          hapticFeedback('light');
        } else {
          $('match-section').style.display = 'none';
          matchedTransaction = null;
        }
      } catch (err) {
        console.error('Match error:', err);
      }
    }

    // ========================================
    // SUBMISSION
    // ========================================
    async function submitReceipt() {
      const merchant = $('merchant-input').value.trim();
      const amount = parseFloat($('amount-input').value.replace(/[^0-9.-]/g, ''));

      if (!currentImage.blob) {
        showToast('Capture a receipt first', 'error');
        hapticFeedback('error');
        return;
      }

      if (!merchant) {
        showToast('Enter merchant name', 'error');
        hapticFeedback('error');
        $('merchant-input').focus();
        return;
      }

      if (isNaN(amount) || amount <= 0) {
        showToast('Enter a valid amount', 'error');
        hapticFeedback('error');
        $('amount-input').focus();
        return;
      }

      showProcessing('Saving receipt...', 'Uploading image');

      const receiptData = {
        merchant,
        amount,
        date: $('date-input').value,
        category: $('category-select').value || '',
        business: selectedBusiness,
        notes: $('notes-input').value || '',
        thumbnail: currentImage.data,
        timestamp: new Date().toISOString(),
        synced: false
      };

      try {
        if (isOnline) {
          const formData = new FormData();
          formData.append('file', currentImage.blob, `receipt_${Date.now()}.jpg`);
          formData.append('merchant', merchant);
          formData.append('amount', amount.toFixed(2));
          formData.append('date', $('date-input').value);
          formData.append('category', $('category-select').value || '');
          formData.append('business', selectedBusiness);
          formData.append('notes', $('notes-input').value || '');
          formData.append('source', SOURCE_TAG);

          updateProcessing('Saving receipt...', 'Processing data');

          const response = await fetch(`${API_BASE}/mobile-upload`, {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            receiptData.synced = true;
            receiptData.serverId = result.id;
          }
        }
      } catch (err) {
        console.error('Upload error:', err);
        receiptData.pendingData = {
          imageData: currentImage.data,
          category: $('category-select').value,
          notes: $('notes-input').value
        };
      }

      // Save to IndexedDB
      const id = await saveToIndexedDB(receiptData);
      receiptData.id = id;
      history.unshift(receiptData);

      hideProcessing();

      // Update pending badge
      updatePendingBadge();

      // Success feedback
      hapticFeedback('success');
      $('success-message').textContent = receiptData.synced
        ? (matchedTransaction ? `Matched to "${matchedTransaction['Chase Description']}"` : 'Receipt saved and synced!')
        : 'Saved offline. Will sync when connected.';
      $('success-modal').classList.add('visible');

      // Request background sync
      if ('serviceWorker' in navigator && 'sync' in window.registration) {
        navigator.serviceWorker.ready.then(reg => {
          reg.sync.register('receipt-upload');
        });
      }
    }

    // ========================================
    // SYNC PENDING UPLOADS
    // ========================================
    async function syncPendingUploads() {
      if (!isOnline) return;

      $('status-dot').classList.add('syncing');
      $('status-text').textContent = 'Syncing...';

      const pending = history.filter(h => !h.synced && h.pendingData);
      let synced = 0;

      for (const item of pending) {
        try {
          const response = await fetch(item.pendingData.imageData);
          const blob = await response.blob();

          const formData = new FormData();
          formData.append('file', blob, `receipt_${item.id}.jpg`);
          formData.append('merchant', item.merchant);
          formData.append('amount', item.amount.toFixed(2));
          formData.append('date', item.date);
          formData.append('category', item.pendingData.category || '');
          formData.append('business', item.business || '');
          formData.append('notes', item.pendingData.notes || '');
          formData.append('source', SOURCE_TAG);

          const uploadResponse = await fetch(`${API_BASE}/mobile-upload`, {
            method: 'POST',
            body: formData
          });

          if (uploadResponse.ok) {
            item.synced = true;
            delete item.pendingData;
            await updateReceiptSync(item.id, true);
            synced++;
          }
        } catch (err) {
          console.error('Sync error:', err);
        }
      }

      $('status-dot').classList.remove('syncing');
      $('status-text').textContent = 'Connected';

      if (synced > 0) {
        showToast(`Synced ${synced} receipt${synced > 1 ? 's' : ''}`, 'success');
        hapticFeedback('success');
      }

      updatePendingBadge();
      renderHistory();
    }

    function updatePendingBadge() {
      const pending = history.filter(h => !h.synced).length;
      const badge = $('pending-badge');
      if (pending > 0) {
        badge.textContent = pending;
        badge.classList.add('visible');
      } else {
        badge.classList.remove('visible');
      }
    }

    // ========================================
    // HISTORY
    // ========================================
    function renderHistory() {
      const todayItems = history.filter(h => {
        const d = new Date(h.timestamp);
        const today = new Date();
        return d.toDateString() === today.toDateString();
      });

      const todayTotal = todayItems.reduce((sum, h) => sum + (h.amount || 0), 0);

      $('stat-count').textContent = todayItems.length;
      $('stat-total').textContent = '$' + todayTotal.toFixed(0);

      if (history.length === 0) {
        $('history-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
            </div>
            <h3>No receipts yet</h3>
            <p>Scanned receipts will appear here</p>
          </div>
        `;
        return;
      }

      $('history-list').innerHTML = history.slice(0, 30).map(item => `
        <div class="history-item">
          <img class="history-thumb" src="${item.thumbnail}" alt="" loading="lazy">
          <div class="history-content">
            <div class="history-row">
              <span class="history-merchant">${item.merchant}</span>
              <span class="history-amount">$${parseFloat(item.amount).toFixed(2)}</span>
            </div>
            <div class="history-meta">
              <span>${formatRelativeDate(item.timestamp)}</span>
              ${item.business ? `<span>${item.business}</span>` : ''}
              <span class="history-status ${item.synced ? '' : 'pending'}">${item.synced ? 'Synced' : 'Pending'}</span>
            </div>
          </div>
        </div>
      `).join('');

      updatePendingBadge();
    }

    // ========================================
    // UTILITIES
    // ========================================
    function formatDateForInput(dateStr) {
      const date = new Date(dateStr);
      return !isNaN(date.getTime()) ? date.toISOString().split('T')[0] : $('date-input').value;
    }

    function formatRelativeDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function showProcessing(text, step) {
      $('processing-text').textContent = text;
      $('processing-step').textContent = step;
      $('processing-overlay').classList.add('visible');
    }

    function updateProcessing(text, step) {
      $('processing-text').textContent = text;
      $('processing-step').textContent = step;
    }

    function hideProcessing() {
      $('processing-overlay').classList.remove('visible');
    }

    function showToast(message, type = 'success') {
      const toast = $('toast');
      $('toast-text').textContent = message;
      toast.className = 'toast ' + type;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 3000);
    }

    function resetScanner() {
      currentImage = { data: null, blob: null };
      matchedTransaction = null;
      selectedBusiness = '';

      $('image-preview').style.display = 'none';
      $('camera-placeholder').style.display = 'flex';
      $('camera-frame').classList.remove('has-image');
      $('extraction-panel').classList.remove('visible');
      $('success-modal').classList.remove('visible');
      $('match-section').style.display = 'none';
      $('retake-btn').classList.remove('visible');

      // Reset form
      $('merchant-input').value = '';
      $('merchant-input').classList.remove('ai-filled');
      $('amount-input').value = '';
      $('amount-input').classList.remove('ai-filled');
      $('date-input').value = new Date().toISOString().split('T')[0];
      $('date-input').classList.remove('ai-filled');
      $('category-select').value = '';
      $('notes-input').value = '';
      $('notes-input').classList.remove('ai-filled');
      $('notes-label').innerHTML = 'Notes';
      $$('.biz-chip').forEach(c => c.classList.remove('selected'));
      $('file-input').value = '';
    }

    async function checkConnection() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        if (response.ok) {
          isOnline = true;
          $('status-text').textContent = 'Connected';
          $('status-dot').classList.remove('offline');
          syncPendingUploads();
        } else {
          isOnline = false;
          $('status-text').textContent = 'Offline';
          $('status-dot').classList.add('offline');
        }
      } catch {
        isOnline = false;
        $('status-text').textContent = 'Offline';
        $('status-dot').classList.add('offline');
      }
    }
  </script>
</body>
</html>
