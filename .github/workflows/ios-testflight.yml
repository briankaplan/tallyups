name: iOS TestFlight Deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.1)'
        required: false
        default: '1.0.0'

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Install API Key
        env:
          API_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$API_KEY" > ~/private_keys/AuthKey_${API_KEY_ID}.p8

      - name: Build and Upload
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          cd ios

          # Build archive with automatic signing
          xcodebuild archive \
            -project TallyScanner.xcodeproj \
            -scheme TallyScanner \
            -archivePath build/TallyScanner.xcarchive \
            -destination "generic/platform=iOS" \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            -authenticationKeyID $API_KEY_ID \
            -authenticationKeyIssuerID $API_ISSUER_ID \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=R2LSUCXR5J

          # Export IPA
          xcodebuild -exportArchive \
            -archivePath build/TallyScanner.xcarchive \
            -exportPath build \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            -authenticationKeyID $API_KEY_ID \
            -authenticationKeyIssuerID $API_ISSUER_ID

          # Upload to TestFlight
          xcrun altool --upload-app \
            -f build/TallyScanner.ipa \
            -t ios \
            --apiKey $API_KEY_ID \
            --apiIssuer $API_ISSUER_ID

      - name: Done
        run: |
          echo "âœ… Build uploaded to TestFlight!"
          echo "Check App Store Connect in ~15 minutes"
