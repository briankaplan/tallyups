# iOS TestFlight Deployment Workflow
name: iOS TestFlight Deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'App version (e.g., 1.0.1)'
        required: false
        default: '1.0.0'
        type: string

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Install App Store Connect API Key
        env:
          API_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p "$HOME/private_keys"
          echo "$API_KEY" > "$HOME/private_keys/AuthKey_${API_KEY_ID}.p8"
          chmod 600 "$HOME/private_keys/AuthKey_${API_KEY_ID}.p8"
          echo "API Key installed: AuthKey_${API_KEY_ID}.p8"

      - name: Import Code Signing Certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.P12_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.P12_PASSWORD }}

      - name: Import Provisioning Profile
        uses: apple-actions/import-provisioning-profile@v1
        with:
          provisioning-profile-base64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}

      - name: Generate App Icon
        run: |
          cd ios/TallyScanner/Resources/Assets.xcassets/AppIcon.appiconset
          python3 -c "
          import struct, zlib
          def create_png(w, h, c):
              def chunk(t, d):
                  x = t + d
                  return struct.pack('>I', len(d)) + x + struct.pack('>I', zlib.crc32(x) & 0xffffffff)
              ihdr = struct.pack('>IIBBBBB', w, h, 8, 2, 0, 0, 0)
              raw = b''.join(b'\\x00' + bytes(c) * w for _ in range(h))
              return b'\\x89PNG\\r\\n\\x1a\\n' + chunk(b'IHDR', ihdr) + chunk(b'IDAT', zlib.compress(raw, 9)) + chunk(b'IEND', b'')
          open('AppIcon.png', 'wb').write(create_png(1024, 1024, (13, 17, 23)))
          print('Created AppIcon.png')
          "
          ls -la AppIcon.png

      - name: Build Archive
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          cd ios
          KEY_PATH="$HOME/private_keys/AuthKey_${API_KEY_ID}.p8"

          xcodebuild archive \
            -project TallyScanner.xcodeproj \
            -scheme TallyScanner \
            -archivePath build/TallyScanner.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM=R2LSUCXR5J \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_NAME }}"

      - name: Export IPA
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          cd ios
          KEY_PATH="$HOME/private_keys/AuthKey_${API_KEY_ID}.p8"

          xcodebuild -exportArchive \
            -archivePath build/TallyScanner.xcarchive \
            -exportPath build \
            -exportOptionsPlist ExportOptions.plist \
            -authenticationKeyPath "$KEY_PATH" \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$API_ISSUER_ID"

      - name: Upload to TestFlight
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          xcrun altool --upload-app \
            -f ios/build/TallyScanner.ipa \
            -t ios \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$API_ISSUER_ID"

      - name: Done
        run: |
          echo "Build uploaded to TestFlight!"
          echo "Check App Store Connect in ~15 minutes"
