name: iOS TestFlight Deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'App version (e.g., 1.0.1)'
        required: false
        default: '1.0.0'
        type: string

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Install API Key
        env:
          API_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p "$HOME/private_keys"
          echo "$API_KEY" > "$HOME/private_keys/AuthKey_${API_KEY_ID}.p8"
          chmod 600 "$HOME/private_keys/AuthKey_${API_KEY_ID}.p8"
          echo "API Key installed: AuthKey_${API_KEY_ID}.p8"

      - name: Generate App Icon
        run: |
          cd ios/TallyScanner/Resources/Assets.xcassets/AppIcon.appiconset
          # Create a simple 1024x1024 green icon using sips (built into macOS)
          # First create a base PNG with ImageMagick if available, else use Python
          if command -v convert &> /dev/null; then
            convert -size 1024x1024 xc:'#0D1117' \
              -fill '#00FF88' -draw "roundrectangle 200,150 824,874 50,50" \
              -fill '#0D1117' -draw "rectangle 280,300 744,380" \
              -fill '#0D1117' -draw "rectangle 280,450 650,530" \
              -fill '#0D1117' -draw "rectangle 280,600 700,680" \
              AppIcon.png
          else
            # Fallback: use Python to create a simple icon
            python3 << 'PYEOF'
import struct
import zlib

def create_png(width, height, color):
    def chunk(chunk_type, data):
        c = chunk_type + data
        return struct.pack('>I', len(data)) + c + struct.pack('>I', zlib.crc32(c) & 0xffffffff)

    # IHDR
    ihdr = struct.pack('>IIBBBBB', width, height, 8, 2, 0, 0, 0)

    # IDAT - simple solid color
    raw_data = b''
    for y in range(height):
        raw_data += b'\x00'  # filter byte
        for x in range(width):
            raw_data += bytes(color)

    compressed = zlib.compress(raw_data, 9)

    png = b'\x89PNG\r\n\x1a\n'
    png += chunk(b'IHDR', ihdr)
    png += chunk(b'IDAT', compressed)
    png += chunk(b'IEND', b'')

    return png

# Dark background with receipt-like appearance
# Using a gradient approximation - just solid dark for now
icon = create_png(1024, 1024, (13, 17, 23))  # #0D1117
with open('AppIcon.png', 'wb') as f:
    f.write(icon)
print('Created AppIcon.png')
PYEOF
          fi
          ls -la AppIcon.png

      - name: Build and Upload
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          cd ios

          KEY_PATH="$HOME/private_keys/AuthKey_${API_KEY_ID}.p8"
          echo "Using key: $KEY_PATH"

          # Build archive with automatic signing
          xcodebuild archive \
            -project TallyScanner.xcodeproj \
            -scheme TallyScanner \
            -archivePath build/TallyScanner.xcarchive \
            -destination "generic/platform=iOS" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$KEY_PATH" \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$API_ISSUER_ID" \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=R2LSUCXR5J

          # Export IPA
          xcodebuild -exportArchive \
            -archivePath build/TallyScanner.xcarchive \
            -exportPath build \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$KEY_PATH" \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$API_ISSUER_ID"

          # Upload to TestFlight
          xcrun altool --upload-app \
            -f build/TallyScanner.ipa \
            -t ios \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$API_ISSUER_ID"

      - name: Done
        run: |
          echo "Build uploaded to TestFlight!"
          echo "Check App Store Connect in ~15 minutes"
