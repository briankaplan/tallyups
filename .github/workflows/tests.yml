name: ReceiptAI Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: "3.11"

jobs:
  # =============================================================================
  # UNIT TESTS
  # =============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov pytest-timeout
          pip install Pillow  # For image tests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f tests/requirements-test.txt ]; then pip install -r tests/requirements-test.txt; fi

      - name: Run unit tests
        run: |
          pytest tests/test_unit_*.py \
            -v \
            --tb=short \
            -m "unit" \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --timeout=60 \
            --ignore=tests/test_e2e.py \
            --ignore=tests/test_performance.py

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unit-tests
          name: unit-coverage

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-unit
          path: htmlcov/
          retention-days: 7

  # =============================================================================
  # INTEGRATION TESTS
  # Note: These tests may fail in CI without proper database/environment setup
  # They are non-blocking to allow unit tests to pass the build
  # =============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    continue-on-error: true  # Don't fail the build on integration test failures

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-cov pytest-timeout
          pip install Pillow
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run integration tests
        run: |
          pytest tests/test_integration.py \
            -v \
            --tb=short \
            -m "integration" \
            --cov=. \
            --cov-report=xml \
            --timeout=120

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: integration-tests
          name: integration-coverage

  # =============================================================================
  # DATA QUALITY TESTS
  # Note: These tests verify classifier accuracy which depends on configuration
  # They are non-blocking as accuracy may vary without merchant rules
  # =============================================================================
  data-quality-tests:
    name: Data Quality Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    continue-on-error: true  # Don't fail the build on data quality test failures

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-timeout
          pip install Pillow
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run data quality tests
        run: |
          pytest tests/test_data_quality.py \
            -v \
            --tb=short \
            -m "data_quality" \
            --timeout=120

  # =============================================================================
  # PERFORMANCE TESTS (Optional, on demand)
  # =============================================================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[perf]')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-timeout pytest-benchmark
          pip install Pillow
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run performance tests
        run: |
          pytest tests/test_performance.py \
            -v \
            --tb=short \
            -m "performance" \
            --timeout=600

  # =============================================================================
  # E2E TESTS (Optional, on demand)
  # =============================================================================
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[e2e]')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-timeout
          pip install Pillow
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run E2E tests
        run: |
          pytest tests/test_e2e.py \
            -v \
            --tb=short \
            -m "e2e" \
            --timeout=300

  # =============================================================================
  # ALL TESTS SUMMARY
  # =============================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, data-quality-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          # Unit tests are required to pass
          if [ "${{ needs.unit-tests.result }}" == "failure" ]; then
            echo "❌ Unit tests failed!"
            exit 1
          fi
          echo "✅ Unit tests passed!"

          # Integration and data quality tests are informational only
          if [ "${{ needs.integration-tests.result }}" == "failure" ]; then
            echo "⚠️ Integration tests failed (non-blocking - may need database setup)"
          else
            echo "✅ Integration tests passed!"
          fi

          if [ "${{ needs.data-quality-tests.result }}" == "failure" ]; then
            echo "⚠️ Data quality tests failed (non-blocking - may need configuration)"
          else
            echo "✅ Data quality tests passed!"
          fi

          echo ""
          echo "✅ All required tests passed!"

  # =============================================================================
  # LINT AND TYPE CHECK
  # =============================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy

      - name: Run flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

      - name: Check formatting with black
        run: |
          black --check --diff . || true

      - name: Check import sorting
        run: |
          isort --check-only --diff . || true

  # =============================================================================
  # SECURITY SCAN
  # =============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run bandit security scan
        run: |
          bandit -r . -ll --skip B101 || true

      - name: Check for known vulnerabilities
        run: |
          safety check || true
