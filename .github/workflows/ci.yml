name: CI/CD Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # =============================================================================
  # UNIT TESTS - Required to pass
  # =============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-timeout Pillow
          pip install -r requirements.txt 2>/dev/null || true
          pip install -r tests/requirements-test.txt 2>/dev/null || true

      - name: Run unit tests
        run: |
          pytest tests/test_unit_*.py -v --tb=short -m "unit" --timeout=60 || pytest tests/test_unit_*.py -v --tb=short --timeout=60
        env:
          RAILWAY_ENVIRONMENT: test
          DB_READ_ONLY: true

  # =============================================================================
  # CODE COVERAGE - Optional
  # =============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: unit-tests
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov Pillow
          pip install -r requirements.txt 2>/dev/null || true

      - name: Run tests with coverage
        run: pytest tests/test_unit_*.py --cov=. --cov-report=xml --cov-fail-under=5 || true
        env:
          RAILWAY_ENVIRONMENT: test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # =============================================================================
  # DEPLOY TO PRODUCTION - On push to main
  # =============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: production
      url: https://tallyups.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Deploy to Production
        run: |
          railway link -p f6f866e5-94f7-4ced-9bc7-a33197ca8411 -e production
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}

      - name: Wait and Health Check
        run: |
          sleep 45
          for i in 1 2 3 4 5; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://tallyups.com/health)
            if [ "$response" = "200" ]; then
              echo "âœ… Production deployment healthy!"
              exit 0
            fi
            echo "Waiting... attempt $i"
            sleep 10
          done
          exit 1

  # =============================================================================
  # DEPLOY TO DEV - On push to dev
  # =============================================================================
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'

    environment:
      name: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Deploy
        run: |
          railway link --environment development
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
