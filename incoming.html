<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="AI-powered receipt management - Incoming receipts processing">
<meta name="theme-color" content="#0b0d10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Incoming Receipts - Tallyups</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßæ</text></svg>">
<style>
/* Tallyups Theme - Black & Green */
:root {
  --bg:#000000; --panel:#111111; --panel2:#0a0a0a; --edge:#222;
  --ink:#f0f0f0; --muted:#888; --brand:#00ff88;
  --ok:#00ff88; --bad:#ff4e6a; --warn:#ffd85e;
  --glow:rgba(0,255,136,.35);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%; background: var(--bg); color: var(--ink);
  font: 13px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Helvetica, Arial;
}

/* Header */
header {
  display: flex; align-items: center; justify-content: space-between; gap: 16px;
  padding: 12px 20px;
  background: linear-gradient(180deg, #0e141a, #0a0f15);
  border-bottom: 1px solid var(--edge);
  box-shadow: 0 2px 12px rgba(0,0,0,.5);
}

.brand { display: flex; align-items: center; gap: 12px; }
.brand h1 {
  margin: 0; font-size: 16px; font-weight: 800;
  background: linear-gradient(135deg, #00ff88, #00cc6a);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.version {
  padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700;
  background: rgba(0,255,136,.15); color: var(--brand);
}

/* Navigation */
.nav-buttons {
  display: flex; gap: 8px; margin-left: auto;
}
.nav-btn {
  padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 13px;
  background: rgba(0,255,136,.1); color: var(--muted);
  border: 1px solid transparent; transition: all .15s;
}
.nav-btn:hover {
  background: rgba(0,255,136,.2); color: var(--ink);
}
.nav-btn.active {
  background: rgba(0,255,136,.2); color: var(--brand);
  border-color: rgba(0,255,136,.3);
}

.controls { display: flex; align-items: center; gap: 10px; }

/* Buttons */
button {
  cursor: pointer; border: none; border-radius: 10px; padding: 8px 14px;
  background: #121a25; transition: all .15s ease; font-size: 13px; font-weight: 500;
  color: var(--ink);
}
button:hover { opacity: .9; transform: translateY(-1px); }
button:active { transform: translateY(0); }

.btn-primary {
  background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,255,136,.3);
}
.btn-success {
  background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,255,136,.3);
}
.btn-danger {
  background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff;
}
.btn-ghost {
  background: rgba(0,255,136,.1); color: var(--brand);
}
.btn-sm { padding: 6px 12px; font-size: 12px; }

/* Dashboard Stats */
.dashboard {
  padding: 16px 20px; background: var(--panel);
  border-bottom: 1px solid var(--edge);
  display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;
}
.stat {
  background: linear-gradient(135deg, rgba(59,130,246,.08), rgba(139,92,246,.08));
  padding: 12px 16px; border-radius: 12px;
  border: 1px solid rgba(59,130,246,.15);
}
.stat-label {
  font-size: 11px; color: var(--muted); text-transform: uppercase;
  letter-spacing: .5px; font-weight: 600;
}
.stat-value {
  font-size: 22px; font-weight: 800; margin: 4px 0; color: var(--ink);
}

/* Filters */
.filters {
  padding: 14px 20px; background: var(--panel);
  border-bottom: 1px solid var(--edge);
  display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
}
.chip {
  padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all .15s; display: flex; align-items: center; gap: 8px;
  background: var(--panel2); border: 1px solid var(--edge); color: var(--muted);
}
.chip:hover { background: rgba(59,130,246,.1); }
.chip.active {
  background: rgba(59,130,246,.2); border-color: var(--brand); color: var(--brand);
}
.chip-icon { font-size: 14px; }
.chip-count {
  padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,.08); min-width: 20px; text-align: center;
}
.chip.active .chip-count { background: rgba(59,130,246,.3); }
.chip[data-filter="pending"] .chip-count { background: rgba(59,130,246,.2); color: var(--brand); }
.chip[data-filter="accepted"] .chip-count { background: rgba(47,255,162,.15); color: var(--ok); }
.chip[data-filter="rejected"] .chip-count { background: rgba(255,78,106,.1); color: var(--bad); }

/* Content */
.content {
  flex: 1; overflow-y: auto; padding: 20px;
}

/* Table */
table {
  width: 100%; border-collapse: separate; border-spacing: 0;
  background: var(--panel); border-radius: 12px; overflow: hidden;
}
thead {
  background: linear-gradient(135deg, rgba(59,130,246,.08), rgba(139,92,246,.08));
  border-bottom: 1px solid var(--edge);
}
th {
  padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600;
  color: var(--muted); text-transform: uppercase; letter-spacing: .5px;
}
td {
  padding: 14px 16px; border-bottom: 1px solid var(--edge);
  font-size: 13px;
}
tr:last-child td { border-bottom: none; }
tr:hover { background: rgba(59,130,246,.03); }
tr.hidden { display: none; }

/* Badges */
.confidence-badge {
  padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;
  display: inline-block;
}
.confidence-high { background: rgba(47,255,162,.15); color: var(--ok); }
.confidence-medium { background: rgba(255,216,94,.15); color: var(--warn); }
.confidence-low { background: rgba(255,78,106,.15); color: var(--bad); }

.match-badge {
  font-size: 11px; color: var(--warn); margin-top: 4px;
  display: inline-block;
}

.description {
  font-size: 12px; color: var(--muted); margin-top: 4px;
  font-style: italic;
}

.snippet {
  font-size: 12px; color: var(--muted); margin-top: 2px;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  max-width: 300px;
}

/* Empty state */
.empty-state {
  text-align: center; padding: 60px 20px;
  color: var(--muted);
}
.empty-state h3 {
  font-size: 18px; margin-bottom: 8px; color: var(--ink);
}

/* Loading */
.loading {
  text-align: center; padding: 40px; color: var(--muted);
}

/* Toast */
.toast {
  position: fixed; bottom: 20px; right: 20px;
  padding: 12px 20px; border-radius: 10px;
  background: var(--panel); border: 1px solid var(--edge);
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
  opacity: 0; transform: translateY(20px);
  transition: all .3s; pointer-events: none;
  z-index: 1000;
}
.toast.show {
  opacity: 1; transform: translateY(0); pointer-events: auto;
}
.toast.success { border-left: 3px solid var(--ok); }
.toast.error { border-left: 3px solid var(--bad); }
.toast.info { border-left: 3px solid var(--brand); }

/* Spinner animation */
.spinner {
  width: 12px; height: 12px; border: 2px solid var(--edge);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  display: inline-block;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Success row highlight animation */
.row-success {
  animation: successFade 2s ease-out;
}
@keyframes successFade {
  0% { background-color: rgba(47,255,162,.2); }
  100% { background-color: transparent; }
}

/* Clickable rows */
tr.clickable { cursor: pointer; }
tr.clickable:hover { background: rgba(59,130,246,.06); }

/* Sender info */
.sender-info {
  display: flex; flex-direction: column; gap: 2px;
}
.sender-name {
  font-weight: 600; color: var(--ink); font-size: 13px;
}
.sender-email {
  font-size: 11px; color: var(--muted);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  max-width: 180px;
}

/* Attachment badge */
.attachment-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 6px; border-radius: 4px; font-size: 10px;
  background: rgba(139,92,246,.15); color: #a78bfa;
  margin-top: 4px;
}

/* Preview eye icon */
.preview-btn {
  width: 32px; height: 32px; border-radius: 6px;
  background: rgba(59,130,246,.1); color: var(--brand);
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 14px; cursor: pointer; border: none;
  transition: all .15s;
}
.preview-btn:hover {
  background: rgba(59,130,246,.2); transform: scale(1.05);
}

/* Preview Modal */
.preview-modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.9);
  display: none; z-index: 2000;
  padding: 20px;
  overflow-y: auto;
}
.preview-modal.active { display: flex; align-items: flex-start; justify-content: center; }

.preview-content {
  background: var(--panel);
  border-radius: 16px;
  max-width: 700px;
  width: 100%;
  margin: 40px auto;
  box-shadow: 0 24px 48px rgba(0,0,0,.5);
  animation: slideUp 0.2s ease;
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.preview-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--edge);
  display: flex; justify-content: space-between; align-items: flex-start;
}
.preview-title {
  font-size: 18px; font-weight: 700; color: var(--ink);
  line-height: 1.4;
  flex: 1;
}
.preview-close {
  width: 36px; height: 36px; border-radius: 8px;
  background: rgba(239,68,68,.1); color: var(--bad);
  font-size: 20px; cursor: pointer; border: none;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-left: 16px;
}

.preview-body { padding: 24px; }

.preview-meta {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;
  margin-bottom: 20px;
}
.preview-meta-item {
  background: var(--panel2);
  padding: 12px 16px;
  border-radius: 10px;
  border: 1px solid var(--edge);
}
.preview-meta-label {
  font-size: 10px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.preview-meta-value {
  font-size: 14px; font-weight: 600; color: var(--ink);
  word-break: break-word;
}
.preview-meta-value.large {
  font-size: 24px;
}
.preview-meta-value.amount-charge { color: var(--bad); }
.preview-meta-value.amount-refund { color: var(--ok); }

.preview-section {
  margin-bottom: 20px;
}
.preview-section-title {
  font-size: 11px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.5px;
  margin-bottom: 8px; font-weight: 600;
}
.preview-section-content {
  background: var(--panel2);
  padding: 16px;
  border-radius: 10px;
  border: 1px solid var(--edge);
  font-size: 13px;
  line-height: 1.6;
  color: var(--ink);
  white-space: pre-wrap;
  max-height: 300px;
  overflow-y: auto;
}

.preview-attachments {
  display: flex; gap: 8px; flex-wrap: wrap;
}
.preview-attachment {
  display: flex; align-items: center; gap: 8px;
  background: rgba(139,92,246,.1);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  color: #a78bfa;
}
.preview-attachment-icon { font-size: 16px; }

.preview-footer {
  padding: 16px 24px;
  border-top: 1px solid var(--edge);
  display: flex; justify-content: space-between; align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.preview-actions {
  display: flex; gap: 10px;
}

/* Account badge */
.account-badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
}
.account-badge.personal { background: rgba(59,130,246,.15); color: #60a5fa; }
.account-badge.mcr { background: rgba(239,68,68,.15); color: #f87171; }
.account-badge.downhome { background: rgba(34,197,94,.15); color: #4ade80; }
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="brand">
    <h1>üßæ Tallyups</h1>
    <span class="version">v2.0</span>
  </div>
  <div class="nav-buttons">
    <button class="nav-btn" onclick="window.location.href='/'">üè† Home</button>
    <button class="nav-btn active">üì¨ Incoming</button>
    <button class="nav-btn" onclick="window.location.href='/scanner'">üì∑ Scan</button>
    <button class="nav-btn" onclick="window.location.href='/?page=reports'">üìä Reports</button>
    <button class="nav-btn" onclick="window.location.href='/?page=stats'">üìà Stats</button>
  </div>
  <div class="controls">
    <button class="btn-ghost btn-sm" onclick="clearFiltered()">üóëÔ∏è Clear Rejected</button>
    <button class="btn-ghost btn-sm" onclick="reprocessMissing()" title="Re-download receipts for accepted items that have no files">üîß Fix Missing</button>
    <button class="btn-ghost btn-sm" onclick="fixDates()" title="Fix wrong dates on transactions from incoming receipts">üìÖ Fix Dates</button>
    <button class="btn-primary" onclick="scanForNew()">üîÑ Scan Now</button>
  </div>
</header>

<!-- Stats Dashboard -->
<div class="dashboard">
  <div class="stat">
    <div class="stat-label">Pending</div>
    <div class="stat-value" id="stat-pending">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Accepted</div>
    <div class="stat-value" id="stat-accepted">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Rejected</div>
    <div class="stat-value" id="stat-rejected">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Total</div>
    <div class="stat-value" id="stat-total">0</div>
  </div>
</div>

<!-- Filters -->
<div class="filters">
  <div class="chip" onclick="filterStatus('pending')" data-filter="pending">
    <span class="chip-icon">üì•</span> Inbox
    <span class="chip-count" id="chip-pending">0</span>
  </div>
  <div class="chip" onclick="filterStatus('accepted')" data-filter="accepted">
    <span class="chip-icon">üìÅ</span> Archive
    <span class="chip-count" id="chip-accepted">0</span>
  </div>
  <div class="chip" onclick="filterStatus('rejected')" data-filter="rejected">
    <span class="chip-icon">üóëÔ∏è</span> Dismissed
    <span class="chip-count" id="chip-rejected">0</span>
  </div>
  <div class="chip" onclick="filterStatus('all')" data-filter="all">
    <span class="chip-icon">üìã</span> All
  </div>
</div>

<!-- Content -->
<div class="content" id="content">
  <div class="loading">Loading receipts...</div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Preview Modal -->
<div id="preview-modal" class="preview-modal" onclick="if(event.target===this)closePreview()">
  <div class="preview-content">
    <div class="preview-header">
      <div class="preview-title" id="preview-subject">Email Subject</div>
      <button class="preview-close" onclick="closePreview()">‚úï</button>
    </div>
    <div class="preview-body">
      <div class="preview-meta">
        <div class="preview-meta-item">
          <div class="preview-meta-label">From</div>
          <div class="preview-meta-value" id="preview-from">sender@email.com</div>
        </div>
        <div class="preview-meta-item">
          <div class="preview-meta-label">Amount</div>
          <div class="preview-meta-value large" id="preview-amount">$0.00</div>
        </div>
        <div class="preview-meta-item">
          <div class="preview-meta-label">Merchant</div>
          <div class="preview-meta-value" id="preview-merchant">Unknown</div>
        </div>
        <div class="preview-meta-item">
          <div class="preview-meta-label">Date</div>
          <div class="preview-meta-value" id="preview-date">Jan 1, 2025</div>
        </div>
      </div>
      <div class="preview-section" id="preview-ai-section" style="display:none">
        <div class="preview-section-title">AI Analysis</div>
        <div class="preview-section-content" id="preview-ai-notes"></div>
      </div>
      <div class="preview-section">
        <div class="preview-section-title">Email Body Preview</div>
        <div class="preview-section-content" id="preview-body">Loading...</div>
      </div>
      <div class="preview-section" id="preview-attachments-section" style="display:none">
        <div class="preview-section-title">Attachments</div>
        <div class="preview-attachments" id="preview-attachments"></div>
      </div>
    </div>
    <div class="preview-footer">
      <div id="preview-account-badge"></div>
      <div class="preview-actions" id="preview-actions"></div>
    </div>
  </div>
</div>

<script>
let allReceipts = [];
let currentFilter = 'pending';  // Default to inbox

// Load receipts on page load
document.addEventListener('DOMContentLoaded', () => {
  // Set pending as active by default
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  document.querySelector('.chip[data-filter="pending"]')?.classList.add('active');
  loadReceipts();
});

async function loadReceipts() {
  try {
    const response = await fetch('/api/incoming/receipts?status=all&limit=500');
    const data = await response.json();

    if (data.ok) {
      allReceipts = data.receipts;
      updateStats(data.counts);
      renderTable();
    } else {
      showToast(data.error || 'Failed to load receipts', 'error');
    }
  } catch (e) {
    console.error('Load error:', e);
    showToast('Error loading receipts', 'error');
  }
}

function updateStats(counts) {
  // Update dashboard stats
  document.getElementById('stat-pending').textContent = counts.pending || 0;
  document.getElementById('stat-accepted').textContent = counts.accepted || 0;
  document.getElementById('stat-rejected').textContent = counts.rejected || 0;
  document.getElementById('stat-total').textContent = allReceipts.length || 0;

  // Update chip counts
  const chipPending = document.getElementById('chip-pending');
  const chipAccepted = document.getElementById('chip-accepted');
  const chipRejected = document.getElementById('chip-rejected');
  if (chipPending) chipPending.textContent = counts.pending || 0;
  if (chipAccepted) chipAccepted.textContent = counts.accepted || 0;
  if (chipRejected) chipRejected.textContent = counts.rejected || 0;
}

function renderTable() {
  const content = document.getElementById('content');

  if (allReceipts.length === 0) {
    content.innerHTML = `
      <div class="empty-state">
        <h3>No receipts found</h3>
        <p>Click "Scan Now" to search for new receipts in your Gmail accounts.</p>
      </div>
    `;
    return;
  }

  const tableHTML = `
    <table>
      <thead>
        <tr>
          <th style="width: 35%">Subject & Details</th>
          <th style="width: 15%">Merchant</th>
          <th style="width: 10%">Amount</th>
          <th style="width: 12%">From</th>
          <th style="width: 10%">Date</th>
          <th style="width: 8%">Score</th>
          <th style="width: 10%">Actions</th>
        </tr>
      </thead>
      <tbody>
        ${allReceipts.map(r => renderRow(r)).join('')}
      </tbody>
    </table>
  `;

  content.innerHTML = tableHTML;
  applyFilter();
}

function renderRow(receipt) {
  const confidenceClass = receipt.confidence_score >= 80 ? 'confidence-high' :
                          receipt.confidence_score >= 60 ? 'confidence-medium' : 'confidence-low';

  const merchant = receipt.merchant || extractMerchantFromSubject(receipt.subject);

  // Format amount: charges are negative (-), refunds are positive
  let amountDisplay = '';
  let amountColor = 'var(--ok)';  // Green for refunds
  const amount = parseFloat(receipt.amount) || 0;
  if (amount > 0) {
    const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');
    if (isRefund) {
      amountDisplay = `+$${amount.toFixed(2)}`;
      amountColor = 'var(--ok)';  // Green for refunds (money back)
    } else {
      amountDisplay = `-$${amount.toFixed(2)}`;
      amountColor = 'var(--bad)';  // Red for charges (money spent)
    }
  }
  const date = formatDate(receipt.received_date);

  // Match badge
  let matchBadge = '';
  if (receipt.match_type === 'needs_receipt' && receipt.matched_transaction_id) {
    matchBadge = `<div class="match-badge">üìé Attach to #${receipt.matched_transaction_id}</div>`;
  }

  // AI description
  let description = '';
  if (receipt.description) {
    description = `<div class="description">${escapeHtml(receipt.description)}</div>`;
  }

  // Check if refund for quickAccept
  const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');

  // Get the actual receipt date (use receipt_date if available, otherwise received_date)
  const receiptDate = receipt.receipt_date || receipt.received_date || '';

  // Actions - include preview button
  const previewBtn = `<button class="preview-btn" onclick="event.stopPropagation();showPreview(${receipt.id})" title="Preview">üëÅÔ∏è</button>`;
  const actions = receipt.status === 'pending'
    ? `${previewBtn}
       <button class="btn-success btn-sm" onclick="event.stopPropagation();quickAccept(${receipt.id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}')">‚úì</button>
       <button class="btn-danger btn-sm" onclick="event.stopPropagation();quickReject(${receipt.id})">‚úó</button>`
    : `${previewBtn}<span style="color:var(--muted);font-size:11px;margin-left:8px">${receipt.status === 'accepted' ? '‚úì Accepted' : '‚úó Rejected'}</span>`;

  // Parse sender info
  const fromEmail = receipt.from_email || '';
  const senderName = extractSenderName(fromEmail);

  // Attachment count
  let attachmentCount = 0;
  try {
    const atts = typeof receipt.attachments === 'string' ? JSON.parse(receipt.attachments) : (receipt.attachments || []);
    attachmentCount = atts.length;
  } catch(e) {}
  const attachmentBadge = attachmentCount > 0 ? `<span class="attachment-badge">üìé ${attachmentCount}</span>` : '';

  return `
    <tr data-status="${receipt.status}" data-id="${receipt.id}" class="clickable" onclick="showPreview(${receipt.id})">
      <td>
        <div style="font-weight:500">${escapeHtml(receipt.subject)}</div>
        <div class="snippet">${escapeHtml(receipt.body_snippet || '')}</div>
        ${description}
        ${matchBadge}
        ${attachmentBadge}
      </td>
      <td style="font-weight:500">${escapeHtml(merchant)}</td>
      <td style="font-weight:600;color:${amountColor}">${amountDisplay}</td>
      <td>
        <div class="sender-info">
          <span class="sender-name">${escapeHtml(senderName)}</span>
          <span class="sender-email">${escapeHtml(fromEmail)}</span>
        </div>
      </td>
      <td style="color:var(--muted);font-size:12px">${date}</td>
      <td><span class="confidence-badge ${confidenceClass}">${receipt.confidence_score}%</span></td>
      <td onclick="event.stopPropagation()">${actions}</td>
    </tr>
  `;
}

function extractSenderName(email) {
  if (!email) return 'Unknown';
  // Extract display name from "Name <email>" format
  const match = email.match(/^([^<]+)</);
  if (match) return match[1].trim();
  // Otherwise extract username from email
  return email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function extractMerchantFromSubject(subject) {
  const patterns = [
    /receipt from ([^#\n]+)/i,
    /invoice from ([^#\n]+)/i,
    /payment (?:to|from) ([^#\n]+)/i,
    /your ([^#\n]+?) (?:receipt|invoice)/i,
  ];

  for (const pattern of patterns) {
    const match = subject.match(pattern);
    if (match) return match[1].trim().split('#')[0].trim();
  }
  return 'Unknown';
}

async function quickAccept(id, merchant, amount, isRefund = false, receiptDate = '') {
  const row = document.querySelector(`tr[data-id="${id}"]`);
  const actionsCell = row.querySelector('td:last-child');

  // Show processing state with spinner
  actionsCell.innerHTML = '<span style="color:var(--brand);font-size:11px;display:flex;align-items:center;gap:4px"><span class="spinner"></span> Creating transaction...</span>';

  // Use actual receipt date, fallback to today if not provided
  const transDate = receiptDate ? receiptDate.split('T')[0] : new Date().toISOString().split('T')[0];

  try {
    const response = await fetch('/api/incoming/accept', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        receipt_id: id,
        merchant: merchant,
        amount: amount || 0,
        is_refund: isRefund,
        date: transDate,
        business_type: 'Personal'
      })
    });

    const data = await response.json();

    if (data.ok) {
      // Show success with transaction details
      const actionText = data.action === 'attached' ? 'Attached to existing' : 'New transaction';
      const txnId = data.transaction_id ? ` #${data.transaction_id}` : '';
      // Format amount with proper sign: - for charges, + for refunds
      const amountSign = isRefund ? '+' : '-';
      const amountStr = amount ? ` (${amountSign}$${parseFloat(amount).toFixed(2)})` : '';

      // Update cell with complete status
      actionsCell.innerHTML = `<span style="color:var(--ok);font-size:11px;font-weight:600">‚úÖ Complete${txnId}</span>`;

      // Show detailed toast
      showToast(`‚úÖ Complete! ${actionText}${txnId} - ${merchant}${amountStr}`, 'success');

      // Highlight row briefly
      row.style.backgroundColor = 'rgba(47,255,162,.1)';
      row.setAttribute('data-status', 'accepted');

      // Fade highlight after 2 seconds
      setTimeout(() => {
        row.style.backgroundColor = '';
      }, 2000);

      // Refresh stats
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to accept', 'error');
      actionsCell.innerHTML = `<button class="btn-success btn-sm" onclick="quickAccept(${id}, '${merchant}', ${amount}, ${isRefund})">‚úì</button>
                               <button class="btn-danger btn-sm" onclick="quickReject(${id})">‚úó</button>`;
    }
  } catch (e) {
    console.error('Accept error:', e);
    showToast('Error accepting receipt', 'error');
    actionsCell.innerHTML = `<button class="btn-success btn-sm" onclick="quickAccept(${id}, '${merchant}', ${amount}, ${isRefund})">‚úì</button>
                             <button class="btn-danger btn-sm" onclick="quickReject(${id})">‚úó</button>`;
  }
}

async function quickReject(id) {
  const row = document.querySelector(`tr[data-id="${id}"]`);
  const actionsCell = row.querySelector('td:last-child');
  actionsCell.innerHTML = '<span style="color:var(--muted);font-size:11px">Processing...</span>';

  try {
    const response = await fetch('/api/incoming/reject', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ receipt_id: id })
    });

    const data = await response.json();

    if (data.ok) {
      showToast('Rejected', 'info');

      // Fade out and remove the row
      row.style.transition = 'opacity 0.3s ease';
      row.style.opacity = '0';
      setTimeout(() => {
        row.remove();
        // Update the receipt from allReceipts array
        const receiptIndex = allReceipts.findIndex(r => r.id === id);
        if (receiptIndex !== -1) {
          allReceipts[receiptIndex].status = 'rejected';
        }
        updateStats();
      }, 300);
    } else {
      showToast(data.error || 'Failed to reject', 'error');
    }
  } catch (e) {
    console.error('Reject error:', e);
    showToast('Error rejecting receipt', 'error');
  }
}

function filterStatus(status) {
  currentFilter = status;

  // Update chip states using data-filter attribute (handles clicks on child elements)
  document.querySelectorAll('.chip').forEach(chip => {
    chip.classList.remove('active');
    if (chip.getAttribute('data-filter') === status) {
      chip.classList.add('active');
    }
  });

  applyFilter();
}

function applyFilter() {
  const rows = document.querySelectorAll('tbody tr');
  rows.forEach(row => {
    const rowStatus = row.getAttribute('data-status');
    if (currentFilter === 'all' || rowStatus === currentFilter) {
      row.classList.remove('hidden');
    } else {
      row.classList.add('hidden');
    }
  });
}

async function scanForNew() {
  showToast('Scanning Gmail accounts...', 'info');

  try {
    const response = await fetch('/api/incoming/scan', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({})
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Found ${data.results.total_new} new receipts!`, 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Scan failed', 'error');
    }
  } catch (e) {
    console.error('Scan error:', e);
    showToast('Error scanning Gmail', 'error');
  }
}

async function clearFiltered() {
  if (!confirm('Remove all rejected receipts from the database?')) return;

  try {
    const response = await fetch('/api/incoming/clear-rejected', {
      method: 'POST'
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Cleared ${data.count} rejected receipts`, 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to clear', 'error');
    }
  } catch (e) {
    showToast('Error clearing receipts', 'error');
  }
}

async function reprocessMissing() {
  showToast('Re-processing accepted receipts with missing files...', 'info');

  try {
    const response = await fetch('/api/incoming/reprocess-missing', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({})
    });

    const data = await response.json();

    if (data.ok) {
      if (data.processed === 0) {
        showToast('All accepted receipts already have files!', 'success');
      } else {
        showToast(`Fixed ${data.success} of ${data.processed} receipts`, 'success');
      }
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to reprocess', 'error');
    }
  } catch (e) {
    console.error('Reprocess error:', e);
    showToast('Error reprocessing receipts', 'error');
  }
}

async function fixDates() {
  // First do a dry run to show what will be fixed
  showToast('Checking for transactions with wrong dates...', 'info');

  try {
    const dryRunResponse = await fetch('/api/incoming/fix-dates', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ dry_run: true })
    });

    const dryRunData = await dryRunResponse.json();

    if (!dryRunData.ok) {
      showToast(dryRunData.error || 'Failed to check dates', 'error');
      return;
    }

    if (dryRunData.found === 0) {
      showToast('All transaction dates are correct!', 'success');
      return;
    }

    // Show confirmation with details
    const details = dryRunData.results.map(r =>
      `${r.merchant}: ${r.old_date} -> ${r.new_date}`
    ).join('\n');

    if (!confirm(`Found ${dryRunData.found} transaction(s) with wrong dates:\n\n${details}\n\nFix them?`)) {
      return;
    }

    // Actually fix the dates
    showToast('Fixing transaction dates...', 'info');
    const response = await fetch('/api/incoming/fix-dates', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ dry_run: false })
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Fixed ${data.fixed} transaction dates!`, 'success');
    } else {
      showToast(data.error || 'Failed to fix dates', 'error');
    }
  } catch (e) {
    console.error('Fix dates error:', e);
    showToast('Error fixing dates', 'error');
  }
}

function formatDate(dateStr) {
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch {
    return dateStr;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;

  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// Preview Modal Functions
let currentPreviewReceipt = null;

function showPreview(receiptId) {
  const receipt = allReceipts.find(r => r.id === receiptId);
  if (!receipt) return;

  currentPreviewReceipt = receipt;
  const modal = document.getElementById('preview-modal');

  // Populate the modal
  document.getElementById('preview-subject').textContent = receipt.subject || 'No subject';
  document.getElementById('preview-from').textContent = receipt.from_email || 'Unknown sender';

  // Format amount
  const amount = parseFloat(receipt.amount) || 0;
  const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');
  const amountEl = document.getElementById('preview-amount');
  if (amount > 0) {
    if (isRefund) {
      amountEl.textContent = `+$${amount.toFixed(2)}`;
      amountEl.className = 'preview-meta-value large amount-refund';
    } else {
      amountEl.textContent = `-$${amount.toFixed(2)}`;
      amountEl.className = 'preview-meta-value large amount-charge';
    }
  } else {
    amountEl.textContent = 'Not detected';
    amountEl.className = 'preview-meta-value large';
  }

  // Merchant
  const merchant = receipt.merchant || extractMerchantFromSubject(receipt.subject);
  document.getElementById('preview-merchant').textContent = merchant;

  // Date
  const dateStr = receipt.receipt_date || receipt.received_date;
  document.getElementById('preview-date').textContent = dateStr ? formatDate(dateStr) : 'Unknown';

  // AI Notes / Description
  const aiSection = document.getElementById('preview-ai-section');
  if (receipt.description || receipt.ai_notes) {
    aiSection.style.display = 'block';
    document.getElementById('preview-ai-notes').textContent = receipt.description || receipt.ai_notes;
  } else {
    aiSection.style.display = 'none';
  }

  // Body snippet
  document.getElementById('preview-body').textContent = receipt.body_snippet || 'No preview available';

  // Attachments
  const attachmentsSection = document.getElementById('preview-attachments-section');
  const attachmentsEl = document.getElementById('preview-attachments');
  let attachments = [];
  try {
    attachments = typeof receipt.attachments === 'string' ? JSON.parse(receipt.attachments) : (receipt.attachments || []);
  } catch(e) {}

  if (attachments.length > 0) {
    attachmentsSection.style.display = 'block';
    attachmentsEl.innerHTML = attachments.map(att => {
      const name = typeof att === 'string' ? att : (att.filename || att.name || 'Attachment');
      const icon = getAttachmentIcon(name);
      return `<div class="preview-attachment"><span class="preview-attachment-icon">${icon}</span> ${escapeHtml(name)}</div>`;
    }).join('');
  } else {
    attachmentsSection.style.display = 'none';
  }

  // Account badge
  const accountBadgeEl = document.getElementById('preview-account-badge');
  const gmailAccount = receipt.gmail_account || '';
  let accountClass = 'personal';
  let accountLabel = gmailAccount.split('@')[0] || 'Unknown';
  if (gmailAccount.includes('musiccity')) {
    accountClass = 'mcr';
    accountLabel = 'MCR';
  } else if (gmailAccount.includes('downhome')) {
    accountClass = 'downhome';
    accountLabel = 'DownHome';
  }
  accountBadgeEl.innerHTML = `<span class="account-badge ${accountClass}">${accountLabel}</span>`;

  // Actions
  const actionsEl = document.getElementById('preview-actions');
  const receiptDate = receipt.receipt_date || receipt.received_date || '';
  if (receipt.status === 'pending') {
    actionsEl.innerHTML = `
      <button class="btn-danger" onclick="closePreview();quickReject(${receipt.id})">‚úï Reject</button>
      <button class="btn-success" onclick="closePreview();quickAccept(${receipt.id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}')">‚úì Accept</button>
    `;
  } else {
    const statusText = receipt.status === 'accepted' ? '‚úì Accepted' : '‚úï Rejected';
    actionsEl.innerHTML = `<span style="color:var(--muted)">${statusText}</span>`;
  }

  // Show modal
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closePreview() {
  const modal = document.getElementById('preview-modal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  currentPreviewReceipt = null;
}

function getAttachmentIcon(filename) {
  const ext = (filename || '').split('.').pop().toLowerCase();
  switch(ext) {
    case 'pdf': return 'üìÑ';
    case 'png': case 'jpg': case 'jpeg': case 'gif': case 'webp': return 'üñºÔ∏è';
    case 'html': case 'htm': return 'üåê';
    default: return 'üìé';
  }
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
  if (!document.getElementById('preview-modal').classList.contains('active')) return;

  if (e.key === 'Escape') {
    closePreview();
  } else if (currentPreviewReceipt && currentPreviewReceipt.status === 'pending') {
    if (e.key === 'Enter' || e.key === 'a' || e.key === 'A') {
      // Accept with Enter or 'A'
      const r = currentPreviewReceipt;
      const merchant = r.merchant || extractMerchantFromSubject(r.subject);
      const amount = parseFloat(r.amount) || 0;
      const isRefund = r.is_refund || (r.subject || '').toLowerCase().includes('refund');
      const receiptDate = r.receipt_date || r.received_date || '';
      closePreview();
      quickAccept(r.id, merchant, amount, isRefund, receiptDate);
    } else if (e.key === 'r' || e.key === 'R' || e.key === 'Backspace') {
      // Reject with 'R' or Backspace
      closePreview();
      quickReject(currentPreviewReceipt.id);
    }
  }
});
</script>

</body>
</html>
