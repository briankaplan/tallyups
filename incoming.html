<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="AI-powered receipt management - Incoming receipts processing">
<meta name="theme-color" content="#0b0d10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Inbox - Tallyups</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßæ</text></svg>">
<style>
/* Tallyups Theme - Black & Green */
:root {
  --bg:#000000; --panel:#111111; --panel2:#0a0a0a; --edge:#222;
  --ink:#f0f0f0; --muted:#888; --brand:#00ff88;
  --ok:#00ff88; --bad:#ff4e6a; --warn:#ffd85e;
  --glow:rgba(0,255,136,.35);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%; background: var(--bg); color: var(--ink);
  font: 13px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Helvetica, Arial;
}

/* Header */
header {
  display: flex; align-items: center; justify-content: space-between; gap: 16px;
  padding: 12px 20px;
  background: linear-gradient(180deg, #0e141a, #0a0f15);
  border-bottom: 1px solid var(--edge);
  box-shadow: 0 2px 12px rgba(0,0,0,.5);
}

.brand { display: flex; align-items: center; gap: 12px; }
.brand h1 {
  margin: 0; font-size: 16px; font-weight: 800;
  background: linear-gradient(135deg, #00ff88, #00cc6a);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.version {
  padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700;
  background: rgba(0,255,136,.15); color: var(--brand);
}

/* Navigation */
.nav-buttons {
  display: flex; gap: 8px; margin-left: auto;
}
.nav-btn {
  padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 13px;
  background: rgba(0,255,136,.1); color: var(--muted);
  border: 1px solid transparent; transition: all .15s;
}
.nav-btn:hover {
  background: rgba(0,255,136,.2); color: var(--ink);
}
.nav-btn.active {
  background: rgba(0,255,136,.2); color: var(--brand);
  border-color: rgba(0,255,136,.3);
}

.controls { display: flex; align-items: center; gap: 10px; }

/* Buttons */
button {
  cursor: pointer; border: none; border-radius: 10px; padding: 8px 14px;
  background: #121a25; transition: all .15s ease; font-size: 13px; font-weight: 500;
  color: var(--ink);
}
button:hover { opacity: .9; transform: translateY(-1px); }
button:active { transform: translateY(0); }

.btn-primary {
  background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,255,136,.3);
}
.btn-success {
  background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,255,136,.3);
}
.btn-danger {
  background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff;
}
.btn-ghost {
  background: rgba(0,255,136,.1); color: var(--brand);
}
.btn-sm { padding: 6px 12px; font-size: 12px; }

/* Dashboard Stats */
.dashboard {
  padding: 16px 20px; background: var(--panel);
  border-bottom: 1px solid var(--edge);
  display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;
}
.stat {
  background: linear-gradient(135deg, rgba(59,130,246,.08), rgba(139,92,246,.08));
  padding: 12px 16px; border-radius: 12px;
  border: 1px solid rgba(59,130,246,.15);
}
.stat-label {
  font-size: 11px; color: var(--muted); text-transform: uppercase;
  letter-spacing: .5px; font-weight: 600;
}
.stat-value {
  font-size: 22px; font-weight: 800; margin: 4px 0; color: var(--ink);
}

/* Filters */
.filters {
  padding: 14px 20px; background: var(--panel);
  border-bottom: 1px solid var(--edge);
  display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
}
.chip {
  padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all .15s; display: flex; align-items: center; gap: 8px;
  background: var(--panel2); border: 1px solid var(--edge); color: var(--muted);
}
.chip:hover { background: rgba(59,130,246,.1); }
.chip.active {
  background: rgba(59,130,246,.2); border-color: var(--brand); color: var(--brand);
}
.chip-icon { font-size: 14px; }
.chip-count {
  padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;
  background: rgba(255,255,255,.08); min-width: 20px; text-align: center;
}
.chip.active .chip-count { background: rgba(59,130,246,.3); }
.chip[data-filter="pending"] .chip-count { background: rgba(59,130,246,.2); color: var(--brand); }
.chip[data-filter="accepted"] .chip-count { background: rgba(47,255,162,.15); color: var(--ok); }
.chip[data-filter="rejected"] .chip-count { background: rgba(255,78,106,.1); color: var(--bad); }

/* Content */
.content {
  flex: 1; overflow-y: auto; padding: 20px;
}

/* Table */
table {
  width: 100%; border-collapse: separate; border-spacing: 0;
  background: var(--panel); border-radius: 12px; overflow: hidden;
}
thead {
  background: linear-gradient(135deg, rgba(59,130,246,.08), rgba(139,92,246,.08));
  border-bottom: 1px solid var(--edge);
}
th {
  padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600;
  color: var(--muted); text-transform: uppercase; letter-spacing: .5px;
}
td {
  padding: 14px 16px; border-bottom: 1px solid var(--edge);
  font-size: 13px;
}
tr:last-child td { border-bottom: none; }
tr:hover { background: rgba(59,130,246,.03); }
tr.hidden { display: none; }

/* Badges */
.confidence-badge {
  padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;
  display: inline-block;
}
.confidence-high { background: rgba(47,255,162,.15); color: var(--ok); }
.confidence-medium { background: rgba(255,216,94,.15); color: var(--warn); }
.confidence-low { background: rgba(255,78,106,.15); color: var(--bad); }

.match-badge {
  font-size: 11px; color: var(--warn); margin-top: 4px;
  display: inline-block;
}

.description {
  font-size: 12px; color: var(--muted); margin-top: 4px;
  font-style: italic;
}

.snippet {
  font-size: 12px; color: var(--muted); margin-top: 2px;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  max-width: 300px;
}

/* Empty state */
.empty-state {
  text-align: center; padding: 60px 20px;
  color: var(--muted);
}
.empty-state h3 {
  font-size: 18px; margin-bottom: 8px; color: var(--ink);
}

/* Loading */
.loading {
  text-align: center; padding: 40px; color: var(--muted);
}

/* Toast */
.toast {
  position: fixed; bottom: 20px; right: 20px;
  padding: 12px 20px; border-radius: 10px;
  background: var(--panel); border: 1px solid var(--edge);
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
  opacity: 0; transform: translateY(20px);
  transition: all .3s; pointer-events: none;
  z-index: 1000;
}
.toast.show {
  opacity: 1; transform: translateY(0); pointer-events: auto;
}
.toast.success { border-left: 3px solid var(--ok); }
.toast.error { border-left: 3px solid var(--bad); }
.toast.info { border-left: 3px solid var(--brand); }

/* Spinner animation */
.spinner {
  width: 12px; height: 12px; border: 2px solid var(--edge);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  display: inline-block;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Success row highlight animation */
.row-success {
  animation: successFade 2s ease-out;
}
@keyframes successFade {
  0% { background-color: rgba(47,255,162,.2); }
  100% { background-color: transparent; }
}

/* Clickable rows */
tr.clickable { cursor: pointer; }
tr.clickable:hover { background: rgba(59,130,246,.06); }

/* Sender info */
.sender-info {
  display: flex; flex-direction: column; gap: 2px;
}
.sender-name {
  font-weight: 600; color: var(--ink); font-size: 13px;
}
.sender-email {
  font-size: 11px; color: var(--muted);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  max-width: 180px;
}

/* Attachment badge */
.attachment-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 6px; border-radius: 4px; font-size: 10px;
  background: rgba(139,92,246,.15); color: #a78bfa;
  margin-top: 4px;
}

/* Preview eye icon */
.preview-btn {
  width: 32px; height: 32px; border-radius: 6px;
  background: rgba(59,130,246,.1); color: var(--brand);
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 14px; cursor: pointer; border: none;
  transition: all .15s;
}
.preview-btn:hover {
  background: rgba(59,130,246,.2); transform: scale(1.05);
}

/* Preview Modal */
.preview-modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.9);
  display: none; z-index: 2000;
  padding: 20px;
  overflow-y: auto;
}
.preview-modal.active { display: flex; align-items: flex-start; justify-content: center; }

.preview-content {
  background: var(--panel);
  border-radius: 16px;
  max-width: 700px;
  width: 100%;
  margin: 40px auto;
  box-shadow: 0 24px 48px rgba(0,0,0,.5);
  animation: slideUp 0.2s ease;
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.preview-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--edge);
  display: flex; justify-content: space-between; align-items: flex-start;
}
.preview-title {
  font-size: 18px; font-weight: 700; color: var(--ink);
  line-height: 1.4;
  flex: 1;
}
.preview-close {
  width: 36px; height: 36px; border-radius: 8px;
  background: rgba(239,68,68,.1); color: var(--bad);
  font-size: 20px; cursor: pointer; border: none;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-left: 16px;
}

.preview-body { padding: 24px; }

.preview-meta {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;
  margin-bottom: 20px;
}
.preview-meta-item {
  background: var(--panel2);
  padding: 12px 16px;
  border-radius: 10px;
  border: 1px solid var(--edge);
}
.preview-meta-label {
  font-size: 10px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.5px;
  margin-bottom: 4px;
}
.preview-meta-value {
  font-size: 14px; font-weight: 600; color: var(--ink);
  word-break: break-word;
}
.preview-meta-value.large {
  font-size: 24px;
}
.preview-meta-value.amount-charge { color: var(--bad); }
.preview-meta-value.amount-refund { color: var(--ok); }

.preview-section {
  margin-bottom: 20px;
}
.preview-section-title {
  font-size: 11px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.5px;
  margin-bottom: 8px; font-weight: 600;
}
.preview-section-content {
  background: var(--panel2);
  padding: 16px;
  border-radius: 10px;
  border: 1px solid var(--edge);
  font-size: 13px;
  line-height: 1.6;
  color: var(--ink);
  white-space: pre-wrap;
  max-height: 300px;
  overflow-y: auto;
}

.preview-attachments {
  display: flex; gap: 8px; flex-wrap: wrap;
}
.preview-attachment {
  display: flex; align-items: center; gap: 8px;
  background: rgba(139,92,246,.1);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  color: #a78bfa;
}
.preview-attachment-icon { font-size: 16px; }

.preview-footer {
  padding: 16px 24px;
  border-top: 1px solid var(--edge);
  display: flex; justify-content: space-between; align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.preview-actions {
  display: flex; gap: 10px;
}

/* Account badge */
.account-badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
}
.account-badge.personal { background: rgba(59,130,246,.15); color: #60a5fa; }
.account-badge.mcr { background: rgba(239,68,68,.15); color: #f87171; }
.account-badge.downhome { background: rgba(34,197,94,.15); color: #4ade80; }

/* ============================================
   AWARD-WORTHY POLISH & MICRO-INTERACTIONS
   ============================================ */

/* Skeleton Loading */
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
.skeleton {
  background: linear-gradient(90deg, var(--panel2) 25%, var(--edge) 50%, var(--panel2) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite ease-in-out;
  border-radius: 6px;
  height: 16px;
}

/* Page Load Animation */
.content {
  animation: fadeSlideIn 0.3s ease-out;
}
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Nav Button Polish */
.nav-btn {
  position: relative;
  overflow: hidden;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.nav-btn::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 0;
  height: 2px;
  background: var(--brand);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateX(-50%);
}
.nav-btn:hover::before { width: 60%; }
.nav-btn.active::before {
  width: 100%;
  height: 3px;
  background: linear-gradient(90deg, transparent, var(--brand), transparent);
}

/* Stat Card Hover */
.stat {
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: default;
}
.stat:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,255,136,0.15);
  border-color: rgba(0,255,136,0.3);
}

/* Chip Filter Animation */
.chip {
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.chip:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,255,136,0.2);
}
.chip.active {
  transform: scale(1.02);
  box-shadow: 0 2px 12px rgba(0,255,136,0.3);
}

/* Table Row Animation */
tr {
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
tr.clickable:hover {
  transform: translateX(2px);
  box-shadow: inset 3px 0 0 var(--brand);
}

/* Button Hover Polish */
button {
  position: relative;
  overflow: hidden;
}
button:hover {
  transform: translateY(-1px);
}
button:active {
  transform: translateY(0);
}

/* Toast Animation */
@keyframes toastSlideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
.toast.show {
  animation: toastSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Preview Modal Polish */
.preview-modal {
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.preview-content {
  animation: modalSlideUp 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}
@keyframes modalSlideUp {
  from { opacity: 0; transform: translateY(30px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Focus States */
button:focus-visible {
  outline: none;
  box-shadow: 0 0 0 3px rgba(0,255,136,0.35);
}

/* Success Animation */
@keyframes successPop {
  0% { transform: scale(0.8); opacity: 0; }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}
.success-pop {
  animation: successPop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Staggered Row Animation */
@keyframes rowFadeIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}
tbody tr {
  animation: rowFadeIn 0.3s ease-out backwards;
}
tbody tr:nth-child(1) { animation-delay: 0.02s; }
tbody tr:nth-child(2) { animation-delay: 0.04s; }
tbody tr:nth-child(3) { animation-delay: 0.06s; }
tbody tr:nth-child(4) { animation-delay: 0.08s; }
tbody tr:nth-child(5) { animation-delay: 0.1s; }

/* ============================================
   MOBILE-FIRST INBOX UI
   ============================================ */

/* Safe area support */
:root {
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* Mobile Card Container */
.mobile-inbox {
  display: none;
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  padding-bottom: calc(16px + var(--safe-bottom));
}

/* Receipt Card */
.inbox-card {
  background: var(--panel);
  border-radius: 20px;
  padding: 18px;
  border: 1px solid var(--edge);
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s ease;
}
.inbox-card:active {
  transform: scale(0.98);
  background: rgba(0,255,136,0.03);
}
.inbox-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  border-radius: 20px 0 0 20px;
}
.inbox-card.pending::before { background: var(--brand); }
.inbox-card.accepted::before { background: var(--ok); opacity: 0.5; }
.inbox-card.rejected::before { background: var(--bad); opacity: 0.5; }

/* Card Header */
.inbox-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  gap: 12px;
}
.inbox-card-date {
  font-size: 12px;
  color: var(--muted);
  font-weight: 600;
  white-space: nowrap;
}
.inbox-card-score {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
}
.inbox-card-score.high { background: rgba(0,255,136,0.15); color: var(--ok); }
.inbox-card-score.medium { background: rgba(255,216,94,0.15); color: var(--warn); }
.inbox-card-score.low { background: rgba(255,78,106,0.15); color: var(--bad); }

/* Card Body */
.inbox-card-merchant {
  font-size: 17px;
  font-weight: 700;
  color: var(--ink);
  margin-bottom: 6px;
  line-height: 1.3;
}
.inbox-card-amount {
  font-size: 22px;
  font-weight: 800;
  font-family: 'SF Mono', monospace;
  margin-bottom: 12px;
}
.inbox-card-amount.charge { color: var(--bad); }
.inbox-card-amount.refund { color: var(--ok); }

/* Card Meta Row */
.inbox-card-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}
.inbox-card-sender {
  font-size: 13px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}
.inbox-card-sender-icon {
  font-size: 14px;
}

/* Card Description */
.inbox-card-desc {
  font-size: 13px;
  color: var(--muted);
  line-height: 1.5;
  margin-bottom: 12px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Card Subject */
.inbox-card-subject {
  font-size: 12px;
  color: var(--muted);
  opacity: 0.7;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 12px;
}

/* Card Footer Actions */
.inbox-card-actions {
  display: flex;
  gap: 10px;
  padding-top: 14px;
  border-top: 1px solid rgba(255,255,255,0.05);
}
.inbox-card-btn {
  flex: 1;
  padding: 12px 16px;
  border-radius: 12px;
  border: none;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.15s;
}
.inbox-card-btn:active { transform: scale(0.95); }
.inbox-card-btn.accept {
  background: var(--brand);
  color: #000;
}
.inbox-card-btn.reject {
  background: rgba(255,78,106,0.15);
  color: var(--bad);
}
.inbox-card-btn.preview {
  background: rgba(59,130,246,0.15);
  color: #60a5fa;
  flex: 0.5;
}

/* Card Status for non-pending */
.inbox-card-status {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
}
.inbox-card-status.accepted {
  background: rgba(0,255,136,0.1);
  color: var(--ok);
}
.inbox-card-status.rejected {
  background: rgba(255,78,106,0.1);
  color: var(--bad);
}

/* Match Badge for Expense Matching */
.inbox-card-match {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 12px;
}
.inbox-card-match .match-icon {
  font-size: 16px;
}
.inbox-card-match.found {
  background: rgba(0,255,136,0.12);
  color: var(--ok);
  border: 1px solid rgba(0,255,136,0.25);
}
.inbox-card-match.none {
  background: rgba(255,216,94,0.1);
  color: var(--warn);
  border: 1px solid rgba(255,216,94,0.2);
}

/* Match button styling */
.inbox-card-btn.match {
  background: linear-gradient(135deg, #00ff88, #00cc6a);
  color: #000;
  box-shadow: 0 2px 8px rgba(0,255,136,0.3);
}
.inbox-card-btn.create {
  background: rgba(59,130,246,0.2);
  color: #60a5fa;
  border: 1px solid rgba(59,130,246,0.3);
}

/* Empty state */
.inbox-empty {
  text-align: center;
  padding: 60px 24px;
}
.inbox-empty-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}
.inbox-empty-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--ink);
}
.inbox-empty-text {
  font-size: 14px;
  color: var(--muted);
}

/* Mobile Styles */
@media (max-width: 768px) {
  /* Prevent horizontal overflow at body level */
  html, body {
    overflow-x: hidden;
    width: 100%;
    max-width: 100vw;
  }

  /* Hide table, show cards */
  .content table { display: none !important; }
  .mobile-inbox { display: flex !important; }

  /* Clean mobile header */
  header {
    flex-wrap: wrap;
    padding: 10px 12px;
    padding-top: calc(10px + var(--safe-top));
    gap: 8px;
    position: relative;
    overflow: hidden;
  }

  .brand {
    order: 1;
    flex-shrink: 0;
  }
  .brand h1 {
    font-size: 15px;
  }
  .version {
    font-size: 9px;
    padding: 2px 6px;
  }

  /* Navigation - horizontal scroll with fade edges */
  .nav-buttons {
    order: 3;
    width: 100%;
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    gap: 6px;
    padding: 4px 0;
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-snap-type: x proximity;
  }
  .nav-buttons::-webkit-scrollbar { display: none; }

  .nav-btn {
    padding: 8px 12px;
    font-size: 12px;
    white-space: nowrap;
    flex-shrink: 0;
    scroll-snap-align: start;
    border-radius: 8px;
  }
  .nav-btn::before { display: none; } /* Remove underline animation */

  /* Controls - compact */
  .controls {
    order: 2;
    gap: 6px;
    margin-left: auto;
  }
  .controls button {
    padding: 6px 10px;
    font-size: 11px;
    border-radius: 8px;
  }
  .controls .btn-ghost.btn-sm { display: none; }
  .controls .btn-primary {
    padding: 8px 12px;
  }

  /* Compact dashboard - 2x2 grid */
  .dashboard {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    padding: 10px 12px;
  }
  .stat {
    padding: 10px 12px;
    border-radius: 12px;
  }
  .stat-value {
    font-size: 20px;
  }
  .stat-label {
    font-size: 10px;
  }

  /* Compact filters - scrollable */
  .filters {
    padding: 8px 12px;
    gap: 6px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    flex-wrap: nowrap;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .filters::-webkit-scrollbar { display: none; }

  .chip {
    padding: 8px 12px;
    font-size: 12px;
    white-space: nowrap;
    flex-shrink: 0;
    border-radius: 10px;
  }
  .chip-icon { display: none; }

  /* Content area */
  .content {
    padding: 0;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* Mobile cards - proper containment */
  .mobile-inbox {
    padding: 12px;
    padding-bottom: calc(16px + var(--safe-bottom));
    gap: 10px;
    overflow-x: hidden;
    width: 100%;
    box-sizing: border-box;
  }

  .inbox-card {
    width: 100%;
    box-sizing: border-box;
    border-radius: 16px;
    padding: 14px;
  }

  .inbox-card-header {
    margin-bottom: 8px;
  }
  .inbox-card-date {
    font-size: 11px;
  }
  .inbox-card-score {
    font-size: 10px;
    padding: 3px 8px;
  }
  .inbox-card-merchant {
    font-size: 16px;
    margin-bottom: 4px;
    word-break: break-word;
  }
  .inbox-card-amount {
    font-size: 20px;
    margin-bottom: 10px;
  }
  .inbox-card-meta {
    margin-bottom: 8px;
  }
  .inbox-card-sender {
    font-size: 12px;
  }
  .inbox-card-desc {
    font-size: 12px;
    margin-bottom: 10px;
    -webkit-line-clamp: 2;
  }

  /* Card action buttons */
  .inbox-card-actions {
    padding-top: 10px;
    gap: 8px;
  }
  .inbox-card-btn {
    padding: 10px 12px;
    font-size: 13px;
    border-radius: 10px;
  }
  .inbox-card-btn.preview {
    flex: 0 0 44px;
    padding: 10px;
  }

  /* Preview modal mobile - bottom sheet */
  .preview-content {
    width: 100%;
    max-width: none;
    margin: 0;
    border-radius: 20px 20px 0 0;
    max-height: 90vh;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    animation: slideUpMobile 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  }
  @keyframes slideUpMobile {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }
  .preview-modal {
    align-items: flex-end;
    padding: 0;
  }
  .preview-header {
    padding: 12px 16px;
    padding-top: 8px;
  }
  .preview-header::before {
    content: '';
    display: block;
    width: 36px;
    height: 4px;
    background: var(--edge);
    border-radius: 2px;
    margin: 0 auto 10px;
  }
  .preview-title {
    font-size: 16px;
  }
  .preview-close {
    width: 32px;
    height: 32px;
    font-size: 18px;
  }
  .preview-body {
    padding: 12px 16px;
    max-height: 45vh;
    overflow-y: auto;
  }
  .preview-meta {
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .preview-meta-item {
    padding: 10px 12px;
  }
  .preview-meta-value.large {
    font-size: 20px;
  }
  .preview-footer {
    padding: 10px 16px;
    padding-bottom: calc(10px + var(--safe-bottom));
    flex-direction: column;
    gap: 8px;
  }
  .preview-actions {
    width: 100%;
    gap: 8px;
  }
  .preview-actions button {
    flex: 1;
    padding: 12px;
    font-size: 14px;
  }
}

/* Very small screens (iPhone SE, etc) */
@media (max-width: 380px) {
  header {
    padding: 8px 10px;
    padding-top: calc(8px + var(--safe-top));
  }
  .brand h1 {
    font-size: 14px;
  }

  .dashboard {
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
    padding: 8px 10px;
  }
  .stat {
    padding: 8px 10px;
  }
  .stat-value {
    font-size: 18px;
  }

  .mobile-inbox {
    padding: 10px;
    gap: 8px;
  }

  .inbox-card {
    padding: 12px;
    border-radius: 14px;
  }
  .inbox-card-merchant {
    font-size: 15px;
  }
  .inbox-card-amount {
    font-size: 18px;
  }
  .inbox-card-btn {
    padding: 10px;
    font-size: 12px;
  }
}

/* Touch-friendly targets */
@media (pointer: coarse) {
  .inbox-card-btn {
    min-height: 44px;
  }
  .chip, .nav-btn {
    min-height: 40px;
    display: flex;
    align-items: center;
  }
}

/* Safe Area Support */
:root {
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* Mobile Bottom Navigation */
.bottom-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: calc(60px + var(--safe-bottom));
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--edge);
  justify-content: space-around;
  align-items: flex-start;
  padding-top: 8px;
  z-index: 100;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  color: var(--muted);
  text-decoration: none;
  font-size: 10px;
  font-weight: 500;
  padding: 4px 16px;
  transition: color 0.2s;
}

.nav-item.active {
  color: var(--brand);
}

.nav-item svg {
  width: 24px;
  height: 24px;
}

@media (max-width: 768px) {
  .bottom-nav {
    display: flex;
  }

  body {
    padding-bottom: calc(70px + var(--safe-bottom));
  }

  .toast {
    bottom: calc(80px + var(--safe-bottom));
  }

  /* Hide desktop nav on mobile */
  .nav-buttons {
    display: none;
  }
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="brand">
    <h1>üßæ Tallyups</h1>
    <span class="version">v2.0</span>
  </div>
  <div class="nav-buttons">
    <button class="nav-btn" onclick="window.location.href='/'">üè† Home</button>
    <button class="nav-btn" onclick="window.location.href='/viewer'">üîÑ Reconcile</button>
    <button class="nav-btn" onclick="window.location.href='/library'">üìö Library</button>
    <button class="nav-btn" onclick="window.location.href='/scanner'">üì∑ Scan</button>
    <button class="nav-btn active">üì• Inbox</button>
    <button class="nav-btn" onclick="window.location.href='/reports'">üìä Reports</button>
  </div>
  <div class="controls">
    <button class="btn-ghost btn-sm" onclick="clearFiltered()">üóëÔ∏è Clear Rejected</button>
    <button class="btn-ghost btn-sm" onclick="reprocessMissing()" title="Re-download receipts for accepted items that have no files">üîß Fix Missing</button>
    <button class="btn-ghost btn-sm" onclick="fixDates()" title="Fix wrong dates on transactions from incoming receipts">üìÖ Fix Dates</button>
    <button class="btn-primary" onclick="scanForNew()">üîÑ Scan Now</button>
  </div>
</header>

<!-- Stats Dashboard -->
<div class="dashboard">
  <div class="stat">
    <div class="stat-label">In Inbox</div>
    <div class="stat-value" id="stat-pending">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Matched</div>
    <div class="stat-value" id="stat-accepted">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Dismissed</div>
    <div class="stat-value" id="stat-rejected">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Total</div>
    <div class="stat-value" id="stat-total">0</div>
  </div>
</div>

<!-- Filters -->
<div class="filters">
  <div class="chip" onclick="filterStatus('pending')" data-filter="pending">
    <span class="chip-icon">üì•</span> Inbox
    <span class="chip-count" id="chip-pending">0</span>
  </div>
  <div class="chip" onclick="filterStatus('accepted')" data-filter="accepted">
    <span class="chip-icon">üîó</span> Matched
    <span class="chip-count" id="chip-accepted">0</span>
  </div>
  <div class="chip" onclick="filterStatus('rejected')" data-filter="rejected">
    <span class="chip-icon">‚úï</span> Dismissed
    <span class="chip-count" id="chip-rejected">0</span>
  </div>
  <div class="chip" onclick="filterStatus('all')" data-filter="all">
    <span class="chip-icon">üìã</span> All
  </div>
</div>

<!-- Content -->
<div class="content" id="content">
  <div class="loading">Loading receipts...</div>
</div>

<!-- Mobile Card View -->
<div class="mobile-inbox" id="mobile-inbox">
  <!-- Cards rendered by JavaScript -->
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Preview Modal -->
<div id="preview-modal" class="preview-modal" onclick="if(event.target===this)closePreview()">
  <div class="preview-content">
    <div class="preview-header">
      <div class="preview-title" id="preview-subject">Email Subject</div>
      <button class="preview-close" onclick="closePreview()">‚úï</button>
    </div>
    <div class="preview-body">
      <div class="preview-meta">
        <div class="preview-meta-item">
          <div class="preview-meta-label">From</div>
          <div class="preview-meta-value" id="preview-from">sender@email.com</div>
        </div>
        <div class="preview-meta-item">
          <div class="preview-meta-label">Amount</div>
          <div class="preview-meta-value large" id="preview-amount">$0.00</div>
        </div>
        <div class="preview-meta-item">
          <div class="preview-meta-label">Merchant</div>
          <div class="preview-meta-value" id="preview-merchant">Unknown</div>
        </div>
        <div class="preview-meta-item">
          <div class="preview-meta-label">Date</div>
          <div class="preview-meta-value" id="preview-date">Jan 1, 2025</div>
        </div>
      </div>
      <div class="preview-section" id="preview-ai-section" style="display:none">
        <div class="preview-section-title">AI Analysis</div>
        <div class="preview-section-content" id="preview-ai-notes"></div>
      </div>
      <div class="preview-section">
        <div class="preview-section-title">Email Body Preview</div>
        <div class="preview-section-content" id="preview-body">Loading...</div>
      </div>
      <div class="preview-section" id="preview-attachments-section" style="display:none">
        <div class="preview-section-title">Attachments</div>
        <div class="preview-attachments" id="preview-attachments"></div>
      </div>
    </div>
    <div class="preview-footer">
      <div id="preview-account-badge"></div>
      <div class="preview-actions" id="preview-actions"></div>
    </div>
  </div>
</div>

<!-- Duplicate Warning Modal -->
<div id="duplicate-modal" class="duplicate-modal">
  <div class="duplicate-content">
    <div class="duplicate-icon">‚ö†Ô∏è</div>
    <div class="duplicate-title">Possible Duplicate</div>
    <div class="duplicate-subtitle">This receipt may match an existing transaction</div>
    <div class="duplicate-match" id="duplicate-match-info">
      <div class="duplicate-match-row">
        <span class="duplicate-match-label">Merchant</span>
        <span id="dup-merchant">‚Äî</span>
      </div>
      <div class="duplicate-match-row">
        <span class="duplicate-match-label">Amount</span>
        <span id="dup-amount">‚Äî</span>
      </div>
      <div class="duplicate-match-row">
        <span class="duplicate-match-label">Date</span>
        <span id="dup-date">‚Äî</span>
      </div>
      <div class="duplicate-match-row">
        <span class="duplicate-match-label">Has Receipt</span>
        <span id="dup-has-receipt">‚Äî</span>
      </div>
    </div>
    <div class="duplicate-actions">
      <button class="duplicate-btn secondary" onclick="closeDuplicateModal();pendingAccept?.callback(true)">Add Anyway</button>
      <button class="duplicate-btn primary" onclick="closeDuplicateModal();attachToExisting()">Attach to Existing</button>
    </div>
  </div>
</div>

<style>
  .duplicate-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(10px);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .duplicate-modal.visible { display: flex; }
  .duplicate-content {
    background: var(--surface);
    border: 2px solid #ffaa00;
    border-radius: 20px;
    padding: 24px;
    max-width: 360px;
    width: 100%;
    text-align: center;
  }
  .duplicate-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }
  .duplicate-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text);
  }
  .duplicate-subtitle {
    font-size: 14px;
    color: var(--text-dim);
    margin-bottom: 16px;
  }
  .duplicate-match {
    background: var(--bg);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 20px;
    text-align: left;
  }
  .duplicate-match-row {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    margin-bottom: 8px;
  }
  .duplicate-match-row:last-child { margin-bottom: 0; }
  .duplicate-match-label { color: var(--text-dim); }
  .duplicate-actions {
    display: flex;
    gap: 12px;
  }
  .duplicate-btn {
    flex: 1;
    padding: 14px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
  }
  .duplicate-btn.secondary {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .duplicate-btn.primary {
    background: #ffaa00;
    color: #000;
  }
</style>

<script>
let allReceipts = [];
let currentFilter = 'pending';  // Default to inbox
let pendingAccept = null; // Store pending accept data for duplicate handling

// Load receipts on page load
document.addEventListener('DOMContentLoaded', () => {
  // Set pending as active by default
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  document.querySelector('.chip[data-filter="pending"]')?.classList.add('active');
  loadReceipts();
});

async function loadReceipts() {
  try {
    const response = await fetch('/api/incoming/receipts?status=all&limit=500', {
      credentials: 'include'
    });
    const data = await response.json();

    if (data.ok) {
      allReceipts = data.receipts;
      updateStats(data.counts);
      renderTable();
    } else {
      showToast(data.error || 'Failed to load receipts', 'error');
    }
  } catch (e) {
    console.error('Load error:', e);
    showToast('Error loading receipts', 'error');
  }
}

function updateStats(counts) {
  // Update dashboard stats
  document.getElementById('stat-pending').textContent = counts.pending || 0;
  document.getElementById('stat-accepted').textContent = counts.accepted || 0;
  document.getElementById('stat-rejected').textContent = counts.rejected || 0;
  document.getElementById('stat-total').textContent = allReceipts.length || 0;

  // Update chip counts
  const chipPending = document.getElementById('chip-pending');
  const chipAccepted = document.getElementById('chip-accepted');
  const chipRejected = document.getElementById('chip-rejected');
  if (chipPending) chipPending.textContent = counts.pending || 0;
  if (chipAccepted) chipAccepted.textContent = counts.accepted || 0;
  if (chipRejected) chipRejected.textContent = counts.rejected || 0;
}

function renderTable() {
  const content = document.getElementById('content');

  if (allReceipts.length === 0) {
    content.innerHTML = `
      <div class="empty-state">
        <h3>No receipts found</h3>
        <p>Click "Scan Now" to search for new receipts in your Gmail accounts.</p>
      </div>
    `;
    renderMobileCards(); // Also render mobile empty state
    return;
  }

  const tableHTML = `
    <table>
      <thead>
        <tr>
          <th style="width: 35%">Subject & Details</th>
          <th style="width: 15%">Merchant</th>
          <th style="width: 10%">Amount</th>
          <th style="width: 12%">From</th>
          <th style="width: 10%">Date</th>
          <th style="width: 8%">Score</th>
          <th style="width: 10%">Actions</th>
        </tr>
      </thead>
      <tbody>
        ${allReceipts.map(r => renderRow(r)).join('')}
      </tbody>
    </table>
  `;

  content.innerHTML = tableHTML;
  renderMobileCards(); // Render mobile cards too
  applyFilter();
}

// Mobile Card Rendering
function renderMobileCards() {
  const container = document.getElementById('mobile-inbox');
  if (!container) return;

  // Filter receipts based on current filter
  const filtered = allReceipts.filter(r => {
    if (currentFilter === 'all') return true;
    return r.status === currentFilter;
  });

  if (filtered.length === 0) {
    let emptyTitle = 'No Receipts';
    let emptyText = 'No receipts found';
    let emptyIcon = 'üì¨';

    if (currentFilter === 'pending') {
      emptyTitle = 'Inbox Clear';
      emptyText = 'All receipts matched to expenses';
      emptyIcon = '‚ú®';
    } else if (currentFilter === 'accepted') {
      emptyTitle = 'No Matched Receipts';
      emptyText = 'Match receipts from your inbox to expenses';
      emptyIcon = 'üîó';
    } else if (currentFilter === 'rejected') {
      emptyTitle = 'Nothing Dismissed';
      emptyText = 'Dismissed receipts will appear here';
      emptyIcon = '‚úï';
    }

    container.innerHTML = `
      <div class="inbox-empty">
        <div class="inbox-empty-icon">${emptyIcon}</div>
        <div class="inbox-empty-title">${emptyTitle}</div>
        <div class="inbox-empty-text">${emptyText}</div>
      </div>
    `;
    return;
  }

  container.innerHTML = filtered.map(r => renderMobileCard(r)).join('');
}

function renderMobileCard(receipt) {
  const merchant = receipt.merchant || extractMerchantFromSubject(receipt.subject);
  const amount = parseFloat(receipt.amount) || 0;
  const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');

  // Format date as "Month Day, Year"
  const dateStr = receipt.receipt_date || receipt.received_date || '';
  const formattedDate = formatDateFull(dateStr);

  // Sender name
  const senderName = extractSenderName(receipt.from_email);

  // Amount display
  let amountDisplay = '';
  let amountClass = '';
  if (amount > 0) {
    if (isRefund) {
      amountDisplay = `+$${amount.toFixed(2)}`;
      amountClass = 'refund';
    } else {
      amountDisplay = `-$${amount.toFixed(2)}`;
      amountClass = 'charge';
    }
  }

  // Confidence score
  const score = receipt.confidence_score || 0;
  const scoreClass = score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';

  // Description (AI analysis or subject snippet)
  const description = receipt.description || receipt.body_snippet || '';

  // Receipt date for accept function
  const receiptDate = receipt.receipt_date || receipt.received_date || '';

  // Actions based on status
  let actionsHTML = '';
  if (receipt.status === 'pending') {
    // Check for potential expense matches
    const bestMatch = receipt.best_match;
    const hasMatch = bestMatch && bestMatch.score >= 50;

    let matchBadge = '';
    let primaryAction = '';

    if (hasMatch) {
      // Found a matching expense - show "Attach" as primary action
      const matchMerchant = bestMatch.merchant || 'Expense';
      const matchAmount = Math.abs(bestMatch.amount).toFixed(2);
      matchBadge = `
        <div class="inbox-card-match found">
          <span class="match-icon">üîó</span>
          <span>Matches: ${escapeHtml(matchMerchant)} $${matchAmount}</span>
        </div>
      `;
      primaryAction = `
        <button class="inbox-card-btn accept match" onclick="event.stopPropagation();attachToExpense(${receipt.id}, ${bestMatch.id}, this)">
          üîó Attach
        </button>
      `;
    } else {
      // No match found
      matchBadge = `
        <div class="inbox-card-match none">
          <span class="match-icon">‚ùì</span>
          <span>No matching expense</span>
        </div>
      `;
      primaryAction = `
        <button class="inbox-card-btn accept create" onclick="event.stopPropagation();mobileAccept(${receipt.id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}', this)">
          + New Expense
        </button>
      `;
    }

    actionsHTML = `
      ${matchBadge}
      <div class="inbox-card-actions">
        <button class="inbox-card-btn preview" onclick="event.stopPropagation();showPreview(${receipt.id})">
          üëÅÔ∏è
        </button>
        <button class="inbox-card-btn reject" onclick="event.stopPropagation();mobileReject(${receipt.id}, this)">
          ‚úï Not Receipt
        </button>
        ${primaryAction}
      </div>
    `;
  } else {
    const statusIcon = receipt.status === 'accepted' ? '‚úì' : '‚úï';
    const statusText = receipt.status === 'accepted' ? 'Matched' : 'Dismissed';
    actionsHTML = `
      <div class="inbox-card-status ${receipt.status}">
        ${statusIcon} ${statusText}
      </div>
    `;
  }

  return `
    <div class="inbox-card ${receipt.status}" data-id="${receipt.id}" onclick="showPreview(${receipt.id})">
      <div class="inbox-card-header">
        <div class="inbox-card-date">${formattedDate}</div>
        <div class="inbox-card-score ${scoreClass}">${score}%</div>
      </div>
      <div class="inbox-card-merchant">${escapeHtml(merchant)}</div>
      ${amountDisplay ? `<div class="inbox-card-amount ${amountClass}">${amountDisplay}</div>` : ''}
      <div class="inbox-card-meta">
        <div class="inbox-card-sender">
          <span class="inbox-card-sender-icon">‚úâÔ∏è</span>
          ${escapeHtml(senderName)}
        </div>
      </div>
      ${description ? `<div class="inbox-card-desc">${escapeHtml(description)}</div>` : ''}
      ${actionsHTML}
    </div>
  `;
}

// Format date as "Month Day, Year"
function formatDateFull(dateStr) {
  if (!dateStr) return 'Unknown Date';
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric'
    });
  } catch {
    return dateStr;
  }
}

// Mobile accept with visual feedback and duplicate detection
async function mobileAccept(id, merchant, amount, isRefund, receiptDate, btn) {
  const card = btn.closest('.inbox-card');
  const actionsDiv = card.querySelector('.inbox-card-actions');

  // Show loading state
  actionsDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--brand)">
      <span class="spinner"></span> Checking...
    </div>
  `;

  const transDate = receiptDate ? receiptDate.split('T')[0] : new Date().toISOString().split('T')[0];

  try {
    // First check for duplicates
    const dupResponse = await fetch('/api/incoming/check-duplicate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ merchant, amount: amount || 0, date: transDate })
    });

    const dupData = await dupResponse.json();

    if (dupData.has_duplicates && dupData.duplicates.length > 0) {
      // Show duplicate warning modal
      const dup = dupData.duplicates[0];
      document.getElementById('dup-merchant').textContent = dup.merchant;
      document.getElementById('dup-amount').textContent = '$' + parseFloat(dup.amount).toFixed(2);
      document.getElementById('dup-date').textContent = dup.date;
      document.getElementById('dup-has-receipt').textContent = dup.has_receipt ? 'Yes ‚úì' : 'No';

      // Store pending accept data
      pendingAccept = {
        id, merchant, amount, isRefund, transDate, card, actionsDiv,
        duplicateId: dup.id,
        callback: (forceAccept) => {
          if (forceAccept) {
            doAccept(id, merchant, amount, isRefund, transDate, card, actionsDiv);
          } else {
            renderMobileCards();
          }
        }
      };

      document.getElementById('duplicate-modal').classList.add('visible');
      return;
    }

    // No duplicates - proceed with accept
    await doAccept(id, merchant, amount, isRefund, transDate, card, actionsDiv);

  } catch (e) {
    console.error('Accept error:', e);
    showToast('Error accepting', 'error');
    renderMobileCards();
  }
}

// Close duplicate modal
function closeDuplicateModal() {
  document.getElementById('duplicate-modal').classList.remove('visible');
}

// Attach receipt to existing transaction
async function attachToExisting() {
  if (!pendingAccept) return;

  const { id, duplicateId, card, actionsDiv, merchant } = pendingAccept;

  actionsDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--brand)">
      <span class="spinner"></span> Attaching...
    </div>
  `;

  try {
    // Call API to attach receipt to existing transaction
    const response = await fetch('/api/incoming/attach-to-transaction', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({
        receipt_id: id,
        transaction_id: duplicateId
      })
    });

    const data = await response.json();

    if (data.ok) {
      card.style.transition = 'all 0.3s ease';
      card.style.background = 'rgba(0,255,136,0.1)';
      card.classList.remove('pending');
      card.classList.add('accepted');

      actionsDiv.innerHTML = `
        <div class="inbox-card-status accepted">
          ‚úì Attached to #${duplicateId}
        </div>
      `;

      showToast(`‚úì Receipt attached to existing transaction`, 'success');

      const receipt = allReceipts.find(r => r.id === id);
      if (receipt) receipt.status = 'accepted';

      if (currentFilter === 'pending') {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateX(100px)';
          setTimeout(() => card.remove(), 300);
        }, 500);
      }

      loadReceipts();
    } else {
      showToast(data.error || 'Failed to attach', 'error');
      renderMobileCards();
    }
  } catch (e) {
    console.error('Attach error:', e);
    showToast('Error attaching receipt', 'error');
    renderMobileCards();
  }

  pendingAccept = null;
}

// Attach receipt to a matched expense (from match badge)
async function attachToExpense(receiptId, transactionId, btn) {
  const card = btn.closest('.inbox-card');
  const actionsDiv = card.querySelector('.inbox-card-actions');
  const matchBadge = card.querySelector('.inbox-card-match');

  // Show loading state
  if (actionsDiv) {
    actionsDiv.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--brand)">
        <span class="spinner"></span> Attaching...
      </div>
    `;
  }
  if (matchBadge) {
    matchBadge.innerHTML = `
      <span class="match-icon">‚è≥</span>
      <span>Linking receipt to expense...</span>
    `;
  }

  try {
    const response = await fetch('/api/incoming/attach-to-transaction', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({
        receipt_id: receiptId,
        transaction_id: transactionId
      })
    });

    const data = await response.json();

    if (data.ok) {
      // Success animation
      card.style.transition = 'all 0.3s ease';
      card.style.background = 'rgba(0,255,136,0.1)';
      card.classList.remove('pending');
      card.classList.add('accepted');

      // Update match badge to show success
      if (matchBadge) {
        matchBadge.className = 'inbox-card-match found';
        matchBadge.innerHTML = `
          <span class="match-icon">‚úì</span>
          <span>Linked to expense #${transactionId}</span>
        `;
      }

      // Update actions to show completed status
      if (actionsDiv) {
        actionsDiv.innerHTML = `
          <div class="inbox-card-status accepted">
            ‚úì Matched
          </div>
        `;
      }

      showToast(`‚úì Receipt attached to expense #${transactionId}`, 'success');

      // Update local data
      const receipt = allReceipts.find(r => r.id === receiptId);
      if (receipt) receipt.status = 'accepted';

      // Fade out if viewing pending only
      if (currentFilter === 'pending') {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateX(100px)';
          setTimeout(() => card.remove(), 300);
        }, 800);
      }

      // Refresh to update stats
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to attach', 'error');
      renderMobileCards();
    }
  } catch (e) {
    console.error('Attach error:', e);
    showToast('Error attaching receipt', 'error');
    renderMobileCards();
  }
}

// Perform the actual accept
async function doAccept(id, merchant, amount, isRefund, transDate, card, actionsDiv) {
  actionsDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--brand)">
      <span class="spinner"></span> Processing...
    </div>
  `;

  try {
    const response = await fetch('/api/incoming/accept', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({
        receipt_id: id,
        merchant: merchant,
        amount: amount || 0,
        is_refund: isRefund,
        date: transDate,
        business_type: 'Personal'
      })
    });

    const data = await response.json();

    if (data.ok) {
      // Success animation
      card.style.transition = 'all 0.3s ease';
      card.style.background = 'rgba(0,255,136,0.1)';
      card.classList.remove('pending');
      card.classList.add('accepted');

      actionsDiv.innerHTML = `
        <div class="inbox-card-status accepted">
          ‚úì Accepted ${data.transaction_id ? `#${data.transaction_id}` : ''}
        </div>
      `;

      showToast(`‚úì ${merchant} accepted!`, 'success');

      // Update local data
      const receipt = allReceipts.find(r => r.id === id);
      if (receipt) receipt.status = 'accepted';

      // Fade out if viewing pending only
      if (currentFilter === 'pending') {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateX(100px)';
          setTimeout(() => card.remove(), 300);
        }, 500);
      }

      // Refresh stats
      loadReceipts();
    } else {
      showToast(data.error || 'Failed', 'error');
      renderMobileCards();
    }
  } catch (e) {
    console.error('Accept error:', e);
    showToast('Error accepting', 'error');
    renderMobileCards();
  }
}

// Mobile reject with visual feedback
async function mobileReject(id, btn) {
  const card = btn.closest('.inbox-card');
  const actionsDiv = card.querySelector('.inbox-card-actions');

  // Show loading state
  actionsDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--muted)">
      <span class="spinner"></span> Rejecting...
    </div>
  `;

  try {
    const response = await fetch('/api/incoming/reject', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ receipt_id: id })
    });

    const data = await response.json();

    if (data.ok) {
      // Fade out animation
      card.style.transition = 'all 0.3s ease';
      card.style.opacity = '0';
      card.style.transform = 'translateX(-100px)';

      setTimeout(() => {
        card.remove();

        // Update local data
        const receipt = allReceipts.find(r => r.id === id);
        if (receipt) receipt.status = 'rejected';

        // Check if list is now empty
        const container = document.getElementById('mobile-inbox');
        if (container && container.children.length === 0) {
          renderMobileCards();
        }
      }, 300);

      showToast('Rejected', 'info');
      loadReceipts();
    } else {
      showToast(data.error || 'Failed', 'error');
      renderMobileCards();
    }
  } catch (e) {
    console.error('Reject error:', e);
    showToast('Error rejecting', 'error');
    renderMobileCards();
  }
}

async function quickUnreject(id) {
  try {
    const res = await fetch(`${API_BASE}/api/incoming/unreject`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ receipt_id: id })
    });
    const data = await res.json();
    if (data.ok) {
      // Update local data
      const receipt = allReceipts.find(r => r.id === id);
      if (receipt) receipt.status = 'pending';

      showToast('Restored to pending', 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to unreject', 'error');
    }
  } catch (e) {
    console.error('Unreject error:', e);
    showToast('Error unrejecting', 'error');
  }
}

function renderRow(receipt) {
  const confidenceClass = receipt.confidence_score >= 80 ? 'confidence-high' :
                          receipt.confidence_score >= 60 ? 'confidence-medium' : 'confidence-low';

  const merchant = receipt.merchant || extractMerchantFromSubject(receipt.subject);

  // Format amount: charges are negative (-), refunds are positive
  let amountDisplay = '';
  let amountColor = 'var(--ok)';  // Green for refunds
  const amount = parseFloat(receipt.amount) || 0;
  if (amount > 0) {
    const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');
    if (isRefund) {
      amountDisplay = `+$${amount.toFixed(2)}`;
      amountColor = 'var(--ok)';  // Green for refunds (money back)
    } else {
      amountDisplay = `-$${amount.toFixed(2)}`;
      amountColor = 'var(--bad)';  // Red for charges (money spent)
    }
  }
  const date = formatDate(receipt.received_date);

  // Match badge
  let matchBadge = '';
  if (receipt.match_type === 'needs_receipt' && receipt.matched_transaction_id) {
    matchBadge = `<div class="match-badge">üìé Attach to #${receipt.matched_transaction_id}</div>`;
  }

  // AI description
  let description = '';
  if (receipt.description) {
    description = `<div class="description">${escapeHtml(receipt.description)}</div>`;
  }

  // Check if refund for quickAccept
  const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');

  // Get the actual receipt date (use receipt_date if available, otherwise received_date)
  const receiptDate = receipt.receipt_date || receipt.received_date || '';

  // Actions - include preview button
  const previewBtn = `<button class="preview-btn" onclick="event.stopPropagation();showPreview(${receipt.id})" title="Preview">üëÅÔ∏è</button>`;
  const actions = receipt.status === 'pending'
    ? `${previewBtn}
       <button class="btn-success btn-sm" onclick="event.stopPropagation();quickAccept(${receipt.id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}')">‚úì</button>
       <button class="btn-danger btn-sm" onclick="event.stopPropagation();quickReject(${receipt.id})">‚úó</button>`
    : `${previewBtn}<span style="color:var(--muted);font-size:11px;margin-left:8px">${receipt.status === 'accepted' ? '‚úì Accepted' : '‚úó Rejected'}</span>`;

  // Parse sender info
  const fromEmail = receipt.from_email || '';
  const senderName = extractSenderName(fromEmail);

  // Attachment count
  let attachmentCount = 0;
  try {
    const atts = typeof receipt.attachments === 'string' ? JSON.parse(receipt.attachments) : (receipt.attachments || []);
    attachmentCount = atts.length;
  } catch(e) {}
  const attachmentBadge = attachmentCount > 0 ? `<span class="attachment-badge">üìé ${attachmentCount}</span>` : '';

  return `
    <tr data-status="${receipt.status}" data-id="${receipt.id}" class="clickable" onclick="showPreview(${receipt.id})">
      <td>
        <div style="font-weight:500">${escapeHtml(receipt.subject)}</div>
        <div class="snippet">${escapeHtml(receipt.body_snippet || '')}</div>
        ${description}
        ${matchBadge}
        ${attachmentBadge}
      </td>
      <td style="font-weight:500">${escapeHtml(merchant)}</td>
      <td style="font-weight:600;color:${amountColor}">${amountDisplay}</td>
      <td>
        <div class="sender-info">
          <span class="sender-name">${escapeHtml(senderName)}</span>
          <span class="sender-email">${escapeHtml(fromEmail)}</span>
        </div>
      </td>
      <td style="color:var(--muted);font-size:12px">${date}</td>
      <td><span class="confidence-badge ${confidenceClass}">${receipt.confidence_score}%</span></td>
      <td onclick="event.stopPropagation()">${actions}</td>
    </tr>
  `;
}

function extractSenderName(email) {
  if (!email) return 'Unknown';
  // Extract display name from "Name <email>" format
  const match = email.match(/^([^<]+)</);
  if (match) return match[1].trim();
  // Otherwise extract username from email
  return email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function extractMerchantFromSubject(subject) {
  const patterns = [
    /receipt from ([^#\n]+)/i,
    /invoice from ([^#\n]+)/i,
    /payment (?:to|from) ([^#\n]+)/i,
    /your ([^#\n]+?) (?:receipt|invoice)/i,
  ];

  for (const pattern of patterns) {
    const match = subject.match(pattern);
    if (match) return match[1].trim().split('#')[0].trim();
  }
  return 'Unknown';
}

async function quickAccept(id, merchant, amount, isRefund = false, receiptDate = '') {
  const row = document.querySelector(`tr[data-id="${id}"]`);
  const actionsCell = row.querySelector('td:last-child');

  // Show processing state with spinner
  actionsCell.innerHTML = '<span style="color:var(--brand);font-size:11px;display:flex;align-items:center;gap:4px"><span class="spinner"></span> Creating transaction...</span>';

  // Use actual receipt date, fallback to today if not provided
  const transDate = receiptDate ? receiptDate.split('T')[0] : new Date().toISOString().split('T')[0];

  try {
    const response = await fetch('/api/incoming/accept', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({
        receipt_id: id,
        merchant: merchant,
        amount: amount || 0,
        is_refund: isRefund,
        date: transDate,
        business_type: 'Personal'
      })
    });

    const data = await response.json();

    if (data.ok) {
      // Show success with transaction details
      const actionText = data.action === 'attached' ? 'Attached to existing' : 'New transaction';
      const txnId = data.transaction_id ? ` #${data.transaction_id}` : '';
      // Format amount with proper sign: - for charges, + for refunds
      const amountSign = isRefund ? '+' : '-';
      const amountStr = amount ? ` (${amountSign}$${parseFloat(amount).toFixed(2)})` : '';

      // Update cell with complete status
      actionsCell.innerHTML = `<span style="color:var(--ok);font-size:11px;font-weight:600">‚úÖ Complete${txnId}</span>`;

      // Show detailed toast
      showToast(`‚úÖ Complete! ${actionText}${txnId} - ${merchant}${amountStr}`, 'success');

      // Highlight row briefly
      row.style.backgroundColor = 'rgba(47,255,162,.1)';
      row.setAttribute('data-status', 'accepted');

      // Fade highlight after 2 seconds
      setTimeout(() => {
        row.style.backgroundColor = '';
      }, 2000);

      // Refresh stats
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to accept', 'error');
      actionsCell.innerHTML = `<button class="btn-success btn-sm" onclick="quickAccept(${id}, '${merchant}', ${amount}, ${isRefund})">‚úì</button>
                               <button class="btn-danger btn-sm" onclick="quickReject(${id})">‚úó</button>`;
    }
  } catch (e) {
    console.error('Accept error:', e);
    showToast('Error accepting receipt', 'error');
    actionsCell.innerHTML = `<button class="btn-success btn-sm" onclick="quickAccept(${id}, '${merchant}', ${amount}, ${isRefund})">‚úì</button>
                             <button class="btn-danger btn-sm" onclick="quickReject(${id})">‚úó</button>`;
  }
}

async function quickReject(id) {
  const row = document.querySelector(`tr[data-id="${id}"]`);
  const actionsCell = row.querySelector('td:last-child');
  actionsCell.innerHTML = '<span style="color:var(--muted);font-size:11px">Processing...</span>';

  try {
    const response = await fetch('/api/incoming/reject', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ receipt_id: id })
    });

    const data = await response.json();

    if (data.ok) {
      showToast('Rejected', 'info');

      // Fade out and remove the row
      row.style.transition = 'opacity 0.3s ease';
      row.style.opacity = '0';
      setTimeout(() => {
        row.remove();
        // Update the receipt from allReceipts array
        const receiptIndex = allReceipts.findIndex(r => r.id === id);
        if (receiptIndex !== -1) {
          allReceipts[receiptIndex].status = 'rejected';
        }
        updateStats();
      }, 300);
    } else {
      showToast(data.error || 'Failed to reject', 'error');
    }
  } catch (e) {
    console.error('Reject error:', e);
    showToast('Error rejecting receipt', 'error');
  }
}

function filterStatus(status) {
  currentFilter = status;

  // Update chip states using data-filter attribute (handles clicks on child elements)
  document.querySelectorAll('.chip').forEach(chip => {
    chip.classList.remove('active');
    if (chip.getAttribute('data-filter') === status) {
      chip.classList.add('active');
    }
  });

  applyFilter();
}

function applyFilter() {
  // Apply to table rows
  const rows = document.querySelectorAll('tbody tr');
  rows.forEach(row => {
    const rowStatus = row.getAttribute('data-status');
    if (currentFilter === 'all' || rowStatus === currentFilter) {
      row.classList.remove('hidden');
    } else {
      row.classList.add('hidden');
    }
  });

  // Also re-render mobile cards
  renderMobileCards();
}

async function scanForNew() {
  showToast('Scanning Gmail accounts...', 'info');

  try {
    const response = await fetch('/api/incoming/scan', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({})
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Found ${data.results.total_new} new receipts!`, 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Scan failed', 'error');
    }
  } catch (e) {
    console.error('Scan error:', e);
    showToast('Error scanning Gmail', 'error');
  }
}

async function clearFiltered() {
  if (!confirm('Remove all rejected receipts from the database?')) return;

  try {
    const response = await fetch('/api/incoming/clear-rejected', {
      method: 'POST',
      credentials: 'include'
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Cleared ${data.count} rejected receipts`, 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to clear', 'error');
    }
  } catch (e) {
    showToast('Error clearing receipts', 'error');
  }
}

async function reprocessMissing() {
  showToast('Re-processing accepted receipts with missing files...', 'info');

  try {
    const response = await fetch('/api/incoming/reprocess-missing', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({})
    });

    const data = await response.json();

    if (data.ok) {
      if (data.processed === 0) {
        showToast('All accepted receipts already have files!', 'success');
      } else {
        showToast(`Fixed ${data.success} of ${data.processed} receipts`, 'success');
      }
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to reprocess', 'error');
    }
  } catch (e) {
    console.error('Reprocess error:', e);
    showToast('Error reprocessing receipts', 'error');
  }
}

async function fixDates() {
  // First do a dry run to show what will be fixed
  showToast('Checking for transactions with wrong dates...', 'info');

  try {
    const dryRunResponse = await fetch('/api/incoming/fix-dates', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ dry_run: true })
    });

    const dryRunData = await dryRunResponse.json();

    if (!dryRunData.ok) {
      showToast(dryRunData.error || 'Failed to check dates', 'error');
      return;
    }

    if (dryRunData.found === 0) {
      showToast('All transaction dates are correct!', 'success');
      return;
    }

    // Show confirmation with details
    const details = dryRunData.results.map(r =>
      `${r.merchant}: ${r.old_date} -> ${r.new_date}`
    ).join('\n');

    if (!confirm(`Found ${dryRunData.found} transaction(s) with wrong dates:\n\n${details}\n\nFix them?`)) {
      return;
    }

    // Actually fix the dates
    showToast('Fixing transaction dates...', 'info');
    const response = await fetch('/api/incoming/fix-dates', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ dry_run: false })
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Fixed ${data.fixed} transaction dates!`, 'success');
    } else {
      showToast(data.error || 'Failed to fix dates', 'error');
    }
  } catch (e) {
    console.error('Fix dates error:', e);
    showToast('Error fixing dates', 'error');
  }
}

function formatDate(dateStr) {
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch {
    return dateStr;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;

  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// Preview Modal Functions
let currentPreviewReceipt = null;

function showPreview(receiptId) {
  const receipt = allReceipts.find(r => r.id === receiptId);
  if (!receipt) return;

  currentPreviewReceipt = receipt;
  const modal = document.getElementById('preview-modal');

  // Populate the modal
  document.getElementById('preview-subject').textContent = receipt.subject || 'No subject';
  document.getElementById('preview-from').textContent = receipt.from_email || 'Unknown sender';

  // Format amount
  const amount = parseFloat(receipt.amount) || 0;
  const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');
  const amountEl = document.getElementById('preview-amount');
  if (amount > 0) {
    if (isRefund) {
      amountEl.textContent = `+$${amount.toFixed(2)}`;
      amountEl.className = 'preview-meta-value large amount-refund';
    } else {
      amountEl.textContent = `-$${amount.toFixed(2)}`;
      amountEl.className = 'preview-meta-value large amount-charge';
    }
  } else {
    amountEl.textContent = 'Not detected';
    amountEl.className = 'preview-meta-value large';
  }

  // Merchant
  const merchant = receipt.merchant || extractMerchantFromSubject(receipt.subject);
  document.getElementById('preview-merchant').textContent = merchant;

  // Date
  const dateStr = receipt.receipt_date || receipt.received_date;
  document.getElementById('preview-date').textContent = dateStr ? formatDate(dateStr) : 'Unknown';

  // AI Notes / Description
  const aiSection = document.getElementById('preview-ai-section');
  if (receipt.description || receipt.ai_notes) {
    aiSection.style.display = 'block';
    document.getElementById('preview-ai-notes').textContent = receipt.description || receipt.ai_notes;
  } else {
    aiSection.style.display = 'none';
  }

  // Body snippet
  document.getElementById('preview-body').textContent = receipt.body_snippet || 'No preview available';

  // Attachments
  const attachmentsSection = document.getElementById('preview-attachments-section');
  const attachmentsEl = document.getElementById('preview-attachments');
  let attachments = [];
  try {
    attachments = typeof receipt.attachments === 'string' ? JSON.parse(receipt.attachments) : (receipt.attachments || []);
  } catch(e) {}

  if (attachments.length > 0) {
    attachmentsSection.style.display = 'block';
    attachmentsEl.innerHTML = attachments.map(att => {
      const name = typeof att === 'string' ? att : (att.filename || att.name || 'Attachment');
      const icon = getAttachmentIcon(name);
      return `<div class="preview-attachment"><span class="preview-attachment-icon">${icon}</span> ${escapeHtml(name)}</div>`;
    }).join('');
  } else {
    attachmentsSection.style.display = 'none';
  }

  // Account badge
  const accountBadgeEl = document.getElementById('preview-account-badge');
  const gmailAccount = receipt.gmail_account || '';
  let accountClass = 'personal';
  let accountLabel = gmailAccount.split('@')[0] || 'Unknown';
  if (gmailAccount.includes('musiccity')) {
    accountClass = 'mcr';
    accountLabel = 'MCR';
  } else if (gmailAccount.includes('downhome')) {
    accountClass = 'downhome';
    accountLabel = 'DownHome';
  }
  accountBadgeEl.innerHTML = `<span class="account-badge ${accountClass}">${accountLabel}</span>`;

  // Actions
  const actionsEl = document.getElementById('preview-actions');
  const receiptDate = receipt.receipt_date || receipt.received_date || '';
  if (receipt.status === 'pending') {
    actionsEl.innerHTML = `
      <button class="btn-danger" onclick="closePreview();quickReject(${receipt.id})">‚úï Reject</button>
      <button class="btn-success" onclick="closePreview();quickAccept(${receipt.id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}')">‚úì Accept</button>
    `;
  } else if (receipt.status === 'rejected') {
    actionsEl.innerHTML = `
      <button class="btn-primary" onclick="closePreview();quickUnreject(${receipt.id})">‚Ü© Restore to Pending</button>
      <span style="color:var(--muted);margin-left:8px">‚úï Rejected</span>
    `;
  } else {
    actionsEl.innerHTML = `<span style="color:var(--muted)">‚úì Accepted</span>`;
  }

  // Show modal
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closePreview() {
  const modal = document.getElementById('preview-modal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  currentPreviewReceipt = null;
}

function getAttachmentIcon(filename) {
  const ext = (filename || '').split('.').pop().toLowerCase();
  switch(ext) {
    case 'pdf': return 'üìÑ';
    case 'png': case 'jpg': case 'jpeg': case 'gif': case 'webp': return 'üñºÔ∏è';
    case 'html': case 'htm': return 'üåê';
    default: return 'üìé';
  }
}

// Keyboard navigation
let currentRowIndex = -1;

document.addEventListener('keydown', (e) => {
  // Handle preview modal shortcuts
  if (document.getElementById('preview-modal').classList.contains('active')) {
    if (e.key === 'Escape') {
      closePreview();
    } else if (currentPreviewReceipt && currentPreviewReceipt.status === 'pending') {
      if (e.key === 'Enter' || e.key === 'a' || e.key === 'A') {
        const r = currentPreviewReceipt;
        const merchant = r.merchant || extractMerchantFromSubject(r.subject);
        const amount = parseFloat(r.amount) || 0;
        const isRefund = r.is_refund || (r.subject || '').toLowerCase().includes('refund');
        const receiptDate = r.receipt_date || r.received_date || '';
        closePreview();
        quickAccept(r.id, merchant, amount, isRefund, receiptDate);
      } else if (e.key === 'r' || e.key === 'R' || e.key === 'Backspace') {
        closePreview();
        quickReject(currentPreviewReceipt.id);
      }
    }
    return;
  }

  // Global shortcuts
  const key = e.key.toLowerCase();

  // J/K for navigation (like vim)
  if (key === 'j' || e.key === 'ArrowDown') {
    e.preventDefault();
    navigateRows(1);
  } else if (key === 'k' || e.key === 'ArrowUp') {
    e.preventDefault();
    navigateRows(-1);
  }
  // / for search focus
  else if (key === '/') {
    e.preventDefault();
    const searchInput = document.querySelector('input[type="search"], input[placeholder*="Search"]');
    if (searchInput) searchInput.focus();
  }
  // Enter to open preview on selected row
  else if (key === 'enter' && currentRowIndex >= 0) {
    const visibleReceipts = getVisibleReceipts();
    if (visibleReceipts[currentRowIndex]) {
      showPreview(visibleReceipts[currentRowIndex].id);
    }
  }
  // Shift+A to batch accept all visible
  else if (key === 'a' && e.shiftKey) {
    e.preventDefault();
    batchAcceptVisible();
  }
  // ? for help
  else if (key === '?') {
    e.preventDefault();
    showKeyboardHelp();
  }
});

function getVisibleReceipts() {
  return allReceipts.filter(r => {
    if (currentFilter === 'all') return true;
    return r.status === currentFilter;
  });
}

function navigateRows(direction) {
  const visibleReceipts = getVisibleReceipts();
  if (visibleReceipts.length === 0) return;

  currentRowIndex = Math.max(0, Math.min(visibleReceipts.length - 1, currentRowIndex + direction));

  // Highlight current row
  const rows = document.querySelectorAll('tbody tr:not(.hidden)');
  rows.forEach((row, i) => {
    if (i === currentRowIndex) {
      row.style.background = 'rgba(0,255,136,0.1)';
      row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
      row.style.background = '';
    }
  });
}

async function batchAcceptVisible() {
  const pending = allReceipts.filter(r => r.status === 'pending');
  if (pending.length === 0) {
    showToast('No pending receipts to accept', 'info');
    return;
  }

  if (!confirm(`Accept all ${pending.length} pending receipts?`)) return;

  showToast(`Processing ${pending.length} receipts...`, 'info');
  let success = 0;

  for (const r of pending) {
    const merchant = r.merchant || extractMerchantFromSubject(r.subject);
    const amount = parseFloat(r.amount) || 0;
    const isRefund = r.is_refund || (r.subject || '').toLowerCase().includes('refund');
    const receiptDate = r.receipt_date || r.received_date || '';

    try {
      const response = await fetch('/api/incoming/accept', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          receipt_id: r.id,
          merchant,
          amount,
          is_refund: isRefund,
          date: receiptDate ? receiptDate.split('T')[0] : new Date().toISOString().split('T')[0],
          business_type: 'Personal'
        })
      });
      if (response.ok) success++;
    } catch (e) { console.error(e); }
  }

  showToast(`Accepted ${success}/${pending.length} receipts`, 'success');
  loadReceipts();
}

function showKeyboardHelp() {
  const helpHtml = `
    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center" onclick="this.remove()">
      <div style="background:var(--panel);padding:24px;border-radius:12px;max-width:400px" onclick="event.stopPropagation()">
        <h3 style="margin:0 0 16px 0">Keyboard Shortcuts</h3>
        <div style="display:grid;gap:8px;font-size:13px">
          <div><kbd>J</kbd> / <kbd>Down</kbd> - Next row</div>
          <div><kbd>K</kbd> / <kbd>Up</kbd> - Previous row</div>
          <div><kbd>Enter</kbd> - Preview selected</div>
          <div><kbd>A</kbd> - Accept (in preview)</div>
          <div><kbd>R</kbd> - Reject (in preview)</div>
          <div><kbd>Shift+A</kbd> - Batch accept all pending</div>
          <div><kbd>/</kbd> - Focus search</div>
          <div><kbd>Esc</kbd> - Close modal</div>
          <div><kbd>?</kbd> - Show this help</div>
        </div>
        <button style="margin-top:16px;width:100%" class="btn-primary" onclick="this.parentNode.parentNode.remove()">Got it</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', helpHtml);
}
</script>

<!-- Mobile Bottom Navigation -->
<nav class="bottom-nav">
  <a href="/" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
      <polyline points="9 22 9 12 15 12 15 22"/>
    </svg>
    Home
  </a>
  <a href="/viewer" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M9 11l3 3L22 4"/>
      <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
    </svg>
    Reconcile
  </a>
  <a href="/library" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="3" y="3" width="7" height="7"/>
      <rect x="14" y="3" width="7" height="7"/>
      <rect x="14" y="14" width="7" height="7"/>
      <rect x="3" y="14" width="7" height="7"/>
    </svg>
    Library
  </a>
  <a href="/scanner" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
      <circle cx="12" cy="13" r="4"/>
    </svg>
    Scan
  </a>
  <a href="/incoming" class="nav-item active">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
      <path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/>
    </svg>
    Inbox
  </a>
  <a href="/reports" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
      <line x1="16" y1="13" x2="8" y2="13"/>
      <line x1="16" y1="17" x2="8" y2="17"/>
    </svg>
    Reports
  </a>
  <a href="/contacts" class="nav-item">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
      <circle cx="9" cy="7" r="4"/>
      <path d="M23 21v-2a4 4 0 00-3-3.87"/>
      <path d="M16 3.13a4 4 0 010 7.75"/>
    </svg>
    Contacts
  </a>
</nav>

</body>
</html>
