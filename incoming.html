<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="AI-powered receipt management - Incoming receipts processing">
<meta name="theme-color" content="#0b0d10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Inbox - Tallyups</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßæ</text></svg>">
<link rel="stylesheet" href="/static/css/design-system.css">
<link rel="stylesheet" href="/static/css/incoming-extracted.css">
<script src="/static/js/business-types.js"></script>
<script src="/static/js/unified-header.js"></script>
<script src="/static/js/app-shell.js" defer></script>
<script src="/static/js/design-system.js"></script>
</head>
<body>

<!-- Page Toolbar - page-specific actions (header handled by unified-header.js) -->
<div class="page-toolbar" style="display:flex; align-items:center; gap:8px; padding:12px 20px; background:var(--bg-secondary); border-bottom:1px solid var(--border-primary); flex-wrap:wrap;">
  <h2 style="margin:0; font-size:1.25rem; font-weight:600; color:var(--text-primary);">üì• Inbox</h2>
  <div style="flex:1;"></div>
  <button class="btn btn-primary" onclick="scanForNew()">üîÑ Scan Now</button>
  <button class="btn btn-secondary" onclick="regenerateImages()">üñºÔ∏è Fix Images</button>
  <button class="btn btn-secondary" onclick="clearDismissed()" style="background:var(--error); color:white;">üóëÔ∏è Clear Dismissed</button>
  <button class="btn btn-ghost" onclick="rematchAll()">üîó Rematch</button>
  <button class="btn btn-ghost" onclick="cleanSpam()">üßπ Clean</button>
</div>

<!-- Stats Dashboard -->
<div class="dashboard">
  <div class="stat">
    <div class="stat-label">In Inbox</div>
    <div class="stat-value" id="stat-pending">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Matched</div>
    <div class="stat-value" id="stat-accepted">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Dismissed</div>
    <div class="stat-value" id="stat-rejected">0</div>
  </div>
  <div class="stat">
    <div class="stat-label">Total</div>
    <div class="stat-value" id="stat-total">0</div>
  </div>
</div>

<!-- Search & Filters -->
<div class="filters-bar">
  <div class="search-box">
    <span class="search-icon">üîç</span>
    <input type="text" id="search-input" placeholder="Search merchants, emails, amounts..." oninput="handleSearch(this.value)">
    <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display:none">‚úï</button>
  </div>
  <div class="date-filter-row">
    <button class="date-btn" onclick="setDateFilter('today')">Today</button>
    <button class="date-btn" onclick="setDateFilter('week')">This Week</button>
    <button class="date-btn" onclick="setDateFilter('month')">This Month</button>
    <button class="date-btn active" onclick="setDateFilter('all')">All Time</button>
    <div class="date-range">
      <input type="date" id="date-from" onchange="applyDateRange()">
      <span>to</span>
      <input type="date" id="date-to" onchange="applyDateRange()">
    </div>
  </div>
</div>

<!-- Status Filters -->
<div class="filters">
  <div class="chip active" onclick="filterStatus('pending')" data-filter="pending">
    <span class="chip-icon">üì•</span> Inbox
    <span class="chip-count" id="chip-pending">0</span>
  </div>
  <div class="chip" onclick="filterStatus('matched')" data-filter="matched">
    <span class="chip-icon">üîó</span> Matched
    <span class="chip-count" id="chip-matched">0</span>
  </div>
  <div class="chip" onclick="filterStatus('accepted')" data-filter="accepted">
    <span class="chip-icon">‚úì</span> Accepted
    <span class="chip-count" id="chip-accepted">0</span>
  </div>
  <div class="chip" onclick="filterStatus('rejected')" data-filter="rejected">
    <span class="chip-icon">‚úï</span> Dismissed
    <span class="chip-count" id="chip-rejected">0</span>
  </div>
  <div class="chip" onclick="filterStatus('all')" data-filter="all">
    <span class="chip-icon">üìã</span> All
  </div>

  <!-- View Toggle -->
  <div class="view-toggle" style="margin-left:auto">
    <button class="view-toggle-btn active" onclick="setViewMode('list')" title="List View">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/>
        <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
      </svg>
    </button>
    <button class="view-toggle-btn" onclick="setViewMode('grid')" title="Grid View">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
        <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
      </svg>
    </button>
  </div>

  <!-- Keyboard Help -->
  <button class="btn-ghost btn-sm" onclick="showKeyboardHelp()" title="Keyboard Shortcuts" style="padding:8px 10px">
    <kbd style="font-size:12px;background:var(--panel2);padding:2px 6px;border-radius:4px;border:1px solid var(--edge)">?</kbd>
  </button>
</div>

<!-- Content -->
<div class="content" id="content">
  <div class="loading">Loading receipts...</div>
</div>

<!-- Mobile Card View -->
<div class="mobile-inbox" id="mobile-inbox">
  <!-- Cards rendered by JavaScript -->
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Preview Modal -->
<div id="preview-modal" class="preview-modal" onclick="if(event.target===this)closePreview()">
  <div class="preview-content">
    <!-- Left side: Large receipt image -->
    <div class="preview-left">
      <div class="preview-receipt-full" id="preview-image-section">
        <img id="preview-receipt-image" src="" alt="Receipt" onclick="this.classList.toggle('zoomed')">
      </div>
    </div>
    <!-- Right side: Data and actions -->
    <div class="preview-right">
      <div class="preview-header">
        <div class="preview-title" id="preview-subject">Email Subject</div>
        <button class="preview-close" onclick="closePreview()">‚úï</button>
      </div>
      <div class="preview-body">
        <div class="preview-meta">
          <div class="preview-meta-item">
            <div class="preview-meta-label">Amount</div>
            <div class="preview-meta-value large" id="preview-amount">$0.00</div>
          </div>
          <div class="preview-meta-item">
            <div class="preview-meta-label">Date</div>
            <div class="preview-meta-value" id="preview-date">Jan 1, 2025</div>
          </div>
          <div class="preview-meta-item">
            <div class="preview-meta-label">Merchant</div>
            <div class="preview-meta-value" id="preview-merchant">Unknown</div>
          </div>
          <div class="preview-meta-item">
            <div class="preview-meta-label">From</div>
            <div class="preview-meta-value" id="preview-from">sender@email.com</div>
          </div>
        </div>
        <div class="preview-section" id="preview-match-section" style="display:none">
          <div class="preview-section-title">Transaction Match</div>
          <div class="preview-section-content" id="preview-match-status"></div>
        </div>
        <div class="preview-section" id="preview-ai-section" style="display:none">
          <div class="preview-section-title">AI Analysis</div>
          <div class="preview-section-content" id="preview-ai-notes"></div>
        </div>
        <div class="preview-section" id="preview-attachments-section" style="display:none">
          <div class="preview-section-title">Attachments</div>
          <div class="preview-attachments" id="preview-attachments"></div>
        </div>
        <div class="preview-section">
          <div class="preview-section-title">Email Body Preview</div>
          <div class="preview-section-content" id="preview-body">Loading...</div>
        </div>
      </div>
      <div class="preview-footer">
        <div id="preview-account-badge"></div>
        <div class="preview-actions" id="preview-actions"></div>
      </div>
    </div>
  </div>
</div>

<!-- Duplicate Warning Modal -->
<div id="duplicate-modal" class="duplicate-modal">
  <div class="duplicate-content">
    <div class="duplicate-icon">‚ö†Ô∏è</div>
    <div class="duplicate-title">Possible Duplicate</div>
    <div class="duplicate-subtitle">This receipt may match an existing transaction</div>
    <div class="duplicate-match" id="duplicate-match-info">
      <div class="duplicate-match-row">
        <span class="duplicate-match-label">Merchant</span>
        <span id="dup-merchant">‚Äî</span>
      </div>
      <div class="duplicate-match-row">
        <span class="duplicate-match-label">Amount</span>
        <span id="dup-amount">‚Äî</span>
      </div>
      <div class="duplicate-match-row">
        <span class="duplicate-match-label">Date</span>
        <span id="dup-date">‚Äî</span>
      </div>
      <div class="duplicate-match-row">
        <span class="duplicate-match-label">Has Receipt</span>
        <span id="dup-has-receipt">‚Äî</span>
      </div>
    </div>
    <div class="duplicate-actions">
      <button class="duplicate-btn secondary" onclick="closeDuplicateModal();pendingAccept?.callback(true)">Add Anyway</button>
      <button class="duplicate-btn primary" onclick="closeDuplicateModal();attachToExisting()">Attach to Existing</button>
    </div>
  </div>
</div>

<style>
  .duplicate-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(10px);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .duplicate-modal.visible { display: flex; }
  .duplicate-content {
    background: var(--surface);
    border: 2px solid #ffaa00;
    border-radius: 20px;
    padding: 24px;
    max-width: 360px;
    width: 100%;
    text-align: center;
  }
  .duplicate-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }
  .duplicate-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text);
  }
  .duplicate-subtitle {
    font-size: 14px;
    color: var(--text-dim);
    margin-bottom: 16px;
  }
  .duplicate-match {
    background: var(--bg);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 20px;
    text-align: left;
  }
  .duplicate-match-row {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    margin-bottom: 8px;
  }
  .duplicate-match-row:last-child { margin-bottom: 0; }
  .duplicate-match-label { color: var(--text-dim); }
  .duplicate-actions {
    display: flex;
    gap: 12px;
  }
  .duplicate-btn {
    flex: 1;
    padding: 14px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
  }
  .duplicate-btn.secondary {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .duplicate-btn.primary {
    background: #ffaa00;
    color: #000;
  }
</style>

<script>
// Theme toggle functionality - uses unified 'tallyups-theme' key
function toggleTheme() {
  const root = document.documentElement;
  const currentTheme = root.getAttribute('data-theme') || 'dark';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  root.setAttribute('data-theme', newTheme);
  localStorage.setItem('tallyups-theme', newTheme);
  updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
  const btn = document.getElementById('theme-toggle');
  if (btn) btn.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}

// Load saved theme - uses unified 'tallyups-theme' key
(function initTheme() {
  const savedTheme = localStorage.getItem('tallyups-theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  setTimeout(() => updateThemeIcon(savedTheme), 0);
})();

let allReceipts = [];
let currentFilter = 'pending';  // Default to inbox
let pendingAccept = null; // Store pending accept data for duplicate handling
let currentSortField = 'date';
let currentSortDir = 'desc';
let searchQuery = '';
let dateFilterFrom = null;
let dateFilterTo = null;
let currentDatePreset = 'all';

// ============== SEARCH, SORT & DATE FILTER FUNCTIONS ==============

// Get filtered and sorted receipts
function getSortedReceipts() {
  let receipts = [...allReceipts];

  // Apply status filter
  if (currentFilter === 'matched') {
    // Show pending receipts that have a matched transaction
    receipts = receipts.filter(r => r.status === 'pending' && r.matched_transaction_id);
  } else if (currentFilter === 'pending') {
    // Show pending receipts WITHOUT a matched transaction
    receipts = receipts.filter(r => r.status === 'pending' && !r.matched_transaction_id);
  } else if (currentFilter !== 'all') {
    receipts = receipts.filter(r => r.status === currentFilter);
  }

  // Apply search filter
  if (searchQuery.trim()) {
    const query = searchQuery.toLowerCase();
    receipts = receipts.filter(r => {
      const subject = (r.subject || '').toLowerCase();
      const merchant = (r.merchant || extractMerchantFromSubject(r.subject) || '').toLowerCase();
      const from = (r.from_email || '').toLowerCase();
      const amount = (r.amount || '').toString();
      const desc = (r.description || r.body_snippet || '').toLowerCase();
      return subject.includes(query) || merchant.includes(query) ||
             from.includes(query) || amount.includes(query) || desc.includes(query);
    });
  }

  // Apply date filter
  if (dateFilterFrom || dateFilterTo) {
    receipts = receipts.filter(r => {
      const dateStr = r.receipt_date || r.received_date || '';
      if (!dateStr) return false;
      const receiptDate = new Date(dateStr);
      receiptDate.setHours(0, 0, 0, 0);

      if (dateFilterFrom) {
        const from = new Date(dateFilterFrom);
        from.setHours(0, 0, 0, 0);
        if (receiptDate < from) return false;
      }
      if (dateFilterTo) {
        const to = new Date(dateFilterTo);
        to.setHours(23, 59, 59, 999);
        if (receiptDate > to) return false;
      }
      return true;
    });
  }

  // Apply sorting
  receipts.sort((a, b) => {
    let aVal, bVal;

    switch (currentSortField) {
      case 'subject':
        aVal = (a.subject || '').toLowerCase();
        bVal = (b.subject || '').toLowerCase();
        break;
      case 'merchant':
        aVal = (a.merchant || extractMerchantFromSubject(a.subject) || '').toLowerCase();
        bVal = (b.merchant || extractMerchantFromSubject(b.subject) || '').toLowerCase();
        break;
      case 'amount':
        aVal = parseFloat(a.amount) || 0;
        bVal = parseFloat(b.amount) || 0;
        break;
      case 'from':
        aVal = (a.from_email || '').toLowerCase();
        bVal = (b.from_email || '').toLowerCase();
        break;
      case 'date':
        aVal = new Date(a.receipt_date || a.received_date || 0);
        bVal = new Date(b.receipt_date || b.received_date || 0);
        break;
      case 'score':
        aVal = a.confidence_score || 0;
        bVal = b.confidence_score || 0;
        break;
      default:
        aVal = a[currentSortField] || '';
        bVal = b[currentSortField] || '';
    }

    if (aVal < bVal) return currentSortDir === 'asc' ? -1 : 1;
    if (aVal > bVal) return currentSortDir === 'asc' ? 1 : -1;
    return 0;
  });

  return receipts;
}

// Sort by column
function sortBy(field) {
  if (currentSortField === field) {
    // Toggle direction
    currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortField = field;
    currentSortDir = field === 'date' ? 'desc' : 'asc'; // Default newest first for dates
  }
  renderTable();
}

// Handle search input
function handleSearch(query) {
  searchQuery = query;
  const clearBtn = document.getElementById('search-clear');
  if (clearBtn) {
    clearBtn.style.display = query ? 'block' : 'none';
  }
  renderTable();
}

// Clear search
function clearSearch() {
  searchQuery = '';
  const input = document.getElementById('search-input');
  const clearBtn = document.getElementById('search-clear');
  if (input) input.value = '';
  if (clearBtn) clearBtn.style.display = 'none';
  renderTable();
}

// Set date filter preset
function setDateFilter(preset) {
  currentDatePreset = preset;

  // Update button states
  document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.date-btn[onclick*="${preset}"]`)?.classList.add('active');

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  switch (preset) {
    case 'today':
      dateFilterFrom = today.toISOString().split('T')[0];
      dateFilterTo = today.toISOString().split('T')[0];
      break;
    case 'week':
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      dateFilterFrom = weekAgo.toISOString().split('T')[0];
      dateFilterTo = today.toISOString().split('T')[0];
      break;
    case 'month':
      const monthAgo = new Date(today);
      monthAgo.setMonth(monthAgo.getMonth() - 1);
      dateFilterFrom = monthAgo.toISOString().split('T')[0];
      dateFilterTo = today.toISOString().split('T')[0];
      break;
    case 'all':
    default:
      dateFilterFrom = null;
      dateFilterTo = null;
      break;
  }

  // Clear custom date inputs
  const dateFromInput = document.getElementById('date-from');
  const dateToInput = document.getElementById('date-to');
  if (dateFromInput) dateFromInput.value = dateFilterFrom || '';
  if (dateToInput) dateToInput.value = dateFilterTo || '';

  renderTable();
}

// Apply custom date range
function applyDateRange() {
  const dateFromInput = document.getElementById('date-from');
  const dateToInput = document.getElementById('date-to');

  dateFilterFrom = dateFromInput?.value || null;
  dateFilterTo = dateToInput?.value || null;

  // Clear preset buttons when using custom range
  if (dateFilterFrom || dateFilterTo) {
    document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
    currentDatePreset = 'custom';
  }

  renderTable();
}

// ============== END SEARCH/SORT/DATE FILTER ==============

// ============== BUSINESS TYPES ==============
let cachedBizTypes = null;

// Generate business type chips HTML from cached types
function getBizTypeChipsHTML() {
  if (!cachedBizTypes || cachedBizTypes.length === 0) {
    // Fallback to default if not loaded yet
    return `
      <div class="biz-chip active" data-biz="Personal" onclick="event.stopPropagation();selectBizType(this)">Personal</div>
      <div class="biz-chip" data-biz="Down Home" onclick="event.stopPropagation();selectBizType(this)">Down Home</div>
      <div class="biz-chip" data-biz="Music City Rodeo" onclick="event.stopPropagation();selectBizType(this)">MCR</div>
      <div class="biz-chip" data-biz="EM.co" onclick="event.stopPropagation();selectBizType(this)">EM.co</div>
    `;
  }
  return cachedBizTypes.map((t, i) => {
    const isActive = i === 0 ? 'active' : '';
    const displayName = t.name.length > 15 ? t.name.substring(0, 12) + '...' : t.name;
    return `<div class="biz-chip ${isActive}" data-biz="${t.name}" style="--biz-color:${t.color}" onclick="event.stopPropagation();selectBizType(this)">${displayName}</div>`;
  }).join('');
}

// Initialize business types from API
async function initBizTypes() {
  try {
    cachedBizTypes = await BusinessTypes.getAll();
  } catch (e) {
    console.warn('Failed to load business types:', e);
  }
}

// ============== END BUSINESS TYPES ==============

// Load receipts on page load
document.addEventListener('DOMContentLoaded', async () => {
  // Load business types first
  await initBizTypes();
  // Set pending as active by default
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  document.querySelector('.chip[data-filter="pending"]')?.classList.add('active');
  loadReceipts();
});

async function loadReceipts() {
  try {
    const response = await fetch('/api/incoming/receipts?status=all&limit=1000', {
      credentials: 'include'
    });
    const data = await response.json();

    if (data.ok) {
      allReceipts = data.receipts;
      updateStats(data.counts);
      renderTable();
    } else {
      showToast(data.error || 'Failed to load receipts', 'error');
    }
  } catch (e) {
    console.error('Load error:', e);
    showToast('Error loading receipts', 'error');
  }
}

function updateStats(counts) {
  // Update dashboard stats
  document.getElementById('stat-pending').textContent = counts.pending || 0;
  document.getElementById('stat-accepted').textContent = counts.accepted || 0;
  document.getElementById('stat-rejected').textContent = counts.rejected || 0;
  document.getElementById('stat-total').textContent = allReceipts.length || 0;

  // Update chip counts
  const chipPending = document.getElementById('chip-pending');
  const chipMatched = document.getElementById('chip-matched');
  const chipAccepted = document.getElementById('chip-accepted');
  const chipRejected = document.getElementById('chip-rejected');

  // Count matched (pending with matched_transaction_id) vs unmatched pending
  const matchedCount = allReceipts.filter(r => r.status === 'pending' && r.matched_transaction_id).length;
  const unmatchedPending = (counts.pending || 0) - matchedCount;

  if (chipPending) chipPending.textContent = unmatchedPending || 0;
  if (chipMatched) chipMatched.textContent = matchedCount || 0;
  if (chipAccepted) chipAccepted.textContent = counts.accepted || 0;
  if (chipRejected) chipRejected.textContent = counts.rejected || 0;
}

function renderTable() {
  const content = document.getElementById('content');

  if (allReceipts.length === 0) {
    content.innerHTML = `
      <div class="empty-state">
        <h3>No receipts found</h3>
        <p>Click "Scan Now" to search for new receipts in your Gmail accounts.</p>
      </div>
    `;
    renderMobileCards(); // Also render mobile empty state
    return;
  }

  const sortedReceipts = getSortedReceipts();
  const tableHTML = `
    <table>
      <thead>
        <tr>
          <th style="width: 30%" class="sortable ${currentSortField === 'subject' ? currentSortDir : ''}" onclick="sortBy('subject')">Subject & Details</th>
          <th style="width: 15%" class="sortable ${currentSortField === 'merchant' ? currentSortDir : ''}" onclick="sortBy('merchant')">Merchant</th>
          <th style="width: 10%" class="sortable ${currentSortField === 'amount' ? currentSortDir : ''}" onclick="sortBy('amount')">Amount</th>
          <th style="width: 12%" class="sortable ${currentSortField === 'from' ? currentSortDir : ''}" onclick="sortBy('from')">From</th>
          <th style="width: 12%" class="sortable ${currentSortField === 'date' ? currentSortDir : ''} active" onclick="sortBy('date')">Date</th>
          <th style="width: 8%" class="sortable ${currentSortField === 'score' ? currentSortDir : ''}" onclick="sortBy('score')">Score</th>
          <th style="width: 10%">Actions</th>
        </tr>
      </thead>
      <tbody>
        ${sortedReceipts.map(r => renderRow(r)).join('')}
      </tbody>
    </table>
  `;

  content.innerHTML = tableHTML;
  renderMobileCards(); // Render mobile cards too
  // Note: Don't call applyFilter() here - getSortedReceipts() already handles filtering
}

// Mobile Card Rendering
function renderMobileCards() {
  const container = document.getElementById('mobile-inbox');
  if (!container) return;

  // Use getSortedReceipts() which already applies status, search, and date filters
  const filtered = getSortedReceipts();

  if (filtered.length === 0) {
    let emptyTitle = 'No Receipts';
    let emptyText = 'No receipts found';
    let emptyIcon = 'üì¨';

    if (currentFilter === 'pending') {
      emptyTitle = 'Inbox Clear';
      emptyText = 'All receipts have been processed';
      emptyIcon = '‚ú®';
    } else if (currentFilter === 'matched') {
      emptyTitle = 'No Matched Receipts';
      emptyText = 'Receipts with matching transactions appear here';
      emptyIcon = 'üîó';
    } else if (currentFilter === 'accepted') {
      emptyTitle = 'No Accepted Receipts';
      emptyText = 'Accepted receipts will appear here';
      emptyIcon = '‚úì';
    } else if (currentFilter === 'rejected') {
      emptyTitle = 'Nothing Dismissed';
      emptyText = 'Dismissed receipts will appear here';
      emptyIcon = '‚úï';
    }

    container.innerHTML = `
      <div class="inbox-empty">
        <div class="inbox-empty-icon">${emptyIcon}</div>
        <div class="inbox-empty-title">${emptyTitle}</div>
        <div class="inbox-empty-text">${emptyText}</div>
      </div>
    `;
    return;
  }

  // Add header for rejected section
  let headerHTML = '';
  if (currentFilter === 'rejected' && filtered.length > 0) {
    headerHTML = `
      <div class="rejected-header">
        <h3>Dismissed (${filtered.length})</h3>
        <button class="clear-all-btn" onclick="clearRejected()">Clear All</button>
      </div>
    `;
  }

  container.innerHTML = headerHTML + filtered.map(r => renderMobileCard(r)).join('');
}

function renderMobileCard(receipt) {
  const merchant = receipt.merchant || extractMerchantFromSubject(receipt.subject);
  const amount = parseFloat(receipt.amount) || 0;
  const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');

  // Format date as "Month Day, Year"
  const dateStr = receipt.receipt_date || receipt.received_date || '';
  const formattedDate = formatDateFull(dateStr);

  // Sender name
  const senderName = extractSenderName(receipt.from_email);

  // Amount display
  let amountDisplay = '';
  let amountClass = '';
  if (amount > 0) {
    if (isRefund) {
      amountDisplay = `+$${amount.toFixed(2)}`;
      amountClass = 'refund';
    } else {
      amountDisplay = `-$${amount.toFixed(2)}`;
      amountClass = 'charge';
    }
  }

  // Confidence score
  const score = receipt.confidence_score || 0;
  const scoreClass = score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';

  // Description (AI analysis or subject snippet)
  const description = receipt.description || receipt.body_snippet || '';

  // Receipt date for accept function
  const receiptDate = receipt.receipt_date || receipt.received_date || '';

  // Receipt thumbnail - prefer thumbnail_url for cards, fall back to full image
  const thumbUrl = receipt.thumbnail_url || receipt.receipt_image_url || receipt.preview_url || receipt.r2_url;
  const fullImageUrl = receipt.receipt_image_url || receipt.preview_url || receipt.r2_url || thumbUrl;
  const hasThumb = !!thumbUrl;
  const thumbHTML = hasThumb ? `
    <div class="inbox-card-thumb" onclick="event.stopPropagation();openFullImage('${fullImageUrl}')">
      <img src="${thumbUrl}" alt="Receipt" loading="lazy" onerror="this.parentNode.style.display='none'">
      <span class="inbox-card-thumb-icon">üßæ</span>
    </div>
  ` : '';

  // Actions based on status
  let actionsHTML = '';
  if (receipt.status === 'pending') {
    // Check for potential expense matches
    const bestMatch = receipt.best_match;
    const hasMatch = bestMatch && bestMatch.score >= 50;

    let matchBadge = '';
    let primaryAction = '';

    if (hasMatch) {
      // Found a matching expense - show "Attach" as primary action (RED HIGHLIGHT)
      const matchMerchant = bestMatch.merchant || 'Expense';
      const matchAmount = Math.abs(bestMatch.amount).toFixed(2);
      const matchDate = bestMatch.date ? formatDateShort(bestMatch.date) : '';
      const matchId = bestMatch.id || '';
      matchBadge = `
        <div class="inbox-card-match found">
          <span class="match-icon">üî¥</span>
          <div>
            <span style="font-size:14px">‚ö†Ô∏è MATCH FOUND!</span>
            <span class="match-details">${escapeHtml(matchMerchant)} ‚Ä¢ $${matchAmount}${matchDate ? ' ‚Ä¢ ' + matchDate : ''}${matchId ? ' (ID:' + matchId + ')' : ''}</span>
          </div>
        </div>
      `;
      primaryAction = `
        <button class="inbox-card-btn accept match" onclick="event.stopPropagation();attachToExpense(${receipt.id}, ${bestMatch.id}, this)">
          üîó Attach
        </button>
      `;
    } else {
      // No match found
      matchBadge = `
        <div class="inbox-card-match none">
          <span class="match-icon">‚ùì</span>
          <span>No matching expense</span>
        </div>
        <div class="biz-type-chips" data-receipt="${receipt.id}">
          ${getBizTypeChipsHTML()}
        </div>
        <div class="inbox-card-extras" data-receipt="${receipt.id}">
          <select class="inbox-category-select" onclick="event.stopPropagation()">
            <option value="">Category (optional)</option>
            <option value="Meals & Entertainment">Meals & Entertainment</option>
            <option value="Travel - Airfare">Travel - Airfare</option>
            <option value="Travel - Hotel">Travel - Hotel</option>
            <option value="Travel - Ground Transportation">Travel - Ground</option>
            <option value="Software & Subscriptions">Software & Subscriptions</option>
            <option value="Office Supplies">Office Supplies</option>
            <option value="Professional Services">Professional Services</option>
            <option value="Equipment & Hardware">Equipment & Hardware</option>
            <option value="Parking & Tolls">Parking & Tolls</option>
            <option value="Fuel & Gas">Fuel & Gas</option>
            <option value="Miscellaneous Business Expense">Miscellaneous</option>
          </select>
          <input type="text" class="inbox-description-input" placeholder="Description (optional)" onclick="event.stopPropagation()" />
        </div>
      `;
      primaryAction = `
        <button class="inbox-card-btn accept create" onclick="event.stopPropagation();mobileAccept(${receipt.id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}', this)">
          + New Expense
        </button>
      `;
    }

    actionsHTML = `
      ${matchBadge}
      <div class="inbox-card-actions">
        <button class="inbox-card-btn preview" onclick="event.stopPropagation();showPreview(${receipt.id})">
          üëÅÔ∏è
        </button>
        <button class="inbox-card-btn reject" onclick="event.stopPropagation();mobileReject(${receipt.id}, this)">
          ‚úï Not Receipt
        </button>
        ${primaryAction}
      </div>
    `;
  } else if (receipt.status === 'rejected') {
    // Compact rejected card with unreject button
    return `
      <div class="inbox-card rejected compact" data-id="${receipt.id}" onclick="showPreview(${receipt.id})">
        <div class="inbox-card-merchant">${escapeHtml(merchant)}</div>
        <div class="inbox-card-actions">
          <button class="inbox-card-btn btn-ghost" onclick="event.stopPropagation();quickUnreject(${receipt.id})">
            Restore
          </button>
        </div>
      </div>
    `;
  } else {
    // Accepted/Matched - normal card
    actionsHTML = `
      <div class="inbox-card-status accepted">
        ‚úì Matched
      </div>
    `;
  }

  // Receipt image URL (from Gmail attachment or R2) - use full image for display
  const imageUrl = receipt.receipt_image_url || receipt.preview_url || receipt.r2_url;
  // Use thumbnail for card display if available (faster loading)
  const cardImageUrl = receipt.thumbnail_url || imageUrl;

  // Gmail link for viewing the original email - use correct account index
  const emailId = receipt.email_id || '';
  const gmailAccount = receipt.gmail_account || '';
  // Map gmail accounts to their index (adjust based on your Chrome profile order)
  const accountIndex = gmailAccount.includes('downhome') ? 1 : gmailAccount.includes('musiccityrodeo') ? 2 : 0;
  const gmailUrl = emailId ? `https://mail.google.com/mail/u/${accountIndex}/#all/${emailId}` : '';

  // If we have an image, show it; otherwise show a styled email preview card
  let imageHTML = '';
  if (cardImageUrl) {
    imageHTML = `
      <div class="inbox-card-image" onclick="event.stopPropagation();openFullImage('${imageUrl || cardImageUrl}')">
        <img src="${cardImageUrl}" alt="Receipt" onerror="this.parentElement.classList.add('no-image')">
      </div>
    `;
  } else {
    // Show styled email preview with key data
    const subjectPreview = (receipt.subject || '').substring(0, 60) + ((receipt.subject || '').length > 60 ? '...' : '');
    const bodyPreview = (receipt.body_snippet || '').substring(0, 100) + ((receipt.body_snippet || '').length > 100 ? '...' : '');
    imageHTML = `
      <div class="inbox-card-email-preview">
        <div class="email-preview-icon">üìß</div>
        <div class="email-preview-subject">${escapeHtml(subjectPreview)}</div>
        ${bodyPreview ? `<div class="email-preview-body">${escapeHtml(bodyPreview)}</div>` : ''}
        ${gmailUrl ? `<a href="${gmailUrl}" target="_blank" onclick="event.stopPropagation()" class="email-preview-link">View in Gmail</a>` : ''}
      </div>
    `;
  }

  return `
    <div class="inbox-card ${receipt.status}${hasThumb ? ' has-thumb' : ''}" data-id="${receipt.id}" onclick="showPreview(${receipt.id})">
      ${thumbHTML}
      <div class="inbox-card-header">
        <div class="inbox-card-date">${formattedDate}</div>
        <div class="inbox-card-score ${scoreClass}">${score}%</div>
      </div>
      <div class="inbox-card-merchant">${escapeHtml(merchant)}</div>
      ${amountDisplay ? `<div class="inbox-card-amount ${amountClass}">${amountDisplay}</div>` : ''}
      ${imageHTML}
      <div class="inbox-card-meta">
        <div class="inbox-card-sender">
          <span class="inbox-card-sender-icon">‚úâÔ∏è</span>
          ${escapeHtml(senderName)}
        </div>
      </div>
      ${description ? `<div class="inbox-card-desc">${escapeHtml(description)}</div>` : ''}
      ${actionsHTML}
    </div>
  `;
}

// Format date as "Month Day, Year"
function formatDateFull(dateStr) {
  if (!dateStr) return 'Unknown Date';
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric'
    });
  } catch {
    return dateStr;
  }
}

// Format date as short "M/D/YY"
function formatDateShort(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', {
      month: 'numeric',
      day: 'numeric',
      year: '2-digit'
    });
  } catch {
    return dateStr;
  }
}

function selectBizType(chip) {
  const container = chip.closest('.biz-type-chips');
  container.querySelectorAll('.biz-chip').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
}

function getSelectedBizType(card) {
  const activeChip = card.querySelector('.biz-chip.active');
  return activeChip ? activeChip.dataset.biz : 'Personal';
}

function getSelectedCategory(card) {
  const select = card.querySelector('.inbox-category-select');
  return select ? select.value : '';
}

function getDescription(card) {
  const input = card.querySelector('.inbox-description-input');
  return input ? input.value.trim() : '';
}

// Mobile accept with visual feedback and duplicate detection
async function mobileAccept(id, merchant, amount, isRefund, receiptDate, btn) {
  const card = btn.closest('.inbox-card');
  const actionsDiv = card.querySelector('.inbox-card-actions');
  const businessType = getSelectedBizType(card);
  const category = getSelectedCategory(card);
  const description = getDescription(card);

  // Show loading state
  actionsDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--brand)">
      <span class="spinner"></span> Checking...
    </div>
  `;

  const transDate = receiptDate ? receiptDate.split('T')[0] : new Date().toISOString().split('T')[0];

  try {
    // First check for duplicates
    const dupResponse = await fetch('/api/incoming/check-duplicate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ merchant, amount: amount || 0, date: transDate })
    });

    const dupData = await dupResponse.json();

    if (dupData.has_duplicates && dupData.duplicates.length > 0) {
      // Show duplicate warning modal
      const dup = dupData.duplicates[0];
      document.getElementById('dup-merchant').textContent = dup.merchant;
      document.getElementById('dup-amount').textContent = '$' + parseFloat(dup.amount).toFixed(2);
      document.getElementById('dup-date').textContent = dup.date;
      document.getElementById('dup-has-receipt').textContent = dup.has_receipt ? 'Yes ‚úì' : 'No';

      // Store pending accept data
      pendingAccept = {
        id, merchant, amount, isRefund, transDate, card, actionsDiv, businessType, category, description,
        duplicateId: dup.id,
        callback: (forceAccept) => {
          if (forceAccept) {
            doAccept(id, merchant, amount, isRefund, transDate, card, actionsDiv, businessType, false, category, description);
          } else {
            renderMobileCards();
          }
        }
      };

      document.getElementById('duplicate-modal').classList.add('visible');
      return;
    }

    // No duplicates - proceed with accept
    await doAccept(id, merchant, amount, isRefund, transDate, card, actionsDiv, businessType, false, category, description);

  } catch (e) {
    console.error('Accept error:', e);
    showToast('Error accepting', 'error');
    renderMobileCards();
  }
}

// Close duplicate modal
function closeDuplicateModal() {
  document.getElementById('duplicate-modal').classList.remove('visible');
}

// Attach receipt to existing transaction
async function attachToExisting() {
  if (!pendingAccept) return;

  const { id, duplicateId, card, actionsDiv, merchant } = pendingAccept;

  actionsDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--brand)">
      <span class="spinner"></span> Attaching...
    </div>
  `;

  try {
    // Call API to attach receipt to existing transaction
    const response = await fetch('/api/incoming/attach-to-transaction', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({
        receipt_id: id,
        transaction_id: duplicateId
      })
    });

    const data = await response.json();

    if (data.ok) {
      card.style.transition = 'all 0.3s ease';
      card.style.background = 'rgba(0,255,136,0.1)';
      card.classList.remove('pending');
      card.classList.add('accepted');

      actionsDiv.innerHTML = `
        <div class="inbox-card-status accepted">
          ‚úì Attached to #${duplicateId}
        </div>
      `;

      showToast(`‚úì Receipt attached to existing transaction`, 'success');

      const receipt = allReceipts.find(r => r.id === id);
      if (receipt) receipt.status = 'accepted';

      if (currentFilter === 'pending') {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateX(100px)';
          setTimeout(() => card.remove(), 300);
        }, 500);
      }

      loadReceipts();
    } else {
      showToast(data.error || 'Failed to attach', 'error');
      renderMobileCards();
    }
  } catch (e) {
    console.error('Attach error:', e);
    showToast('Error attaching receipt', 'error');
    renderMobileCards();
  }

  pendingAccept = null;
}

// Attach receipt to a matched expense (from match badge)
async function attachToExpense(receiptId, transactionId, btn) {
  const card = btn.closest('.inbox-card');
  const actionsDiv = card.querySelector('.inbox-card-actions');
  const matchBadge = card.querySelector('.inbox-card-match');

  // Show loading state
  if (actionsDiv) {
    actionsDiv.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--brand)">
        <span class="spinner"></span> Attaching...
      </div>
    `;
  }
  if (matchBadge) {
    matchBadge.innerHTML = `
      <span class="match-icon">‚è≥</span>
      <span>Linking receipt to expense...</span>
    `;
  }

  try {
    const response = await fetch('/api/incoming/attach-to-transaction', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({
        receipt_id: receiptId,
        transaction_id: transactionId
      })
    });

    const data = await response.json();

    if (data.ok) {
      // Success animation
      card.style.transition = 'all 0.3s ease';
      card.style.background = 'rgba(0,255,136,0.1)';
      card.classList.remove('pending');
      card.classList.add('accepted');

      // Update match badge to show success
      if (matchBadge) {
        matchBadge.className = 'inbox-card-match found';
        matchBadge.innerHTML = `
          <span class="match-icon">‚úì</span>
          <span>Linked to expense #${transactionId}</span>
        `;
      }

      // Update actions to show completed status
      if (actionsDiv) {
        actionsDiv.innerHTML = `
          <div class="inbox-card-status accepted">
            ‚úì Matched
          </div>
        `;
      }

      showToast(`‚úì Receipt attached to expense #${transactionId}`, 'success');

      // Update local data
      const receipt = allReceipts.find(r => r.id === receiptId);
      if (receipt) receipt.status = 'accepted';

      // Fade out if viewing pending only
      if (currentFilter === 'pending') {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateX(100px)';
          setTimeout(() => card.remove(), 300);
        }, 800);
      }

      // Refresh to update stats
      loadReceipts();
    } else {
      // Show error persistently
      const errorMsg = data.error || 'Failed to attach receipt';
      if (actionsDiv) {
        actionsDiv.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:8px;padding:12px;background:rgba(255,80,80,0.1);border-radius:8px;border:1px solid rgba(255,80,80,0.3)">
            <div style="color:var(--error);font-weight:600;font-size:12px">Error</div>
            <div style="font-size:11px;color:var(--muted);word-break:break-word">${errorMsg}</div>
            <button class="inbox-card-btn" onclick="renderMobileCards()" style="margin-top:4px">Dismiss</button>
          </div>
        `;
      }
      showToast(errorMsg, 'error');
      console.error('Attach failed:', errorMsg);
    }
  } catch (e) {
    console.error('Attach error:', e);
    const errorMsg = e.message || 'Network error - try again';
    if (actionsDiv) {
      actionsDiv.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:8px;padding:12px;background:rgba(255,80,80,0.1);border-radius:8px;border:1px solid rgba(255,80,80,0.3)">
          <div style="color:var(--error);font-weight:600;font-size:12px">Error</div>
          <div style="font-size:11px;color:var(--muted);word-break:break-word">${errorMsg}</div>
          <button class="inbox-card-btn" onclick="renderMobileCards()" style="margin-top:4px">Dismiss</button>
        </div>
      `;
    }
    showToast('Error attaching receipt', 'error');
  }
}

// Perform the actual accept
async function doAccept(id, merchant, amount, isRefund, transDate, card, actionsDiv, businessType = 'Personal', forceAccept = false, category = '', description = '') {
  actionsDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--brand)">
      <span class="spinner"></span> Processing...
    </div>
  `;

  try {
    const response = await fetch('/api/incoming/accept', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({
        receipt_id: id,
        merchant: merchant,
        amount: amount || 0,
        is_refund: isRefund,
        date: transDate,
        business_type: businessType,
        force: forceAccept,
        category: category || '',
        description: description || ''
      })
    });

    const data = await response.json();

    // Handle duplicate warning - ask user to confirm
    if (data.duplicate_warning && !forceAccept) {
      const existing = data.existing_transaction;
      const confirmMsg = `‚ö†Ô∏è DUPLICATE DETECTED!\n\nSimilar transaction already exists:\n‚Ä¢ ${existing.description}\n‚Ä¢ $${existing.amount}\n‚Ä¢ Date: ${existing.date}\n‚Ä¢ Already has receipt ‚úì\n\nAre you sure you want to create a duplicate?`;

      actionsDiv.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:8px;padding:12px;background:rgba(255,200,0,0.1);border-radius:8px;border:1px solid rgba(255,200,0,0.3)">
          <div style="color:var(--warn);font-weight:600;font-size:12px">‚ö†Ô∏è Possible Duplicate</div>
          <div style="font-size:11px;color:var(--muted)">
            Transaction #${existing.id} already has receipt<br>
            $${existing.amount} on ${existing.date}
          </div>
          <div style="display:flex;gap:8px;justify-content:center;margin-top:4px">
            <button class="inbox-card-btn reject" onclick="event.stopPropagation();renderMobileCards()" style="flex:1">Cancel</button>
            <button class="inbox-card-btn accept create" onclick="event.stopPropagation();doAccept(${id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${transDate}', this.closest('.inbox-card'), this.closest('.inbox-card-actions'), '${businessType}', true)" style="flex:1">Create Anyway</button>
          </div>
        </div>
      `;
      showToast('‚ö†Ô∏è Similar transaction already has receipt', 'warning');
      return;
    }

    if (data.ok) {
      // Success animation
      card.style.transition = 'all 0.3s ease';
      card.style.background = 'rgba(0,255,136,0.1)';
      card.classList.remove('pending');
      card.classList.add('accepted');

      actionsDiv.innerHTML = `
        <div class="inbox-card-status accepted">
          ‚úì Accepted ${data.transaction_id ? `#${data.transaction_id}` : ''}
        </div>
      `;

      showToast(`‚úì ${merchant} accepted!`, 'success');

      // Update local data
      const receipt = allReceipts.find(r => r.id === id);
      if (receipt) receipt.status = 'accepted';

      // Fade out if viewing pending only
      if (currentFilter === 'pending') {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateX(100px)';
          setTimeout(() => card.remove(), 300);
        }, 500);
      }

      // Refresh stats
      loadReceipts();
    } else {
      // Show error persistently in the card
      const errorMsg = data.error || 'Failed to accept receipt';
      actionsDiv.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:8px;padding:12px;background:rgba(255,80,80,0.1);border-radius:8px;border:1px solid rgba(255,80,80,0.3)">
          <div style="color:var(--error);font-weight:600;font-size:12px">Error</div>
          <div style="font-size:11px;color:var(--muted);word-break:break-word">${errorMsg}</div>
          <button class="inbox-card-btn" onclick="renderMobileCards()" style="margin-top:4px">Dismiss</button>
        </div>
      `;
      showToast(errorMsg, 'error');
      console.error('Accept failed:', errorMsg);
    }
  } catch (e) {
    console.error('Accept error:', e);
    // Show error persistently in the card
    const errorMsg = e.message || 'Network error - try again';
    actionsDiv.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px;padding:12px;background:rgba(255,80,80,0.1);border-radius:8px;border:1px solid rgba(255,80,80,0.3)">
        <div style="color:var(--error);font-weight:600;font-size:12px">Error</div>
        <div style="font-size:11px;color:var(--muted);word-break:break-word">${errorMsg}</div>
        <button class="inbox-card-btn" onclick="renderMobileCards()" style="margin-top:4px">Dismiss</button>
      </div>
    `;
    showToast('Error accepting receipt', 'error');
  }
}

// Mobile reject with visual feedback
async function mobileReject(id, btn) {
  const card = btn.closest('.inbox-card');
  const actionsDiv = card.querySelector('.inbox-card-actions');

  // Show loading state
  actionsDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:12px;color:var(--muted)">
      <span class="spinner"></span> Rejecting...
    </div>
  `;

  try {
    const response = await fetch('/api/incoming/reject', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ receipt_id: id })
    });

    const data = await response.json();

    if (data.ok) {
      // Fade out animation
      card.style.transition = 'all 0.3s ease';
      card.style.opacity = '0';
      card.style.transform = 'translateX(-100px)';

      setTimeout(() => {
        card.remove();

        // Update local data
        const receipt = allReceipts.find(r => r.id === id);
        if (receipt) receipt.status = 'rejected';

        // Check if list is now empty
        const container = document.getElementById('mobile-inbox');
        if (container && container.children.length === 0) {
          renderMobileCards();
        }
      }, 300);

      showToast('Rejected', 'info');
      loadReceipts();
    } else {
      showToast(data.error || 'Failed', 'error');
      renderMobileCards();
    }
  } catch (e) {
    console.error('Reject error:', e);
    showToast('Error rejecting', 'error');
    renderMobileCards();
  }
}

async function quickUnreject(id) {
  try {
    const res = await fetch(`${API_BASE}/api/incoming/unreject`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ receipt_id: id })
    });
    const data = await res.json();
    if (data.ok) {
      // Update local data
      const receipt = allReceipts.find(r => r.id === id);
      if (receipt) receipt.status = 'pending';

      showToast('Restored to pending', 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to unreject', 'error');
    }
  } catch (e) {
    console.error('Unreject error:', e);
    showToast('Error unrejecting', 'error');
  }
}

function renderRow(receipt) {
  const confidenceClass = receipt.confidence_score >= 80 ? 'confidence-high' :
                          receipt.confidence_score >= 60 ? 'confidence-medium' : 'confidence-low';

  const merchant = receipt.merchant || extractMerchantFromSubject(receipt.subject);

  // Format amount: charges are negative (-), refunds are positive
  let amountDisplay = '';
  let amountColor = 'var(--ok)';  // Green for refunds
  const amount = parseFloat(receipt.amount) || 0;
  if (amount > 0) {
    const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');
    if (isRefund) {
      amountDisplay = `+$${amount.toFixed(2)}`;
      amountColor = 'var(--ok)';  // Green for refunds (money back)
    } else {
      amountDisplay = `-$${amount.toFixed(2)}`;
      amountColor = 'var(--bad)';  // Red for charges (money spent)
    }
  }
  const date = formatDate(receipt.received_date);

  // Match badge - show status for transaction matching
  let matchBadge = '';
  if (receipt.matched_transaction_id) {
    if (receipt.match_type === 'needs_receipt') {
      matchBadge = `<div class="match-badge needs-receipt">RECEIPT NEEDED - TX #${receipt.matched_transaction_id}</div>`;
    } else if (receipt.match_type === 'has_receipt') {
      matchBadge = `<div class="match-badge has-receipt">Already has receipt - TX #${receipt.matched_transaction_id}</div>`;
    }
  } else if (receipt.match_type === 'no_match') {
    matchBadge = `<div class="match-badge no-match">No matching transaction</div>`;
  }

  // AI notes from Vision analysis
  let aiNotes = '';
  if (receipt.ai_notes) {
    aiNotes = `<div class="ai-notes">${escapeHtml(receipt.ai_notes)}</div>`;
  }

  // AI description
  let description = '';
  if (receipt.description) {
    description = `<div class="description">${escapeHtml(receipt.description)}</div>`;
  }

  // Check if refund for quickAccept
  const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');

  // Get the actual receipt date (use receipt_date if available, otherwise received_date)
  const receiptDate = receipt.receipt_date || receipt.received_date || '';

  // Actions - include preview button
  const previewBtn = `<button class="preview-btn" onclick="event.stopPropagation();showPreview(${receipt.id})" title="Preview">üëÅÔ∏è</button>`;
  const actions = receipt.status === 'pending'
    ? `${previewBtn}
       <button class="btn-success btn-sm" onclick="event.stopPropagation();quickAccept(${receipt.id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}')">‚úì</button>
       <button class="btn-danger btn-sm" onclick="event.stopPropagation();quickReject(${receipt.id})">‚úó</button>`
    : `${previewBtn}<span style="color:var(--muted);font-size:11px;margin-left:8px">${receipt.status === 'accepted' ? '‚úì Accepted' : '‚úó Rejected'}</span>`;

  // Parse sender info
  const fromEmail = receipt.from_email || '';
  const senderName = extractSenderName(fromEmail);

  // Attachment count
  let attachmentCount = 0;
  try {
    const atts = typeof receipt.attachments === 'string' ? JSON.parse(receipt.attachments) : (receipt.attachments || []);
    attachmentCount = atts.length;
  } catch(e) {}
  const hasMatch = receipt.matched_transaction_id ? 'true' : 'false';
  const attachmentBadge = attachmentCount > 0 ? `<span class="attachment-badge">üìé ${attachmentCount}</span>` : '';

  return `
    <tr data-status="${receipt.status}" data-id="${receipt.id}" data-matched="${hasMatch}" class="clickable" onclick="showPreview(${receipt.id})">
      <td>
        <div style="font-weight:500">${escapeHtml(receipt.subject)}</div>
        <div class="snippet">${escapeHtml(receipt.body_snippet || '')}</div>
        ${description}
        ${matchBadge}
        ${aiNotes}
        ${attachmentBadge}
      </td>
      <td style="font-weight:500">${escapeHtml(merchant)}</td>
      <td style="font-weight:600;color:${amountColor}">${amountDisplay}</td>
      <td>
        <div class="sender-info">
          <span class="sender-name">${escapeHtml(senderName)}</span>
          <span class="sender-email">${escapeHtml(fromEmail)}</span>
        </div>
      </td>
      <td style="color:var(--muted);font-size:12px">${date}</td>
      <td><span class="confidence-badge ${confidenceClass}">${receipt.confidence_score}%</span></td>
      <td onclick="event.stopPropagation()">${actions}</td>
    </tr>
  `;
}

function extractSenderName(email) {
  if (!email) return 'Unknown';
  // Extract display name from "Name <email>" format
  const match = email.match(/^([^<]+)</);
  if (match) return match[1].trim();
  // Otherwise extract username from email
  return email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function extractMerchantFromSubject(subject) {
  const patterns = [
    /receipt from ([^#\n]+)/i,
    /invoice from ([^#\n]+)/i,
    /payment (?:to|from) ([^#\n]+)/i,
    /your ([^#\n]+?) (?:receipt|invoice)/i,
  ];

  for (const pattern of patterns) {
    const match = subject.match(pattern);
    if (match) return match[1].trim().split('#')[0].trim();
  }
  return 'Unknown';
}

async function quickAccept(id, merchant, amount, isRefund = false, receiptDate = '', forceAccept = false) {
  const row = document.querySelector(`tr[data-id="${id}"]`);
  const actionsCell = row.querySelector('td:last-child');

  // Show processing state with spinner
  actionsCell.innerHTML = '<span style="color:var(--brand);font-size:11px;display:flex;align-items:center;gap:4px"><span class="spinner"></span> Creating transaction...</span>';

  // Use actual receipt date, fallback to today if not provided
  const transDate = receiptDate ? receiptDate.split('T')[0] : new Date().toISOString().split('T')[0];

  try {
    const response = await fetch('/api/incoming/accept', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({
        receipt_id: id,
        merchant: merchant,
        amount: amount || 0,
        is_refund: isRefund,
        date: transDate,
        business_type: 'Personal',
        force: forceAccept
      })
    });

    const data = await response.json();

    // Handle duplicate warning - show inline confirmation
    if (data.duplicate_warning && !forceAccept) {
      const existing = data.existing_transaction;
      actionsCell.innerHTML = `
        <div style="font-size:10px;padding:4px 8px;background:rgba(255,200,0,.15);border-radius:4px;border:1px solid rgba(255,200,0,.3)">
          <div style="color:var(--warn);font-weight:600;margin-bottom:4px">‚ö†Ô∏è Duplicate?</div>
          <div style="color:var(--muted);margin-bottom:6px">#${existing.id} has receipt ($${existing.amount})</div>
          <div style="display:flex;gap:4px">
            <button class="btn-danger btn-sm" onclick="loadReceipts()">Cancel</button>
            <button class="btn-success btn-sm" onclick="quickAccept(${id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}', true)">Force</button>
          </div>
        </div>`;
      showToast('‚ö†Ô∏è Similar transaction already has receipt', 'warning');
      return;
    }

    if (data.ok) {
      // Show success with transaction details
      const actionText = data.action === 'attached' ? 'Attached to existing' : 'New transaction';
      const txnId = data.transaction_id ? ` #${data.transaction_id}` : '';
      // Format amount with proper sign: - for charges, + for refunds
      const amountSign = isRefund ? '+' : '-';
      const amountStr = amount ? ` (${amountSign}$${parseFloat(amount).toFixed(2)})` : '';

      // Update cell with complete status
      actionsCell.innerHTML = `<span style="color:var(--ok);font-size:11px;font-weight:600">‚úÖ Complete${txnId}</span>`;

      // Show detailed toast
      showToast(`‚úÖ Complete! ${actionText}${txnId} - ${merchant}${amountStr}`, 'success');

      // Highlight row briefly
      row.style.backgroundColor = 'rgba(47,255,162,.1)';
      row.setAttribute('data-status', 'accepted');

      // Fade highlight after 2 seconds
      setTimeout(() => {
        row.style.backgroundColor = '';
      }, 2000);

      // Refresh stats
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to accept', 'error');
      actionsCell.innerHTML = `<button class="btn-success btn-sm" onclick="quickAccept(${id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}')">‚úì</button>
                               <button class="btn-danger btn-sm" onclick="quickReject(${id})">‚úó</button>`;
    }
  } catch (e) {
    console.error('Accept error:', e);
    showToast('Error accepting receipt', 'error');
    actionsCell.innerHTML = `<button class="btn-success btn-sm" onclick="quickAccept(${id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}')">‚úì</button>
                             <button class="btn-danger btn-sm" onclick="quickReject(${id})">‚úó</button>`;
  }
}

async function quickReject(id) {
  const row = document.querySelector(`tr[data-id="${id}"]`);
  const actionsCell = row.querySelector('td:last-child');
  actionsCell.innerHTML = '<span style="color:var(--muted);font-size:11px">Processing...</span>';

  try {
    const response = await fetch('/api/incoming/reject', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ receipt_id: id })
    });

    const data = await response.json();

    if (data.ok) {
      showToast('Rejected', 'info');

      // Fade out and remove the row
      row.style.transition = 'opacity 0.3s ease';
      row.style.opacity = '0';
      setTimeout(() => {
        row.remove();
        // Update the receipt from allReceipts array
        const receiptIndex = allReceipts.findIndex(r => r.id === id);
        if (receiptIndex !== -1) {
          allReceipts[receiptIndex].status = 'rejected';
        }
        updateStats();
      }, 300);
    } else {
      showToast(data.error || 'Failed to reject', 'error');
    }
  } catch (e) {
    console.error('Reject error:', e);
    showToast('Error rejecting receipt', 'error');
  }
}

async function clearRejected() {
  if (!confirm('Clear all rejected receipts? This cannot be undone.')) return;

  showToast('Clearing rejected receipts...', 'info');

  try {
    const response = await fetch('/api/incoming/clear-rejected', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include'
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Cleared ${data.deleted || 0} rejected receipts`, 'success');
      loadReceipts(); // Reload to update the list
    } else {
      showToast(data.error || 'Failed to clear rejected', 'error');
    }
  } catch (e) {
    console.error('Clear rejected error:', e);
    showToast('Error clearing rejected receipts', 'error');
  }
}

function filterStatus(status) {
  // Prevent double-trigger by checking if already on this filter
  if (currentFilter === status) {
    return;
  }
  currentFilter = status;

  // Update chip states using data-filter attribute (handles clicks on child elements)
  document.querySelectorAll('.chip').forEach(chip => {
    chip.classList.remove('active');
    if (chip.getAttribute('data-filter') === status) {
      chip.classList.add('active');
    }
  });

  // Re-render the table with new filter applied
  renderTable();
}

function applyFilter() {
  // Apply to table rows
  const rows = document.querySelectorAll('tbody tr');
  rows.forEach(row => {
    const rowStatus = row.getAttribute('data-status');
    const hasMatch = row.getAttribute('data-matched') === 'true';

    let show = false;
    if (currentFilter === 'all') {
      show = true;
    } else if (currentFilter === 'matched') {
      // Show only pending receipts that have a matched transaction
      show = (rowStatus === 'pending' && hasMatch);
    } else if (currentFilter === 'pending') {
      // Show pending that are NOT matched (true inbox)
      show = (rowStatus === 'pending' && !hasMatch);
    } else {
      show = (rowStatus === currentFilter);
    }

    if (show) {
      row.classList.remove('hidden');
    } else {
      row.classList.add('hidden');
    }
  });

  // Also re-render mobile cards
  renderMobileCards();
}

async function scanForNew() {
  showToast('Scanning Gmail accounts...', 'info');

  try {
    const response = await fetch('/api/incoming/scan', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({})
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Found ${data.results.total_new} new receipts!`, 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Scan failed', 'error');
    }
  } catch (e) {
    console.error('Scan error:', e);
    showToast('Error scanning Gmail', 'error');
  }
}

async function rematchAll() {
  const unmatchedCount = allReceipts.filter(r => r.status === 'pending' && !r.matched_transaction_id).length;
  if (!confirm(`Re-match ${unmatchedCount} unmatched receipts?\n\nThis will use improved AI to:\n- Extract better merchant names\n- Use email dates as fallback\n- Search wider date ranges\n- Generate receipt screenshots\n\nThis may take a few minutes.`)) return;

  showToast('Re-matching all unmatched receipts...', 'info');

  try {
    const response = await fetch('/api/incoming/rematch-all', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({})
    });

    const data = await response.json();

    if (data.ok) {
      const results = data.results || {};
      showToast(`Matched ${results.matched || 0} receipts! (${results.still_unmatched || 0} still unmatched)`, 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Rematch failed', 'error');
    }
  } catch (e) {
    console.error('Rematch error:', e);
    showToast('Error during rematch', 'error');
  }
}

async function cleanSpam() {
  // Spam patterns to auto-reject
  const spamPatterns = [
    // Marketing/promotional
    /sale|discount|promo|offer|deal|save \d+%|limited time|exclusive|flash sale/i,
    /black friday|cyber monday|holiday|clearance/i,
    // Newsletters
    /newsletter|digest|weekly update|daily update|roundup/i,
    // Notifications
    /notification|alert|reminder|update your|verify your|confirm your account/i,
    // Political/news
    /breaking news|campaign|election|donate|petition|urgent action/i,
    // Generic junk
    /unsubscribe|click here|act now|don't miss|hurry/i,
    // Marketing domains (check from_email)
    /mailchimp|sendgrid|constantcontact|hubspot|marketing\.|newsletter\./i
  ];

  // Patterns for forwarded emails (duplicates of originals)
  const forwardedPatterns = [
    /^Fwd:/i,
    /^FW:/i,
    /^Fw:/i
  ];

  // Also reject low-confidence items without amounts
  const pendingReceipts = allReceipts.filter(r => r.status === 'pending');
  const spamToReject = pendingReceipts.filter(r => {
    const subject = r.subject || '';
    const from = r.from_email || '';
    const amount = parseFloat(r.amount) || 0;
    const confidence = r.confidence_score || 0;

    // Check spam patterns in subject or from
    const isSpam = spamPatterns.some(p => p.test(subject) || p.test(from));

    // Forwarded emails are duplicates (original exists elsewhere)
    const isForwarded = forwardedPatterns.some(p => p.test(subject));

    // Self-sent emails with generic subject (manual forwards)
    const isSelfSent = from.toLowerCase().includes('kaplan') &&
                       /^(receipt|receipts)$/i.test(subject.trim());

    // Also reject if no amount and low confidence
    const noAmountLowConf = amount === 0 && confidence < 50;

    // Also reject if category is marketing/newsletter/junk
    const spamCategory = ['marketing', 'newsletter', 'junk', 'notification'].includes((r.category || '').toLowerCase());

    return isSpam || isForwarded || isSelfSent || noAmountLowConf || spamCategory;
  });

  if (spamToReject.length === 0) {
    showToast('No spam found to clean', 'info');
    return;
  }

  // Count categories for display
  const forwarded = spamToReject.filter(r => forwardedPatterns.some(p => p.test(r.subject || ''))).length;
  const noAmount = spamToReject.filter(r => (parseFloat(r.amount) || 0) === 0).length;

  if (!confirm(`Found ${spamToReject.length} items to clean:\n\n- ${forwarded} forwarded emails (duplicates)\n- Marketing/newsletters\n- ${noAmount} items with $0 amount\n\nReject all of these?`)) return;

  showToast(`Rejecting ${spamToReject.length} items...`, 'info');

  try {
    const ids = spamToReject.map(r => r.id);
    const response = await fetch('/api/incoming/bulk-reject', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ ids, reason: 'spam_auto_cleanup' })
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Rejected ${data.rejected || ids.length} items`, 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Cleanup failed', 'error');
    }
  } catch (e) {
    console.error('Cleanup error:', e);
    showToast('Error cleaning spam', 'error');
  }
}

// Clear all dismissed/rejected receipts permanently
async function clearDismissed() {
  const rejectedCount = receipts.filter(r => r.status === 'rejected' || r.status === 'auto_rejected').length;

  if (rejectedCount === 0) {
    showToast('No dismissed receipts to clear', 'info');
    return;
  }

  if (!confirm(`This will permanently delete ${rejectedCount} dismissed receipts.\n\nThis cannot be undone. Continue?`)) return;

  showToast(`Clearing ${rejectedCount} dismissed receipts...`, 'info');

  try {
    const response = await fetch('/api/incoming/clear-rejected', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({})
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Cleared ${data.deleted || rejectedCount} dismissed receipts`, 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to clear dismissed', 'error');
    }
  } catch (e) {
    console.error('Clear dismissed error:', e);
    showToast('Error clearing dismissed receipts', 'error');
  }
}

async function regenerateImages() {
  if (!confirm('This will:\n1. Find and clear text-based screenshots (<50KB)\n2. Regenerate them with proper Playwright browser screenshots\n\nContinue?')) return;

  showToast('Step 1: Finding and clearing text screenshots...', 'info');

  try {
    // First, clear text-based screenshots and regenerate with Playwright
    const response = await fetch('/api/incoming/clear-text-screenshots', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ threshold_kb: 50, limit: 200, regenerate: true })
    });

    const data = await response.json();

    if (data.ok) {
      if (data.cleared > 0) {
        showToast(`Cleared ${data.cleared} text screenshots, regenerated ${data.regenerated} with Playwright`, 'success');
      } else {
        showToast('No text-based screenshots found to clear', 'info');
      }
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to clear text screenshots', 'error');
    }
  } catch (e) {
    console.error('Regenerate error:', e);
    showToast('Error fixing images', 'error');
  }
}

// Regenerate image for single receipt
async function regenerateImage(receiptId) {
  showToast('Generating screenshot...', 'info');

  try {
    const response = await fetch('/api/incoming/generate-images', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ receipt_ids: [receiptId], force: true })
    });

    const data = await response.json();

    if (data.ok && data.success > 0) {
      showToast('Screenshot generated!', 'success');
      // Refresh receipts to get new image URL
      await loadReceipts();
      // Re-open preview with updated data
      showPreview(receiptId);
    } else {
      showToast(data.error || 'Failed to generate screenshot', 'error');
    }
  } catch (e) {
    console.error('Regenerate error:', e);
    showToast('Error generating screenshot', 'error');
  }
}

async function clearAndRescan() {
  if (!confirm('This will DELETE all pending receipts and do a fresh scan. Continue?')) return;
  if (!confirm('Are you sure? This cannot be undone.')) return;

  showToast('Clearing pending receipts...', 'info');

  try {
    // Step 1: Clear pending receipts
    const clearResponse = await fetch('/api/incoming/clear-pending', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ confirm: true })
    });

    const clearData = await clearResponse.json();

    if (!clearData.ok) {
      showToast(clearData.error || 'Failed to clear', 'error');
      return;
    }

    showToast(`Cleared ${clearData.deleted} receipts. Starting fresh scan...`, 'info');

    // Step 2: Scan for new
    const scanResponse = await fetch('/api/incoming/scan', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({})
    });

    const scanData = await scanResponse.json();

    if (scanData.ok) {
      showToast(`Fresh scan complete! Found ${scanData.results.total_new} receipts`, 'success');
      loadReceipts();
    } else {
      showToast(scanData.error || 'Scan failed after clear', 'error');
    }
  } catch (e) {
    console.error('Clear & rescan error:', e);
    showToast('Error during clear & rescan', 'error');
  }
}

async function clearFiltered() {
  if (!confirm('Remove all rejected receipts from the database?')) return;

  try {
    const response = await fetch('/api/incoming/clear-rejected', {
      method: 'POST',
      credentials: 'include'
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Cleared ${data.count} rejected receipts`, 'success');
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to clear', 'error');
    }
  } catch (e) {
    showToast('Error clearing receipts', 'error');
  }
}

async function reprocessMissing() {
  showToast('Re-processing accepted receipts with missing files...', 'info');

  try {
    const response = await fetch('/api/incoming/reprocess-missing', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({})
    });

    const data = await response.json();

    if (data.ok) {
      if (data.processed === 0) {
        showToast('All accepted receipts already have files!', 'success');
      } else {
        showToast(`Fixed ${data.success} of ${data.processed} receipts`, 'success');
      }
      loadReceipts();
    } else {
      showToast(data.error || 'Failed to reprocess', 'error');
    }
  } catch (e) {
    console.error('Reprocess error:', e);
    showToast('Error reprocessing receipts', 'error');
  }
}

async function fixDates() {
  // First do a dry run to show what will be fixed
  showToast('Checking for transactions with wrong dates...', 'info');

  try {
    const dryRunResponse = await fetch('/api/incoming/fix-dates', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ dry_run: true })
    });

    const dryRunData = await dryRunResponse.json();

    if (!dryRunData.ok) {
      showToast(dryRunData.error || 'Failed to check dates', 'error');
      return;
    }

    if (dryRunData.found === 0) {
      showToast('All transaction dates are correct!', 'success');
      return;
    }

    // Show confirmation with details
    const details = dryRunData.results.map(r =>
      `${r.merchant}: ${r.old_date} -> ${r.new_date}`
    ).join('\n');

    if (!confirm(`Found ${dryRunData.found} transaction(s) with wrong dates:\n\n${details}\n\nFix them?`)) {
      return;
    }

    // Actually fix the dates
    showToast('Fixing transaction dates...', 'info');
    const response = await fetch('/api/incoming/fix-dates', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      body: JSON.stringify({ dry_run: false })
    });

    const data = await response.json();

    if (data.ok) {
      showToast(`Fixed ${data.fixed} transaction dates!`, 'success');
    } else {
      showToast(data.error || 'Failed to fix dates', 'error');
    }
  } catch (e) {
    console.error('Fix dates error:', e);
    showToast('Error fixing dates', 'error');
  }
}

function formatDate(dateStr) {
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch {
    return dateStr;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;

  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// Preview Modal Functions
let currentPreviewReceipt = null;

function showPreview(receiptId) {
  const receipt = allReceipts.find(r => r.id === receiptId);
  if (!receipt) return;

  currentPreviewReceipt = receipt;
  const modal = document.getElementById('preview-modal');

  // Populate the modal
  document.getElementById('preview-subject').textContent = receipt.subject || 'No subject';
  document.getElementById('preview-from').textContent = receipt.from_email || 'Unknown sender';

  // Format amount
  const amount = parseFloat(receipt.amount) || 0;
  const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');
  const amountEl = document.getElementById('preview-amount');
  if (amount > 0) {
    if (isRefund) {
      amountEl.textContent = `+$${amount.toFixed(2)}`;
      amountEl.className = 'preview-meta-value large amount-refund';
    } else {
      amountEl.textContent = `-$${amount.toFixed(2)}`;
      amountEl.className = 'preview-meta-value large amount-charge';
    }
  } else {
    amountEl.textContent = 'Not detected';
    amountEl.className = 'preview-meta-value large';
  }

  // Merchant
  const merchant = receipt.merchant || extractMerchantFromSubject(receipt.subject);
  document.getElementById('preview-merchant').textContent = merchant;

  // Date
  const dateStr = receipt.receipt_date || receipt.received_date;
  document.getElementById('preview-date').textContent = dateStr ? formatDate(dateStr) : 'Unknown';

  // AI Notes / Description
  const aiSection = document.getElementById('preview-ai-section');
  if (receipt.description || receipt.ai_notes) {
    aiSection.style.display = 'block';
    document.getElementById('preview-ai-notes').textContent = receipt.description || receipt.ai_notes;
  } else {
    aiSection.style.display = 'none';
  }

  // Match Status Section
  const matchSection = document.getElementById('preview-match-section');
  const matchStatusEl = document.getElementById('preview-match-status');
  if (matchSection && matchStatusEl) {
    if (receipt.matched_transaction_id) {
      matchSection.style.display = 'block';
      if (receipt.match_type === 'needs_receipt') {
        matchStatusEl.innerHTML = `<div class="match-badge needs-receipt" style="font-size:14px;padding:8px 12px;">RECEIPT NEEDED<br><small>Transaction #${receipt.matched_transaction_id}</small></div>`;
      } else if (receipt.match_type === 'has_receipt') {
        matchStatusEl.innerHTML = `<div class="match-badge has-receipt" style="font-size:14px;padding:8px 12px;">Already has receipt<br><small>Transaction #${receipt.matched_transaction_id}</small></div>`;
      }
    } else if (receipt.match_type === 'no_match') {
      matchSection.style.display = 'block';
      matchStatusEl.innerHTML = `<div class="match-badge no-match" style="font-size:14px;padding:8px 12px;">No matching transaction found</div>`;
    } else {
      matchSection.style.display = 'none';
    }
  }

  // Body snippet
  document.getElementById('preview-body').textContent = receipt.body_snippet || 'No preview available';

  // Attachments
  const attachmentsSection = document.getElementById('preview-attachments-section');
  const attachmentsEl = document.getElementById('preview-attachments');
  let attachments = [];
  try {
    attachments = typeof receipt.attachments === 'string' ? JSON.parse(receipt.attachments) : (receipt.attachments || []);
  } catch(e) {}

  if (attachments.length > 0) {
    attachmentsSection.style.display = 'block';
    attachmentsEl.innerHTML = attachments.map(att => {
      const name = typeof att === 'string' ? att : (att.filename || att.name || 'Attachment');
      const icon = getAttachmentIcon(name);
      return `<div class="preview-attachment"><span class="preview-attachment-icon">${icon}</span> ${escapeHtml(name)}</div>`;
    }).join('');
  } else {
    attachmentsSection.style.display = 'none';
  }

  // Receipt Image Preview - now in side-by-side layout (left panel)
  const imageSection = document.getElementById('preview-image-section');
  const imageEl = document.getElementById('preview-receipt-image');
  const previewUrl = receipt.receipt_image_url || receipt.preview_url || receipt.r2_url;

  // Gmail link for viewing the original email - use correct account index
  const emailId = receipt.email_id || '';
  const gmailAccount = receipt.gmail_account || '';
  // Map gmail accounts to their index (adjust based on your Chrome profile order)
  const accountIndex = gmailAccount.includes('downhome') ? 1 : gmailAccount.includes('musiccityrodeo') ? 2 : 0;
  const gmailUrl = emailId ? `https://mail.google.com/mail/u/${accountIndex}/#all/${emailId}` : '';

  // Reset image section to default state
  imageSection.innerHTML = `<img id="preview-receipt-image" src="" alt="Receipt" onclick="this.classList.toggle('zoomed')">`;
  const newImageEl = document.getElementById('preview-receipt-image');

  if (previewUrl) {
    newImageEl.src = previewUrl;
    newImageEl.style.display = 'block';
    newImageEl.onerror = () => {
      // If image fails, show Gmail link or placeholder
      imageSection.innerHTML = `
        <div class="preview-receipt-placeholder">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <path d="m21 15-5-5L5 21"/>
          </svg>
          <div style="font-size:16px;margin-bottom:12px;">Image failed to load</div>
          ${gmailUrl ? `<a href="${gmailUrl}" target="_blank" class="btn-primary" style="text-decoration:none;padding:10px 20px;border-radius:8px;display:inline-block;">üìß View in Gmail</a>` : ''}
        </div>
      `;
    };
  } else {
    // No image URL - show placeholder with Gmail link
    imageSection.innerHTML = `
      <div class="preview-receipt-placeholder">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <path d="m21 15-5-5L5 21"/>
        </svg>
        <div style="font-size:16px;margin-bottom:8px;">No receipt image</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:16px;">Screenshot not generated yet</div>
        ${gmailUrl ? `<a href="${gmailUrl}" target="_blank" class="btn-primary" style="text-decoration:none;padding:10px 20px;border-radius:8px;display:inline-block;">üìß View Original Email</a>` : ''}
        <button onclick="regenerateImage(${receipt.id})" class="btn-secondary" style="margin-top:12px;padding:10px 20px;border-radius:8px;display:block;margin-left:auto;margin-right:auto;">üîÑ Generate Screenshot</button>
      </div>
    `;
  }

  // Account badge
  const accountBadgeEl = document.getElementById('preview-account-badge');
  // gmailAccount already declared above
  let accountClass = 'personal';
  let accountLabel = gmailAccount.split('@')[0] || 'Unknown';
  if (gmailAccount.includes('musiccity')) {
    accountClass = 'mcr';
    accountLabel = 'MCR';
  } else if (gmailAccount.includes('downhome')) {
    accountClass = 'downhome';
    accountLabel = 'DownHome';
  }
  accountBadgeEl.innerHTML = `<span class="account-badge ${accountClass}">${accountLabel}</span>`;

  // Actions
  const actionsEl = document.getElementById('preview-actions');
  const receiptDate = receipt.receipt_date || receipt.received_date || '';
  if (receipt.status === 'pending') {
    actionsEl.innerHTML = `
      <button class="btn-danger" onclick="closePreview();quickReject(${receipt.id})">‚úï Reject</button>
      <button class="btn-success" onclick="closePreview();quickAccept(${receipt.id}, '${escapeHtml(merchant).replace(/'/g, "\\'")}', ${amount}, ${isRefund}, '${receiptDate}')">‚úì Accept</button>
    `;
  } else if (receipt.status === 'rejected') {
    actionsEl.innerHTML = `
      <button class="btn-primary" onclick="closePreview();quickUnreject(${receipt.id})">‚Ü© Restore to Pending</button>
      <span style="color:var(--muted);margin-left:8px">‚úï Rejected</span>
    `;
  } else {
    actionsEl.innerHTML = `<span style="color:var(--muted)">‚úì Accepted</span>`;
  }

  // Show modal
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closePreview() {
  const modal = document.getElementById('preview-modal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
  currentPreviewReceipt = null;
}

function getAttachmentIcon(filename) {
  const ext = (filename || '').split('.').pop().toLowerCase();
  switch(ext) {
    case 'pdf': return 'üìÑ';
    case 'png': case 'jpg': case 'jpeg': case 'gif': case 'webp': return 'üñºÔ∏è';
    case 'html': case 'htm': return 'üåê';
    default: return 'üìé';
  }
}

function openFullImage(src) {
  if (!src) return;

  // Create fullscreen modal viewer
  const existingModal = document.getElementById('fullscreen-image-modal');
  if (existingModal) existingModal.remove();

  const modal = document.createElement('div');
  modal.id = 'fullscreen-image-modal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.95);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: zoom-out;
  `;

  modal.innerHTML = `
    <img src="${src}" alt="Receipt" style="
      max-width: 95vw;
      max-height: 95vh;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 4px 30px rgba(0,0,0,0.5);
    " onclick="event.stopPropagation()">
    <button onclick="this.parentElement.remove()" style="
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.9);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    ">√ó</button>
    <a href="${src}" target="_blank" onclick="event.stopPropagation()" style="
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: var(--accent);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 500;
    ">Open in New Tab</a>
  `;

  modal.onclick = () => modal.remove();
  document.addEventListener('keydown', function escHandler(e) {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  });

  document.body.appendChild(modal);
}

// View mode toggle
let currentViewMode = localStorage.getItem('inbox-view-mode') || 'list';

function setViewMode(mode) {
  currentViewMode = mode;
  localStorage.setItem('inbox-view-mode', mode);

  const container = document.getElementById('mobile-inbox');
  const toggleBtns = document.querySelectorAll('.view-toggle-btn');

  toggleBtns.forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.view-toggle-btn[onclick*="${mode}"]`)?.classList.add('active');

  if (mode === 'grid') {
    container.classList.add('grid-view');
  } else {
    container.classList.remove('grid-view');
  }
}

// Initialize view mode on load
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => setViewMode(currentViewMode), 100);
});

// Keyboard navigation
let currentRowIndex = -1;
let lastShortcutHint = null;

function showQuickAction(text, icon = '‚ö°') {
  const existing = document.querySelector('.quick-action-toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = 'quick-action-toast';
  toast.innerHTML = `${icon} ${text}`;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 800);
}

document.addEventListener('keydown', (e) => {
  // Skip if user is typing in an input
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    if (e.key === 'Escape') e.target.blur();
    return;
  }

  // Handle preview modal shortcuts
  if (document.getElementById('preview-modal').classList.contains('active')) {
    if (e.key === 'Escape') {
      closePreview();
    } else if (currentPreviewReceipt && currentPreviewReceipt.status === 'pending') {
      if (e.key === 'Enter' || e.key === 'a' || e.key === 'A') {
        const r = currentPreviewReceipt;
        const merchant = r.merchant || extractMerchantFromSubject(r.subject);
        const amount = parseFloat(r.amount) || 0;
        const isRefund = r.is_refund || (r.subject || '').toLowerCase().includes('refund');
        const receiptDate = r.receipt_date || r.received_date || '';
        closePreview();
        quickAccept(r.id, merchant, amount, isRefund, receiptDate);
      } else if (e.key === 'r' || e.key === 'R' || e.key === 'Backspace') {
        closePreview();
        quickReject(currentPreviewReceipt.id);
      }
    }
    // N/P for next/previous in preview
    if (e.key === 'n' || e.key === 'N') {
      e.preventDefault();
      navigatePreview(1);
    } else if (e.key === 'p' || e.key === 'P') {
      e.preventDefault();
      navigatePreview(-1);
    }
    return;
  }

  // Global shortcuts
  const key = e.key.toLowerCase();

  // J/K for navigation (like vim)
  if (key === 'j' || e.key === 'ArrowDown') {
    e.preventDefault();
    navigateCards(1);
  } else if (key === 'k' || e.key === 'ArrowUp') {
    e.preventDefault();
    navigateCards(-1);
  }
  // Home/End for first/last
  else if (e.key === 'Home' || (key === 'g' && e.shiftKey)) {
    e.preventDefault();
    currentRowIndex = -1;
    navigateCards(1);
  } else if (e.key === 'End' || key === 'g') {
    if (!e.shiftKey && key === 'g') {
      e.preventDefault();
      const visible = getVisibleReceipts();
      currentRowIndex = visible.length - 2;
      navigateCards(1);
    }
  }
  // / for search focus
  else if (key === '/') {
    e.preventDefault();
    document.getElementById('search-input')?.focus();
  }
  // Enter to open preview on selected card
  else if (key === 'enter' && currentRowIndex >= 0) {
    e.preventDefault();
    const visibleReceipts = getVisibleReceipts();
    if (visibleReceipts[currentRowIndex]) {
      showPreview(visibleReceipts[currentRowIndex].id);
    }
  }
  // A to accept selected (without shift)
  else if (key === 'a' && !e.shiftKey && currentRowIndex >= 0) {
    e.preventDefault();
    const receipt = getVisibleReceipts()[currentRowIndex];
    if (receipt && receipt.status === 'pending') {
      showQuickAction('Accepting...', '‚úì');
      const merchant = receipt.merchant || extractMerchantFromSubject(receipt.subject);
      const amount = parseFloat(receipt.amount) || 0;
      const isRefund = receipt.is_refund || (receipt.subject || '').toLowerCase().includes('refund');
      const receiptDate = receipt.receipt_date || receipt.received_date || '';
      quickAccept(receipt.id, merchant, amount, isRefund, receiptDate);
    }
  }
  // X or D to reject selected
  else if ((key === 'x' || key === 'd') && currentRowIndex >= 0) {
    e.preventDefault();
    const receipt = getVisibleReceipts()[currentRowIndex];
    if (receipt && receipt.status === 'pending') {
      showQuickAction('Rejecting...', '‚úï');
      quickReject(receipt.id);
    }
  }
  // Shift+A to batch accept all visible
  else if (key === 'a' && e.shiftKey) {
    e.preventDefault();
    batchAcceptVisible();
  }
  // V to toggle view mode
  else if (key === 'v') {
    e.preventDefault();
    setViewMode(currentViewMode === 'list' ? 'grid' : 'list');
    showQuickAction(currentViewMode === 'grid' ? 'Grid View' : 'List View', 'üìã');
  }
  // 1-4 for quick filter
  else if (key === '1') { filterStatus('pending'); showQuickAction('Inbox', 'üì•'); }
  else if (key === '2') { filterStatus('accepted'); showQuickAction('Matched', 'üîó'); }
  else if (key === '3') { filterStatus('rejected'); showQuickAction('Dismissed', '‚úï'); }
  else if (key === '4') { filterStatus('all'); showQuickAction('All', 'üìã'); }
  // R to refresh
  else if (key === 'r' && !e.shiftKey && currentRowIndex < 0) {
    e.preventDefault();
    loadReceipts();
    showQuickAction('Refreshing...', 'üîÑ');
  }
  // S to scan for new
  else if (key === 's' && !e.shiftKey) {
    e.preventDefault();
    scanForNew();
    showQuickAction('Scanning...', 'üìß');
  }
  // ? for help
  else if (key === '?') {
    e.preventDefault();
    showKeyboardHelp();
  }
  // Escape to clear selection
  else if (e.key === 'Escape') {
    currentRowIndex = -1;
    clearCardSelection();
  }
});

function getVisibleReceipts() {
  // Use the same filtering logic as getSortedReceipts for consistency
  return getSortedReceipts();
}

function navigateCards(direction) {
  const visibleReceipts = getVisibleReceipts();
  if (visibleReceipts.length === 0) return;

  currentRowIndex = Math.max(0, Math.min(visibleReceipts.length - 1, currentRowIndex + direction));

  // Clear all selections
  document.querySelectorAll('.inbox-card.selected').forEach(c => c.classList.remove('selected'));
  document.querySelectorAll('tbody tr').forEach(r => r.style.background = '');

  // Highlight current card (mobile view)
  const cards = document.querySelectorAll('.inbox-card:not(.compact)');
  const cardArray = Array.from(cards);
  if (cardArray[currentRowIndex]) {
    cardArray[currentRowIndex].classList.add('selected');
    cardArray[currentRowIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  // Also highlight table row (desktop view)
  const rows = document.querySelectorAll('tbody tr:not(.hidden)');
  if (rows[currentRowIndex]) {
    rows[currentRowIndex].style.background = 'rgba(0,255,136,0.1)';
  }
}

function clearCardSelection() {
  document.querySelectorAll('.inbox-card.selected').forEach(c => c.classList.remove('selected'));
  document.querySelectorAll('tbody tr').forEach(r => r.style.background = '');
}

function navigatePreview(direction) {
  if (!currentPreviewReceipt) return;

  const visible = getVisibleReceipts();
  const currentIndex = visible.findIndex(r => r.id === currentPreviewReceipt.id);
  if (currentIndex === -1) return;

  const newIndex = Math.max(0, Math.min(visible.length - 1, currentIndex + direction));
  if (newIndex !== currentIndex && visible[newIndex]) {
    showPreview(visible[newIndex].id);
    currentRowIndex = newIndex;
  }
}

// Legacy function name for compatibility
function navigateRows(direction) {
  navigateCards(direction);
}

async function batchAcceptVisible() {
  const pending = allReceipts.filter(r => r.status === 'pending');
  if (pending.length === 0) {
    showToast('No pending receipts to accept', 'info');
    return;
  }

  if (!confirm(`Accept all ${pending.length} pending receipts?`)) return;

  showToast(`Processing ${pending.length} receipts...`, 'info');
  let success = 0;

  for (const r of pending) {
    const merchant = r.merchant || extractMerchantFromSubject(r.subject);
    const amount = parseFloat(r.amount) || 0;
    const isRefund = r.is_refund || (r.subject || '').toLowerCase().includes('refund');
    const receiptDate = r.receipt_date || r.received_date || '';

    try {
      const response = await fetch('/api/incoming/accept', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          receipt_id: r.id,
          merchant,
          amount,
          is_refund: isRefund,
          date: receiptDate ? receiptDate.split('T')[0] : new Date().toISOString().split('T')[0],
          business_type: 'Personal'
        })
      });
      if (response.ok) success++;
    } catch (e) { console.error(e); }
  }

  showToast(`Accepted ${success}/${pending.length} receipts`, 'success');
  loadReceipts();
}

function showKeyboardHelp() {
  const helpHtml = `
    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(8px);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px" onclick="this.remove()">
      <div style="background:var(--panel);padding:28px;border-radius:16px;max-width:560px;width:100%;border:1px solid var(--edge);box-shadow:0 20px 60px rgba(0,0,0,0.5)" onclick="event.stopPropagation()">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <span style="font-size:24px">‚å®Ô∏è</span>
          <h3 style="margin:0;font-size:18px;font-weight:700">Keyboard Shortcuts</h3>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
          <div>
            <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;font-weight:600">Navigation</div>
            <div style="display:grid;gap:6px;font-size:13px">
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">J</kbd><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">‚Üì</kbd> Next</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">K</kbd><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">‚Üë</kbd> Previous</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">Enter</kbd> Open preview</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">N</kbd><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">P</kbd> Next/Prev in preview</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">Esc</kbd> Close / Clear selection</div>
            </div>
          </div>

          <div>
            <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;font-weight:600">Actions</div>
            <div style="display:grid;gap:6px;font-size:13px">
              <div><kbd style="background:rgba(0,255,136,0.2);color:var(--ok);padding:3px 8px;border-radius:4px;border:1px solid var(--ok);font-family:monospace;margin-right:8px">A</kbd> Accept selected</div>
              <div><kbd style="background:rgba(255,78,106,0.2);color:var(--bad);padding:3px 8px;border-radius:4px;border:1px solid var(--bad);font-family:monospace;margin-right:8px">X</kbd><kbd style="background:rgba(255,78,106,0.2);color:var(--bad);padding:3px 8px;border-radius:4px;border:1px solid var(--bad);font-family:monospace;margin-right:8px">D</kbd> Reject selected</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">Shift+A</kbd> Accept all pending</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">S</kbd> Scan for new</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">R</kbd> Refresh list</div>
            </div>
          </div>

          <div>
            <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;font-weight:600">Filters</div>
            <div style="display:grid;gap:6px;font-size:13px">
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">1</kbd> Inbox (Pending)</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">2</kbd> Matched</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">3</kbd> Dismissed</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">4</kbd> All</div>
            </div>
          </div>

          <div>
            <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;font-weight:600">View</div>
            <div style="display:grid;gap:6px;font-size:13px">
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">V</kbd> Toggle List/Grid</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">/</kbd> Focus search</div>
              <div><kbd style="background:var(--panel2);padding:3px 8px;border-radius:4px;border:1px solid var(--edge);font-family:monospace;margin-right:8px">?</kbd> This help</div>
            </div>
          </div>
        </div>

        <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--edge);display:flex;gap:12px;justify-content:flex-end">
          <span style="color:var(--muted);font-size:12px;margin-right:auto">Pro tip: Use <kbd style="background:var(--panel2);padding:2px 6px;border-radius:4px;font-family:monospace;font-size:11px">J</kbd>/<kbd style="background:var(--panel2);padding:2px 6px;border-radius:4px;font-family:monospace;font-size:11px">K</kbd> then <kbd style="background:var(--panel2);padding:2px 6px;border-radius:4px;font-family:monospace;font-size:11px">A</kbd> to quickly process receipts</span>
          <button class="btn-primary" onclick="this.closest('[onclick]').remove()" style="padding:10px 20px">Got it!</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', helpHtml);
}
</script>

</body>
</html>
