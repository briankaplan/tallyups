<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<script>
// Force dark mode immediately - prevent flash of light mode
document.documentElement.setAttribute('data-theme', 'dark');
localStorage.setItem('theme', 'dark');
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="AI-powered receipt management and expense tracking system">
<meta name="theme-color" content="#0b0d10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.json">
<!-- Preconnect to external resources for faster loading -->
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<!-- Critical CSS - loads first -->
<link rel="stylesheet" href="/static/css/legendary/index.css">
<link rel="stylesheet" href="/static/css/reconciler-extracted.css">
<title>Tallyups - Expense Management</title>
<link rel="icon" type="image/svg+xml" href="/static/icon.svg">
<link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
<!-- All scripts deferred to not block HTML parsing -->
<script src="/static/js/design-system.js" defer></script>
<script src="/static/js/image-utils.js" defer></script>
<script src="/static/js/business-types.js" defer></script>
<script src="/static/js/unified-header.js" defer></script>
<script src="/static/js/app-shell.js" defer></script>
<script src="/static/js/keyboard.js" defer></script>
<script src="/static/js/bulk-actions.js" defer></script>
</head>
<body>

<!-- Header injected by unified-header.js -->

<!-- Main Layout -->
<!-- Home Page (default) -->
<div id="home-page" class="page-content">
<div class="main">
  <!-- Left Panel -->
  <div class="left">
    <!-- Dashboard - Collapsible Stats -->
    <div class="dashboard-container">
      <div class="dashboard-toggle" onclick="toggleDashboard()">
        <div class="dashboard-toggle-label">
          <span class="dashboard-toggle-arrow" id="dashboard-arrow">â–¼</span>
          <span>Stats Overview</span>
        </div>
        <div class="dashboard-summary" id="dashboard-summary">
          <span class="dashboard-summary-item">Hover or click to expand</span>
        </div>
      </div>
      <div class="dashboard" id="dashboard">
        <div class="stat">
          <div class="stat-label">Down Home</div>
          <div class="stat-value" id="down-home-total">$0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Music City Rodeo</div>
          <div class="stat-value" id="mcr-total">$0</div>
        </div>
        <div class="stat">
          <div class="stat-label">EM.co</div>
          <div class="stat-value" id="emco-total">$0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Personal</div>
          <div class="stat-value" id="personal-total">$0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Credit Card Payments</div>
          <div class="stat-value pos" id="payments-total">$0</div>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-group">
        <!-- Mobile Filter Button (hidden on desktop) -->
        <button class="mobile-filter-btn" onclick="openFilterSheet()" style="display:none" title="Filter transactions">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
          </svg>
          Filters
          <span class="filter-count" id="mobile-filter-count" style="display:none">0</span>
        </button>
        <button class="btn-ghost" onclick="openManualEntryModal()" title="Add a manual expense entry">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Manual Entry
        </button>
        <button class="btn-primary" onclick="smartSearchMissing()" title="Find missing receipts automatically using AI, Gmail, and iMessage">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          Find Receipts
        </button>
        <button class="btn-ghost" onclick="autoProcessAll()" title="Auto-categorize AND generate AI descriptions in one step">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 2a10 10 0 0 1 10 10"/><circle cx="12" cy="12" r="3"/></svg>
          Auto-Process
        </button>
        <button class="btn-ghost" onclick="generateAllNotes()" title="Generate AI notes for all transactions missing them">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          AI Notes
        </button>
        <button class="btn-success" onclick="saveCSV()" title="Save all changes to database">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save
        </button>
        <div class="toolbar-divider"></div>
        <!-- Batch Operations -->
        <button class="btn-ghost" id="batch-select-btn" onclick="toggleBatchMode()" title="Select multiple transactions for bulk operations">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
          Batch
        </button>
        <div id="batch-actions" style="display:none;gap:6px" class="toolbar-group">
          <button class="btn-ghost btn-sm" onclick="selectAllVisible()">Select All</button>
          <button class="btn-ghost btn-sm" onclick="clearSelection()">Clear</button>
          <select id="batch-business-select" class="input" style="width:140px;font-size:12px" onchange="batchSetBusiness(this.value)">
            <option value="">Set Business...</option>
            <!-- Populated dynamically by BusinessTypes.populateSelect() -->
          </select>
          <select id="batch-status-select" class="input" style="width:130px;font-size:12px" onchange="batchSetStatus(this.value)">
            <option value="">Set Status...</option>
            <option value="good">Good</option>
            <option value="bad">Bad</option>
            <option value="not needed">Not Needed</option>
          </select>
          <div class="toolbar-divider"></div>
          <button class="btn-primary btn-sm" onclick="addSelectedToReport()" title="Add selected transactions to current report">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/></svg>
            Add to Report
          </button>
          <span id="batch-count" style="font-size:11px;color:var(--muted);margin-left:8px">0 selected</span>
        </div>
      </div>
      <div class="toolbar-divider"></div>
      <div class="toolbar-group" style="gap:8px">
        <!-- Advanced Search -->
        <div style="position:relative">
          <input type="text" class="input" id="search" placeholder="/ Search..." style="width:200px;padding-left:32px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted)"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        </div>
        <button class="btn-ghost btn-sm" onclick="toggleAdvancedSearch()" title="Advanced Search Filters" id="advanced-search-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
        </button>
      </div>
    </div>

    <!-- Advanced Search Panel (hidden by default) -->
    <div id="advanced-search-panel" style="display:none;padding:12px 20px;background:var(--panel2);border-bottom:1px solid var(--edge);gap:16px" class="filters">
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:11px;color:var(--muted);font-weight:600">AMOUNT:</label>
        <input type="number" id="search-amount-min" class="input" placeholder="Min" style="width:80px;font-size:12px" step="0.01">
        <span style="color:var(--muted)">-</span>
        <input type="number" id="search-amount-max" class="input" placeholder="Max" style="width:80px;font-size:12px" step="0.01">
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:11px;color:var(--muted);font-weight:600">DATE:</label>
        <input type="date" id="search-date-from" class="input" style="width:130px;font-size:12px">
        <span style="color:var(--muted)">-</span>
        <input type="date" id="search-date-to" class="input" style="width:130px;font-size:12px">
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:11px;color:var(--muted);font-weight:600">MERCHANT:</label>
        <input type="text" id="search-merchant" class="input" placeholder="Merchant name..." style="width:150px;font-size:12px">
      </div>
      <button class="btn-primary btn-sm" onclick="applyAdvancedSearch()">Apply</button>
      <button class="btn-ghost btn-sm" onclick="clearAdvancedSearch()">Clear</button>
    </div>

    <!-- Filters -->
    <div class="filters">
      <span style="font-size:12px;color:var(--muted);font-weight:600">FILTERS:</span>
      <div class="chip chip-with-badge" data-filter="all">
        All <span class="notification-badge" id="all-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="needs-review">
        Needs Review <span class="notification-badge" id="needs-review-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="good">
        Good <span class="notification-badge" id="good-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="bad">
        Bad <span class="notification-badge" id="bad-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="missing">
        Missing Receipts <span class="notification-badge" id="missing-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="with-receipts">
        With Receipts <span class="notification-badge" id="with-receipts-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="not-needed">
        Not Needed <span class="notification-badge" id="not-needed-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="refunds">
        Refunds <span class="notification-badge" id="refunds-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="already-submitted">
        Already Submitted <span class="notification-badge" id="already-submitted-count">0</span>
      </div>
      <div class="toolbar-divider"></div>
      <span style="font-size:12px;color:var(--muted);font-weight:600">RECEIPTS:</span>
      <div class="chip chip-with-badge" data-filter="receipt-verified" style="border-color:#22c55e">
        âœ“âœ“ Verified <span class="notification-badge" id="receipt-verified-count" style="background:#22c55e">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="receipt-mismatch" style="border-color:#ef4444">
        âœ— Mismatch <span class="notification-badge" id="receipt-mismatch-count" style="background:#ef4444">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="receipt-error" style="border-color:#f59e0b">
        âš  Error <span class="notification-badge" id="receipt-error-count" style="background:#f59e0b">0</span>
      </div>
      <div class="toolbar-divider"></div>
      <span style="font-size:12px;color:var(--muted);font-weight:600">BUSINESS:</span>
      <div id="business-type-chips" style="display:contents">
        <!-- Populated dynamically by initBusinessTypeChips() -->
      </div>
      <div class="chip chip-with-badge" data-biz="Unassigned">
        Unassigned <span class="notification-badge" id="unassigned-count">0</span>
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrap">
      <table id="dataTable">
        <thead>
          <tr>
            <th data-sort="Chase Date">Date</th>
            <th data-sort="MI Merchant">Merchant</th>
            <th data-sort="Chase Amount">Amount</th>
            <th data-sort="MI Category">Category</th>
            <th data-sort="Business Type">Business</th>
            <th data-sort="Review Status">Status</th>
            <th data-sort="Receipt File">Receipt</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Mobile Card View (shown on phones only) -->
    <div class="mobile-cards" id="mobile-cards">
      <!-- Cards are rendered by JavaScript -->
    </div>
  </div>

  <!-- Resizable Divider -->
  <div class="divider" id="divider"></div>

  <!-- Right Panel: Receipt Viewer -->
  <div class="right">
    <div class="viewer-container">
      <div class="viewer-header">
        <div class="viewer-title" id="viewer-title">Receipt Viewer</div>
        <div class="viewer-controls">
          <button class="icon-btn" onclick="rotateImage()" title="Rotate (R)">ğŸ”„</button>
          <button class="icon-btn" onclick="resetZoom()" title="Reset (0)">âŠ™</button>
          <button class="icon-btn" onclick="openQuickViewer()" title="Quick View (Q)">â›¶</button>
        </div>
      </div>
      <div class="viewer-content" id="viewer-content">
        <div class="panzoom-wrap" id="panzoom-wrap">
          <div class="no-receipt">
            <div class="no-receipt-icon">ğŸ“„</div>
            <div class="no-receipt-text">Select a transaction to view receipt</div>
          </div>
        </div>
        <div class="zoom-controls">
          <button class="icon-btn" onclick="zoomIn()" title="Zoom In (+)">+</button>
          <button class="icon-btn" onclick="zoomOut()" title="Zoom Out (-)">âˆ’</button>
          <button class="icon-btn" onclick="resetZoom()" title="Reset (0)">0</button>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
<!-- End Home Page -->

<!-- Reports Page -->
<div id="reports-page" class="page-content" style="display:none">
  <div style="max-width:1400px;margin:0 auto;padding:24px">
    <!-- Hero Header -->
    <div style="margin-bottom:32px;background:linear-gradient(135deg, rgba(0,255,136,.1), rgba(0,204,106,.1));padding:32px;border-radius:16px;border:1px solid rgba(0,255,136,.2)">
      <div style="display:flex;align-items:center;gap:16px">
        <div style="width:56px;height:56px;background:linear-gradient(135deg, #00ff88, #00cc6a);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 16px rgba(0,255,136,.4)">ğŸ“Š</div>
        <div style="flex:1">
          <h2 style="margin:0;font-size:28px;font-weight:800;background:linear-gradient(135deg, #00ff88, #00cc6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Expense Reports</h2>
          <p style="margin:4px 0 0 0;color:var(--muted);font-size:14px">Review transactions, verify receipts, and create expense reports</p>
        </div>
      </div>
    </div>

    <!-- Create Report CTA -->
    <div style="background:linear-gradient(145deg, var(--panel), var(--panel2));padding:32px;border-radius:16px;border:1px solid var(--edge);margin-bottom:28px;box-shadow:0 4px 24px rgba(0,0,0,.2);text-align:center">
      <div style="font-size:48px;margin-bottom:16px">ğŸ¯</div>
      <h3 style="margin:0 0 8px 0;font-size:24px;font-weight:700">Create New Report</h3>
      <p style="margin:0 0 24px 0;color:var(--muted);max-width:500px;margin-left:auto;margin-right:auto">
        Review each transaction with its receipt side-by-side. Verify matches, add to report, and export when done.
      </p>
      <a href="/reports" style="display:inline-flex;align-items:center;gap:10px;padding:16px 32px;font-size:16px;font-weight:700;border-radius:12px;background:linear-gradient(135deg, #00ff88, #00cc6a);color:#000;text-decoration:none;box-shadow:0 4px 20px rgba(0,255,136,.4);transition:all .2s">
        <span>Start Report Builder</span>
        <span style="font-size:20px">â†’</span>
      </a>
      <div style="margin-top:16px;display:flex;justify-content:center;gap:24px;color:var(--muted);font-size:13px">
        <span>âŒ¨ï¸ Keyboard shortcuts</span>
        <span>ğŸ‘ï¸ Side-by-side view</span>
        <span>ğŸ“Š Progress tracking</span>
      </div>
    </div>

    <!-- Draft Reports Section -->
    <div id="draft-reports-section" style="margin-bottom:28px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <h3 style="margin:0;font-size:18px;font-weight:700;display:flex;align-items:center;gap:10px">
          <span style="font-size:22px">ğŸ“</span>
          Draft Reports
          <span id="draft-reports-count" style="background:var(--edge);color:var(--muted);padding:2px 8px;border-radius:10px;font-size:12px;font-weight:600">0</span>
        </h3>
        <button class="btn-secondary" onclick="refreshDraftReports()" style="padding:8px 12px;font-size:12px">
          ğŸ”„ Refresh
        </button>
      </div>
      <div id="draft-reports-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px">
        <!-- Draft report cards will be populated here -->
        <div id="draft-reports-empty" style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);background:var(--panel);border-radius:12px;border:1px dashed var(--edge)">
          <div style="font-size:32px;margin-bottom:12px;opacity:0.5">ğŸ“‹</div>
          <p style="margin:0">No draft reports yet. Use <kbd style="background:var(--edge);padding:2px 6px;border-radius:4px;font-size:11px">R</kbd> in the viewer to add transactions to a report.</p>
        </div>
      </div>
    </div>

    <!-- Report Preview (hidden, kept for legacy) -->
    <div id="report-preview-section" style="display:none">
      <div style="background:var(--panel);padding:24px;border-radius:12px;border:1px solid var(--edge);margin-bottom:24px">
        <!-- Summary Stats -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px">
          <div style="background:linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);color:#000;padding:20px;border-radius:10px">
            <div style="font-size:13px;opacity:0.8;margin-bottom:4px;font-weight:600">Total Amount</div>
            <div style="font-size:32px;font-weight:700" id="report-total-amount">$0.00</div>
          </div>
          <div style="background:var(--panel2);padding:20px;border-radius:10px;border:1px solid var(--edge)">
            <div style="font-size:13px;color:var(--muted);margin-bottom:4px">Expenses</div>
            <div style="font-size:32px;font-weight:700;color:#00ff88" id="report-expense-count">0</div>
          </div>
          <div style="background:var(--panel2);padding:20px;border-radius:10px;border:1px solid var(--edge)">
            <div style="font-size:13px;color:var(--muted);margin-bottom:4px">Receipts</div>
            <div style="font-size:32px;font-weight:700;color:#00ff88" id="report-receipt-count">0</div>
          </div>
        </div>

        <!-- Actions -->
        <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center">
          <input type="text" id="report-name" class="input" placeholder="Report Name (e.g., Q1 2024 Down Home)" style="flex:1">
          <button class="btn-success" onclick="submitReport()">
            ğŸ“¤ Submit Report
          </button>
        </div>

        <!-- Additional Actions (shown after report is submitted) -->
        <div id="report-actions" style="display:none;padding:16px;background:var(--panel2);border-radius:8px;margin-bottom:20px">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
            <button class="btn-primary" onclick="viewReportPage()" id="view-report-btn">
              ğŸ“Š View Report Page
            </button>
            <button class="btn-primary" onclick="downloadReportCSV()" id="download-csv-btn">
              ğŸ“„ Download CSV
            </button>
            <button class="btn-primary" onclick="downloadReportReceipts()" id="download-receipts-btn">
              ğŸ“¦ Download Receipts ZIP
            </button>
            <button class="btn-secondary" onclick="copyReportLink()" id="copy-link-btn">
              ğŸ”— Copy Report Link
            </button>
            <button class="btn-secondary" onclick="startNewReport()" style="margin-left:auto">
              â• New Report
            </button>
          </div>
        </div>

        <div style="max-height:400px;overflow-y:auto;border:1px solid var(--edge);border-radius:8px">
          <table style="width:100%;border-collapse:collapse">
            <thead style="background:var(--panel2);position:sticky;top:0">
              <tr>
                <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Date</th>
                <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Description</th>
                <th style="padding:10px;text-align:right;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Amount</th>
                <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Category</th>
                <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Notes</th>
              </tr>
            </thead>
            <tbody id="report-preview-table">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Archived Reports -->
    <div style="background:linear-gradient(145deg, var(--panel), var(--panel2));padding:28px;border-radius:16px;border:1px solid var(--edge);box-shadow:0 4px 24px rgba(0,0,0,.2)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
        <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ“</div>
        <div>
          <h3 style="margin:0;font-size:18px;font-weight:700">Submitted Reports</h3>
          <p style="margin:4px 0 0 0;font-size:13px;color:var(--muted)">Previously submitted expense reports</p>
        </div>
      </div>

      <div id="archived-reports-list" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(340px, 1fr));gap:20px">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>
</div>
<!-- End Reports Page -->

<!-- Stats Page -->
<div id="stats-page" class="page-content" style="display:none">
  <div style="max-width:1400px;margin:0 auto;padding:24px">
    <!-- Hero Header -->
    <div style="margin-bottom:32px;background:linear-gradient(135deg, rgba(0,255,136,.1), rgba(0,204,106,.1));padding:32px;border-radius:16px;border:1px solid rgba(0,255,136,.2)">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:16px">
          <div style="width:56px;height:56px;background:linear-gradient(135deg, #00ff88, #00cc6a);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 16px rgba(0,255,136,.4)">ğŸ“ˆ</div>
          <div>
            <h2 style="margin:0;font-size:28px;font-weight:800;background:linear-gradient(135deg, #00ff88, #00cc6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Financial Analytics</h2>
            <p style="margin:4px 0 0 0;color:var(--muted);font-size:14px">Real-time spending insights and data</p>
          </div>
        </div>
        <button onclick="loadStatsPage()" style="background:rgba(0,255,136,.2);border:1px solid rgba(0,255,136,.3);color:#00ff88;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600">ğŸ”„ Refresh</button>
      </div>
    </div>

    <!-- Overview Cards Row -->
    <div style="display:grid;grid-template-columns:repeat(5, 1fr);gap:16px;margin-bottom:28px">
      <div style="background:linear-gradient(135deg, #00ff88, #00cc6a);padding:20px;border-radius:12px;color:#000">
        <div style="font-size:12px;font-weight:600;opacity:0.7;margin-bottom:6px">TOTAL SPENT</div>
        <div style="font-size:28px;font-weight:800" id="stats-total-spent">$0</div>
        <div style="font-size:11px;margin-top:6px;opacity:0.6" id="stats-total-count">0 transactions</div>
      </div>
      <div style="background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--edge)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">RECEIPTS MATCHED</div>
        <div style="font-size:28px;font-weight:800;color:#00ff88" id="stats-receipts-matched">0</div>
        <div style="font-size:11px;margin-top:6px;color:var(--muted)" id="stats-match-rate">0% coverage</div>
      </div>
      <div style="background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--edge)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">FROM GMAIL</div>
        <div style="font-size:28px;font-weight:800;color:#00ff88" id="stats-gmail-receipts">0</div>
        <div style="font-size:11px;margin-top:6px;color:var(--muted)" id="stats-gmail-pct">0% of receipts</div>
      </div>
      <div style="background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--edge)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">REFUNDS</div>
        <div style="font-size:28px;font-weight:800;color:#00ff88" id="stats-refunds">$0</div>
        <div style="font-size:11px;margin-top:6px;color:var(--muted)" id="stats-refund-count">0 transactions</div>
      </div>
      <div style="background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--edge)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">PAYMENTS</div>
        <div style="font-size:28px;font-weight:800;color:#00ff88" id="stats-payments">$0</div>
        <div style="font-size:11px;margin-top:6px;color:var(--muted)" id="stats-payment-count">0 transactions</div>
      </div>
    </div>

    <!-- Business Type Breakdown & Interest/Fees -->
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-bottom:28px">
      <!-- Business Type Breakdown -->
      <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ¢</div>
          <h3 style="margin:0;font-size:18px;font-weight:700">By Business Type</h3>
        </div>
        <div id="stats-business-breakdown" style="display:flex;flex-direction:column;gap:16px">
          <!-- Populated by JS -->
          <div style="color:var(--muted);text-align:center;padding:20px">Loading...</div>
        </div>
      </div>

      <!-- Interest & Fees -->
      <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div style="width:36px;height:36px;background:rgba(255,78,106,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ’³</div>
          <h3 style="margin:0;font-size:18px;font-weight:700">Interest & Fees</h3>
        </div>
        <div id="stats-interest-fees" style="display:flex;flex-direction:column;gap:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--panel2);border-radius:8px">
            <span style="color:var(--muted)">Interest Charges</span>
            <span style="font-weight:700;color:#ff4e6a" id="stats-interest-total">$0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--panel2);border-radius:8px">
            <span style="color:var(--muted)">Fees</span>
            <span style="font-weight:700;color:#ff4e6a" id="stats-fees-total">$0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--panel2);border-radius:8px">
            <span style="color:var(--muted)">Late Charges</span>
            <span style="font-weight:700;color:#ff4e6a" id="stats-late-total">$0</span>
          </div>
          <div style="border-top:1px solid var(--edge);margin-top:8px;padding-top:12px;display:flex;justify-content:space-between;align-items:center">
            <span style="font-weight:600">Total Lost to Fees</span>
            <span style="font-weight:800;color:#ff4e6a;font-size:20px" id="stats-total-fees">$0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Subscriptions Section -->
    <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge);margin-bottom:28px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ”„</div>
          <div>
            <h3 style="margin:0;font-size:18px;font-weight:700">Recurring Subscriptions</h3>
            <p style="margin:2px 0 0 0;font-size:12px;color:var(--muted)">Auto-detected recurring charges</p>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:24px;font-weight:800;color:#00ff88" id="stats-monthly-subs">$0</div>
          <div style="font-size:11px;color:var(--muted)">total subscription spend</div>
        </div>
      </div>
      <div id="stats-subscriptions" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));gap:12px">
        <!-- Populated by JS -->
        <div style="color:var(--muted);text-align:center;padding:20px;grid-column:1/-1">Loading subscriptions...</div>
      </div>
    </div>

    <!-- Top Merchants & Categories -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:28px">
      <!-- Top Merchants -->
      <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸª</div>
          <h3 style="margin:0;font-size:18px;font-weight:700">Top Merchants</h3>
        </div>
        <div id="stats-top-merchants" style="display:flex;flex-direction:column;gap:10px">
          <!-- Populated by JS -->
          <div style="color:var(--muted);text-align:center;padding:20px">Loading...</div>
        </div>
      </div>

      <!-- Top Categories -->
      <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ“‚</div>
          <h3 style="margin:0;font-size:18px;font-weight:700">Spending by Category</h3>
        </div>
        <div id="stats-top-categories" style="display:flex;flex-direction:column;gap:10px">
          <!-- Populated by JS -->
          <div style="color:var(--muted);text-align:center;padding:20px">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Receipt Source Breakdown -->
    <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
        <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ“§</div>
        <h3 style="margin:0;font-size:18px;font-weight:700">Receipt Sources</h3>
      </div>
      <div id="stats-receipt-sources" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(180px, 1fr));gap:16px">
        <!-- Populated by JS -->
        <div style="color:var(--muted);text-align:center;padding:20px;grid-column:1/-1">Loading...</div>
      </div>
    </div>
  </div>
</div>
<!-- End Stats Page -->

<!-- Hotkey Menu Modal -->
<div class="modal-overlay" id="hotkey-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">âŒ¨ï¸ Keyboard Shortcuts</div>
      <button class="modal-close" onclick="toggleHotkeyMenu()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="hotkey-grid">
        <div class="hotkey-section">
          <div class="hotkey-section-title">ğŸ¬ Actions</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">AI Match Receipt</span>
            <span class="hotkey-key"><span class="kbd">A</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Generate AI Note</span>
            <span class="hotkey-key"><span class="kbd">J</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Missing Receipt Form</span>
            <span class="hotkey-key"><span class="kbd">F</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Detach Receipt</span>
            <span class="hotkey-key"><span class="kbd">X</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Save Changes</span>
            <span class="hotkey-key"><span class="kbd">Ctrl</span><span class="kbd">S</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Undo Last Change</span>
            <span class="hotkey-key"><span class="kbd">Ctrl</span><span class="kbd">Z</span></span>
          </div>
        </div>

        <div class="hotkey-section">
          <div class="hotkey-section-title">âœ… Review Status</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Mark Good</span>
            <span class="hotkey-key"><span class="kbd">G</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Mark Bad</span>
            <span class="hotkey-key"><span class="kbd">B</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Mark Not Needed</span>
            <span class="hotkey-key"><span class="kbd">N</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Clear Status</span>
            <span class="hotkey-key"><span class="kbd">C</span></span>
          </div>
        </div>

        <div class="hotkey-section">
          <div class="hotkey-section-title">ğŸ¢ Business Type</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Music City Rodeo</span>
            <span class="hotkey-key"><span class="kbd">M</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Down Home</span>
            <span class="hotkey-key"><span class="kbd">D</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">EM.co</span>
            <span class="hotkey-key"><span class="kbd">E</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Personal</span>
            <span class="hotkey-key"><span class="kbd">P</span></span>
          </div>
        </div>

        <div class="hotkey-section">
          <div class="hotkey-section-title">ğŸ” Viewer</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Quick View</span>
            <span class="hotkey-key"><span class="kbd">Q</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Navigate Receipts</span>
            <span class="hotkey-key"><span class="kbd">â† â†’</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Jump to Position (10%-90%)</span>
            <span class="hotkey-key"><span class="kbd">1-9</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">First / Last Receipt</span>
            <span class="hotkey-key"><span class="kbd">Home</span> <span class="kbd">End</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Zoom In / Out (Quick View)</span>
            <span class="hotkey-key"><span class="kbd">+</span><span class="kbd">âˆ’</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Reset Zoom (Quick View)</span>
            <span class="hotkey-key"><span class="kbd">0</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Close Quick View</span>
            <span class="hotkey-key"><span class="kbd">ESC</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Rotate Image (Main)</span>
            <span class="hotkey-key"><span class="kbd">R</span></span>
          </div>
        </div>

        <div class="hotkey-section">
          <div class="hotkey-section-title">âŒ¨ï¸ Navigation</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Previous Row</span>
            <span class="hotkey-key"><span class="kbd">â†‘</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Next Row</span>
            <span class="hotkey-key"><span class="kbd">â†“</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Focus Search</span>
            <span class="hotkey-key"><span class="kbd">/</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Missing Receipt Form</span>
            <span class="hotkey-key"><span class="kbd">F</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Close Modal</span>
            <span class="hotkey-key"><span class="kbd">Esc</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Show This Menu</span>
            <span class="hotkey-key"><span class="kbd">?</span></span>
          </div>
        </div>

        <div class="hotkey-section">
          <div class="hotkey-section-title">ğŸ“… Extra Features</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Calendar View</span>
            <span class="hotkey-key"><span class="kbd">Stats Page</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Batch Mode</span>
            <span class="hotkey-key"><span class="kbd">Toolbar Button</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Advanced Search</span>
            <span class="hotkey-key"><span class="kbd">Toolbar Button</span></span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="toggleHotkeyMenu()">Close</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">âš™ï¸ Settings</div>
      <button class="modal-close" onclick="toggleSettings()">Ã—</button>
    </div>
    <div class="modal-body">
      <!-- System Health -->
      <div class="settings-section" id="system-health-section" style="background:linear-gradient(135deg, rgba(0,255,136,.1), rgba(0,204,106,.05));border:1px solid rgba(0,255,136,.2);border-radius:12px;padding:16px;margin-bottom:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div class="settings-section-title" style="color:#00ff88;margin:0" id="health-title">ğŸŸ¢ System Health</div>
          <div style="font-size:10px;color:var(--muted)" id="health-timestamp">Last checked: --</div>
        </div>
        <div id="system-health-status" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:12px">
          <div class="health-card" id="health-db-card" style="text-align:center;padding:12px;background:var(--panel2);border-radius:8px;cursor:pointer" onclick="toggleHealthDetails('db')">
            <div style="font-size:20px;margin-bottom:4px" id="db-icon">âœ…</div>
            <div style="font-size:11px;color:var(--muted)">Database</div>
            <div style="font-size:12px;font-weight:600;color:#00ff88" id="db-status">MySQL</div>
            <div style="font-size:10px;color:var(--muted);margin-top:4px" id="db-latency">--ms</div>
          </div>
          <div class="health-card" style="text-align:center;padding:12px;background:var(--panel2);border-radius:8px;cursor:pointer" onclick="toggleHealthDetails('r2')">
            <div style="font-size:20px;margin-bottom:4px" id="r2-icon">âœ…</div>
            <div style="font-size:11px;color:var(--muted)">R2 Storage</div>
            <div style="font-size:12px;font-weight:600;color:#00ff88" id="r2-status">Connected</div>
            <div style="font-size:10px;color:var(--muted);margin-top:4px" id="r2-bucket">--</div>
          </div>
          <div class="health-card" style="text-align:center;padding:12px;background:var(--panel2);border-radius:8px;cursor:pointer" onclick="toggleHealthDetails('ai')">
            <div style="font-size:20px;margin-bottom:4px" id="ai-icon">âœ…</div>
            <div style="font-size:11px;color:var(--muted)">Gemini AI</div>
            <div style="font-size:12px;font-weight:600;color:#00ff88" id="ai-status">Ready</div>
            <div style="font-size:10px;color:var(--muted);margin-top:4px" id="ai-accuracy">99%+ OCR</div>
          </div>
          <div class="health-card" style="text-align:center;padding:12px;background:var(--panel2);border-radius:8px;cursor:pointer" onclick="toggleHealthDetails('gmail')">
            <div style="font-size:20px;margin-bottom:4px" id="gmail-icon">ğŸ“§</div>
            <div style="font-size:11px;color:var(--muted)">Gmail</div>
            <div style="font-size:12px;font-weight:600;color:#00ff88" id="gmail-health-status">0/3</div>
            <div style="font-size:10px;color:var(--muted);margin-top:4px" id="gmail-accounts-summary">accounts</div>
          </div>
        </div>

        <!-- Expandable Details Panel -->
        <div id="health-details-panel" style="display:none;margin-top:12px;padding:12px;background:var(--panel2);border-radius:8px;border-left:3px solid #00ff88">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong id="health-details-title" style="color:#00ff88">Details</strong>
            <button onclick="closeHealthDetails()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px">âœ•</button>
          </div>
          <div id="health-details-content" style="font-size:12px;color:var(--ink)">
            <!-- Populated dynamically -->
          </div>
        </div>

        <!-- Receipt Stats Row -->
        <div id="receipt-stats-row" style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;margin-top:12px;padding:12px;background:var(--panel2);border-radius:8px">
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700;color:#00ff88" id="stat-total">--</div>
            <div style="font-size:10px;color:var(--muted)">Transactions</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700;color:#00ff88" id="stat-receipts">--</div>
            <div style="font-size:10px;color:var(--muted)">With Receipts</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:18px;font-weight:700;color:#fbbf24" id="stat-missing">--</div>
            <div style="font-size:10px;color:var(--muted)">Missing</div>
          </div>
        </div>

        <button class="btn-ghost" onclick="checkSystemHealth()" id="health-check-btn" style="margin-top:12px;width:100%">ğŸ”„ Check All Services</button>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">ğŸ¤– AI & OCR</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Gemini Vision API</div>
            <div class="settings-desc">Receipt OCR & AI note generation</div>
          </div>
          <span class="badge badge-good" id="gemini-badge">Active</span>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Local OCR (Donut)</div>
            <div class="settings-desc">97-98% accuracy fallback</div>
          </div>
          <span class="badge badge-good">Enabled</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">ğŸ“§ Gmail Integration</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Personal Gmail</div>
            <div class="settings-desc">kaplan.brian@gmail.com</div>
          </div>
          <span id="gmail-status-personal" class="badge badge-neutral">Checking...</span>
          <button class="btn-ghost" onclick="connectGmail('kaplan.brian@gmail.com')" id="gmail-btn-personal">ğŸ”— Connect</button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Music City Rodeo</div>
            <div class="settings-desc">brian@musiccityrodeo.com</div>
          </div>
          <span id="gmail-status-mcr" class="badge badge-neutral">Checking...</span>
          <button class="btn-ghost" onclick="connectGmail('brian@musiccityrodeo.com')" id="gmail-btn-mcr">ğŸ”— Connect</button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Down Home</div>
            <div class="settings-desc">brian@downhome.com</div>
          </div>
          <span id="gmail-status-downhome" class="badge badge-neutral">Checking...</span>
          <button class="btn-ghost" onclick="connectGmail('brian@downhome.com')" id="gmail-btn-downhome">ğŸ”— Connect</button>
        </div>
      </div>

      <!-- Calendar Integration Section -->
      <div class="settings-section" id="calendar-settings-section">
        <div class="settings-section-title">ğŸ“… Calendar Integration</div>
        <div id="calendar-status-row" style="margin-bottom:12px;padding:12px;background:var(--panel2);border-radius:8px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:13px;font-weight:600;color:var(--ink)" id="calendar-connection-status">Checking...</div>
              <div style="font-size:11px;color:var(--muted)" id="calendar-status-detail">Loading calendar status</div>
            </div>
            <button class="btn-ghost" onclick="checkCalendarStatus()" style="font-size:12px">ğŸ”„ Refresh</button>
          </div>
        </div>
        <div id="calendar-accounts-list" style="display:none">
          <!-- Populated dynamically with checkboxes for each calendar -->
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:8px;padding:8px;background:rgba(0,255,136,.05);border-radius:6px">
          ğŸ’¡ Calendar events are used to auto-generate contextual notes like "Uber - Vegas Trip" or "Parking - Rodeo Vegas"
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">ğŸ’¾ Data & Storage</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Database</div>
            <div class="settings-desc" id="db-type-desc">MySQL on Railway</div>
          </div>
          <span id="db-status" class="badge badge-good">Connected</span>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Receipt Storage</div>
            <div class="settings-desc">Cloudflare R2 + local backup</div>
          </div>
          <span class="badge badge-good">R2</span>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Transactions</div>
            <div class="settings-desc" id="transaction-count-setting">Loading...</div>
          </div>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Auto-Backup</div>
            <div class="settings-desc">CSV backup on every server start</div>
          </div>
          <span class="badge badge-good">On</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">ğŸ” Security</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Authentication</div>
            <div class="settings-desc">Password + PIN protection</div>
          </div>
          <span class="badge badge-good">Enabled</span>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Session</div>
            <div class="settings-desc">Secure HTTPOnly cookies</div>
          </div>
          <span class="badge badge-good">Active</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">ğŸ¨ Appearance</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Theme</div>
            <div class="settings-desc">Tallyups dark theme</div>
          </div>
          <span style="color:#00ff88;font-weight:600">Black & Green</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="toggleSettings()">Close</button>
    </div>
  </div>
</div>

<!-- Manual Entry Modal -->
<div class="modal-overlay" id="manual-entry-modal">
  <div class="modal" style="max-width:700px">
    <div class="modal-header">
      <div class="modal-title">â• Add Manual Expense</div>
      <button class="modal-close" onclick="closeManualEntryModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <!-- OCR Drag & Drop Zone -->
      <div class="ocr-drop-zone" id="ocr-drop-zone">
        <input type="file" id="ocr-file-input" accept="image/*" style="display:none">
        <div class="ocr-drop-icon">ğŸ“¸</div>
        <div class="ocr-drop-text">Drop receipt image or click to upload</div>
        <div class="ocr-drop-hint">AI will automatically extract merchant, date & amount</div>
        <img id="ocr-preview" class="ocr-preview" alt="Receipt preview">
        <div id="ocr-status" class="ocr-status"></div>
      </div>

      <form id="manual-entry-form" onsubmit="submitManualEntry(event)">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
          <!-- Date -->
          <div>
            <label class="settings-label" style="display:block;margin-bottom:6px">Date *</label>
            <input type="date" id="manual-date" class="input" style="width:100%" required
                   value="">
          </div>

          <!-- Amount -->
          <div>
            <label class="settings-label" style="display:block;margin-bottom:6px">Amount *</label>
            <input type="number" id="manual-amount" class="input" style="width:100%"
                   placeholder="0.00" step="0.01" required>
          </div>
        </div>

        <!-- Merchant/Description -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Merchant/Description *</label>
          <input type="text" id="manual-merchant" class="input" style="width:100%"
                 placeholder="e.g., Soho House Nashville" required>
        </div>

        <!-- Business Type -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Business Type *</label>
          <select id="manual-business-type" class="input" style="width:100%" required onchange="updateCategoryOptions()">
            <option value="">Select Business Type</option>
            <!-- Populated dynamically by BusinessTypes.populateSelect() -->
          </select>
        </div>

        <!-- Category -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Category</label>
          <select id="manual-category" class="input" style="width:100%">
            <option value="">Select Category (optional)</option>
          </select>
        </div>

        <!-- Notes -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Notes</label>
          <textarea id="manual-notes" class="input" style="width:100%;min-height:80px;resize:vertical"
                    placeholder="Add any additional notes..."></textarea>
        </div>

        <div style="font-size:11px;color:var(--muted);padding:12px;background:var(--panel2);border-radius:8px;border:1px solid var(--edge)">
          â„¹ï¸ This expense will be marked as "Manual Entry" and added to your transactions.
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" type="button" onclick="closeManualEntryModal()">Cancel</button>
      <button class="btn-success" type="submit" form="manual-entry-form">
        â• Add Expense
      </button>
    </div>
  </div>
</div>

<!-- Quick Viewer Modal -->
<div class="quick-viewer" id="quick-viewer">
  <div class="quick-viewer-content">
    <!-- Navigation Buttons -->
    <button class="quick-nav-btn prev" onclick="navigateQuickViewer(-1)" id="quick-prev">â€¹</button>
    <button class="quick-nav-btn next" onclick="navigateQuickViewer(1)" id="quick-next">â€º</button>

    <!-- Position Indicator -->
    <div class="quick-position" id="quick-position">1 / 247</div>

    <!-- Keyboard Shortcuts -->
    <div class="quick-shortcuts">
      <span><kbd>â†</kbd> <kbd>â†’</kbd> Navigate</span>
      <span><kbd>G/B/N</kbd> Status</span>
      <span><kbd>M/D/P</kbd> Business</span>
      <span><kbd>J</kbd> AI Note</span>
      <span><kbd>A</kbd> AI Match</span>
      <span><kbd>F</kbd> Missing Form</span>
      <span><kbd>ESC</kbd> Close</span>
    </div>

    <div class="quick-viewer-header">
      <div class="quick-viewer-title" id="quick-title">Quick Receipt View</div>
      <div class="viewer-controls">
        <button class="icon-btn" onclick="closeQuickViewer()">Ã—</button>
      </div>
    </div>
    <div class="quick-viewer-body">
      <div class="quick-viewer-image" id="quick-image">
        <!-- Zoom Controls -->
        <div class="quick-zoom-controls">
          <button class="quick-zoom-btn" onclick="quickZoom(0.2)" title="Zoom In">+</button>
          <button class="quick-zoom-btn" onclick="quickZoom(-0.2)" title="Zoom Out">âˆ’</button>
          <button class="quick-zoom-btn" onclick="quickResetZoom()" title="Reset Zoom">âŸ²</button>
        </div>

        <!-- Match Confidence Badge (hidden by default) -->
        <div class="match-confidence" id="quick-match-badge" style="display:none">
          <span>âœ“</span>
          <span id="quick-confidence-text">95% Match</span>
        </div>

        <div class="no-receipt">
          <div class="no-receipt-icon">ğŸ“„</div>
          <div class="no-receipt-text">No receipt selected</div>
        </div>
      </div>
      <div class="quick-viewer-data" id="quick-data">
        <!-- VERIFICATION STATUS BANNER -->
        <div class="verification-banner" id="verification-banner" style="display:none">
          <span class="verification-icon" id="verification-icon"></span>
          <span class="verification-text" id="verification-text"></span>
        </div>

        <!-- COMPARISON SECTION -->
        <div class="compare-section">
          <div class="compare-header">TRANSACTION vs RECEIPT</div>
          <div class="compare-grid">
            <div class="compare-col">
              <div class="compare-col-header">BANK TRANSACTION</div>
              <div class="compare-field">
                <div class="compare-label">Merchant</div>
                <div class="compare-value" id="compare-bank-merchant">â€”</div>
              </div>
              <div class="compare-field">
                <div class="compare-label">Amount</div>
                <div class="compare-value amount" id="compare-bank-amount">â€”</div>
              </div>
              <div class="compare-field">
                <div class="compare-label">Date</div>
                <div class="compare-value date" id="compare-bank-date">â€”</div>
              </div>
            </div>
            <div class="compare-col">
              <div class="compare-col-header" id="receipt-col-header">RECEIPT OCR</div>
              <div class="compare-field">
                <div class="compare-label">Merchant</div>
                <div class="compare-value" id="compare-receipt-merchant">â€”</div>
              </div>
              <div class="compare-field">
                <div class="compare-label">Amount</div>
                <div class="compare-value amount" id="compare-receipt-amount">â€”</div>
              </div>
              <div class="compare-field">
                <div class="compare-label">Date</div>
                <div class="compare-value date" id="compare-receipt-date">â€”</div>
              </div>
            </div>
          </div>
          <!-- OCR Extra Details -->
          <div class="ocr-details" id="ocr-details" style="display:none">
            <div class="ocr-detail-row" id="ocr-subtotal-row" style="display:none">
              <span class="ocr-detail-label">Subtotal:</span>
              <span class="ocr-detail-value" id="ocr-subtotal">â€”</span>
            </div>
            <div class="ocr-detail-row" id="ocr-tax-row" style="display:none">
              <span class="ocr-detail-label">Tax:</span>
              <span class="ocr-detail-value" id="ocr-tax">â€”</span>
            </div>
            <div class="ocr-detail-row" id="ocr-tip-row" style="display:none">
              <span class="ocr-detail-label">Tip:</span>
              <span class="ocr-detail-value" id="ocr-tip">â€”</span>
            </div>
            <div class="ocr-detail-row" id="ocr-payment-row" style="display:none">
              <span class="ocr-detail-label">Payment:</span>
              <span class="ocr-detail-value" id="ocr-payment">â€”</span>
            </div>
          </div>
        </div>
        <!-- ACTIONS -->
        <div class="data-row">
          <div class="data-label">Business Type</div>
          <select id="quick-business" class="quick-field-select" onchange="quickUpdateField('Business Type', this.value)">
            <option value="">â€”</option>
            <!-- Populated dynamically by BusinessTypes.populateSelect() -->
          </select>
        </div>
        <div class="data-row">
          <div class="data-label">Status</div>
          <select id="quick-status" class="quick-field-select" onchange="quickUpdateField('Review Status', this.value)">
            <option value="">Pending</option>
            <option value="good">Good</option>
            <option value="bad">Bad</option>
            <option value="not needed">Not Needed</option>
          </select>
        </div>
        <div class="data-row">
          <div class="data-label">AI Note</div>
          <textarea id="quick-ai-note" class="quick-field-textarea" placeholder="AI-generated note..."
            onblur="quickUpdateField('AI Note', this.value)"
            onkeydown="handleTextareaKeys(event, 'AI Note')"></textarea>
        </div>
        <!-- Hidden fields for compatibility -->
        <div id="quick-merchant" style="display:none"></div>
        <div id="quick-amount" style="display:none"></div>
        <div id="quick-date" style="display:none"></div>
        <div id="quick-category" style="display:none"></div>
        <textarea id="quick-notes" style="display:none"></textarea>
      </div>
    </div>
  </div>
</div>

<!-- Progress Modal -->
<div class="modal-overlay" id="progress-modal">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <div class="modal-title">ğŸ¤– Finding Missing Receipts</div>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:20px">
        <div style="font-size:14px;color:var(--muted);margin-bottom:10px">
          Processing transactions...
        </div>
        <div style="background:var(--panel2);border-radius:8px;overflow:hidden;height:24px;position:relative">
          <div id="progress-bar" style="background:linear-gradient(90deg,#3b82f6,#8b5cf6);height:100%;width:0%;transition:width 0.3s ease"></div>
          <div id="progress-text" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:12px;font-weight:600;color:var(--ink)">
            0%
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
        <div style="background:var(--panel2);padding:12px;border-radius:8px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Processed</div>
          <div style="font-size:20px;font-weight:700" id="progress-processed">0</div>
        </div>
        <div style="background:var(--panel2);padding:12px;border-radius:8px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Found</div>
          <div style="font-size:20px;font-weight:700;color:var(--ok)" id="progress-found">0</div>
        </div>
      </div>

      <div style="max-height:200px;overflow-y:auto;background:var(--panel2);border-radius:8px;padding:12px">
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">
          Recent Matches
        </div>
        <div id="progress-log" style="font-size:12px;line-height:1.8;font-family:ui-monospace,monospace">
          <div style="color:var(--muted)">Waiting to start...</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" onclick="cancelBatchProcess()" id="progress-cancel-btn">
        Cancel
      </button>
      <button class="btn-ghost" onclick="closeProgressModal()" id="progress-close-btn" style="display:none">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Missing Receipt Form Modal -->
<div class="modal-overlay" id="missing-receipt-modal">
  <div class="modal" style="max-width:550px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“ Generate Missing Receipt Form</div>
      <button class="modal-close" onclick="closeMissingReceiptModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:white;padding:16px;border-radius:10px;margin-bottom:20px">
        <div style="font-size:14px;font-weight:600;margin-bottom:4px" id="mrf-merchant">Loading...</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:24px;font-weight:700" id="mrf-amount">$0.00</span>
          <span style="font-size:13px;opacity:0.9" id="mrf-date">--/--/----</span>
        </div>
      </div>

      <form id="missing-receipt-form">
        <!-- Company Selection -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Company *</label>
          <select id="mrf-company" class="input" style="width:100%" required>
            <option value="downhome">Down Home Media LLC</option>
            <option value="mcr">Music City Rodeo</option>
            <option value="emco">EM.co</option>
          </select>
        </div>

        <!-- Reason Receipt Was Lost -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Reason Receipt Was Lost *</label>
          <select id="mrf-reason-select" class="input" style="width:100%;margin-bottom:8px" onchange="updateReasonField()">
            <option value="">-- Select a reason or type custom --</option>
            <option value="Receipt not provided by vendor">Receipt not provided by vendor</option>
            <option value="Electronic payment - no physical receipt">Electronic payment - no physical receipt</option>
            <option value="Receipt lost during travel">Receipt lost during travel</option>
            <option value="Receipt faded/illegible">Receipt faded/illegible</option>
            <option value="Vendor does not issue receipts">Vendor does not issue receipts</option>
            <option value="Online purchase - email receipt unavailable">Online purchase - email receipt unavailable</option>
            <option value="custom">Custom reason...</option>
          </select>
          <input type="text" id="mrf-reason" class="input" style="width:100%"
                 placeholder="Enter reason receipt was lost" required>
        </div>

        <!-- Meal Receipt Section (collapsible) -->
        <div style="margin-bottom:16px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px">
            <input type="checkbox" id="mrf-is-meal" onchange="toggleMealSection()">
            <span class="settings-label" style="margin:0">This was a meal/entertainment expense</span>
          </label>
          <div id="mrf-meal-section" style="display:none;padding:12px;background:var(--panel2);border-radius:8px;border:1px solid var(--edge)">
            <div style="margin-bottom:12px">
              <label class="settings-label" style="display:block;margin-bottom:6px;font-size:12px">Attendee Name(s)</label>
              <input type="text" id="mrf-attendees" class="input" style="width:100%"
                     placeholder="e.g., John Smith, Jane Doe">
            </div>
            <div>
              <label class="settings-label" style="display:block;margin-bottom:6px;font-size:12px">Business Purpose</label>
              <input type="text" id="mrf-purpose" class="input" style="width:100%"
                     placeholder="e.g., Client meeting to discuss Q4 campaign">
            </div>
          </div>
        </div>

        <div style="font-size:11px;color:var(--muted);padding:12px;background:var(--panel2);border-radius:8px;border:1px solid var(--edge)">
          â„¹ï¸ This will generate a PDF Missing Receipt Form with your signature and attach it to this transaction.
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" type="button" onclick="closeMissingReceiptModal()">Cancel</button>
      <button class="btn-success" type="button" onclick="submitMissingReceiptForm()">
        ğŸ“ Generate Form
      </button>
    </div>
  </div>
</div>

<!-- Report Selector Popup -->
<div id="report-selector-popup" class="report-selector-popup">
  <div class="report-selector-header">
    <span>Add to Report</span>
    <button class="report-selector-close" onclick="closeReportSelector()">Ã—</button>
  </div>
  <div id="report-selector-list" class="report-selector-list">
    <!-- Populated dynamically -->
  </div>
  <div class="report-selector-hint">
    Press 1-9 to select â€¢ N for new â€¢ Esc to close
  </div>
</div>

<!-- 10X REPORT BUILDER WIDGETS -->

<!-- Live Report Widget -->
<div id="live-report-widget" class="hidden" onclick="toggleReportPanel()">
  <div class="widget-header">
    <span class="widget-title">
      <span id="widget-report-name">Report</span>
      <span class="widget-count" id="widget-item-count">0</span>
    </span>
  </div>
  <div class="widget-total" id="widget-total">$0.00</div>
  <div class="widget-hint">
    <kbd>Space</kbd> add â€¢ <kbd>S</kbd> skip â€¢ <kbd>Tab</kbd> next
  </div>
</div>

<!-- Quick Action Bar (shows when transaction selected) -->
<div id="quick-action-bar">
  <button class="action-btn primary" onclick="quickAddToReport()">
    <span>Add to Report</span>
    <kbd>Space</kbd>
  </button>
  <button class="action-btn" onclick="quickSkipTransaction()">
    <span>Skip</span>
    <kbd>S</kbd>
  </button>
  <button class="action-btn" onclick="showQuickEditPopup()">
    <span>Edit</span>
    <kbd>E</kbd>
  </button>
  <button class="action-btn" onclick="markAsPersonal()">
    <span>Personal</span>
    <kbd>P</kbd>
  </button>
  <button class="action-btn" onclick="enterSpeedMode()">
    <span>Speed Mode</span>
    <kbd>Ctrl+Enter</kbd>
  </button>
</div>

<!-- Quick Edit Popup -->
<div id="quick-edit-popup" class="report-selector-popup" style="min-width:400px">
  <div class="report-selector-header">
    <span>Quick Edit</span>
    <button class="report-selector-close" onclick="closeQuickEditPopup()">Ã—</button>
  </div>
  <div style="padding:16px">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
      <div>
        <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Category</label>
        <select id="quick-edit-category" class="input" style="width:100%;padding:10px">
          <option value="">Select...</option>
          <option value="Advertising">Advertising</option>
          <option value="Artist Fees">Artist Fees</option>
          <option value="Audio/Visual">Audio/Visual</option>
          <option value="Catering">Catering</option>
          <option value="Consulting">Consulting</option>
          <option value="Equipment Rental">Equipment Rental</option>
          <option value="Food & Beverage">Food & Beverage</option>
          <option value="Insurance">Insurance</option>
          <option value="Legal">Legal</option>
          <option value="Marketing">Marketing</option>
          <option value="Meals & Entertainment">Meals & Entertainment</option>
          <option value="Merchandise">Merchandise</option>
          <option value="Office Supplies">Office Supplies</option>
          <option value="Parking">Parking</option>
          <option value="Photography">Photography</option>
          <option value="Production">Production</option>
          <option value="Rent">Rent</option>
          <option value="Security">Security</option>
          <option value="Software">Software</option>
          <option value="Subscriptions">Subscriptions</option>
          <option value="Supplies">Supplies</option>
          <option value="Travel">Travel</option>
          <option value="Utilities">Utilities</option>
          <option value="Venue">Venue</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div>
        <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Business</label>
        <select id="quick-edit-business" class="input" style="width:100%;padding:10px">
          <option value="">Select...</option>
          <!-- Populated dynamically by BusinessTypes.populateSelect() -->
        </select>
      </div>
    </div>
    <div style="margin-bottom:16px">
      <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Notes / Description</label>
      <input type="text" id="quick-edit-notes" class="input" style="width:100%;padding:10px" placeholder="Add notes...">
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn-ghost" onclick="closeQuickEditPopup()" style="flex:1">Cancel</button>
      <button class="btn-success" onclick="saveQuickEdit()" style="flex:1">Save & Next</button>
    </div>
  </div>
</div>

<!-- Speed Mode Indicator -->
<div id="speed-mode-indicator">
  <span>âš¡ SPEED MODE</span>
  <div class="progress">
    <div class="progress-bar" id="speed-progress-bar"></div>
  </div>
  <span id="speed-count">0/0</span>
  <button onclick="exitSpeedMode()" style="background:rgba(0,0,0,.2);border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px">ESC</button>
</div>

<!-- Transaction Preview Card (for Speed Mode) -->
<div id="transaction-preview">
  <div class="preview-amount" id="preview-amount">$0.00</div>
  <div class="preview-merchant" id="preview-merchant">Merchant Name</div>
  <div class="preview-date" id="preview-date">Jan 1, 2025</div>

  <!-- Editable Fields -->
  <div class="preview-fields" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0">
    <div>
      <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Category</label>
      <select id="preview-category" class="input" style="width:100%;padding:10px;font-size:14px" onchange="updateSpeedCategory(this.value)">
        <option value="">Select category...</option>
        <option value="Advertising">Advertising</option>
        <option value="Artist Fees">Artist Fees</option>
        <option value="Audio/Visual">Audio/Visual</option>
        <option value="Bank Fees">Bank Fees</option>
        <option value="Catering">Catering</option>
        <option value="Cleaning">Cleaning</option>
        <option value="Commissions">Commissions</option>
        <option value="Consulting">Consulting</option>
        <option value="Decorations">Decorations</option>
        <option value="Equipment Rental">Equipment Rental</option>
        <option value="Food & Beverage">Food & Beverage</option>
        <option value="Furniture">Furniture</option>
        <option value="Insurance">Insurance</option>
        <option value="Legal">Legal</option>
        <option value="Licensing">Licensing</option>
        <option value="Marketing">Marketing</option>
        <option value="Meals & Entertainment">Meals & Entertainment</option>
        <option value="Merchandise">Merchandise</option>
        <option value="Office Supplies">Office Supplies</option>
        <option value="Parking">Parking</option>
        <option value="Payroll">Payroll</option>
        <option value="Photography">Photography</option>
        <option value="Printing">Printing</option>
        <option value="Production">Production</option>
        <option value="Rent">Rent</option>
        <option value="Repairs">Repairs</option>
        <option value="Security">Security</option>
        <option value="Shipping">Shipping</option>
        <option value="Software">Software</option>
        <option value="Staging">Staging</option>
        <option value="Subscriptions">Subscriptions</option>
        <option value="Supplies">Supplies</option>
        <option value="Talent">Talent</option>
        <option value="Taxes">Taxes</option>
        <option value="Technology">Technology</option>
        <option value="Tickets">Tickets</option>
        <option value="Travel">Travel</option>
        <option value="Uniforms">Uniforms</option>
        <option value="Utilities">Utilities</option>
        <option value="Venue">Venue</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div>
      <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Business</label>
      <select id="preview-business" class="input" style="width:100%;padding:10px;font-size:14px" onchange="updateSpeedBusiness(this.value)">
        <option value="">Select business...</option>
        <!-- Populated dynamically by BusinessTypes.populateSelect() -->
      </select>
    </div>
  </div>

  <div style="margin-bottom:16px">
    <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Description / Notes</label>
    <input type="text" id="preview-notes" class="input" style="width:100%;padding:10px;font-size:14px"
           placeholder="Add description or notes..." onchange="updateSpeedNotes(this.value)">
  </div>

  <img class="preview-receipt" id="preview-receipt-img" src="" alt="Receipt">
  <div class="preview-actions">
    <button class="skip-btn" onclick="speedSkip()">
      Skip <kbd>S</kbd>
    </button>
    <button class="add-btn" onclick="speedAdd()">
      Add <kbd>Space</kbd>
    </button>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
  <span class="toast-icon" id="toast-icon">âœ“</span>
  <span class="toast-message" id="toast-message"></span>
</div>

<!-- Loading Overlay for batch operations -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner-large"></div>
  <div class="loading-text" id="loading-text">Processing...</div>
  <div class="loading-progress" id="loading-progress"></div>
</div>

<script>
// Global state
let csvData = [];
let filteredData = [];
let selectedRow = null;
let sortColumn = 'Chase Date';
let sortAsc = true;
let panzoomInstance = null;
let currentRotation = 0;

// Undo system
let undoStack = [];
const MAX_UNDO_STACK = 50;

// ============================================
// REPORT STATE (must be before renderTable)
// ============================================
let openReports = JSON.parse(localStorage.getItem('tallyups_open_reports') || '[]');
let currentReportId = localStorage.getItem('tallyups_current_report') || null;
let reportPanelVisible = false;
let reportPanelMinimized = false;
let reportPanelTab = 'items';
let reportTransactions = new Map(); // reportId -> Set of transaction indices
let reportSelectorVisible = false;

// Check if transaction is in any draft report
function isInAnyReport(index) {
  for (const [_, indices] of reportTransactions) {
    if (indices.has(index)) return true;
  }
  return false;
}

// Initialize report transactions from localStorage (called early)
(function initReportTransactionsEarly() {
  openReports.forEach(report => {
    const stored = localStorage.getItem(`tallyups_report_${report.id}`);
    if (stored) {
      try {
        reportTransactions.set(report.id, new Set(JSON.parse(stored)));
      } catch (e) {
        reportTransactions.set(report.id, new Set());
      }
    } else {
      reportTransactions.set(report.id, new Set());
    }
  });
})();

// Load draft reports from database and merge with localStorage
async function loadDraftReportsFromDatabase() {
  try {
    const response = await fetch('/api/reports?status=draft');
    if (!response.ok) return;

    const data = await response.json();
    if (!data.ok || !data.reports) return;

    // Merge database reports with localStorage reports
    data.reports.forEach(dbReport => {
      const existing = openReports.find(r => r.id === dbReport.report_id);
      if (!existing) {
        // Add report from database
        const report = {
          id: dbReport.report_id,
          name: dbReport.report_name || dbReport.report_id,
          created: dbReport.created_at,
          synced: true
        };
        openReports.push(report);
        reportTransactions.set(report.id, new Set());
      }
    });

    // Load transactions for each synced report
    for (const report of openReports) {
      if (!report.id.startsWith('report_')) {
        try {
          const itemsRes = await fetch(`/api/reports/${report.id}/items`);
          if (itemsRes.ok) {
            const itemsData = await itemsRes.json();
            if (itemsData.ok && itemsData.items) {
              const indices = new Set(itemsData.items.map(i => i._index).filter(Boolean));
              if (indices.size > 0) {
                reportTransactions.set(report.id, indices);
              }
            }
          }
        } catch (e) {
          // Use localStorage fallback
        }
      }
    }

    // Update currentReportId if needed
    if (openReports.length > 0 && !currentReportId) {
      currentReportId = openReports[0].id;
    }

    // Save merged state back to localStorage
    localStorage.setItem('tallyups_open_reports', JSON.stringify(openReports));

    // Re-render to reflect loaded reports
    if (typeof updateReportUI === 'function') updateReportUI();
    if (typeof updateReportFAB === 'function') updateReportFAB();
    if (typeof renderTable === 'function') renderTable();

  } catch (e) {
    console.log('Using localStorage reports (offline or error):', e);
  }
}

// Initialize business type dropdowns and chips
async function initBusinessTypes() {
  try {
    const types = await BusinessTypes.getAll();

    // Populate all business type select dropdowns
    const selects = [
      'batch-business-select',
      'manual-business-type',
      'quick-business',
      'quick-edit-business',
      'preview-business'
    ];

    for (const selectId of selects) {
      const select = document.getElementById(selectId);
      if (select) {
        // Keep the first option (placeholder)
        const placeholder = select.options[0];
        select.innerHTML = '';
        select.appendChild(placeholder);

        // Add business type options
        types.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.name;
          opt.textContent = t.name;
          select.appendChild(opt);
        });
      }
    }

    // Populate business type filter chips
    const chipsContainer = document.getElementById('business-type-chips');
    if (chipsContainer) {
      chipsContainer.innerHTML = '';
      types.forEach(t => {
        const chipId = t.name.toLowerCase().replace(/\s+/g, '-').replace(/\./g, '');
        const chip = document.createElement('div');
        chip.className = 'chip chip-with-badge';
        chip.dataset.biz = t.name;
        chip.innerHTML = `${t.name} <span class="notification-badge" id="${chipId}-count">0</span>`;
        chip.onclick = () => filterByBusiness(t.name);
        chipsContainer.appendChild(chip);
      });
    }

    // Store color map for use in rendering
    window.businessTypeColors = {};
    types.forEach(t => { window.businessTypeColors[t.name] = t.color; });

  } catch (error) {
    console.warn('Failed to initialize business types:', error);
  }
}

// Initialize - parallelize API calls for faster loading
document.addEventListener('DOMContentLoaded', async () => {
  // Run independent API calls in parallel for faster initial load
  await Promise.all([
    initBusinessTypes(),
    loadCSV()
  ]);

  // Setup UI after data is loaded
  setupEventListeners();
  setupDragDrop();
  setupResizer();
  loadTheme();

  // Fire-and-forget background tasks (don't await)
  updateIncomingBadge();
  loadDraftReportsFromDatabase();

  // Handle URL parameters for navigation (e.g., /?page=reports)
  const urlParams = new URLSearchParams(window.location.search);
  const requestedPage = urlParams.get('page');
  if (requestedPage && ['home', 'reports', 'stats'].includes(requestedPage)) {
    switchPage(requestedPage);
  }

  showToast('System ready! Press ? for keyboard shortcuts', 'ğŸš€');
});

// Fetch and display incoming receipts badge count
async function updateIncomingBadge() {
  try {
    const res = await fetch('/api/incoming/receipts?status=pending&limit=1', { credentials: 'same-origin' });
    if (!res.ok) return;
    const data = await res.json();
    const badge = document.getElementById('incoming-badge');
    if (!badge) return;
    const pendingCount = data.counts?.pending || 0;
    if (pendingCount > 0) {
      badge.textContent = pendingCount;
      badge.style.display = 'block';
    } else {
      badge.style.display = 'none';
    }
  } catch (e) {
    console.log('Could not fetch incoming badge count:', e.message);
  }
}

// API calls - load transactions from MySQL database
async function loadTransactions() {
  try {
    const res = await fetch('/api/transactions?all=true', { credentials: 'same-origin' });
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    const data = await res.json();
    // Handle both array format and {transactions: []} format
    csvData = Array.isArray(data) ? data : (data.transactions || []);
    filteredData = [...csvData];
    renderTable();
    updateDashboard();
    showToast(`Loaded ${csvData.length} transactions`, 'ğŸ“Š');
  } catch (e) {
    console.error('loadTransactions error:', e);
    showToast('Failed to load transactions: ' + e.message, 'âŒ');
  }
}
// Backwards compatibility alias
const loadCSV = loadTransactions;

async function saveCSV() {
  // NOTE: Server auto-saves on each update_row call
  // This function kept for Ctrl+S hotkey compatibility
  showToast('Changes are auto-saved on each update', 'âœ“');
}

async function aiMatch() {
  if (!selectedRow) return showToast('Select a transaction first', 'âš ï¸');

  // Save undo state BEFORE making changes
  const oldData = {
    'Receipt File': selectedRow['Receipt File'] || '',
    'ai_receipt_merchant': selectedRow['ai_receipt_merchant'] || '',
    'ai_receipt_date': selectedRow['ai_receipt_date'] || '',
    'ai_receipt_total': selectedRow['ai_receipt_total'] || '',
    'AI Confidence': selectedRow['AI Confidence'] || '',
    'mi_merchant': selectedRow['mi_merchant'] || '',
    'mi_category': selectedRow['mi_category'] || '',
    'mi_description': selectedRow['mi_description'] || '',
    'mi_confidence': selectedRow['mi_confidence'] || ''
  };

  showToast('ğŸ” Finding receipt...', 'ğŸ”');
  try {
    const res = await fetch('/ai_match', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({_index: selectedRow._index})
    });
    const data = await res.json();
    if (data.ok) {
      // Save undo state
      saveUndoState('AI Receipt Match + MI', selectedRow._index, oldData);

      // Update selected row with matched receipt data
      Object.assign(selectedRow, data.result);
      renderTable();
      loadReceipt();

      // Show detailed success message
      const confidence = data.result['AI Confidence'] || data.result['ai_confidence'] || 0;
      const receiptFile = data.result['Receipt File'] || '';
      const fileName = receiptFile.split('/').pop();

      showToast(`âœ… Receipt matched! ${fileName} (${Math.round(confidence)}%) - Running Donut OCR...`, 'ğŸ”„', 3000);

      // Now run Donut OCR + MI processing on the matched receipt
      try {
        const miRes = await fetch('/process_mi_ocr', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({_index: selectedRow._index})
        });
        const miData = await miRes.json();
        if (miData.ok) {
          // Update with MI results
          if (miData.result) {
            selectedRow.mi_merchant = miData.result.mi_merchant || selectedRow.mi_merchant;
            selectedRow.mi_category = miData.result.mi_category || selectedRow.mi_category;
            selectedRow.mi_description = miData.result.mi_description || selectedRow.mi_description;
            selectedRow.mi_confidence = miData.result.mi_confidence || selectedRow.mi_confidence;
            selectedRow.mi_is_subscription = miData.result.mi_is_subscription || 0;
            selectedRow.mi_subscription_name = miData.result.mi_subscription_name || '';
          }
          renderTable();

          const usedOcr = miData.used_ocr ? 'ğŸ© Donut' : 'ğŸ“‹ Pattern';
          const miConf = Math.round((miData.result?.mi_confidence || 0) * 100);
          showToast(`âœ… Complete! ${usedOcr}: ${miData.result?.mi_merchant || 'Unknown'} (${miConf}%) - Ctrl+Z to undo`, 'âœ…', 5000);
        } else {
          showToast(`âš ï¸ Receipt matched but MI failed: ${miData.message}`, 'âš ï¸', 4000);
        }
      } catch (miError) {
        showToast(`âš ï¸ Receipt matched but MI error: ${miError.message}`, 'âš ï¸', 4000);
      }
    } else {
      // No receipt found - still run MI with pattern matching
      showToast(`âŒ No receipt found - running pattern MI...`, 'ğŸ”„', 2000);

      try {
        const miRes = await fetch('/process_mi_ocr', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({_index: selectedRow._index})
        });
        const miData = await miRes.json();
        if (miData.ok && miData.result) {
          // Save undo state for MI-only change
          saveUndoState('MI Pattern Match', selectedRow._index, oldData);

          selectedRow.mi_merchant = miData.result.mi_merchant || '';
          selectedRow.mi_category = miData.result.mi_category || '';
          selectedRow.mi_description = miData.result.mi_description || '';
          selectedRow.mi_confidence = miData.result.mi_confidence || 0;
          renderTable();

          const miConf = Math.round((miData.result.mi_confidence || 0) * 100);
          showToast(`ğŸ“‹ No receipt, but MI processed: ${miData.result.mi_merchant} (${miConf}%)`, 'ğŸ“‹', 4000);
        }
      } catch (e) {
        showToast(`âŒ ${data.message || 'No receipt found'}`, 'âŒ', 4000);
      }
    }
  } catch (e) {
    showToast(`âŒ AI Match failed: ${e.message}`, 'âŒ');
  }
}

async function aiNote() {
  if (!selectedRow) return showToast('Select a transaction first', 'âš ï¸');

  showToast('Generating AI note...', 'âœï¸');
  try {
    const res = await fetch('/ai_note', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({_index: selectedRow._index})
    });
    const data = await res.json();
    if (data.ok) {
      selectedRow.Notes = data.note;
      selectedRow['AI Note'] = data.note;
      // Update textarea if quick viewer is open
      const aiNoteTextarea = document.getElementById('quick-ai-note');
      if (aiNoteTextarea) aiNoteTextarea.value = data.note || '';
      renderTable();
      showToast('AI note generated', 'âœ“');
    }
  } catch (e) {
    showToast('AI Note failed: ' + e.message, 'âŒ');
  }
}

// Auto-generate AI note in background (no toast spam)
const pendingAutoNotes = new Set();
async function autoGenerateAINote(idx) {
  // Prevent duplicate requests for same transaction
  if (pendingAutoNotes.has(idx)) return;
  pendingAutoNotes.add(idx);

  try {
    const res = await fetch('/ai_note', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({_index: idx})
    });
    const data = await res.json();
    if (data.ok && data.note) {
      // Update the data in memory
      const row = allData.find(r => r._index === idx);
      if (row) {
        row['AI Note'] = data.note;
        row.Notes = row.Notes || data.note;
      }
      // Update quick viewer if still showing this transaction
      if (selectedRow && selectedRow._index === idx) {
        selectedRow['AI Note'] = data.note;
        const aiNoteTextarea = document.getElementById('quick-ai-note');
        if (aiNoteTextarea && !aiNoteTextarea.value) {
          aiNoteTextarea.value = data.note;
        }
      }
      // Subtle indicator
      console.log(`Auto-generated AI note for transaction ${idx}`);
    }
  } catch (e) {
    console.warn(`Auto AI note failed for ${idx}:`, e.message);
  } finally {
    pendingAutoNotes.delete(idx);
  }
}

// Undo system functions
function saveUndoState(action, transactionIndex, oldData) {
  const undoEntry = {
    action,
    transactionIndex,
    oldData: {...oldData}, // Clone the old data
    timestamp: Date.now()
  };

  undoStack.push(undoEntry);

  // Limit stack size
  if (undoStack.length > MAX_UNDO_STACK) {
    undoStack.shift(); // Remove oldest entry
  }

  console.log(`Undo state saved: ${action} for transaction ${transactionIndex}`, undoEntry);
}

async function undo() {
  if (undoStack.length === 0) {
    showToast('âš ï¸ Nothing to undo', 'âš ï¸');
    return;
  }

  const entry = undoStack.pop();

  try {
    showToast(`â†©ï¸ Undoing: ${entry.action}...`, 'â†©ï¸');

    // Restore the old data
    const res = await fetch('/update_row', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        _index: entry.transactionIndex,
        patch: entry.oldData
      })
    });

    if (!res.ok) {
      throw new Error(`Failed to undo: ${res.statusText}`);
    }

    // Update local state
    const rowIndex = csvData.findIndex(r => r._index === entry.transactionIndex);
    if (rowIndex >= 0) {
      Object.assign(csvData[rowIndex], entry.oldData);
      if (selectedRow && selectedRow._index === entry.transactionIndex) {
        Object.assign(selectedRow, entry.oldData);
      }
    }

    renderTable();
    loadReceipt();

    showToast(`âœ… Undid: ${entry.action}`, 'âœ…', 3000);

  } catch (e) {
    showToast(`âŒ Undo failed: ${e.message}`, 'âŒ');
    // Put entry back on stack since undo failed
    undoStack.push(entry);
  }
}

let batchProcessCancelled = false;

// Combined Auto-Process: Categorize + AI Notes in one step
async function autoProcessAll() {
  const missingNotes = csvData.filter(r => !r['AI Note'] || r['AI Note'].trim() === '');
  const noteCount = Math.min(missingNotes.length, 100);

  if (!confirm(`Auto-Process ${csvData.length} transactions?\n\nStep 1: Merchant Intelligence\n- Normalize merchant names\n- Assign categories\n- Detect subscriptions\n- Match contacts from CRM\n\nStep 2: AI Notes\n- Generate ${noteCount} expense descriptions\n- Calendar context\n- Contact enrichment\n\nThis may take a few minutes.`)) {
    return;
  }

  batchProcessCancelled = false;

  // Show progress modal
  const modal = document.getElementById('progress-modal');
  modal.classList.add('active');
  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">ğŸ¤– Starting Auto-Process...</div>';

  try {
    // PHASE 1: Merchant Intelligence
    addProgressLog('\nğŸ“¦ Phase 1: Merchant Intelligence...', 'ok');
    updateProgress(0, 0, 0, 2);

    const miResponse = await fetch('/process_mi', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({all: true})
    });
    const miResult = await miResponse.json();

    if (miResult.ok) {
      addProgressLog(`âœ“ ${miResult.message || 'Categorization complete'}`, 'ok');
    } else {
      addProgressLog(`âš ï¸ MI: ${miResult.message || 'Some issues'}`, 'warn');
    }

    if (batchProcessCancelled) {
      addProgressLog('\nâš ï¸ Cancelled after Phase 1', 'bad');
      return;
    }

    // Reload data after MI processing
    await loadCSV();

    // PHASE 2: AI Notes
    addProgressLog('\nâœ¨ Phase 2: AI Notes Generation...', 'ok');
    updateProgress(1, 0, 50, 2);

    // Find transactions still missing notes after MI
    const stillMissingNotes = csvData.filter(r => !r['AI Note'] || r['AI Note'].trim() === '');
    const indexes = stillMissingNotes.slice(0, 100).map(r => r._index);

    if (indexes.length === 0) {
      addProgressLog('âœ“ All transactions already have AI notes!', 'ok');
    } else {
      let processed = 0;
      let success = 0;
      const total = indexes.length;
      const batchSize = 10;

      addProgressLog(`Generating notes for ${total} transactions...`, 'ok');

      for (let i = 0; i < indexes.length; i += batchSize) {
        if (batchProcessCancelled) {
          addProgressLog(`\nâš ï¸ Cancelled! Generated ${success} notes.`, 'bad');
          break;
        }

        const batch = indexes.slice(i, i + batchSize);

        try {
          const res = await fetch('/api/notes/batch', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ indexes: batch, skip_existing: true })
          });

          const data = await res.json();

          if (data.ok) {
            for (const result of data.results || []) {
              processed++;
              const percent = 50 + Math.round((processed / total) * 50);
              updateProgress(1 + (processed / total), success, percent, 2);

              if (result.success) {
                success++;
                const row = csvData.find(r => r._index === result._index);
                if (row) row['AI Note'] = result.note;
              }
            }
          }
        } catch (e) {
          addProgressLog(`Batch error: ${e.message}`, 'bad');
        }

        if (i + batchSize < indexes.length && !batchProcessCancelled) {
          await new Promise(r => setTimeout(r, 300));
        }
      }

      addProgressLog(`âœ“ Generated ${success} of ${total} AI notes`, 'ok');
    }

    // Final reload and refresh
    addProgressLog('\nâœ… Auto-Process Complete!', 'ok');
    await loadCSV();
    applyFilters();
    renderTable();
    showToast('Auto-Process complete!', 'ğŸ¤–');

  } catch (e) {
    addProgressLog(`\nâŒ Error: ${e.message}`, 'bad');
    showToast('Auto-Process error: ' + e.message, 'âŒ');
  } finally {
    document.getElementById('progress-cancel-btn').style.display = 'none';
    document.getElementById('progress-close-btn').style.display = 'block';
  }
}

// Process all transactions through Merchant Intelligence
async function processMerchantIntelligence() {
  if (!confirm(`Process all ${csvData.length} transactions through Merchant Intelligence?\n\nThis will:\n- Normalize merchant names\n- Assign categories\n- Detect subscriptions\n- Generate descriptions\n- Match contacts from CRM`)) {
    return;
  }

  showToast('Processing Merchant Intelligence...', 'ğŸ§ ');

  try {
    const response = await fetch('/process_mi', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({all: true})
    });

    const result = await response.json();

    if (result.ok) {
      showToast(result.message, 'âœ…');
      // Reload data to show updated MI fields
      await loadCSV();
      applyFilters();
      renderTable();
    } else {
      showToast(result.message || 'MI processing failed', 'âŒ');
    }
  } catch (e) {
    showToast('MI processing error: ' + e.message, 'âŒ');
  }
}

// Batch Generate AI Notes for transactions missing notes
async function batchGenerateAINotes() {
  // Find transactions without AI notes
  const missingNotes = csvData.filter(r => !r['AI Note'] || r['AI Note'].trim() === '');

  if (missingNotes.length === 0) {
    showToast('All transactions have AI notes!', 'âœ“');
    return;
  }

  const limit = Math.min(missingNotes.length, 100);
  if (!confirm(`Generate AI descriptions for ${limit} transactions without notes?\n\nThis uses the Smart Notes service with:\n- Calendar context\n- Contact enrichment\n- Receipt OCR data\n- Historical patterns\n\nThis may take a few minutes.`)) {
    return;
  }

  batchProcessCancelled = false;

  // Show progress modal
  const modal = document.getElementById('progress-modal');
  modal.classList.add('active');
  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">âœ¨ Starting AI Notes generation...</div>';

  const indexes = missingNotes.slice(0, limit).map(r => r._index);
  let processed = 0;
  let success = 0;
  const total = indexes.length;
  const batchSize = 10;

  addProgressLog(`Processing ${total} transactions in batches of ${batchSize}...`, 'ok');

  try {
    // Process in batches to avoid timeout
    for (let i = 0; i < indexes.length; i += batchSize) {
      if (batchProcessCancelled) {
        addProgressLog(`\nâš ï¸ Cancelled! Generated ${success} notes.`, 'bad');
        break;
      }

      const batch = indexes.slice(i, i + batchSize);

      try {
        const res = await fetch('/api/notes/batch', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            indexes: batch,
            skip_existing: true
          })
        });

        const data = await res.json();

        if (data.ok) {
          for (const result of data.results || []) {
            processed++;
            const percent = Math.round((processed / total) * 100);
            updateProgress(processed, success, percent, total);

            if (result.success) {
              success++;
              // Update local data
              const row = csvData.find(r => r._index === result._index);
              if (row) {
                row['AI Note'] = result.note;
              }
              addProgressLog(`âœ“ ${result.merchant}: "${result.note?.substring(0, 50)}..."`, 'ok');
            } else {
              addProgressLog(`âœ— ${result.merchant}: ${result.error || 'Failed'}`, 'bad');
            }
          }
        } else {
          addProgressLog(`Batch error: ${data.error || 'Unknown error'}`, 'bad');
        }
      } catch (e) {
        addProgressLog(`Batch request failed: ${e.message}`, 'bad');
      }

      // Small delay between batches
      if (i + batchSize < indexes.length && !batchProcessCancelled) {
        await new Promise(r => setTimeout(r, 500));
      }
    }

    // Final summary
    addProgressLog(`\nâœ… Complete! Generated ${success} of ${total} AI notes.`, 'ok');
    showToast(`Generated ${success} AI notes`, 'âœ¨');

    // Reload data and refresh
    await loadCSV();
    applyFilters();
    renderTable();

  } catch (e) {
    addProgressLog(`\nâŒ Error: ${e.message}`, 'bad');
    showToast('AI Notes error: ' + e.message, 'âŒ');
  } finally {
    document.getElementById('progress-cancel-btn').style.display = 'none';
    document.getElementById('progress-close-btn').style.display = 'block';
  }
}

// Alias for the AI Notes button
function generateAllNotes() {
  batchGenerateAINotes();
}

// Smart Search - Intelligent multi-source search with learning
async function smartSearchMissing() {
  const missingRows = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (missingRows.length === 0) {
    showToast('All transactions have receipts!', 'âœ“');
    return;
  }

  if (!confirm(`Smart Search will find receipts using AI match, Gmail, and iMessage.\n\nProcess ${missingRows.length} missing receipts?\n\nThis may take several minutes.`)) {
    return;
  }

  console.log(`ğŸ” Starting Smart Search: ${missingRows.length} receipts to find`);

  batchProcessCancelled = false;

  const modal = document.getElementById('progress-modal');
  modal.classList.add('active');

  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">ğŸ§  Smart Search: AI â†’ Gmail â†’ iMessage</div>';

  let processed = 0;
  let found = 0;
  const total = missingRows.length;
  const startTime = Date.now();

  // Phase 1: AI Match (try local receipts first)
  addProgressLog('\nğŸ¤– Phase 1: AI matching local receipts...', 'ok');

  for (const row of missingRows) {
    if (batchProcessCancelled) {
      addProgressLog(`\nâš ï¸ Cancelled! Processed ${processed} of ${total}`, 'bad');
      document.getElementById('progress-cancel-btn').style.display = 'none';
      document.getElementById('progress-close-btn').style.display = 'block';
      showToast(`Cancelled after ${processed} receipts`, 'âš ï¸');
      return;
    }

    try {
      processed++;
      const percent = Math.round((processed / total) * 100);
      updateProgress(processed, found, percent, total);

      // Try AI match first
      const res = await fetch('/ai_match', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({_index: row._index})
      });

      const data = await res.json();

      if (data.ok && data.result.receipt_file) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;
        addProgressLog(`âœ“ ${(row['Chase Description'] || 'Unknown').substring(0, 30)} â†’ AI matched`, 'ok');
        document.getElementById('progress-found').textContent = found;
      }
    } catch (e) {
      console.error(`AI match error:`, e);
    }
  }

  // Get still-missing receipts
  let stillMissing = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (stillMissing.length === 0) {
    addProgressLog(`\nâœ… All receipts found via AI match!`, 'ok');
    finishSmartSearch(found, total, startTime);
    return;
  }

  // Phase 2: Gmail Search
  addProgressLog(`\nğŸ“§ Phase 2: Searching Gmail (${stillMissing.length} remaining)...`, 'ok');

  for (const row of stillMissing) {
    if (batchProcessCancelled) break;

    try {
      const res = await fetch('/smart_search_receipt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: row._index,
          merchant: row['Chase Description'],
          amount: row['Chase Amount'],
          date: row['Chase Date'],
          source: 'gmail'
        })
      });

      const data = await res.json();

      if (data.ok && data.result && data.result.found) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;
        const source = data.result.source || 'Gmail';
        addProgressLog(`âœ“ ${(row['Chase Description'] || 'Unknown').substring(0, 30)} â†’ ${source}`, 'ok');
        document.getElementById('progress-found').textContent = found;
      }
    } catch (e) {
      console.error(`Gmail search error:`, e);
    }
  }

  // Get still-missing receipts
  stillMissing = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (stillMissing.length === 0) {
    addProgressLog(`\nâœ… All receipts found!`, 'ok');
    finishSmartSearch(found, total, startTime);
    return;
  }

  // Phase 3: iMessage Search
  addProgressLog(`\nğŸ’¬ Phase 3: Searching iMessage (${stillMissing.length} remaining)...`, 'ok');

  for (const row of stillMissing) {
    if (batchProcessCancelled) break;

    try {
      const res = await fetch('/smart_search_receipt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: row._index,
          merchant: row['Chase Description'],
          amount: row['Chase Amount'],
          date: row['Chase Date'],
          source: 'imessage'
        })
      });

      const data = await res.json();

      if (data.ok && data.result && data.result.found) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;
        addProgressLog(`âœ“ ${(row['Chase Description'] || 'Unknown').substring(0, 30)} â†’ iMessage`, 'ok');
        document.getElementById('progress-found').textContent = found;
      }
    } catch (e) {
      console.error(`iMessage search error:`, e);
    }
  }

  finishSmartSearch(found, total, startTime);
}

function finishSmartSearch(found, total, startTime) {
  const elapsed = Math.round((Date.now() - startTime) / 1000);
  console.log(`âœ… Smart Search complete in ${elapsed}s: Found ${found} of ${total} receipts`);

  addProgressLog(`\nâœ… Smart Search complete! Found ${found} of ${total} receipts in ${elapsed}s`, 'ok');
  document.getElementById('progress-cancel-btn').style.display = 'none';
  document.getElementById('progress-close-btn').style.display = 'block';

  showToast(`Smart Search complete: ${found} receipts found`, 'âœ…');

  // Reload to show new receipts
  loadCSV().then(() => {
    applyFilters();
    renderTable();
  });
}

// Gmail Search - Search Gmail for missing receipts
async function searchGmailForMissing() {
  const missingRows = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (missingRows.length === 0) {
    showToast('All transactions have receipts!', 'âœ“');
    return;
  }

  if (!confirm(`Search Gmail for ${missingRows.length} missing receipts? This may take several minutes.`)) {
    return;
  }

  console.log(`ğŸ“§ Starting Gmail search: ${missingRows.length} receipts to find`);

  batchProcessCancelled = false;

  const modal = document.getElementById('progress-modal');
  modal.classList.add('active');

  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">Searching Gmail accounts...</div>';

  let processed = 0;
  let found = 0;
  const total = missingRows.length;
  const startTime = Date.now();

  for (const row of missingRows) {
    if (batchProcessCancelled) {
      console.log('âŒ Gmail search cancelled');
      addProgressLog(`\nâš ï¸ Cancelled! Searched ${processed} of ${total}`, 'bad');
      document.getElementById('progress-cancel-btn').style.display = 'none';
      document.getElementById('progress-close-btn').style.display = 'block';
      showToast(`Cancelled after ${processed} receipts`, 'âš ï¸');
      return;
    }

    try {
      processed++;
      const percent = Math.round((processed / total) * 100);
      updateProgress(processed, found, percent, total);

      console.log(`[${processed}/${total}] Searching Gmail: ${row['Chase Description']?.substring(0, 40) || 'Unknown'}`);

      const res = await fetch('/search_gmail_receipt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: row._index,
          merchant: row['Chase Description'],
          amount: row['Chase Amount'],
          date: row['Chase Date']
        })
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();

      if (data.ok && data.result && data.result.receipt_file) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;

        const merchant = row['Chase Description'] || 'Unknown';
        console.log(`  âœ“ Found in Gmail`);
        addProgressLog(`âœ“ ${merchant.substring(0, 30)} â†’ Found in email`, 'ok');
      } else {
        console.log(`  âŠ˜ Not found in Gmail`);
        addProgressLog(`âŠ˜ ${(row['Chase Description'] || 'Unknown').substring(0, 30)} â†’ Not found`, 'muted');
      }

      document.getElementById('progress-found').textContent = found;

    } catch (e) {
      console.error(`  âœ— Error searching Gmail:`, e);
      addProgressLog(`âœ— Error: ${e.message}`, 'bad');
    }
  }

  const elapsed = Math.round((Date.now() - startTime) / 1000);
  console.log(`âœ… Gmail search complete in ${elapsed}s: Found ${found} of ${total} receipts`);

  addProgressLog(`\nâœ… Complete! Found ${found} receipts in ${elapsed}s`, 'ok');
  document.getElementById('progress-cancel-btn').style.display = 'none';
  document.getElementById('progress-close-btn').style.display = 'block';

  showToast(`Gmail search complete: ${found} receipts found`, 'âœ…');

  await loadCSV();
  applyFilters();
  renderTable();
}

// iMessage Search - Search iMessage for missing receipts
async function searchIMessageForMissing() {
  const missingRows = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (missingRows.length === 0) {
    showToast('All transactions have receipts!', 'âœ“');
    return;
  }

  if (!confirm(`Search iMessage for ${missingRows.length} missing receipts? This may take several minutes.`)) {
    return;
  }

  console.log(`ğŸ’¬ Starting iMessage search: ${missingRows.length} receipts to find`);

  batchProcessCancelled = false;

  const modal = document.getElementById('progress-modal');
  modal.classList.add('active');

  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">Searching iMessage database...</div>';

  let processed = 0;
  let found = 0;
  const total = missingRows.length;
  const startTime = Date.now();

  for (const row of missingRows) {
    if (batchProcessCancelled) {
      console.log('âŒ iMessage search cancelled');
      addProgressLog(`\nâš ï¸ Cancelled! Searched ${processed} of ${total}`, 'bad');
      document.getElementById('progress-cancel-btn').style.display = 'none';
      document.getElementById('progress-close-btn').style.display = 'block';
      showToast(`Cancelled after ${processed} receipts`, 'âš ï¸');
      return;
    }

    try {
      processed++;
      const percent = Math.round((processed / total) * 100);
      updateProgress(processed, found, percent, total);

      console.log(`[${processed}/${total}] Searching iMessage: ${row['Chase Description']?.substring(0, 40) || 'Unknown'}`);

      const res = await fetch('/search_imessage_receipt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: row._index,
          merchant: row['Chase Description'],
          amount: row['Chase Amount'],
          date: row['Chase Date']
        })
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();

      if (data.ok && data.result && data.result.receipt_file) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;

        const merchant = row['Chase Description'] || 'Unknown';
        console.log(`  âœ“ Found in iMessage`);
        addProgressLog(`âœ“ ${merchant.substring(0, 30)} â†’ Found in messages`, 'ok');
      } else {
        console.log(`  âŠ˜ Not found in iMessage`);
        addProgressLog(`âŠ˜ ${(row['Chase Description'] || 'Unknown').substring(0, 30)} â†’ Not found`, 'muted');
      }

      document.getElementById('progress-found').textContent = found;

    } catch (e) {
      console.error(`  âœ— Error searching iMessage:`, e);
      addProgressLog(`âœ— Error: ${e.message}`, 'bad');
    }
  }

  const elapsed = Math.round((Date.now() - startTime) / 1000);
  console.log(`âœ… iMessage search complete in ${elapsed}s: Found ${found} of ${total} receipts`);

  addProgressLog(`\nâœ… Complete! Found ${found} receipts in ${elapsed}s`, 'ok');
  document.getElementById('progress-cancel-btn').style.display = 'none';
  document.getElementById('progress-close-btn').style.display = 'block';

  showToast(`iMessage search complete: ${found} receipts found`, 'âœ…');

  await loadCSV();
  applyFilters();
  renderTable();
}

// Process single transaction through MI
async function processSingleMI(rowIndex) {
  try {
    const response = await fetch('/process_mi', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({_index: rowIndex})
    });

    const result = await response.json();

    if (result.ok) {
      showToast(result.message, 'âœ…');
      await loadCSV();
      applyFilters();
      renderTable();
    } else {
      showToast(result.message || 'MI processing failed', 'âŒ');
    }
  } catch (e) {
    showToast('MI error: ' + e.message, 'âŒ');
  }
}

async function findMissingReceipts() {
  // Find rows without receipts
  const missingRows = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (missingRows.length === 0) {
    showToast('All transactions have receipts!', 'âœ“');
    return;
  }

  if (!confirm(`Process ${missingRows.length} missing receipts? This may take several minutes.`)) {
    return;
  }

  console.log(`ğŸš€ Starting batch process: ${missingRows.length} receipts to process`);

  // Reset cancel flag
  batchProcessCancelled = false;

  // Show progress modal
  const modal = document.getElementById('progress-modal');
  console.log('ğŸ“Š Showing progress modal...');
  modal.classList.add('active');
  console.log('ğŸ“Š Modal classList:', modal.classList.toString());
  console.log('ğŸ“Š Modal display:', window.getComputedStyle(modal).display);
  console.log('ğŸ“Š Modal z-index:', window.getComputedStyle(modal).zIndex);

  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">Starting batch process...</div>';

  console.log('âœ… Progress modal configuration complete!');

  let processed = 0;
  let found = 0;
  const total = missingRows.length;
  const startTime = Date.now();

  // Process each row individually so we can show progress
  for (const row of missingRows) {
    // Check if cancelled
    if (batchProcessCancelled) {
      console.log('âŒ Batch process cancelled by user');
      addProgressLog(`\nâš ï¸ Cancelled! Processed ${processed} of ${total}`, 'bad');
      document.getElementById('progress-cancel-btn').style.display = 'none';
      document.getElementById('progress-close-btn').style.display = 'block';
      showToast(`Cancelled after ${processed} receipts`, 'âš ï¸');
      return;
    }

    try {
      // Update progress
      processed++;
      const percent = Math.round((processed / total) * 100);
      updateProgress(processed, found, percent, total);

      console.log(`[${processed}/${total}] Processing: ${row['Chase Description']?.substring(0, 40) || 'Unknown'}`);

      // Call AI match endpoint for this row
      const res = await fetch('/ai_match', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({_index: row._index})
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();

      if (data.ok && data.result.receipt_file) {
        found++;
        // Update the row in our data
        Object.assign(row, data.result);

        // Mark as newly matched for visual highlighting
        row._newlyMatched = true;

        // Log the match
        const merchant = row['Chase Description'] || 'Unknown';
        const confidence = data.result.ai_confidence || 0;
        console.log(`  âœ“ Found receipt: ${confidence}% confidence`);
        addProgressLog(`âœ“ ${merchant.substring(0, 30)} â†’ ${confidence}% match`, 'ok');
      } else {
        console.log(`  âŠ˜ No match found`);
        addProgressLog(`âŠ˜ ${(row['Chase Description'] || 'Unknown').substring(0, 30)} â†’ No match`, 'muted');
      }

      // Update progress counters
      document.getElementById('progress-found').textContent = found;

    } catch (e) {
      console.error(`  âœ— Error processing receipt:`, e);
      addProgressLog(`âœ— Error: ${e.message}`, 'bad');
    }
  }

  // Calculate time
  const elapsed = Math.round((Date.now() - startTime) / 1000);
  console.log(`âœ… Batch complete in ${elapsed}s: Found ${found} of ${total} receipts`);

  // Complete - hide cancel, show close button
  document.getElementById('progress-cancel-btn').style.display = 'none';
  document.getElementById('progress-close-btn').style.display = 'block';
  addProgressLog(`\nğŸ‰ Complete! Found ${found} of ${total} receipts (${elapsed}s)`, 'ok');

  // Reload CSV to get all updates
  await loadCSV();
  showToast(`Batch complete! Found ${found} of ${total} receipts`, 'âœ“');

  // Auto-remove highlighting after 30 seconds
  setTimeout(() => {
    csvData.forEach(row => {
      if (row._newlyMatched) {
        row._newlyMatched = false;
      }
    });
    renderTable();
    console.log('ğŸ¨ Removed newly-matched highlighting');
  }, 30000);
}

function cancelBatchProcess() {
  if (confirm('Cancel batch processing?')) {
    batchProcessCancelled = true;
    console.log('ğŸ›‘ Cancelling batch process...');
  }
}

function updateProgress(processed, found, percent, total) {
  document.getElementById('progress-bar').style.width = `${percent}%`;
  document.getElementById('progress-text').textContent = `${percent}%`;
  document.getElementById('progress-processed').textContent = `${processed} / ${total}`;
  document.getElementById('progress-found').textContent = found;
}

function addProgressLog(message, type = 'muted') {
  const log = document.getElementById('progress-log');
  const colors = {
    ok: 'var(--ok)',
    bad: 'var(--bad)',
    muted: 'var(--muted)'
  };

  const entry = document.createElement('div');
  entry.style.color = colors[type] || colors.muted;
  entry.textContent = message;

  // Keep only last 20 entries
  if (log.children.length > 20) {
    log.removeChild(log.firstChild);
  }

  log.appendChild(entry);
  log.scrollTop = log.scrollHeight; // Auto-scroll to bottom
}

function closeProgressModal() {
  document.getElementById('progress-modal').classList.remove('active');
  renderTable();
}

async function detachReceipt() {
  if (!selectedRow) return;

  try {
    const response = await fetch('/detach_receipt', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({_index: selectedRow._index})
    });

    if (!response.ok) {
      throw new Error('Server error');
    }

    // Clear all receipt-related fields in local data
    selectedRow['Receipt File'] = '';
    selectedRow.receipt_file = '';
    selectedRow.r2_url = '';
    selectedRow['Review Status'] = '';  // This moves it to "Missing Receipt"
    selectedRow['AI Confidence'] = '';
    selectedRow.ai_receipt_merchant = '';
    selectedRow.ai_receipt_total = '';
    selectedRow.ai_receipt_date = '';
    selectedRow.receipt_validation_status = 'missing';
    selectedRow.receipt_validated = 0;

    // Re-apply filters - this will move the row to Missing Receipts if that filter exists
    applyFilters();
    loadReceipt();  // Show empty receipt panel
    showToast('Receipt detached - moved to Missing Receipts', 'âœ“');
  } catch (e) {
    showToast('Failed to detach: ' + e.message, 'âŒ');
  }
}

async function updateField(field, value) {
  if (!selectedRow) return;

  // Save scroll position BEFORE update
  const scrollContainer = document.querySelector('.table-wrap');
  const scrollPos = scrollContainer ? scrollContainer.scrollTop : 0;

  selectedRow[field] = value;
  try {
    await fetch('/update_row', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        _index: selectedRow._index,
        patch: {[field]: value}  // FIXED: was 'updates', should be 'patch'
      })
    });

    // âœ… FIX: Re-apply filters to rebuild filteredData with updated values
    // applyFilters() calls renderTable() + updateDashboard() - handles everything
    applyFilters();

    // Restore scroll position
    if (scrollContainer) {
      scrollContainer.scrollTop = scrollPos;
    }
  } catch (e) {
    showToast('Update failed: ' + e.message, 'âŒ');
  }
}

// Mark receipt as verified (updates receipt_validation_status to 'verified')
async function markReceiptVerified() {
  if (!selectedRow) {
    showToast('Select a transaction first', 'âš ï¸');
    return;
  }

  // Update both the validation status and review status
  selectedRow.receipt_validation_status = 'verified';
  selectedRow['Review Status'] = 'good';

  try {
    await fetch('/update_row', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        _index: selectedRow._index,
        patch: {
          receipt_validation_status: 'verified',
          receipt_validation_note: 'Manually verified',
          'Review Status': 'good'
        }
      })
    });

    applyFilters();
    showToast('Receipt marked as VERIFIED', 'âœ“âœ“');
  } catch (e) {
    showToast('Failed to verify: ' + e.message, 'âŒ');
  }
}

// NEW: Update a single row in-place without rebuilding table
function updateRowInPlace(row) {
  const tbody = document.getElementById('tbody');
  const tr = Array.from(tbody.children).find(
    tr => tr.dataset.index == row._index
  );

  if (!tr) {
    // Row doesn't exist in current filter - it may have been filtered out
    applyFilters();  // Re-filter to remove it
    return;
  }

  // Update cells in-place
  const cells = tr.cells;
  if (!cells || cells.length < 7) return;

  // Cell 0: Date - handles both YYYY-MM-DD and MySQL date formats
  const dateStr = row['Chase Date'] || '';
  if (dateStr) {
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    let year, month, day;
    const parts = dateStr.split('-');
    if (parts.length === 3 && parts[0].length === 4) {
      year = parts[0];
      month = months[parseInt(parts[1]) - 1] || parts[1];
      day = parseInt(parts[2]);
    } else {
      try {
        const d = new Date(dateStr);
        if (!isNaN(d.getTime())) {
          year = d.getFullYear();
          month = months[d.getMonth()];
          day = d.getDate();
        }
      } catch (e) {}
    }
    if (year && month && day) {
      cells[0].innerHTML = `<div class="date-cell"><span class="date-month-day">${month} ${day}</span><span class="date-year">${year}</span></div>`;
    }
  }

  // Cell 1: Description
  cells[1].textContent = row['Chase Description'] || '';

  // Cell 2: Amount
  const amt = parseFloat(row['Chase Amount'] || 0);
  const amtClass = amt > 0 ? 'neg' : 'pos';
  const amtSign = amt > 0 ? '-' : '+';
  cells[2].innerHTML = `<span class="amount ${amtClass}">${amtSign}$${Math.abs(amt).toFixed(2)}</span>`;

  // Cell 3: Business Type
  cells[3].textContent = row['Business Type'] || '';

  // Cell 4: Review Status
  cells[4].innerHTML = getStatusBadge(row['Review Status']);

  // Cell 5: AI Confidence
  cells[5].innerHTML = getConfidenceIndicator(row);

  // Cell 6: Notes
  const notes = row['Notes'] || '';
  const notesHtml = notes
    ? `<div class="notes-cell" onclick="editNotes(event, ${row._index})" title="${notes}">${notes}</div>`
    : `<div class="notes-cell empty" onclick="editNotes(event, ${row._index})">Click to add note</div>`;
  cells[6].innerHTML = notesHtml;
}

// Connect Gmail account via OAuth popup
function connectGmail(email) {
  showToast(`Opening Google authorization...`, 'ğŸ”—');

  // Open OAuth in a popup window
  const width = 600;
  const height = 700;
  const left = (window.innerWidth - width) / 2 + window.screenX;
  const top = (window.innerHeight - height) / 2 + window.screenY;

  const popup = window.open(
    `/api/gmail/authorize/${encodeURIComponent(email)}`,
    'gmail_oauth',
    `width=${width},height=${height},left=${left},top=${top},menubar=no,toolbar=no,location=no,status=no`
  );

  // Poll for popup closure and refresh status
  const pollTimer = setInterval(() => {
    if (popup.closed) {
      clearInterval(pollTimer);
      showToast('Checking Gmail status...', 'ğŸ”„');
      setTimeout(() => checkGmailStatus(), 500);
    }
  }, 500);
}

// Disconnect Gmail account
async function disconnectGmail(email) {
  if (!confirm(`Disconnect ${email}? You'll need to re-authorize to use Gmail features.`)) {
    return;
  }

  try {
    const res = await fetch(`/api/gmail/disconnect/${encodeURIComponent(email)}`, {
      method: 'POST'
    });
    const data = await res.json();
    if (data.ok) {
      showToast(`Disconnected ${email}`, 'âœ“');
      await checkGmailStatus();
    } else {
      showToast(data.error || 'Failed to disconnect', 'âŒ');
    }
  } catch (e) {
    showToast(`Error: ${e.message}`, 'âŒ');
  }
}

// Check Gmail account status from backend
async function checkGmailStatus() {
  const emailToId = {
    'kaplan.brian@gmail.com': { status: 'gmail-status-personal', btn: 'gmail-btn-personal' },
    'brian@musiccityrodeo.com': { status: 'gmail-status-mcr', btn: 'gmail-btn-mcr' },
    'brian@downhome.com': { status: 'gmail-status-downhome', btn: 'gmail-btn-downhome' }
  };

  try {
    const res = await fetch('/settings/gmail/status');
    const data = await res.json();

    if (data.ok && data.accounts) {
      data.accounts.forEach(account => {
        const ids = emailToId[account.email];
        if (!ids) return;

        const statusEl = document.getElementById(ids.status);
        const btnEl = document.getElementById(ids.btn);

        if (!statusEl) return;

        // If we have a refresh_token, we're connected (access token auto-refreshes when used)
        const isConnected = account.exists && account.has_refresh_token;

        if (!account.exists) {
          statusEl.className = 'badge badge-neutral';
          statusEl.textContent = 'Not connected';
          if (btnEl) {
            btnEl.textContent = 'ğŸ”— Connect';
            btnEl.onclick = () => connectGmail(account.email);
          }
        } else if (account.has_refresh_token) {
          // Connected - has refresh token so can auto-refresh when needed
          statusEl.className = 'badge badge-good';
          statusEl.textContent = account.expired ? 'Connected (will refresh)' : 'Connected';
          if (btnEl) {
            btnEl.textContent = 'ğŸ”Œ Disconnect';
            btnEl.onclick = () => disconnectGmail(account.email);
          }
        } else if (account.expired) {
          // No refresh token AND expired - need to reconnect
          statusEl.className = 'badge badge-bad';
          statusEl.textContent = 'Expired';
          if (btnEl) {
            btnEl.textContent = 'ğŸ”„ Reconnect';
            btnEl.onclick = () => connectGmail(account.email);
          }
        } else {
          statusEl.className = 'badge badge-neutral';
          statusEl.textContent = 'Needs auth';
          if (btnEl) {
            btnEl.textContent = 'ğŸ”— Connect';
            btnEl.onclick = () => connectGmail(account.email);
          }
        }
      });
    }
  } catch (e) {
    console.error('Error checking Gmail status:', e);
  }
}

// Rendering
// Cached month names for performance
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function renderTable() {
  const tbody = document.getElementById('tbody');

  // Use DocumentFragment for batch DOM operations (significant performance improvement)
  const fragment = document.createDocumentFragment();

  // Pre-calculate selected index for faster comparison
  const selectedIndex = selectedRow ? selectedRow._index : null;

  // Filter out transactions that are in open reports (they're hidden from main view)
  const visibleData = filteredData.filter(row => {
    if (typeof isInAnyReport === 'function' && isInAnyReport(row._index)) {
      return false;
    }
    return true;
  });

  visibleData.forEach(row => {
    const tr = document.createElement('tr');
    const rowIndex = row._index;

    // Add data-index for swipe gestures and swipe-row class
    tr.dataset.index = rowIndex;
    tr.classList.add('swipe-row');

    if (selectedIndex !== null && rowIndex === selectedIndex) {
      tr.classList.add('selected');
    }

    // Highlight newly matched receipts
    if (row._newlyMatched) {
      tr.classList.add('newly-matched');
    }

    // Check if this is a refund (cache amount)
    const amt = parseFloat(row['Chase Amount'] || row['Amount'] || 0);
    const isRefund = amt < 0 || row['Review Status'] === 'refund';
    if (isRefund) {
      tr.classList.add('refund-row');
    }

    // Format date - optimized parsing
    const dateStr = row['Chase Date'] || '';
    let dateHtml = '';
    if (dateStr) {
      let year, month, day;
      const parts = dateStr.split('-');
      if (parts.length === 3 && parts[0].length === 4) {
        year = parts[0];
        month = MONTHS[parseInt(parts[1]) - 1] || parts[1];
        day = parseInt(parts[2]);
      } else {
        try {
          const d = new Date(dateStr);
          if (!isNaN(d.getTime())) {
            year = d.getFullYear();
            month = MONTHS[d.getMonth()];
            day = d.getDate();
          }
        } catch (e) {}
      }

      dateHtml = (year && month && day)
        ? `<div class="date-cell"><span class="date-month-day">${month} ${day}</span><span class="date-year">${year}</span></div>`
        : dateStr;
    }

    // Format amount with +/- sign
    const amtClass = amt > 0 ? 'neg' : 'pos';
    const amtSign = amt > 0 ? '-' : '+';
    const amtHtml = `<span class="amount ${amtClass}">${amtSign}$${Math.abs(amt).toFixed(2)}</span>`;

    // MI Enhanced fields
    const miMerchant = row['MI Merchant'] || row['Chase Description'] || '';
    const miCategory = row['MI Category'] || row['Chase Category'] || '';
    const miDescription = row['MI Description'] || row['AI Note'] || row.ai_note || row.mi_description || row['Notes'] || row.notes || '';
    const isSubscription = row['MI Is Subscription'] === 1;

    // Merchant cell with subscription badge
    const merchantHtml = isSubscription
      ? `<div class="merchant-cell" title="${row['Chase Description'] || ''}">${miMerchant} <span class="sub-badge">SUB</span></div>`
      : `<div class="merchant-cell" title="${row['Chase Description'] || ''}">${miMerchant}</div>`;

    // Category cell
    const categoryHtml = `<span class="category-badge">${miCategory}</span>`;

    // Description cell with inline editing
    const descHtml = miDescription
      ? `<div class="notes-cell" onclick="editNotes(event, ${rowIndex})" title="${miDescription}">${miDescription}</div>`
      : `<div class="notes-cell empty" onclick="editNotes(event, ${rowIndex})">Click to add note</div>`;

    // Receipt indicator - check both local file and R2 URL
    const receiptFile = row['Receipt File'] || '';
    const r2Url = row['r2_url'] || row['R2 URL'] || row['receipt_url'] || '';
    const hasReceipt = receiptFile || r2Url;
    const receiptHtml = hasReceipt
      ? `<span class="receipt-indicator has-receipt" title="${receiptFile || r2Url}">âœ“</span>`
      : `<span class="receipt-indicator no-receipt">â€“</span>`;

    tr.innerHTML = `
      <td>${dateHtml}</td>
      <td>${merchantHtml}</td>
      <td>${amtHtml}</td>
      <td>${categoryHtml}</td>
      <td>${row['Business Type'] || ''}</td>
      <td>${getStatusBadge(row['Review Status'], isRefund)}</td>
      <td>${receiptHtml}</td>
      <td>${descHtml}</td>
    `;

    tr.dataset.index = rowIndex;
    tr.onclick = (e) => {
      // Don't select row if clicking on notes cell
      if (!e.target.classList.contains('notes-cell') && !e.target.classList.contains('notes-input')) {
        // On mobile/tablet, open the mobile receipt viewer
        if (window.innerWidth <= 1024) {
          showMobileReceiptViewer(rowIndex);
        } else {
          selectRow(row);
        }
      }
    };
    fragment.appendChild(tr);
  });

  // Single DOM update - much faster than individual appendChild calls
  tbody.innerHTML = '';
  tbody.appendChild(fragment);

  // Also render mobile cards
  renderMobileCards();
}

// Render mobile card view
function renderMobileCards() {
  const mobileCards = document.getElementById('mobile-cards');
  if (!mobileCards) return;

  if (filteredData.length === 0) {
    mobileCards.innerHTML = `
      <div class="mobile-cards-empty">
        <div class="mobile-cards-empty-icon">ğŸ“­</div>
        <div class="mobile-cards-empty-text">No transactions match your filters</div>
      </div>`;
    return;
  }

  const selectedIndex = selectedRow ? selectedRow._index : null;
  let html = '';

  filteredData.forEach(row => {
    const rowIndex = row._index;
    const isSelected = selectedIndex !== null && rowIndex === selectedIndex;

    // Amount
    const amt = parseFloat(row['Chase Amount'] || row['Amount'] || 0);
    const isRefund = amt < 0 || row['Review Status'] === 'refund';
    const amtClass = isRefund ? 'refund' : (amt > 0 ? 'negative' : 'positive');
    const amtSign = amt > 0 ? '-' : '+';
    const amtDisplay = `${amtSign}$${Math.abs(amt).toFixed(2)}`;

    // Date
    const dateStr = row['Chase Date'] || '';
    let dateDisplay = dateStr;
    if (dateStr) {
      const parts = dateStr.split('-');
      if (parts.length === 3 && parts[0].length === 4) {
        const month = MONTHS[parseInt(parts[1]) - 1] || parts[1];
        const day = parseInt(parts[2]);
        dateDisplay = `${month} ${day}, ${parts[0]}`;
      }
    }

    // Fields
    const merchant = row['MI Merchant'] || row['Chase Description'] || 'Unknown';
    const category = row['MI Category'] || row['Chase Category'] || '';
    const business = row['Business Type'] || '';
    const status = row['Review Status'] || 'pending';

    // Receipt check
    const receiptFile = row['Receipt File'] || '';
    const r2Url = row['r2_url'] || row['R2 URL'] || row['receipt_url'] || '';
    const hasReceipt = receiptFile || r2Url;
    const receiptClass = hasReceipt ? 'has-receipt' : 'no-receipt';
    const receiptIcon = hasReceipt ? 'âœ“' : '!';
    const receiptIconClass = hasReceipt ? 'has' : 'missing';

    // Status badge
    let statusHtml = '';
    if (isRefund) {
      statusHtml = '<span class="badge badge-refund" style="font-size:10px;padding:3px 8px">Refund</span>';
    } else if (status === 'good') {
      statusHtml = '<span class="badge badge-good" style="font-size:10px;padding:3px 8px">Good</span>';
    } else if (status === 'bad') {
      statusHtml = '<span class="badge badge-bad" style="font-size:10px;padding:3px 8px">Bad</span>';
    }

    html += `
      <div class="tx-card ${receiptClass}${isSelected ? ' selected' : ''}"
           data-index="${rowIndex}"
           onclick="openMobileDrawer(${rowIndex})">
        <div class="tx-card-header">
          <div class="tx-card-merchant">${merchant}</div>
          <div class="tx-card-amount ${amtClass}">${amtDisplay}</div>
        </div>
        <div class="tx-card-body">
          <div class="tx-card-date">${dateDisplay}</div>
          ${category ? `<div class="tx-card-category">${category}</div>` : ''}
          ${business ? `<div class="tx-card-business">${business}</div>` : ''}
        </div>
        <div class="tx-card-footer">
          <div class="tx-card-status">
            <div class="tx-card-receipt-icon ${receiptIconClass}">${receiptIcon}</div>
            ${statusHtml}
          </div>
          <div class="tx-card-arrow">â€º</div>
        </div>
      </div>`;
  });

  mobileCards.innerHTML = html;
}

// Mobile drawer functions
let currentDrawerRow = null;

function openMobileDrawer(rowIndex) {
  const row = csvData.find(r => r._index === rowIndex);
  if (!row) return;

  currentDrawerRow = row;
  selectedRow = row;

  // Create drawer if not exists
  let drawer = document.getElementById('tx-drawer');
  let backdrop = document.getElementById('tx-drawer-backdrop');

  if (!drawer) {
    backdrop = document.createElement('div');
    backdrop.id = 'tx-drawer-backdrop';
    backdrop.className = 'tx-drawer-backdrop';
    backdrop.onclick = closeMobileDrawer;
    document.body.appendChild(backdrop);

    drawer = document.createElement('div');
    drawer.id = 'tx-drawer';
    drawer.className = 'tx-drawer';
    document.body.appendChild(drawer);
  }

  // Get data
  const amt = parseFloat(row['Chase Amount'] || row['Amount'] || 0);
  const isRefund = amt < 0 || row['Review Status'] === 'refund';
  const amtSign = amt > 0 ? '-' : '+';
  const amtDisplay = `${amtSign}$${Math.abs(amt).toFixed(2)}`;
  const amtClass = isRefund ? 'color:var(--pos)' : (amt > 0 ? '' : 'color:var(--pos)');

  const dateStr = row['Chase Date'] || '';
  let dateDisplay = dateStr;
  if (dateStr) {
    const parts = dateStr.split('-');
    if (parts.length === 3) {
      const month = MONTHS[parseInt(parts[1]) - 1] || parts[1];
      dateDisplay = `${month} ${parseInt(parts[2])}, ${parts[0]}`;
    }
  }

  const merchant = row['MI Merchant'] || row['Chase Description'] || 'Unknown';
  const category = row['MI Category'] || row['Chase Category'] || 'Uncategorized';
  const business = row['Business Type'] || 'Unassigned';
  const status = row['Review Status'] || 'pending';
  const description = row['Chase Description'] || '';
  const notes = row['MI Description'] || row['Notes'] || '';

  // Receipt
  const receiptFile = row['Receipt File'] || '';
  const r2Url = row['r2_url'] || row['R2 URL'] || row['receipt_url'] || '';
  const hasReceipt = receiptFile || r2Url;

  let receiptHtml = '';
  if (hasReceipt) {
    const imgUrl = r2Url || `/receipts/${encodeURIComponent(receiptFile)}`;
    receiptHtml = `<img src="${imgUrl}" alt="Receipt" onerror="this.parentElement.innerHTML='<div class=tx-drawer-receipt-placeholder><div class=tx-drawer-receipt-placeholder-icon>âš ï¸</div><div>Failed to load receipt</div></div>'">`;
  } else {
    receiptHtml = `
      <div class="tx-drawer-receipt-placeholder">
        <div class="tx-drawer-receipt-placeholder-icon">ğŸ“„</div>
        <div>No receipt attached</div>
      </div>`;
  }

  drawer.innerHTML = `
    <div class="tx-drawer-handle"></div>
    <div class="tx-drawer-header">
      <div class="tx-drawer-title">${merchant}</div>
      <button class="tx-drawer-close" onclick="closeMobileDrawer()">Ã—</button>
    </div>
    <div class="tx-drawer-body">
      <div class="tx-drawer-receipt">${receiptHtml}</div>
      <div class="tx-drawer-details">
        <div class="tx-drawer-row">
          <div class="tx-drawer-label">Amount</div>
          <div class="tx-drawer-value amount" style="${amtClass}">${amtDisplay}</div>
        </div>
        <div class="tx-drawer-row">
          <div class="tx-drawer-label">Date</div>
          <div class="tx-drawer-value">${dateDisplay}</div>
        </div>
        <div class="tx-drawer-row">
          <div class="tx-drawer-label">Category</div>
          <div class="tx-drawer-value">${category}</div>
        </div>
        <div class="tx-drawer-row">
          <div class="tx-drawer-label">Business</div>
          <div class="tx-drawer-value">${business}</div>
        </div>
        <div class="tx-drawer-row">
          <div class="tx-drawer-label">Status</div>
          <div class="tx-drawer-value">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
        </div>
        ${description ? `<div class="tx-drawer-row"><div class="tx-drawer-label">Description</div><div class="tx-drawer-value" style="font-size:13px">${description}</div></div>` : ''}
        ${notes ? `<div class="tx-drawer-row"><div class="tx-drawer-label">Notes</div><div class="tx-drawer-value" style="font-size:13px">${notes}</div></div>` : ''}
      </div>
    </div>
    <div class="tx-drawer-actions">
      <button class="tx-drawer-btn secondary" onclick="markMobileStatus('good')">âœ“ Good</button>
      <button class="tx-drawer-btn secondary" onclick="markMobileStatus('bad')">âœ— Bad</button>
      ${!hasReceipt ? `<button class="tx-drawer-btn primary" onclick="closeMobileDrawer();window.location.href='/scanner'" style="grid-column:span 2">ğŸ“· Add Receipt</button>` : ''}
    </div>`;

  // Show drawer
  setTimeout(() => {
    backdrop.classList.add('active');
    drawer.classList.add('active');
  }, 10);

  // Update card selection
  renderMobileCards();
}

function closeMobileDrawer() {
  const drawer = document.getElementById('tx-drawer');
  const backdrop = document.getElementById('tx-drawer-backdrop');
  if (drawer) drawer.classList.remove('active');
  if (backdrop) backdrop.classList.remove('active');
  currentDrawerRow = null;
}

async function markMobileStatus(status) {
  if (!currentDrawerRow) return;

  try {
    await fetch('/update_row', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        _index: currentDrawerRow._index,
        patch: {'Review Status': status}
      })
    });

    currentDrawerRow['Review Status'] = status;
    showToast(`Marked as ${status}`, 'âœ“');
    closeMobileDrawer();
    renderTable();
  } catch (e) {
    showToast('Failed to update: ' + e.message, 'âŒ');
  }
}

function getStatusBadge(status, isRefund) {
  if (isRefund || status === 'refund') return '<span class="badge badge-refund">Refund</span>';
  if (!status) return '<span class="badge badge-pending">Pending</span>';
  if (status === 'good') return '<span class="badge badge-good">Good</span>';
  if (status === 'bad') return '<span class="badge badge-bad">Bad</span>';
  return `<span class="badge badge-pending">${status}</span>`;
}

function getConfidenceIndicator(row) {
  // Check if receipt exists (any source)
  const receiptFile = (row['Receipt File'] || '').trim();
  const receiptUrl = (row.receipt_url || '').trim();
  const r2Url = (row.r2_url || row['R2 URL'] || '').trim();
  if (!receiptFile && !receiptUrl && !r2Url) {
    return 'â€”';
  }

  // Get confidence score
  const confidence = parseFloat(row['AI Confidence']) || 0;

  // Determine confidence level and color
  let level, className, label;
  if (confidence >= 90) {
    level = 'excellent';
    className = 'conf-excellent';
    label = `${confidence.toFixed(0)}%`;
  } else if (confidence >= 80) {
    level = 'very-good';
    className = 'conf-very-good';
    label = `${confidence.toFixed(0)}%`;
  } else if (confidence >= 70) {
    level = 'good';
    className = 'conf-good';
    label = `${confidence.toFixed(0)}%`;
  } else if (confidence >= 60) {
    level = 'fair';
    className = 'conf-fair';
    label = `${confidence.toFixed(0)}%`;
  } else if (confidence > 0) {
    level = 'low';
    className = 'conf-low';
    label = `${confidence.toFixed(0)}%`;
  } else {
    // Receipt exists but no confidence score
    level = 'none';
    className = 'conf-none';
    label = 'â€”';
  }

  return `<span class="confidence-indicator ${className}" title="Match Confidence: ${label}">
    <span class="confidence-dot ${className}"></span>
    ${label}
  </span>`;
}

function selectRow(row) {
  selectedRow = row;
  renderTable();
  loadReceipt();

  // Show quick action bar when row is selected
  if (typeof updateQuickActionBar === 'function') {
    updateQuickActionBar();
  }
}

// Notes inline editing
function editNotes(event, rowIndex) {
  event.stopPropagation();

  const row = csvData.find(r => r._index === rowIndex);
  if (!row) return;

  const cell = event.target;
  const currentNotes = row['Notes'] || '';

  // Create input field
  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'notes-input';
  input.value = currentNotes;
  input.placeholder = 'Add note...';

  // Replace cell content
  cell.innerHTML = '';
  cell.appendChild(input);
  input.focus();
  input.select();

  // Save on blur or Enter
  const saveNotes = async () => {
    const newNotes = input.value.trim();
    row['Notes'] = newNotes;

    // Update on server
    try {
      await fetch('/update_row', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: rowIndex,
          patch: {Notes: newNotes}
        })
      });
      renderTable();
      showToast('Note saved', 'âœ“');
    } catch (e) {
      showToast('Failed to save note: ' + e.message, 'âŒ');
      renderTable();
    }
  };

  input.addEventListener('blur', saveNotes);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      saveNotes();
    } else if (e.key === 'Escape') {
      renderTable();
    }
  });
}

function loadReceipt() {
  const wrap = document.getElementById('panzoom-wrap');
  const title = document.getElementById('viewer-title');

  // Check for R2 URL first (cloud storage), then local Receipt File
  const r2Url = selectedRow ? (selectedRow['r2_url'] || selectedRow['R2 URL'] || selectedRow['receipt_url']) : null;
  const receiptFile = selectedRow ? selectedRow['Receipt File'] : null;
  const reviewStatus = selectedRow ? (selectedRow['Review Status'] || '').toLowerCase().trim() : '';

  // Check if marked as "not needed" first
  if (selectedRow && reviewStatus === 'not needed') {
    wrap.innerHTML = `
      <div class="no-receipt" style="background:linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.05))">
        <div class="no-receipt-icon" style="font-size:64px">âœ…</div>
        <div class="no-receipt-text" style="color:#22c55e;font-weight:600">No Receipt Needed</div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">This expense doesn't require a receipt</div>
      </div>`;
    title.textContent = 'Not Needed';
    return;
  }

  if (!selectedRow || (!receiptFile && !r2Url)) {
    wrap.innerHTML = `
      <div class="no-receipt">
        <div class="no-receipt-icon">ğŸ“„</div>
        <div class="no-receipt-text">No receipt attached</div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">Drag & drop a receipt or use AI Match</div>
      </div>`;
    title.textContent = 'Receipt Viewer';
    return;
  }

  // Handle multiple receipt paths (comma-separated) - take first one
  let receiptPath = receiptFile ? receiptFile.split(',')[0].trim() : '';

  // Skip special values
  if (receiptPath === 'NO_RECEIPT_NEEDED' || receiptPath === 'NO_RECEIPT') {
    wrap.innerHTML = `
      <div class="no-receipt" style="background:linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.05))">
        <div class="no-receipt-icon" style="font-size:64px">âœ…</div>
        <div class="no-receipt-text" style="color:#22c55e;font-weight:600">No Receipt Needed</div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">This expense doesn't require a receipt</div>
      </div>`;
    title.textContent = 'Not Needed';
    return;
  }

  // Set title from receipt path or R2 URL
  if (receiptPath) {
    title.textContent = receiptPath.split('/').pop();
  } else if (r2Url) {
    title.textContent = r2Url.split('/').pop();
  }

  const img = document.createElement('img');

  // Use R2 URL if available (cloud storage), otherwise use local path
  if (r2Url && r2Url.startsWith('http')) {
    img.src = r2Url;
  } else if (receiptPath) {
    // Build proper local path - handle various path formats
    if (receiptPath.startsWith('receipts/')) {
      img.src = `/${receiptPath}`;
    } else if (receiptPath.startsWith('incoming/')) {
      img.src = `/${receiptPath}`;
    } else {
      img.src = `/receipts/${receiptPath}`;
    }
  } else {
    // Fallback - no valid path
    wrap.innerHTML = `
      <div class="no-receipt">
        <div class="no-receipt-icon">ğŸ“„</div>
        <div class="no-receipt-text">Receipt path not found</div>
      </div>`;
    title.textContent = 'Receipt Viewer';
    return;
  }
  img.alt = 'Receipt';
  img.style.imageOrientation = 'from-image'; // Auto-handle EXIF orientation

  // Auto-rotation: detect if image needs rotation after load
  img.onload = function() {
    let rotation = currentRotation;

    // Auto-rotate landscape images (width > height * 1.3) to portrait
    if (currentRotation === 0 && img.naturalWidth > img.naturalHeight * 1.3) {
      rotation = 90;
      currentRotation = 90;
    }

    // Apply rotation
    img.style.transform = `rotate(${rotation}deg)`;

    // Re-initialize panzoom after image loads
    if (panzoomInstance) panzoomInstance.destroy();
    panzoomInstance = Panzoom(img, {
      maxScale: 5,
      minScale: 0.5,
      startScale: 1.2,
      contain: 'outside'
    });

    wrap.addEventListener('wheel', panzoomInstance.zoomWithWheel);
  };

  // Error handling - try fallback if R2 URL fails
  img.onerror = function() {
    if (r2Url && receiptPath && !img.dataset.retried) {
      console.warn('R2 URL failed, trying local path:', receiptPath);
      img.dataset.retried = 'true';
      img.src = `/receipts/${receiptPath}`;
    } else {
      wrap.innerHTML = `
        <div class="no-receipt">
          <div class="no-receipt-icon">âš ï¸</div>
          <div class="no-receipt-text">Failed to load receipt</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Image may have been moved or deleted</div>
        </div>`;
      title.textContent = 'Load Error';
    }
  };

  // Initial rotation transform
  img.style.transform = `rotate(${currentRotation}deg)`;

  wrap.innerHTML = '';
  wrap.appendChild(img);
}

function updateDashboard() {
  // âœ… FIX: Use csvData for header totals so they ALWAYS show ALL transactions
  // This ensures live stats update correctly when business type changes
  const dataToUse = csvData;

  // Calculate totals by Business Type
  // Expenses (positive) + Refunds (negative, excluding payments) = Net Total
  // âœ… FIX: Use both Title Case and snake_case field names for robust field access
  const getAmount = (r) => parseFloat(r['Chase Amount'] || r['chase_amount'] || 0);
  const getDesc = (r) => (r['Chase Description'] || r['chase_description'] || '').toLowerCase();
  const isPaymentTxn = (desc) => desc.includes('payment thank you') || desc.includes('payment - web');

  const downHomeTotal = dataToUse
    .filter(r => r['Business Type'] === 'Down Home')
    .reduce((sum, r) => {
      const amt = getAmount(r);
      const desc = getDesc(r);
      // Include positive (expenses) and negative (refunds, but not payments)
      if (isPaymentTxn(desc)) return sum;  // Skip payments
      return sum + amt;  // Add positive expenses, subtract refunds (negative amounts)
    }, 0);

  const mcrTotal = dataToUse
    .filter(r => r['Business Type'] === 'Music City Rodeo')
    .reduce((sum, r) => {
      const amt = getAmount(r);
      const desc = getDesc(r);
      if (isPaymentTxn(desc)) return sum;
      return sum + amt;
    }, 0);

  const personalTotal = dataToUse
    .filter(r => r['Business Type'] === 'Personal')
    .reduce((sum, r) => {
      const amt = getAmount(r);
      const desc = getDesc(r);
      if (isPaymentTxn(desc)) return sum;
      return sum + amt;
    }, 0);

  const emcoTotal = dataToUse
    .filter(r => r['Business Type'] === 'EM.co')
    .reduce((sum, r) => {
      const amt = getAmount(r);
      const desc = getDesc(r);
      if (isPaymentTxn(desc)) return sum;
      return sum + amt;
    }, 0);

  // Credit Card Payments - Description contains "PAYMENT THANK YOU" (negative amounts)
  const paymentsTotal = dataToUse
    .reduce((sum, r) => {
      const amt = getAmount(r);
      const desc = getDesc(r);
      return isPaymentTxn(desc) ? sum + Math.abs(amt) : sum;
    }, 0);

  document.getElementById('down-home-total').textContent = `$${downHomeTotal.toFixed(2)}`;
  document.getElementById('mcr-total').textContent = `$${mcrTotal.toFixed(2)}`;
  document.getElementById('emco-total').textContent = `$${emcoTotal.toFixed(2)}`;
  document.getElementById('personal-total').textContent = `$${personalTotal.toFixed(2)}`;
  document.getElementById('payments-total').textContent = `+$${paymentsTotal.toFixed(2)}`;

  // Update ALL filter counts (from ALL data, not filtered)
  const counts = {
    all: csvData.length,
    // âœ… Needs review = has receipt AND (no status OR status not in good/bad/not needed)
    needsReview: csvData.filter(r => {
      const status = (r['Review Status'] || '').toLowerCase().trim();
      const receiptFile = (r['Receipt File'] || '').trim();
      const receiptUrl = (r.receipt_url || '').trim();
      const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
      const hasReceipt = receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
      return hasReceipt && (!status || (status !== 'good' && status !== 'bad' && status !== 'not needed'));
    }).length,
    // âœ… Good/Bad must have receipts
    good: csvData.filter(r => {
      const receiptFile = (r['Receipt File'] || '').trim();
      const receiptUrl = (r.receipt_url || '').trim();
      const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
      const hasReceipt = receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
      return hasReceipt && r['Review Status'] === 'good';
    }).length,
    bad: csvData.filter(r => {
      const receiptFile = (r['Receipt File'] || '').trim();
      const receiptUrl = (r.receipt_url || '').trim();
      const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
      const hasReceipt = receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
      return hasReceipt && r['Review Status'] === 'bad';
    }).length,
    missing: csvData.filter(r => {
      const receiptFile = (r['Receipt File'] || '').trim();
      const receiptUrl = (r.receipt_url || '').trim();
      const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
      const status = (r['Review Status'] || '').toLowerCase().trim();
      const hasReceipt = receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
      return !hasReceipt && status !== 'not needed';
    }).length,
    withReceipts: csvData.filter(r => {
      const receiptFile = (r['Receipt File'] || '').trim();
      const receiptUrl = (r.receipt_url || '').trim();
      const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
      return receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
    }).length,
    notNeeded: csvData.filter(r => r['Review Status'] === 'not needed' || r['Receipt File'] === 'NO_RECEIPT_NEEDED').length,
    // âœ… Refunds = negative amounts OR review_status = refund
    refunds: csvData.filter(r => {
      const amount = parseFloat(r['Chase Amount'] || r['Amount'] || 0);
      return amount < 0 || r['Review Status'] === 'refund';
    }).length,
    mcr: csvData.filter(r => r['Business Type'] === 'Music City Rodeo').length,
    downhome: csvData.filter(r => r['Business Type'] === 'Down Home').length,
    emco: csvData.filter(r => r['Business Type'] === 'EM.co').length,
    personal: csvData.filter(r => r['Business Type'] === 'Personal').length,
    unassigned: csvData.filter(r => !r['Business Type'] || r['Business Type'] === 'Unassigned').length,
    alreadySubmitted: csvData.filter(r => {
      const submitted = (r['Already Submitted'] || r.already_submitted || '').toLowerCase().trim();
      return submitted === 'yes' || submitted === '1' || submitted === 'true';
    }).length,
    // Receipt Validation Status counts (check both old and new OCR fields)
    receiptVerified: csvData.filter(r => {
      const status = (r.ocr_verification_status || r.receipt_validation_status || '').toLowerCase().trim();
      return status === 'verified';
    }).length,
    receiptMismatch: csvData.filter(r => {
      const status = (r.ocr_verification_status || r.receipt_validation_status || '').toLowerCase().trim();
      return status === 'mismatch';
    }).length,
    receiptError: csvData.filter(r => {
      const status = (r.ocr_verification_status || r.receipt_validation_status || '').toLowerCase().trim();
      return status === 'error' || status === 'unclear';
    }).length
  };

  // Update badge elements (badges are now shown on hover via CSS)
  const updateBadge = (id, count) => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = count;
      // No need to control display - CSS handles visibility via hover
    }
  };

  updateBadge('all-count', counts.all);
  updateBadge('needs-review-count', counts.needsReview);
  updateBadge('good-count', counts.good);
  updateBadge('bad-count', counts.bad);
  updateBadge('missing-count', counts.missing);
  updateBadge('with-receipts-count', counts.withReceipts);
  updateBadge('not-needed-count', counts.notNeeded);
  updateBadge('refunds-count', counts.refunds);
  updateBadge('mcr-count', counts.mcr);
  updateBadge('downhome-count', counts.downhome);
  updateBadge('emco-count', counts.emco);
  updateBadge('personal-count', counts.personal);
  updateBadge('unassigned-count', counts.unassigned);
  updateBadge('already-submitted-count', counts.alreadySubmitted);
  // Receipt validation status badges
  updateBadge('receipt-verified-count', counts.receiptVerified);
  updateBadge('receipt-mismatch-count', counts.receiptMismatch);
  updateBadge('receipt-error-count', counts.receiptError);
}

// Image controls
function rotateImage() {
  currentRotation = (currentRotation + 90) % 360;
  loadReceipt();
}

function zoomIn() {
  if (panzoomInstance) panzoomInstance.zoomIn();
}

function zoomOut() {
  if (panzoomInstance) panzoomInstance.zoomOut();
}

function resetZoom() {
  currentRotation = 0; // Reset rotation first
  if (panzoomInstance) {
    panzoomInstance.reset();
    panzoomInstance.zoom(1.2); // Reset to 120%
  }
  loadReceipt(); // Reload to apply reset rotation
}

// Quick Viewer - Fast Navigation
let quickViewerReceipts = []; // All receipts with images
let quickViewerIndex = 0; // Current index in receipts array
let quickPanzoomInstance = null; // Panzoom instance for quick viewer

function openQuickViewer() {
  if (!selectedRow) return;

  // Build list of ALL receipts (filtered or all, depending on view)
  // Check all receipt sources: Receipt File, receipt_url, r2_url
  quickViewerReceipts = filteredData.filter(r => {
    const receiptFile = (r['Receipt File'] || '').trim();
    const receiptUrl = (r.receipt_url || '').trim();
    const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
    return receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
  });

  if (quickViewerReceipts.length === 0) {
    showToast('No receipts to view', 'ğŸ“„');
    return;
  }

  // Find current row in the list
  quickViewerIndex = quickViewerReceipts.findIndex(r => r._index === selectedRow._index);
  if (quickViewerIndex === -1) quickViewerIndex = 0;

  // Show modal and load first receipt
  document.getElementById('quick-viewer').classList.add('active');
  updateQuickViewer();

  // Focus modal for keyboard events
  document.getElementById('quick-viewer').focus();
}

function closeQuickViewer() {
  // Cleanup Panzoom instance
  if (quickPanzoomInstance) {
    quickPanzoomInstance.destroy();
    quickPanzoomInstance = null;
  }
  document.getElementById('quick-viewer').classList.remove('active');
}

function navigateQuickViewer(direction) {
  if (quickViewerReceipts.length === 0) return;

  quickViewerIndex += direction;

  // Wrap around
  if (quickViewerIndex < 0) quickViewerIndex = quickViewerReceipts.length - 1;
  if (quickViewerIndex >= quickViewerReceipts.length) quickViewerIndex = 0;

  updateQuickViewer();
}

function jumpToQuickReceipt(percent) {
  if (quickViewerReceipts.length === 0) return;
  quickViewerIndex = Math.floor((quickViewerReceipts.length - 1) * (percent / 10));
  updateQuickViewer();
}

function updateQuickViewer() {
  const receipt = quickViewerReceipts[quickViewerIndex];
  if (!receipt) return;

  const imageDiv = document.getElementById('quick-image');

  // Update title
  document.getElementById('quick-title').textContent =
    `${receipt['Chase Description']} - ${receipt['Chase Date']}`;

  // Preserve zoom controls and confidence badge
  const zoomControls = imageDiv.querySelector('.quick-zoom-controls');
  const confidenceBadge = imageDiv.querySelector('.match-confidence');

  // Check for R2 URL (cloud storage) first, then local file
  const r2Url = receipt['r2_url'] || receipt['R2 URL'] || receipt['receipt_url'] || '';
  const receiptFile = receipt['Receipt File'] || '';
  const hasReceipt = r2Url || receiptFile;

  // Check if marked as "not needed"
  const reviewStatus = (receipt['Review Status'] || '').toLowerCase().trim();
  if (reviewStatus === 'not needed') {
    imageDiv.innerHTML = `
      <div class="no-receipt" style="background:linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.05))">
        <div class="no-receipt-icon" style="font-size:64px">âœ…</div>
        <div class="no-receipt-text" style="color:#22c55e;font-weight:600">No Receipt Needed</div>
      </div>`;
    if (zoomControls) imageDiv.appendChild(zoomControls);
    if (confidenceBadge) imageDiv.appendChild(confidenceBadge);
  } else if (hasReceipt) {
    const imgEl = document.createElement('img');

    // Use R2 URL (cloud) if available, otherwise local path
    if (r2Url && r2Url.startsWith('http')) {
      imgEl.src = r2Url;
    } else if (receiptFile) {
      // Build local path - handle various formats
      if (receiptFile.startsWith('http')) {
        imgEl.src = receiptFile;
      } else if (receiptFile.startsWith('receipts/') || receiptFile.startsWith('incoming/')) {
        imgEl.src = `/${receiptFile}`;
      } else {
        imgEl.src = `/receipts/${receiptFile}`;
      }
    }

    imgEl.alt = 'Receipt';
    imgEl.style.transition = 'opacity 0.2s ease';
    imgEl.style.imageOrientation = 'from-image'; // Auto-handle EXIF orientation
    imgEl.id = 'quick-viewer-img';

    // Auto-rotation: detect if image needs rotation after load
    imgEl.onload = function() {
      // Auto-rotate landscape images (width > height * 1.3) to portrait
      if (imgEl.naturalWidth > imgEl.naturalHeight * 1.3) {
        imgEl.style.transform = 'rotate(90deg)';
      } else {
        imgEl.style.transform = 'none';
      }
    };

    // Error handling - try fallback if R2 URL fails
    imgEl.onerror = function() {
      if (r2Url && receiptFile && !imgEl.dataset.retried) {
        console.warn('R2 URL failed, trying local path:', receiptFile);
        imgEl.dataset.retried = 'true';
        imgEl.src = `/receipts/${receiptFile}`;
      } else {
        imageDiv.innerHTML = `
          <div class="no-receipt">
            <div class="no-receipt-icon">âš ï¸</div>
            <div class="no-receipt-text">Failed to load receipt</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px">Image may have been moved or deleted</div>
          </div>`;
      }
    };

    // Initial transform (will be updated in onload)
    imgEl.style.transform = 'none';

    // Clear and rebuild
    imageDiv.innerHTML = '';
    if (zoomControls) imageDiv.appendChild(zoomControls);
    if (confidenceBadge) imageDiv.appendChild(confidenceBadge);
    imageDiv.appendChild(imgEl);

    // Initialize Panzoom on new image
    setTimeout(() => {
      if (quickPanzoomInstance) {
        quickPanzoomInstance.destroy();
      }
      quickPanzoomInstance = Panzoom(imgEl, {
        maxScale: 5,
        minScale: 0.5,
        step: 0.2,
        contain: 'outside'
      });
    }, 50);
  } else {
    imageDiv.innerHTML = `
      <div class="no-receipt">
        <div class="no-receipt-icon">ğŸ“„</div>
        <div class="no-receipt-text">No receipt attached</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">Press A to AI-match or drag & drop</div>
      </div>`;
    if (zoomControls) imageDiv.appendChild(zoomControls);
    if (confidenceBadge) imageDiv.appendChild(confidenceBadge);
  }

  // Check if this is an AI-matched receipt
  const isAIMatched = receipt['AI Note'] && receipt['AI Note'].trim() !== '';
  const confidence = parseFloat(receipt['AI Confidence'] || 0);

  // Show/hide confidence badge
  const badge = document.getElementById('quick-match-badge');
  if (isAIMatched && confidence > 0) {
    badge.style.display = 'flex';
    document.getElementById('quick-confidence-text').textContent = `${confidence}% Match`;

    // Color code by confidence
    badge.classList.remove('high', 'medium', 'low');
    if (confidence >= 85) badge.classList.add('high');
    else if (confidence >= 70) badge.classList.add('medium');
    else badge.classList.add('low');
  } else {
    badge.style.display = 'none';
  }

  // Update data with match highlighting (hidden fields for compatibility)
  updateQuickDataRow('quick-merchant', receipt['Chase Description'] || 'â€”', isAIMatched);

  const amt = parseFloat(receipt['Chase Amount'] || 0);
  const amtSign = amt > 0 ? '-' : '+';
  updateQuickDataRow('quick-amount', `${amtSign}$${Math.abs(amt).toFixed(2)}`, isAIMatched, true);

  updateQuickDataRow('quick-date', receipt['Chase Date'] || 'â€”', isAIMatched);

  // === COMPARISON PANEL UPDATE ===
  // BANK side - use exact same field names that work in the title
  const bankMerchantText = receipt['Chase Description'] || 'â€”';
  const bankAmountNum = Math.abs(parseFloat(receipt['Chase Amount']) || 0);
  const bankDateStr = receipt['Chase Date'] || '';

  // Format date as M/D
  let bankDateFormatted = 'â€”';
  if (bankDateStr) {
    const d = new Date(bankDateStr);
    if (!isNaN(d.getTime())) {
      bankDateFormatted = (d.getMonth()+1) + '/' + d.getDate();
    } else {
      bankDateFormatted = bankDateStr.substring(0, 10);
    }
  }

  // Update BANK comparison panel
  document.getElementById('compare-bank-merchant').textContent = bankMerchantText;
  document.getElementById('compare-bank-amount').textContent = '$' + bankAmountNum.toFixed(2);
  document.getElementById('compare-bank-date').textContent = bankDateFormatted;

  // RECEIPT side - use OCR data (preferred) or fall back to AI Note parsing
  const ocrMerchant = receipt['OCR Merchant'] || receipt['ocr_merchant'] || '';
  const ocrAmount = receipt['OCR Amount'] || receipt['ocr_amount'];
  const ocrDate = receipt['OCR Date'] || receipt['ocr_date'] || '';
  const ocrConfidence = receipt['OCR Confidence'] || receipt['ocr_confidence'] || 0;
  const hasOCR = ocrMerchant || ocrAmount || ocrDate;

  let rcptMerchant = 'â€”';
  let rcptAmount = 'â€”';
  let rcptDate = 'â€”';

  if (hasOCR) {
    // Use OCR-extracted data (high quality)
    rcptMerchant = ocrMerchant || 'â€”';
    rcptAmount = ocrAmount ? '$' + parseFloat(ocrAmount).toFixed(2) : 'â€”';
    if (ocrDate) {
      const d = new Date(ocrDate);
      rcptDate = !isNaN(d.getTime()) ? (d.getMonth()+1) + '/' + d.getDate() : ocrDate;
    }
  } else {
    // Fall back to AI Note parsing
    const aiNoteText = receipt['AI Note'] || '';
    if (aiNoteText) {
      const lines = aiNoteText.split(/[\n,]/);
      if (lines[0]) rcptMerchant = lines[0].trim().substring(0, 30) || 'â€”';
      const amtMatch = aiNoteText.match(/\$[\d,.]+/);
      if (amtMatch) rcptAmount = amtMatch[0];
      const dtMatch = aiNoteText.match(/\d{1,2}\/\d{1,2}(?:\/\d{2,4})?/);
      if (dtMatch) rcptDate = dtMatch[0];
    }
  }

  // Update RECEIPT comparison panel
  const rcptMerchantEl = document.getElementById('compare-receipt-merchant');
  const rcptAmountEl = document.getElementById('compare-receipt-amount');
  const rcptDateEl = document.getElementById('compare-receipt-date');

  rcptMerchantEl.textContent = rcptMerchant;
  rcptAmountEl.textContent = rcptAmount;
  rcptDateEl.textContent = rcptDate;

  // Amount match/mismatch highlighting
  if (rcptAmount !== 'â€”' && bankAmountNum > 0) {
    const rcptAmtNum = parseFloat(rcptAmount.replace(/[$,]/g, '')) || 0;
    const amtDiff = Math.abs(rcptAmtNum - bankAmountNum);
    if (amtDiff < 2) {
      rcptAmountEl.classList.add('match');
      rcptAmountEl.classList.remove('mismatch');
    } else {
      rcptAmountEl.classList.add('mismatch');
      rcptAmountEl.classList.remove('match');
    }
  } else {
    rcptAmountEl.classList.remove('match', 'mismatch');
  }

  // Show OCR source indicator if available
  const compareHeader = document.querySelector('.compare-col:last-child .compare-col-header');
  if (compareHeader) {
    if (hasOCR && ocrConfidence > 0) {
      compareHeader.innerHTML = `RECEIPT <span style="font-size:9px;color:#3b82f6;margin-left:4px">OCR ${Math.round(ocrConfidence*100)}%</span>`;
    } else if (hasOCR) {
      compareHeader.innerHTML = `RECEIPT <span style="font-size:9px;color:#3b82f6;margin-left:4px">OCR</span>`;
    } else {
      compareHeader.textContent = 'RECEIPT';
    }
  }

  // Update Business Type dropdown
  const businessSelect = document.getElementById('quick-business');
  businessSelect.value = receipt['Business Type'] || '';

  // Update Category (read-only)
  document.getElementById('quick-category').textContent = receipt['Chase Category'] || 'â€”';

  // Update Status dropdown
  const statusSelect = document.getElementById('quick-status');
  statusSelect.value = receipt['Review Status'] || '';

  // Update Notes textarea
  const notesTextarea = document.getElementById('quick-notes');
  notesTextarea.value = receipt['Notes'] || '';

  // Update AI Note textarea
  const aiNoteTextarea = document.getElementById('quick-ai-note');
  aiNoteTextarea.value = receipt['AI Note'] || '';

  // Auto-generate AI note if missing
  if (!receipt['AI Note'] && receipt._index !== undefined) {
    autoGenerateAINote(receipt._index);
  }

  // Update position indicator
  document.getElementById('quick-position').textContent =
    `${quickViewerIndex + 1} / ${quickViewerReceipts.length}`;

  // Update button states
  document.getElementById('quick-prev').disabled = false;
  document.getElementById('quick-next').disabled = false;

  // âœ… FIX: Update selectedRow so hotkeys (M, D, P, etc.) work on the correct transaction
  selectedRow = receipt;

  // Preload adjacent images for smooth navigation
  preloadAdjacentReceipts();
}

// Helper to update data row with match highlighting
function updateQuickDataRow(elementId, value, isMatched, isLarge = false) {
  const element = document.getElementById(elementId);
  const row = element.closest('.data-row');

  element.textContent = value;

  if (isMatched) {
    row.classList.add('matched');
  } else {
    row.classList.remove('matched');
  }
}

// Quick Viewer Zoom Functions
function quickZoom(delta) {
  if (quickPanzoomInstance) {
    const currentScale = quickPanzoomInstance.getScale();
    quickPanzoomInstance.zoom(currentScale + delta);
  }
}

function quickResetZoom() {
  if (quickPanzoomInstance) {
    quickPanzoomInstance.reset();
  }
}

// Handle keyboard shortcuts in textareas (Ctrl+Enter to save, Escape to blur)
function handleTextareaKeys(event, field) {
  // Ctrl+Enter or Cmd+Enter to save
  if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
    event.preventDefault();
    const textarea = event.target;
    quickUpdateField(field, textarea.value);
    textarea.blur(); // Remove focus after saving
    showToast(`${field} saved`, 'âœ“');
  }
  // Escape to cancel and blur
  else if (event.key === 'Escape') {
    event.preventDefault();
    event.target.blur();
  }
}

// Quick Viewer Field Update - Updates database AND refreshes display
async function quickUpdateField(field, value) {
  const currentReceipt = quickViewerReceipts[quickViewerIndex];
  if (!currentReceipt) return;

  const rowIndex = currentReceipt._index;

  // Update local data immediately for responsive UI
  currentReceipt[field] = value;

  // Also update selectedRow if it's the same transaction
  if (selectedRow && selectedRow._index === rowIndex) {
    selectedRow[field] = value;
  }

  // Update in csvData array
  const csvIndex = csvData.findIndex(r => r._index === rowIndex);
  if (csvIndex !== -1) {
    csvData[csvIndex][field] = value;
  }

  // Update in filteredData array
  const filteredIndex = filteredData.findIndex(r => r._index === rowIndex);
  if (filteredIndex !== -1) {
    filteredData[filteredIndex][field] = value;
  }

  try {
    // Save to backend (SQLite + CSV)
    const response = await fetch('/update_row', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        _index: rowIndex,
        patch: {[field]: value}
      })
    });

    if (!response.ok) {
      throw new Error(`Server returned ${response.status}`);
    }

    // âœ… FIX: Re-apply filters - this handles renderTable() + updateDashboard()
    applyFilters();

    // Update the quick viewer UI to reflect the change
    if (field === 'Review Status') {
      document.getElementById('quick-status').value = value;
    } else if (field === 'Business Type') {
      document.getElementById('quick-business').value = value;
    } else if (field === 'Notes') {
      document.getElementById('quick-notes').value = value;
    } else if (field === 'AI Note') {
      document.getElementById('quick-ai-note').value = value;
    }

    // Show success toast
    showToast(`${field} updated`, 'âœ“');

    console.log(`âœ… Quick Viewer: Updated ${field} = "${value}" for transaction #${rowIndex}`);
  } catch (e) {
    showToast(`Failed to update ${field}: ${e.message}`, 'âŒ');
    console.error(`âŒ Quick Viewer update failed:`, e);
  }
}

function preloadAdjacentReceipts() {
  const preloadIndices = [quickViewerIndex - 1, quickViewerIndex + 1];

  preloadIndices.forEach(idx => {
    if (idx >= 0 && idx < quickViewerReceipts.length) {
      const receipt = quickViewerReceipts[idx];
      const r2Url = receipt['r2_url'] || receipt['R2 URL'] || receipt['receipt_url'] || '';
      const receiptFile = receipt['Receipt File'] || '';

      if (r2Url || receiptFile) {
        const img = new Image();
        // Use R2 URL if available, otherwise local path
        if (r2Url && r2Url.startsWith('http')) {
          img.src = r2Url;
        } else if (receiptFile) {
          if (receiptFile.startsWith('http')) {
            img.src = receiptFile;
          } else {
            img.src = `/receipts/${receiptFile}`;
          }
        }
      }
    }
  });
}

// Keyboard shortcuts for quick viewer
document.addEventListener('keydown', (e) => {
  const modal = document.getElementById('quick-viewer');
  if (!modal.classList.contains('active')) return;
  // Don't interfere with input fields, textareas, or select dropdowns
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

  const key = e.key.toLowerCase();

  switch(key) {
    case 'arrowleft':
      e.preventDefault();
      navigateQuickViewer(-1);
      break;
    case 'arrowright':
      e.preventDefault();
      navigateQuickViewer(1);
      break;
    case 'escape':
      e.preventDefault();
      closeQuickViewer();
      break;
    // Status hotkeys
    case 'g':
      e.preventDefault();
      quickUpdateField('Review Status', 'good');
      break;
    case 'b':
      e.preventDefault();
      quickUpdateField('Review Status', 'bad');
      break;
    case 'n':
      e.preventDefault();
      quickUpdateField('Review Status', 'not needed');
      break;
    case 'c':
      e.preventDefault();
      quickUpdateField('Review Status', '');
      break;
    // Business type hotkeys
    case 'm':
      e.preventDefault();
      quickUpdateField('Business Type', 'Music City Rodeo');
      break;
    case 'd':
      e.preventDefault();
      quickUpdateField('Business Type', 'Down Home');
      break;
    case 'e':
      e.preventDefault();
      quickUpdateField('Business Type', 'EM.co');
      break;
    case 'p':
      e.preventDefault();
      quickUpdateField('Business Type', 'Personal');
      break;
    // Action hotkeys
    case 'x':
      e.preventDefault();
      detachReceipt();
      break;
    case 'a':
      e.preventDefault();
      aiMatch();
      break;
    case 'j':
      e.preventDefault();
      aiNote();
      break;
    case 'f':
      e.preventDefault();
      closeQuickViewer();
      openMissingReceiptModal();
      break;
    case 'r':
      e.preventDefault();
      closeQuickViewer();
      toggleReportTrayAndAdd();
      break;
    case '1': case '2': case '3': case '4': case '5':
    case '6': case '7': case '8': case '9':
      e.preventDefault();
      jumpToQuickReceipt(parseInt(e.key));
      break;
    case 'home':
      e.preventDefault();
      quickViewerIndex = 0;
      updateQuickViewer();
      break;
    case 'end':
      e.preventDefault();
      quickViewerIndex = quickViewerReceipts.length - 1;
      updateQuickViewer();
      break;
    case '+':
    case '=':
      e.preventDefault();
      quickZoom(0.2);
      break;
    case '-':
    case '_':
      e.preventDefault();
      quickZoom(-0.2);
      break;
    case '0':
      e.preventDefault();
      quickResetZoom();
      break;
  }
});


// ========================================================================
// MAIN TABLE HOTKEYS (Arrow Up/Down, G/B/N, M/D/P, X, Enter, A, J)
// ========================================================================
document.addEventListener('keydown', (e) => {
  // Skip if in quick viewer modal
  const quickViewer = document.getElementById('quick-viewer');
  if (quickViewer && quickViewer.classList.contains('active')) return;

  // Skip if typing in input/textarea
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  // Skip if no row selected
  if (!selectedRow) return;

  const key = e.key.toLowerCase();

  switch(key) {
    case 'arrowup':
      e.preventDefault();
      navigateTable(-1);  // Move selection up
      break;

    case 'arrowdown':
      e.preventDefault();
      navigateTable(1);  // Move selection down
      break;

    case 'g':
      e.preventDefault();
      updateField('Review Status', 'good');
      showToast('Marked as GOOD', 'âœ“');
      break;

    case 'b':
      e.preventDefault();
      updateField('Review Status', 'bad');
      showToast('Marked as BAD', 'âœ—');
      break;

    case 'n':
      e.preventDefault();
      updateField('Review Status', 'not needed');
      showToast('Marked as NOT NEEDED', 'â„¹ï¸');
      break;

    case 'm':
      e.preventDefault();
      updateField('Business Type', 'Music City Rodeo');
      showToast('Business Type: Music City Rodeo', 'ğŸµ');
      break;

    case 'd':
      e.preventDefault();
      updateField('Business Type', 'Down Home');
      showToast('Business Type: Down Home', 'ğŸ ');
      break;

    case 'e':
      e.preventDefault();
      updateField('Business Type', 'EM.co');
      showToast('Business Type: EM.co', 'ğŸš€');
      break;

    case 'p':
      e.preventDefault();
      updateField('Business Type', 'Personal');
      showToast('Business Type: Personal', 'ğŸ‘¤');
      break;

    case 'x':
      e.preventDefault();
      if (confirm('Detach receipt from this transaction?')) {
        detachReceipt();
      }
      break;

    case 'enter':
      e.preventDefault();
      openQuickViewer(selectedRow);
      break;

    case 'a':
      e.preventDefault();
      aiMatch();
      break;

    case 'j':
      e.preventDefault();
      aiNote();
      break;

    case 'q':
      e.preventDefault();
      openQuickViewer();
      showToast('Quick Viewer Opened', 'âš¡');
      break;

    case 'f':
      e.preventDefault();
      openMissingReceiptModal();
      break;

    case 'r':
      e.preventDefault();
      addToReportAndGo();
      break;
  }
});

// Add current transaction to report and navigate to reports page
async function addToReportAndGo() {
  if (!selectedRow) {
    showToast('No transaction selected', 'âš ï¸');
    return;
  }

  // Mark as good if not already marked
  if (selectedRow['Review Status'] !== 'good') {
    await updateField('Review Status', 'good');
  }

  // Store transaction info for report builder
  const reportItem = {
    _index: selectedRow._index,
    merchant: selectedRow['MI Merchant'] || selectedRow['Chase Description'],
    amount: parseFloat(selectedRow['Chase Amount']),
    date: selectedRow['Chase Date'],
    category: selectedRow['MI Category'] || selectedRow['Chase Category'],
    business: selectedRow['Business Type'],
    receipt_url: selectedRow['R2 URL'] || selectedRow['Receipt File'],
    ai_note: selectedRow['AI Note'] || selectedRow['Notes'] || ''
  };

  // Get or create pending report items in localStorage
  let pendingItems = JSON.parse(localStorage.getItem('tallyups_pending_report_items') || '[]');

  // Check if already added
  if (!pendingItems.find(item => item._index === reportItem._index)) {
    pendingItems.push(reportItem);
    localStorage.setItem('tallyups_pending_report_items', JSON.stringify(pendingItems));
    showToast(`Added to report (${pendingItems.length} items)`, 'ğŸ“‹');
  } else {
    showToast('Already in report', 'â„¹ï¸');
  }

  // Navigate to reports page
  setTimeout(() => {
    window.location.href = '/reports';
  }, 500);
}

// Navigate table rows with arrow keys
function navigateTable(direction) {
  const currentIndex = filteredData.findIndex(row => row._index === selectedRow._index);
  if (currentIndex === -1) return;

  const newIndex = currentIndex + direction;

  if (newIndex >= 0 && newIndex < filteredData.length) {
    selectRow(filteredData[newIndex]);

    // Scroll selected row into view
    const selectedTr = document.querySelector('tr.selected');
    if (selectedTr) {
      selectedTr.scrollIntoView({ block: 'center', behavior: 'smooth' });
    }
  }
}


// Modals
function toggleHotkeyMenu() {
  const modal = document.getElementById('hotkey-modal');
  modal.classList.toggle('active');
}

function toggleSettings() {
  const modal = document.getElementById('settings-modal');
  modal.classList.toggle('active');

  // Update all settings info when opening
  if (modal.classList.contains('active')) {
    updateSettingsInfo();
    checkGmailStatus();
    checkSystemHealth();
  }
}

// Update settings info with live data
async function updateSettingsInfo() {
  // Update transaction count
  const transactionCount = DATA ? DATA.length : 0;
  const countEl = document.getElementById('transaction-count-setting');
  if (countEl) {
    countEl.textContent = transactionCount.toLocaleString() + ' transactions';
  }

  // Check calendar status when settings open
  checkCalendarStatus();
}

// Calendar settings state
let calendarSettings = {
  enabled_calendars: [] // List of enabled calendar emails
};

// Check calendar connection status and load settings
async function checkCalendarStatus() {
  const statusEl = document.getElementById('calendar-connection-status');
  const detailEl = document.getElementById('calendar-status-detail');
  const accountsList = document.getElementById('calendar-accounts-list');

  if (statusEl) statusEl.textContent = 'Checking...';
  if (detailEl) detailEl.textContent = 'Connecting to calendar service...';

  try {
    const res = await fetch('/settings/calendar/status');
    const data = await res.json();

    if (!data.connected) {
      if (statusEl) {
        statusEl.textContent = 'âŒ Not Connected';
        statusEl.style.color = '#ff4e6a';
      }
      if (detailEl) detailEl.textContent = data.message || 'Calendar not configured';
      if (accountsList) accountsList.style.display = 'none';
      return;
    }

    // Connected - show account count
    const accountCount = data.account_count || 1;
    if (statusEl) {
      statusEl.textContent = `âœ… ${accountCount} Calendar${accountCount > 1 ? 's' : ''} Connected`;
      statusEl.style.color = '#00ff88';
    }
    if (detailEl) detailEl.textContent = data.message || `${accountCount} account(s) linked`;

    // Populate calendar list with checkboxes
    if (accountsList && data.accounts && data.accounts.length > 0) {
      accountsList.style.display = 'block';
      accountsList.innerHTML = '<div style="font-size:12px;color:var(--muted);margin-bottom:8px">Select which calendars to use for context:</div>';

      // Load saved settings
      await loadCalendarSettings();

      data.accounts.forEach(account => {
        const isEnabled = calendarSettings.enabled_calendars.length === 0 ||
                         calendarSettings.enabled_calendars.includes(account.email);

        const row = document.createElement('div');
        row.className = 'settings-row';
        row.style.padding = '10px 12px';
        row.style.background = isEnabled ? 'rgba(0,255,136,.08)' : 'transparent';
        row.style.borderRadius = '8px';
        row.style.marginBottom = '6px';
        row.style.transition = 'background .2s';

        row.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;flex:1">
            <input type="checkbox"
                   id="cal-${account.email.replace(/[@.]/g, '-')}"
                   ${isEnabled ? 'checked' : ''}
                   onchange="toggleCalendar('${account.email}', this.checked)"
                   style="width:18px;height:18px;accent-color:#00ff88;cursor:pointer">
            <div>
              <div style="font-size:13px;font-weight:500;color:var(--ink)">${account.name || account.email}</div>
              <div style="font-size:11px;color:var(--muted)">${account.email}</div>
            </div>
          </div>
          <span class="badge ${account.connected ? 'badge-good' : 'badge-bad'}">${account.connected ? 'Active' : 'Error'}</span>
        `;

        accountsList.appendChild(row);
      });

      // Add save button
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn-primary';
      saveBtn.style.marginTop = '12px';
      saveBtn.style.width = '100%';
      saveBtn.innerHTML = 'ğŸ’¾ Save Calendar Settings';
      saveBtn.onclick = saveCalendarSettings;
      accountsList.appendChild(saveBtn);
    }

  } catch (err) {
    console.error('Calendar status check failed:', err);
    if (statusEl) {
      statusEl.textContent = 'âš ï¸ Error';
      statusEl.style.color = '#ffd85e';
    }
    if (detailEl) detailEl.textContent = 'Could not check calendar status';
  }
}

// Load saved calendar settings
async function loadCalendarSettings() {
  try {
    const res = await fetch('/settings/calendar/preferences');
    if (res.ok) {
      const data = await res.json();
      if (data.enabled_calendars) {
        calendarSettings.enabled_calendars = data.enabled_calendars;
      }
    }
  } catch (err) {
    console.log('No saved calendar settings found, using defaults');
  }
}

// Toggle calendar enabled state
function toggleCalendar(email, enabled) {
  const row = document.getElementById(`cal-${email.replace(/[@.]/g, '-')}`).closest('.settings-row');
  if (row) {
    row.style.background = enabled ? 'rgba(0,255,136,.08)' : 'transparent';
  }

  if (enabled) {
    if (!calendarSettings.enabled_calendars.includes(email)) {
      calendarSettings.enabled_calendars.push(email);
    }
  } else {
    calendarSettings.enabled_calendars = calendarSettings.enabled_calendars.filter(e => e !== email);
  }
}

// Save calendar settings
async function saveCalendarSettings() {
  // Get all checked calendars
  const checkboxes = document.querySelectorAll('#calendar-accounts-list input[type="checkbox"]');
  const enabledCalendars = [];

  checkboxes.forEach(cb => {
    if (cb.checked) {
      // Extract email from id (cal-email-domain-com -> email@domain.com)
      const idParts = cb.id.replace('cal-', '').split('-');
      // Reconstruct email (last part after last dash is domain)
      const email = cb.id.replace('cal-', '').replace(/-/g, function(match, offset, str) {
        // Count dashes - replace all but the one before domain
        const remaining = str.substring(offset + 1);
        if (remaining.includes('-')) return '.';
        return '@';
      });
      enabledCalendars.push(email);
    }
  });

  try {
    const res = await fetch('/settings/calendar/preferences', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ enabled_calendars: enabledCalendars })
    });

    if (res.ok) {
      showToast('Calendar settings saved!', 'success');
      calendarSettings.enabled_calendars = enabledCalendars;
    } else {
      showToast('Failed to save settings', 'error');
    }
  } catch (err) {
    console.error('Save calendar settings failed:', err);
    showToast('Error saving settings', 'error');
  }
}

// Store last health data for details panel
let lastHealthData = null;

// Check all system services
async function checkSystemHealth() {
  const btn = document.getElementById('health-check-btn');
  if (btn) btn.innerHTML = 'â³ Checking...';

  // Show checking state on all cards
  const elements = ['db-status', 'r2-status', 'ai-status', 'gmail-health-status'];
  elements.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = '<span style="color:#fbbf24">...</span>';
  });

  try {
    const response = await fetch('/api/health');
    if (!response.ok) throw new Error('Health check failed');

    const health = await response.json();
    lastHealthData = health;

    // Update timestamp
    const timestamp = document.getElementById('health-timestamp');
    if (timestamp && health.timestamp) {
      const date = new Date(health.timestamp);
      timestamp.textContent = `Last checked: ${date.toLocaleTimeString()}`;
    }

    // Update overall health indicator
    const healthTitle = document.getElementById('health-title');
    const services = health.services || {};
    const allGood = services.database?.status === 'connected' &&
                   services.r2_storage?.status === 'connected' &&
                   services.gemini_ai?.status === 'configured';

    if (healthTitle) {
      healthTitle.innerHTML = allGood ? 'ğŸŸ¢ System Health' : 'ğŸŸ¡ System Health';
    }

    // Database status
    const dbStatus = document.getElementById('db-status');
    const dbIcon = document.getElementById('db-icon');
    const dbLatency = document.getElementById('db-latency');
    const dbTypeDesc = document.getElementById('db-type-desc');

    if (services.database) {
      const db = services.database;
      if (db.status === 'connected') {
        if (dbIcon) dbIcon.textContent = 'âœ…';
        if (dbStatus) dbStatus.innerHTML = `<span style="color:#00ff88">${db.type?.toUpperCase() || 'OK'}</span>`;
        if (dbLatency) dbLatency.textContent = `${db.response_ms || '--'}ms`;
        if (dbTypeDesc) dbTypeDesc.textContent = db.type === 'mysql' ? 'MySQL on Railway' : 'SQLite - receipts.db';
      } else {
        if (dbIcon) dbIcon.textContent = 'âŒ';
        if (dbStatus) dbStatus.innerHTML = '<span style="color:#ef4444">Error</span>';
        if (dbLatency) dbLatency.textContent = db.error ? 'Failed' : '--';
      }

      // Update receipt stats
      if (db.receipts) {
        const statTotal = document.getElementById('stat-total');
        const statReceipts = document.getElementById('stat-receipts');
        const statMissing = document.getElementById('stat-missing');
        const total = db.receipts.total || 0;
        const withReceipts = db.receipts.with_receipts || 0;
        const missing = total - withReceipts - (db.receipts.deleted || 0);

        if (statTotal) statTotal.textContent = total.toLocaleString();
        if (statReceipts) statReceipts.textContent = withReceipts.toLocaleString();
        if (statMissing) {
          statMissing.textContent = missing.toLocaleString();
          statMissing.style.color = missing > 0 ? '#fbbf24' : '#00ff88';
        }
      }
    }

    // R2 Storage status
    const r2Status = document.getElementById('r2-status');
    const r2Icon = document.getElementById('r2-icon');
    const r2Bucket = document.getElementById('r2-bucket');

    if (services.r2_storage) {
      const r2 = services.r2_storage;
      if (r2.status === 'connected') {
        if (r2Icon) r2Icon.textContent = 'âœ…';
        if (r2Status) r2Status.innerHTML = '<span style="color:#00ff88">Connected</span>';
        if (r2Bucket) r2Bucket.textContent = r2.bucket || 'receipts';
      } else {
        if (r2Icon) r2Icon.textContent = 'âš ï¸';
        if (r2Status) r2Status.innerHTML = '<span style="color:#fbbf24">Not Set</span>';
        if (r2Bucket) r2Bucket.textContent = 'configure';
      }
    }

    // Gemini AI status
    const aiStatus = document.getElementById('ai-status');
    const aiIcon = document.getElementById('ai-icon');
    const aiAccuracy = document.getElementById('ai-accuracy');
    const geminiBadge = document.getElementById('gemini-badge');

    if (services.gemini_ai) {
      const ai = services.gemini_ai;
      if (ai.status === 'configured') {
        if (aiIcon) aiIcon.textContent = 'âœ…';
        if (aiStatus) aiStatus.innerHTML = '<span style="color:#00ff88">Ready</span>';
        if (aiAccuracy) aiAccuracy.textContent = services.ocr?.accuracy || '99%+';
        if (geminiBadge) geminiBadge.className = 'badge badge-good';
      } else {
        if (aiIcon) aiIcon.textContent = 'âš ï¸';
        if (aiStatus) aiStatus.innerHTML = '<span style="color:#fbbf24">No Key</span>';
        if (aiAccuracy) aiAccuracy.textContent = 'Donut fallback';
        if (geminiBadge) geminiBadge.className = 'badge badge-neutral';
      }
    }

    // Gmail status
    const gmailHealthStatus = document.getElementById('gmail-health-status');
    const gmailIcon = document.getElementById('gmail-icon');
    const gmailSummary = document.getElementById('gmail-accounts-summary');

    if (services.gmail) {
      const gmail = services.gmail;
      const connected = gmail.connected_count || 0;
      const total = gmail.accounts?.length || 3;

      if (gmailHealthStatus) {
        gmailHealthStatus.innerHTML = `<span style="color:${connected > 0 ? '#00ff88' : '#fbbf24'}">${connected}/${total}</span>`;
      }
      if (gmailIcon) gmailIcon.textContent = connected === total ? 'âœ…' : connected > 0 ? 'ğŸ“§' : 'âš ï¸';
      if (gmailSummary) gmailSummary.textContent = connected === total ? 'all connected' : 'accounts';
    }

    if (btn) btn.innerHTML = 'ğŸ”„ Check All Services';
    showToast('System health check complete', 'success');

  } catch (error) {
    console.error('Health check error:', error);
    if (btn) btn.innerHTML = 'ğŸ”„ Check All Services';

    // Show error state
    const dbStatus = document.getElementById('db-status');
    if (dbStatus) dbStatus.innerHTML = '<span style="color:#ef4444">Offline</span>';

    showToast('Health check failed: ' + error.message, 'error');
  }
}

// Toggle health details panel
function toggleHealthDetails(service) {
  const panel = document.getElementById('health-details-panel');
  const title = document.getElementById('health-details-title');
  const content = document.getElementById('health-details-content');

  if (!lastHealthData || !lastHealthData.services) {
    showToast('Run health check first', 'info');
    return;
  }

  // If already showing this service, close it
  if (panel.style.display !== 'none' && panel.dataset.service === service) {
    panel.style.display = 'none';
    return;
  }

  panel.dataset.service = service;
  const services = lastHealthData.services;

  let html = '';
  switch (service) {
    case 'db':
      const db = services.database || {};
      title.textContent = 'ğŸ’¾ Database Details';
      html = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div><strong>Type:</strong> ${db.type || 'Unknown'}</div>
          <div><strong>Host:</strong> ${db.host || 'Local'}</div>
          <div><strong>Status:</strong> ${db.status || 'Unknown'}</div>
          <div><strong>Latency:</strong> ${db.response_ms || '--'}ms</div>
          ${db.transaction_count ? `<div><strong>Transactions:</strong> ${db.transaction_count.toLocaleString()}</div>` : ''}
          ${db.receipts ? `<div><strong>With Receipts:</strong> ${db.receipts.with_receipts?.toLocaleString() || 0}</div>` : ''}
        </div>
        ${db.error ? `<div style="color:#ef4444;margin-top:8px">Error: ${db.error}</div>` : ''}
      `;
      break;

    case 'r2':
      const r2 = services.r2_storage || {};
      title.textContent = 'â˜ï¸ R2 Storage Details';
      html = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div><strong>Status:</strong> ${r2.status || 'Unknown'}</div>
          <div><strong>Bucket:</strong> ${r2.bucket || 'Not set'}</div>
          ${r2.endpoint ? `<div><strong>Account:</strong> ${r2.endpoint}</div>` : ''}
        </div>
        <div style="margin-top:8px;font-size:11px;color:var(--muted)">
          Receipt images are stored in Cloudflare R2 for fast global access.
        </div>
      `;
      break;

    case 'ai':
      const ai = services.gemini_ai || {};
      const ocr = services.ocr || {};
      title.textContent = 'ğŸ¤– AI & OCR Details';
      html = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div><strong>Gemini:</strong> ${ai.status || 'Unknown'}</div>
          <div><strong>OCR Provider:</strong> ${ocr.provider || 'Unknown'}</div>
          <div><strong>Accuracy:</strong> ${ocr.accuracy || 'Unknown'}</div>
          ${ai.key_prefix ? `<div><strong>API Key:</strong> ${ai.key_prefix}</div>` : ''}
        </div>
        <div style="margin-top:8px;font-size:11px;color:var(--muted)">
          Gemini Vision extracts merchant, date, and amount from receipt images.
        </div>
      `;
      break;

    case 'gmail':
      const gmail = services.gmail || {};
      title.textContent = 'ğŸ“§ Gmail Integration';
      html = '<div style="display:flex;flex-direction:column;gap:6px">';
      if (gmail.accounts && gmail.accounts.length > 0) {
        gmail.accounts.forEach(acc => {
          const statusColor = acc.connected ? '#00ff88' : '#fbbf24';
          const statusText = acc.connected ? 'Connected' : 'Not connected';
          html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border)">
              <span>${acc.email}</span>
              <span style="color:${statusColor};font-size:11px">${statusText}</span>
            </div>
          `;
        });
      } else {
        html += '<div>No Gmail accounts configured</div>';
      }
      html += '</div>';
      html += `<div style="margin-top:8px;font-size:11px;color:var(--muted)">
        Gmail integration searches your inbox for receipt attachments.
      </div>`;
      break;
  }

  content.innerHTML = html;
  panel.style.display = 'block';
}

function closeHealthDetails() {
  const panel = document.getElementById('health-details-panel');
  panel.style.display = 'none';
}

// Manual Entry Modal
function openManualEntryModal() {
  const modal = document.getElementById('manual-entry-modal');
  modal.classList.add('active');

  // Set today's date as default
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('manual-date').value = today;

  // Reset form
  document.getElementById('manual-entry-form').reset();
  document.getElementById('manual-date').value = today; // Re-set after reset
}

function closeManualEntryModal() {
  const modal = document.getElementById('manual-entry-modal');
  modal.classList.remove('active');
  document.getElementById('manual-entry-form').reset();

  // Reset OCR zone
  const dropZone = document.getElementById('ocr-drop-zone');
  dropZone.classList.remove('processing');
  document.getElementById('ocr-status').classList.remove('show', 'success', 'error');
  document.getElementById('ocr-preview').classList.remove('show');

  // Reset the stored receipt filename
  lastOCRReceiptFilename = null;
}

// ========================================================================
// MISSING RECEIPT FORM MODAL
// ========================================================================

function openMissingReceiptModal() {
  if (!selectedRow) {
    showToast('Select a transaction first', 'âš ï¸');
    return;
  }

  // Check if transaction already has a receipt
  const hasReceipt = selectedRow['Receipt File'] || selectedRow['receipt_file'];
  if (hasReceipt) {
    if (!confirm('This transaction already has a receipt attached. Generate a Missing Receipt Form anyway?')) {
      return;
    }
  }

  const modal = document.getElementById('missing-receipt-modal');
  modal.classList.add('active');

  // Populate transaction details
  const merchant = selectedRow['mi_merchant'] || selectedRow['MI Merchant'] || selectedRow['Chase Description'] || selectedRow['chase_description'] || 'Unknown';
  const amount = parseFloat(selectedRow['Chase Amount'] || selectedRow['chase_amount'] || 0);
  const date = selectedRow['Chase Date'] || selectedRow['chase_date'] || '';

  document.getElementById('mrf-merchant').textContent = merchant;
  document.getElementById('mrf-amount').textContent = `$${Math.abs(amount).toFixed(2)}`;

  // Format date
  if (date) {
    try {
      const d = new Date(date);
      document.getElementById('mrf-date').textContent = d.toLocaleDateString('en-US');
    } catch {
      document.getElementById('mrf-date').textContent = date;
    }
  }

  // Pre-select company based on Business Type
  const bizType = (selectedRow['Business Type'] || selectedRow['business_type'] || '').toLowerCase();
  const companySelect = document.getElementById('mrf-company');
  if (bizType.includes('music') || bizType.includes('mcr') || bizType.includes('rodeo')) {
    companySelect.value = 'mcr';
  } else {
    companySelect.value = 'downhome';
  }

  // Reset form fields
  document.getElementById('mrf-reason-select').value = '';
  document.getElementById('mrf-reason').value = '';
  document.getElementById('mrf-is-meal').checked = false;
  document.getElementById('mrf-meal-section').style.display = 'none';
  document.getElementById('mrf-attendees').value = '';
  document.getElementById('mrf-purpose').value = '';

  // Check if this looks like a meal expense (restaurant/dining category)
  const category = (selectedRow['mi_category'] || selectedRow['MI Category'] || selectedRow['Category'] || '').toLowerCase();
  if (category.includes('restaurant') || category.includes('dining') || category.includes('food') || category.includes('meal')) {
    document.getElementById('mrf-is-meal').checked = true;
    toggleMealSection();
  }
}

function closeMissingReceiptModal() {
  const modal = document.getElementById('missing-receipt-modal');
  modal.classList.remove('active');
}

function updateReasonField() {
  const select = document.getElementById('mrf-reason-select');
  const input = document.getElementById('mrf-reason');

  if (select.value === 'custom') {
    input.value = '';
    input.focus();
  } else if (select.value) {
    input.value = select.value;
  }
}

function toggleMealSection() {
  const checkbox = document.getElementById('mrf-is-meal');
  const section = document.getElementById('mrf-meal-section');
  section.style.display = checkbox.checked ? 'block' : 'none';
}

async function submitMissingReceiptForm() {
  if (!selectedRow) {
    showToast('No transaction selected', 'âŒ');
    return;
  }

  const reason = document.getElementById('mrf-reason').value.trim();
  if (!reason) {
    showToast('Please enter a reason', 'âš ï¸');
    document.getElementById('mrf-reason').focus();
    return;
  }

  const company = document.getElementById('mrf-company').value;
  const isMeal = document.getElementById('mrf-is-meal').checked;
  const attendees = isMeal ? document.getElementById('mrf-attendees').value.trim() : '';
  const purpose = isMeal ? document.getElementById('mrf-purpose').value.trim() : '';

  showToast('Generating Missing Receipt Form...', 'ğŸ“');

  try {
    const response = await fetch('/generate_missing_receipt_form', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        _index: selectedRow._index,
        reason: reason,
        company: company,
        meal_attendees: attendees,
        meal_purpose: purpose
      })
    });

    const result = await response.json();

    if (result.ok) {
      // Update local data
      selectedRow['Receipt File'] = result.filename;
      selectedRow['receipt_file'] = result.filename;
      selectedRow['Review Status'] = 'good';
      selectedRow['Notes'] = `Missing Receipt Form - ${reason}`;

      // Refresh UI
      renderTable();
      updateDashboard();
      loadReceipt();

      closeMissingReceiptModal();
      showToast(`Missing Receipt Form generated!`, 'âœ…');
    } else {
      showToast(`Error: ${result.error}`, 'âŒ');
    }
  } catch (error) {
    console.error('Error generating form:', error);
    showToast(`Failed to generate form: ${error.message}`, 'âŒ');
  }
}

// OCR Drag & Drop Functionality
function initOCRDropZone() {
  const dropZone = document.getElementById('ocr-drop-zone');
  const fileInput = document.getElementById('ocr-file-input');
  const preview = document.getElementById('ocr-preview');
  const status = document.getElementById('ocr-status');

  // Click to upload
  dropZone.addEventListener('click', (e) => {
    if (e.target === dropZone || e.target.closest('.ocr-drop-icon, .ocr-drop-text, .ocr-drop-hint')) {
      fileInput.click();
    }
  });

  // File input change
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      processReceiptImage(e.target.files[0]);
    }
  });

  // Drag and drop events
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');

    const file = e.dataTransfer.files[0];
    if (file && (file.type.startsWith('image/') || file.type === 'application/pdf')) {
      processReceiptImage(file);
    } else {
      showOCRStatus('Please drop an image or PDF file', 'error');
    }
  });
}

// Store the receipt filename and R2 URL from OCR for use in submitManualEntry
let lastOCRReceiptFilename = null;
let lastOCRReceiptR2Url = null;

async function processReceiptImage(file) {
  const dropZone = document.getElementById('ocr-drop-zone');
  const preview = document.getElementById('ocr-preview');
  const status = document.getElementById('ocr-status');

  // Reset stored filename and R2 URL
  lastOCRReceiptFilename = null;
  lastOCRReceiptR2Url = null;

  // Show preview
  const reader = new FileReader();
  reader.onload = (e) => {
    preview.src = e.target.result;
    preview.classList.add('show');
  };
  reader.readAsDataURL(file);

  // Show processing state
  dropZone.classList.add('processing');
  showOCRStatus('ğŸ” Processing receipt with AI...', 'processing');

  try {
    // Upload to OCR API
    const formData = new FormData();
    formData.append('file', file);

    const response = await fetch('/api/ocr/process', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    if (result.success) {
      // Auto-fill form fields
      if (result.merchant) {
        document.getElementById('manual-merchant').value = result.merchant;
      }

      if (result.date) {
        document.getElementById('manual-date').value = result.date;
      }

      if (result.total) {
        document.getElementById('manual-amount').value = result.total;
      }

      // IMPORTANT: Store the filename and R2 URL for later use when submitting the form
      if (result.filename) {
        lastOCRReceiptFilename = result.filename;
        console.log('Receipt saved as:', result.filename);
      }
      // Store R2 URL (check both field names for compatibility)
      if (result.receipt_url || result.r2_url) {
        lastOCRReceiptR2Url = result.receipt_url || result.r2_url;
        console.log('Receipt uploaded to R2:', lastOCRReceiptR2Url);
      }

      // Show success with confidence
      const confidence = Math.round(result.confidence * 100);
      const engines = result.engines_used ? result.engines_used.join(', ') : 'OCR';
      const uploadedTo = (result.receipt_url || result.r2_url) ? 'â˜ï¸' : 'ğŸ’¾';
      showOCRStatus(
        `${uploadedTo} Extracted! ${result.filename || 'N/A'} (${confidence}%)`,
        'success'
      );
    } else {
      showOCRStatus(`âŒ ${result.error || 'Failed to process receipt'}`, 'error');
    }
  } catch (error) {
    console.error('OCR Error:', error);
    showOCRStatus('âŒ Failed to connect to OCR service', 'error');
  } finally {
    dropZone.classList.remove('processing');
  }
}

function showOCRStatus(message, type) {
  const status = document.getElementById('ocr-status');
  status.textContent = message;
  status.className = 'ocr-status show';
  if (type) {
    status.classList.add(type);
  }
}

// Initialize OCR when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  initOCRDropZone();
});

function updateCategoryOptions() {
  const businessType = document.getElementById('manual-business-type').value;
  const categorySelect = document.getElementById('manual-category');

  // Define categories by business type (placeholder - user will provide actual categories)
  const categories = {
    'Music City Rodeo': [
      'Artist Management',
      'Event Production',
      'Marketing & Advertising',
      'Venue Rental',
      'Equipment',
      'Travel & Lodging',
      'Meals & Entertainment',
      'Professional Services',
      'Other'
    ],
    'Down Home': [
      'Artist Development',
      'Recording & Production',
      'Marketing & PR',
      'Touring & Live Events',
      'Merchandising',
      'Professional Services',
      'Meals & Entertainment',
      'Travel',
      'Other'
    ],
    'Personal': [
      'Business Meals',
      'Travel',
      'Office Supplies',
      'Professional Development',
      'Subscriptions',
      'Other'
    ]
  };

  // Clear and repopulate
  categorySelect.innerHTML = '<option value="">Select Category (optional)</option>';

  if (businessType && categories[businessType]) {
    categories[businessType].forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    });
  }
}

async function submitManualEntry(event) {
  event.preventDefault();

  const date = document.getElementById('manual-date').value;
  const merchant = document.getElementById('manual-merchant').value;
  const amount = parseFloat(document.getElementById('manual-amount').value);
  const businessType = document.getElementById('manual-business-type').value;
  const category = document.getElementById('manual-category').value;
  const notes = document.getElementById('manual-notes').value;

  if (!date || !merchant || !amount || !businessType) {
    showToast('Please fill in all required fields', 'âš ï¸');
    return;
  }

  showToast('Adding manual entry...', 'âœï¸');

  try {
    // Build request body, including receipt_file if we have one from OCR
    const requestBody = {
      date,
      merchant,
      amount,
      business_type: businessType,
      category,
      notes
    };

    // Include the receipt file and R2 URL from OCR if available
    if (lastOCRReceiptFilename) {
      requestBody.receipt_file = lastOCRReceiptFilename;
      console.log('Including receipt file:', lastOCRReceiptFilename);
    }
    if (lastOCRReceiptR2Url) {
      requestBody.r2_url = lastOCRReceiptR2Url;
      console.log('Including R2 URL:', lastOCRReceiptR2Url);
    }

    const res = await fetch('/add_manual_expense', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(requestBody)
    });

    const data = await res.json();

    if (data.ok) {
      // Add to local data
      csvData.push(data.expense);
      filteredData = [...csvData];

      // Refresh table and dashboard
      renderTable();
      updateDashboard();

      // Close modal
      closeManualEntryModal();

      showToast('Manual expense added successfully!', 'âœ…');
    } else {
      showToast('Failed to add expense: ' + (data.error || 'Unknown error'), 'âŒ');
    }
  } catch (e) {
    showToast('Failed to add expense: ' + e.message, 'âŒ');
  }
}

// Close modal on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const modal = document.getElementById('manual-entry-modal');
    if (modal.classList.contains('active')) {
      closeManualEntryModal();
    }
  }
});

// Theme - Legendary Design System compatible
function toggleTheme() {
  const html = document.documentElement;
  const isLight = html.getAttribute('data-theme') === 'light';
  const newTheme = isLight ? 'dark' : 'light';

  html.setAttribute('data-theme', newTheme);
  document.body.classList.toggle('light', newTheme === 'light');
  localStorage.setItem('theme', newTheme);
  showToast('Theme: ' + newTheme, 'ğŸ¨');
}

function loadTheme() {
  // Default to dark mode for legendary design
  const savedTheme = localStorage.getItem('theme');
  // Only apply light if explicitly saved as light, otherwise stay dark
  if (savedTheme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.body.classList.add('light');
  } else {
    // Ensure dark mode is set
    document.documentElement.setAttribute('data-theme', 'dark');
    document.body.classList.remove('light');
    localStorage.setItem('theme', 'dark');
  }
}

// Logout
function logout() {
  if (confirm('Are you sure you want to logout?')) {
    window.location.href = '/logout';
  }
}

// Filters
function applyFilters() {
  let filtered = [...csvData];

  const activeFilter = document.querySelector('.chip[data-filter].active');
  if (activeFilter) {
    const filter = activeFilter.dataset.filter;
    if (filter === 'needs-review') {
      // Show items that haven't been reviewed yet (empty status or not finalized)
      // âœ… MUST have a receipt to be reviewed - no receipt = missing receipts
      filtered = filtered.filter(r => {
        const status = (r['Review Status'] || '').toLowerCase().trim();
        const receiptFile = (r['Receipt File'] || '').trim();
        const receiptUrl = (r.receipt_url || '').trim();
        const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
        const hasReceipt = receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
        return hasReceipt && (!status || (status !== 'good' && status !== 'bad' && status !== 'not needed'));
      });
    }
    else if (filter === 'good') {
      // âœ… MUST have a receipt to be marked good - no receipt = missing receipts
      filtered = filtered.filter(r => {
        const receiptFile = (r['Receipt File'] || '').trim();
        const receiptUrl = (r.receipt_url || '').trim();
        const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
        const hasReceipt = receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
        return hasReceipt && r['Review Status'] === 'good';
      });
    }
    else if (filter === 'bad') {
      // âœ… MUST have a receipt to be marked bad - no receipt = missing receipts
      filtered = filtered.filter(r => {
        const receiptFile = (r['Receipt File'] || '').trim();
        const receiptUrl = (r.receipt_url || '').trim();
        const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
        const hasReceipt = receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
        return hasReceipt && r['Review Status'] === 'bad';
      });
    }
    else if (filter === 'missing') {
      // Missing = no receipt (file, url, or r2) OR status is 'needs_receipt'
      filtered = filtered.filter(r => {
        const receiptFile = (r['Receipt File'] || '').trim();
        const receiptUrl = (r.receipt_url || '').trim();
        const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
        const reviewStatus = (r['Review Status'] || '').toLowerCase().trim();
        const validationStatus = (r.receipt_validation_status || '').toLowerCase().trim();
        const hasReceipt = receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
        // Show if: no receipt and not marked 'not needed', OR validation status is 'needs_receipt'
        return (!hasReceipt && reviewStatus !== 'not needed') || validationStatus === 'needs_receipt';
      });
    }
    else if (filter === 'with-receipts') {
      // With receipts = has a receipt file, receipt_url, or r2_url
      filtered = filtered.filter(r => {
        const receiptFile = (r['Receipt File'] || '').trim();
        const receiptUrl = (r.receipt_url || '').trim();
        const r2Url = (r.r2_url || r['R2 URL'] || '').trim();
        return receiptFile !== '' || receiptUrl !== '' || r2Url !== '';
      });
    }
    else if (filter === 'not-needed') filtered = filtered.filter(r => r['Review Status'] === 'not needed');
    else if (filter === 'refunds') {
      // âœ… Refunds = negative amounts OR review_status = refund
      filtered = filtered.filter(r => {
        const amount = parseFloat(r['Chase Amount'] || r['Amount'] || 0);
        return amount < 0 || r['Review Status'] === 'refund';
      });
    }
    else if (filter === 'already-submitted') {
      // âœ… Already Submitted = expenses marked as already submitted
      filtered = filtered.filter(r => {
        const submitted = (r['Already Submitted'] || r.already_submitted || '').toLowerCase().trim();
        return submitted === 'yes' || submitted === '1' || submitted === 'true';
      });
    }
    // Receipt Validation Status filters (check both old and new OCR fields)
    else if (filter === 'receipt-verified') {
      filtered = filtered.filter(r => {
        const status = (r.ocr_verification_status || r.receipt_validation_status || '').toLowerCase().trim();
        // Include both 'verified' and 'subscription' as verified receipts
        return status === 'verified' || status === 'subscription';
      });
    }
    else if (filter === 'receipt-mismatch') {
      filtered = filtered.filter(r => {
        const status = (r.ocr_verification_status || r.receipt_validation_status || '').toLowerCase().trim();
        return status === 'mismatch';
      });
    }
    else if (filter === 'receipt-error') {
      filtered = filtered.filter(r => {
        const status = (r.ocr_verification_status || r.receipt_validation_status || '').toLowerCase().trim();
        return status === 'error' || status === 'unclear';
      });
    }
  }

  const activeBiz = document.querySelector('.chip[data-biz].active');
  if (activeBiz) {
    const bizType = activeBiz.dataset.biz;
    if (bizType === 'Unassigned') {
      // Show transactions with NULL, empty, or missing Business Type
      filtered = filtered.filter(r => {
        const bt = r['Business Type'] || r.business_type || '';
        return !bt || bt === '' || bt === 'None' || bt === null;
      });
    } else {
      // Check both 'Business Type' (CSV) and 'business_type' (DB) field names
      filtered = filtered.filter(r => {
        const bt = r['Business Type'] || r.business_type || '';
        return bt === bizType;
      });
    }
  }

  const activeConfidence = document.querySelector('.chip[data-confidence].active');
  if (activeConfidence) {
    const confLevel = activeConfidence.dataset.confidence;
    filtered = filtered.filter(r => {
      const conf = parseFloat(r['AI Confidence']) || 0;
      const hasReceipt = r['Receipt File'];

      if (confLevel === 'excellent') return hasReceipt && conf >= 90;
      if (confLevel === 'good-range') return hasReceipt && conf >= 70 && conf < 90;
      if (confLevel === 'needs-review') return hasReceipt && conf > 0 && conf < 70;
      if (confLevel === 'none') return hasReceipt && conf === 0;
      return true;
    });
  }

  const search = document.getElementById('search').value.toLowerCase().trim();
  if (search) {
    // Check if search is a number/amount (e.g., "22.44", "$22.44", "22")
    const searchAmount = parseFloat(search.replace(/[$,]/g, ''));
    const isAmountSearch = !isNaN(searchAmount) && /^[$]?[\d,]+\.?\d*$/.test(search.replace(/\s/g, ''));

    filtered = filtered.filter(r => {
      // Text search: check description and notes
      const textMatch =
        (r['Chase Description'] || '').toLowerCase().includes(search) ||
        (r['Notes'] || '').toLowerCase().includes(search);

      if (textMatch) return true;

      // Amount search: check if amount matches
      if (isAmountSearch) {
        const amount = parseFloat(r['Chase Amount'] || r['Amount'] || 0);
        const absAmount = Math.abs(amount);

        // Exact match (within 1 cent for floating point)
        if (Math.abs(absAmount - searchAmount) < 0.01) return true;

        // Also allow partial match for the amount string (e.g., "22" matches "22.50")
        const amountStr = absAmount.toFixed(2);
        if (amountStr.includes(search.replace(/[$,]/g, ''))) return true;
      }

      return false;
    });
  }

  filteredData = filtered;
  renderTable();
  updateDashboard();
}

// Event Listeners
function setupEventListeners() {
  // Filters - Toggle on/off behavior
  document.querySelectorAll('.chip[data-filter]').forEach(chip => {
    chip.addEventListener('click', () => {
      // If already active, deactivate (show all)
      if (chip.classList.contains('active')) {
        chip.classList.remove('active');
      } else {
        // Otherwise, activate this one and deactivate others
        document.querySelectorAll('.chip[data-filter]').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
      }
      applyFilters();
    });
  });

  // Business Type Filters - Toggle on/off behavior
  document.querySelectorAll('.chip[data-biz]').forEach(chip => {
    chip.addEventListener('click', () => {
      // If already active, deactivate (show all)
      if (chip.classList.contains('active')) {
        chip.classList.remove('active');
      } else {
        // Otherwise, activate this one and deactivate others
        document.querySelectorAll('.chip[data-biz]').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
      }
      applyFilters();
    });
  });

  document.getElementById('search').addEventListener('input', applyFilters);

  // Table sorting
  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.sort;
      if (sortColumn === col) {
        sortAsc = !sortAsc;
      } else {
        sortColumn = col;
        sortAsc = true;
      }

      filteredData.sort((a, b) => {
        let aVal = a[col] || '';
        let bVal = b[col] || '';
        if (col === 'Chase Amount') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        } else if (col === 'Chase Date' || col === 'chase_date') {
          // Parse dates properly for date sorting
          aVal = new Date(aVal).getTime() || 0;
          bVal = new Date(bVal).getTime() || 0;
        }
        return sortAsc ?
          (aVal > bVal ? 1 : -1) :
          (aVal < bVal ? 1 : -1);
      });

      renderTable();

      document.querySelectorAll('th').forEach(h => h.classList.remove('sorted', 'asc'));
      th.classList.add('sorted');
      if (sortAsc) th.classList.add('asc');
    });
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;

    const key = e.key.toLowerCase();

    if (key === 'escape') {
      closeQuickViewer();
      toggleHotkeyMenu();
      toggleSettings();
    } else if (key === '?') {
      e.preventDefault();
      toggleHotkeyMenu();
    } else if (key === 'q') {
      e.preventDefault();
      openQuickViewer();
    } else if (key === 'a') {
      e.preventDefault();
      aiMatch();
    } else if (key === 'j') {
      e.preventDefault();
      aiNote();
    } else if (key === 'x') {
      e.preventDefault();
      detachReceipt();
    } else if (key === 'g') {
      e.preventDefault();
      updateField('Review Status', 'good');
    } else if (key === 'b') {
      e.preventDefault();
      updateField('Review Status', 'bad');
    } else if (key === 'n') {
      e.preventDefault();
      updateField('Review Status', 'not needed');
    } else if (key === 'c') {
      e.preventDefault();
      updateField('Review Status', '');
    } else if (key === 'v') {
      e.preventDefault();
      markReceiptVerified();
    } else if (key === 'm') {
      e.preventDefault();
      updateField('Business Type', 'Music City Rodeo');
    } else if (key === 'd') {
      e.preventDefault();
      updateField('Business Type', 'Down Home');
    } else if (key === 'p') {
      e.preventDefault();
      updateField('Business Type', 'Personal');
    } else if (key === 'r' && !e.shiftKey) {
      e.preventDefault();
      toggleReportTrayAndAdd();
    } else if (key === 'r' && e.shiftKey) {
      e.preventDefault();
      rotateImage();
    } else if (key === '0') {
      e.preventDefault();
      resetZoom();
    } else if (key === '+' || key === '=') {
      e.preventDefault();
      zoomIn();
    } else if (key === '-') {
      e.preventDefault();
      zoomOut();
    } // âœ… FIX: Removed duplicate arrow key handlers (already handled at line ~2250)
    // else if (key === 'arrowup') {
    //   e.preventDefault();
    //   navigateRow(-1);
    // } else if (key === 'arrowdown') {
    //   e.preventDefault();
    //   navigateRow(1);
    // }
    else if (e.ctrlKey && key === 's') {
      e.preventDefault();
      saveCSV();
    }
    else if (e.ctrlKey && key === 'z') {
      e.preventDefault();
      undo();
    }
    else if (key === '/') {
      e.preventDefault();
      document.getElementById('search').focus();
    }
    else if (key === 'f' && !e.ctrlKey) {
      e.preventDefault();
      openMissingReceiptModal();
    }
    else if (key === 'arrowup') {
      e.preventDefault();
      navigateRow(-1);
    }
    else if (key === 'arrowdown') {
      e.preventDefault();
      navigateRow(1);
    }
  });
}

function navigateRow(delta) {
  if (!selectedRow || filteredData.length === 0) return;

  const idx = filteredData.findIndex(r => r._index === selectedRow._index);
  const newIdx = Math.max(0, Math.min(filteredData.length - 1, idx + delta));
  selectRow(filteredData[newIdx]);

  // Scroll into view
  const rows = document.querySelectorAll('#tbody tr');
  if (rows[newIdx]) {
    rows[newIdx].scrollIntoView({behavior: 'smooth', block: 'nearest'});
  }
}

// Drag & Drop
function setupDragDrop() {
  const viewer = document.getElementById('viewer-content');

  ['dragenter', 'dragover'].forEach(evt => {
    viewer.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      viewer.style.borderColor = 'var(--brand)';
    });
  });

  ['dragleave', 'drop'].forEach(evt => {
    viewer.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      viewer.style.borderColor = '';
    });
  });

  viewer.addEventListener('drop', async (e) => {
    const file = e.dataTransfer.files[0];
    if (!file || !(file.type.startsWith('image/') || file.type === 'application/pdf')) {
      return showToast('Please drop an image or PDF file', 'âš ï¸');
    }

    // If a row is selected, use upload method
    if (selectedRow) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('_index', selectedRow._index);

      try {
        showToast('Uploading receipt...', 'â±ï¸');
        const res = await fetch('/upload_receipt', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.ok) {
          selectedRow['Receipt File'] = data.filename;
          const r2Url = data.r2_url || data.receipt_url;
          if (r2Url) {
            selectedRow.r2_url = r2Url;
          }
          applyFilters();  // Re-filter to update counts
          loadReceipt();
          const cloudIcon = r2Url ? 'â˜ï¸' : 'ğŸ“';
          showToast(`${cloudIcon} Receipt attached`, 'âœ“');
        }
      } catch (e) {
        showToast('Upload failed: ' + e.message, 'âŒ');
      }
      return;
    }

    // No row selected - use smart upload with Gemini OCR + create new transaction
    const formData = new FormData();
    formData.append('file', file);

    try {
      showToast('ğŸ” Processing receipt with Gemini AI...', 'â±ï¸');

      // Try to match first
      const res = await fetch('/upload_receipt_auto', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      if (data.ok && data.matched && data.auto_attached) {
        // Success! Auto-matched and attached to existing transaction
        showToast(`âœ… ${data.message}`, 'âœ“');
        await loadData();

        const matchedRow = allRows.find(r => r._index === data.transaction._index);
        if (matchedRow) {
          selectRow(matchedRow);
        }
      } else if (data.ok && data.matched && !data.auto_attached) {
        // Found possible match but confidence too low
        showToast(`ğŸ¤” ${data.message}`, 'âš ï¸');

        const matchedRow = allRows.find(r => r._index === data.transaction._index);
        if (matchedRow) {
          selectRow(matchedRow);
        }
      } else {
        // No match found OR OCR failed - CREATE NEW TRANSACTION
        showToast('ğŸ†• Creating new transaction from receipt...', 'â±ï¸');

        // Re-upload to create new transaction
        const newFormData = new FormData();
        newFormData.append('file', file);

        const newRes = await fetch('/upload_receipt_new', {
          method: 'POST',
          body: newFormData
        });
        const newData = await newRes.json();

        if (newData.ok) {
          showToast(`âœ… ${newData.message}`, 'âœ“');
          await loadData();

          // Select the new transaction
          const newRow = allRows.find(r => r._index === newData.transaction._index);
          if (newRow) {
            selectRow(newRow);
          }
        } else {
          showToast(newData.message || 'Failed to create transaction', 'âŒ');
        }
      }

    } catch (e) {
      showToast('Upload failed: ' + e.message, 'âŒ');
    }
  });
}

// Resizable divider
function setupResizer() {
  const divider = document.getElementById('divider');
  const left = document.querySelector('.left');
  let isResizing = false;

  divider.addEventListener('mousedown', () => {
    isResizing = true;
    document.body.style.cursor = 'col-resize';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    const newWidth = (e.clientX / window.innerWidth) * 100;
    if (newWidth > 30 && newWidth < 80) {
      left.style.flex = `0 0 ${newWidth}%`;
    }
  });

  document.addEventListener('mouseup', () => {
    isResizing = false;
    document.body.style.cursor = '';
  });
}

// UI Helpers
function showStatus(state) {
  const el = document.getElementById('status');
  el.className = `status ${state}`;
  if (state === 'saved') {
    setTimeout(() => el.className = 'status', 2000);
  }
}

let toastTimeout = null;
function showToast(message, icon = 'âœ“', duration = 3000) {
  const toast = document.getElementById('toast');
  document.getElementById('toast-icon').textContent = icon;
  document.getElementById('toast-message').textContent = message;
  toast.classList.add('active');
  if (toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => toast.classList.remove('active'), duration);
}

// Loading overlay functions for batch operations
function showLoading(text = 'Processing...', progress = '') {
  document.getElementById('loading-text').textContent = text;
  document.getElementById('loading-progress').textContent = progress;
  document.getElementById('loading-overlay').classList.add('active');
}
function updateLoading(text, progress = '') {
  document.getElementById('loading-text').textContent = text;
  document.getElementById('loading-progress').textContent = progress;
}
function hideLoading() {
  document.getElementById('loading-overlay').classList.remove('active');
}

// Click outside to close modals
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('active');
    }
  });
});

// =============================================================================
// PAGE NAVIGATION
// =============================================================================

function switchPage(page) {
  // Special handling for Incoming page (separate HTML file)
  if (page === 'incoming') {
    window.location.href = '/incoming.html';
    return;
  }

  // Hide all pages
  document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');

  // Show selected page
  document.getElementById(`${page}-page`).style.display = 'block';

  // Update nav button styles
  document.querySelectorAll('[id^="nav-"]').forEach(btn => {
    btn.style.background = '';
    btn.style.color = '';
  });

  const activeBtn = document.getElementById(`nav-${page}`);
  activeBtn.style.background = 'var(--brand)';
  activeBtn.style.color = '#000';

  // Load data for Reports page
  if (page === 'reports') {
    loadArchivedReports();
    refreshDraftReports();
  }

  // Load data for Stats page
  if (page === 'stats') {
    loadStatsPage();
  }
}

// =============================================================================
// STATS PAGE
// =============================================================================

async function loadStatsPage() {
  console.log('ğŸ“Š Loading stats page...');

  // Show loading state for key containers
  const containerIds = ['stats-business-breakdown', 'stats-top-merchants', 'stats-top-categories', 'stats-subscriptions', 'stats-receipt-sources'];
  containerIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">Loading...</div>';
  });

  try {
    // Fetch fresh data from database
    let transactions = [];
    console.log('Fetching transactions from /api/transactions...');

    try {
      // Stats needs ALL transactions including already submitted ones
      const res = await fetch('/api/transactions?show_submitted=true', { credentials: 'same-origin' });
      console.log('Transactions response status:', res.status);

      if (res.ok) {
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          transactions = await res.json();
          console.log('Loaded', transactions.length, 'transactions from database');
        } else {
          console.log('Response is not JSON - likely redirected to login');
        }
      } else {
        console.log('Transaction fetch failed:', res.status);
      }
    } catch (e) {
      console.log('Could not fetch transaction data for stats:', e);
    }

    // If no data, show helpful message
    if (transactions.length === 0) {
      containerIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No transaction data available. Load the Transactions page first.</div>';
      });
      // Still render with empty data to show zeroes in the overview cards
      renderStats(calculateStats([], []));
      return;
    }

    // Also fetch incoming receipts for source info
    let receipts = [];
    try {
      const receiptsRes = await fetch('/api/incoming/receipts?status=all&limit=500', { credentials: 'same-origin' });
      if (receiptsRes.ok) {
        const receiptsData = await receiptsRes.json();
        receipts = receiptsData.receipts || [];
        console.log('Loaded', receipts.length, 'incoming receipts');
      }
    } catch (e) {
      console.log('Could not fetch receipts for stats');
    }

    // Calculate stats
    console.log('Calculating stats with', transactions.length, 'transactions');
    const stats = calculateStats(transactions, receipts);
    console.log('Stats calculated:', stats);

    // Update UI
    renderStats(stats);
    console.log('Stats rendered');
  } catch (e) {
    console.error('Error loading stats:', e);
    // Show error state
    containerIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = `<div style="color:#ff4e6a;text-align:center;padding:20px">Error loading data: ${e.message}</div>`;
    });
  }
}

function calculateStats(transactions, receipts) {
  const stats = {
    totalSpent: 0,
    totalCount: 0,
    receiptsMatched: 0,
    gmailReceipts: 0,
    totalReceipts: 0,  // Will be calculated from transactions with receipts
    refunds: { total: 0, count: 0 },
    payments: { total: 0, count: 0 },
    interest: 0,
    fees: 0,
    lateCharges: 0,
    byBusiness: {},
    byCategory: {},
    byMerchant: {},
    subscriptions: [],
    receiptSources: {}
  };

  // Track merchant frequencies for subscription detection
  const merchantCounts = {};

  transactions.forEach(t => {
    // Handle both prefixed (chase_) and unprefixed field names
    const amount = parseFloat(t.chase_amount || t.amount) || 0;
    const desc = (t.chase_description || t.description || '').toLowerCase();
    const merchant = t.mi_merchant || t.merchant || t.chase_description || t.description || 'Unknown';
    const category = t.chase_category || t.category || 'Uncategorized';
    const business = t.business_type || t['Business Type'] || 'Unassigned';

    // Count transactions with receipts
    if (t.receipt_file || t.receipt_url || t.receipt_path) {
      stats.receiptsMatched++;
    }

    // Transaction type detection using chase_type field and amount sign
    // In this database:
    //   - POSITIVE amounts = money OUT (expenses, interest, fees)
    //   - NEGATIVE amounts = money IN (payments, refunds, credits)
    //   - chase_type = 'Payment' = credit card payment
    const txnType = (t.chase_type || '').toLowerCase();
    const isInterest = desc.includes('interest') || category === 'Interest';
    const isFee = desc.includes('fee') && !desc.includes('coffee');
    const isLate = desc.includes('late') || desc.includes('penalty');

    // NEGATIVE amounts = money coming IN
    if (amount < 0) {
      if (txnType === 'payment' || desc.includes('payment thank you')) {
        // Credit card payment
        stats.payments.total += Math.abs(amount);
        stats.payments.count++;
      } else {
        // Refund/credit
        stats.refunds.total += Math.abs(amount);
        stats.refunds.count++;
      }
    }
    // POSITIVE amounts = money going OUT
    else if (isInterest) {
      stats.interest += amount;
      stats.totalSpent += amount;
      stats.totalCount++;
    } else if (isFee) {
      stats.fees += amount;
      stats.totalSpent += amount;
      stats.totalCount++;
    } else if (isLate) {
      stats.lateCharges += amount;
      stats.totalSpent += amount;
      stats.totalCount++;
    } else if (amount > 0) {
      // Regular expense
      stats.totalSpent += amount;
      stats.totalCount++;
    }

    // Track business, category, merchant for ALL positive amounts (expenses)
    const isSubmitted = (t.already_submitted || t['Already Submitted'] || '').toLowerCase() === 'yes';

    if (amount > 0) {
      // By business - track total AND submitted separately
      if (!stats.byBusiness[business]) {
        stats.byBusiness[business] = { total: 0, count: 0, submitted: 0, submittedCount: 0 };
      }
      stats.byBusiness[business].total += amount;
      stats.byBusiness[business].count++;
      if (isSubmitted) {
        stats.byBusiness[business].submitted += amount;
        stats.byBusiness[business].submittedCount++;
      }

      // By category
      if (!stats.byCategory[category]) {
        stats.byCategory[category] = { total: 0, count: 0 };
      }
      stats.byCategory[category].total += amount;
      stats.byCategory[category].count++;

      // By merchant
      if (!stats.byMerchant[merchant]) {
        stats.byMerchant[merchant] = { total: 0, count: 0 };
      }
      stats.byMerchant[merchant].total += amount;
      stats.byMerchant[merchant].count++;

      // Track for subscription detection
      if (!merchantCounts[merchant]) {
        merchantCounts[merchant] = { amounts: [], dates: [] };
      }
      merchantCounts[merchant].amounts.push(amount);
      merchantCounts[merchant].dates.push(t.chase_date || t.date);
    }
  });

  // Detect subscriptions (merchants with 3+ recurring charges OR known subscription services)
  const knownSubscriptions = ['apple', 'spotify', 'netflix', 'hulu', 'amazon prime', 'cursor', 'claude', 'midjourney', 'openai', 'chatgpt', 'expensify', 'cloudflare', 'adobe', 'microsoft', 'google one', 'icloud', 'dropbox', 'notion', 'slack', 'zoom', 'canva', 'figma', 'github', 'aws', 'digitalocean', 'heroku', 'vercel', 'anthropic', 'ada ai', 'hive', 'soho house'];

  Object.entries(merchantCounts).forEach(([merchant, data]) => {
    if (data.amounts.length >= 3) {
      const avgAmount = data.amounts.reduce((a, b) => a + b, 0) / data.amounts.length;
      const total = data.amounts.reduce((a, b) => a + b, 0);
      const merchantLower = merchant.toLowerCase();

      // Check if it's a known subscription OR has similar recurring amounts
      const isKnownSub = knownSubscriptions.some(sub => merchantLower.includes(sub));
      const allSimilar = data.amounts.every(a => Math.abs(a - avgAmount) / avgAmount < 0.15);

      // Include if: known subscription service OR recurring similar charges
      if (isKnownSub || (allSimilar && avgAmount > 5)) {
        stats.subscriptions.push({
          name: merchant,
          amount: avgAmount,
          total: total,
          count: data.amounts.length,
          isRecurring: allSimilar
        });
      }
    }
  });

  // Sort subscriptions by total spent
  stats.subscriptions.sort((a, b) => b.total - a.total);

  // Analyze receipt sources
  // Count matched receipts (transactions with receipt_file)
  transactions.forEach(t => {
    const receiptUrl = t.receipt_file || t.receipt_url || t.receipt_path || '';
    if (receiptUrl) {
      stats.totalReceipts++;
      if (!stats.receiptSources['Matched']) {
        stats.receiptSources['Matched'] = 0;
      }
      stats.receiptSources['Matched']++;
    }
  });

  // Count Gmail receipts from incoming_receipts (they have gmail_account field)
  if (receipts.length > 0) {
    receipts.forEach(r => {
      // incoming_receipts with gmail_account are from Gmail
      if (r.gmail_account || r.email_id) {
        stats.gmailReceipts++;
        if (!stats.receiptSources['Gmail (Incoming)']) {
          stats.receiptSources['Gmail (Incoming)'] = 0;
        }
        stats.receiptSources['Gmail (Incoming)']++;
      } else {
        if (!stats.receiptSources['Other Incoming']) {
          stats.receiptSources['Other Incoming'] = 0;
        }
        stats.receiptSources['Other Incoming']++;
      }
    });
  }

  // Count missing receipts (positive amount transactions without receipt)
  const missingCount = transactions.filter(t => {
    const amount = parseFloat(t.chase_amount || t.amount) || 0;
    const hasReceipt = t.receipt_file || t.receipt_url || t.receipt_path;
    return amount > 0 && !hasReceipt;
  }).length;

  if (missingCount > 0) {
    stats.receiptSources['Missing'] = missingCount;
  }

  return stats;
}

function renderStats(stats) {
  console.log('ğŸ¨ renderStats called with:', stats);
  const fmt = (n) => '$' + Math.abs(n || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // Helper to safely set text content
  const setText = (id, text) => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = text;
    } else {
      console.warn(`Element #${id} not found`);
    }
  };

  // Helper to safely set innerHTML
  const setHTML = (id, html) => {
    const el = document.getElementById(id);
    if (el) {
      el.innerHTML = html;
    } else {
      console.warn(`Element #${id} not found`);
    }
  };

  try {
    // Overview cards
    setText('stats-total-spent', fmt(stats.totalSpent));
    setText('stats-total-count', `${stats.totalCount || 0} transactions`);

    setText('stats-receipts-matched', stats.receiptsMatched || 0);
    const matchRate = stats.totalCount > 0 ? Math.round((stats.receiptsMatched / stats.totalCount) * 100) : 0;
    setText('stats-match-rate', `${matchRate}% coverage`);

    setText('stats-gmail-receipts', stats.gmailReceipts || 0);
    const gmailPct = stats.totalReceipts > 0 ? Math.round((stats.gmailReceipts / stats.totalReceipts) * 100) : 0;
    setText('stats-gmail-pct', `${gmailPct}% of receipts`);

    setText('stats-refunds', fmt(stats.refunds?.total || 0));
    setText('stats-refund-count', `${stats.refunds?.count || 0} transactions`);

    setText('stats-payments', fmt(stats.payments?.total || 0));
    setText('stats-payment-count', `${stats.payments?.count || 0} transactions`);
    console.log('âœ“ Overview cards rendered');
  } catch (e) {
    console.error('Error rendering overview cards:', e);
  }

  try {
    // Interest & Fees
    setText('stats-interest-total', fmt(stats.interest));
    setText('stats-fees-total', fmt(stats.fees));
    setText('stats-late-total', fmt(stats.lateCharges));
    setText('stats-total-fees', fmt((stats.interest || 0) + (stats.fees || 0) + (stats.lateCharges || 0)));
    console.log('âœ“ Interest & Fees rendered');
  } catch (e) {
    console.error('Error rendering interest/fees:', e);
  }

  try {
    // Business breakdown
    const businessContainer = document.getElementById('stats-business-breakdown');
    const businessEntries = Object.entries(stats.byBusiness || {}).sort((a, b) => b[1].total - a[1].total);

    if (!businessContainer) {
      console.warn('stats-business-breakdown not found');
    } else if (businessEntries.length === 0) {
      businessContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No business data yet</div>';
    } else {
      const maxBusiness = businessEntries[0][1].total || 1;
      businessContainer.innerHTML = businessEntries.map(([name, data]) => {
        const pct = Math.round((data.total / maxBusiness) * 100);
        const submittedPct = data.submitted > 0 ? Math.round((data.submitted / data.total) * 100) : 0;
        const color = window.businessTypeColors?.[name] || BusinessTypes.getColorSync(name);
        const unreported = data.total - (data.submitted || 0);
        const hasSubmitted = data.submitted > 0;
        return `
          <div style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px">
              <span style="font-weight:600">${name}</span>
              <span style="color:${color};font-weight:700">${fmt(data.total)}</span>
            </div>
            <div style="background:var(--panel2);height:8px;border-radius:4px;overflow:hidden;position:relative">
              <div style="background:${color};height:100%;width:${pct}%;border-radius:4px;transition:width .3s"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px">
              <span>${data.count} transactions</span>
              ${hasSubmitted ? `<span style="color:#00ff88">Reported: ${fmt(data.submitted)} (${data.submittedCount})</span>` : ''}
            </div>
            ${hasSubmitted && unreported > 0 ? `<div style="font-size:11px;color:#ffd85e;margin-top:2px">Unreported: ${fmt(unreported)} (${data.count - data.submittedCount})</div>` : ''}
          </div>
        `;
      }).join('');
    }
    console.log('âœ“ Business breakdown rendered');
  } catch (e) {
    console.error('Error rendering business breakdown:', e);
  }

  try {
    // Top merchants
    const merchantContainer = document.getElementById('stats-top-merchants');
    const merchantEntries = Object.entries(stats.byMerchant || {}).sort((a, b) => b[1].total - a[1].total).slice(0, 10);

    if (!merchantContainer) {
      console.warn('stats-top-merchants not found');
    } else if (merchantEntries.length === 0) {
      merchantContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No merchant data yet</div>';
    } else {
      const maxMerchant = merchantEntries[0][1].total || 1;
      merchantContainer.innerHTML = merchantEntries.map(([name, data], i) => {
        const pct = Math.round((data.total / maxMerchant) * 100);
        return `
          <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--panel2);border-radius:8px">
            <div style="width:24px;height:24px;background:rgba(0,255,136,.2);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#00ff88">${i + 1}</div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
              <div style="background:var(--edge);height:4px;border-radius:2px;margin-top:4px">
                <div style="background:#00ff88;height:100%;width:${pct}%;border-radius:2px"></div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700;color:#00ff88">${fmt(data.total)}</div>
              <div style="font-size:11px;color:var(--muted)">${data.count}x</div>
            </div>
          </div>
        `;
      }).join('');
    }
    console.log('âœ“ Top merchants rendered');
  } catch (e) {
    console.error('Error rendering top merchants:', e);
  }

  try {
    // Top categories
    const categoryContainer = document.getElementById('stats-top-categories');
    const categoryEntries = Object.entries(stats.byCategory || {}).sort((a, b) => b[1].total - a[1].total).slice(0, 8);

    if (!categoryContainer) {
      console.warn('stats-top-categories not found');
    } else if (categoryEntries.length === 0) {
      categoryContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No category data yet</div>';
    } else {
      const maxCategory = categoryEntries[0][1].total || 1;
      categoryContainer.innerHTML = categoryEntries.map(([name, data]) => {
        const pct = Math.round((data.total / maxCategory) * 100);
        return `
          <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--panel2);border-radius:8px">
            <div style="flex:1">
              <div style="font-weight:600">${name}</div>
              <div style="background:var(--edge);height:4px;border-radius:2px;margin-top:4px">
                <div style="background:#00ff88;height:100%;width:${pct}%;border-radius:2px"></div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700;color:#00ff88">${fmt(data.total)}</div>
              <div style="font-size:11px;color:var(--muted)">${data.count}x</div>
            </div>
          </div>
        `;
      }).join('');
    }
    console.log('âœ“ Top categories rendered');
  } catch (e) {
    console.error('Error rendering top categories:', e);
  }

  try {
    // Subscriptions
    const subsContainer = document.getElementById('stats-subscriptions');
    const subscriptions = stats.subscriptions || [];
    const totalSubSpend = subscriptions.reduce((sum, s) => sum + (s.total || 0), 0);
    setText('stats-monthly-subs', fmt(totalSubSpend));

    if (!subsContainer) {
      console.warn('stats-subscriptions not found');
    } else if (subscriptions.length === 0) {
      subsContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;grid-column:1/-1">No recurring subscriptions detected</div>';
    } else {
      subsContainer.innerHTML = subscriptions.slice(0, 15).map(sub => `
        <div style="background:var(--panel2);padding:14px;border-radius:10px;border:1px solid var(--edge)">
          <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px">${sub.name || 'Unknown'}</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span style="font-size:18px;font-weight:700;color:#00ff88">${fmt(sub.total || 0)}</span>
            <span style="font-size:11px;color:var(--muted);background:var(--panel);padding:2px 8px;border-radius:4px">${sub.count || 0}x</span>
          </div>
          <div style="font-size:11px;color:var(--muted)">~${fmt(sub.amount || 0)}/charge${sub.isRecurring ? ' â€¢ recurring' : ''}</div>
        </div>
      `).join('');
    }
    console.log('âœ“ Subscriptions rendered');
  } catch (e) {
    console.error('Error rendering subscriptions:', e);
  }

  try {
    // Receipt sources
    const sourcesContainer = document.getElementById('stats-receipt-sources');
    const sourceEntries = Object.entries(stats.receiptSources || {}).sort((a, b) => b[1] - a[1]);

    if (!sourcesContainer) {
      console.warn('stats-receipt-sources not found');
    } else if (sourceEntries.length === 0) {
      sourcesContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;grid-column:1/-1">No receipt source data</div>';
    } else {
      const sourceIcons = {
        'Gmail': 'ğŸ“§',
        'Manual Upload': 'ğŸ“¤',
        'Scanner': 'ğŸ“·',
        'Google Photos': 'ğŸ–¼ï¸',
        'Unknown': 'â“'
      };
      sourcesContainer.innerHTML = sourceEntries.map(([source, count]) => {
        const icon = sourceIcons[source] || 'ğŸ“„';
        const pct = stats.totalReceipts > 0 ? Math.round((count / stats.totalReceipts) * 100) : 0;
        return `
          <div style="background:var(--panel2);padding:16px;border-radius:10px;border:1px solid var(--edge);text-align:center">
            <div style="font-size:32px;margin-bottom:8px">${icon}</div>
            <div style="font-weight:600;margin-bottom:4px">${source}</div>
            <div style="font-size:28px;font-weight:800;color:#00ff88">${count}</div>
            <div style="font-size:11px;color:var(--muted)">${pct}% of receipts</div>
          </div>
        `;
      }).join('');
    }
    console.log('âœ“ Receipt sources rendered');
  } catch (e) {
    console.error('Error rendering receipt sources:', e);
  }

  console.log('âœ… renderStats complete');
}

// =============================================================================
// REPORTS PAGE
// =============================================================================

let reportPreviewData = [];
// currentReportId is declared earlier in the file

async function loadReportPreview() {
  const businessType = document.getElementById('report-business-type').value;
  const dateFrom = document.getElementById('report-date-from').value;
  const dateTo = document.getElementById('report-date-to').value;

  if (!businessType) {
    showToast('Please select a business type', 'âš ï¸');
    return;
  }

  showToast('Loading preview...', 'ğŸ”„');

  try {
    const res = await fetch('/reports/preview', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        business_type: businessType,
        date_from: dateFrom || null,
        date_to: dateTo || null
      })
    });

    const data = await res.json();

    if (data.ok) {
      reportPreviewData = data.expenses;

      // Generate human-readable notes
      const notesRes = await fetch('/reports/generate_notes', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ expenses: reportPreviewData })
      });

      const notesData = await notesRes.json();
      if (notesData.ok) {
        reportPreviewData = notesData.expenses_with_notes;
      }

      // Count receipts
      const receiptCount = reportPreviewData.filter(exp => exp['Receipt File']).length;

      // Update stat cards
      document.getElementById('report-total-amount').textContent =
        `$${data.total_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('report-expense-count').textContent = data.count;
      document.getElementById('report-receipt-count').textContent = receiptCount;

      // Populate table
      const tbody = document.getElementById('report-preview-table');
      tbody.innerHTML = '';

      if (reportPreviewData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding:40px;text-align:center;color:var(--muted)">
              No expenses found matching the criteria
            </td>
          </tr>
        `;
      } else {
        reportPreviewData.forEach(exp => {
          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid var(--edge)';

          const notes = exp['Notes'] || exp['AI Note'] || '';
          const notesDisplay = notes.length > 60 ? notes.substring(0, 60) + '...' : notes;

          const hasReceipt = exp['Receipt File'] ? 'ğŸ“' : '';

          tr.innerHTML = `
            <td style="padding:10px">${exp['Chase Date'] || ''}</td>
            <td style="padding:10px">${hasReceipt} ${exp['Chase Description'] || ''}</td>
            <td style="padding:10px;text-align:right">$${Math.abs(exp['Chase Amount'] || 0).toFixed(2)}</td>
            <td style="padding:10px">${exp['Category'] || '-'}</td>
            <td style="padding:10px;font-size:12px;color:var(--muted)" title="${notes}">${notesDisplay || '-'}</td>
          `;

          tbody.appendChild(tr);
        });
      }

      // Show preview section
      document.getElementById('report-preview-section').style.display = 'block';

      // Hide report actions until submitted
      document.getElementById('report-actions').style.display = 'none';

      showToast(`Found ${data.count} expenses â€¢ ${receiptCount} receipts`, 'âœ…');
    } else {
      showToast('Failed to load preview: ' + (data.error || 'Unknown error'), 'âŒ');
    }
  } catch (e) {
    showToast('Failed to load preview: ' + e.message, 'âŒ');
  }
}

async function submitReport() {
  const reportName = document.getElementById('report-name').value.trim();
  const businessType = document.getElementById('report-business-type').value;

  if (!reportName) {
    showToast('Please enter a report name', 'âš ï¸');
    return;
  }

  if (reportPreviewData.length === 0) {
    showToast('No expenses to submit - click Preview first', 'âš ï¸');
    return;
  }

  // Extract _index values, filtering out any undefined/null
  const expenseIndexes = reportPreviewData
    .map(exp => exp._index || exp['_index'])
    .filter(idx => idx !== undefined && idx !== null);

  console.log('Report submit: ', {
    reportName,
    businessType,
    totalExpenses: reportPreviewData.length,
    validIndexes: expenseIndexes.length,
    sampleIndexes: expenseIndexes.slice(0, 5)
  });

  if (expenseIndexes.length === 0) {
    showToast('No valid expense indexes found - please reload preview', 'âš ï¸');
    return;
  }

  showToast(`Submitting ${expenseIndexes.length} expenses...`, 'ğŸ“¤');

  try {
    const res = await fetch('/reports/submit', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        report_name: reportName,
        business_type: businessType,
        expense_indexes: expenseIndexes
      })
    });

    const data = await res.json();

    if (data.ok) {
      currentReportId = data.report_id;
      showToast(`Report ${data.report_id} created with ${expenseIndexes.length} expenses!`, 'âœ…');

      // Show report actions
      document.getElementById('report-actions').style.display = 'block';

      // Reload main data (these expenses are now archived)
      await loadCSV();

      // Reload archived reports list
      await loadArchivedReports();
    } else {
      console.error('Report submit failed:', data);
      showToast('Failed to submit report: ' + (data.error || data.message || 'Unknown error'), 'âŒ');
    }
  } catch (e) {
    console.error('Report submit exception:', e);
    showToast('Failed to submit report: ' + e.message, 'âŒ');
  }
}

function viewReportPage() {
  if (!currentReportId) {
    showToast('No report selected', 'âš ï¸');
    return;
  }
  window.open(`/reports/${currentReportId}/page`, '_blank');
}

function downloadReportCSV() {
  if (!currentReportId) {
    showToast('No report selected', 'âš ï¸');
    return;
  }
  window.location.href = `/reports/${currentReportId}/export/downhome`;
  showToast('Downloading CSV...', 'ğŸ“¥');
}

function downloadReportReceipts() {
  if (!currentReportId) {
    showToast('No report selected', 'âš ï¸');
    return;
  }
  window.location.href = `/reports/${currentReportId}/receipts.zip`;
  showToast('Downloading receipts ZIP...', 'ğŸ“¥');
}

async function copyReportLink() {
  if (!currentReportId) {
    showToast('No report selected', 'âš ï¸');
    return;
  }
  const url = `${window.location.origin}/reports/${currentReportId}/page`;
  try {
    await navigator.clipboard.writeText(url);
    showToast('Report link copied to clipboard!', 'âœ…');
  } catch (e) {
    showToast('Failed to copy link', 'âŒ');
  }
}

function startNewReport() {
  // Hide report actions
  document.getElementById('report-actions').style.display = 'none';

  // Hide preview section
  document.getElementById('report-preview-section').style.display = 'none';

  // Clear the preview data
  reportPreviewData = [];
  currentReportId = null;

  // Clear the report name input
  document.getElementById('report-name').value = '';

  // Keep the date range and business type selections so they can create another report
  // with the same or different criteria

  showToast('Ready to create a new report', 'âœ¨');
}

async function deleteReport(reportId) {
  if (!confirm(`Are you sure you want to delete report ${reportId}?\n\nThis will return all expenses to the available pool.`)) {
    return;
  }

  showToast('Deleting report...', 'ğŸ—‘ï¸');

  try {
    const res = await fetch(`/reports/${reportId}/delete`, {
      method: 'POST'
    });

    const data = await res.json();

    if (data.ok) {
      showToast('Report deleted! Expenses returned to available pool.', 'âœ…');

      // Reload archived reports list
      await loadArchivedReports();

      // Reload main data
      await loadCSV();

      // Close report modal if it's open
      const modal = document.getElementById('report-view-modal');
      if (modal) {
        modal.remove();
      }
    } else {
      showToast('Failed to delete report', 'âŒ');
    }
  } catch (e) {
    console.error('Delete report failed:', e);
    showToast('Failed to delete report: ' + e.message, 'âŒ');
  }
}

async function loadArchivedReports() {
  try {
    const res = await fetch('/reports/list');
    const data = await res.json();

    if (data.ok) {
      const container = document.getElementById('archived-reports-list');

      if (data.reports.length === 0) {
        container.innerHTML = `
          <div style="grid-column:1/-1;padding:60px 20px;text-align:center;color:var(--muted);background:var(--panel2);border-radius:12px;border:1px dashed var(--edge)">
            <div style="font-size:48px;margin-bottom:16px;opacity:.6">ğŸ“</div>
            <h4 style="margin:0 0 8px 0;font-size:16px;color:var(--ink)">No Reports Yet</h4>
            <p style="margin:0;font-size:13px">Create your first expense report above to get started</p>
          </div>
        `;
      } else {
        container.innerHTML = data.reports.map(report => {
          // Get business type color/gradient (using dynamic colors)
          const typeColor = window.businessTypeColors?.[report.business_type] || '#6b7280';
          const businessGradient = BusinessTypes.getGradient(report.business_type);

          return `
          <div class="report-card" style="background:linear-gradient(145deg, var(--panel2), rgba(11,17,23,.8));padding:0;border-radius:14px;border:1px solid var(--edge);overflow:hidden;transition:all .2s ease;cursor:pointer"
               onclick="openReport('${report.report_id}')"
               onmouseenter="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 32px rgba(0,0,0,.3)';this.style.borderColor='rgba(59,130,246,.4)'"
               onmouseleave="this.style.transform='';this.style.boxShadow='';this.style.borderColor='var(--edge)'">

            <!-- Card Header with gradient -->
            <div style="background:${businessGradient};padding:16px 20px;position:relative;overflow:hidden">
              <div style="position:absolute;top:-20px;right:-20px;width:80px;height:80px;background:rgba(255,255,255,.1);border-radius:50%"></div>
              <div style="position:relative;z-index:1">
                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:.9;margin-bottom:6px">${report.business_type}</div>
                <div style="font-size:16px;font-weight:700;line-height:1.3;color:white">${report.report_name}</div>
              </div>
            </div>

            <!-- Card Body -->
            <div style="padding:20px">
              <!-- Stats Row -->
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">
                <div style="text-align:center;padding:12px;background:rgba(59,130,246,.1);border-radius:10px">
                  <div style="font-size:20px;font-weight:800;color:var(--brand)">$${parseFloat(report.total_amount).toFixed(0)}</div>
                  <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Total</div>
                </div>
                <div style="text-align:center;padding:12px;background:rgba(139,92,246,.1);border-radius:10px">
                  <div style="font-size:20px;font-weight:800;color:#a78bfa">${report.expense_count}</div>
                  <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Expenses</div>
                </div>
                <div style="text-align:center;padding:12px;background:rgba(34,197,94,.1);border-radius:10px">
                  <div style="font-size:20px;font-weight:800;color:#4ade80">${report.receipt_count || 'â€”'}</div>
                  <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Receipts</div>
                </div>
              </div>

              <!-- Date -->
              <div style="font-size:12px;color:var(--muted);margin-bottom:16px;display:flex;align-items:center;gap:6px">
                <span style="opacity:.7">ğŸ“…</span>
                Created ${new Date(report.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </div>

              <!-- Action Buttons -->
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <button onclick="event.stopPropagation();window.open('/reports/${report.report_id}/page', '_blank')"
                  style="padding:10px 12px;background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px"
                  onmouseenter="this.style.transform='scale(1.02)'" onmouseleave="this.style.transform=''">
                  ğŸ“Š View
                </button>
                <button onclick="event.stopPropagation();window.location.href='/reports/${report.report_id}/export/downhome'"
                  style="padding:10px 12px;background:rgba(59,130,246,.15);color:var(--brand);border:1px solid rgba(59,130,246,.3);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px"
                  onmouseenter="this.style.background='rgba(59,130,246,.25)'" onmouseleave="this.style.background='rgba(59,130,246,.15)'">
                  ğŸ“„ CSV
                </button>
                <button onclick="event.stopPropagation();window.location.href='/reports/${report.report_id}/receipts.zip'"
                  style="padding:10px 12px;background:rgba(139,92,246,.15);color:#a78bfa;border:1px solid rgba(139,92,246,.3);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px"
                  onmouseenter="this.style.background='rgba(139,92,246,.25)'" onmouseleave="this.style.background='rgba(139,92,246,.15)'">
                  ğŸ“¦ ZIP
                </button>
                <button onclick="event.stopPropagation();deleteReport('${report.report_id}')"
                  style="padding:10px 12px;background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.2);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px"
                  onmouseenter="this.style.background='rgba(239,68,68,.2)'" onmouseleave="this.style.background='rgba(239,68,68,.1)'">
                  ğŸ—‘ï¸ Delete
                </button>
              </div>
            </div>
          </div>
        `}).join('');
      }
    }
  } catch (e) {
    console.error('Failed to load archived reports:', e);
  }
}

async function openReport(reportId) {
  showToast('Loading report...', 'ğŸ“‚');

  try {
    const res = await fetch(`/reports/${reportId}`);
    const data = await res.json();

    if (data.ok) {
      // Create modal HTML
      const modalHTML = `
        <div class="modal-overlay active" id="report-view-modal" style="z-index:10000">
          <div class="modal" style="max-width:1000px;max-height:80vh">
            <div class="modal-header">
              <div class="modal-title">ğŸ“Š Report: ${reportId}</div>
              <button class="modal-close" onclick="closeReportModal()">Ã—</button>
            </div>
            <div class="modal-body" style="max-height:60vh;overflow-y:auto">
              <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--edge)">
                <h3 style="margin:0 0 8px 0">${data.count} Expenses</h3>
                <p style="margin:0;color:var(--muted)">Total: $${data.total_amount.toFixed(2)}</p>
              </div>

              <table style="width:100%;border-collapse:collapse">
                <thead style="background:var(--panel2)">
                  <tr>
                    <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px">Date</th>
                    <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px">Description</th>
                    <th style="padding:10px;text-align:right;border-bottom:1px solid var(--edge);font-size:12px">Amount</th>
                    <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px">Category</th>
                    <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px">Notes</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.expenses.map(exp => {
                    const notes = exp['Notes'] || exp['AI Note'] || '';
                    return `
                    <tr style="border-bottom:1px solid var(--edge)">
                      <td style="padding:10px">${exp['Chase Date'] || ''}</td>
                      <td style="padding:10px">${exp['Chase Description'] || ''}</td>
                      <td style="padding:10px;text-align:right">$${Math.abs(exp['Chase Amount'] || 0).toFixed(2)}</td>
                      <td style="padding:10px">${exp['Category'] || '-'}</td>
                      <td style="padding:10px;font-size:12px;color:var(--muted)">${notes || '-'}</td>
                    </tr>
                  `}).join('')}
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button class="btn-ghost" onclick="closeReportModal()">Close</button>
            </div>
          </div>
        </div>
      `;

      // Add to body
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = modalHTML;
      document.body.appendChild(tempDiv.firstElementChild);

      showToast('Report loaded', 'âœ…');
    } else {
      showToast('Failed to load report: ' + (data.error || 'Unknown error'), 'âŒ');
    }
  } catch (e) {
    showToast('Failed to load report: ' + e.message, 'âŒ');
  }
}

function closeReportModal() {
  const modal = document.getElementById('report-view-modal');
  if (modal) {
    modal.remove();
  }
}

// ============================================
// MOBILE RECEIPT VIEWER
// ============================================

let mobileReceiptModal = null;
let mobileReceiptPanzoom = null;

function initMobileReceiptModal() {
  // Create modal if it doesn't exist
  if (!document.getElementById('mobile-receipt-modal')) {
    const modal = document.createElement('div');
    modal.id = 'mobile-receipt-modal';
    modal.className = 'mobile-receipt-modal';
    modal.innerHTML = `
      <div class="mobile-receipt-header">
        <div class="mobile-receipt-title" id="mobile-receipt-title">Receipt</div>
        <button class="mobile-receipt-close" onclick="closeMobileReceiptViewer()">Ã—</button>
      </div>
      <div class="mobile-receipt-image" id="mobile-receipt-image">
        <button class="mobile-receipt-nav prev" onclick="navigateMobileReceipt(-1)" id="mobile-prev">â€¹</button>
        <button class="mobile-receipt-nav next" onclick="navigateMobileReceipt(1)" id="mobile-next">â€º</button>
        <img id="mobile-receipt-img" src="" alt="Receipt" style="display:none">
        <div id="mobile-no-receipt" style="text-align:center;color:var(--muted);padding:40px">
          <div style="font-size:48px;opacity:0.3;margin-bottom:16px">ğŸ“„</div>
          <div>No receipt attached</div>
        </div>
      </div>
      <div class="mobile-receipt-info" id="mobile-receipt-info">
        <div class="mobile-receipt-row">
          <span class="mobile-receipt-label">Merchant</span>
          <span class="mobile-receipt-value" id="mobile-merchant">â€”</span>
        </div>
        <div class="mobile-receipt-row">
          <span class="mobile-receipt-label">Amount</span>
          <span class="mobile-receipt-value" id="mobile-amount">â€”</span>
        </div>
        <div class="mobile-receipt-row">
          <span class="mobile-receipt-label">Date</span>
          <span class="mobile-receipt-value" id="mobile-date">â€”</span>
        </div>
        <div class="mobile-receipt-row">
          <span class="mobile-receipt-label">Business</span>
          <span class="mobile-receipt-value" id="mobile-business">â€”</span>
        </div>
        <div class="mobile-receipt-row">
          <span class="mobile-receipt-label">Status</span>
          <span class="mobile-receipt-value" id="mobile-status">â€”</span>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-success" onclick="mobileMarkStatus('good')" style="flex:1;min-width:80px">âœ“ Good</button>
          <button class="btn-danger" onclick="mobileMarkStatus('bad')" style="flex:1;min-width:80px">âœ— Bad</button>
          <button class="btn-ghost" onclick="openQuickViewerFromMobile()" style="flex:1;min-width:80px">âœï¸ Edit</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    mobileReceiptModal = modal;
  }
}

function showMobileReceiptViewer(idx) {
  initMobileReceiptModal();
  const modal = document.getElementById('mobile-receipt-modal');
  const row = DATA[idx];

  if (!row) return;

  // Store current index
  modal.dataset.currentIdx = idx;

  // Update title
  document.getElementById('mobile-receipt-title').textContent =
    row['Vendor/Merchant'] || 'Receipt Details';

  // Update info
  document.getElementById('mobile-merchant').textContent =
    row['Vendor/Merchant'] || 'â€”';
  document.getElementById('mobile-amount').textContent =
    row['Amount'] || 'â€”';
  document.getElementById('mobile-date').textContent =
    row['Transaction Date'] || 'â€”';
  document.getElementById('mobile-business').textContent =
    row['Business Type'] || 'â€”';
  document.getElementById('mobile-status').textContent =
    row['Review Status'] || 'Pending';

  // Update receipt image
  const img = document.getElementById('mobile-receipt-img');
  const noReceipt = document.getElementById('mobile-no-receipt');
  // Use ImageUtils for consistent receipt URL handling
  const receiptUrl = (typeof ImageUtils !== 'undefined' ? ImageUtils.getReceiptUrl(row) : null)
    || row.r2_url || row['R2 URL'] || row.receipt_url || row['Receipt File'] || '';

  if (receiptUrl) {
    img.src = ImageUtils?.normalizeUrl ? ImageUtils.normalizeUrl(receiptUrl) : receiptUrl;
    img.style.display = 'block';
    noReceipt.style.display = 'none';

    // Initialize panzoom for pinch-to-zoom
    if (mobileReceiptPanzoom) {
      mobileReceiptPanzoom.destroy();
    }
    img.onload = () => {
      if (typeof Panzoom !== 'undefined') {
        mobileReceiptPanzoom = Panzoom(img, {
          maxScale: 5,
          minScale: 0.5,
          contain: 'outside'
        });
        img.parentElement.addEventListener('wheel', mobileReceiptPanzoom.zoomWithWheel);
      }
    };
  } else {
    img.style.display = 'none';
    noReceipt.style.display = 'block';
  }

  // Update navigation buttons
  updateMobileNavButtons(idx);

  // Show modal
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeMobileReceiptViewer() {
  const modal = document.getElementById('mobile-receipt-modal');
  if (modal) {
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }
  if (mobileReceiptPanzoom) {
    mobileReceiptPanzoom.destroy();
    mobileReceiptPanzoom = null;
  }
}

function navigateMobileReceipt(direction) {
  const modal = document.getElementById('mobile-receipt-modal');
  const currentIdx = parseInt(modal.dataset.currentIdx || 0);
  const newIdx = currentIdx + direction;

  if (newIdx >= 0 && newIdx < FILTERED.length) {
    const dataIdx = FILTERED[newIdx];
    showMobileReceiptViewer(dataIdx);
  }
}

function updateMobileNavButtons(dataIdx) {
  const currentFilteredIdx = FILTERED.indexOf(dataIdx);
  const prevBtn = document.getElementById('mobile-prev');
  const nextBtn = document.getElementById('mobile-next');

  if (prevBtn) prevBtn.disabled = currentFilteredIdx <= 0;
  if (nextBtn) nextBtn.disabled = currentFilteredIdx >= FILTERED.length - 1;
}

function mobileMarkStatus(status) {
  const modal = document.getElementById('mobile-receipt-modal');
  const dataIdx = parseInt(modal.dataset.currentIdx || 0);

  if (DATA[dataIdx]) {
    DATA[dataIdx]['Review Status'] = status;
    saveRow(dataIdx, 'Review Status', status);

    // Update display
    document.getElementById('mobile-status').textContent = status;

    // Show toast
    showToast(`Marked as ${status}`, status === 'good' ? 'âœ…' : 'âŒ');

    // Auto-advance to next
    setTimeout(() => navigateMobileReceipt(1), 500);
  }
}

function openQuickViewerFromMobile() {
  const modal = document.getElementById('mobile-receipt-modal');
  const dataIdx = parseInt(modal.dataset.currentIdx || 0);
  closeMobileReceiptViewer();
  showQuickViewer(dataIdx);
}

// Override row click behavior on mobile
function handleRowClick(idx, e) {
  // Check if we're on mobile/tablet
  if (window.innerWidth <= 1024) {
    e.preventDefault();
    e.stopPropagation();
    showMobileReceiptViewer(idx);
    return false;
  }
  // Desktop behavior - select row and show in side panel
  selectRow(idx);
}

// Add touch event handling for swipe navigation in mobile viewer
document.addEventListener('DOMContentLoaded', () => {
  initMobileReceiptModal();

  // Add swipe support to mobile receipt viewer
  let touchStartX = 0;
  let touchEndX = 0;

  document.addEventListener('touchstart', (e) => {
    const modal = document.getElementById('mobile-receipt-modal');
    if (modal && modal.classList.contains('active')) {
      touchStartX = e.changedTouches[0].screenX;
    }
  }, { passive: true });

  document.addEventListener('touchend', (e) => {
    const modal = document.getElementById('mobile-receipt-modal');
    if (modal && modal.classList.contains('active')) {
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;

      // Minimum swipe distance of 50px
      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          navigateMobileReceipt(1); // Swipe left - next
        } else {
          navigateMobileReceipt(-1); // Swipe right - previous
        }
      }
    }
  }, { passive: true });

  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeMobileReceiptViewer();
    }
  });
});

// Helper to check if we're on mobile
function isMobileDevice() {
  return window.innerWidth <= 1024 ||
    ('ontouchstart' in window) ||
    (navigator.maxTouchPoints > 0);
}

// ============================================
// BATCH OPERATIONS
// ============================================
let batchMode = false;
let selectedTransactions = new Set();

function toggleBatchMode() {
  batchMode = !batchMode;
  const btn = document.getElementById('batch-select-btn');
  const actions = document.getElementById('batch-actions');

  if (batchMode) {
    btn.style.background = 'var(--brand)';
    btn.style.color = '#000';
    actions.style.display = 'flex';
    showToast('Batch mode ON - Click rows to select', 'info');
  } else {
    btn.style.background = '';
    btn.style.color = '';
    actions.style.display = 'none';
    selectedTransactions.clear();
    renderTable();
  }
}

function toggleTransactionSelection(index, event) {
  if (!batchMode) return;
  event.stopPropagation();

  if (selectedTransactions.has(index)) {
    selectedTransactions.delete(index);
  } else {
    selectedTransactions.add(index);
  }

  updateBatchCount();
  renderTable();
}

function selectAllVisible() {
  filteredData.forEach(row => selectedTransactions.add(row._index));
  updateBatchCount();
  renderTable();
  showToast(`Selected ${selectedTransactions.size} transactions`, 'info');
}

function clearSelection() {
  selectedTransactions.clear();
  updateBatchCount();
  renderTable();
}

function updateBatchCount() {
  const countEl = document.getElementById('batch-count');
  if (countEl) {
    countEl.textContent = `${selectedTransactions.size} selected`;
  }
}

async function batchSetBusiness(businessType) {
  if (!businessType || selectedTransactions.size === 0) return;

  const count = selectedTransactions.size;
  if (!confirm(`Set ${count} transactions to "${businessType}"?`)) {
    document.getElementById('batch-business-select').value = '';
    return;
  }

  showToast(`Updating ${count} transactions...`, 'info');

  let success = 0;
  for (const index of selectedTransactions) {
    try {
      const res = await fetch('/update_row', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ _index: index, patch: { 'Business Type': businessType }})
      });
      if (res.ok) {
        success++;
        const row = csvData.find(r => r._index === index);
        if (row) row['Business Type'] = businessType;
      }
    } catch (e) { console.error(e); }
  }

  showToast(`Updated ${success}/${count} transactions`, 'success');
  document.getElementById('batch-business-select').value = '';
  selectedTransactions.clear();
  updateBatchCount();
  renderTable();
  updateDashboard();
}

async function batchSetStatus(status) {
  if (!status || selectedTransactions.size === 0) return;

  const count = selectedTransactions.size;
  if (!confirm(`Set ${count} transactions to "${status}"?`)) {
    document.getElementById('batch-status-select').value = '';
    return;
  }

  showToast(`Updating ${count} transactions...`, 'info');

  let success = 0;
  for (const index of selectedTransactions) {
    try {
      const res = await fetch('/update_row', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ _index: index, patch: { 'Review Status': status }})
      });
      if (res.ok) {
        success++;
        const row = csvData.find(r => r._index === index);
        if (row) row['Review Status'] = status;
      }
    } catch (e) { console.error(e); }
  }

  showToast(`Updated ${success}/${count} transactions`, 'success');
  document.getElementById('batch-status-select').value = '';
  selectedTransactions.clear();
  updateBatchCount();
  renderTable();
}

// ============================================
// ADVANCED SEARCH
// ============================================
let advancedSearchVisible = false;

function toggleAdvancedSearch() {
  advancedSearchVisible = !advancedSearchVisible;
  const panel = document.getElementById('advanced-search-panel');
  const btn = document.getElementById('advanced-search-btn');

  if (advancedSearchVisible) {
    panel.style.display = 'flex';
    btn.style.background = 'var(--brand)';
    btn.style.color = '#000';
  } else {
    panel.style.display = 'none';
    btn.style.background = '';
    btn.style.color = '';
  }
}

function applyAdvancedSearch() {
  const amountMin = parseFloat(document.getElementById('search-amount-min').value) || null;
  const amountMax = parseFloat(document.getElementById('search-amount-max').value) || null;
  const dateFrom = document.getElementById('search-date-from').value || null;
  const dateTo = document.getElementById('search-date-to').value || null;
  const merchant = document.getElementById('search-merchant').value.toLowerCase().trim();

  filteredData = csvData.filter(row => {
    const amount = Math.abs(parseFloat(row['Chase Amount']) || 0);
    const date = row['Chase Date'] || '';
    const merchantName = (row['MI Merchant'] || row['Chase Description'] || '').toLowerCase();

    if (amountMin !== null && amount < amountMin) return false;
    if (amountMax !== null && amount > amountMax) return false;
    if (dateFrom && date < dateFrom) return false;
    if (dateTo && date > dateTo) return false;
    if (merchant && !merchantName.includes(merchant)) return false;

    return true;
  });

  renderTable();
  showToast(`Found ${filteredData.length} matching transactions`, 'success');
}

function clearAdvancedSearch() {
  document.getElementById('search-amount-min').value = '';
  document.getElementById('search-amount-max').value = '';
  document.getElementById('search-date-from').value = '';
  document.getElementById('search-date-to').value = '';
  document.getElementById('search-merchant').value = '';
  document.getElementById('search').value = '';

  filteredData = [...csvData];
  renderTable();
  showToast('Filters cleared', 'info');
}

// ============================================
// AUTO-CATEGORIZATION LEARNING
// ============================================
const categoryRules = JSON.parse(localStorage.getItem('categoryRules') || '{}');

function learnCategorization(merchant, businessType, category) {
  const key = merchant.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 20);
  if (!key) return;

  categoryRules[key] = { businessType, category, lastUsed: Date.now() };
  localStorage.setItem('categoryRules', JSON.stringify(categoryRules));
}

function suggestCategorization(merchant) {
  const key = merchant.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 20);
  return categoryRules[key] || null;
}

// Auto-apply learned rules when loading
function applyLearnedRules() {
  let applied = 0;

  csvData.forEach(row => {
    if (row['Business Type']) return; // Already categorized

    const merchant = row['MI Merchant'] || row['Chase Description'] || '';
    const suggestion = suggestCategorization(merchant);

    if (suggestion) {
      row['Business Type'] = suggestion.businessType;
      if (suggestion.category) row['MI Category'] = suggestion.category;
      applied++;
    }
  });

  if (applied > 0) {
    showToast(`Auto-categorized ${applied} transactions from learned rules`, 'success');
    renderTable();
    updateDashboard();
  }
}

// ============================================
// CALENDAR VIEW
// ============================================
function openCalendarView() {
  // Create calendar modal
  let modal = document.getElementById('calendar-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'calendar-modal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal" style="max-width:900px;max-height:90vh">
        <div class="modal-header">
          <div class="modal-title">ğŸ“… Calendar View</div>
          <button class="modal-close" onclick="closeCalendarView()">Ã—</button>
        </div>
        <div class="modal-body" style="padding:0">
          <div id="calendar-container" style="padding:20px"></div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  modal.classList.add('active');
  renderCalendar();
}

function closeCalendarView() {
  const modal = document.getElementById('calendar-modal');
  if (modal) modal.classList.remove('active');
}

function renderCalendar() {
  const container = document.getElementById('calendar-container');
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();

  // Group transactions by date
  const transactionsByDate = {};
  csvData.forEach(row => {
    const date = row['Chase Date'];
    if (date) {
      if (!transactionsByDate[date]) transactionsByDate[date] = [];
      transactionsByDate[date].push(row);
    }
  });

  // Get days in month
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startDay = firstDay.getDay();

  let html = `
    <div style="text-align:center;margin-bottom:20px">
      <h3 style="margin:0">${today.toLocaleString('default', { month: 'long', year: 'numeric' })}</h3>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center">
      <div style="font-weight:600;color:var(--muted);padding:8px">Sun</div>
      <div style="font-weight:600;color:var(--muted);padding:8px">Mon</div>
      <div style="font-weight:600;color:var(--muted);padding:8px">Tue</div>
      <div style="font-weight:600;color:var(--muted);padding:8px">Wed</div>
      <div style="font-weight:600;color:var(--muted);padding:8px">Thu</div>
      <div style="font-weight:600;color:var(--muted);padding:8px">Fri</div>
      <div style="font-weight:600;color:var(--muted);padding:8px">Sat</div>
  `;

  // Empty cells before first day
  for (let i = 0; i < startDay; i++) {
    html += '<div></div>';
  }

  // Days
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const dayTxns = transactionsByDate[dateStr] || [];
    const total = dayTxns.reduce((sum, t) => sum + Math.abs(parseFloat(t['Chase Amount']) || 0), 0);
    const isToday = day === today.getDate();

    html += `
      <div style="padding:8px;background:var(--panel2);border-radius:8px;min-height:60px;cursor:${dayTxns.length ? 'pointer' : 'default'};${isToday ? 'border:2px solid var(--brand);' : ''}"
           onclick="${dayTxns.length ? `showDayTransactions('${dateStr}')` : ''}">
        <div style="font-weight:600;${isToday ? 'color:var(--brand)' : ''}">${day}</div>
        ${dayTxns.length ? `
          <div style="font-size:11px;color:var(--muted)">${dayTxns.length} txn</div>
          <div style="font-size:12px;font-weight:600;color:var(--bad)">$${total.toFixed(0)}</div>
        ` : ''}
      </div>
    `;
  }

  html += '</div>';
  container.innerHTML = html;
}

function showDayTransactions(dateStr) {
  // Filter to show only that day's transactions
  document.getElementById('search').value = dateStr;
  applyFilters();
  closeCalendarView();
  showToast(`Showing transactions for ${dateStr}`, 'info');
}

// ============================================
// SMART NOTIFICATIONS
// ============================================
let notificationPermission = Notification.permission;

async function requestNotificationPermission() {
  if ('Notification' in window) {
    notificationPermission = await Notification.requestPermission();
    return notificationPermission === 'granted';
  }
  return false;
}

function showNotification(title, body, icon = '/favicon.ico') {
  if (notificationPermission !== 'granted') return;

  new Notification(title, { body, icon, badge: icon });
}

// Check for weekly summaries (call on page load)
async function checkWeeklySummary() {
  const lastSummary = localStorage.getItem('lastWeeklySummary');
  const now = Date.now();
  const oneWeek = 7 * 24 * 60 * 60 * 1000;

  if (lastSummary && (now - parseInt(lastSummary)) < oneWeek) return;

  // Generate summary
  const unmatched = csvData.filter(r => !r['Receipt File']).length;
  const thisWeek = csvData.filter(r => {
    const date = new Date(r['Chase Date']);
    return (now - date.getTime()) < oneWeek;
  });
  const weeklyTotal = thisWeek.reduce((sum, r) => sum + Math.abs(parseFloat(r['Chase Amount']) || 0), 0);

  if (unmatched > 0 || weeklyTotal > 0) {
    showNotification(
      'Weekly Expense Summary',
      `${unmatched} receipts missing | $${weeklyTotal.toFixed(2)} spent this week`
    );
    localStorage.setItem('lastWeeklySummary', now.toString());
  }
}

// Check for subscription reminders
function checkSubscriptionReminders() {
  const subscriptions = csvData.filter(r => r.mi_is_subscription);
  const now = new Date();

  subscriptions.forEach(sub => {
    const lastCharge = new Date(sub['Chase Date']);
    const daysSince = Math.floor((now - lastCharge) / (1000 * 60 * 60 * 24));

    // Remind if subscription is due soon (around 25-31 days)
    if (daysSince >= 25 && daysSince <= 31) {
      showNotification(
        'Subscription Reminder',
        `${sub.mi_subscription_name || sub['MI Merchant']} may renew soon ($${Math.abs(parseFloat(sub['Chase Amount'])).toFixed(2)})`
      );
    }
  });
}

// Initialize notifications on load (only check if already granted, don't prompt)
document.addEventListener('DOMContentLoaded', () => {
  // Only use notifications if already granted - don't auto-request (requires user gesture)
  if (Notification.permission === 'granted') {
    checkWeeklySummary();
    checkSubscriptionReminders();
  }
});

// Add calendar button to stats page
setTimeout(() => {
  const statsHeader = document.querySelector('#stats-page h2');
  if (statsHeader) {
    const calBtn = document.createElement('button');
    calBtn.className = 'btn-ghost';
    calBtn.style.marginLeft = '16px';
    calBtn.innerHTML = 'ğŸ“… Calendar View';
    calBtn.onclick = openCalendarView;
    statsHeader.parentNode.appendChild(calBtn);
  }
}, 100);

// ============================================
// KEYBOARD SHORTCUTS INTEGRATION
// ============================================
// ReviewInterface adapter - bridges KeyboardHandler to existing functions
const ReviewInterface = {
  // Navigation
  navigate: (delta) => navigateRow(delta),
  navigateToIndex: (idx) => {
    if (idx === -1) idx = filteredData.length - 1;
    if (idx >= 0 && idx < filteredData.length) {
      const row = filteredData[idx];
      selectRow(row);
      document.querySelector(`tr[data-index="${row._index}"]`)?.scrollIntoView({ block: 'center' });
    }
  },
  togglePreview: (open) => {
    if (open && selectedRow) loadReceipt();
  },
  closeAll: () => {
    closeQuickViewer();
    const modal = document.querySelector('.modal-overlay.active');
    if (modal) modal.classList.remove('active');
  },

  // Quick actions - map to updateField
  setReviewStatus: (status) => updateField('Review Status', status),
  setValidationStatus: (status) => updateField('MI Validation', status),
  detachReceipt: () => detachReceipt(),

  // Business type
  setBusinessType: (type) => updateField('Business Type', type),
  setPersonal: () => updateField('Business Type', 'Personal'),

  // AI actions
  aiMatch: () => aiMatch(),
  generateAINote: () => aiNote(),
  aiCategorize: async () => {
    if (!selectedRow) return showToast('Select a transaction first', 'warning');
    try {
      const resp = await fetch('/api/ai/categorize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ _index: selectedRow._index })
      });
      const data = await resp.json();
      if (data.ok) {
        showToast(`Categorized: ${data.category}`, 'success');
        await loadCSV();
      }
    } catch (e) {
      showToast('AI categorization failed', 'error');
    }
  },

  // Bulk selection
  extendSelection: (delta) => navigateRow(delta),
  selectAll: () => showToast('Select all: Use Ctrl+Click', 'info'),
  selectSameMerchant: () => showToast('Select same merchant: Coming soon', 'info'),
  openBulkActions: () => {
    if (typeof BulkActions !== 'undefined') {
      window.bulkActions?.show();
    }
  },

  // Search & Filter
  focusSearch: () => {
    const search = document.getElementById('search');
    if (search) search.focus();
  },
  toggleFilterPanel: () => {
    const filters = document.querySelector('.filter-controls');
    if (filters) filters.classList.toggle('expanded');
  },
  quickFilter: (type, value) => {
    if (type === 'business') {
      const select = document.getElementById('filterBusiness');
      if (select) { select.value = value; applyFilters(); }
    } else if (type === 'receipt') {
      const select = document.getElementById('filterReceipt');
      if (select) { select.value = value; applyFilters(); }
    } else if (type === 'status') {
      const select = document.getElementById('filterStatus');
      if (select) { select.value = value; applyFilters(); }
    }
  },

  // Image controls
  rotateImage: () => rotateImage(),
  zoomIn: () => zoomIn(),
  zoomOut: () => zoomOut(),
  resetZoom: () => resetZoom(),

  // System
  openQuickViewer: () => openQuickViewer(),
  undo: () => undo(),
  save: () => saveCSV(),
  exportSelected: () => showToast('Export: Use Reports page', 'info'),

  // Methods needed by BulkActions
  showToast: (message, icon) => showToast(message, icon === 'âœ…' ? 'success' : icon === 'âŒ' ? 'error' : 'info'),
  getFilteredTransactions: () => filteredData,
  getAllTransactions: () => csvData,
  refresh: () => { renderTable(); updateDashboard(); }
};

// Initialize keyboard handler
document.addEventListener('DOMContentLoaded', () => {
  if (typeof KeyboardHandler !== 'undefined') {
    window.keyboardHandler = new KeyboardHandler(ReviewInterface);
    console.log('Keyboard shortcuts enabled. Press ? for help.');
  }

  // Initialize bulk actions
  if (typeof BulkActions !== 'undefined') {
    window.bulkActions = new BulkActions(ReviewInterface);
  }
});

// Open bulk actions from header button
function openBulkActionsFromHeader() {
  if (!window.bulkActions) {
    showToast('Bulk actions not loaded', 'error');
    return;
  }

  // If we have a selected row, add it to the selection
  if (selectedRow && selectedRow._index !== undefined) {
    window.bulkActions.select(selectedRow._index);
  }

  // Open the modal
  if (window.bulkActions.selectedIds.size === 0) {
    showToast('Select transactions first (click rows, then Ctrl+Click for multi-select)', 'info');
    return;
  }

  window.bulkActions.open();
}

// Add Ctrl+Click multi-selection to table rows
document.addEventListener('click', (e) => {
  const row = e.target.closest('tr[data-index]');
  if (!row) return;

  const index = parseInt(row.dataset.index);
  if (isNaN(index)) return;

  // Ctrl/Cmd + Click for multi-select
  if ((e.ctrlKey || e.metaKey) && window.bulkActions) {
    e.preventDefault();
    window.bulkActions.toggle(index);

    // Visual feedback
    row.classList.toggle('bulk-selected', window.bulkActions.selectedIds.has(index));

    // Update bulk actions button
    const count = window.bulkActions.selectedIds.size;
    const btn = document.getElementById('bulk-actions-btn');
    if (btn) {
      btn.textContent = count > 0 ? `ğŸ“¦ ${count}` : 'ğŸ“¦';
      btn.classList.toggle('has-selection', count > 0);
    }
  }
});

// Listen for bulk selection changes
document.addEventListener('bulkSelectionChanged', (e) => {
  const { selectedIds } = e.detail;

  // Update row highlighting
  document.querySelectorAll('tr[data-index]').forEach(row => {
    const index = parseInt(row.dataset.index);
    row.classList.toggle('bulk-selected', selectedIds.includes(index));
  });

  // Update button
  const btn = document.getElementById('bulk-actions-btn');
  if (btn) {
    btn.textContent = selectedIds.length > 0 ? `ğŸ“¦ ${selectedIds.length}` : 'ğŸ“¦';
    btn.classList.toggle('has-selection', selectedIds.length > 0);
  }
});
</script>

<!-- Mobile Filter Sheet (iOS-style bottom sheet) -->
<div class="filter-sheet-backdrop" id="filter-sheet-backdrop" onclick="closeFilterSheet()"></div>
<div class="filter-sheet" id="filter-sheet">
  <div class="filter-sheet-handle"></div>
  <div class="filter-sheet-header">
    <span class="filter-sheet-title">Filters</span>
    <button class="filter-sheet-clear" onclick="clearAllFilters()">Clear All</button>
    <button class="filter-sheet-close" onclick="closeFilterSheet()">&times;</button>
  </div>
  <div class="filter-sheet-body">
    <!-- Status Filter -->
    <div class="filter-section">
      <div class="filter-section-title">Receipt Status</div>
      <div class="filter-options" id="filter-status-options">
        <button class="filter-option active" data-filter="status" data-value="all">All</button>
        <button class="filter-option" data-filter="status" data-value="missing">Missing</button>
        <button class="filter-option" data-filter="status" data-value="good">Good</button>
        <button class="filter-option" data-filter="status" data-value="bad">Bad</button>
        <button class="filter-option" data-filter="status" data-value="not needed">Not Needed</button>
      </div>
    </div>
    <!-- Business Filter -->
    <div class="filter-section">
      <div class="filter-section-title">Business</div>
      <div class="filter-options" id="filter-business-options">
        <button class="filter-option active" data-filter="business" data-value="all">All</button>
        <button class="filter-option" data-filter="business" data-value="Music City Rodeo">MCR</button>
        <button class="filter-option" data-filter="business" data-value="Down Home">Down Home</button>
        <button class="filter-option" data-filter="business" data-value="EM.co">EM.co</button>
        <button class="filter-option" data-filter="business" data-value="Personal">Personal</button>
      </div>
    </div>
    <!-- Date Range Filter -->
    <div class="filter-section">
      <div class="filter-section-title">Date Range</div>
      <div class="filter-options" id="filter-date-options">
        <button class="filter-option active" data-filter="date" data-value="all">All Time</button>
        <button class="filter-option" data-filter="date" data-value="today">Today</button>
        <button class="filter-option" data-filter="date" data-value="week">This Week</button>
        <button class="filter-option" data-filter="date" data-value="month">This Month</button>
        <button class="filter-option" data-filter="date" data-value="quarter">This Quarter</button>
      </div>
    </div>
    <!-- Amount Filter -->
    <div class="filter-section">
      <div class="filter-section-title">Amount Range</div>
      <div class="filter-options" id="filter-amount-options">
        <button class="filter-option active" data-filter="amount" data-value="all">Any</button>
        <button class="filter-option" data-filter="amount" data-value="under50">Under $50</button>
        <button class="filter-option" data-filter="amount" data-value="50to200">$50 - $200</button>
        <button class="filter-option" data-filter="amount" data-value="over200">Over $200</button>
      </div>
    </div>
  </div>
  <div class="filter-sheet-footer">
    <button class="filter-reset-btn" onclick="clearAllFilters()">Reset</button>
    <button class="filter-apply-btn" onclick="applyMobileFilters()">Apply Filters</button>
  </div>
</div>

<!-- Pull to Refresh Indicator -->
<div class="pull-refresh-indicator" id="pull-refresh-indicator">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
    <polyline points="21 3 21 9 15 9"/>
  </svg>
</div>

<script>
// Mobile Filter Sheet Functions
let activeFilters = { status: 'all', business: 'all', date: 'all', amount: 'all' };

function openFilterSheet() {
  document.getElementById('filter-sheet-backdrop').classList.add('active');
  document.getElementById('filter-sheet').classList.add('active');
  // Haptic feedback
  if ('vibrate' in navigator) navigator.vibrate(10);
}

function closeFilterSheet() {
  document.getElementById('filter-sheet-backdrop').classList.remove('active');
  document.getElementById('filter-sheet').classList.remove('active');
}

// Filter option click handlers
document.querySelectorAll('.filter-option').forEach(btn => {
  btn.addEventListener('click', function() {
    const filterType = this.dataset.filter;
    const value = this.dataset.value;

    // Deselect siblings, select this one
    this.parentElement.querySelectorAll('.filter-option').forEach(b => b.classList.remove('active'));
    this.classList.add('active');

    activeFilters[filterType] = value;
    updateFilterCount();

    // Haptic feedback
    if ('vibrate' in navigator) navigator.vibrate(5);
  });
});

function updateFilterCount() {
  let count = 0;
  if (activeFilters.status !== 'all') count++;
  if (activeFilters.business !== 'all') count++;
  if (activeFilters.date !== 'all') count++;
  if (activeFilters.amount !== 'all') count++;

  const badge = document.getElementById('mobile-filter-count');
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
}

function clearAllFilters() {
  activeFilters = { status: 'all', business: 'all', date: 'all', amount: 'all' };
  document.querySelectorAll('.filter-option').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.value === 'all') btn.classList.add('active');
  });
  updateFilterCount();
  applyMobileFilters();
}

function applyMobileFilters() {
  // Apply status filter
  if (activeFilters.status !== 'all') {
    const statusDropdown = document.getElementById('receipt-status-filter');
    if (statusDropdown) {
      statusDropdown.value = activeFilters.status;
      statusDropdown.dispatchEvent(new Event('change'));
    }
  }

  // Apply business filter
  if (activeFilters.business !== 'all') {
    const bizDropdown = document.getElementById('business-filter');
    if (bizDropdown) {
      bizDropdown.value = activeFilters.business;
      bizDropdown.dispatchEvent(new Event('change'));
    }
  }

  // Trigger data refresh if available
  if (typeof applyFilters === 'function') {
    applyFilters();
  }

  closeFilterSheet();

  // Haptic feedback
  if ('vibrate' in navigator) navigator.vibrate(20);
}

// Pull to Refresh (simplified implementation)
let pullStartY = 0;
let isPulling = false;

if ('ontouchstart' in window) {
  const tableWrap = document.querySelector('.table-wrap');
  if (tableWrap) {
    tableWrap.addEventListener('touchstart', (e) => {
      if (tableWrap.scrollTop === 0) {
        pullStartY = e.touches[0].clientY;
        isPulling = true;
      }
    }, { passive: true });

    tableWrap.addEventListener('touchmove', (e) => {
      if (!isPulling) return;
      const pullDistance = e.touches[0].clientY - pullStartY;
      if (pullDistance > 60 && pullDistance < 150) {
        document.getElementById('pull-refresh-indicator').classList.add('pulling');
      }
    }, { passive: true });

    tableWrap.addEventListener('touchend', () => {
      const indicator = document.getElementById('pull-refresh-indicator');
      if (indicator.classList.contains('pulling')) {
        indicator.classList.remove('pulling');
        indicator.classList.add('refreshing');

        // Haptic feedback
        if ('vibrate' in navigator) navigator.vibrate([20, 50, 20]);

        // Trigger refresh
        if (typeof loadData === 'function') {
          loadData().then(() => {
            indicator.classList.remove('refreshing');
          }).catch(() => {
            indicator.classList.remove('refreshing');
          });
        } else {
          setTimeout(() => indicator.classList.remove('refreshing'), 1000);
        }
      }
      isPulling = false;
    }, { passive: true });
  }
}

// Handle swipe-to-close for filter sheet
let sheetStartY = 0;
const filterSheet = document.getElementById('filter-sheet');
if (filterSheet) {
  filterSheet.addEventListener('touchstart', (e) => {
    if (e.target.closest('.filter-sheet-handle') || e.target.closest('.filter-sheet-header')) {
      sheetStartY = e.touches[0].clientY;
    }
  }, { passive: true });

  filterSheet.addEventListener('touchmove', (e) => {
    if (sheetStartY === 0) return;
    const diff = e.touches[0].clientY - sheetStartY;
    if (diff > 0) {
      filterSheet.style.transform = `translateY(${diff}px)`;
    }
  }, { passive: true });

  filterSheet.addEventListener('touchend', (e) => {
    if (sheetStartY === 0) return;
    const diff = e.changedTouches[0].clientY - sheetStartY;
    filterSheet.style.transform = '';
    if (diff > 100) {
      closeFilterSheet();
    }
    sheetStartY = 0;
  }, { passive: true });
}
</script>

<!-- Floating Report FAB Button -->
<button class="report-fab hidden" id="report-fab" onclick="toggleReportPanel()">
  ğŸ“‹
  <span class="report-fab-badge" id="report-fab-badge">0</span>
</button>

<!-- Floating Report Panel -->
<div class="report-panel" id="report-panel">
  <div class="report-panel-header" onclick="toggleReportMinimize()">
    <span class="report-icon">ğŸ“‹</span>
    <span class="report-title" id="report-panel-title">New Report</span>
    <div class="report-stats">
      <span id="report-panel-count">0 items</span>
      <span id="report-panel-total">$0.00</span>
    </div>
    <span class="report-minimize" id="report-minimize-icon">âˆ’</span>
  </div>
  <div class="report-panel-tabs">
    <div class="report-tab active" data-tab="items" onclick="switchReportTab('items')">Items</div>
    <div class="report-tab" data-tab="reports" onclick="switchReportTab('reports')">Reports</div>
  </div>
  <div class="report-panel-content" id="report-panel-content">
    <div class="report-empty" id="report-empty">
      <div class="report-empty-icon">ğŸ“­</div>
      <div class="report-empty-text">No transactions added yet.<br>Select transactions and click "Add to Report"</div>
    </div>
    <div id="report-items-list"></div>
  </div>
  <div class="report-panel-footer">
    <button class="btn btn-ghost" onclick="clearCurrentReport()">Clear</button>
    <button class="btn btn-primary" onclick="submitCurrentReport()">Submit Report</button>
  </div>
</div>

<!-- Report Selector Dropdown (for moving between reports) -->
<div class="report-selector-menu" id="report-selector-menu">
  <div class="report-selector-item report-selector-new" onclick="createNewReport()">
    <span class="report-selector-icon">â•</span>
    <span class="report-selector-name">New Report</span>
  </div>
</div>

<script>
// ============================================
// REPORT PANEL FUNCTIONALITY
// ============================================

// Report state management (openReports, currentReportId, reportTransactions declared earlier)
// NOTE: reportPanelVisible, reportPanelMinimized, reportPanelTab declared at line 4267-4269

// Initialize reports from localStorage
function initReportPanel() {
  // Load open reports
  openReports = JSON.parse(localStorage.getItem('tallyups_open_reports') || '[]');

  // Load transactions for each report
  openReports.forEach(report => {
    const stored = localStorage.getItem(`tallyups_report_${report.id}`);
    if (stored) {
      reportTransactions.set(report.id, new Set(JSON.parse(stored)));
    } else {
      reportTransactions.set(report.id, new Set());
    }
  });

  // Create default report if none exist (skip prompt for auto-creation)
  if (openReports.length === 0) {
    createNewReport(true);
  } else {
    // Use stored current report or first report
    currentReportId = localStorage.getItem('tallyups_current_report');
    if (!currentReportId || !openReports.find(r => r.id === currentReportId)) {
      currentReportId = openReports[0].id;
    }
  }

  updateReportUI();
  updateReportFAB();
}

// Create a new report
async function createNewReport(skipPrompt = false) {
  const tempId = 'report_' + Date.now();
  const defaultName = 'Report ' + (openReports.length + 1);

  // Prompt for name unless skipPrompt is true
  let reportName = defaultName;
  if (!skipPrompt) {
    const inputName = prompt('Enter report name:', defaultName);
    if (inputName === null) return; // User cancelled
    reportName = inputName.trim() || defaultName;
  }

  // Try to create in database first
  try {
    const response = await fetch('/api/reports', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: reportName,
        status: 'draft'
      })
    });

    if (response.ok) {
      const data = await response.json();
      const report = {
        id: data.id,
        name: data.name || reportName,
        created: new Date().toISOString(),
        synced: true
      };
      openReports.push(report);
      reportTransactions.set(data.id, new Set());
      currentReportId = data.id;
    } else {
      // Fallback to local-only report
      const report = {
        id: tempId,
        name: reportName,
        created: new Date().toISOString(),
        synced: false
      };
      openReports.push(report);
      reportTransactions.set(tempId, new Set());
      currentReportId = tempId;
    }
  } catch (e) {
    // Offline - create local report
    const report = {
      id: tempId,
      name: reportName,
      created: new Date().toISOString(),
      synced: false
    };
    openReports.push(report);
    reportTransactions.set(tempId, new Set());
    currentReportId = tempId;
  }

  saveReportsState();
  updateReportUI();
  showToast('Created new report', 'success');
}

// Save reports state to localStorage AND sync to database
function saveReportsState() {
  // Always save to localStorage as cache/fallback
  localStorage.setItem('tallyups_open_reports', JSON.stringify(openReports));
  localStorage.setItem('tallyups_current_report', currentReportId);

  // Save each report's transactions to localStorage
  reportTransactions.forEach((indices, reportId) => {
    localStorage.setItem(`tallyups_report_${reportId}`, JSON.stringify([...indices]));
  });

  // Sync transaction assignments to database (debounced)
  debouncedSyncToDatabase();
}

// Debounce database sync to avoid too many API calls
let syncTimeout = null;
function debouncedSyncToDatabase() {
  if (syncTimeout) clearTimeout(syncTimeout);
  syncTimeout = setTimeout(() => syncReportsToDatabase(), 500);
}

// Sync report transactions to database
async function syncReportsToDatabase() {
  for (const [reportId, indices] of reportTransactions) {
    // Skip local-only reports (not synced to DB yet)
    if (reportId.startsWith('report_')) continue;

    for (const idx of indices) {
      try {
        await fetch(`/api/reports/${reportId}/add`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transaction_id: idx })
        });
      } catch (e) {
        // Silently fail, localStorage is the backup
      }
    }
  }
}

// Refresh and display draft reports in the reports page
async function refreshDraftReports() {
  const grid = document.getElementById('draft-reports-grid');
  const countBadge = document.getElementById('draft-reports-count');
  const emptyState = document.getElementById('draft-reports-empty');

  if (!grid) return;

  // Combine localStorage and database reports
  const allDrafts = [...openReports];

  // Also fetch from database
  try {
    const res = await fetch('/api/reports?status=draft');
    if (res.ok) {
      const data = await res.json();
      if (data.ok && data.reports) {
        data.reports.forEach(dbReport => {
          if (!allDrafts.find(r => r.id === dbReport.report_id)) {
            allDrafts.push({
              id: dbReport.report_id,
              name: dbReport.report_name || dbReport.name,
              created: dbReport.created_at,
              total: dbReport.total || 0,
              count: dbReport.count || 0,
              synced: true
            });
          }
        });
      }
    }
  } catch (e) {
    // Use localStorage only
  }

  // Update count badge
  countBadge.textContent = allDrafts.length;

  // Clear existing cards (except empty state)
  grid.querySelectorAll('.draft-report-card').forEach(c => c.remove());

  if (allDrafts.length === 0) {
    emptyState.style.display = '';
    return;
  }

  emptyState.style.display = 'none';

  // Create cards for each draft report
  allDrafts.forEach(report => {
    const indices = reportTransactions.get(report.id) || new Set();
    const itemCount = indices.size || report.count || 0;

    // Calculate total from indices if available
    let total = report.total || 0;
    if (indices.size > 0 && csvData) {
      total = 0;
      indices.forEach(idx => {
        const row = csvData.find(r => r._index === idx);
        if (row) {
          total += Math.abs(parseFloat(row['Chase Amount'] || row['Amount'] || 0));
        }
      });
    }

    const card = document.createElement('div');
    card.className = 'draft-report-card';
    card.style.cssText = 'background:var(--panel);border:1px solid var(--edge);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;position:relative';
    card.onmouseenter = () => card.style.borderColor = 'var(--brand)';
    card.onmouseleave = () => card.style.borderColor = 'var(--edge)';

    const syncStatus = report.synced ? 'â˜ï¸' : 'ğŸ’¾';
    const syncTooltip = report.synced ? 'Synced to server' : 'Local only';

    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div style="font-size:24px">ğŸ“‹</div>
        <div style="display:flex;gap:8px;align-items:center">
          <span title="${syncTooltip}" style="font-size:14px;opacity:0.6">${syncStatus}</span>
          <button onclick="event.stopPropagation();deleteDraftReport('${report.id}')" style="width:24px;height:24px;border-radius:6px;background:transparent;color:var(--muted);font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none" title="Delete draft">Ã—</button>
        </div>
      </div>
      <h4 style="margin:0 0 8px 0;font-size:16px;font-weight:600;color:var(--ink)">${escapeHtml(report.name)}</h4>
      <div style="display:flex;gap:16px;font-size:13px;color:var(--muted)">
        <span>${itemCount} item${itemCount !== 1 ? 's' : ''}</span>
        <span style="color:var(--brand);font-weight:600">$${total.toFixed(2)}</span>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button onclick="event.stopPropagation();continueDraftReport('${report.id}')" class="btn-success" style="flex:1;padding:8px 12px;font-size:12px">
          Continue
        </button>
        <button onclick="event.stopPropagation();renameReport('${report.id}')" class="btn-secondary" style="padding:8px 12px;font-size:12px" title="Rename">
          âœï¸
        </button>
        <button onclick="event.stopPropagation();viewDraftReportDetails('${report.id}')" class="btn-secondary" style="padding:8px 12px;font-size:12px">
          View
        </button>
      </div>
    `;

    grid.appendChild(card);
  });
}

// Rename a report
async function renameReport(reportId) {
  const report = openReports.find(r => r.id === reportId);
  if (!report) return;

  const newName = prompt('Enter new report name:', report.name);
  if (newName === null || newName.trim() === '' || newName.trim() === report.name) return;

  report.name = newName.trim();

  // Try to update on server
  try {
    const response = await fetch(`/api/reports/${reportId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: newName.trim() })
    });
    if (response.ok) {
      showToast('Report renamed', 'success');
    }
  } catch (e) {
    console.log('Could not sync rename to server:', e);
  }

  saveReportsState();
  updateReportUI();
  renderDraftReports();
}

// Continue working on a draft report
function continueDraftReport(reportId) {
  currentReportId = reportId;
  localStorage.setItem('tallyups_current_report', currentReportId);

  // Switch to home page (viewer) and show report panel
  switchPage('home');
  showReportPanel();
  updateReportUI();
  showToast('Draft report loaded', 'success');
}

// View draft report details in a modal
function viewDraftReportDetails(reportId) {
  const report = openReports.find(r => r.id === reportId);
  if (!report) return;

  const indices = reportTransactions.get(reportId) || new Set();
  const items = [];
  let total = 0;

  indices.forEach(idx => {
    const row = csvData.find(r => r._index === idx);
    if (row) {
      const amt = Math.abs(parseFloat(row['Chase Amount'] || row['Amount'] || 0));
      total += amt;
      items.push({
        date: row['Chase Date'] || row['Date'],
        merchant: row['MI Merchant'] || row['Chase Description'],
        amount: amt
      });
    }
  });

  // Show modal with report details
  const modalHTML = `
    <div class="modal-overlay active" id="draft-report-detail-modal" style="z-index:10001">
      <div class="modal" style="max-width:600px;max-height:80vh">
        <div class="modal-header">
          <div class="modal-title">ğŸ“‹ ${escapeHtml(report.name)}</div>
          <button class="modal-close" onclick="document.getElementById('draft-report-detail-modal').remove()">Ã—</button>
        </div>
        <div class="modal-body" style="max-height:50vh;overflow-y:auto">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
            <div style="background:var(--panel2);padding:16px;border-radius:10px;text-align:center">
              <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Items</div>
              <div style="font-size:24px;font-weight:700;color:var(--brand)">${items.length}</div>
            </div>
            <div style="background:var(--panel2);padding:16px;border-radius:10px;text-align:center">
              <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Total</div>
              <div style="font-size:24px;font-weight:700;color:var(--brand)">$${total.toFixed(2)}</div>
            </div>
          </div>
          <div style="border:1px solid var(--edge);border-radius:8px;overflow:hidden">
            <table style="width:100%;border-collapse:collapse;font-size:13px">
              <thead style="background:var(--panel2)">
                <tr>
                  <th style="padding:10px;text-align:left;color:var(--muted)">Date</th>
                  <th style="padding:10px;text-align:left;color:var(--muted)">Merchant</th>
                  <th style="padding:10px;text-align:right;color:var(--muted)">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(item => `
                  <tr style="border-top:1px solid var(--edge)">
                    <td style="padding:10px">${escapeHtml(item.date || '')}</td>
                    <td style="padding:10px">${escapeHtml(item.merchant || '')}</td>
                    <td style="padding:10px;text-align:right;font-weight:600">$${item.amount.toFixed(2)}</td>
                  </tr>
                `).join('') || '<tr><td colspan="3" style="padding:20px;text-align:center;color:var(--muted)">No items yet</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-ghost" onclick="document.getElementById('draft-report-detail-modal').remove()">Close</button>
          <button class="btn-success" onclick="document.getElementById('draft-report-detail-modal').remove();continueDraftReport('${reportId}')">Continue Editing</button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Delete a draft report
async function deleteDraftReport(reportId) {
  if (!confirm('Delete this draft report?')) return;

  // Remove from openReports
  openReports = openReports.filter(r => r.id !== reportId);
  reportTransactions.delete(reportId);
  localStorage.removeItem(`tallyups_report_${reportId}`);

  // Update currentReportId if needed
  if (currentReportId === reportId) {
    currentReportId = openReports.length > 0 ? openReports[0].id : null;
  }

  saveReportsState();

  // Also delete from database if it's a synced report
  if (!reportId.startsWith('report_')) {
    try {
      await fetch(`/reports/${reportId}/delete`, { method: 'POST' });
    } catch (e) {
      // Ignore
    }
  }

  refreshDraftReports();
  renderTable();
  showToast('Draft deleted', 'info');
}

// ============================================
// 10X REPORT BUILDER - SPEED & POWER FEATURES
// ============================================

let speedModeActive = false;
let speedModeQueue = [];
let speedModeIndex = 0;
let quickActionBarVisible = false;

// Update the live report widget with current totals
function updateLiveReportWidget() {
  const widget = document.getElementById('live-report-widget');
  if (!widget) return;

  // Only show when we have an active report
  if (openReports.length === 0) {
    widget.classList.add('hidden');
    return;
  }

  widget.classList.remove('hidden');

  const report = openReports.find(r => r.id === currentReportId) || openReports[0];
  const indices = reportTransactions.get(report.id) || new Set();

  // Calculate total
  let total = 0;
  indices.forEach(idx => {
    const row = csvData.find(r => r._index === idx);
    if (row) {
      total += Math.abs(parseFloat(row['Chase Amount'] || row['Amount'] || 0));
    }
  });

  document.getElementById('widget-report-name').textContent = report.name;
  document.getElementById('widget-item-count').textContent = indices.size;
  document.getElementById('widget-total').textContent = '$' + total.toFixed(2);

  // Pulse animation when item added
  widget.classList.add('pulse');
  setTimeout(() => widget.classList.remove('pulse'), 500);
}

// Show/hide quick action bar based on selection
function updateQuickActionBar() {
  const bar = document.getElementById('quick-action-bar');
  if (!bar) return;

  if (selectedRow && !speedModeActive) {
    bar.classList.add('visible');
    quickActionBarVisible = true;
  } else {
    bar.classList.remove('visible');
    quickActionBarVisible = false;
  }
}

// Quick add current transaction to report (Space key)
function quickAddToReport() {
  if (!selectedRow) return;

  // Auto-create report if none exists
  if (!currentReportId || openReports.length === 0) {
    createNewReport();
  }

  const currentSet = reportTransactions.get(currentReportId) || new Set();
  const index = selectedRow._index;

  if (currentSet.has(index)) {
    showToast('Already in report', 'info');
    return;
  }

  currentSet.add(index);
  reportTransactions.set(currentReportId, currentSet);
  saveReportsState();

  // Update UI
  updateLiveReportWidget();
  updateReportUI();

  const merchant = selectedRow['MI Merchant'] || selectedRow['Chase Description'] || 'Transaction';
  showToast(`Added "${merchant}"`, 'success');

  // Re-render and move to next
  renderTable();
  navigateRow(1);
}

// Quick skip transaction (S key) - marks as reviewed but not added
function quickSkipTransaction() {
  if (!selectedRow) return;

  // Just move to next without adding to report
  showToast('Skipped', 'info');
  navigateRow(1);
}

// Mark as personal (P key)
function markAsPersonal() {
  if (!selectedRow) return;

  updateField('Business Type', 'Personal');
  showToast('Marked as Personal', 'success');
  navigateRow(1);
}

// ============================================
// QUICK EDIT POPUP
// ============================================

let quickEditVisible = false;

function showQuickEditPopup() {
  if (!selectedRow) return;

  const popup = document.getElementById('quick-edit-popup');

  // Populate with current values
  document.getElementById('quick-edit-category').value = selectedRow['MI Category'] || selectedRow['Chase Category'] || '';
  document.getElementById('quick-edit-business').value = selectedRow['Business Type'] || '';
  document.getElementById('quick-edit-notes').value = selectedRow['Notes'] || selectedRow['MI Description'] || '';

  popup.classList.add('visible');
  quickEditVisible = true;

  // Focus on first field
  document.getElementById('quick-edit-category').focus();

  // Handle keyboard
  document.addEventListener('keydown', handleQuickEditKeys);
}

function closeQuickEditPopup() {
  document.getElementById('quick-edit-popup').classList.remove('visible');
  quickEditVisible = false;
  document.removeEventListener('keydown', handleQuickEditKeys);
}

function handleQuickEditKeys(e) {
  if (!quickEditVisible) return;

  if (e.key === 'Escape') {
    e.preventDefault();
    closeQuickEditPopup();
  } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    saveQuickEdit();
  }
}

function saveQuickEdit() {
  if (!selectedRow) return;

  const category = document.getElementById('quick-edit-category').value;
  const business = document.getElementById('quick-edit-business').value;
  const notes = document.getElementById('quick-edit-notes').value;

  // Update local data
  if (category) {
    selectedRow['MI Category'] = category;
    updateField('MI Category', category);
  }
  if (business) {
    selectedRow['Business Type'] = business;
    updateField('Business Type', business);
  }
  if (notes !== undefined) {
    selectedRow['Notes'] = notes;
    updateField('Notes', notes);
  }

  closeQuickEditPopup();
  showToast('Saved', 'success');

  // Move to next transaction
  navigateRow(1);
}

// ============================================
// SPEED MODE - Rapid-fire expense categorization
// ============================================

function enterSpeedMode() {
  // Get all visible transactions that aren't in a report
  speedModeQueue = filteredData.filter(row => {
    if (typeof isInAnyReport === 'function' && isInAnyReport(row._index)) {
      return false;
    }
    return true;
  });

  if (speedModeQueue.length === 0) {
    showToast('No transactions to process', 'warning');
    return;
  }

  speedModeActive = true;
  speedModeIndex = 0;

  // Auto-create report if needed
  if (!currentReportId || openReports.length === 0) {
    createNewReport();
  }

  // Show speed mode UI
  document.getElementById('speed-mode-indicator').classList.add('visible');
  document.getElementById('transaction-preview').classList.add('visible');
  document.getElementById('quick-action-bar').classList.remove('visible');

  // Show first transaction
  showSpeedModeTransaction();

  showToast('Speed Mode activated! Space=Add, S=Skip, Esc=Exit', 'success');
}

function exitSpeedMode() {
  speedModeActive = false;
  speedModeQueue = [];
  speedModeIndex = 0;

  document.getElementById('speed-mode-indicator').classList.remove('visible');
  document.getElementById('transaction-preview').classList.remove('visible');
  updateQuickActionBar();

  renderTable();
  showToast('Speed Mode exited', 'info');
}

function showSpeedModeTransaction() {
  if (speedModeIndex >= speedModeQueue.length) {
    exitSpeedMode();
    showToast('All transactions processed!', 'success');
    return;
  }

  const row = speedModeQueue[speedModeIndex];
  const amt = Math.abs(parseFloat(row['Chase Amount'] || row['Amount'] || 0));
  const merchant = row['MI Merchant'] || row['Chase Description'] || 'Unknown';
  const date = row['Chase Date'] || '';
  // Use ImageUtils for consistent receipt URL handling
  const receiptUrl = (typeof ImageUtils !== 'undefined' ? ImageUtils.getReceiptUrl(row) : null)
    || row.r2_url || row['R2 URL'] || row.receipt_url || row['Receipt File'] || '';

  // Update preview card
  const amtClass = (parseFloat(row['Chase Amount'] || 0)) > 0 ? 'neg' : 'pos';
  document.getElementById('preview-amount').innerHTML = `<span class="amount ${amtClass}">$${amt.toFixed(2)}</span>`;
  document.getElementById('preview-merchant').textContent = merchant;
  document.getElementById('preview-date').textContent = formatDateForDisplay(date);

  // Populate editable fields with current values
  const categoryEl = document.getElementById('preview-category');
  const businessEl = document.getElementById('preview-business');
  const notesEl = document.getElementById('preview-notes');

  categoryEl.value = row['MI Category'] || row['Chase Category'] || '';
  businessEl.value = row['Business Type'] || '';
  notesEl.value = row['Notes'] || row['MI Description'] || '';

  // Show/hide receipt image
  const imgEl = document.getElementById('preview-receipt-img');
  if (receiptUrl) {
    imgEl.src = receiptUrl;
    imgEl.style.display = 'block';
  } else {
    imgEl.style.display = 'none';
  }

  // Update progress
  const progress = ((speedModeIndex + 1) / speedModeQueue.length) * 100;
  document.getElementById('speed-progress-bar').style.width = progress + '%';
  document.getElementById('speed-count').textContent = `${speedModeIndex + 1}/${speedModeQueue.length}`;
}

// Update category for current speed mode transaction
function updateSpeedCategory(value) {
  if (!speedModeActive || speedModeIndex >= speedModeQueue.length) return;
  const row = speedModeQueue[speedModeIndex];
  row['MI Category'] = value;
  // Save to server
  updateFieldForIndex(row._index, 'MI Category', value);
}

// Update business type for current speed mode transaction
function updateSpeedBusiness(value) {
  if (!speedModeActive || speedModeIndex >= speedModeQueue.length) return;
  const row = speedModeQueue[speedModeIndex];
  row['Business Type'] = value;
  // Save to server
  updateFieldForIndex(row._index, 'Business Type', value);
}

// Update notes for current speed mode transaction
function updateSpeedNotes(value) {
  if (!speedModeActive || speedModeIndex >= speedModeQueue.length) return;
  const row = speedModeQueue[speedModeIndex];
  row['Notes'] = value;
  // Save to server
  updateFieldForIndex(row._index, 'Notes', value);
}

// Helper to update a field by index (without changing selectedRow)
async function updateFieldForIndex(rowIndex, field, value) {
  try {
    const response = await fetch('/api/transaction/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        index: rowIndex,
        field: field,
        value: value
      })
    });
    if (!response.ok) {
      console.error('Failed to update field');
    }
  } catch (e) {
    console.error('Error updating field:', e);
  }
}

function speedAdd() {
  if (!speedModeActive || speedModeIndex >= speedModeQueue.length) return;

  const row = speedModeQueue[speedModeIndex];
  const currentSet = reportTransactions.get(currentReportId) || new Set();
  currentSet.add(row._index);
  reportTransactions.set(currentReportId, currentSet);
  saveReportsState();
  updateLiveReportWidget();

  // Animate card out
  const preview = document.getElementById('transaction-preview');
  preview.style.animation = 'none';
  preview.offsetHeight; // Force reflow
  preview.style.animation = 'cardSlideIn 0.3s ease';

  speedModeIndex++;
  showSpeedModeTransaction();
}

function speedSkip() {
  if (!speedModeActive) return;

  // Animate card out
  const preview = document.getElementById('transaction-preview');
  preview.style.animation = 'none';
  preview.offsetHeight;
  preview.style.animation = 'cardSlideIn 0.3s ease';

  speedModeIndex++;
  showSpeedModeTransaction();
}

// Helper for date formatting
function formatDateForDisplay(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  } catch (e) {
    return dateStr;
  }
}

// ============================================
// ENHANCED KEYBOARD SHORTCUTS
// ============================================

// Add speed mode keyboard handlers
document.addEventListener('keydown', (e) => {
  // Speed mode controls
  if (speedModeActive) {
    if (e.code === 'Space') {
      e.preventDefault();
      speedAdd();
    } else if (e.key.toLowerCase() === 's') {
      e.preventDefault();
      speedSkip();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      exitSpeedMode();
    }
    return;
  }

  // Skip if quick edit popup is open
  if (quickEditVisible) return;

  // Normal mode - quick action shortcuts (only when not in input)
  if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT') {
    return;
  }

  // Space to add to report (when transaction selected)
  if (e.code === 'Space' && selectedRow && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    quickAddToReport();
  }

  // S to skip
  if (e.key.toLowerCase() === 's' && selectedRow && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
    e.preventDefault();
    quickSkipTransaction();
  }

  // E to edit
  if (e.key.toLowerCase() === 'e' && selectedRow && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
    e.preventDefault();
    showQuickEditPopup();
  }

  // Ctrl+Enter for speed mode
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    enterSpeedMode();
  }
});

// ============================================
// SWIPE GESTURES (Touch support)
// ============================================

let touchStartX = 0;
let touchStartY = 0;
let swipingRow = null;
const SWIPE_THRESHOLD = 80;

function initSwipeGestures() {
  const tbody = document.getElementById('tbody');
  if (!tbody) return;

  tbody.addEventListener('touchstart', (e) => {
    const row = e.target.closest('tr');
    if (!row) return;

    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    swipingRow = row;
    row.classList.add('swiping');
  }, { passive: true });

  tbody.addEventListener('touchmove', (e) => {
    if (!swipingRow) return;

    const deltaX = e.touches[0].clientX - touchStartX;
    const deltaY = e.touches[0].clientY - touchStartY;

    // Only allow horizontal swipes
    if (Math.abs(deltaY) > Math.abs(deltaX)) return;

    // Limit swipe distance
    const clampedX = Math.max(-100, Math.min(100, deltaX));
    swipingRow.style.transform = `translateX(${clampedX}px)`;

    // Show action indicators
    if (deltaX > SWIPE_THRESHOLD) {
      swipingRow.classList.add('swipe-add');
      swipingRow.classList.remove('swipe-skip');
    } else if (deltaX < -SWIPE_THRESHOLD) {
      swipingRow.classList.add('swipe-skip');
      swipingRow.classList.remove('swipe-add');
    } else {
      swipingRow.classList.remove('swipe-add', 'swipe-skip');
    }
  }, { passive: true });

  tbody.addEventListener('touchend', (e) => {
    if (!swipingRow) return;

    const deltaX = e.changedTouches[0].clientX - touchStartX;
    const rowIndex = parseInt(swipingRow.dataset.index);

    // Execute action based on swipe direction
    if (deltaX > SWIPE_THRESHOLD) {
      // Swipe right = add to report
      const row = csvData.find(r => r._index === rowIndex);
      if (row) {
        selectedRow = row;
        quickAddToReport();
      }
    } else if (deltaX < -SWIPE_THRESHOLD) {
      // Swipe left = mark as personal
      const row = csvData.find(r => r._index === rowIndex);
      if (row) {
        selectedRow = row;
        markAsPersonal();
      }
    }

    // Reset row
    swipingRow.style.transform = '';
    swipingRow.classList.remove('swiping', 'swipe-add', 'swipe-skip');
    swipingRow = null;
  });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
  initSwipeGestures();
  updateLiveReportWidget();
});

// Update widget when reports change
const originalSaveReportsState = saveReportsState;
saveReportsState = function() {
  originalSaveReportsState.apply(this, arguments);
  updateLiveReportWidget();
};

// Add selected transactions to current report
function addSelectedToReport() {
  if (selectedTransactions.size === 0) {
    showToast('No transactions selected', 'warning');
    return;
  }

  if (!currentReportId) {
    createNewReport();
  }

  const currentSet = reportTransactions.get(currentReportId) || new Set();
  let added = 0;

  selectedTransactions.forEach(index => {
    if (!currentSet.has(index)) {
      currentSet.add(index);
      added++;
    }
  });

  reportTransactions.set(currentReportId, currentSet);
  saveReportsState();

  // Clear selection and exit batch mode
  selectedTransactions.clear();
  updateBatchCount();

  // Re-render table to hide added transactions
  renderTable();

  // Show and update report panel
  showReportPanel();
  updateReportUI();

  showToast(`Added ${added} transaction${added !== 1 ? 's' : ''} to report`, 'success');
}

// Remove transaction from report
function removeFromReport(index) {
  if (!currentReportId) return;

  const currentSet = reportTransactions.get(currentReportId);
  if (currentSet) {
    currentSet.delete(index);
    reportTransactions.set(currentReportId, currentSet);
    saveReportsState();
    updateReportUI();
    renderTable(); // Show transaction again in main table
    showToast('Removed from report', 'info');
  }
}

// Move transaction to another report
function moveToReport(index, targetReportId) {
  if (!currentReportId || currentReportId === targetReportId) return;

  // Remove from current
  const currentSet = reportTransactions.get(currentReportId);
  if (currentSet) {
    currentSet.delete(index);
  }

  // Add to target
  const targetSet = reportTransactions.get(targetReportId) || new Set();
  targetSet.add(index);
  reportTransactions.set(targetReportId, targetSet);

  saveReportsState();
  updateReportUI();
  showToast('Moved to ' + (openReports.find(r => r.id === targetReportId)?.name || 'report'), 'success');
}

// Clear current report
function clearCurrentReport() {
  if (!currentReportId) return;

  if (!confirm('Clear all transactions from this report?')) return;

  reportTransactions.set(currentReportId, new Set());
  saveReportsState();
  updateReportUI();
  renderTable();
  showToast('Report cleared', 'info');
}

// Submit current report
async function submitCurrentReport() {
  if (!currentReportId) return;

  const indices = [...(reportTransactions.get(currentReportId) || [])];
  if (indices.length === 0) {
    showToast('No transactions in report', 'warning');
    return;
  }

  const reportName = openReports.find(r => r.id === currentReportId)?.name || 'Report';

  // Determine business type from transactions in the report
  let businessType = 'Down Home'; // Default
  if (indices.length > 0) {
    const firstTx = filteredData.find(t => t._index === indices[0] || t.id === indices[0]);
    if (firstTx) {
      const bt = firstTx['Business Type'] || firstTx.business_type || '';
      if (bt.toLowerCase().includes('mcr') || bt.toLowerCase().includes('rodeo') || bt.toLowerCase().includes('music city')) {
        businessType = 'Music City Rodeo';
      } else if (bt.toLowerCase().includes('personal')) {
        businessType = 'Personal';
      } else if (bt.toLowerCase().includes('em.co') || bt.toLowerCase().includes('emco')) {
        businessType = 'EM.co';
      }
    }
  }

  if (!confirm(`Submit "${reportName}" (${businessType}) with ${indices.length} transactions?`)) return;

  try {
    showToast('Submitting report...', 'info');

    const resp = await fetch('/reports/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        report_name: reportName,
        business_type: businessType,
        expense_indexes: indices
      })
    });

    if (resp.ok) {
      const data = await resp.json();

      // Clear the submitted report
      reportTransactions.delete(currentReportId);
      localStorage.removeItem(`tallyups_report_${currentReportId}`);

      // Remove from open reports list
      openReports = openReports.filter(r => r.id !== currentReportId);

      // Switch to next report or create new one
      if (openReports.length > 0) {
        currentReportId = openReports[0].id;
      } else {
        createNewReport();
      }

      saveReportsState();
      updateReportUI();
      renderTable();

      showToast(`Report submitted! ID: ${data.report_id}`, 'success');
    } else {
      throw new Error('Failed to submit report');
    }
  } catch (e) {
    console.error('Submit error:', e);
    showToast('Failed to submit report: ' + e.message, 'error');
  }
}

// Toggle report panel visibility
function toggleReportPanel() {
  reportPanelVisible = !reportPanelVisible;
  const panel = document.getElementById('report-panel');
  const fab = document.getElementById('report-fab');

  if (reportPanelVisible) {
    panel.classList.add('visible');
    fab.classList.add('hidden');
  } else {
    panel.classList.remove('visible');
    updateReportFAB();
  }
}

// Show report panel
function showReportPanel() {
  reportPanelVisible = true;
  document.getElementById('report-panel').classList.add('visible');
  document.getElementById('report-fab').classList.add('hidden');
}

// Toggle report tray and add current transaction (triggered by 'R' key)
function toggleReportTrayAndAdd() {
  if (!selectedRow) {
    showToast('No transaction selected', 'warning');
    return;
  }

  // If multiple draft reports exist, show selector popup
  if (openReports.length > 1) {
    showReportSelector();
    return;
  }

  // Single report or no reports - add directly
  addToReport(currentReportId);
}

// Show report selector popup for choosing which report to add to
function showReportSelector() {
  const selector = document.getElementById('report-selector-popup');
  const list = document.getElementById('report-selector-list');

  // Build the list of reports
  list.innerHTML = openReports.map((report, idx) => {
    const count = (reportTransactions.get(report.id) || new Set()).size;
    const isActive = report.id === currentReportId;
    const shortcut = idx < 9 ? `<span class="report-selector-shortcut">${idx + 1}</span>` : '';
    return `
      <div class="report-selector-item ${isActive ? 'active' : ''}"
           onclick="selectReportAndAdd('${report.id}')"
           data-report-id="${report.id}">
        ${shortcut}
        <span class="report-selector-name">${escapeHtml(report.name)}</span>
        <span class="report-selector-count">${count} items</span>
      </div>
    `;
  }).join('') + `
    <div class="report-selector-item report-selector-new" onclick="createNewReportAndAdd()">
      <span class="report-selector-shortcut">N</span>
      <span class="report-selector-name">+ New Report</span>
    </div>
  `;

  selector.classList.add('visible');
  reportSelectorVisible = true;

  // Close on outside click
  setTimeout(() => {
    document.addEventListener('click', closeReportSelectorOnOutsideClick);
    document.addEventListener('keydown', handleReportSelectorKeys);
  }, 10);
}

// Handle keyboard in report selector
function handleReportSelectorKeys(e) {
  if (!reportSelectorVisible) return;

  const key = e.key.toLowerCase();

  // Number keys 1-9 to select report
  if (key >= '1' && key <= '9') {
    e.preventDefault();
    const idx = parseInt(key) - 1;
    if (idx < openReports.length) {
      selectReportAndAdd(openReports[idx].id);
    }
  }
  // N for new report
  else if (key === 'n') {
    e.preventDefault();
    createNewReportAndAdd();
  }
  // Escape to close
  else if (key === 'escape') {
    e.preventDefault();
    closeReportSelector();
  }
}

function closeReportSelectorOnOutsideClick(e) {
  const selector = document.getElementById('report-selector-popup');
  if (!selector.contains(e.target)) {
    closeReportSelector();
  }
}

function closeReportSelector() {
  document.getElementById('report-selector-popup').classList.remove('visible');
  reportSelectorVisible = false;
  document.removeEventListener('click', closeReportSelectorOnOutsideClick);
  document.removeEventListener('keydown', handleReportSelectorKeys);
}

// Select a report and add current transaction to it
function selectReportAndAdd(reportId) {
  closeReportSelector();
  currentReportId = reportId;
  saveReportsState();
  addToReport(reportId);
}

// Create new report and add current transaction
function createNewReportAndAdd() {
  closeReportSelector();
  createNewReport();
  addToReport(currentReportId);
}

// Add current selected transaction to a specific report
function addToReport(reportId) {
  if (!selectedRow) return;

  // Ensure we have a report
  if (!reportId) {
    createNewReport();
    reportId = currentReportId;
  }

  // Show the report panel
  if (!reportPanelVisible) {
    showReportPanel();
  }

  // Add current transaction to report
  const currentSet = reportTransactions.get(reportId) || new Set();
  const index = selectedRow._index;

  if (currentSet.has(index)) {
    showToast('Already in report', 'info');
  } else {
    currentSet.add(index);
    reportTransactions.set(reportId, currentSet);
    saveReportsState();
    updateReportUI();
    updateReportFAB();
    renderTable(); // Re-render to hide the added transaction

    const merchant = selectedRow['MI Merchant'] || selectedRow['Chase Description'] || 'Transaction';
    const reportName = openReports.find(r => r.id === reportId)?.name || 'Report';
    showToast(`Added "${merchant}" to ${reportName}`, 'success');

    // Auto-navigate to next row
    navigateRow(1);
  }
}

// Toggle minimize
function toggleReportMinimize() {
  reportPanelMinimized = !reportPanelMinimized;
  const panel = document.getElementById('report-panel');
  const icon = document.getElementById('report-minimize-icon');

  if (reportPanelMinimized) {
    panel.classList.add('minimized');
    icon.textContent = '+';
  } else {
    panel.classList.remove('minimized');
    icon.textContent = 'âˆ’';
  }
}

// Switch report tabs
function switchReportTab(tab) {
  reportPanelTab = tab;
  document.querySelectorAll('.report-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.tab === tab);
  });
  updateReportUI();
}

// Switch between open reports
function switchReport(reportId) {
  if (!openReports.find(r => r.id === reportId)) return;
  currentReportId = reportId;
  saveReportsState();
  updateReportUI();
  renderTable();
}

// Update report FAB badge
function updateReportFAB() {
  const fab = document.getElementById('report-fab');
  const badge = document.getElementById('report-fab-badge');

  const totalItems = [...reportTransactions.values()].reduce((sum, set) => sum + set.size, 0);

  if (totalItems > 0) {
    fab.classList.remove('hidden');
    badge.textContent = totalItems;
  } else if (!reportPanelVisible) {
    fab.classList.add('hidden');
  }
}

// Update report panel UI
function updateReportUI() {
  const titleEl = document.getElementById('report-panel-title');
  const countEl = document.getElementById('report-panel-count');
  const totalEl = document.getElementById('report-panel-total');
  const contentEl = document.getElementById('report-panel-content');
  const emptyEl = document.getElementById('report-empty');
  const listEl = document.getElementById('report-items-list');

  const currentReport = openReports.find(r => r.id === currentReportId);
  const currentIndices = reportTransactions.get(currentReportId) || new Set();

  // Update header
  titleEl.textContent = currentReport?.name || 'New Report';
  countEl.textContent = `${currentIndices.size} items`;

  // Calculate total
  let total = 0;
  currentIndices.forEach(index => {
    const row = csvData.find(r => r._index === index);
    if (row) {
      total += Math.abs(parseFloat(row['Chase Amount']) || 0);
    }
  });
  totalEl.textContent = '$' + total.toFixed(2);

  // Update FAB
  updateReportFAB();

  // Render content based on tab
  if (reportPanelTab === 'items') {
    renderReportItems(currentIndices, listEl, emptyEl);
  } else {
    renderReportsTab(listEl, emptyEl);
  }
}

// Render report items
function renderReportItems(indices, listEl, emptyEl) {
  if (indices.size === 0) {
    emptyEl.style.display = 'block';
    listEl.innerHTML = '';
    return;
  }

  emptyEl.style.display = 'none';

  let html = '';
  indices.forEach(index => {
    const row = csvData.find(r => r._index === index);
    if (!row) return;

    const merchant = row['MI Merchant'] || row['Chase Description'] || 'Unknown';
    const amount = Math.abs(parseFloat(row['Chase Amount']) || 0);
    const date = row['Chase Date'] || '';

    html += `
      <div class="report-item">
        <div class="report-item-info">
          <div class="report-item-merchant">${escapeHtml(merchant)}</div>
          <div class="report-item-meta">
            <span>${formatDate(date)}</span>
            <span>${row['Business Type'] || ''}</span>
          </div>
        </div>
        <div class="report-item-amount">$${amount.toFixed(2)}</div>
        <div class="report-item-actions">
          <button class="report-item-btn remove" onclick="removeFromReport(${index})" title="Remove from report">âœ•</button>
        </div>
      </div>
    `;
  });

  listEl.innerHTML = html;
}

// Render reports tab (list of open reports)
function renderReportsTab(listEl, emptyEl) {
  emptyEl.style.display = 'none';

  let html = '';
  openReports.forEach(report => {
    const count = (reportTransactions.get(report.id) || new Set()).size;
    const isActive = report.id === currentReportId;

    html += `
      <div class="report-item ${isActive ? 'active' : ''}" onclick="switchReport('${report.id}')" style="${isActive ? 'border: 1px solid var(--brand);' : ''}">
        <div class="report-item-info">
          <div class="report-item-merchant">${escapeHtml(report.name)}</div>
          <div class="report-item-meta">
            <span>${count} items</span>
            <span>${new Date(report.created).toLocaleDateString()}</span>
          </div>
        </div>
        <div class="report-item-actions">
          ${!isActive ? `<button class="report-item-btn" onclick="event.stopPropagation(); deleteReport('${report.id}')" title="Delete report">ğŸ—‘</button>` : ''}
        </div>
      </div>
    `;
  });

  html += `
    <div class="report-item" onclick="createNewReport()" style="border: 1px dashed var(--edge); cursor: pointer;">
      <div class="report-item-info">
        <div class="report-item-merchant" style="color: var(--brand)">â• New Report</div>
      </div>
    </div>
  `;

  listEl.innerHTML = html;
}

// Delete an open report
function deleteReport(reportId) {
  if (reportId === currentReportId) {
    showToast('Cannot delete active report', 'warning');
    return;
  }

  if (!confirm('Delete this report?')) return;

  reportTransactions.delete(reportId);
  localStorage.removeItem(`tallyups_report_${reportId}`);
  openReports = openReports.filter(r => r.id !== reportId);
  saveReportsState();
  updateReportUI();
  renderTable();
  showToast('Report deleted', 'info');
}

// Format date helper
function formatDate(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch {
    return dateStr;
  }
}

// Escape HTML helper
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  })[m]);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Give a moment for csvData to load
  setTimeout(initReportPanel, 500);
});

// Override renderTable to filter out report transactions
const originalRenderTable = typeof renderTable === 'function' ? renderTable : null;
</script>

</body>
</html>
