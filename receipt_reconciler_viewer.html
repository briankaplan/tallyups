<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="AI-powered receipt management and expense tracking system">
<meta name="theme-color" content="#0b0d10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Tallyups - Expense Management</title>
<!-- Favicon (brain emoji as SVG) -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßæ</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßæ</text></svg>">
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/@panzoom/panzoom/dist/panzoom.min.js"></script>
<style>
:root{
  --bg:#000000; --panel:#111111; --panel2:#0a0a0a; --edge:#222;
  --ink:#f0f0f0; --muted:#888; --brand:#00ff88;
  --ok:#00ff88; --bad:#ff4e6a; --warn:#ffd85e;
  --glow:rgba(0,255,136,.35); --pos:#00ff88; --neg:#ff8ea4;
  --chip:#111; --chipOn:#003322; --chipL:#f0f0f0;
}
.light{
  --bg:#f8f9fa; --panel:#ffffff; --panel2:#f5f5f5; --edge:#e0e0e0;
  --ink:#111111; --muted:#666; --brand:#00cc6a;
  --ok:#00cc6a; --bad:#e04863; --warn:#ffd14a;
  --glow:rgba(0,204,106,.25); --pos:#00aa55; --neg:#b9475b;
  --chip:#f0fff0; --chipOn:#d0ffd0; --chipL:#004422;
}

*{box-sizing:border-box}
html,body{
  height:100%;margin:0;background:var(--bg);color:var(--ink);
  font:13px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Helvetica,Arial;
}

/* Buttons */
button{
  cursor:pointer;border:none;border-radius:10px;padding:8px 14px;color:var(--ink);
  background:#121a25;transition:all .15s ease;font-size:13px;font-weight:500;
}
button:hover{opacity:.9;transform:translateY(-1px)}
button:active{transform:translateY(0)}
.btn-primary{background:linear-gradient(135deg,#00ff88,#00cc6a);color:#000;font-weight:600;box-shadow:0 2px 8px rgba(0,255,136,.3)}
.btn-success{background:linear-gradient(135deg,#00ff88,#00cc6a);color:#000;font-weight:600;box-shadow:0 2px 8px rgba(0,255,136,.3)}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
.btn-ghost{background:rgba(0,255,136,.1);color:var(--brand)}
.light .btn-primary{background:linear-gradient(135deg,#00cc6a,#00aa55);color:#000}
.light .btn-ghost{background:#e0fff0;color:#006633}

.kbd{
  font-family:ui-monospace,Menlo,Consolas,monospace;font-size:11px;
  padding:3px 7px;border-radius:6px;
  background:#0d1622;border:1px solid #1b2a45;color:#cfe1ff;
  display:inline-block;min-width:24px;text-align:center;
}
.light .kbd{background:#eaf2ff;border-color:#c7d7f0;color:#2a4e88}

/* Header */
header{
  display:flex;align-items:center;justify-content:space-between;gap:16px;
  padding:12px 20px;
  background:linear-gradient(180deg,#0e141a,#0a0f15);
  border-bottom:1px solid var(--edge);
  position:sticky;top:0;z-index:100;
  box-shadow:0 2px 12px rgba(0,0,0,.5);
}
.light header{background:linear-gradient(180deg,#f6f9ff,#ffffff);box-shadow:0 2px 12px rgba(0,0,0,.1)}

.brand{display:flex;align-items:center;gap:12px}
.brand h1{
  margin:0;font-size:16px;font-weight:800;
  background:linear-gradient(135deg,#00ff88,#00cc6a);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.version{
  font-size:11px;color:var(--muted);background:var(--chip);
  padding:3px 8px;border-radius:8px;font-weight:600;
}

.controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.input,select{
  background:#0b1117;border:1px solid var(--edge);color:var(--ink);
  padding:8px 12px;border-radius:8px;font-size:13px;
}
.light .input,.light select{background:#fff}

.status{font-size:12px;color:var(--muted);font-weight:500}
.status.saving::before{content:"üíæ Saving‚Ä¶ ";color:var(--warn)}
.status.saved::before{content:"‚úì Saved ";color:var(--ok)}

/* Icon Buttons */
.icon-btn{
  width:36px;height:36px;padding:0;display:flex;align-items:center;
  justify-content:center;border-radius:8px;font-size:18px;
}

/* Main layout */
.main{display:flex;min-height:calc(100vh - 60px)}

.left{
  flex:0 0 52%;min-width:400px;max-width:80vw;
  display:flex;flex-direction:column;
  background:var(--panel2);border-right:1px solid var(--edge);
}

.divider{
  width:5px;cursor:col-resize;
  background:linear-gradient(180deg,#111827,#020617);
  border-left:1px solid #020617;border-right:1px solid #1f2933;
}
.light .divider{
  background:linear-gradient(180deg,#e5edff,#d0ddff);
  border-left:1px solid #d0ddff;border-right:1px solid #a5b4fc;
}

.right{
  flex:1 1 auto;min-width:400px;
  position:sticky;top:60px;
  background:linear-gradient(135deg,#000000,#0a0a0a);
  height:calc(100vh - 60px);overflow-y:auto;
}
.light .right{background:linear-gradient(135deg,#f8fafc,#f1f5f9)}

/* Dashboard */
.dashboard{
  padding:16px 20px;background:var(--panel);
  border-bottom:1px solid var(--edge);
  display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;
}
.stat{
  background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(139,92,246,.08));
  padding:12px 16px;border-radius:12px;
  border:1px solid rgba(59,130,246,.15);
}
.stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.stat-value{font-size:22px;font-weight:800;margin:4px 0;color:var(--ink)}
.stat-change{font-size:11px;color:var(--ok)}

/* Toolbar */
.toolbar{
  padding:14px 20px;background:var(--panel);
  border-bottom:1px solid var(--edge);
  display:flex;gap:12px;align-items:center;flex-wrap:wrap;
}
.toolbar-group{display:flex;gap:8px;align-items:center}
.toolbar-divider{width:1px;height:28px;background:var(--edge)}

/* Filters */
.filters{
  padding:14px 20px;background:var(--panel);
  border-bottom:1px solid var(--edge);
  display:flex;gap:10px;align-items:center;flex-wrap:wrap;
}
.chip{
  padding:6px 12px;border-radius:8px;font-size:12px;font-weight:500;
  background:var(--chip);color:var(--muted);cursor:pointer;
  transition:all .15s ease;border:1px solid transparent;
}
.chip:hover{background:var(--chipOn);color:var(--chipL)}
.chip.active{background:var(--brand);color:#fff;border-color:var(--brand)}

/* Table */
.table-wrap{flex:1;position:relative;max-height:calc(100vh - 200px);overflow-y:auto}
table{
  width:100%;border-collapse:collapse;
  background:var(--panel);font-size:13px;
}
thead{position:sticky;top:0;z-index:10;background:var(--panel);box-shadow:0 2px 8px rgba(0,0,0,.1)}
th{
  padding:12px 16px;text-align:left;font-weight:600;font-size:12px;
  color:var(--muted);text-transform:uppercase;letter-spacing:.5px;
  border-bottom:2px solid var(--edge);cursor:pointer;
  user-select:none;white-space:nowrap;
}
/* Column widths for better table layout */
th:nth-child(1), td:nth-child(1){width:90px} /* Date */
th:nth-child(2), td:nth-child(2){width:180px;max-width:200px} /* Merchant */
th:nth-child(3), td:nth-child(3){width:90px} /* Amount */
th:nth-child(4), td:nth-child(4){width:130px} /* Category */
th:nth-child(5), td:nth-child(5){width:100px} /* Business */
th:nth-child(6), td:nth-child(6){width:80px} /* Status */
th:nth-child(7), td:nth-child(7){width:60px;text-align:center} /* Receipt */
th:nth-child(8), td:nth-child(8){min-width:150px} /* Description */
th:hover{background:rgba(59,130,246,.05);color:var(--brand)}
th.sorted::after{content:" ‚ñº";font-size:10px}
th.sorted.asc::after{content:" ‚ñ≤"}

td{
  padding:12px 16px;border-bottom:1px solid var(--edge);
  vertical-align:middle;
}
tbody tr{cursor:pointer;transition:background .15s ease}
tbody tr:hover{background:rgba(59,130,246,.05)}
tbody tr.selected{
  background:rgba(59,130,246,.12);
  box-shadow:inset 3px 0 0 var(--brand);
}

/* Newly matched receipts - highlight with pulsing green */
tbody tr.newly-matched{
  background:rgba(34,197,94,0.08);
  animation:pulseGreen 2s ease infinite;
  border-left:4px solid #22c55e;
}
tbody tr.newly-matched:hover{background:rgba(34,197,94,0.12)}
tbody tr.newly-matched.selected{
  background:rgba(34,197,94,0.15);
  box-shadow:inset 3px 0 0 #22c55e;
}

@keyframes pulseGreen{
  0%, 100%{background:rgba(34,197,94,0.08)}
  50%{background:rgba(34,197,94,0.15)}
}

.amount{font-variant-numeric:tabular-nums;font-weight:600}
.pos{color:var(--pos)}
.neg{color:var(--neg)}

/* Date Cell Styling */
.date-cell{
  background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(139,92,246,.12));
  border:1px solid rgba(59,130,246,.2);
  border-radius:8px;padding:6px 10px;display:inline-block;
  min-width:70px;text-align:center;
}
.date-month-day{
  font-size:13px;font-weight:700;color:var(--ink);
  display:block;letter-spacing:0.3px;
}
.date-year{
  font-size:10px;color:var(--muted);font-weight:600;
  margin-top:2px;display:block;
}
.light .date-cell{
  background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(139,92,246,.08));
  border-color:rgba(59,130,246,.25);
}

/* Notes Cell */
.notes-cell{
  max-width:300px;overflow:hidden;text-overflow:ellipsis;
  white-space:nowrap;cursor:pointer;color:var(--muted);
  font-size:12px;
}
.notes-cell:hover{color:var(--ink);}
.notes-cell.empty{font-style:italic;opacity:0.5}
.notes-input{
  width:100%;background:var(--panel);border:1px solid var(--brand);
  color:var(--ink);padding:4px 8px;border-radius:4px;font-size:12px;
}

.badge{
  display:inline-block;padding:3px 8px;border-radius:6px;
  font-size:11px;font-weight:600;text-transform:uppercase;
}
.badge-good{background:rgba(34,197,94,.15);color:var(--ok)}
.badge-bad{background:rgba(239,68,68,.15);color:var(--bad)}
.badge-pending{background:rgba(234,179,8,.15);color:var(--warn)}
.badge-refund{background:rgba(6,182,212,.15);color:#06b6d4}

/* Refund row styling */
tbody tr.refund-row{background:rgba(6,182,212,.05)}
tbody tr.refund-row:hover{background:rgba(6,182,212,.1)}
tbody tr.refund-row.selected{background:rgba(6,182,212,.15);box-shadow:inset 3px 0 0 #06b6d4}

/* MI Enhanced Styles */
.merchant-cell{display:flex;align-items:center;gap:6px}
.sub-badge{
  display:inline-block;padding:2px 6px;border-radius:4px;
  font-size:9px;font-weight:700;background:rgba(147,51,234,.15);
  color:#a855f7;text-transform:uppercase;
}
.category-badge{
  display:inline-block;padding:3px 8px;border-radius:6px;
  font-size:10px;font-weight:500;background:rgba(59,130,246,.1);
  color:var(--muted);white-space:nowrap;
}

/* Confidence Indicator */
.confidence-indicator{
  display:inline-flex;align-items:center;gap:6px;
  font-size:11px;font-weight:600;
}
.confidence-dot{
  width:10px;height:10px;border-radius:50%;
  display:inline-block;
  box-shadow:0 0 8px currentColor;
}
.conf-excellent{color:#10b981}  /* 90-100% - Bright Green */
.conf-very-good{color:#3b82f6}  /* 80-89% - Blue */
.conf-good{color:#8b5cf6}       /* 70-79% - Purple */
.conf-fair{color:#f59e0b}       /* 60-69% - Orange */
.conf-low{color:#ef4444}        /* <60% - Red */
.conf-none{color:#6b7280}       /* No score - Gray */

/* Notification Badge (for missing receipts counter) */
.chip-with-badge{position:relative}
.notification-badge{
  position:absolute;top:-6px;right:-6px;
  background:linear-gradient(135deg,#ef4444,#dc2626);
  color:#fff;font-size:10px;font-weight:700;
  padding:2px 6px;border-radius:10px;
  box-shadow:0 2px 8px rgba(239,68,68,.4);
  min-width:20px;text-align:center;
  opacity:0;
  transition:opacity .2s ease;
  pointer-events:none;
}
/* Show badge on hover */
.chip-with-badge:hover .notification-badge{
  opacity:1;
}

/* Receipt Viewer */
.viewer-container{
  height:100%;display:flex;flex-direction:column;
}
.viewer-header{
  padding:16px 20px;background:var(--panel);
  border-bottom:1px solid var(--edge);
  display:flex;justify-content:space-between;align-items:center;
}
.viewer-title{font-size:14px;font-weight:700;color:var(--ink)}
.viewer-controls{display:flex;gap:8px}

.viewer-content{
  flex:1;position:relative;overflow:hidden;
  background:repeating-conic-gradient(#0a0a0a 0% 25%,#0f0f0f 0% 50%) 50%/20px 20px;
}
.light .viewer-content{
  background:repeating-conic-gradient(#f5f5f5 0% 25%,#fafafa 0% 50%) 50%/20px 20px;
}

.panzoom-wrap{
  width:100%;height:100%;display:flex;align-items:center;justify-content:center;
  position:relative;
}
.panzoom-wrap img{
  width:100%;height:auto;object-fit:contain;
  border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5);
  cursor:grab;
  transform-origin:center center;
}
.panzoom-wrap img:active{cursor:grabbing}

.no-receipt{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  text-align:center;color:var(--muted);
}
.no-receipt-icon{font-size:64px;opacity:.3;margin-bottom:16px}
.no-receipt-text{font-size:14px}

/* Receipt indicator in table */
.receipt-indicator{font-weight:bold;font-size:14px}
.receipt-indicator.has-receipt{color:var(--ok)}
.receipt-indicator.no-receipt{color:var(--muted);opacity:0.5}

/* Zoom Controls */
.zoom-controls{
  position:absolute;bottom:20px;right:20px;
  display:flex;flex-direction:column;gap:8px;
  background:rgba(0,0,0,.8);padding:8px;border-radius:12px;
  backdrop-filter:blur(10px);
}
.light .zoom-controls{background:rgba(255,255,255,.9)}

/* Modals */
.modal-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.75);
  display:none;align-items:center;justify-content:center;
  z-index:10000;backdrop-filter:blur(8px);
  animation:fadeIn .2s ease;
}
.modal-overlay.active{display:flex}

/* Progress Modal - Highest Z-Index */
#progress-modal{z-index:10001!important}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}

.modal{
  background:var(--panel);border-radius:16px;
  max-width:600px;width:90%;max-height:80vh;
  box-shadow:0 24px 48px rgba(0,0,0,.5);
  animation:slideUp .3s ease;
  display:flex;flex-direction:column;
}
.modal-header{
  padding:20px 24px;border-bottom:1px solid var(--edge);
  display:flex;justify-content:space-between;align-items:center;
}
.modal-title{font-size:18px;font-weight:700;color:var(--ink)}
.modal-close{
  width:32px;height:32px;border-radius:8px;
  background:rgba(239,68,68,.1);color:var(--bad);
  font-size:20px;line-height:1;
}
.modal-body{padding:24px;overflow-y:auto;flex:1}
.modal-footer{
  padding:16px 24px;border-top:1px solid var(--edge);
  display:flex;justify-content:flex-end;gap:10px;
}

/* Hotkey Menu */
.hotkey-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;
}
.hotkey-section{
  background:var(--panel2);padding:16px;border-radius:12px;
  border:1px solid var(--edge);
}
.hotkey-section-title{
  font-size:13px;font-weight:700;color:var(--brand);
  margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px;
}
.hotkey-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05);
}
.hotkey-item:last-child{border-bottom:none}
.hotkey-desc{font-size:13px;color:var(--ink)}
.hotkey-key{display:flex;gap:4px}

/* Settings Panel */
.settings-section{
  background:var(--panel2);padding:20px;border-radius:12px;
  border:1px solid var(--edge);margin-bottom:16px;
}
.settings-section-title{
  font-size:15px;font-weight:700;color:var(--ink);margin-bottom:16px;
}
.settings-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05);
}
.settings-row:last-child{border-bottom:none}
.settings-label{font-size:13px;color:var(--ink)}
.settings-desc{font-size:12px;color:var(--muted);margin-top:4px}

/* Quick Viewer Enhanced */
.quick-viewer{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.95);z-index:2000;
  display:none;align-items:center;justify-content:center;
  backdrop-filter:blur(12px);
}
.quick-viewer.active{display:flex}

.quick-viewer-content{
  max-width:1200px;width:95%;max-height:95vh;
  background:var(--panel);border-radius:20px;
  box-shadow:0 32px 64px rgba(0,0,0,.8);
  display:flex;flex-direction:column;
  overflow:hidden;
}
.quick-viewer-header{
  padding:20px 24px;background:linear-gradient(135deg,#0e141a,#0a0f15);
  border-bottom:1px solid var(--edge);
  display:flex;justify-content:space-between;align-items:center;
}
.quick-viewer-title{font-size:18px;font-weight:700;color:var(--ink)}
.quick-viewer-body{
  flex:1;display:flex;gap:24px;padding:24px;overflow:auto;
}
.quick-viewer-image{
  flex:1;display:flex;align-items:center;justify-content:center;
  background:repeating-conic-gradient(#0a0a0a 0% 25%,#0f0f0f 0% 50%) 50%/20px 20px;
  border-radius:12px;min-height:400px;position:relative;overflow:hidden;
  cursor:grab;
}
.quick-viewer-image:active{cursor:grabbing}
.quick-viewer-image img{
  width:100%;height:auto;object-fit:contain;
  border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.5);
  animation:fadeIn 0.2s ease;
  transform-origin:center center;
}

@keyframes fadeIn{
  from{opacity:0;transform:scale(0.95)}
  to{opacity:1;transform:scale(1)}
}

/* Quick Viewer Zoom Controls */
.quick-zoom-controls{
  position:absolute;top:10px;right:10px;z-index:10;
  display:flex;gap:6px;
}
.quick-zoom-btn{
  background:rgba(0,0,0,0.7);color:#fff;border:none;
  width:36px;height:36px;border-radius:8px;cursor:pointer;
  font-size:18px;font-weight:600;
  transition:all 0.2s ease;backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;
}
.quick-zoom-btn:hover{background:rgba(59,130,246,0.9);transform:scale(1.1)}
.quick-viewer-data{
  width:400px;background:var(--panel2);padding:20px;border-radius:12px;
  border:1px solid var(--edge);overflow-y:auto;
}
.data-row{
  margin-bottom:16px;padding-bottom:16px;
  border-bottom:1px solid rgba(255,255,255,.05);
}
.data-row:last-child{border-bottom:none}
.data-label{
  font-size:11px;color:var(--muted);text-transform:uppercase;
  letter-spacing:.5px;font-weight:600;margin-bottom:6px;
}
.data-value{
  font-size:16px;color:var(--ink);font-weight:600;
  word-break:break-word;
}
.data-value.large{font-size:24px}

/* Quick Viewer Interactive Fields */
.quick-field-select{
  width:100%;padding:8px 12px;font-size:14px;
  background:var(--panel2);color:var(--ink);
  border:2px solid rgba(255,255,255,.1);border-radius:6px;
  cursor:pointer;transition:all 0.2s ease;
  font-weight:600;
}
.quick-field-select:hover{
  border-color:rgba(59,130,246,0.5);
  background:rgba(59,130,246,0.05);
}
.quick-field-select:focus{
  outline:none;border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,0.1);
}
.quick-field-textarea{
  width:100%;padding:8px 12px;font-size:13px;
  background:var(--panel2);color:var(--ink);
  border:2px solid rgba(255,255,255,.1);border-radius:6px;
  resize:vertical;min-height:60px;max-height:120px;
  font-family:inherit;transition:all 0.2s ease;
  line-height:1.5;
}
.quick-field-textarea:hover{
  border-color:rgba(59,130,246,0.5);
  background:rgba(59,130,246,0.05);
}
.quick-field-textarea:focus{
  outline:none;border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,0.1);
}

/* Matched Field Highlighting */
.data-row.matched{
  background:rgba(34,197,94,0.1);
  border:2px solid rgba(34,197,94,0.3);
  border-radius:8px;padding:12px;
  animation:pulseMatch 2s ease infinite;
  position:relative;
}
.data-row.matched::before{
  content:'‚úì';
  position:absolute;left:8px;top:50%;transform:translateY(-50%);
  font-size:18px;color:#22c55e;font-weight:700;
}
.data-row.matched .data-label{margin-left:20px}
.data-row.matched .data-value{margin-left:20px;color:#22c55e}

@keyframes pulseMatch{
  0%, 100%{border-color:rgba(34,197,94,0.3)}
  50%{border-color:rgba(34,197,94,0.5)}
}

/* Match Confidence Badge */
.match-confidence{
  position:absolute;top:60px;left:50%;transform:translateX(-50%);
  background:rgba(34,197,94,0.9);color:#fff;
  padding:6px 12px;border-radius:20px;
  font-size:11px;font-weight:700;z-index:10;
  backdrop-filter:blur(4px);display:flex;align-items:center;gap:6px;
}
.match-confidence.high{background:rgba(34,197,94,0.9)}
.match-confidence.medium{background:rgba(234,179,8,0.9)}
.match-confidence.low{background:rgba(239,68,68,0.9)}

/* Quick Viewer Navigation */
.quick-nav-btn{
  position:absolute;top:50%;transform:translateY(-50%);
  background:rgba(59,130,246,0.9);color:#fff;border:none;
  width:50px;height:50px;border-radius:50%;cursor:pointer;
  font-size:24px;font-weight:700;z-index:10;
  transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;
}
.quick-nav-btn:hover{background:rgba(59,130,246,1);transform:translateY(-50%) scale(1.1)}
.quick-nav-btn:disabled{opacity:0.3;cursor:not-allowed;transform:translateY(-50%)}
.quick-nav-btn.prev{left:20px}
.quick-nav-btn.next{right:20px}

.quick-position{
  position:absolute;top:20px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.8);color:#fff;padding:8px 16px;
  border-radius:20px;font-size:12px;font-weight:600;z-index:10;
  backdrop-filter:blur(4px);
}

.quick-shortcuts{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.8);color:#fff;padding:8px 12px;
  border-radius:8px;font-size:11px;z-index:10;
  backdrop-filter:blur(4px);display:flex;gap:12px;flex-wrap:wrap;
  align-items:center;justify-content:center;max-width:90%;
}
.quick-shortcuts span{opacity:0.7}
.quick-shortcuts kbd{
  background:rgba(255,255,255,0.15);padding:2px 6px;border-radius:4px;
  font-family:ui-monospace,monospace;font-size:10px;font-weight:600;
  box-shadow:0 2px 4px rgba(0,0,0,0.3);
}

/* Toast Notifications */
.toast{
  position:fixed;bottom:24px;right:24px;
  background:var(--panel);padding:16px 20px;border-radius:12px;
  border:1px solid var(--edge);box-shadow:0 8px 24px rgba(0,0,0,.3);
  display:none;align-items:center;gap:12px;
  z-index:1001;animation:slideUp .3s ease;
}
.toast.active{display:flex}
.toast-icon{font-size:20px}
.toast-message{font-size:13px;color:var(--ink)}

/* Loading Spinner */
.spinner{
  width:20px;height:20px;border:3px solid rgba(59,130,246,.2);
  border-top-color:var(--brand);border-radius:50%;
  animation:spin 0.8s linear infinite;display:inline-block;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Loading Overlay for batch operations */
.loading-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:none;align-items:center;justify-content:center;flex-direction:column;
  z-index:2000;backdrop-filter:blur(4px);gap:16px;
}
.loading-overlay.active{display:flex}
.loading-overlay .spinner-large{
  width:48px;height:48px;border:4px solid rgba(59,130,246,.2);
  border-top-color:var(--brand);border-radius:50%;
  animation:spin 0.8s linear infinite;
}
.loading-overlay .loading-text{
  font-size:16px;font-weight:600;color:var(--ink);
}
.loading-overlay .loading-progress{
  font-size:13px;color:var(--muted);
}

/* Responsive */
@media(max-width:1024px){
  .left{flex:0 0 100%;max-width:100%}
  .right{display:none}
  .main{flex-direction:column}
}

/* OCR Drag and Drop */
.ocr-drop-zone{
  border:2px dashed var(--edge);
  border-radius:12px;
  padding:32px 24px;
  text-align:center;
  background:var(--panel2);
  margin-bottom:20px;
  transition:all .2s ease;
  cursor:pointer;
}
.ocr-drop-zone:hover{
  border-color:var(--brand);
  background:rgba(59,130,246,.05);
}
.ocr-drop-zone.dragover{
  border-color:var(--brand);
  background:rgba(59,130,246,.1);
  border-style:solid;
}
.ocr-drop-zone.processing{
  border-color:var(--warn);
  background:rgba(255,216,94,.05);
}
.ocr-drop-icon{
  font-size:48px;
  margin-bottom:12px;
  opacity:.7;
}
.ocr-drop-text{
  font-size:15px;
  font-weight:600;
  color:var(--ink);
  margin-bottom:6px;
}
.ocr-drop-hint{
  font-size:12px;
  color:var(--muted);
}
.ocr-status{
  margin-top:12px;
  padding:10px 16px;
  background:var(--panel);
  border-radius:8px;
  font-size:12px;
  display:none;
}
.ocr-status.show{display:block}
.ocr-status.success{
  background:rgba(47,255,162,.1);
  border:1px solid rgba(47,255,162,.3);
  color:var(--ok);
}
.ocr-status.error{
  background:rgba(255,78,106,.1);
  border:1px solid rgba(255,78,106,.3);
  color:var(--bad);
}
.ocr-preview{
  display:none;
  margin-top:12px;
  max-height:120px;
  border-radius:8px;
  object-fit:contain;
}
.ocr-preview.show{display:block}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="brand">
    <h1>üßæ Tallyups</h1>
    <span class="version">v2.0</span>
  </div>
  <!-- Navigation Tabs -->
  <div style="display:flex;gap:8px;margin-left:auto">
    <button id="nav-home" class="btn-ghost" onclick="switchPage('home')" style="border-radius:8px;font-weight:600">
      üè† Home
    </button>
    <button id="nav-incoming" class="btn-ghost" onclick="switchPage('incoming')" style="border-radius:8px;font-weight:600;position:relative">
      üì¨ Incoming
      <span id="incoming-badge" style="display:none;position:absolute;top:-4px;right:-4px;background:var(--danger);color:white;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:700"></span>
    </button>
    <button id="nav-reports" class="btn-ghost" onclick="switchPage('reports')" style="border-radius:8px;font-weight:600">
      üìä Reports
    </button>
    <button id="nav-stats" class="btn-ghost" onclick="switchPage('stats')" style="border-radius:8px;font-weight:600">
      üìà Stats
    </button>
  </div>

  <div class="controls">
    <button class="btn-ghost icon-btn" onclick="toggleHotkeyMenu()" title="Keyboard Shortcuts (?)">‚å®Ô∏è</button>
    <button class="btn-ghost icon-btn" onclick="toggleSettings()" title="Settings">‚öôÔ∏è</button>
    <button class="btn-ghost icon-btn" onclick="toggleTheme()" title="Toggle Theme">üé®</button>
    <button class="btn-ghost icon-btn" onclick="logout()" title="Logout">üö™</button>
    <span class="status" id="status"></span>
  </div>
</header>

<!-- Main Layout -->
<!-- Home Page (default) -->
<div id="home-page" class="page-content">
<div class="main">
  <!-- Left Panel -->
  <div class="left">
    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
      <div class="stat">
        <div class="stat-label">Down Home</div>
        <div class="stat-value" id="down-home-total">$0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Music City Rodeo</div>
        <div class="stat-value" id="mcr-total">$0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Personal</div>
        <div class="stat-value" id="personal-total">$0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Credit Card Payments</div>
        <div class="stat-value pos" id="payments-total">$0</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-group">
        <button class="btn-primary" onclick="openManualEntryModal()" title="Add Manual Expense">
          ‚ûï Manual Entry
        </button>
        <button class="btn-primary" onclick="smartSearchMissing()" title="Smart search: AI match, Gmail, and iMessage (learns patterns over time)" style="background:linear-gradient(135deg, var(--brand) 0%, #EA4335 50%, #0B84FE 100%)">
          üîç Smart Search
        </button>
        <button class="btn-primary" onclick="processMerchantIntelligence()" title="Process Merchant Intelligence" style="background:var(--brand2)">
          üß† Process MI
        </button>
        <button class="btn-success" onclick="saveCSV()" title="Save Changes">
          üíæ Save
        </button>
      </div>
      <div class="toolbar-divider"></div>
      <div class="toolbar-group">
        <input type="text" class="input" id="search" placeholder="Search..." style="width:200px">
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <span style="font-size:12px;color:var(--muted);font-weight:600">FILTERS:</span>
      <div class="chip chip-with-badge" data-filter="all">
        All <span class="notification-badge" id="all-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="needs-review">
        Needs Review <span class="notification-badge" id="needs-review-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="good">
        Good <span class="notification-badge" id="good-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="bad">
        Bad <span class="notification-badge" id="bad-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="missing">
        Missing Receipts <span class="notification-badge" id="missing-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="with-receipts">
        With Receipts <span class="notification-badge" id="with-receipts-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="not-needed">
        Not Needed <span class="notification-badge" id="not-needed-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="refunds">
        Refunds <span class="notification-badge" id="refunds-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-filter="already-submitted">
        Already Submitted <span class="notification-badge" id="already-submitted-count">0</span>
      </div>
      <div class="toolbar-divider"></div>
      <span style="font-size:12px;color:var(--muted);font-weight:600">BUSINESS:</span>
      <div class="chip chip-with-badge" data-biz="Music City Rodeo">
        MCR <span class="notification-badge" id="mcr-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-biz="Down Home">
        Down Home <span class="notification-badge" id="downhome-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-biz="Personal">
        Personal <span class="notification-badge" id="personal-count">0</span>
      </div>
      <div class="chip chip-with-badge" data-biz="Unassigned">
        Unassigned <span class="notification-badge" id="unassigned-count">0</span>
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrap">
      <table id="dataTable">
        <thead>
          <tr>
            <th data-sort="Chase Date">Date</th>
            <th data-sort="MI Merchant">Merchant</th>
            <th data-sort="Chase Amount">Amount</th>
            <th data-sort="MI Category">Category</th>
            <th data-sort="Business Type">Business</th>
            <th data-sort="Review Status">Status</th>
            <th data-sort="Receipt File">Receipt</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Resizable Divider -->
  <div class="divider" id="divider"></div>

  <!-- Right Panel: Receipt Viewer -->
  <div class="right">
    <div class="viewer-container">
      <div class="viewer-header">
        <div class="viewer-title" id="viewer-title">Receipt Viewer</div>
        <div class="viewer-controls">
          <button class="icon-btn" onclick="rotateImage()" title="Rotate (R)">üîÑ</button>
          <button class="icon-btn" onclick="resetZoom()" title="Reset (0)">‚äô</button>
          <button class="icon-btn" onclick="openQuickViewer()" title="Quick View (Q)">‚õ∂</button>
        </div>
      </div>
      <div class="viewer-content" id="viewer-content">
        <div class="panzoom-wrap" id="panzoom-wrap">
          <div class="no-receipt">
            <div class="no-receipt-icon">üìÑ</div>
            <div class="no-receipt-text">Select a transaction to view receipt</div>
          </div>
        </div>
        <div class="zoom-controls">
          <button class="icon-btn" onclick="zoomIn()" title="Zoom In (+)">+</button>
          <button class="icon-btn" onclick="zoomOut()" title="Zoom Out (-)">‚àí</button>
          <button class="icon-btn" onclick="resetZoom()" title="Reset (0)">0</button>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
<!-- End Home Page -->

<!-- Reports Page -->
<div id="reports-page" class="page-content" style="display:none">
  <div style="max-width:1400px;margin:0 auto;padding:24px">
    <!-- Hero Header -->
    <div style="margin-bottom:32px;background:linear-gradient(135deg, rgba(0,255,136,.1), rgba(0,204,106,.1));padding:32px;border-radius:16px;border:1px solid rgba(0,255,136,.2)">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
        <div style="width:56px;height:56px;background:linear-gradient(135deg, #00ff88, #00cc6a);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 16px rgba(0,255,136,.4)">üìä</div>
        <div>
          <h2 style="margin:0;font-size:28px;font-weight:800;background:linear-gradient(135deg, #00ff88, #00cc6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Expense Reports</h2>
          <p style="margin:4px 0 0 0;color:var(--muted);font-size:14px">Create, manage, and export professional expense reports</p>
        </div>
      </div>
    </div>

    <!-- Report Builder Card -->
    <div style="background:linear-gradient(145deg, var(--panel), var(--panel2));padding:28px;border-radius:16px;border:1px solid var(--edge);margin-bottom:28px;box-shadow:0 4px 24px rgba(0,0,0,.2)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
        <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">‚ú®</div>
        <h3 style="margin:0;font-size:18px;font-weight:700">Create New Report</h3>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:24px">
        <div>
          <label style="display:block;margin-bottom:10px;font-size:13px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Business Type *</label>
          <select id="report-business-type" class="input" style="width:100%;padding:14px;border-radius:10px;font-size:14px">
            <option value="">Select Business Type</option>
            <option value="Music City Rodeo">Music City Rodeo</option>
            <option value="Down Home">Down Home</option>
            <option value="Personal">Personal</option>
          </select>
        </div>

        <div>
          <label style="display:block;margin-bottom:10px;font-size:13px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Date From</label>
          <input type="date" id="report-date-from" class="input" style="width:100%;padding:14px;border-radius:10px;font-size:14px">
        </div>

        <div>
          <label style="display:block;margin-bottom:10px;font-size:13px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Date To</label>
          <input type="date" id="report-date-to" class="input" style="width:100%;padding:14px;border-radius:10px;font-size:14px">
        </div>
      </div>

      <button class="btn-primary" onclick="loadReportPreview()" style="width:100%;padding:16px;font-size:15px;font-weight:700;border-radius:12px;background:linear-gradient(135deg, #00ff88, #00cc6a);color:#000;box-shadow:0 4px 16px rgba(0,255,136,.4);transition:all .2s">
        üîç Preview Expenses
      </button>
    </div>

    <!-- Report Preview -->
    <div id="report-preview-section" style="display:none">
      <div style="background:var(--panel);padding:24px;border-radius:12px;border:1px solid var(--edge);margin-bottom:24px">
        <!-- Summary Stats -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px">
          <div style="background:linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);color:#000;padding:20px;border-radius:10px">
            <div style="font-size:13px;opacity:0.8;margin-bottom:4px;font-weight:600">Total Amount</div>
            <div style="font-size:32px;font-weight:700" id="report-total-amount">$0.00</div>
          </div>
          <div style="background:var(--panel2);padding:20px;border-radius:10px;border:1px solid var(--edge)">
            <div style="font-size:13px;color:var(--muted);margin-bottom:4px">Expenses</div>
            <div style="font-size:32px;font-weight:700;color:#00ff88" id="report-expense-count">0</div>
          </div>
          <div style="background:var(--panel2);padding:20px;border-radius:10px;border:1px solid var(--edge)">
            <div style="font-size:13px;color:var(--muted);margin-bottom:4px">Receipts</div>
            <div style="font-size:32px;font-weight:700;color:#00ff88" id="report-receipt-count">0</div>
          </div>
        </div>

        <!-- Actions -->
        <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center">
          <input type="text" id="report-name" class="input" placeholder="Report Name (e.g., Q1 2024 Down Home)" style="flex:1">
          <button class="btn-success" onclick="submitReport()">
            üì§ Submit Report
          </button>
        </div>

        <!-- Additional Actions (shown after report is submitted) -->
        <div id="report-actions" style="display:none;padding:16px;background:var(--panel2);border-radius:8px;margin-bottom:20px">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
            <button class="btn-primary" onclick="viewReportPage()" id="view-report-btn">
              üìä View Report Page
            </button>
            <button class="btn-primary" onclick="downloadReportCSV()" id="download-csv-btn">
              üìÑ Download CSV
            </button>
            <button class="btn-primary" onclick="downloadReportReceipts()" id="download-receipts-btn">
              üì¶ Download Receipts ZIP
            </button>
            <button class="btn-secondary" onclick="copyReportLink()" id="copy-link-btn">
              üîó Copy Report Link
            </button>
            <button class="btn-secondary" onclick="startNewReport()" style="margin-left:auto">
              ‚ûï New Report
            </button>
          </div>
        </div>

        <div style="max-height:400px;overflow-y:auto;border:1px solid var(--edge);border-radius:8px">
          <table style="width:100%;border-collapse:collapse">
            <thead style="background:var(--panel2);position:sticky;top:0">
              <tr>
                <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Date</th>
                <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Description</th>
                <th style="padding:10px;text-align:right;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Amount</th>
                <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Category</th>
                <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px;color:var(--muted)">Notes</th>
              </tr>
            </thead>
            <tbody id="report-preview-table">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Archived Reports -->
    <div style="background:linear-gradient(145deg, var(--panel), var(--panel2));padding:28px;border-radius:16px;border:1px solid var(--edge);box-shadow:0 4px 24px rgba(0,0,0,.2)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
        <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üìÅ</div>
        <div>
          <h3 style="margin:0;font-size:18px;font-weight:700">Submitted Reports</h3>
          <p style="margin:4px 0 0 0;font-size:13px;color:var(--muted)">Previously submitted expense reports</p>
        </div>
      </div>

      <div id="archived-reports-list" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(340px, 1fr));gap:20px">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>
</div>
<!-- End Reports Page -->

<!-- Stats Page -->
<div id="stats-page" class="page-content" style="display:none">
  <div style="max-width:1400px;margin:0 auto;padding:24px">
    <!-- Hero Header -->
    <div style="margin-bottom:32px;background:linear-gradient(135deg, rgba(0,255,136,.1), rgba(0,204,106,.1));padding:32px;border-radius:16px;border:1px solid rgba(0,255,136,.2)">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:16px">
          <div style="width:56px;height:56px;background:linear-gradient(135deg, #00ff88, #00cc6a);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 16px rgba(0,255,136,.4)">üìà</div>
          <div>
            <h2 style="margin:0;font-size:28px;font-weight:800;background:linear-gradient(135deg, #00ff88, #00cc6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Financial Analytics</h2>
            <p style="margin:4px 0 0 0;color:var(--muted);font-size:14px">Real-time spending insights and data</p>
          </div>
        </div>
        <button onclick="loadStatsPage()" style="background:rgba(0,255,136,.2);border:1px solid rgba(0,255,136,.3);color:#00ff88;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600">üîÑ Refresh</button>
      </div>
    </div>

    <!-- Overview Cards Row -->
    <div style="display:grid;grid-template-columns:repeat(5, 1fr);gap:16px;margin-bottom:28px">
      <div style="background:linear-gradient(135deg, #00ff88, #00cc6a);padding:20px;border-radius:12px;color:#000">
        <div style="font-size:12px;font-weight:600;opacity:0.7;margin-bottom:6px">TOTAL SPENT</div>
        <div style="font-size:28px;font-weight:800" id="stats-total-spent">$0</div>
        <div style="font-size:11px;margin-top:6px;opacity:0.6" id="stats-total-count">0 transactions</div>
      </div>
      <div style="background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--edge)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">RECEIPTS MATCHED</div>
        <div style="font-size:28px;font-weight:800;color:#00ff88" id="stats-receipts-matched">0</div>
        <div style="font-size:11px;margin-top:6px;color:var(--muted)" id="stats-match-rate">0% coverage</div>
      </div>
      <div style="background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--edge)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">FROM GMAIL</div>
        <div style="font-size:28px;font-weight:800;color:#00ff88" id="stats-gmail-receipts">0</div>
        <div style="font-size:11px;margin-top:6px;color:var(--muted)" id="stats-gmail-pct">0% of receipts</div>
      </div>
      <div style="background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--edge)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">REFUNDS</div>
        <div style="font-size:28px;font-weight:800;color:#00ff88" id="stats-refunds">$0</div>
        <div style="font-size:11px;margin-top:6px;color:var(--muted)" id="stats-refund-count">0 transactions</div>
      </div>
      <div style="background:var(--panel);padding:20px;border-radius:12px;border:1px solid var(--edge)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">PAYMENTS</div>
        <div style="font-size:28px;font-weight:800;color:#00ff88" id="stats-payments">$0</div>
        <div style="font-size:11px;margin-top:6px;color:var(--muted)" id="stats-payment-count">0 transactions</div>
      </div>
    </div>

    <!-- Business Type Breakdown & Interest/Fees -->
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-bottom:28px">
      <!-- Business Type Breakdown -->
      <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üè¢</div>
          <h3 style="margin:0;font-size:18px;font-weight:700">By Business Type</h3>
        </div>
        <div id="stats-business-breakdown" style="display:flex;flex-direction:column;gap:16px">
          <!-- Populated by JS -->
          <div style="color:var(--muted);text-align:center;padding:20px">Loading...</div>
        </div>
      </div>

      <!-- Interest & Fees -->
      <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div style="width:36px;height:36px;background:rgba(255,78,106,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üí≥</div>
          <h3 style="margin:0;font-size:18px;font-weight:700">Interest & Fees</h3>
        </div>
        <div id="stats-interest-fees" style="display:flex;flex-direction:column;gap:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--panel2);border-radius:8px">
            <span style="color:var(--muted)">Interest Charges</span>
            <span style="font-weight:700;color:#ff4e6a" id="stats-interest-total">$0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--panel2);border-radius:8px">
            <span style="color:var(--muted)">Fees</span>
            <span style="font-weight:700;color:#ff4e6a" id="stats-fees-total">$0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--panel2);border-radius:8px">
            <span style="color:var(--muted)">Late Charges</span>
            <span style="font-weight:700;color:#ff4e6a" id="stats-late-total">$0</span>
          </div>
          <div style="border-top:1px solid var(--edge);margin-top:8px;padding-top:12px;display:flex;justify-content:space-between;align-items:center">
            <span style="font-weight:600">Total Lost to Fees</span>
            <span style="font-weight:800;color:#ff4e6a;font-size:20px" id="stats-total-fees">$0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Subscriptions Section -->
    <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge);margin-bottom:28px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üîÑ</div>
          <div>
            <h3 style="margin:0;font-size:18px;font-weight:700">Recurring Subscriptions</h3>
            <p style="margin:2px 0 0 0;font-size:12px;color:var(--muted)">Auto-detected recurring charges</p>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:24px;font-weight:800;color:#00ff88" id="stats-monthly-subs">$0</div>
          <div style="font-size:11px;color:var(--muted)">total subscription spend</div>
        </div>
      </div>
      <div id="stats-subscriptions" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));gap:12px">
        <!-- Populated by JS -->
        <div style="color:var(--muted);text-align:center;padding:20px;grid-column:1/-1">Loading subscriptions...</div>
      </div>
    </div>

    <!-- Top Merchants & Categories -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:28px">
      <!-- Top Merchants -->
      <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üè™</div>
          <h3 style="margin:0;font-size:18px;font-weight:700">Top Merchants</h3>
        </div>
        <div id="stats-top-merchants" style="display:flex;flex-direction:column;gap:10px">
          <!-- Populated by JS -->
          <div style="color:var(--muted);text-align:center;padding:20px">Loading...</div>
        </div>
      </div>

      <!-- Top Categories -->
      <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üìÇ</div>
          <h3 style="margin:0;font-size:18px;font-weight:700">Spending by Category</h3>
        </div>
        <div id="stats-top-categories" style="display:flex;flex-direction:column;gap:10px">
          <!-- Populated by JS -->
          <div style="color:var(--muted);text-align:center;padding:20px">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Receipt Source Breakdown -->
    <div style="background:var(--panel);padding:24px;border-radius:14px;border:1px solid var(--edge)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
        <div style="width:36px;height:36px;background:rgba(0,255,136,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üìß</div>
        <h3 style="margin:0;font-size:18px;font-weight:700">Receipt Sources</h3>
      </div>
      <div id="stats-receipt-sources" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(180px, 1fr));gap:16px">
        <!-- Populated by JS -->
        <div style="color:var(--muted);text-align:center;padding:20px;grid-column:1/-1">Loading...</div>
      </div>
    </div>
  </div>
</div>
<!-- End Stats Page -->

<!-- Hotkey Menu Modal -->
<div class="modal-overlay" id="hotkey-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚å®Ô∏è Keyboard Shortcuts</div>
      <button class="modal-close" onclick="toggleHotkeyMenu()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="hotkey-grid">
        <div class="hotkey-section">
          <div class="hotkey-section-title">üé¨ Actions</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">AI Match Receipt</span>
            <span class="hotkey-key"><span class="kbd">A</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Generate AI Note</span>
            <span class="hotkey-key"><span class="kbd">J</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Missing Receipt Form</span>
            <span class="hotkey-key"><span class="kbd">F</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Detach Receipt</span>
            <span class="hotkey-key"><span class="kbd">X</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Save Changes</span>
            <span class="hotkey-key"><span class="kbd">Ctrl</span><span class="kbd">S</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Undo Last Change</span>
            <span class="hotkey-key"><span class="kbd">Ctrl</span><span class="kbd">Z</span></span>
          </div>
        </div>

        <div class="hotkey-section">
          <div class="hotkey-section-title">‚úÖ Review Status</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Mark Good</span>
            <span class="hotkey-key"><span class="kbd">G</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Mark Bad</span>
            <span class="hotkey-key"><span class="kbd">B</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Mark Not Needed</span>
            <span class="hotkey-key"><span class="kbd">N</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Clear Status</span>
            <span class="hotkey-key"><span class="kbd">C</span></span>
          </div>
        </div>

        <div class="hotkey-section">
          <div class="hotkey-section-title">üè¢ Business Type</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Music City Rodeo</span>
            <span class="hotkey-key"><span class="kbd">M</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Down Home</span>
            <span class="hotkey-key"><span class="kbd">D</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Personal</span>
            <span class="hotkey-key"><span class="kbd">P</span></span>
          </div>
        </div>

        <div class="hotkey-section">
          <div class="hotkey-section-title">üîç Viewer</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Quick View</span>
            <span class="hotkey-key"><span class="kbd">Q</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Navigate Receipts</span>
            <span class="hotkey-key"><span class="kbd">‚Üê ‚Üí</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Jump to Position (10%-90%)</span>
            <span class="hotkey-key"><span class="kbd">1-9</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">First / Last Receipt</span>
            <span class="hotkey-key"><span class="kbd">Home</span> <span class="kbd">End</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Zoom In / Out (Quick View)</span>
            <span class="hotkey-key"><span class="kbd">+</span><span class="kbd">‚àí</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Reset Zoom (Quick View)</span>
            <span class="hotkey-key"><span class="kbd">0</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Close Quick View</span>
            <span class="hotkey-key"><span class="kbd">ESC</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Rotate Image (Main)</span>
            <span class="hotkey-key"><span class="kbd">R</span></span>
          </div>
        </div>

        <div class="hotkey-section">
          <div class="hotkey-section-title">‚å®Ô∏è Navigation</div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Previous Row</span>
            <span class="hotkey-key"><span class="kbd">‚Üë</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Next Row</span>
            <span class="hotkey-key"><span class="kbd">‚Üì</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Close Modal</span>
            <span class="hotkey-key"><span class="kbd">Esc</span></span>
          </div>
          <div class="hotkey-item">
            <span class="hotkey-desc">Show This Menu</span>
            <span class="hotkey-key"><span class="kbd">?</span></span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="toggleHotkeyMenu()">Close</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚öôÔ∏è Settings</div>
      <button class="modal-close" onclick="toggleSettings()">√ó</button>
    </div>
    <div class="modal-body">
      <!-- System Health -->
      <div class="settings-section" style="background:linear-gradient(135deg, rgba(0,255,136,.1), rgba(0,204,106,.05));border:1px solid rgba(0,255,136,.2);border-radius:12px;padding:16px;margin-bottom:20px">
        <div class="settings-section-title" style="color:#00ff88">üü¢ System Health</div>
        <div id="system-health-status" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:12px;margin-top:12px">
          <div style="text-align:center;padding:12px;background:var(--panel2);border-radius:8px">
            <div style="font-size:20px;margin-bottom:4px">‚úÖ</div>
            <div style="font-size:11px;color:var(--muted)">Database</div>
            <div style="font-size:12px;font-weight:600;color:#00ff88" id="db-status">SQLite</div>
          </div>
          <div style="text-align:center;padding:12px;background:var(--panel2);border-radius:8px">
            <div style="font-size:20px;margin-bottom:4px" id="r2-icon">‚úÖ</div>
            <div style="font-size:11px;color:var(--muted)">R2 Storage</div>
            <div style="font-size:12px;font-weight:600;color:#00ff88" id="r2-status">Connected</div>
          </div>
          <div style="text-align:center;padding:12px;background:var(--panel2);border-radius:8px">
            <div style="font-size:20px;margin-bottom:4px" id="ai-icon">‚úÖ</div>
            <div style="font-size:11px;color:var(--muted)">Gemini AI</div>
            <div style="font-size:12px;font-weight:600;color:#00ff88" id="ai-status">Ready</div>
          </div>
          <div style="text-align:center;padding:12px;background:var(--panel2);border-radius:8px">
            <div style="font-size:20px;margin-bottom:4px" id="ocr-icon">‚úÖ</div>
            <div style="font-size:11px;color:var(--muted)">OCR</div>
            <div style="font-size:12px;font-weight:600;color:#00ff88" id="health-ocr-status">Donut 98%</div>
          </div>
        </div>
        <button class="btn-ghost" onclick="checkSystemHealth()" style="margin-top:12px;width:100%">üîÑ Check All Services</button>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">ü§ñ AI & OCR</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Gemini Vision API</div>
            <div class="settings-desc">Receipt OCR & AI note generation</div>
          </div>
          <span class="badge badge-good" id="gemini-badge">Active</span>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Local OCR (Donut)</div>
            <div class="settings-desc">97-98% accuracy fallback</div>
          </div>
          <span class="badge badge-good">Enabled</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üìß Gmail Integration</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Personal Gmail</div>
            <div class="settings-desc">kaplan.brian@gmail.com</div>
          </div>
          <span id="gmail-status-personal" class="badge badge-neutral">Checking...</span>
          <button class="btn-ghost" onclick="connectGmail('kaplan.brian@gmail.com')" id="gmail-btn-personal">üîó Connect</button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Music City Rodeo</div>
            <div class="settings-desc">brian@musiccityrodeo.com</div>
          </div>
          <span id="gmail-status-mcr" class="badge badge-neutral">Checking...</span>
          <button class="btn-ghost" onclick="connectGmail('brian@musiccityrodeo.com')" id="gmail-btn-mcr">üîó Connect</button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Down Home</div>
            <div class="settings-desc">brian@downhome.com</div>
          </div>
          <span id="gmail-status-downhome" class="badge badge-neutral">Checking...</span>
          <button class="btn-ghost" onclick="connectGmail('brian@downhome.com')" id="gmail-btn-downhome">üîó Connect</button>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üíæ Data & Storage</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Database</div>
            <div class="settings-desc" id="db-type-desc">MySQL on Railway</div>
          </div>
          <span id="db-status" class="badge badge-good">Connected</span>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Receipt Storage</div>
            <div class="settings-desc">Cloudflare R2 + local backup</div>
          </div>
          <span class="badge badge-good">R2</span>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Transactions</div>
            <div class="settings-desc" id="transaction-count-setting">Loading...</div>
          </div>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Auto-Backup</div>
            <div class="settings-desc">CSV backup on every server start</div>
          </div>
          <span class="badge badge-good">On</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üîê Security</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Authentication</div>
            <div class="settings-desc">Password + PIN protection</div>
          </div>
          <span class="badge badge-good">Enabled</span>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Session</div>
            <div class="settings-desc">Secure HTTPOnly cookies</div>
          </div>
          <span class="badge badge-good">Active</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">üé® Appearance</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">Theme</div>
            <div class="settings-desc">Tallyups dark theme</div>
          </div>
          <span style="color:#00ff88;font-weight:600">Black & Green</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="toggleSettings()">Close</button>
    </div>
  </div>
</div>

<!-- Manual Entry Modal -->
<div class="modal-overlay" id="manual-entry-modal">
  <div class="modal" style="max-width:700px">
    <div class="modal-header">
      <div class="modal-title">‚ûï Add Manual Expense</div>
      <button class="modal-close" onclick="closeManualEntryModal()">√ó</button>
    </div>
    <div class="modal-body">
      <!-- OCR Drag & Drop Zone -->
      <div class="ocr-drop-zone" id="ocr-drop-zone">
        <input type="file" id="ocr-file-input" accept="image/*" style="display:none">
        <div class="ocr-drop-icon">üì∏</div>
        <div class="ocr-drop-text">Drop receipt image or click to upload</div>
        <div class="ocr-drop-hint">AI will automatically extract merchant, date & amount</div>
        <img id="ocr-preview" class="ocr-preview" alt="Receipt preview">
        <div id="ocr-status" class="ocr-status"></div>
      </div>

      <form id="manual-entry-form" onsubmit="submitManualEntry(event)">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
          <!-- Date -->
          <div>
            <label class="settings-label" style="display:block;margin-bottom:6px">Date *</label>
            <input type="date" id="manual-date" class="input" style="width:100%" required
                   value="">
          </div>

          <!-- Amount -->
          <div>
            <label class="settings-label" style="display:block;margin-bottom:6px">Amount *</label>
            <input type="number" id="manual-amount" class="input" style="width:100%"
                   placeholder="0.00" step="0.01" required>
          </div>
        </div>

        <!-- Merchant/Description -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Merchant/Description *</label>
          <input type="text" id="manual-merchant" class="input" style="width:100%"
                 placeholder="e.g., Soho House Nashville" required>
        </div>

        <!-- Business Type -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Business Type *</label>
          <select id="manual-business-type" class="input" style="width:100%" required onchange="updateCategoryOptions()">
            <option value="">Select Business Type</option>
            <option value="Music City Rodeo">Music City Rodeo</option>
            <option value="Down Home">Down Home</option>
            <option value="Personal">Personal</option>
          </select>
        </div>

        <!-- Category -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Category</label>
          <select id="manual-category" class="input" style="width:100%">
            <option value="">Select Category (optional)</option>
          </select>
        </div>

        <!-- Notes -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Notes</label>
          <textarea id="manual-notes" class="input" style="width:100%;min-height:80px;resize:vertical"
                    placeholder="Add any additional notes..."></textarea>
        </div>

        <div style="font-size:11px;color:var(--muted);padding:12px;background:var(--panel2);border-radius:8px;border:1px solid var(--edge)">
          ‚ÑπÔ∏è This expense will be marked as "Manual Entry" and added to your transactions.
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" type="button" onclick="closeManualEntryModal()">Cancel</button>
      <button class="btn-success" type="submit" form="manual-entry-form">
        ‚ûï Add Expense
      </button>
    </div>
  </div>
</div>

<!-- Quick Viewer Modal -->
<div class="quick-viewer" id="quick-viewer">
  <div class="quick-viewer-content">
    <!-- Navigation Buttons -->
    <button class="quick-nav-btn prev" onclick="navigateQuickViewer(-1)" id="quick-prev">‚Äπ</button>
    <button class="quick-nav-btn next" onclick="navigateQuickViewer(1)" id="quick-next">‚Ä∫</button>

    <!-- Position Indicator -->
    <div class="quick-position" id="quick-position">1 / 247</div>

    <!-- Keyboard Shortcuts -->
    <div class="quick-shortcuts">
      <span><kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate</span>
      <span><kbd>G/B/N</kbd> Status</span>
      <span><kbd>M/D/P</kbd> Business</span>
      <span><kbd>J</kbd> AI Note</span>
      <span><kbd>A</kbd> AI Match</span>
      <span><kbd>F</kbd> Missing Form</span>
      <span><kbd>ESC</kbd> Close</span>
    </div>

    <div class="quick-viewer-header">
      <div class="quick-viewer-title" id="quick-title">Quick Receipt View</div>
      <div class="viewer-controls">
        <button class="icon-btn" onclick="closeQuickViewer()">√ó</button>
      </div>
    </div>
    <div class="quick-viewer-body">
      <div class="quick-viewer-image" id="quick-image">
        <!-- Zoom Controls -->
        <div class="quick-zoom-controls">
          <button class="quick-zoom-btn" onclick="quickZoom(0.2)" title="Zoom In">+</button>
          <button class="quick-zoom-btn" onclick="quickZoom(-0.2)" title="Zoom Out">‚àí</button>
          <button class="quick-zoom-btn" onclick="quickResetZoom()" title="Reset Zoom">‚ü≤</button>
        </div>

        <!-- Match Confidence Badge (hidden by default) -->
        <div class="match-confidence" id="quick-match-badge" style="display:none">
          <span>‚úì</span>
          <span id="quick-confidence-text">95% Match</span>
        </div>

        <div class="no-receipt">
          <div class="no-receipt-icon">üìÑ</div>
          <div class="no-receipt-text">No receipt selected</div>
        </div>
      </div>
      <div class="quick-viewer-data" id="quick-data">
        <div class="data-row">
          <div class="data-label">Merchant</div>
          <div class="data-value" id="quick-merchant">‚Äî</div>
        </div>
        <div class="data-row">
          <div class="data-label">Amount</div>
          <div class="data-value large" id="quick-amount">‚Äî</div>
        </div>
        <div class="data-row">
          <div class="data-label">Date</div>
          <div class="data-value" id="quick-date">‚Äî</div>
        </div>
        <div class="data-row">
          <div class="data-label">Business Type</div>
          <select id="quick-business" class="quick-field-select" onchange="quickUpdateField('Business Type', this.value)">
            <option value="">‚Äî</option>
            <option value="Music City Rodeo">Music City Rodeo</option>
            <option value="Down Home">Down Home</option>
            <option value="Personal">Personal</option>
          </select>
        </div>
        <div class="data-row">
          <div class="data-label">Category</div>
          <div class="data-value" id="quick-category">‚Äî</div>
        </div>
        <div class="data-row">
          <div class="data-label">Status</div>
          <select id="quick-status" class="quick-field-select" onchange="quickUpdateField('Review Status', this.value)">
            <option value="">Pending</option>
            <option value="good">Good</option>
            <option value="bad">Bad</option>
            <option value="not needed">Not Needed</option>
          </select>
        </div>
        <div class="data-row">
          <div class="data-label">Notes</div>
          <textarea id="quick-notes" class="quick-field-textarea" placeholder="Add notes..."
            onblur="quickUpdateField('Notes', this.value)"
            onkeydown="handleTextareaKeys(event, 'Notes')"></textarea>
        </div>
        <div class="data-row">
          <div class="data-label">AI Note</div>
          <textarea id="quick-ai-note" class="quick-field-textarea" placeholder="AI-generated note..."
            onblur="quickUpdateField('AI Note', this.value)"
            onkeydown="handleTextareaKeys(event, 'AI Note')"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Progress Modal -->
<div class="modal-overlay" id="progress-modal">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <div class="modal-title">ü§ñ Finding Missing Receipts</div>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:20px">
        <div style="font-size:14px;color:var(--muted);margin-bottom:10px">
          Processing transactions...
        </div>
        <div style="background:var(--panel2);border-radius:8px;overflow:hidden;height:24px;position:relative">
          <div id="progress-bar" style="background:linear-gradient(90deg,#3b82f6,#8b5cf6);height:100%;width:0%;transition:width 0.3s ease"></div>
          <div id="progress-text" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:12px;font-weight:600;color:var(--ink)">
            0%
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
        <div style="background:var(--panel2);padding:12px;border-radius:8px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Processed</div>
          <div style="font-size:20px;font-weight:700" id="progress-processed">0</div>
        </div>
        <div style="background:var(--panel2);padding:12px;border-radius:8px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Found</div>
          <div style="font-size:20px;font-weight:700;color:var(--ok)" id="progress-found">0</div>
        </div>
      </div>

      <div style="max-height:200px;overflow-y:auto;background:var(--panel2);border-radius:8px;padding:12px">
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">
          Recent Matches
        </div>
        <div id="progress-log" style="font-size:12px;line-height:1.8;font-family:ui-monospace,monospace">
          <div style="color:var(--muted)">Waiting to start...</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" onclick="cancelBatchProcess()" id="progress-cancel-btn">
        Cancel
      </button>
      <button class="btn-ghost" onclick="closeProgressModal()" id="progress-close-btn" style="display:none">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Missing Receipt Form Modal -->
<div class="modal-overlay" id="missing-receipt-modal">
  <div class="modal" style="max-width:550px">
    <div class="modal-header">
      <div class="modal-title">üìù Generate Missing Receipt Form</div>
      <button class="modal-close" onclick="closeMissingReceiptModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:white;padding:16px;border-radius:10px;margin-bottom:20px">
        <div style="font-size:14px;font-weight:600;margin-bottom:4px" id="mrf-merchant">Loading...</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:24px;font-weight:700" id="mrf-amount">$0.00</span>
          <span style="font-size:13px;opacity:0.9" id="mrf-date">--/--/----</span>
        </div>
      </div>

      <form id="missing-receipt-form">
        <!-- Company Selection -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Company *</label>
          <select id="mrf-company" class="input" style="width:100%" required>
            <option value="downhome">Down Home Media LLC</option>
            <option value="mcr">Music City Rodeo</option>
          </select>
        </div>

        <!-- Reason Receipt Was Lost -->
        <div style="margin-bottom:16px">
          <label class="settings-label" style="display:block;margin-bottom:6px">Reason Receipt Was Lost *</label>
          <select id="mrf-reason-select" class="input" style="width:100%;margin-bottom:8px" onchange="updateReasonField()">
            <option value="">-- Select a reason or type custom --</option>
            <option value="Receipt not provided by vendor">Receipt not provided by vendor</option>
            <option value="Electronic payment - no physical receipt">Electronic payment - no physical receipt</option>
            <option value="Receipt lost during travel">Receipt lost during travel</option>
            <option value="Receipt faded/illegible">Receipt faded/illegible</option>
            <option value="Vendor does not issue receipts">Vendor does not issue receipts</option>
            <option value="Online purchase - email receipt unavailable">Online purchase - email receipt unavailable</option>
            <option value="custom">Custom reason...</option>
          </select>
          <input type="text" id="mrf-reason" class="input" style="width:100%"
                 placeholder="Enter reason receipt was lost" required>
        </div>

        <!-- Meal Receipt Section (collapsible) -->
        <div style="margin-bottom:16px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px">
            <input type="checkbox" id="mrf-is-meal" onchange="toggleMealSection()">
            <span class="settings-label" style="margin:0">This was a meal/entertainment expense</span>
          </label>
          <div id="mrf-meal-section" style="display:none;padding:12px;background:var(--panel2);border-radius:8px;border:1px solid var(--edge)">
            <div style="margin-bottom:12px">
              <label class="settings-label" style="display:block;margin-bottom:6px;font-size:12px">Attendee Name(s)</label>
              <input type="text" id="mrf-attendees" class="input" style="width:100%"
                     placeholder="e.g., John Smith, Jane Doe">
            </div>
            <div>
              <label class="settings-label" style="display:block;margin-bottom:6px;font-size:12px">Business Purpose</label>
              <input type="text" id="mrf-purpose" class="input" style="width:100%"
                     placeholder="e.g., Client meeting to discuss Q4 campaign">
            </div>
          </div>
        </div>

        <div style="font-size:11px;color:var(--muted);padding:12px;background:var(--panel2);border-radius:8px;border:1px solid var(--edge)">
          ‚ÑπÔ∏è This will generate a PDF Missing Receipt Form with your signature and attach it to this transaction.
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" type="button" onclick="closeMissingReceiptModal()">Cancel</button>
      <button class="btn-success" type="button" onclick="submitMissingReceiptForm()">
        üìù Generate Form
      </button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
  <span class="toast-icon" id="toast-icon">‚úì</span>
  <span class="toast-message" id="toast-message"></span>
</div>

<!-- Loading Overlay for batch operations -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner-large"></div>
  <div class="loading-text" id="loading-text">Processing...</div>
  <div class="loading-progress" id="loading-progress"></div>
</div>

<script>
// Global state
let csvData = [];
let filteredData = [];
let selectedRow = null;
let sortColumn = 'Chase Date';
let sortAsc = true;
let panzoomInstance = null;
let currentRotation = 0;

// Undo system
let undoStack = [];
const MAX_UNDO_STACK = 50;

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  await loadCSV();
  setupEventListeners();
  setupDragDrop();
  setupResizer();
  loadTheme();
  showToast('System ready! Press ? for keyboard shortcuts', 'üöÄ');
});

// API calls
async function loadCSV() {
  try {
    const res = await fetch('/api/transactions');
    const data = await res.json();
    csvData = data || [];  // Server returns array directly from MySQL
    filteredData = [...csvData];
    renderTable();
    updateDashboard();
    showToast(`Loaded ${csvData.length} transactions`, 'üìä');
  } catch (e) {
    showToast('Failed to load CSV: ' + e.message, '‚ùå');
  }
}

async function saveCSV() {
  // NOTE: Server auto-saves on each update_row call
  // This function kept for Ctrl+S hotkey compatibility
  showToast('Changes are auto-saved on each update', '‚úì');
}

async function aiMatch() {
  if (!selectedRow) return showToast('Select a transaction first', '‚ö†Ô∏è');

  // Save undo state BEFORE making changes
  const oldData = {
    'Receipt File': selectedRow['Receipt File'] || '',
    'ai_receipt_merchant': selectedRow['ai_receipt_merchant'] || '',
    'ai_receipt_date': selectedRow['ai_receipt_date'] || '',
    'ai_receipt_total': selectedRow['ai_receipt_total'] || '',
    'AI Confidence': selectedRow['AI Confidence'] || '',
    'mi_merchant': selectedRow['mi_merchant'] || '',
    'mi_category': selectedRow['mi_category'] || '',
    'mi_description': selectedRow['mi_description'] || '',
    'mi_confidence': selectedRow['mi_confidence'] || ''
  };

  showToast('üîç Finding receipt...', 'üîç');
  try {
    const res = await fetch('/ai_match', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({_index: selectedRow._index})
    });
    const data = await res.json();
    if (data.ok) {
      // Save undo state
      saveUndoState('AI Receipt Match + MI', selectedRow._index, oldData);

      // Update selected row with matched receipt data
      Object.assign(selectedRow, data.result);
      renderTable();
      loadReceipt();

      // Show detailed success message
      const confidence = data.result['AI Confidence'] || data.result['ai_confidence'] || 0;
      const receiptFile = data.result['Receipt File'] || '';
      const fileName = receiptFile.split('/').pop();

      showToast(`‚úÖ Receipt matched! ${fileName} (${Math.round(confidence)}%) - Running Donut OCR...`, 'üîÑ', 3000);

      // Now run Donut OCR + MI processing on the matched receipt
      try {
        const miRes = await fetch('/process_mi_ocr', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({_index: selectedRow._index})
        });
        const miData = await miRes.json();
        if (miData.ok) {
          // Update with MI results
          if (miData.result) {
            selectedRow.mi_merchant = miData.result.mi_merchant || selectedRow.mi_merchant;
            selectedRow.mi_category = miData.result.mi_category || selectedRow.mi_category;
            selectedRow.mi_description = miData.result.mi_description || selectedRow.mi_description;
            selectedRow.mi_confidence = miData.result.mi_confidence || selectedRow.mi_confidence;
            selectedRow.mi_is_subscription = miData.result.mi_is_subscription || 0;
            selectedRow.mi_subscription_name = miData.result.mi_subscription_name || '';
          }
          renderTable();

          const usedOcr = miData.used_ocr ? 'üç© Donut' : 'üìã Pattern';
          const miConf = Math.round((miData.result?.mi_confidence || 0) * 100);
          showToast(`‚úÖ Complete! ${usedOcr}: ${miData.result?.mi_merchant || 'Unknown'} (${miConf}%) - Ctrl+Z to undo`, '‚úÖ', 5000);
        } else {
          showToast(`‚ö†Ô∏è Receipt matched but MI failed: ${miData.message}`, '‚ö†Ô∏è', 4000);
        }
      } catch (miError) {
        showToast(`‚ö†Ô∏è Receipt matched but MI error: ${miError.message}`, '‚ö†Ô∏è', 4000);
      }
    } else {
      // No receipt found - still run MI with pattern matching
      showToast(`‚ùå No receipt found - running pattern MI...`, 'üîÑ', 2000);

      try {
        const miRes = await fetch('/process_mi_ocr', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({_index: selectedRow._index})
        });
        const miData = await miRes.json();
        if (miData.ok && miData.result) {
          // Save undo state for MI-only change
          saveUndoState('MI Pattern Match', selectedRow._index, oldData);

          selectedRow.mi_merchant = miData.result.mi_merchant || '';
          selectedRow.mi_category = miData.result.mi_category || '';
          selectedRow.mi_description = miData.result.mi_description || '';
          selectedRow.mi_confidence = miData.result.mi_confidence || 0;
          renderTable();

          const miConf = Math.round((miData.result.mi_confidence || 0) * 100);
          showToast(`üìã No receipt, but MI processed: ${miData.result.mi_merchant} (${miConf}%)`, 'üìã', 4000);
        }
      } catch (e) {
        showToast(`‚ùå ${data.message || 'No receipt found'}`, '‚ùå', 4000);
      }
    }
  } catch (e) {
    showToast(`‚ùå AI Match failed: ${e.message}`, '‚ùå');
  }
}

async function aiNote() {
  if (!selectedRow) return showToast('Select a transaction first', '‚ö†Ô∏è');

  showToast('Generating AI note...', '‚úçÔ∏è');
  try {
    const res = await fetch('/ai_note', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({_index: selectedRow._index})
    });
    const data = await res.json();
    if (data.ok) {
      selectedRow.Notes = data.note;
      renderTable();
      showToast('AI note generated', '‚úì');
    }
  } catch (e) {
    showToast('AI Note failed: ' + e.message, '‚ùå');
  }
}

// Undo system functions
function saveUndoState(action, transactionIndex, oldData) {
  const undoEntry = {
    action,
    transactionIndex,
    oldData: {...oldData}, // Clone the old data
    timestamp: Date.now()
  };

  undoStack.push(undoEntry);

  // Limit stack size
  if (undoStack.length > MAX_UNDO_STACK) {
    undoStack.shift(); // Remove oldest entry
  }

  console.log(`Undo state saved: ${action} for transaction ${transactionIndex}`, undoEntry);
}

async function undo() {
  if (undoStack.length === 0) {
    showToast('‚ö†Ô∏è Nothing to undo', '‚ö†Ô∏è');
    return;
  }

  const entry = undoStack.pop();

  try {
    showToast(`‚Ü©Ô∏è Undoing: ${entry.action}...`, '‚Ü©Ô∏è');

    // Restore the old data
    const res = await fetch('/update_row', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        _index: entry.transactionIndex,
        patch: entry.oldData
      })
    });

    if (!res.ok) {
      throw new Error(`Failed to undo: ${res.statusText}`);
    }

    // Update local state
    const rowIndex = csvData.findIndex(r => r._index === entry.transactionIndex);
    if (rowIndex >= 0) {
      Object.assign(csvData[rowIndex], entry.oldData);
      if (selectedRow && selectedRow._index === entry.transactionIndex) {
        Object.assign(selectedRow, entry.oldData);
      }
    }

    renderTable();
    loadReceipt();

    showToast(`‚úÖ Undid: ${entry.action}`, '‚úÖ', 3000);

  } catch (e) {
    showToast(`‚ùå Undo failed: ${e.message}`, '‚ùå');
    // Put entry back on stack since undo failed
    undoStack.push(entry);
  }
}

let batchProcessCancelled = false;

// Process all transactions through Merchant Intelligence
async function processMerchantIntelligence() {
  if (!confirm(`Process all ${csvData.length} transactions through Merchant Intelligence?\n\nThis will:\n- Normalize merchant names\n- Assign categories\n- Detect subscriptions\n- Generate descriptions\n- Match contacts from CRM`)) {
    return;
  }

  showToast('Processing Merchant Intelligence...', 'üß†');

  try {
    const response = await fetch('/process_mi', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({all: true})
    });

    const result = await response.json();

    if (result.ok) {
      showToast(result.message, '‚úÖ');
      // Reload data to show updated MI fields
      await loadCSV();
      applyFilters();
      renderTable();
    } else {
      showToast(result.message || 'MI processing failed', '‚ùå');
    }
  } catch (e) {
    showToast('MI processing error: ' + e.message, '‚ùå');
  }
}

// Smart Search - Intelligent multi-source search with learning
async function smartSearchMissing() {
  const missingRows = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (missingRows.length === 0) {
    showToast('All transactions have receipts!', '‚úì');
    return;
  }

  if (!confirm(`Smart Search will find receipts using AI match, Gmail, and iMessage.\n\nProcess ${missingRows.length} missing receipts?\n\nThis may take several minutes.`)) {
    return;
  }

  console.log(`üîç Starting Smart Search: ${missingRows.length} receipts to find`);

  batchProcessCancelled = false;

  const modal = document.getElementById('progress-modal');
  modal.classList.add('active');

  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">üß† Smart Search: AI ‚Üí Gmail ‚Üí iMessage</div>';

  let processed = 0;
  let found = 0;
  const total = missingRows.length;
  const startTime = Date.now();

  // Phase 1: AI Match (try local receipts first)
  addProgressLog('\nü§ñ Phase 1: AI matching local receipts...', 'ok');

  for (const row of missingRows) {
    if (batchProcessCancelled) {
      addProgressLog(`\n‚ö†Ô∏è Cancelled! Processed ${processed} of ${total}`, 'bad');
      document.getElementById('progress-cancel-btn').style.display = 'none';
      document.getElementById('progress-close-btn').style.display = 'block';
      showToast(`Cancelled after ${processed} receipts`, '‚ö†Ô∏è');
      return;
    }

    try {
      processed++;
      const percent = Math.round((processed / total) * 100);
      updateProgress(processed, found, percent, total);

      // Try AI match first
      const res = await fetch('/ai_match', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({_index: row._index})
      });

      const data = await res.json();

      if (data.ok && data.result.receipt_file) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;
        addProgressLog(`‚úì ${(row['Chase Description'] || 'Unknown').substring(0, 30)} ‚Üí AI matched`, 'ok');
        document.getElementById('progress-found').textContent = found;
      }
    } catch (e) {
      console.error(`AI match error:`, e);
    }
  }

  // Get still-missing receipts
  let stillMissing = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (stillMissing.length === 0) {
    addProgressLog(`\n‚úÖ All receipts found via AI match!`, 'ok');
    finishSmartSearch(found, total, startTime);
    return;
  }

  // Phase 2: Gmail Search
  addProgressLog(`\nüìß Phase 2: Searching Gmail (${stillMissing.length} remaining)...`, 'ok');

  for (const row of stillMissing) {
    if (batchProcessCancelled) break;

    try {
      const res = await fetch('/smart_search_receipt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: row._index,
          merchant: row['Chase Description'],
          amount: row['Chase Amount'],
          date: row['Chase Date'],
          source: 'gmail'
        })
      });

      const data = await res.json();

      if (data.ok && data.result && data.result.found) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;
        const source = data.result.source || 'Gmail';
        addProgressLog(`‚úì ${(row['Chase Description'] || 'Unknown').substring(0, 30)} ‚Üí ${source}`, 'ok');
        document.getElementById('progress-found').textContent = found;
      }
    } catch (e) {
      console.error(`Gmail search error:`, e);
    }
  }

  // Get still-missing receipts
  stillMissing = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (stillMissing.length === 0) {
    addProgressLog(`\n‚úÖ All receipts found!`, 'ok');
    finishSmartSearch(found, total, startTime);
    return;
  }

  // Phase 3: iMessage Search
  addProgressLog(`\nüí¨ Phase 3: Searching iMessage (${stillMissing.length} remaining)...`, 'ok');

  for (const row of stillMissing) {
    if (batchProcessCancelled) break;

    try {
      const res = await fetch('/smart_search_receipt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: row._index,
          merchant: row['Chase Description'],
          amount: row['Chase Amount'],
          date: row['Chase Date'],
          source: 'imessage'
        })
      });

      const data = await res.json();

      if (data.ok && data.result && data.result.found) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;
        addProgressLog(`‚úì ${(row['Chase Description'] || 'Unknown').substring(0, 30)} ‚Üí iMessage`, 'ok');
        document.getElementById('progress-found').textContent = found;
      }
    } catch (e) {
      console.error(`iMessage search error:`, e);
    }
  }

  finishSmartSearch(found, total, startTime);
}

function finishSmartSearch(found, total, startTime) {
  const elapsed = Math.round((Date.now() - startTime) / 1000);
  console.log(`‚úÖ Smart Search complete in ${elapsed}s: Found ${found} of ${total} receipts`);

  addProgressLog(`\n‚úÖ Smart Search complete! Found ${found} of ${total} receipts in ${elapsed}s`, 'ok');
  document.getElementById('progress-cancel-btn').style.display = 'none';
  document.getElementById('progress-close-btn').style.display = 'block';

  showToast(`Smart Search complete: ${found} receipts found`, '‚úÖ');

  // Reload to show new receipts
  loadCSV().then(() => {
    applyFilters();
    renderTable();
  });
}

// Gmail Search - Search Gmail for missing receipts
async function searchGmailForMissing() {
  const missingRows = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (missingRows.length === 0) {
    showToast('All transactions have receipts!', '‚úì');
    return;
  }

  if (!confirm(`Search Gmail for ${missingRows.length} missing receipts? This may take several minutes.`)) {
    return;
  }

  console.log(`üìß Starting Gmail search: ${missingRows.length} receipts to find`);

  batchProcessCancelled = false;

  const modal = document.getElementById('progress-modal');
  modal.classList.add('active');

  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">Searching Gmail accounts...</div>';

  let processed = 0;
  let found = 0;
  const total = missingRows.length;
  const startTime = Date.now();

  for (const row of missingRows) {
    if (batchProcessCancelled) {
      console.log('‚ùå Gmail search cancelled');
      addProgressLog(`\n‚ö†Ô∏è Cancelled! Searched ${processed} of ${total}`, 'bad');
      document.getElementById('progress-cancel-btn').style.display = 'none';
      document.getElementById('progress-close-btn').style.display = 'block';
      showToast(`Cancelled after ${processed} receipts`, '‚ö†Ô∏è');
      return;
    }

    try {
      processed++;
      const percent = Math.round((processed / total) * 100);
      updateProgress(processed, found, percent, total);

      console.log(`[${processed}/${total}] Searching Gmail: ${row['Chase Description']?.substring(0, 40) || 'Unknown'}`);

      const res = await fetch('/search_gmail_receipt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: row._index,
          merchant: row['Chase Description'],
          amount: row['Chase Amount'],
          date: row['Chase Date']
        })
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();

      if (data.ok && data.result && data.result.receipt_file) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;

        const merchant = row['Chase Description'] || 'Unknown';
        console.log(`  ‚úì Found in Gmail`);
        addProgressLog(`‚úì ${merchant.substring(0, 30)} ‚Üí Found in email`, 'ok');
      } else {
        console.log(`  ‚äò Not found in Gmail`);
        addProgressLog(`‚äò ${(row['Chase Description'] || 'Unknown').substring(0, 30)} ‚Üí Not found`, 'muted');
      }

      document.getElementById('progress-found').textContent = found;

    } catch (e) {
      console.error(`  ‚úó Error searching Gmail:`, e);
      addProgressLog(`‚úó Error: ${e.message}`, 'bad');
    }
  }

  const elapsed = Math.round((Date.now() - startTime) / 1000);
  console.log(`‚úÖ Gmail search complete in ${elapsed}s: Found ${found} of ${total} receipts`);

  addProgressLog(`\n‚úÖ Complete! Found ${found} receipts in ${elapsed}s`, 'ok');
  document.getElementById('progress-cancel-btn').style.display = 'none';
  document.getElementById('progress-close-btn').style.display = 'block';

  showToast(`Gmail search complete: ${found} receipts found`, '‚úÖ');

  await loadCSV();
  applyFilters();
  renderTable();
}

// iMessage Search - Search iMessage for missing receipts
async function searchIMessageForMissing() {
  const missingRows = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (missingRows.length === 0) {
    showToast('All transactions have receipts!', '‚úì');
    return;
  }

  if (!confirm(`Search iMessage for ${missingRows.length} missing receipts? This may take several minutes.`)) {
    return;
  }

  console.log(`üí¨ Starting iMessage search: ${missingRows.length} receipts to find`);

  batchProcessCancelled = false;

  const modal = document.getElementById('progress-modal');
  modal.classList.add('active');

  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">Searching iMessage database...</div>';

  let processed = 0;
  let found = 0;
  const total = missingRows.length;
  const startTime = Date.now();

  for (const row of missingRows) {
    if (batchProcessCancelled) {
      console.log('‚ùå iMessage search cancelled');
      addProgressLog(`\n‚ö†Ô∏è Cancelled! Searched ${processed} of ${total}`, 'bad');
      document.getElementById('progress-cancel-btn').style.display = 'none';
      document.getElementById('progress-close-btn').style.display = 'block';
      showToast(`Cancelled after ${processed} receipts`, '‚ö†Ô∏è');
      return;
    }

    try {
      processed++;
      const percent = Math.round((processed / total) * 100);
      updateProgress(processed, found, percent, total);

      console.log(`[${processed}/${total}] Searching iMessage: ${row['Chase Description']?.substring(0, 40) || 'Unknown'}`);

      const res = await fetch('/search_imessage_receipt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: row._index,
          merchant: row['Chase Description'],
          amount: row['Chase Amount'],
          date: row['Chase Date']
        })
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();

      if (data.ok && data.result && data.result.receipt_file) {
        found++;
        Object.assign(row, data.result);
        row._newlyMatched = true;

        const merchant = row['Chase Description'] || 'Unknown';
        console.log(`  ‚úì Found in iMessage`);
        addProgressLog(`‚úì ${merchant.substring(0, 30)} ‚Üí Found in messages`, 'ok');
      } else {
        console.log(`  ‚äò Not found in iMessage`);
        addProgressLog(`‚äò ${(row['Chase Description'] || 'Unknown').substring(0, 30)} ‚Üí Not found`, 'muted');
      }

      document.getElementById('progress-found').textContent = found;

    } catch (e) {
      console.error(`  ‚úó Error searching iMessage:`, e);
      addProgressLog(`‚úó Error: ${e.message}`, 'bad');
    }
  }

  const elapsed = Math.round((Date.now() - startTime) / 1000);
  console.log(`‚úÖ iMessage search complete in ${elapsed}s: Found ${found} of ${total} receipts`);

  addProgressLog(`\n‚úÖ Complete! Found ${found} receipts in ${elapsed}s`, 'ok');
  document.getElementById('progress-cancel-btn').style.display = 'none';
  document.getElementById('progress-close-btn').style.display = 'block';

  showToast(`iMessage search complete: ${found} receipts found`, '‚úÖ');

  await loadCSV();
  applyFilters();
  renderTable();
}

// Process single transaction through MI
async function processSingleMI(rowIndex) {
  try {
    const response = await fetch('/process_mi', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({_index: rowIndex})
    });

    const result = await response.json();

    if (result.ok) {
      showToast(result.message, '‚úÖ');
      await loadCSV();
      applyFilters();
      renderTable();
    } else {
      showToast(result.message || 'MI processing failed', '‚ùå');
    }
  } catch (e) {
    showToast('MI error: ' + e.message, '‚ùå');
  }
}

async function findMissingReceipts() {
  // Find rows without receipts
  const missingRows = csvData.filter(r => !r['Receipt File'] || r['Receipt File'].trim() === '');

  if (missingRows.length === 0) {
    showToast('All transactions have receipts!', '‚úì');
    return;
  }

  if (!confirm(`Process ${missingRows.length} missing receipts? This may take several minutes.`)) {
    return;
  }

  console.log(`üöÄ Starting batch process: ${missingRows.length} receipts to process`);

  // Reset cancel flag
  batchProcessCancelled = false;

  // Show progress modal
  const modal = document.getElementById('progress-modal');
  console.log('üìä Showing progress modal...');
  modal.classList.add('active');
  console.log('üìä Modal classList:', modal.classList.toString());
  console.log('üìä Modal display:', window.getComputedStyle(modal).display);
  console.log('üìä Modal z-index:', window.getComputedStyle(modal).zIndex);

  document.getElementById('progress-close-btn').style.display = 'none';
  document.getElementById('progress-cancel-btn').style.display = 'block';
  document.getElementById('progress-log').innerHTML = '<div style="color:var(--muted)">Starting batch process...</div>';

  console.log('‚úÖ Progress modal configuration complete!');

  let processed = 0;
  let found = 0;
  const total = missingRows.length;
  const startTime = Date.now();

  // Process each row individually so we can show progress
  for (const row of missingRows) {
    // Check if cancelled
    if (batchProcessCancelled) {
      console.log('‚ùå Batch process cancelled by user');
      addProgressLog(`\n‚ö†Ô∏è Cancelled! Processed ${processed} of ${total}`, 'bad');
      document.getElementById('progress-cancel-btn').style.display = 'none';
      document.getElementById('progress-close-btn').style.display = 'block';
      showToast(`Cancelled after ${processed} receipts`, '‚ö†Ô∏è');
      return;
    }

    try {
      // Update progress
      processed++;
      const percent = Math.round((processed / total) * 100);
      updateProgress(processed, found, percent, total);

      console.log(`[${processed}/${total}] Processing: ${row['Chase Description']?.substring(0, 40) || 'Unknown'}`);

      // Call AI match endpoint for this row
      const res = await fetch('/ai_match', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({_index: row._index})
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();

      if (data.ok && data.result.receipt_file) {
        found++;
        // Update the row in our data
        Object.assign(row, data.result);

        // Mark as newly matched for visual highlighting
        row._newlyMatched = true;

        // Log the match
        const merchant = row['Chase Description'] || 'Unknown';
        const confidence = data.result.ai_confidence || 0;
        console.log(`  ‚úì Found receipt: ${confidence}% confidence`);
        addProgressLog(`‚úì ${merchant.substring(0, 30)} ‚Üí ${confidence}% match`, 'ok');
      } else {
        console.log(`  ‚äò No match found`);
        addProgressLog(`‚äò ${(row['Chase Description'] || 'Unknown').substring(0, 30)} ‚Üí No match`, 'muted');
      }

      // Update progress counters
      document.getElementById('progress-found').textContent = found;

    } catch (e) {
      console.error(`  ‚úó Error processing receipt:`, e);
      addProgressLog(`‚úó Error: ${e.message}`, 'bad');
    }
  }

  // Calculate time
  const elapsed = Math.round((Date.now() - startTime) / 1000);
  console.log(`‚úÖ Batch complete in ${elapsed}s: Found ${found} of ${total} receipts`);

  // Complete - hide cancel, show close button
  document.getElementById('progress-cancel-btn').style.display = 'none';
  document.getElementById('progress-close-btn').style.display = 'block';
  addProgressLog(`\nüéâ Complete! Found ${found} of ${total} receipts (${elapsed}s)`, 'ok');

  // Reload CSV to get all updates
  await loadCSV();
  showToast(`Batch complete! Found ${found} of ${total} receipts`, '‚úì');

  // Auto-remove highlighting after 30 seconds
  setTimeout(() => {
    csvData.forEach(row => {
      if (row._newlyMatched) {
        row._newlyMatched = false;
      }
    });
    renderTable();
    console.log('üé® Removed newly-matched highlighting');
  }, 30000);
}

function cancelBatchProcess() {
  if (confirm('Cancel batch processing?')) {
    batchProcessCancelled = true;
    console.log('üõë Cancelling batch process...');
  }
}

function updateProgress(processed, found, percent, total) {
  document.getElementById('progress-bar').style.width = `${percent}%`;
  document.getElementById('progress-text').textContent = `${percent}%`;
  document.getElementById('progress-processed').textContent = `${processed} / ${total}`;
  document.getElementById('progress-found').textContent = found;
}

function addProgressLog(message, type = 'muted') {
  const log = document.getElementById('progress-log');
  const colors = {
    ok: 'var(--ok)',
    bad: 'var(--bad)',
    muted: 'var(--muted)'
  };

  const entry = document.createElement('div');
  entry.style.color = colors[type] || colors.muted;
  entry.textContent = message;

  // Keep only last 20 entries
  if (log.children.length > 20) {
    log.removeChild(log.firstChild);
  }

  log.appendChild(entry);
  log.scrollTop = log.scrollHeight; // Auto-scroll to bottom
}

function closeProgressModal() {
  document.getElementById('progress-modal').classList.remove('active');
  renderTable();
}

async function detachReceipt() {
  if (!selectedRow) return;

  try {
    await fetch('/detach_receipt', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({_index: selectedRow._index})
    });
    selectedRow['Receipt File'] = '';
    selectedRow.receipt_file = '';
    renderTable();
    updateDashboard();  // ‚úÖ FIX: Update counts badge after detaching receipt
    loadReceipt();
    showToast('Receipt detached', '‚úì');
  } catch (e) {
    showToast('Failed to detach: ' + e.message, '‚ùå');
  }
}

async function updateField(field, value) {
  if (!selectedRow) return;

  // Save scroll position BEFORE update
  const scrollContainer = document.querySelector('.table-wrap');
  const scrollPos = scrollContainer ? scrollContainer.scrollTop : 0;

  selectedRow[field] = value;
  try {
    await fetch('/update_row', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        _index: selectedRow._index,
        patch: {[field]: value}  // FIXED: was 'updates', should be 'patch'
      })
    });

    // ‚úÖ FIX: Re-apply filters to rebuild filteredData with updated values
    // applyFilters() calls renderTable() + updateDashboard() - handles everything
    applyFilters();

    // Restore scroll position
    if (scrollContainer) {
      scrollContainer.scrollTop = scrollPos;
    }
  } catch (e) {
    showToast('Update failed: ' + e.message, '‚ùå');
  }
}

// NEW: Update a single row in-place without rebuilding table
function updateRowInPlace(row) {
  const tbody = document.getElementById('tbody');
  const tr = Array.from(tbody.children).find(
    tr => tr.dataset.index == row._index
  );

  if (!tr) {
    // Row doesn't exist in current filter - it may have been filtered out
    applyFilters();  // Re-filter to remove it
    return;
  }

  // Update cells in-place
  const cells = tr.cells;
  if (!cells || cells.length < 7) return;

  // Cell 0: Date - handles both YYYY-MM-DD and MySQL date formats
  const dateStr = row['Chase Date'] || '';
  if (dateStr) {
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    let year, month, day;
    const parts = dateStr.split('-');
    if (parts.length === 3 && parts[0].length === 4) {
      year = parts[0];
      month = months[parseInt(parts[1]) - 1] || parts[1];
      day = parseInt(parts[2]);
    } else {
      try {
        const d = new Date(dateStr);
        if (!isNaN(d.getTime())) {
          year = d.getFullYear();
          month = months[d.getMonth()];
          day = d.getDate();
        }
      } catch (e) {}
    }
    if (year && month && day) {
      cells[0].innerHTML = `<div class="date-cell"><span class="date-month-day">${month} ${day}</span><span class="date-year">${year}</span></div>`;
    }
  }

  // Cell 1: Description
  cells[1].textContent = row['Chase Description'] || '';

  // Cell 2: Amount
  const amt = parseFloat(row['Chase Amount'] || 0);
  const amtClass = amt > 0 ? 'neg' : 'pos';
  const amtSign = amt > 0 ? '-' : '+';
  cells[2].innerHTML = `<span class="amount ${amtClass}">${amtSign}$${Math.abs(amt).toFixed(2)}</span>`;

  // Cell 3: Business Type
  cells[3].textContent = row['Business Type'] || '';

  // Cell 4: Review Status
  cells[4].innerHTML = getStatusBadge(row['Review Status']);

  // Cell 5: AI Confidence
  cells[5].innerHTML = getConfidenceIndicator(row);

  // Cell 6: Notes
  const notes = row['Notes'] || '';
  const notesHtml = notes
    ? `<div class="notes-cell" onclick="editNotes(event, ${row._index})" title="${notes}">${notes}</div>`
    : `<div class="notes-cell empty" onclick="editNotes(event, ${row._index})">Click to add note</div>`;
  cells[6].innerHTML = notesHtml;
}

// Connect Gmail account via OAuth popup
function connectGmail(email) {
  showToast(`Opening Google authorization...`, 'üîó');

  // Open OAuth in a popup window
  const width = 600;
  const height = 700;
  const left = (window.innerWidth - width) / 2 + window.screenX;
  const top = (window.innerHeight - height) / 2 + window.screenY;

  const popup = window.open(
    `/api/gmail/authorize/${encodeURIComponent(email)}`,
    'gmail_oauth',
    `width=${width},height=${height},left=${left},top=${top},menubar=no,toolbar=no,location=no,status=no`
  );

  // Poll for popup closure and refresh status
  const pollTimer = setInterval(() => {
    if (popup.closed) {
      clearInterval(pollTimer);
      showToast('Checking Gmail status...', 'üîÑ');
      setTimeout(() => checkGmailStatus(), 500);
    }
  }, 500);
}

// Disconnect Gmail account
async function disconnectGmail(email) {
  if (!confirm(`Disconnect ${email}? You'll need to re-authorize to use Gmail features.`)) {
    return;
  }

  try {
    const res = await fetch(`/api/gmail/disconnect/${encodeURIComponent(email)}`, {
      method: 'POST'
    });
    const data = await res.json();
    if (data.ok) {
      showToast(`Disconnected ${email}`, '‚úì');
      await checkGmailStatus();
    } else {
      showToast(data.error || 'Failed to disconnect', '‚ùå');
    }
  } catch (e) {
    showToast(`Error: ${e.message}`, '‚ùå');
  }
}

// Check Gmail account status from backend
async function checkGmailStatus() {
  const emailToId = {
    'kaplan.brian@gmail.com': { status: 'gmail-status-personal', btn: 'gmail-btn-personal' },
    'brian@musiccityrodeo.com': { status: 'gmail-status-mcr', btn: 'gmail-btn-mcr' },
    'brian@downhome.com': { status: 'gmail-status-downhome', btn: 'gmail-btn-downhome' }
  };

  try {
    const res = await fetch('/settings/gmail/status');
    const data = await res.json();

    if (data.ok && data.accounts) {
      data.accounts.forEach(account => {
        const ids = emailToId[account.email];
        if (!ids) return;

        const statusEl = document.getElementById(ids.status);
        const btnEl = document.getElementById(ids.btn);

        if (!statusEl) return;

        const isConnected = account.exists && account.has_refresh_token && !account.expired;

        if (!account.exists) {
          statusEl.className = 'badge badge-neutral';
          statusEl.textContent = 'Not connected';
          if (btnEl) {
            btnEl.textContent = 'üîó Connect';
            btnEl.onclick = () => connectGmail(account.email);
          }
        } else if (account.expired) {
          statusEl.className = 'badge badge-bad';
          statusEl.textContent = 'Expired';
          if (btnEl) {
            btnEl.textContent = 'üîÑ Reconnect';
            btnEl.onclick = () => connectGmail(account.email);
          }
        } else if (account.has_refresh_token) {
          statusEl.className = 'badge badge-good';
          statusEl.textContent = 'Connected';
          if (btnEl) {
            btnEl.textContent = 'üîå Disconnect';
            btnEl.onclick = () => disconnectGmail(account.email);
          }
        } else {
          statusEl.className = 'badge badge-neutral';
          statusEl.textContent = 'Needs auth';
          if (btnEl) {
            btnEl.textContent = 'üîó Connect';
            btnEl.onclick = () => connectGmail(account.email);
          }
        }
      });
    }
  } catch (e) {
    console.error('Error checking Gmail status:', e);
  }
}

// Rendering
function renderTable() {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';

  filteredData.forEach(row => {
    const tr = document.createElement('tr');
    if (selectedRow && row._index === selectedRow._index) {
      tr.classList.add('selected');
    }

    // Highlight newly matched receipts
    if (row._newlyMatched) {
      tr.classList.add('newly-matched');
    }

    // Check if this is a refund
    // ‚úÖ Refunds = negative amounts OR review_status = refund
    const amount = parseFloat(row['Chase Amount'] || row['Amount'] || 0);
    const isRefund = amount < 0 || row['Review Status'] === 'refund';
    if (isRefund) {
      tr.classList.add('refund-row');
    }

    // Format date as "MMM DD" and "YYYY" - handles both YYYY-MM-DD and "Sat, 22 Nov 2025 00:00:00 GMT" formats
    const dateStr = row['Chase Date'] || '';
    let dateHtml = '';
    if (dateStr) {
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      let year, month, day;

      // Try YYYY-MM-DD format first
      const parts = dateStr.split('-');
      if (parts.length === 3 && parts[0].length === 4) {
        year = parts[0];
        month = months[parseInt(parts[1]) - 1] || parts[1];
        day = parseInt(parts[2]);
      } else {
        // Try parsing as Date string (handles "Sat, 22 Nov 2025 00:00:00 GMT")
        try {
          const d = new Date(dateStr);
          if (!isNaN(d.getTime())) {
            year = d.getFullYear();
            month = months[d.getMonth()];
            day = d.getDate();
          }
        } catch (e) {}
      }

      if (year && month && day) {
        dateHtml = `
          <div class="date-cell">
            <span class="date-month-day">${month} ${day}</span>
            <span class="date-year">${year}</span>
          </div>
        `;
      } else {
        dateHtml = dateStr;
      }
    }

    // Format amount with +/- sign (Positive in CSV = Expense, Negative = Refund)
    const amt = parseFloat(row['Chase Amount'] || 0);
    const amtClass = amt > 0 ? 'neg' : 'pos';  // Positive = expense (red), Negative = refund (green)
    const amtSign = amt > 0 ? '-' : '+';  // Show - for expenses, + for refunds
    const amtHtml = `<span class="amount ${amtClass}">${amtSign}$${Math.abs(amt).toFixed(2)}</span>`;

    // MI Enhanced fields
    const miMerchant = row['MI Merchant'] || row['Chase Description'] || '';
    const miCategory = row['MI Category'] || row['Chase Category'] || '';
    const miDescription = row['MI Description'] || row['Notes'] || '';
    const isSubscription = row['MI Is Subscription'] === 1;

    // Merchant cell with subscription badge
    const merchantHtml = isSubscription
      ? `<div class="merchant-cell" title="${row['Chase Description'] || ''}">${miMerchant} <span class="sub-badge">SUB</span></div>`
      : `<div class="merchant-cell" title="${row['Chase Description'] || ''}">${miMerchant}</div>`;

    // Category cell
    const categoryHtml = `<span class="category-badge">${miCategory}</span>`;

    // Description cell with inline editing
    const descHtml = miDescription
      ? `<div class="notes-cell" onclick="editNotes(event, ${row._index})" title="${miDescription}">${miDescription}</div>`
      : `<div class="notes-cell empty" onclick="editNotes(event, ${row._index})">Click to add note</div>`;

    // Receipt indicator - show ‚úì if receipt exists, ‚úó if not
    const receiptFile = row['Receipt File'] || '';
    const r2Url = row['r2_url'] || row['R2 URL'] || '';
    const hasReceipt = receiptFile || r2Url;
    const receiptHtml = hasReceipt
      ? `<span class="receipt-indicator has-receipt" title="${receiptFile}">‚úì</span>`
      : `<span class="receipt-indicator no-receipt">‚úó</span>`;

    tr.innerHTML = `
      <td>${dateHtml}</td>
      <td>${merchantHtml}</td>
      <td>${amtHtml}</td>
      <td>${categoryHtml}</td>
      <td>${row['Business Type'] || ''}</td>
      <td>${getStatusBadge(row['Review Status'], isRefund)}</td>
      <td>${receiptHtml}</td>
      <td>${descHtml}</td>
    `;

    tr.dataset.index = row._index;
    tr.onclick = (e) => {
      // Don't select row if clicking on notes cell
      if (!e.target.classList.contains('notes-cell') && !e.target.classList.contains('notes-input')) {
        selectRow(row);
      }
    };
    tbody.appendChild(tr);
  });
}

function getStatusBadge(status, isRefund) {
  if (isRefund || status === 'refund') return '<span class="badge badge-refund">Refund</span>';
  if (!status) return '<span class="badge badge-pending">Pending</span>';
  if (status === 'good') return '<span class="badge badge-good">Good</span>';
  if (status === 'bad') return '<span class="badge badge-bad">Bad</span>';
  return `<span class="badge badge-pending">${status}</span>`;
}

function getConfidenceIndicator(row) {
  // Check if receipt exists
  if (!row['Receipt File']) {
    return '‚Äî';
  }

  // Get confidence score
  const confidence = parseFloat(row['AI Confidence']) || 0;

  // Determine confidence level and color
  let level, className, label;
  if (confidence >= 90) {
    level = 'excellent';
    className = 'conf-excellent';
    label = `${confidence.toFixed(0)}%`;
  } else if (confidence >= 80) {
    level = 'very-good';
    className = 'conf-very-good';
    label = `${confidence.toFixed(0)}%`;
  } else if (confidence >= 70) {
    level = 'good';
    className = 'conf-good';
    label = `${confidence.toFixed(0)}%`;
  } else if (confidence >= 60) {
    level = 'fair';
    className = 'conf-fair';
    label = `${confidence.toFixed(0)}%`;
  } else if (confidence > 0) {
    level = 'low';
    className = 'conf-low';
    label = `${confidence.toFixed(0)}%`;
  } else {
    // Receipt exists but no confidence score
    level = 'none';
    className = 'conf-none';
    label = '‚Äî';
  }

  return `<span class="confidence-indicator ${className}" title="Match Confidence: ${label}">
    <span class="confidence-dot ${className}"></span>
    ${label}
  </span>`;
}

function selectRow(row) {
  selectedRow = row;
  renderTable();
  loadReceipt();
}

// Notes inline editing
function editNotes(event, rowIndex) {
  event.stopPropagation();

  const row = csvData.find(r => r._index === rowIndex);
  if (!row) return;

  const cell = event.target;
  const currentNotes = row['Notes'] || '';

  // Create input field
  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'notes-input';
  input.value = currentNotes;
  input.placeholder = 'Add note...';

  // Replace cell content
  cell.innerHTML = '';
  cell.appendChild(input);
  input.focus();
  input.select();

  // Save on blur or Enter
  const saveNotes = async () => {
    const newNotes = input.value.trim();
    row['Notes'] = newNotes;

    // Update on server
    try {
      await fetch('/update_row', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          _index: rowIndex,
          patch: {Notes: newNotes}
        })
      });
      renderTable();
      showToast('Note saved', '‚úì');
    } catch (e) {
      showToast('Failed to save note: ' + e.message, '‚ùå');
      renderTable();
    }
  };

  input.addEventListener('blur', saveNotes);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      saveNotes();
    } else if (e.key === 'Escape') {
      renderTable();
    }
  });
}

function loadReceipt() {
  const wrap = document.getElementById('panzoom-wrap');
  const title = document.getElementById('viewer-title');

  // Check for R2 URL first (cloud storage), then local Receipt File
  const r2Url = selectedRow ? (selectedRow['r2_url'] || selectedRow['R2 URL'] || selectedRow['receipt_url']) : null;
  const receiptFile = selectedRow ? selectedRow['Receipt File'] : null;

  if (!selectedRow || (!receiptFile && !r2Url)) {
    wrap.innerHTML = `
      <div class="no-receipt">
        <div class="no-receipt-icon">üìÑ</div>
        <div class="no-receipt-text">No receipt attached</div>
      </div>`;
    title.textContent = 'Receipt Viewer';
    return;
  }

  // Handle multiple receipt paths (comma-separated) - take first one
  let receiptPath = receiptFile ? receiptFile.split(',')[0].trim() : '';

  // Skip special values
  if (receiptPath === 'NO_RECEIPT_NEEDED' || receiptPath === 'NO_RECEIPT') {
    wrap.innerHTML = `
      <div class="no-receipt">
        <div class="no-receipt-icon">‚úì</div>
        <div class="no-receipt-text">No receipt needed</div>
      </div>`;
    title.textContent = 'No Receipt Needed';
    return;
  }

  // Set title from receipt path or R2 URL
  if (receiptPath) {
    title.textContent = receiptPath.split('/').pop();
  } else if (r2Url) {
    title.textContent = r2Url.split('/').pop();
  }

  const img = document.createElement('img');

  // Use R2 URL if available (cloud storage), otherwise use local path
  if (r2Url && r2Url.startsWith('http')) {
    img.src = r2Url;
  } else if (receiptPath) {
    // Build proper local path - handle various path formats
    if (receiptPath.startsWith('receipts/')) {
      img.src = `/${receiptPath}`;
    } else if (receiptPath.startsWith('incoming/')) {
      img.src = `/${receiptPath}`;
    } else {
      img.src = `/receipts/${receiptPath}`;
    }
  } else {
    // Fallback - no valid path
    wrap.innerHTML = `
      <div class="no-receipt">
        <div class="no-receipt-icon">üìÑ</div>
        <div class="no-receipt-text">Receipt path not found</div>
      </div>`;
    title.textContent = 'Receipt Viewer';
    return;
  }
  img.alt = 'Receipt';
  img.style.imageOrientation = 'from-image'; // Auto-handle EXIF orientation

  // Auto-rotation: detect if image needs rotation after load
  img.onload = function() {
    let rotation = currentRotation;

    // Auto-rotate landscape images (width > height * 1.3) to portrait
    if (currentRotation === 0 && img.naturalWidth > img.naturalHeight * 1.3) {
      rotation = 90;
      currentRotation = 90;
    }

    // Apply rotation
    img.style.transform = `rotate(${rotation}deg)`;

    // Re-initialize panzoom after image loads
    if (panzoomInstance) panzoomInstance.destroy();
    panzoomInstance = Panzoom(img, {
      maxScale: 5,
      minScale: 0.5,
      startScale: 1.2,
      contain: 'outside'
    });

    wrap.addEventListener('wheel', panzoomInstance.zoomWithWheel);
  };

  // Initial rotation transform
  img.style.transform = `rotate(${currentRotation}deg)`;

  wrap.innerHTML = '';
  wrap.appendChild(img);
}

function updateDashboard() {
  // ‚úÖ FIX: Use csvData for header totals so they ALWAYS show ALL transactions
  // This ensures live stats update correctly when business type changes
  const dataToUse = csvData;

  // Calculate totals by Business Type
  // Expenses (positive) + Refunds (negative, excluding payments) = Net Total
  // ‚úÖ FIX: Use both Title Case and snake_case field names for robust field access
  const getAmount = (r) => parseFloat(r['Chase Amount'] || r['chase_amount'] || 0);
  const getDesc = (r) => (r['Chase Description'] || r['chase_description'] || '').toLowerCase();
  const isPaymentTxn = (desc) => desc.includes('payment thank you') || desc.includes('payment - web');

  const downHomeTotal = dataToUse
    .filter(r => r['Business Type'] === 'Down Home')
    .reduce((sum, r) => {
      const amt = getAmount(r);
      const desc = getDesc(r);
      // Include positive (expenses) and negative (refunds, but not payments)
      if (isPaymentTxn(desc)) return sum;  // Skip payments
      return sum + amt;  // Add positive expenses, subtract refunds (negative amounts)
    }, 0);

  const mcrTotal = dataToUse
    .filter(r => r['Business Type'] === 'Music City Rodeo')
    .reduce((sum, r) => {
      const amt = getAmount(r);
      const desc = getDesc(r);
      if (isPaymentTxn(desc)) return sum;
      return sum + amt;
    }, 0);

  const personalTotal = dataToUse
    .filter(r => r['Business Type'] === 'Personal')
    .reduce((sum, r) => {
      const amt = getAmount(r);
      const desc = getDesc(r);
      if (isPaymentTxn(desc)) return sum;
      return sum + amt;
    }, 0);

  // Credit Card Payments - Description contains "PAYMENT THANK YOU" (negative amounts)
  const paymentsTotal = dataToUse
    .reduce((sum, r) => {
      const amt = getAmount(r);
      const desc = getDesc(r);
      return isPaymentTxn(desc) ? sum + Math.abs(amt) : sum;
    }, 0);

  document.getElementById('down-home-total').textContent = `$${downHomeTotal.toFixed(2)}`;
  document.getElementById('mcr-total').textContent = `$${mcrTotal.toFixed(2)}`;
  document.getElementById('personal-total').textContent = `$${personalTotal.toFixed(2)}`;
  document.getElementById('payments-total').textContent = `+$${paymentsTotal.toFixed(2)}`;

  // Update ALL filter counts (from ALL data, not filtered)
  const counts = {
    all: csvData.length,
    // ‚úÖ Needs review = has receipt AND (no status OR status not in good/bad/not needed)
    needsReview: csvData.filter(r => {
      const status = (r['Review Status'] || '').toLowerCase().trim();
      const hasReceipt = r['Receipt File'] && r['Receipt File'].trim() !== '';
      return hasReceipt && (!status || (status !== 'good' && status !== 'bad' && status !== 'not needed'));
    }).length,
    // ‚úÖ Good/Bad must have receipts
    good: csvData.filter(r => {
      const hasReceipt = r['Receipt File'] && r['Receipt File'].trim() !== '';
      return hasReceipt && r['Review Status'] === 'good';
    }).length,
    bad: csvData.filter(r => {
      const hasReceipt = r['Receipt File'] && r['Receipt File'].trim() !== '';
      return hasReceipt && r['Review Status'] === 'bad';
    }).length,
    missing: csvData.filter(r => (!r['Receipt File'] || r['Receipt File'] === '' || r['Receipt File'] === 'None') && r['Receipt File'] !== 'NO_RECEIPT_NEEDED' && r['Review Status'] !== 'not needed').length,
    withReceipts: csvData.filter(r => r['Receipt File'] && r['Receipt File'] !== 'NO_RECEIPT_NEEDED').length,
    notNeeded: csvData.filter(r => r['Review Status'] === 'not needed' || r['Receipt File'] === 'NO_RECEIPT_NEEDED').length,
    // ‚úÖ Refunds = negative amounts OR review_status = refund
    refunds: csvData.filter(r => {
      const amount = parseFloat(r['Chase Amount'] || r['Amount'] || 0);
      return amount < 0 || r['Review Status'] === 'refund';
    }).length,
    mcr: csvData.filter(r => r['Business Type'] === 'Music City Rodeo').length,
    downhome: csvData.filter(r => r['Business Type'] === 'Down Home').length,
    personal: csvData.filter(r => r['Business Type'] === 'Personal').length,
    unassigned: csvData.filter(r => !r['Business Type'] || r['Business Type'] === 'Unassigned').length,
    alreadySubmitted: csvData.filter(r => {
      const submitted = (r['Already Submitted'] || '').toLowerCase().trim();
      return submitted === 'yes';
    }).length
  };

  // Update badge elements (badges are now shown on hover via CSS)
  const updateBadge = (id, count) => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = count;
      // No need to control display - CSS handles visibility via hover
    }
  };

  updateBadge('all-count', counts.all);
  updateBadge('needs-review-count', counts.needsReview);
  updateBadge('good-count', counts.good);
  updateBadge('bad-count', counts.bad);
  updateBadge('missing-count', counts.missing);
  updateBadge('with-receipts-count', counts.withReceipts);
  updateBadge('not-needed-count', counts.notNeeded);
  updateBadge('refunds-count', counts.refunds);
  updateBadge('mcr-count', counts.mcr);
  updateBadge('downhome-count', counts.downhome);
  updateBadge('personal-count', counts.personal);
  updateBadge('unassigned-count', counts.unassigned);
  updateBadge('already-submitted-count', counts.alreadySubmitted);
}

// Image controls
function rotateImage() {
  currentRotation = (currentRotation + 90) % 360;
  loadReceipt();
}

function zoomIn() {
  if (panzoomInstance) panzoomInstance.zoomIn();
}

function zoomOut() {
  if (panzoomInstance) panzoomInstance.zoomOut();
}

function resetZoom() {
  currentRotation = 0; // Reset rotation first
  if (panzoomInstance) {
    panzoomInstance.reset();
    panzoomInstance.zoom(1.2); // Reset to 120%
  }
  loadReceipt(); // Reload to apply reset rotation
}

// Quick Viewer - Fast Navigation
let quickViewerReceipts = []; // All receipts with images
let quickViewerIndex = 0; // Current index in receipts array
let quickPanzoomInstance = null; // Panzoom instance for quick viewer

function openQuickViewer() {
  if (!selectedRow) return;

  // Build list of ALL receipts (filtered or all, depending on view)
  quickViewerReceipts = filteredData.filter(r => r['Receipt File'] && r['Receipt File'].trim() !== '');

  if (quickViewerReceipts.length === 0) {
    showToast('No receipts to view', 'üìÑ');
    return;
  }

  // Find current row in the list
  quickViewerIndex = quickViewerReceipts.findIndex(r => r._index === selectedRow._index);
  if (quickViewerIndex === -1) quickViewerIndex = 0;

  // Show modal and load first receipt
  document.getElementById('quick-viewer').classList.add('active');
  updateQuickViewer();

  // Focus modal for keyboard events
  document.getElementById('quick-viewer').focus();
}

function closeQuickViewer() {
  // Cleanup Panzoom instance
  if (quickPanzoomInstance) {
    quickPanzoomInstance.destroy();
    quickPanzoomInstance = null;
  }
  document.getElementById('quick-viewer').classList.remove('active');
}

function navigateQuickViewer(direction) {
  if (quickViewerReceipts.length === 0) return;

  quickViewerIndex += direction;

  // Wrap around
  if (quickViewerIndex < 0) quickViewerIndex = quickViewerReceipts.length - 1;
  if (quickViewerIndex >= quickViewerReceipts.length) quickViewerIndex = 0;

  updateQuickViewer();
}

function jumpToQuickReceipt(percent) {
  if (quickViewerReceipts.length === 0) return;
  quickViewerIndex = Math.floor((quickViewerReceipts.length - 1) * (percent / 10));
  updateQuickViewer();
}

function updateQuickViewer() {
  const receipt = quickViewerReceipts[quickViewerIndex];
  if (!receipt) return;

  const imageDiv = document.getElementById('quick-image');

  // Update title
  document.getElementById('quick-title').textContent =
    `${receipt['Chase Description']} - ${receipt['Chase Date']}`;

  // Preserve zoom controls and confidence badge
  const zoomControls = imageDiv.querySelector('.quick-zoom-controls');
  const confidenceBadge = imageDiv.querySelector('.match-confidence');

  // Update image
  if (receipt['Receipt File']) {
    const imgEl = document.createElement('img');
    imgEl.src = `/receipts/${receipt['Receipt File']}`;
    imgEl.alt = 'Receipt';
    imgEl.style.transition = 'opacity 0.2s ease';
    imgEl.style.imageOrientation = 'from-image'; // Auto-handle EXIF orientation
    imgEl.id = 'quick-viewer-img';

    // Auto-rotation: detect if image needs rotation after load
    imgEl.onload = function() {
      // Auto-rotate landscape images (width > height * 1.3) to portrait
      if (imgEl.naturalWidth > imgEl.naturalHeight * 1.3) {
        imgEl.style.transform = 'rotate(90deg)';
      } else {
        imgEl.style.transform = 'none';
      }
    };

    // Initial transform (will be updated in onload)
    imgEl.style.transform = 'none';

    // Clear and rebuild
    imageDiv.innerHTML = '';
    if (zoomControls) imageDiv.appendChild(zoomControls);
    if (confidenceBadge) imageDiv.appendChild(confidenceBadge);
    imageDiv.appendChild(imgEl);

    // Initialize Panzoom on new image
    setTimeout(() => {
      if (quickPanzoomInstance) {
        quickPanzoomInstance.destroy();
      }
      quickPanzoomInstance = Panzoom(imgEl, {
        maxScale: 5,
        minScale: 0.5,
        step: 0.2,
        contain: 'outside'
      });
    }, 50);
  } else {
    imageDiv.innerHTML = `
      <div class="no-receipt">
        <div class="no-receipt-icon">üìÑ</div>
        <div class="no-receipt-text">No receipt attached</div>
      </div>`;
    if (zoomControls) imageDiv.appendChild(zoomControls);
    if (confidenceBadge) imageDiv.appendChild(confidenceBadge);
  }

  // Check if this is an AI-matched receipt
  const isAIMatched = receipt['AI Note'] && receipt['AI Note'].trim() !== '';
  const confidence = parseFloat(receipt['AI Confidence'] || 0);

  // Show/hide confidence badge
  const badge = document.getElementById('quick-match-badge');
  if (isAIMatched && confidence > 0) {
    badge.style.display = 'flex';
    document.getElementById('quick-confidence-text').textContent = `${confidence}% Match`;

    // Color code by confidence
    badge.classList.remove('high', 'medium', 'low');
    if (confidence >= 85) badge.classList.add('high');
    else if (confidence >= 70) badge.classList.add('medium');
    else badge.classList.add('low');
  } else {
    badge.style.display = 'none';
  }

  // Update data with match highlighting
  updateQuickDataRow('quick-merchant', receipt['Chase Description'] || '‚Äî', isAIMatched);

  const amt = parseFloat(receipt['Chase Amount'] || 0);
  const amtSign = amt > 0 ? '-' : '+';
  updateQuickDataRow('quick-amount', `${amtSign}$${Math.abs(amt).toFixed(2)}`, isAIMatched, true);

  updateQuickDataRow('quick-date', receipt['Chase Date'] || '‚Äî', isAIMatched);

  // Update Business Type dropdown
  const businessSelect = document.getElementById('quick-business');
  businessSelect.value = receipt['Business Type'] || '';

  // Update Category (read-only)
  document.getElementById('quick-category').textContent = receipt['Chase Category'] || '‚Äî';

  // Update Status dropdown
  const statusSelect = document.getElementById('quick-status');
  statusSelect.value = receipt['Review Status'] || '';

  // Update Notes textarea
  const notesTextarea = document.getElementById('quick-notes');
  notesTextarea.value = receipt['Notes'] || '';

  // Update AI Note textarea
  const aiNoteTextarea = document.getElementById('quick-ai-note');
  aiNoteTextarea.value = receipt['AI Note'] || '';

  // Update position indicator
  document.getElementById('quick-position').textContent =
    `${quickViewerIndex + 1} / ${quickViewerReceipts.length}`;

  // Update button states
  document.getElementById('quick-prev').disabled = false;
  document.getElementById('quick-next').disabled = false;

  // ‚úÖ FIX: Update selectedRow so hotkeys (M, D, P, etc.) work on the correct transaction
  selectedRow = receipt;

  // Preload adjacent images for smooth navigation
  preloadAdjacentReceipts();
}

// Helper to update data row with match highlighting
function updateQuickDataRow(elementId, value, isMatched, isLarge = false) {
  const element = document.getElementById(elementId);
  const row = element.closest('.data-row');

  element.textContent = value;

  if (isMatched) {
    row.classList.add('matched');
  } else {
    row.classList.remove('matched');
  }
}

// Quick Viewer Zoom Functions
function quickZoom(delta) {
  if (quickPanzoomInstance) {
    const currentScale = quickPanzoomInstance.getScale();
    quickPanzoomInstance.zoom(currentScale + delta);
  }
}

function quickResetZoom() {
  if (quickPanzoomInstance) {
    quickPanzoomInstance.reset();
  }
}

// Handle keyboard shortcuts in textareas (Ctrl+Enter to save, Escape to blur)
function handleTextareaKeys(event, field) {
  // Ctrl+Enter or Cmd+Enter to save
  if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
    event.preventDefault();
    const textarea = event.target;
    quickUpdateField(field, textarea.value);
    textarea.blur(); // Remove focus after saving
    showToast(`${field} saved`, '‚úì');
  }
  // Escape to cancel and blur
  else if (event.key === 'Escape') {
    event.preventDefault();
    event.target.blur();
  }
}

// Quick Viewer Field Update - Updates database AND refreshes display
async function quickUpdateField(field, value) {
  const currentReceipt = quickViewerReceipts[quickViewerIndex];
  if (!currentReceipt) return;

  const rowIndex = currentReceipt._index;

  // Update local data immediately for responsive UI
  currentReceipt[field] = value;

  // Also update selectedRow if it's the same transaction
  if (selectedRow && selectedRow._index === rowIndex) {
    selectedRow[field] = value;
  }

  // Update in csvData array
  const csvIndex = csvData.findIndex(r => r._index === rowIndex);
  if (csvIndex !== -1) {
    csvData[csvIndex][field] = value;
  }

  // Update in filteredData array
  const filteredIndex = filteredData.findIndex(r => r._index === rowIndex);
  if (filteredIndex !== -1) {
    filteredData[filteredIndex][field] = value;
  }

  try {
    // Save to backend (SQLite + CSV)
    const response = await fetch('/update_row', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        _index: rowIndex,
        patch: {[field]: value}
      })
    });

    if (!response.ok) {
      throw new Error(`Server returned ${response.status}`);
    }

    // ‚úÖ FIX: Re-apply filters - this handles renderTable() + updateDashboard()
    applyFilters();

    // Update the quick viewer UI to reflect the change
    if (field === 'Review Status') {
      document.getElementById('quick-status').value = value;
    } else if (field === 'Business Type') {
      document.getElementById('quick-business').value = value;
    } else if (field === 'Notes') {
      document.getElementById('quick-notes').value = value;
    } else if (field === 'AI Note') {
      document.getElementById('quick-ai-note').value = value;
    }

    // Show success toast
    showToast(`${field} updated`, '‚úì');

    console.log(`‚úÖ Quick Viewer: Updated ${field} = "${value}" for transaction #${rowIndex}`);
  } catch (e) {
    showToast(`Failed to update ${field}: ${e.message}`, '‚ùå');
    console.error(`‚ùå Quick Viewer update failed:`, e);
  }
}

function preloadAdjacentReceipts() {
  const preloadIndices = [quickViewerIndex - 1, quickViewerIndex + 1];

  preloadIndices.forEach(idx => {
    if (idx >= 0 && idx < quickViewerReceipts.length) {
      const receipt = quickViewerReceipts[idx];
      if (receipt['Receipt File']) {
        const img = new Image();
        img.src = `/receipts/${receipt['Receipt File']}`;
      }
    }
  });
}

// Keyboard shortcuts for quick viewer
document.addEventListener('keydown', (e) => {
  const modal = document.getElementById('quick-viewer');
  if (!modal.classList.contains('active')) return;
  // Don't interfere with input fields, textareas, or select dropdowns
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

  const key = e.key.toLowerCase();

  switch(key) {
    case 'arrowleft':
      e.preventDefault();
      navigateQuickViewer(-1);
      break;
    case 'arrowright':
      e.preventDefault();
      navigateQuickViewer(1);
      break;
    case 'escape':
      e.preventDefault();
      closeQuickViewer();
      break;
    // Status hotkeys
    case 'g':
      e.preventDefault();
      quickUpdateField('Review Status', 'good');
      break;
    case 'b':
      e.preventDefault();
      quickUpdateField('Review Status', 'bad');
      break;
    case 'n':
      e.preventDefault();
      quickUpdateField('Review Status', 'not needed');
      break;
    case 'c':
      e.preventDefault();
      quickUpdateField('Review Status', '');
      break;
    // Business type hotkeys
    case 'm':
      e.preventDefault();
      quickUpdateField('Business Type', 'Music City Rodeo');
      break;
    case 'd':
      e.preventDefault();
      quickUpdateField('Business Type', 'Down Home');
      break;
    case 'p':
      e.preventDefault();
      quickUpdateField('Business Type', 'Personal');
      break;
    // Action hotkeys
    case 'x':
      e.preventDefault();
      detachReceipt();
      break;
    case 'a':
      e.preventDefault();
      aiMatch();
      break;
    case 'j':
      e.preventDefault();
      aiNote();
      break;
    case 'f':
      e.preventDefault();
      closeQuickViewer();
      openMissingReceiptModal();
      break;
    case '1': case '2': case '3': case '4': case '5':
    case '6': case '7': case '8': case '9':
      e.preventDefault();
      jumpToQuickReceipt(parseInt(e.key));
      break;
    case 'home':
      e.preventDefault();
      quickViewerIndex = 0;
      updateQuickViewer();
      break;
    case 'end':
      e.preventDefault();
      quickViewerIndex = quickViewerReceipts.length - 1;
      updateQuickViewer();
      break;
    case '+':
    case '=':
      e.preventDefault();
      quickZoom(0.2);
      break;
    case '-':
    case '_':
      e.preventDefault();
      quickZoom(-0.2);
      break;
    case '0':
      e.preventDefault();
      quickResetZoom();
      break;
  }
});


// ========================================================================
// MAIN TABLE HOTKEYS (Arrow Up/Down, G/B/N, M/D/P, X, Enter, A, J)
// ========================================================================
document.addEventListener('keydown', (e) => {
  // Skip if in quick viewer modal
  const quickViewer = document.getElementById('quick-viewer');
  if (quickViewer && quickViewer.classList.contains('active')) return;

  // Skip if typing in input/textarea
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  // Skip if no row selected
  if (!selectedRow) return;

  const key = e.key.toLowerCase();

  switch(key) {
    case 'arrowup':
      e.preventDefault();
      navigateTable(-1);  // Move selection up
      break;

    case 'arrowdown':
      e.preventDefault();
      navigateTable(1);  // Move selection down
      break;

    case 'g':
      e.preventDefault();
      updateField('Review Status', 'good');
      showToast('Marked as GOOD', '‚úì');
      break;

    case 'b':
      e.preventDefault();
      updateField('Review Status', 'bad');
      showToast('Marked as BAD', '‚úó');
      break;

    case 'n':
      e.preventDefault();
      updateField('Review Status', 'not needed');
      showToast('Marked as NOT NEEDED', '‚ÑπÔ∏è');
      break;

    case 'm':
      e.preventDefault();
      updateField('Business Type', 'Music City Rodeo');
      showToast('Business Type: Music City Rodeo', 'üéµ');
      break;

    case 'd':
      e.preventDefault();
      updateField('Business Type', 'Down Home');
      showToast('Business Type: Down Home', 'üè†');
      break;

    case 'p':
      e.preventDefault();
      updateField('Business Type', 'Personal');
      showToast('Business Type: Personal', 'üë§');
      break;

    case 'x':
      e.preventDefault();
      if (confirm('Detach receipt from this transaction?')) {
        detachReceipt();
      }
      break;

    case 'enter':
      e.preventDefault();
      openQuickViewer(selectedRow);
      break;

    case 'a':
      e.preventDefault();
      aiMatch();
      break;

    case 'j':
      e.preventDefault();
      aiNote();
      break;

    case 'q':
      e.preventDefault();
      openQuickViewer();
      showToast('Quick Viewer Opened', '‚ö°');
      break;

    case 'f':
      e.preventDefault();
      openMissingReceiptModal();
      break;
  }
});

// Navigate table rows with arrow keys
function navigateTable(direction) {
  const currentIndex = filteredData.findIndex(row => row._index === selectedRow._index);
  if (currentIndex === -1) return;

  const newIndex = currentIndex + direction;

  if (newIndex >= 0 && newIndex < filteredData.length) {
    selectRow(filteredData[newIndex]);

    // Scroll selected row into view
    const selectedTr = document.querySelector('tr.selected');
    if (selectedTr) {
      selectedTr.scrollIntoView({ block: 'center', behavior: 'smooth' });
    }
  }
}


// Modals
function toggleHotkeyMenu() {
  const modal = document.getElementById('hotkey-modal');
  modal.classList.toggle('active');
}

function toggleSettings() {
  const modal = document.getElementById('settings-modal');
  modal.classList.toggle('active');

  // Update all settings info when opening
  if (modal.classList.contains('active')) {
    updateSettingsInfo();
    checkGmailStatus();
    checkSystemHealth();
  }
}

// Update settings info with live data
async function updateSettingsInfo() {
  // Update transaction count
  const transactionCount = DATA ? DATA.length : 0;
  const countEl = document.getElementById('transaction-count-setting');
  if (countEl) {
    countEl.textContent = transactionCount.toLocaleString() + ' transactions';
  }
}

// Check all system services
async function checkSystemHealth() {
  const dbStatus = document.getElementById('db-status');
  const r2Status = document.getElementById('r2-status');
  const geminiStatus = document.getElementById('ai-status');
  const ocrStatus = document.getElementById('health-ocr-status');

  // Show checking state
  if (dbStatus) dbStatus.innerHTML = '<span style="color:#fbbf24">Checking...</span>';
  if (r2Status) r2Status.innerHTML = '<span style="color:#fbbf24">Checking...</span>';
  if (geminiStatus) geminiStatus.innerHTML = '<span style="color:#fbbf24">Checking...</span>';
  if (ocrStatus) ocrStatus.innerHTML = '<span style="color:#fbbf24">Checking...</span>';

  // Check Database (via health endpoint)
  try {
    const healthRes = await fetch('/api/health');
    const dbRes = await fetch('/api/transactions?limit=1');
    if (healthRes.ok && dbRes.ok) {
      const health = await healthRes.json();
      const data = await dbRes.json();
      const dbType = health.database === 'connected' ? 'MySQL' : 'SQLite';
      const dbTypeDesc = document.getElementById('db-type-desc');
      if (dbTypeDesc) {
        dbTypeDesc.textContent = dbType === 'MySQL' ? 'MySQL on Railway' : 'SQLite - receipts.db';
      }
      if (dbStatus) {
        dbStatus.className = 'badge badge-good';
        dbStatus.textContent = `${dbType} ‚úì`;
      }
    } else {
      if (dbStatus) {
        dbStatus.className = 'badge badge-bad';
        dbStatus.textContent = 'Error';
      }
    }
  } catch (e) {
    if (dbStatus) {
      dbStatus.className = 'badge badge-bad';
      dbStatus.textContent = 'Offline';
    }
  }

  // Check R2 Storage (via health endpoint)
  try {
    const r2Res = await fetch('/api/health');
    if (r2Res.ok) {
      const health = await r2Res.json();
      if (r2Status) {
        if (health.r2_connected || health.storage === 'ok') {
          r2Status.innerHTML = '<span style="color:#00ff88">Connected ‚úì</span>';
        } else {
          r2Status.innerHTML = '<span style="color:#fbbf24">Not configured</span>';
        }
      }
      // Also check Gemini from same response
      if (geminiStatus) {
        if (health.gemini_configured || health.ai === 'ok') {
          geminiStatus.innerHTML = '<span style="color:#00ff88">Ready ‚úì</span>';
        } else {
          geminiStatus.innerHTML = '<span style="color:#fbbf24">No API key</span>';
        }
      }
    } else {
      if (r2Status) r2Status.innerHTML = '<span style="color:#fbbf24">Unknown</span>';
      if (geminiStatus) geminiStatus.innerHTML = '<span style="color:#fbbf24">Unknown</span>';
    }
  } catch (e) {
    if (r2Status) r2Status.innerHTML = '<span style="color:#fbbf24">Check failed</span>';
    if (geminiStatus) geminiStatus.innerHTML = '<span style="color:#fbbf24">Check failed</span>';
  }

  // OCR is always available (local Donut fallback)
  if (ocrStatus) {
    ocrStatus.innerHTML = '<span style="color:#00ff88">Ready ‚úì</span>';
  }

  showToast('System health check complete', 'success');
}

// Manual Entry Modal
function openManualEntryModal() {
  const modal = document.getElementById('manual-entry-modal');
  modal.classList.add('active');

  // Set today's date as default
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('manual-date').value = today;

  // Reset form
  document.getElementById('manual-entry-form').reset();
  document.getElementById('manual-date').value = today; // Re-set after reset
}

function closeManualEntryModal() {
  const modal = document.getElementById('manual-entry-modal');
  modal.classList.remove('active');
  document.getElementById('manual-entry-form').reset();

  // Reset OCR zone
  const dropZone = document.getElementById('ocr-drop-zone');
  dropZone.classList.remove('processing');
  document.getElementById('ocr-status').classList.remove('show', 'success', 'error');
  document.getElementById('ocr-preview').classList.remove('show');

  // Reset the stored receipt filename
  lastOCRReceiptFilename = null;
}

// ========================================================================
// MISSING RECEIPT FORM MODAL
// ========================================================================

function openMissingReceiptModal() {
  if (!selectedRow) {
    showToast('Select a transaction first', '‚ö†Ô∏è');
    return;
  }

  // Check if transaction already has a receipt
  const hasReceipt = selectedRow['Receipt File'] || selectedRow['receipt_file'];
  if (hasReceipt) {
    if (!confirm('This transaction already has a receipt attached. Generate a Missing Receipt Form anyway?')) {
      return;
    }
  }

  const modal = document.getElementById('missing-receipt-modal');
  modal.classList.add('active');

  // Populate transaction details
  const merchant = selectedRow['mi_merchant'] || selectedRow['MI Merchant'] || selectedRow['Chase Description'] || selectedRow['chase_description'] || 'Unknown';
  const amount = parseFloat(selectedRow['Chase Amount'] || selectedRow['chase_amount'] || 0);
  const date = selectedRow['Chase Date'] || selectedRow['chase_date'] || '';

  document.getElementById('mrf-merchant').textContent = merchant;
  document.getElementById('mrf-amount').textContent = `$${Math.abs(amount).toFixed(2)}`;

  // Format date
  if (date) {
    try {
      const d = new Date(date);
      document.getElementById('mrf-date').textContent = d.toLocaleDateString('en-US');
    } catch {
      document.getElementById('mrf-date').textContent = date;
    }
  }

  // Pre-select company based on Business Type
  const bizType = (selectedRow['Business Type'] || selectedRow['business_type'] || '').toLowerCase();
  const companySelect = document.getElementById('mrf-company');
  if (bizType.includes('music') || bizType.includes('mcr') || bizType.includes('rodeo')) {
    companySelect.value = 'mcr';
  } else {
    companySelect.value = 'downhome';
  }

  // Reset form fields
  document.getElementById('mrf-reason-select').value = '';
  document.getElementById('mrf-reason').value = '';
  document.getElementById('mrf-is-meal').checked = false;
  document.getElementById('mrf-meal-section').style.display = 'none';
  document.getElementById('mrf-attendees').value = '';
  document.getElementById('mrf-purpose').value = '';

  // Check if this looks like a meal expense (restaurant/dining category)
  const category = (selectedRow['mi_category'] || selectedRow['MI Category'] || selectedRow['Category'] || '').toLowerCase();
  if (category.includes('restaurant') || category.includes('dining') || category.includes('food') || category.includes('meal')) {
    document.getElementById('mrf-is-meal').checked = true;
    toggleMealSection();
  }
}

function closeMissingReceiptModal() {
  const modal = document.getElementById('missing-receipt-modal');
  modal.classList.remove('active');
}

function updateReasonField() {
  const select = document.getElementById('mrf-reason-select');
  const input = document.getElementById('mrf-reason');

  if (select.value === 'custom') {
    input.value = '';
    input.focus();
  } else if (select.value) {
    input.value = select.value;
  }
}

function toggleMealSection() {
  const checkbox = document.getElementById('mrf-is-meal');
  const section = document.getElementById('mrf-meal-section');
  section.style.display = checkbox.checked ? 'block' : 'none';
}

async function submitMissingReceiptForm() {
  if (!selectedRow) {
    showToast('No transaction selected', '‚ùå');
    return;
  }

  const reason = document.getElementById('mrf-reason').value.trim();
  if (!reason) {
    showToast('Please enter a reason', '‚ö†Ô∏è');
    document.getElementById('mrf-reason').focus();
    return;
  }

  const company = document.getElementById('mrf-company').value;
  const isMeal = document.getElementById('mrf-is-meal').checked;
  const attendees = isMeal ? document.getElementById('mrf-attendees').value.trim() : '';
  const purpose = isMeal ? document.getElementById('mrf-purpose').value.trim() : '';

  showToast('Generating Missing Receipt Form...', 'üìù');

  try {
    const response = await fetch('/generate_missing_receipt_form', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        _index: selectedRow._index,
        reason: reason,
        company: company,
        meal_attendees: attendees,
        meal_purpose: purpose
      })
    });

    const result = await response.json();

    if (result.ok) {
      // Update local data
      selectedRow['Receipt File'] = result.filename;
      selectedRow['receipt_file'] = result.filename;
      selectedRow['Review Status'] = 'good';
      selectedRow['Notes'] = `Missing Receipt Form - ${reason}`;

      // Refresh UI
      renderTable();
      updateDashboard();
      loadReceipt();

      closeMissingReceiptModal();
      showToast(`Missing Receipt Form generated!`, '‚úÖ');
    } else {
      showToast(`Error: ${result.error}`, '‚ùå');
    }
  } catch (error) {
    console.error('Error generating form:', error);
    showToast(`Failed to generate form: ${error.message}`, '‚ùå');
  }
}

// OCR Drag & Drop Functionality
function initOCRDropZone() {
  const dropZone = document.getElementById('ocr-drop-zone');
  const fileInput = document.getElementById('ocr-file-input');
  const preview = document.getElementById('ocr-preview');
  const status = document.getElementById('ocr-status');

  // Click to upload
  dropZone.addEventListener('click', (e) => {
    if (e.target === dropZone || e.target.closest('.ocr-drop-icon, .ocr-drop-text, .ocr-drop-hint')) {
      fileInput.click();
    }
  });

  // File input change
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      processReceiptImage(e.target.files[0]);
    }
  });

  // Drag and drop events
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');

    const file = e.dataTransfer.files[0];
    if (file && (file.type.startsWith('image/') || file.type === 'application/pdf')) {
      processReceiptImage(file);
    } else {
      showOCRStatus('Please drop an image or PDF file', 'error');
    }
  });
}

// Store the receipt filename from OCR for use in submitManualEntry
let lastOCRReceiptFilename = null;

async function processReceiptImage(file) {
  const dropZone = document.getElementById('ocr-drop-zone');
  const preview = document.getElementById('ocr-preview');
  const status = document.getElementById('ocr-status');

  // Reset stored filename
  lastOCRReceiptFilename = null;

  // Show preview
  const reader = new FileReader();
  reader.onload = (e) => {
    preview.src = e.target.result;
    preview.classList.add('show');
  };
  reader.readAsDataURL(file);

  // Show processing state
  dropZone.classList.add('processing');
  showOCRStatus('üîç Processing receipt with AI...', 'processing');

  try {
    // Upload to OCR API
    const formData = new FormData();
    formData.append('file', file);

    const response = await fetch('/api/ocr/process', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    if (result.success) {
      // Auto-fill form fields
      if (result.merchant) {
        document.getElementById('manual-merchant').value = result.merchant;
      }

      if (result.date) {
        document.getElementById('manual-date').value = result.date;
      }

      if (result.total) {
        document.getElementById('manual-amount').value = result.total;
      }

      // IMPORTANT: Store the filename for later use when submitting the form
      if (result.filename) {
        lastOCRReceiptFilename = result.filename;
        console.log('Receipt saved as:', result.filename);
      }

      // Show success with confidence
      const confidence = Math.round(result.confidence * 100);
      const engines = result.engines_used ? result.engines_used.join(', ') : 'OCR';
      showOCRStatus(
        `‚úÖ Extracted! Saved: ${result.filename || 'N/A'} (${confidence}%)`,
        'success'
      );
    } else {
      showOCRStatus(`‚ùå ${result.error || 'Failed to process receipt'}`, 'error');
    }
  } catch (error) {
    console.error('OCR Error:', error);
    showOCRStatus('‚ùå Failed to connect to OCR service', 'error');
  } finally {
    dropZone.classList.remove('processing');
  }
}

function showOCRStatus(message, type) {
  const status = document.getElementById('ocr-status');
  status.textContent = message;
  status.className = 'ocr-status show';
  if (type) {
    status.classList.add(type);
  }
}

// Initialize OCR when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  initOCRDropZone();
});

function updateCategoryOptions() {
  const businessType = document.getElementById('manual-business-type').value;
  const categorySelect = document.getElementById('manual-category');

  // Define categories by business type (placeholder - user will provide actual categories)
  const categories = {
    'Music City Rodeo': [
      'Artist Management',
      'Event Production',
      'Marketing & Advertising',
      'Venue Rental',
      'Equipment',
      'Travel & Lodging',
      'Meals & Entertainment',
      'Professional Services',
      'Other'
    ],
    'Down Home': [
      'Artist Development',
      'Recording & Production',
      'Marketing & PR',
      'Touring & Live Events',
      'Merchandising',
      'Professional Services',
      'Meals & Entertainment',
      'Travel',
      'Other'
    ],
    'Personal': [
      'Business Meals',
      'Travel',
      'Office Supplies',
      'Professional Development',
      'Subscriptions',
      'Other'
    ]
  };

  // Clear and repopulate
  categorySelect.innerHTML = '<option value="">Select Category (optional)</option>';

  if (businessType && categories[businessType]) {
    categories[businessType].forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    });
  }
}

async function submitManualEntry(event) {
  event.preventDefault();

  const date = document.getElementById('manual-date').value;
  const merchant = document.getElementById('manual-merchant').value;
  const amount = parseFloat(document.getElementById('manual-amount').value);
  const businessType = document.getElementById('manual-business-type').value;
  const category = document.getElementById('manual-category').value;
  const notes = document.getElementById('manual-notes').value;

  if (!date || !merchant || !amount || !businessType) {
    showToast('Please fill in all required fields', '‚ö†Ô∏è');
    return;
  }

  showToast('Adding manual entry...', '‚úçÔ∏è');

  try {
    // Build request body, including receipt_file if we have one from OCR
    const requestBody = {
      date,
      merchant,
      amount,
      business_type: businessType,
      category,
      notes
    };

    // Include the receipt file from OCR if available
    if (lastOCRReceiptFilename) {
      requestBody.receipt_file = lastOCRReceiptFilename;
      console.log('Including receipt file:', lastOCRReceiptFilename);
    }

    const res = await fetch('/add_manual_expense', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(requestBody)
    });

    const data = await res.json();

    if (data.ok) {
      // Add to local data
      csvData.push(data.expense);
      filteredData = [...csvData];

      // Refresh table and dashboard
      renderTable();
      updateDashboard();

      // Close modal
      closeManualEntryModal();

      showToast('Manual expense added successfully!', '‚úÖ');
    } else {
      showToast('Failed to add expense: ' + (data.error || 'Unknown error'), '‚ùå');
    }
  } catch (e) {
    showToast('Failed to add expense: ' + e.message, '‚ùå');
  }
}

// Close modal on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const modal = document.getElementById('manual-entry-modal');
    if (modal.classList.contains('active')) {
      closeManualEntryModal();
    }
  }
});

// Theme
function toggleTheme() {
  document.body.classList.toggle('light');
  localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  showToast('Theme changed', 'üé®');
}

function loadTheme() {
  if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light');
  }
}

// Logout
function logout() {
  if (confirm('Are you sure you want to logout?')) {
    window.location.href = '/logout';
  }
}

// Filters
function applyFilters() {
  let filtered = [...csvData];

  const activeFilter = document.querySelector('.chip[data-filter].active');
  if (activeFilter) {
    const filter = activeFilter.dataset.filter;
    if (filter === 'needs-review') {
      // Show items that haven't been reviewed yet (empty status or not finalized)
      // ‚úÖ MUST have a receipt to be reviewed - no receipt = missing receipts
      filtered = filtered.filter(r => {
        const status = (r['Review Status'] || '').toLowerCase().trim();
        const hasReceipt = r['Receipt File'] && r['Receipt File'].trim() !== '';
        return hasReceipt && (!status || (status !== 'good' && status !== 'bad' && status !== 'not needed'));
      });
    }
    else if (filter === 'good') {
      // ‚úÖ MUST have a receipt to be marked good - no receipt = missing receipts
      filtered = filtered.filter(r => {
        const hasReceipt = r['Receipt File'] && r['Receipt File'].trim() !== '';
        return hasReceipt && r['Review Status'] === 'good';
      });
    }
    else if (filter === 'bad') {
      // ‚úÖ MUST have a receipt to be marked bad - no receipt = missing receipts
      filtered = filtered.filter(r => {
        const hasReceipt = r['Receipt File'] && r['Receipt File'].trim() !== '';
        return hasReceipt && r['Review Status'] === 'bad';
      });
    }
    else if (filter === 'missing') filtered = filtered.filter(r => !r['Receipt File'] && r['Review Status'] !== 'not needed');
    else if (filter === 'with-receipts') filtered = filtered.filter(r => r['Receipt File'] && r['Receipt File'].trim() !== '');
    else if (filter === 'not-needed') filtered = filtered.filter(r => r['Review Status'] === 'not needed');
    else if (filter === 'refunds') {
      // ‚úÖ Refunds = negative amounts OR review_status = refund
      filtered = filtered.filter(r => {
        const amount = parseFloat(r['Chase Amount'] || r['Amount'] || 0);
        return amount < 0 || r['Review Status'] === 'refund';
      });
    }
    else if (filter === 'already-submitted') {
      // ‚úÖ Already Submitted = expenses marked as already submitted
      filtered = filtered.filter(r => {
        const submitted = (r['Already Submitted'] || '').toLowerCase().trim();
        return submitted === 'yes';
      });
    }
  }

  const activeBiz = document.querySelector('.chip[data-biz].active');
  if (activeBiz) {
    const bizType = activeBiz.dataset.biz;
    if (bizType === 'Unassigned') {
      // Show transactions with NULL, empty, or missing Business Type
      filtered = filtered.filter(r => {
        const bt = r['Business Type'];
        return !bt || bt === '' || bt === 'None' || bt === null;
      });
    } else {
      filtered = filtered.filter(r => r['Business Type'] === bizType);
    }
  }

  const activeConfidence = document.querySelector('.chip[data-confidence].active');
  if (activeConfidence) {
    const confLevel = activeConfidence.dataset.confidence;
    filtered = filtered.filter(r => {
      const conf = parseFloat(r['AI Confidence']) || 0;
      const hasReceipt = r['Receipt File'];

      if (confLevel === 'excellent') return hasReceipt && conf >= 90;
      if (confLevel === 'good-range') return hasReceipt && conf >= 70 && conf < 90;
      if (confLevel === 'needs-review') return hasReceipt && conf > 0 && conf < 70;
      if (confLevel === 'none') return hasReceipt && conf === 0;
      return true;
    });
  }

  const search = document.getElementById('search').value.toLowerCase().trim();
  if (search) {
    // Check if search is a number/amount (e.g., "22.44", "$22.44", "22")
    const searchAmount = parseFloat(search.replace(/[$,]/g, ''));
    const isAmountSearch = !isNaN(searchAmount) && /^[$]?[\d,]+\.?\d*$/.test(search.replace(/\s/g, ''));

    filtered = filtered.filter(r => {
      // Text search: check description and notes
      const textMatch =
        (r['Chase Description'] || '').toLowerCase().includes(search) ||
        (r['Notes'] || '').toLowerCase().includes(search);

      if (textMatch) return true;

      // Amount search: check if amount matches
      if (isAmountSearch) {
        const amount = parseFloat(r['Chase Amount'] || r['Amount'] || 0);
        const absAmount = Math.abs(amount);

        // Exact match (within 1 cent for floating point)
        if (Math.abs(absAmount - searchAmount) < 0.01) return true;

        // Also allow partial match for the amount string (e.g., "22" matches "22.50")
        const amountStr = absAmount.toFixed(2);
        if (amountStr.includes(search.replace(/[$,]/g, ''))) return true;
      }

      return false;
    });
  }

  filteredData = filtered;
  renderTable();
  updateDashboard();
}

// Event Listeners
function setupEventListeners() {
  // Filters - Toggle on/off behavior
  document.querySelectorAll('.chip[data-filter]').forEach(chip => {
    chip.addEventListener('click', () => {
      // If already active, deactivate (show all)
      if (chip.classList.contains('active')) {
        chip.classList.remove('active');
      } else {
        // Otherwise, activate this one and deactivate others
        document.querySelectorAll('.chip[data-filter]').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
      }
      applyFilters();
    });
  });

  // Business Type Filters - Toggle on/off behavior
  document.querySelectorAll('.chip[data-biz]').forEach(chip => {
    chip.addEventListener('click', () => {
      // If already active, deactivate (show all)
      if (chip.classList.contains('active')) {
        chip.classList.remove('active');
      } else {
        // Otherwise, activate this one and deactivate others
        document.querySelectorAll('.chip[data-biz]').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
      }
      applyFilters();
    });
  });

  document.getElementById('search').addEventListener('input', applyFilters);

  // Table sorting
  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.sort;
      if (sortColumn === col) {
        sortAsc = !sortAsc;
      } else {
        sortColumn = col;
        sortAsc = true;
      }

      filteredData.sort((a, b) => {
        let aVal = a[col] || '';
        let bVal = b[col] || '';
        if (col === 'Chase Amount') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        }
        return sortAsc ?
          (aVal > bVal ? 1 : -1) :
          (aVal < bVal ? 1 : -1);
      });

      renderTable();

      document.querySelectorAll('th').forEach(h => h.classList.remove('sorted', 'asc'));
      th.classList.add('sorted');
      if (sortAsc) th.classList.add('asc');
    });
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;

    const key = e.key.toLowerCase();

    if (key === 'escape') {
      closeQuickViewer();
      toggleHotkeyMenu();
      toggleSettings();
    } else if (key === '?') {
      e.preventDefault();
      toggleHotkeyMenu();
    } else if (key === 'q') {
      e.preventDefault();
      openQuickViewer();
    } else if (key === 'a') {
      e.preventDefault();
      aiMatch();
    } else if (key === 'j') {
      e.preventDefault();
      aiNote();
    } else if (key === 'x') {
      e.preventDefault();
      detachReceipt();
    } else if (key === 'g') {
      e.preventDefault();
      updateField('Review Status', 'good');
    } else if (key === 'b') {
      e.preventDefault();
      updateField('Review Status', 'bad');
    } else if (key === 'n') {
      e.preventDefault();
      updateField('Review Status', 'not needed');
    } else if (key === 'c') {
      e.preventDefault();
      updateField('Review Status', '');
    } else if (key === 'm') {
      e.preventDefault();
      updateField('Business Type', 'Music City Rodeo');
    } else if (key === 'd') {
      e.preventDefault();
      updateField('Business Type', 'Down Home');
    } else if (key === 'p') {
      e.preventDefault();
      updateField('Business Type', 'Personal');
    } else if (key === 'r') {
      e.preventDefault();
      rotateImage();
    } else if (key === '0') {
      e.preventDefault();
      resetZoom();
    } else if (key === '+' || key === '=') {
      e.preventDefault();
      zoomIn();
    } else if (key === '-') {
      e.preventDefault();
      zoomOut();
    } // ‚úÖ FIX: Removed duplicate arrow key handlers (already handled at line ~2250)
    // else if (key === 'arrowup') {
    //   e.preventDefault();
    //   navigateRow(-1);
    // } else if (key === 'arrowdown') {
    //   e.preventDefault();
    //   navigateRow(1);
    // }
    else if (e.ctrlKey && key === 's') {
      e.preventDefault();
      saveCSV();
    }
    else if (e.ctrlKey && key === 'z') {
      e.preventDefault();
      undo();
    }
  });
}

function navigateRow(delta) {
  if (!selectedRow || filteredData.length === 0) return;

  const idx = filteredData.findIndex(r => r._index === selectedRow._index);
  const newIdx = Math.max(0, Math.min(filteredData.length - 1, idx + delta));
  selectRow(filteredData[newIdx]);

  // Scroll into view
  const rows = document.querySelectorAll('#tbody tr');
  if (rows[newIdx]) {
    rows[newIdx].scrollIntoView({behavior: 'smooth', block: 'nearest'});
  }
}

// Drag & Drop
function setupDragDrop() {
  const viewer = document.getElementById('viewer-content');

  ['dragenter', 'dragover'].forEach(evt => {
    viewer.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      viewer.style.borderColor = 'var(--brand)';
    });
  });

  ['dragleave', 'drop'].forEach(evt => {
    viewer.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      viewer.style.borderColor = '';
    });
  });

  viewer.addEventListener('drop', async (e) => {
    const file = e.dataTransfer.files[0];
    if (!file || !(file.type.startsWith('image/') || file.type === 'application/pdf')) {
      return showToast('Please drop an image or PDF file', '‚ö†Ô∏è');
    }

    // If a row is selected, use old upload method
    if (selectedRow) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('_index', selectedRow._index);

      try {
        showToast('Uploading receipt...', '‚è±Ô∏è');
        const res = await fetch('/upload_receipt', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.ok) {
          selectedRow['Receipt File'] = data.filename;
          renderTable();
          loadReceipt();
          showToast('Receipt attached', '‚úì');
        }
      } catch (e) {
        showToast('Upload failed: ' + e.message, '‚ùå');
      }
      return;
    }

    // No row selected - use smart upload with Gemini OCR + create new transaction
    const formData = new FormData();
    formData.append('file', file);

    try {
      showToast('üîç Processing receipt with Gemini AI...', '‚è±Ô∏è');

      // Try to match first
      const res = await fetch('/upload_receipt_auto', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      if (data.ok && data.matched && data.auto_attached) {
        // Success! Auto-matched and attached to existing transaction
        showToast(`‚úÖ ${data.message}`, '‚úì');
        await loadData();

        const matchedRow = allRows.find(r => r._index === data.transaction._index);
        if (matchedRow) {
          selectRow(matchedRow);
        }
      } else if (data.ok && data.matched && !data.auto_attached) {
        // Found possible match but confidence too low
        showToast(`ü§î ${data.message}`, '‚ö†Ô∏è');

        const matchedRow = allRows.find(r => r._index === data.transaction._index);
        if (matchedRow) {
          selectRow(matchedRow);
        }
      } else {
        // No match found OR OCR failed - CREATE NEW TRANSACTION
        showToast('üÜï Creating new transaction from receipt...', '‚è±Ô∏è');

        // Re-upload to create new transaction
        const newFormData = new FormData();
        newFormData.append('file', file);

        const newRes = await fetch('/upload_receipt_new', {
          method: 'POST',
          body: newFormData
        });
        const newData = await newRes.json();

        if (newData.ok) {
          showToast(`‚úÖ ${newData.message}`, '‚úì');
          await loadData();

          // Select the new transaction
          const newRow = allRows.find(r => r._index === newData.transaction._index);
          if (newRow) {
            selectRow(newRow);
          }
        } else {
          showToast(newData.message || 'Failed to create transaction', '‚ùå');
        }
      }

    } catch (e) {
      showToast('Upload failed: ' + e.message, '‚ùå');
    }
  });
}

// Resizable divider
function setupResizer() {
  const divider = document.getElementById('divider');
  const left = document.querySelector('.left');
  let isResizing = false;

  divider.addEventListener('mousedown', () => {
    isResizing = true;
    document.body.style.cursor = 'col-resize';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    const newWidth = (e.clientX / window.innerWidth) * 100;
    if (newWidth > 30 && newWidth < 80) {
      left.style.flex = `0 0 ${newWidth}%`;
    }
  });

  document.addEventListener('mouseup', () => {
    isResizing = false;
    document.body.style.cursor = '';
  });
}

// UI Helpers
function showStatus(state) {
  const el = document.getElementById('status');
  el.className = `status ${state}`;
  if (state === 'saved') {
    setTimeout(() => el.className = 'status', 2000);
  }
}

let toastTimeout = null;
function showToast(message, icon = '‚úì', duration = 3000) {
  const toast = document.getElementById('toast');
  document.getElementById('toast-icon').textContent = icon;
  document.getElementById('toast-message').textContent = message;
  toast.classList.add('active');
  if (toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => toast.classList.remove('active'), duration);
}

// Loading overlay functions for batch operations
function showLoading(text = 'Processing...', progress = '') {
  document.getElementById('loading-text').textContent = text;
  document.getElementById('loading-progress').textContent = progress;
  document.getElementById('loading-overlay').classList.add('active');
}
function updateLoading(text, progress = '') {
  document.getElementById('loading-text').textContent = text;
  document.getElementById('loading-progress').textContent = progress;
}
function hideLoading() {
  document.getElementById('loading-overlay').classList.remove('active');
}

// Click outside to close modals
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('active');
    }
  });
});

// =============================================================================
// PAGE NAVIGATION
// =============================================================================

function switchPage(page) {
  // Special handling for Incoming page (separate HTML file)
  if (page === 'incoming') {
    window.location.href = '/incoming.html';
    return;
  }

  // Hide all pages
  document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');

  // Show selected page
  document.getElementById(`${page}-page`).style.display = 'block';

  // Update nav button styles
  document.querySelectorAll('[id^="nav-"]').forEach(btn => {
    btn.style.background = '';
    btn.style.color = '';
  });

  const activeBtn = document.getElementById(`nav-${page}`);
  activeBtn.style.background = 'var(--brand)';
  activeBtn.style.color = '#000';

  // Load data for Reports page
  if (page === 'reports') {
    loadArchivedReports();
  }

  // Load data for Stats page
  if (page === 'stats') {
    loadStatsPage();
  }
}

// =============================================================================
// STATS PAGE
// =============================================================================

async function loadStatsPage() {
  console.log('üìä Loading stats page...');

  // Show loading state for key containers
  const containerIds = ['stats-business-breakdown', 'stats-top-merchants', 'stats-top-categories', 'stats-subscriptions', 'stats-receipt-sources'];
  containerIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">Loading...</div>';
  });

  try {
    // Fetch fresh data from database
    let transactions = [];
    console.log('Fetching transactions from /api/transactions...');

    try {
      // Stats needs ALL transactions including already submitted ones
      const res = await fetch('/api/transactions?show_submitted=true', { credentials: 'same-origin' });
      console.log('Transactions response status:', res.status);

      if (res.ok) {
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          transactions = await res.json();
          console.log('Loaded', transactions.length, 'transactions from database');
        } else {
          console.log('Response is not JSON - likely redirected to login');
        }
      } else {
        console.log('Transaction fetch failed:', res.status);
      }
    } catch (e) {
      console.log('Could not fetch transaction data for stats:', e);
    }

    // If no data, show helpful message
    if (transactions.length === 0) {
      containerIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No transaction data available. Load the Transactions page first.</div>';
      });
      // Still render with empty data to show zeroes in the overview cards
      renderStats(calculateStats([], []));
      return;
    }

    // Also fetch incoming receipts for source info
    let receipts = [];
    try {
      const receiptsRes = await fetch('/api/incoming/receipts?status=all&limit=500', { credentials: 'same-origin' });
      if (receiptsRes.ok) {
        const receiptsData = await receiptsRes.json();
        receipts = receiptsData.receipts || [];
        console.log('Loaded', receipts.length, 'incoming receipts');
      }
    } catch (e) {
      console.log('Could not fetch receipts for stats');
    }

    // Calculate stats
    console.log('Calculating stats with', transactions.length, 'transactions');
    const stats = calculateStats(transactions, receipts);
    console.log('Stats calculated:', stats);

    // Update UI
    renderStats(stats);
    console.log('Stats rendered');
  } catch (e) {
    console.error('Error loading stats:', e);
    // Show error state
    containerIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = `<div style="color:#ff4e6a;text-align:center;padding:20px">Error loading data: ${e.message}</div>`;
    });
  }
}

function calculateStats(transactions, receipts) {
  const stats = {
    totalSpent: 0,
    totalCount: 0,
    receiptsMatched: 0,
    gmailReceipts: 0,
    totalReceipts: 0,  // Will be calculated from transactions with receipts
    refunds: { total: 0, count: 0 },
    payments: { total: 0, count: 0 },
    interest: 0,
    fees: 0,
    lateCharges: 0,
    byBusiness: {},
    byCategory: {},
    byMerchant: {},
    subscriptions: [],
    receiptSources: {}
  };

  // Track merchant frequencies for subscription detection
  const merchantCounts = {};

  transactions.forEach(t => {
    // Handle both prefixed (chase_) and unprefixed field names
    const amount = parseFloat(t.chase_amount || t.amount) || 0;
    const desc = (t.chase_description || t.description || '').toLowerCase();
    const merchant = t.mi_merchant || t.merchant || t.chase_description || t.description || 'Unknown';
    const category = t.chase_category || t.category || 'Uncategorized';
    const business = t.business_type || t['Business Type'] || 'Unassigned';

    // Count transactions with receipts
    if (t.receipt_file || t.receipt_url || t.receipt_path) {
      stats.receiptsMatched++;
    }

    // Transaction type detection using chase_type field and amount sign
    // In this database:
    //   - POSITIVE amounts = money OUT (expenses, interest, fees)
    //   - NEGATIVE amounts = money IN (payments, refunds, credits)
    //   - chase_type = 'Payment' = credit card payment
    const txnType = (t.chase_type || '').toLowerCase();
    const isInterest = desc.includes('interest') || category === 'Interest';
    const isFee = desc.includes('fee') && !desc.includes('coffee');
    const isLate = desc.includes('late') || desc.includes('penalty');

    // NEGATIVE amounts = money coming IN
    if (amount < 0) {
      if (txnType === 'payment' || desc.includes('payment thank you')) {
        // Credit card payment
        stats.payments.total += Math.abs(amount);
        stats.payments.count++;
      } else {
        // Refund/credit
        stats.refunds.total += Math.abs(amount);
        stats.refunds.count++;
      }
    }
    // POSITIVE amounts = money going OUT
    else if (isInterest) {
      stats.interest += amount;
      stats.totalSpent += amount;
      stats.totalCount++;
    } else if (isFee) {
      stats.fees += amount;
      stats.totalSpent += amount;
      stats.totalCount++;
    } else if (isLate) {
      stats.lateCharges += amount;
      stats.totalSpent += amount;
      stats.totalCount++;
    } else if (amount > 0) {
      // Regular expense
      stats.totalSpent += amount;
      stats.totalCount++;
    }

    // Track business, category, merchant for ALL positive amounts (expenses)
    const isSubmitted = (t.already_submitted || t['Already Submitted'] || '').toLowerCase() === 'yes';

    if (amount > 0) {
      // By business - track total AND submitted separately
      if (!stats.byBusiness[business]) {
        stats.byBusiness[business] = { total: 0, count: 0, submitted: 0, submittedCount: 0 };
      }
      stats.byBusiness[business].total += amount;
      stats.byBusiness[business].count++;
      if (isSubmitted) {
        stats.byBusiness[business].submitted += amount;
        stats.byBusiness[business].submittedCount++;
      }

      // By category
      if (!stats.byCategory[category]) {
        stats.byCategory[category] = { total: 0, count: 0 };
      }
      stats.byCategory[category].total += amount;
      stats.byCategory[category].count++;

      // By merchant
      if (!stats.byMerchant[merchant]) {
        stats.byMerchant[merchant] = { total: 0, count: 0 };
      }
      stats.byMerchant[merchant].total += amount;
      stats.byMerchant[merchant].count++;

      // Track for subscription detection
      if (!merchantCounts[merchant]) {
        merchantCounts[merchant] = { amounts: [], dates: [] };
      }
      merchantCounts[merchant].amounts.push(amount);
      merchantCounts[merchant].dates.push(t.chase_date || t.date);
    }
  });

  // Detect subscriptions (merchants with 3+ recurring charges OR known subscription services)
  const knownSubscriptions = ['apple', 'spotify', 'netflix', 'hulu', 'amazon prime', 'cursor', 'claude', 'midjourney', 'openai', 'chatgpt', 'expensify', 'cloudflare', 'adobe', 'microsoft', 'google one', 'icloud', 'dropbox', 'notion', 'slack', 'zoom', 'canva', 'figma', 'github', 'aws', 'digitalocean', 'heroku', 'vercel', 'anthropic', 'ada ai', 'hive', 'soho house'];

  Object.entries(merchantCounts).forEach(([merchant, data]) => {
    if (data.amounts.length >= 3) {
      const avgAmount = data.amounts.reduce((a, b) => a + b, 0) / data.amounts.length;
      const total = data.amounts.reduce((a, b) => a + b, 0);
      const merchantLower = merchant.toLowerCase();

      // Check if it's a known subscription OR has similar recurring amounts
      const isKnownSub = knownSubscriptions.some(sub => merchantLower.includes(sub));
      const allSimilar = data.amounts.every(a => Math.abs(a - avgAmount) / avgAmount < 0.15);

      // Include if: known subscription service OR recurring similar charges
      if (isKnownSub || (allSimilar && avgAmount > 5)) {
        stats.subscriptions.push({
          name: merchant,
          amount: avgAmount,
          total: total,
          count: data.amounts.length,
          isRecurring: allSimilar
        });
      }
    }
  });

  // Sort subscriptions by total spent
  stats.subscriptions.sort((a, b) => b.total - a.total);

  // Analyze receipt sources
  // Count matched receipts (transactions with receipt_file)
  transactions.forEach(t => {
    const receiptUrl = t.receipt_file || t.receipt_url || t.receipt_path || '';
    if (receiptUrl) {
      stats.totalReceipts++;
      if (!stats.receiptSources['Matched']) {
        stats.receiptSources['Matched'] = 0;
      }
      stats.receiptSources['Matched']++;
    }
  });

  // Count Gmail receipts from incoming_receipts (they have gmail_account field)
  if (receipts.length > 0) {
    receipts.forEach(r => {
      // incoming_receipts with gmail_account are from Gmail
      if (r.gmail_account || r.email_id) {
        stats.gmailReceipts++;
        if (!stats.receiptSources['Gmail (Incoming)']) {
          stats.receiptSources['Gmail (Incoming)'] = 0;
        }
        stats.receiptSources['Gmail (Incoming)']++;
      } else {
        if (!stats.receiptSources['Other Incoming']) {
          stats.receiptSources['Other Incoming'] = 0;
        }
        stats.receiptSources['Other Incoming']++;
      }
    });
  }

  // Count missing receipts (positive amount transactions without receipt)
  const missingCount = transactions.filter(t => {
    const amount = parseFloat(t.chase_amount || t.amount) || 0;
    const hasReceipt = t.receipt_file || t.receipt_url || t.receipt_path;
    return amount > 0 && !hasReceipt;
  }).length;

  if (missingCount > 0) {
    stats.receiptSources['Missing'] = missingCount;
  }

  return stats;
}

function renderStats(stats) {
  console.log('üé® renderStats called with:', stats);
  const fmt = (n) => '$' + Math.abs(n || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // Helper to safely set text content
  const setText = (id, text) => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = text;
    } else {
      console.warn(`Element #${id} not found`);
    }
  };

  // Helper to safely set innerHTML
  const setHTML = (id, html) => {
    const el = document.getElementById(id);
    if (el) {
      el.innerHTML = html;
    } else {
      console.warn(`Element #${id} not found`);
    }
  };

  try {
    // Overview cards
    setText('stats-total-spent', fmt(stats.totalSpent));
    setText('stats-total-count', `${stats.totalCount || 0} transactions`);

    setText('stats-receipts-matched', stats.receiptsMatched || 0);
    const matchRate = stats.totalCount > 0 ? Math.round((stats.receiptsMatched / stats.totalCount) * 100) : 0;
    setText('stats-match-rate', `${matchRate}% coverage`);

    setText('stats-gmail-receipts', stats.gmailReceipts || 0);
    const gmailPct = stats.totalReceipts > 0 ? Math.round((stats.gmailReceipts / stats.totalReceipts) * 100) : 0;
    setText('stats-gmail-pct', `${gmailPct}% of receipts`);

    setText('stats-refunds', fmt(stats.refunds?.total || 0));
    setText('stats-refund-count', `${stats.refunds?.count || 0} transactions`);

    setText('stats-payments', fmt(stats.payments?.total || 0));
    setText('stats-payment-count', `${stats.payments?.count || 0} transactions`);
    console.log('‚úì Overview cards rendered');
  } catch (e) {
    console.error('Error rendering overview cards:', e);
  }

  try {
    // Interest & Fees
    setText('stats-interest-total', fmt(stats.interest));
    setText('stats-fees-total', fmt(stats.fees));
    setText('stats-late-total', fmt(stats.lateCharges));
    setText('stats-total-fees', fmt((stats.interest || 0) + (stats.fees || 0) + (stats.lateCharges || 0)));
    console.log('‚úì Interest & Fees rendered');
  } catch (e) {
    console.error('Error rendering interest/fees:', e);
  }

  try {
    // Business breakdown
    const businessContainer = document.getElementById('stats-business-breakdown');
    const businessEntries = Object.entries(stats.byBusiness || {}).sort((a, b) => b[1].total - a[1].total);

    if (!businessContainer) {
      console.warn('stats-business-breakdown not found');
    } else if (businessEntries.length === 0) {
      businessContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No business data yet</div>';
    } else {
      const maxBusiness = businessEntries[0][1].total || 1;
      businessContainer.innerHTML = businessEntries.map(([name, data]) => {
        const pct = Math.round((data.total / maxBusiness) * 100);
        const submittedPct = data.submitted > 0 ? Math.round((data.submitted / data.total) * 100) : 0;
        const color = name === 'Down Home' ? '#00ff88' : name === 'Music City Rodeo' ? '#ffd85e' : name === 'Personal' ? '#6eb5ff' : '#888';
        const unreported = data.total - (data.submitted || 0);
        const hasSubmitted = data.submitted > 0;
        return `
          <div style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px">
              <span style="font-weight:600">${name}</span>
              <span style="color:${color};font-weight:700">${fmt(data.total)}</span>
            </div>
            <div style="background:var(--panel2);height:8px;border-radius:4px;overflow:hidden;position:relative">
              <div style="background:${color};height:100%;width:${pct}%;border-radius:4px;transition:width .3s"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px">
              <span>${data.count} transactions</span>
              ${hasSubmitted ? `<span style="color:#00ff88">Reported: ${fmt(data.submitted)} (${data.submittedCount})</span>` : ''}
            </div>
            ${hasSubmitted && unreported > 0 ? `<div style="font-size:11px;color:#ffd85e;margin-top:2px">Unreported: ${fmt(unreported)} (${data.count - data.submittedCount})</div>` : ''}
          </div>
        `;
      }).join('');
    }
    console.log('‚úì Business breakdown rendered');
  } catch (e) {
    console.error('Error rendering business breakdown:', e);
  }

  try {
    // Top merchants
    const merchantContainer = document.getElementById('stats-top-merchants');
    const merchantEntries = Object.entries(stats.byMerchant || {}).sort((a, b) => b[1].total - a[1].total).slice(0, 10);

    if (!merchantContainer) {
      console.warn('stats-top-merchants not found');
    } else if (merchantEntries.length === 0) {
      merchantContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No merchant data yet</div>';
    } else {
      const maxMerchant = merchantEntries[0][1].total || 1;
      merchantContainer.innerHTML = merchantEntries.map(([name, data], i) => {
        const pct = Math.round((data.total / maxMerchant) * 100);
        return `
          <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--panel2);border-radius:8px">
            <div style="width:24px;height:24px;background:rgba(0,255,136,.2);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#00ff88">${i + 1}</div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
              <div style="background:var(--edge);height:4px;border-radius:2px;margin-top:4px">
                <div style="background:#00ff88;height:100%;width:${pct}%;border-radius:2px"></div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700;color:#00ff88">${fmt(data.total)}</div>
              <div style="font-size:11px;color:var(--muted)">${data.count}x</div>
            </div>
          </div>
        `;
      }).join('');
    }
    console.log('‚úì Top merchants rendered');
  } catch (e) {
    console.error('Error rendering top merchants:', e);
  }

  try {
    // Top categories
    const categoryContainer = document.getElementById('stats-top-categories');
    const categoryEntries = Object.entries(stats.byCategory || {}).sort((a, b) => b[1].total - a[1].total).slice(0, 8);

    if (!categoryContainer) {
      console.warn('stats-top-categories not found');
    } else if (categoryEntries.length === 0) {
      categoryContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">No category data yet</div>';
    } else {
      const maxCategory = categoryEntries[0][1].total || 1;
      categoryContainer.innerHTML = categoryEntries.map(([name, data]) => {
        const pct = Math.round((data.total / maxCategory) * 100);
        return `
          <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--panel2);border-radius:8px">
            <div style="flex:1">
              <div style="font-weight:600">${name}</div>
              <div style="background:var(--edge);height:4px;border-radius:2px;margin-top:4px">
                <div style="background:#00ff88;height:100%;width:${pct}%;border-radius:2px"></div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700;color:#00ff88">${fmt(data.total)}</div>
              <div style="font-size:11px;color:var(--muted)">${data.count}x</div>
            </div>
          </div>
        `;
      }).join('');
    }
    console.log('‚úì Top categories rendered');
  } catch (e) {
    console.error('Error rendering top categories:', e);
  }

  try {
    // Subscriptions
    const subsContainer = document.getElementById('stats-subscriptions');
    const subscriptions = stats.subscriptions || [];
    const totalSubSpend = subscriptions.reduce((sum, s) => sum + (s.total || 0), 0);
    setText('stats-monthly-subs', fmt(totalSubSpend));

    if (!subsContainer) {
      console.warn('stats-subscriptions not found');
    } else if (subscriptions.length === 0) {
      subsContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;grid-column:1/-1">No recurring subscriptions detected</div>';
    } else {
      subsContainer.innerHTML = subscriptions.slice(0, 15).map(sub => `
        <div style="background:var(--panel2);padding:14px;border-radius:10px;border:1px solid var(--edge)">
          <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px">${sub.name || 'Unknown'}</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span style="font-size:18px;font-weight:700;color:#00ff88">${fmt(sub.total || 0)}</span>
            <span style="font-size:11px;color:var(--muted);background:var(--panel);padding:2px 8px;border-radius:4px">${sub.count || 0}x</span>
          </div>
          <div style="font-size:11px;color:var(--muted)">~${fmt(sub.amount || 0)}/charge${sub.isRecurring ? ' ‚Ä¢ recurring' : ''}</div>
        </div>
      `).join('');
    }
    console.log('‚úì Subscriptions rendered');
  } catch (e) {
    console.error('Error rendering subscriptions:', e);
  }

  try {
    // Receipt sources
    const sourcesContainer = document.getElementById('stats-receipt-sources');
    const sourceEntries = Object.entries(stats.receiptSources || {}).sort((a, b) => b[1] - a[1]);

    if (!sourcesContainer) {
      console.warn('stats-receipt-sources not found');
    } else if (sourceEntries.length === 0) {
      sourcesContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;grid-column:1/-1">No receipt source data</div>';
    } else {
      const sourceIcons = {
        'Gmail': 'üìß',
        'Manual Upload': 'üì§',
        'Scanner': 'üì∑',
        'Google Photos': 'üñºÔ∏è',
        'Unknown': '‚ùì'
      };
      sourcesContainer.innerHTML = sourceEntries.map(([source, count]) => {
        const icon = sourceIcons[source] || 'üìÑ';
        const pct = stats.totalReceipts > 0 ? Math.round((count / stats.totalReceipts) * 100) : 0;
        return `
          <div style="background:var(--panel2);padding:16px;border-radius:10px;border:1px solid var(--edge);text-align:center">
            <div style="font-size:32px;margin-bottom:8px">${icon}</div>
            <div style="font-weight:600;margin-bottom:4px">${source}</div>
            <div style="font-size:28px;font-weight:800;color:#00ff88">${count}</div>
            <div style="font-size:11px;color:var(--muted)">${pct}% of receipts</div>
          </div>
        `;
      }).join('');
    }
    console.log('‚úì Receipt sources rendered');
  } catch (e) {
    console.error('Error rendering receipt sources:', e);
  }

  console.log('‚úÖ renderStats complete');
}

// =============================================================================
// REPORTS PAGE
// =============================================================================

let reportPreviewData = [];
let currentReportId = null;

async function loadReportPreview() {
  const businessType = document.getElementById('report-business-type').value;
  const dateFrom = document.getElementById('report-date-from').value;
  const dateTo = document.getElementById('report-date-to').value;

  if (!businessType) {
    showToast('Please select a business type', '‚ö†Ô∏è');
    return;
  }

  showToast('Loading preview...', 'üîÑ');

  try {
    const res = await fetch('/reports/preview', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        business_type: businessType,
        date_from: dateFrom || null,
        date_to: dateTo || null
      })
    });

    const data = await res.json();

    if (data.ok) {
      reportPreviewData = data.expenses;

      // Generate human-readable notes
      const notesRes = await fetch('/reports/generate_notes', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ expenses: reportPreviewData })
      });

      const notesData = await notesRes.json();
      if (notesData.ok) {
        reportPreviewData = notesData.expenses_with_notes;
      }

      // Count receipts
      const receiptCount = reportPreviewData.filter(exp => exp['Receipt File']).length;

      // Update stat cards
      document.getElementById('report-total-amount').textContent =
        `$${data.total_amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('report-expense-count').textContent = data.count;
      document.getElementById('report-receipt-count').textContent = receiptCount;

      // Populate table
      const tbody = document.getElementById('report-preview-table');
      tbody.innerHTML = '';

      if (reportPreviewData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding:40px;text-align:center;color:var(--muted)">
              No expenses found matching the criteria
            </td>
          </tr>
        `;
      } else {
        reportPreviewData.forEach(exp => {
          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid var(--edge)';

          const notes = exp['Notes'] || exp['AI Note'] || '';
          const notesDisplay = notes.length > 60 ? notes.substring(0, 60) + '...' : notes;

          const hasReceipt = exp['Receipt File'] ? 'üìé' : '';

          tr.innerHTML = `
            <td style="padding:10px">${exp['Chase Date'] || ''}</td>
            <td style="padding:10px">${hasReceipt} ${exp['Chase Description'] || ''}</td>
            <td style="padding:10px;text-align:right">$${Math.abs(exp['Chase Amount'] || 0).toFixed(2)}</td>
            <td style="padding:10px">${exp['Category'] || '-'}</td>
            <td style="padding:10px;font-size:12px;color:var(--muted)" title="${notes}">${notesDisplay || '-'}</td>
          `;

          tbody.appendChild(tr);
        });
      }

      // Show preview section
      document.getElementById('report-preview-section').style.display = 'block';

      // Hide report actions until submitted
      document.getElementById('report-actions').style.display = 'none';

      showToast(`Found ${data.count} expenses ‚Ä¢ ${receiptCount} receipts`, '‚úÖ');
    } else {
      showToast('Failed to load preview: ' + (data.error || 'Unknown error'), '‚ùå');
    }
  } catch (e) {
    showToast('Failed to load preview: ' + e.message, '‚ùå');
  }
}

async function submitReport() {
  const reportName = document.getElementById('report-name').value.trim();
  const businessType = document.getElementById('report-business-type').value;

  if (!reportName) {
    showToast('Please enter a report name', '‚ö†Ô∏è');
    return;
  }

  if (reportPreviewData.length === 0) {
    showToast('No expenses to submit', '‚ö†Ô∏è');
    return;
  }

  showToast('Submitting report...', 'üì§');

  try {
    const expenseIndexes = reportPreviewData.map(exp => exp._index);

    const res = await fetch('/reports/submit', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        report_name: reportName,
        business_type: businessType,
        expense_indexes: expenseIndexes
      })
    });

    const data = await res.json();

    if (data.ok) {
      currentReportId = data.report_id;
      showToast(`Report ${data.report_id} created successfully!`, '‚úÖ');

      // Show report actions
      document.getElementById('report-actions').style.display = 'block';

      // Reload main data (these expenses are now archived)
      await loadCSV();

      // Reload archived reports list
      await loadArchivedReports();
    } else {
      showToast('Failed to submit report: ' + (data.error || 'Unknown error'), '‚ùå');
    }
  } catch (e) {
    showToast('Failed to submit report: ' + e.message, '‚ùå');
  }
}

function viewReportPage() {
  if (!currentReportId) {
    showToast('No report selected', '‚ö†Ô∏è');
    return;
  }
  window.open(`/reports/${currentReportId}/page`, '_blank');
}

function downloadReportCSV() {
  if (!currentReportId) {
    showToast('No report selected', '‚ö†Ô∏è');
    return;
  }
  window.location.href = `/reports/${currentReportId}/export/downhome`;
  showToast('Downloading CSV...', 'üì•');
}

function downloadReportReceipts() {
  if (!currentReportId) {
    showToast('No report selected', '‚ö†Ô∏è');
    return;
  }
  window.location.href = `/reports/${currentReportId}/receipts.zip`;
  showToast('Downloading receipts ZIP...', 'üì•');
}

async function copyReportLink() {
  if (!currentReportId) {
    showToast('No report selected', '‚ö†Ô∏è');
    return;
  }
  const url = `${window.location.origin}/reports/${currentReportId}/page`;
  try {
    await navigator.clipboard.writeText(url);
    showToast('Report link copied to clipboard!', '‚úÖ');
  } catch (e) {
    showToast('Failed to copy link', '‚ùå');
  }
}

function startNewReport() {
  // Hide report actions
  document.getElementById('report-actions').style.display = 'none';

  // Hide preview section
  document.getElementById('report-preview-section').style.display = 'none';

  // Clear the preview data
  reportPreviewData = [];
  currentReportId = null;

  // Clear the report name input
  document.getElementById('report-name').value = '';

  // Keep the date range and business type selections so they can create another report
  // with the same or different criteria

  showToast('Ready to create a new report', '‚ú®');
}

async function deleteReport(reportId) {
  if (!confirm(`Are you sure you want to delete report ${reportId}?\n\nThis will return all expenses to the available pool.`)) {
    return;
  }

  showToast('Deleting report...', 'üóëÔ∏è');

  try {
    const res = await fetch(`/reports/${reportId}/delete`, {
      method: 'POST'
    });

    const data = await res.json();

    if (data.ok) {
      showToast('Report deleted! Expenses returned to available pool.', '‚úÖ');

      // Reload archived reports list
      await loadArchivedReports();

      // Reload main data
      await loadCSV();

      // Close report modal if it's open
      const modal = document.getElementById('report-view-modal');
      if (modal) {
        modal.remove();
      }
    } else {
      showToast('Failed to delete report', '‚ùå');
    }
  } catch (e) {
    console.error('Delete report failed:', e);
    showToast('Failed to delete report: ' + e.message, '‚ùå');
  }
}

async function loadArchivedReports() {
  try {
    const res = await fetch('/reports/list');
    const data = await res.json();

    if (data.ok) {
      const container = document.getElementById('archived-reports-list');

      if (data.reports.length === 0) {
        container.innerHTML = `
          <div style="grid-column:1/-1;padding:60px 20px;text-align:center;color:var(--muted);background:var(--panel2);border-radius:12px;border:1px dashed var(--edge)">
            <div style="font-size:48px;margin-bottom:16px;opacity:.6">üìÅ</div>
            <h4 style="margin:0 0 8px 0;font-size:16px;color:var(--ink)">No Reports Yet</h4>
            <p style="margin:0;font-size:13px">Create your first expense report above to get started</p>
          </div>
        `;
      } else {
        container.innerHTML = data.reports.map(report => {
          // Get business type color/gradient
          const businessColors = {
            'Music City Rodeo': 'linear-gradient(135deg, #f59e0b, #d97706)',
            'Down Home': 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
            'Personal': 'linear-gradient(135deg, #10b981, #059669)'
          };
          const businessGradient = businessColors[report.business_type] || 'linear-gradient(135deg, #6b7280, #4b5563)';

          return `
          <div class="report-card" style="background:linear-gradient(145deg, var(--panel2), rgba(11,17,23,.8));padding:0;border-radius:14px;border:1px solid var(--edge);overflow:hidden;transition:all .2s ease;cursor:pointer"
               onclick="openReport('${report.report_id}')"
               onmouseenter="this.style.transform='translateY(-4px)';this.style.boxShadow='0 12px 32px rgba(0,0,0,.3)';this.style.borderColor='rgba(59,130,246,.4)'"
               onmouseleave="this.style.transform='';this.style.boxShadow='';this.style.borderColor='var(--edge)'">

            <!-- Card Header with gradient -->
            <div style="background:${businessGradient};padding:16px 20px;position:relative;overflow:hidden">
              <div style="position:absolute;top:-20px;right:-20px;width:80px;height:80px;background:rgba(255,255,255,.1);border-radius:50%"></div>
              <div style="position:relative;z-index:1">
                <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;opacity:.9;margin-bottom:6px">${report.business_type}</div>
                <div style="font-size:16px;font-weight:700;line-height:1.3;color:white">${report.report_name}</div>
              </div>
            </div>

            <!-- Card Body -->
            <div style="padding:20px">
              <!-- Stats Row -->
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">
                <div style="text-align:center;padding:12px;background:rgba(59,130,246,.1);border-radius:10px">
                  <div style="font-size:20px;font-weight:800;color:var(--brand)">$${parseFloat(report.total_amount).toFixed(0)}</div>
                  <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Total</div>
                </div>
                <div style="text-align:center;padding:12px;background:rgba(139,92,246,.1);border-radius:10px">
                  <div style="font-size:20px;font-weight:800;color:#a78bfa">${report.expense_count}</div>
                  <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Expenses</div>
                </div>
                <div style="text-align:center;padding:12px;background:rgba(34,197,94,.1);border-radius:10px">
                  <div style="font-size:20px;font-weight:800;color:#4ade80">${report.receipt_count || '‚Äî'}</div>
                  <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Receipts</div>
                </div>
              </div>

              <!-- Date -->
              <div style="font-size:12px;color:var(--muted);margin-bottom:16px;display:flex;align-items:center;gap:6px">
                <span style="opacity:.7">üìÖ</span>
                Created ${new Date(report.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </div>

              <!-- Action Buttons -->
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <button onclick="event.stopPropagation();window.open('/reports/${report.report_id}/page', '_blank')"
                  style="padding:10px 12px;background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px"
                  onmouseenter="this.style.transform='scale(1.02)'" onmouseleave="this.style.transform=''">
                  üìä View
                </button>
                <button onclick="event.stopPropagation();window.location.href='/reports/${report.report_id}/export/downhome'"
                  style="padding:10px 12px;background:rgba(59,130,246,.15);color:var(--brand);border:1px solid rgba(59,130,246,.3);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px"
                  onmouseenter="this.style.background='rgba(59,130,246,.25)'" onmouseleave="this.style.background='rgba(59,130,246,.15)'">
                  üìÑ CSV
                </button>
                <button onclick="event.stopPropagation();window.location.href='/reports/${report.report_id}/receipts.zip'"
                  style="padding:10px 12px;background:rgba(139,92,246,.15);color:#a78bfa;border:1px solid rgba(139,92,246,.3);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px"
                  onmouseenter="this.style.background='rgba(139,92,246,.25)'" onmouseleave="this.style.background='rgba(139,92,246,.15)'">
                  üì¶ ZIP
                </button>
                <button onclick="event.stopPropagation();deleteReport('${report.report_id}')"
                  style="padding:10px 12px;background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.2);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px"
                  onmouseenter="this.style.background='rgba(239,68,68,.2)'" onmouseleave="this.style.background='rgba(239,68,68,.1)'">
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
          </div>
        `}).join('');
      }
    }
  } catch (e) {
    console.error('Failed to load archived reports:', e);
  }
}

async function openReport(reportId) {
  showToast('Loading report...', 'üìÇ');

  try {
    const res = await fetch(`/reports/${reportId}`);
    const data = await res.json();

    if (data.ok) {
      // Create modal HTML
      const modalHTML = `
        <div class="modal-overlay active" id="report-view-modal" style="z-index:10000">
          <div class="modal" style="max-width:1000px;max-height:80vh">
            <div class="modal-header">
              <div class="modal-title">üìä Report: ${reportId}</div>
              <button class="modal-close" onclick="closeReportModal()">√ó</button>
            </div>
            <div class="modal-body" style="max-height:60vh;overflow-y:auto">
              <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--edge)">
                <h3 style="margin:0 0 8px 0">${data.count} Expenses</h3>
                <p style="margin:0;color:var(--muted)">Total: $${data.total_amount.toFixed(2)}</p>
              </div>

              <table style="width:100%;border-collapse:collapse">
                <thead style="background:var(--panel2)">
                  <tr>
                    <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px">Date</th>
                    <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px">Description</th>
                    <th style="padding:10px;text-align:right;border-bottom:1px solid var(--edge);font-size:12px">Amount</th>
                    <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px">Category</th>
                    <th style="padding:10px;text-align:left;border-bottom:1px solid var(--edge);font-size:12px">Notes</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.expenses.map(exp => {
                    const notes = exp['Notes'] || exp['AI Note'] || '';
                    return `
                    <tr style="border-bottom:1px solid var(--edge)">
                      <td style="padding:10px">${exp['Chase Date'] || ''}</td>
                      <td style="padding:10px">${exp['Chase Description'] || ''}</td>
                      <td style="padding:10px;text-align:right">$${Math.abs(exp['Chase Amount'] || 0).toFixed(2)}</td>
                      <td style="padding:10px">${exp['Category'] || '-'}</td>
                      <td style="padding:10px;font-size:12px;color:var(--muted)">${notes || '-'}</td>
                    </tr>
                  `}).join('')}
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button class="btn-ghost" onclick="closeReportModal()">Close</button>
            </div>
          </div>
        </div>
      `;

      // Add to body
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = modalHTML;
      document.body.appendChild(tempDiv.firstElementChild);

      showToast('Report loaded', '‚úÖ');
    } else {
      showToast('Failed to load report: ' + (data.error || 'Unknown error'), '‚ùå');
    }
  } catch (e) {
    showToast('Failed to load report: ' + e.message, '‚ùå');
  }
}

function closeReportModal() {
  const modal = document.getElementById('report-view-modal');
  if (modal) {
    modal.remove();
  }
}
</script>
</body>
</html>
