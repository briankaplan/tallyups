<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="/static/manifest.json">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <title>ATLAS - Contact Intelligence</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #000000;
      --bg-card: #111111;
      --bg-elevated: #1a1a1a;
      --accent: #00ff88;
      --accent-dim: rgba(0, 255, 136, 0.15);
      --accent-glow: rgba(0, 255, 136, 0.3);
      --text: #ffffff;
      --text-dim: #666666;
      --text-secondary: #999999;
      --border: #222222;
      --success: #00ff88;
      --warning: #ffaa00;
      --error: #ff4444;
      --info: #4488ff;
      --purple: #aa66ff;
      --pink: #ff66aa;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      padding-top: var(--safe-top);
      padding-bottom: calc(80px + var(--safe-bottom));
    }

    /* Header */
    .header {
      padding: 20px 20px 16px;
      background: linear-gradient(180deg, rgba(170,102,255,0.08) 0%, transparent 100%);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-icon svg {
      width: 20px;
      height: 20px;
      color: #fff;
    }

    .logo-text {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .logo-text span {
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: var(--bg-elevated);
      border-color: var(--purple);
    }

    .icon-btn svg {
      width: 20px;
      height: 20px;
      color: var(--text-secondary);
    }

    .icon-btn.sync-active {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(170, 102, 255, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(170, 102, 255, 0); }
    }

    /* Multi-Select Mode */
    .select-mode-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .select-mode-btn:hover {
      border-color: var(--purple);
      color: var(--purple);
    }

    .select-mode-btn.active {
      background: var(--purple);
      border-color: var(--purple);
      color: #fff;
    }

    .contact-checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-right: 12px;
    }

    .select-mode .contact-checkbox {
      display: flex;
    }

    .contact-checkbox.selected {
      background: var(--purple);
      border-color: var(--purple);
    }

    .contact-checkbox.selected::after {
      content: '';
      width: 10px;
      height: 6px;
      border-left: 2px solid #fff;
      border-bottom: 2px solid #fff;
      transform: rotate(-45deg);
      margin-bottom: 2px;
    }

    /* Bulk Action Bar */
    .bulk-action-bar {
      position: fixed;
      bottom: calc(80px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-elevated);
      border: 1px solid var(--purple);
      border-radius: 16px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 8px 32px rgba(170, 102, 255, 0.3);
      z-index: 1000;
      transition: transform 0.3s ease;
      max-width: 90vw;
    }

    .bulk-action-bar.visible {
      transform: translateX(-50%) translateY(0);
    }

    .bulk-count {
      font-size: 14px;
      font-weight: 600;
      color: var(--purple);
      white-space: nowrap;
    }

    .bulk-category-select {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
      outline: none;
      cursor: pointer;
    }

    .bulk-apply-btn {
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .bulk-apply-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(170, 102, 255, 0.4);
    }

    .bulk-clear-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
    }

    .bulk-clear-btn:hover {
      border-color: var(--error);
      color: var(--error);
    }

    /* Search */
    .search-container {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 14px 14px 14px 44px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text);
      font-size: 16px;
      outline: none;
      transition: all 0.2s;
    }

    .search-input:focus {
      border-color: var(--purple);
      box-shadow: 0 0 0 3px rgba(170, 102, 255, 0.15);
    }

    .search-input::placeholder {
      color: var(--text-dim);
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      color: var(--text-dim);
    }

    /* Filter Chips */
    .filter-chips {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .filter-chips::-webkit-scrollbar {
      display: none;
    }

    .filter-chip {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-chip:hover {
      border-color: var(--purple);
      color: var(--text);
    }

    .filter-chip.active {
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      border-color: transparent;
      color: white;
    }

    .filter-chip .count {
      margin-left: 6px;
      padding: 2px 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      font-size: 11px;
    }

    /* Sync Panel */
    .sync-panel {
      margin: 16px;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      display: none;
    }

    .sync-panel.visible {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sync-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .sync-panel-title {
      font-size: 16px;
      font-weight: 600;
    }

    .sync-close {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .sync-sources {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .sync-source {
      padding: 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sync-source:hover {
      border-color: var(--purple);
    }

    .sync-source.syncing {
      pointer-events: none;
      opacity: 0.7;
    }

    .sync-source-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .sync-source-icon.google {
      background: linear-gradient(135deg, #4285f4 0%, #34a853 50%, #fbbc05 75%, #ea4335 100%);
    }

    .sync-source-icon.apple {
      background: linear-gradient(135deg, #333 0%, #666 100%);
    }

    .sync-source-icon svg {
      width: 22px;
      height: 22px;
      color: white;
    }

    .sync-source-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .sync-source-status {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .sync-source-status.connected {
      color: var(--success);
    }

    /* Sync Status Badge */
    .sync-status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .sync-status-info {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .sync-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .sync-stat-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .sync-stat-label {
      color: var(--text-secondary);
    }

    .sync-stat.pending .sync-stat-value {
      color: var(--warning);
    }

    .sync-stat.conflict .sync-stat-value {
      color: var(--danger);
    }

    .sync-stat.synced .sync-stat-value {
      color: var(--success);
    }

    /* Sync Direction Buttons */
    .sync-direction-btns {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .sync-dir-btn {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-card);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .sync-dir-btn:hover {
      border-color: var(--purple);
      background: rgba(124, 58, 237, 0.1);
    }

    .sync-dir-btn.syncing {
      opacity: 0.7;
      pointer-events: none;
    }

    .sync-dir-btn .icon {
      font-size: 18px;
    }

    .sync-dir-btn .label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sync-dir-btn.pull .icon { color: #22c55e; }
    .sync-dir-btn.push .icon { color: #3b82f6; }
    .sync-dir-btn.full .icon { color: #8b5cf6; }

    /* Sync Pending Badge */
    .sync-pending-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--warning);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    .sync-btn-wrapper {
      position: relative;
      display: inline-block;
    }

    /* Contact Sync Status Indicator */
    .contact-sync-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 8px;
      flex-shrink: 0;
    }

    .contact-sync-status.synced {
      background: var(--success);
    }

    .contact-sync-status.pending_push {
      background: var(--warning);
    }

    .contact-sync-status.conflict {
      background: var(--danger);
    }

    /* Stats Row */
    .stats-row {
      display: flex;
      gap: 8px;
      padding: 0 16px;
      margin-bottom: 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      align-items: center;
    }

    .load-all-btn {
      padding: 8px 16px;
      background: var(--purple);
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      margin-left: auto;
    }

    .load-all-btn:hover {
      background: #7C3AED;
      transform: scale(1.02);
    }

    .load-all-btn:disabled {
      background: var(--border);
      cursor: not-allowed;
    }

    .stat-pill {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .stat-pill-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--purple);
    }

    .stat-pill-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Contact List */
    .contact-list {
      padding: 0 16px;
      padding-right: 40px;
    }

    /* Alphabet Index Sidebar */
    .alphabet-index {
      position: fixed;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 90;
      padding: 8px 2px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .alpha-letter {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-dim);
      padding: 2px 6px;
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
      border-radius: 4px;
    }

    .alpha-letter:hover {
      color: var(--purple);
      transform: scale(1.2);
    }

    .alpha-letter.active {
      color: var(--purple);
      background: var(--accent-dim);
    }

    .alpha-letter.has-contacts::after {
      content: '';
      position: absolute;
      right: 0;
      width: 3px;
      height: 3px;
      background: var(--purple);
      border-radius: 50%;
    }

    .alpha-letter.no-contacts {
      opacity: 0.3;
      cursor: default;
    }

    .alpha-letter.no-contacts:hover {
      transform: none;
      color: var(--text-dim);
    }

    /* Search results indicator */
    .search-results-count {
      font-size: 12px;
      color: var(--text-secondary);
      padding: 8px 16px;
      text-align: center;
    }

    .search-results-count .highlight {
      color: var(--purple);
      font-weight: 600;
    }

    .search-results-count .query {
      color: var(--text-primary);
      font-weight: 500;
    }

    /* Search input wrapper for clear button */
    .search-wrapper {
      position: relative;
      flex: 1;
    }

    .search-wrapper .clear-search {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--bg-elevated);
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      display: none;
    }

    .search-wrapper .clear-search:hover {
      color: var(--text-primary);
      background: var(--border);
    }

    .search-wrapper input:not(:placeholder-shown) + .clear-search {
      display: block;
    }

    /* Category Chips Container */
    .category-chips-container {
      display: flex;
      gap: 8px;
      padding: 0 16px 12px;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .category-chips-container::-webkit-scrollbar {
      display: none;
    }

    .category-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .category-chip:hover {
      border-color: var(--purple);
      color: var(--text-primary);
    }

    .category-chip.active {
      background: var(--purple);
      border-color: var(--purple);
      color: white;
    }

    .category-chip .cat-count {
      font-size: 10px;
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 10px;
    }

    .category-chip:not(.active) .cat-count {
      background: var(--bg-elevated);
    }

    .category-chip .cat-icon {
      font-size: 14px;
    }

    .category-chip.add-category-chip {
      background: transparent;
      border: 1px dashed var(--purple);
      color: var(--purple);
    }

    .category-chip.add-category-chip:hover {
      background: rgba(139, 92, 246, 0.1);
      border-style: solid;
    }

    /* Load All button */
    .load-all-btn {
      display: block;
      width: calc(100% - 32px);
      margin: 16px auto;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--purple);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .load-all-btn:hover {
      background: var(--bg-elevated);
      border-color: var(--purple);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0 12px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-action {
      font-size: 13px;
      color: var(--purple);
      cursor: pointer;
    }

    /* Contact Card */
    .contact-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .contact-card:hover {
      border-color: var(--purple);
      transform: translateY(-2px);
    }

    .contact-card:active {
      transform: scale(0.98);
    }

    .contact-header {
      display: flex;
      gap: 14px;
      margin-bottom: 12px;
    }

    .contact-avatar {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
      overflow: hidden;
    }

    .contact-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-name {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .contact-name .vip-badge {
      padding: 2px 6px;
      background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
      border-radius: 4px;
      font-size: 9px;
      font-weight: 700;
      color: #000;
    }

    .contact-title {
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .contact-company {
      font-size: 13px;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Intelligence Score */
    .intelligence-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-top: 1px solid var(--border);
    }

    .intel-score {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .intel-score-ring {
      width: 36px;
      height: 36px;
      position: relative;
    }

    .intel-score-ring svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .intel-score-ring circle {
      fill: none;
      stroke-width: 3;
    }

    .intel-score-ring .bg {
      stroke: var(--border);
    }

    .intel-score-ring .progress {
      stroke: var(--purple);
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }

    .intel-score-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      font-weight: 700;
    }

    .intel-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .intel-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      flex: 1;
    }

    .intel-tag {
      padding: 4px 10px;
      background: var(--bg-elevated);
      border-radius: 12px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .intel-tag.high-value {
      background: rgba(0, 255, 136, 0.15);
      color: var(--success);
    }

    .intel-tag.needs-attention {
      background: rgba(255, 170, 0, 0.15);
      color: var(--warning);
    }

    .intel-tag.connected {
      background: rgba(170, 102, 255, 0.15);
      color: var(--purple);
    }

    /* Last Interaction */
    .last-interaction {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .last-interaction svg {
      width: 14px;
      height: 14px;
      opacity: 0.6;
    }

    .interaction-type {
      padding: 2px 8px;
      background: var(--bg-elevated);
      border-radius: 8px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Contact Detail Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1000;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }

    .modal-overlay.visible {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      background: var(--bg-card);
      border-radius: 24px 24px 0 0;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-header {
      padding: 20px;
      background: linear-gradient(180deg, rgba(170,102,255,0.15) 0%, transparent 100%);
      text-align: center;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: var(--bg-elevated);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .modal-avatar {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 600;
      color: white;
      margin: 0 auto 16px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .modal-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-avatar:hover::after {
      content: 'Upload';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 10px;
      font-weight: 500;
      padding: 4px 0;
      text-align: center;
    }

    .modal-avatar.has-photo:hover::after {
      content: 'Change';
    }

    .modal-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-uploading {
      font-size: 24px;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .modal-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .modal-title {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-section {
      margin-bottom: 24px;
    }

    .modal-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .intel-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .intel-item {
      background: var(--bg-elevated);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }

    .intel-item-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--purple);
      margin-bottom: 4px;
    }

    .intel-item-label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .timeline {
      position: relative;
      padding-left: 24px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 7px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 4px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--purple);
      border: 2px solid var(--bg-card);
    }

    .timeline-item.email::before { background: var(--info); }
    .timeline-item.call::before { background: var(--success); }
    .timeline-item.meeting::before { background: var(--warning); }

    .timeline-date {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .timeline-content {
      font-size: 14px;
      color: var(--text);
    }

    .timeline-type {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Relationship Health Indicator */
    .relationship-health {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: 16px;
      margin-bottom: 16px;
    }

    .health-ring {
      position: relative;
      width: 72px;
      height: 72px;
    }

    .health-ring svg {
      transform: rotate(-90deg);
    }

    .health-ring-bg {
      fill: none;
      stroke: var(--border);
      stroke-width: 6;
    }

    .health-ring-progress {
      fill: none;
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }

    .health-score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 700;
    }

    .health-details {
      flex: 1;
    }

    .health-status {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .health-status.excellent { color: #22c55e; }
    .health-status.good { color: #84cc16; }
    .health-status.fair { color: #eab308; }
    .health-status.needs-attention { color: #f97316; }
    .health-status.at-risk { color: #ef4444; }

    .health-message {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .health-last-contact {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    /* Interaction Quick Add */
    .interaction-quick-add {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .interaction-type-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      color: var(--text);
    }

    .interaction-type-btn:hover {
      border-color: var(--purple);
      background: rgba(170, 102, 255, 0.1);
    }

    .interaction-type-btn.active {
      background: var(--purple);
      border-color: var(--purple);
      color: white;
    }

    .interaction-type-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Log Interaction Modal */
    .interaction-modal-content {
      padding: 20px;
    }

    .interaction-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .interaction-types-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .interaction-type-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 8px;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .interaction-type-option:hover {
      border-color: var(--purple);
    }

    .interaction-type-option.selected {
      background: rgba(170, 102, 255, 0.15);
      border-color: var(--purple);
      color: var(--purple);
    }

    .interaction-type-option svg {
      width: 24px;
      height: 24px;
    }

    .interaction-note-input {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }

    .interaction-note-input:focus {
      outline: none;
      border-color: var(--purple);
    }

    .interaction-submit-btn {
      padding: 14px;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .interaction-submit-btn:hover {
      transform: scale(1.02);
    }

    /* Relationship Nudge */
    .relationship-nudge {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.15) 0%, rgba(249, 115, 22, 0.15) 100%);
      border: 1px solid rgba(234, 179, 8, 0.3);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .nudge-icon {
      width: 36px;
      height: 36px;
      background: rgba(234, 179, 8, 0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #eab308;
    }

    .nudge-icon svg {
      width: 20px;
      height: 20px;
    }

    .nudge-content {
      flex: 1;
    }

    .nudge-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .nudge-message {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .nudge-action {
      padding: 8px 12px;
      background: #eab308;
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Enhanced Timeline */
    .timeline-empty {
      text-align: center;
      padding: 24px;
      color: var(--text-dim);
      font-size: 13px;
    }

    .timeline-add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      background: var(--bg-elevated);
      border: 2px dashed var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 12px;
    }

    .timeline-add-btn:hover {
      border-color: var(--purple);
      color: var(--purple);
    }

    .timeline-add-btn svg {
      width: 16px;
      height: 16px;
    }

    .contact-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }

    .contact-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text);
    }

    .contact-action:hover {
      background: var(--purple);
    }

    .contact-action svg {
      width: 24px;
      height: 24px;
    }

    .contact-action span {
      font-size: 11px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: var(--bg-card);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-icon svg {
      width: 40px;
      height: 40px;
      color: var(--text-dim);
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .empty-btn {
      padding: 14px 28px;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      border: none;
      border-radius: 14px;
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .empty-btn:hover {
      transform: scale(1.05);
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(17, 17, 17, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      padding: 8px 0 calc(8px + var(--safe-bottom));
      display: flex;
      justify-content: space-around;
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      color: var(--text-dim);
      text-decoration: none;
      transition: all 0.2s;
    }

    .nav-item:hover {
      color: var(--text-secondary);
    }

    .nav-item.active {
      color: var(--purple);
    }

    .nav-item.active svg {
      transform: scale(1.1);
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
      transition: transform 0.2s;
    }

    .nav-label {
      font-size: 10px;
      font-weight: 500;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 14px 24px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 14px;
      font-size: 14px;
      z-index: 1001;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: var(--success);
      color: var(--success);
    }

    .toast.error {
      border-color: var(--error);
      color: var(--error);
    }

    /* Form Styles for Edit Modal */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form-input {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--purple);
      box-shadow: 0 0 0 3px rgba(170, 102, 255, 0.15);
    }

    .form-input::placeholder {
      color: var(--text-dim);
    }

    textarea.form-input {
      resize: vertical;
      min-height: 80px;
    }

    select.form-input {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .btn-primary {
      flex: 1;
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(170, 102, 255, 0.3);
    }

    .btn-secondary {
      flex: 1;
      padding: 12px 20px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      border-color: var(--text-secondary);
    }

    .btn-danger {
      padding: 12px 20px;
      background: transparent;
      border: 1px solid var(--error);
      border-radius: 10px;
      color: var(--error);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-danger:hover {
      background: rgba(255, 68, 68, 0.1);
    }

    /* Loading more contacts indicator */
    .loading-more {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      gap: 10px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .loading-more .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Loaded count indicator */
    .loaded-count {
      text-align: center;
      padding: 12px;
      color: var(--text-dim);
      font-size: 12px;
    }

    /* AI Features Panel */
    .ai-panel {
      margin: 12px 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(170, 102, 255, 0.1) 0%, rgba(255, 102, 170, 0.1) 100%);
      border: 1px solid rgba(170, 102, 255, 0.3);
      border-radius: 16px;
      display: none;
    }

    .ai-panel.visible {
      display: block;
      animation: slideDown 0.3s ease;
    }

    .ai-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .ai-panel-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ai-panel-title svg {
      width: 20px;
      height: 20px;
      color: var(--purple);
    }

    .ai-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .ai-action-btn {
      padding: 12px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .ai-action-btn:hover {
      border-color: var(--purple);
      transform: translateY(-1px);
    }

    .ai-action-btn.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .ai-action-icon {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .ai-action-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .ai-action-desc {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* AI Search */
    .ai-search-container {
      position: relative;
      margin-top: 12px;
    }

    .ai-search-input {
      width: 100%;
      padding: 12px 44px 12px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    .ai-search-input:focus {
      border-color: var(--purple);
    }

    .ai-search-btn {
      position: absolute;
      right: 6px;
      top: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Smart Filters */
    .smart-filters {
      display: none;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 16px;
      background: var(--bg-card);
      margin: 0 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
    }

    .smart-filters.visible {
      display: flex;
    }

    .smart-filter {
      padding: 6px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .smart-filter:hover {
      border-color: var(--purple);
      color: var(--text);
    }

    .smart-filter.active {
      background: var(--purple);
      border-color: var(--purple);
      color: white;
    }

    .smart-filter .count {
      padding: 2px 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      font-size: 10px;
    }

    .smart-filter-type {
      font-size: 10px;
      opacity: 0.7;
    }

    /* AI Results Panel */
    .ai-results {
      margin: 12px 16px;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: none;
    }

    .ai-results.visible {
      display: block;
    }

    .ai-results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .ai-results-title {
      font-size: 14px;
      font-weight: 600;
    }

    .ai-results-close {
      padding: 4px 8px;
      background: var(--bg-elevated);
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 12px;
    }

    .ai-result-item {
      padding: 12px;
      background: var(--bg-elevated);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .ai-result-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .ai-result-detail {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .ai-result-tags {
      display: flex;
      gap: 4px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .ai-result-tag {
      padding: 2px 8px;
      background: rgba(170, 102, 255, 0.2);
      border-radius: 6px;
      font-size: 10px;
      color: var(--purple);
    }

    /* ============================================
       BATCH CONTACT CLEANUP MODAL
       ============================================ */
    .cleanup-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .cleanup-modal {
      background: var(--card-bg);
      border-radius: 16px;
      width: 100%;
      max-width: 800px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .cleanup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .cleanup-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    .cleanup-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }

    .cleanup-close:hover {
      color: var(--text);
    }

    .cleanup-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .cleanup-loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .cleanup-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .cleanup-tabs {
      display: flex;
      gap: 8px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      flex-shrink: 0;
    }

    .cleanup-tab {
      padding: 8px 16px;
      background: var(--hover);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .cleanup-tab:hover {
      background: var(--border);
    }

    .cleanup-tab.active {
      background: var(--purple);
      border-color: var(--purple);
      color: white;
    }

    .cleanup-tab .count {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
      font-size: 11px;
    }

    .cleanup-tab.active .count {
      background: rgba(255, 255, 255, 0.3);
    }

    .cleanup-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px;
    }

    .cleanup-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .cleanup-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .cleanup-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--hover);
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }

    .cleanup-item:hover {
      background: var(--border);
    }

    .cleanup-item.selected {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .cleanup-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .cleanup-checkbox:hover {
      border-color: var(--purple);
    }

    .cleanup-checkbox.checked {
      background: #ef4444;
      border-color: #ef4444;
    }

    .cleanup-checkbox.checked::after {
      content: 'âœ“';
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .cleanup-info {
      flex: 1;
      min-width: 0;
    }

    .cleanup-name {
      font-weight: 500;
      color: var(--text);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cleanup-details {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cleanup-keep {
      padding: 6px 12px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      flex-shrink: 0;
      transition: opacity 0.2s;
    }

    .cleanup-keep:hover {
      opacity: 0.9;
    }

    .cleanup-actions {
      display: flex;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .cleanup-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cleanup-btn.secondary {
      background: var(--hover);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .cleanup-btn.secondary:hover {
      background: var(--border);
    }

    .cleanup-btn.danger {
      background: #ef4444;
      border: none;
      color: white;
      margin-left: auto;
    }

    .cleanup-btn.danger:hover:not(:disabled) {
      background: #dc2626;
    }

    .cleanup-btn.danger:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Date Helper for Birthday/Anniversary */
    .date-helper {
      display: block;
      font-size: 11px;
      margin-top: 4px;
      transition: color 0.2s;
    }

    .form-row {
      display: flex;
      gap: 16px;
    }

    .form-row .form-group {
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-top">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="8" r="4"/>
            <path d="M4 21v-2a4 4 0 014-4h8a4 4 0 014 4v2"/>
            <circle cx="19" cy="8" r="2"/>
            <path d="M19 10v1a2 2 0 01-2 2"/>
          </svg>
        </div>
        <span class="logo-text"><span>ATLAS</span></span>
      </div>
      <div class="header-actions">
        <button class="icon-btn" onclick="toggleAIPanel()" id="aiBtn" title="AI Features" style="background: linear-gradient(135deg, rgba(170,102,255,0.2) 0%, rgba(255,102,170,0.2) 100%);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
        </button>
        <button class="icon-btn" onclick="toggleSyncPanel()" id="syncBtn" title="Sync Contacts">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 2v6h-6M3 12a9 9 0 0115.4-6.4L21 8M3 22v-6h6M21 12a9 9 0 01-15.4 6.4L3 16"/>
          </svg>
        </button>
        <button class="icon-btn" onclick="addContact()" title="Add Contact">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="8" r="4"/>
            <path d="M16 21v-2a4 4 0 00-8 0v2"/>
            <line x1="19" y1="8" x2="19" y2="14"/>
            <line x1="16" y1="11" x2="22" y2="11"/>
          </svg>
        </button>
        <button class="icon-btn" onclick="openCleanupModal()" title="Cleanup Contacts" style="color: #f97316;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
          </svg>
        </button>
        <button class="select-mode-btn" onclick="toggleSelectMode()" id="selectModeBtn" title="Bulk Select & Categorize">
          Select
        </button>
      </div>
    </div>

    <div class="search-container">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <div class="search-wrapper">
        <input type="text" class="search-input" placeholder="Search contacts, companies..." id="searchInput" oninput="searchContacts()">
        <button class="clear-search" onclick="clearSearch()" title="Clear search">Ã—</button>
      </div>
    </div>
  </header>

  <!-- Sync Panel -->
  <div class="sync-panel" id="syncPanel">
    <div class="sync-panel-header">
      <span class="sync-panel-title">Sync Contacts</span>
      <button class="sync-close" onclick="toggleSyncPanel()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Sync Status Bar -->
    <div class="sync-status-bar" id="syncStatusBar">
      <div class="sync-status-info">
        <div class="sync-stat synced">
          <span class="sync-stat-value" id="syncedCount">0</span>
          <span class="sync-stat-label">Synced</span>
        </div>
        <div class="sync-stat pending">
          <span class="sync-stat-value" id="pendingCount">0</span>
          <span class="sync-stat-label">Pending</span>
        </div>
        <div class="sync-stat conflict">
          <span class="sync-stat-value" id="conflictCount">0</span>
          <span class="sync-stat-label">Conflicts</span>
        </div>
      </div>
      <div class="sync-last-sync" id="lastSyncTime" style="font-size: 11px; color: var(--text-secondary);">
        Never synced
      </div>
    </div>

    <div class="sync-sources">
      <div class="sync-source" id="googleSync">
        <div class="sync-source-icon google">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/>
          </svg>
        </div>
        <div class="sync-source-name">Google Contacts</div>
        <div class="sync-source-status" id="googleStatus">Not connected</div>

        <!-- Bidirectional Sync Buttons -->
        <div class="sync-direction-btns">
          <button class="sync-dir-btn pull" onclick="syncGooglePull()" title="Pull from Google">
            <span class="icon">&#x2B07;</span>
            <span class="label">Pull</span>
          </button>
          <button class="sync-dir-btn push" onclick="syncGooglePush()" title="Push to Google">
            <span class="icon">&#x2B06;</span>
            <span class="label">Push</span>
          </button>
          <button class="sync-dir-btn full" onclick="syncGoogleFull()" title="Full Bidirectional Sync">
            <span class="icon">&#x21C4;</span>
            <span class="label">Full</span>
          </button>
        </div>
      </div>
      <div class="sync-source" id="appleSync">
        <div class="sync-source-icon apple">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.71,19.5C17.88,20.74 17,21.95 15.66,21.97C14.32,22 13.89,21.18 12.37,21.18C10.84,21.18 10.37,21.95 9.1,22C7.79,22.05 6.8,20.68 5.96,19.47C4.25,17 2.94,12.45 4.7,9.39C5.57,7.87 7.13,6.91 8.82,6.88C10.1,6.86 11.32,7.75 12.11,7.75C12.89,7.75 14.37,6.68 15.92,6.84C16.57,6.87 18.39,7.1 19.56,8.82C19.47,8.88 17.39,10.1 17.41,12.63C17.44,15.65 20.06,16.66 20.09,16.67C20.06,16.74 19.67,18.11 18.71,19.5M13,3.5C13.73,2.67 14.94,2.04 15.94,2C16.07,3.17 15.6,4.35 14.9,5.19C14.21,6.04 13.07,6.7 11.95,6.61C11.8,5.46 12.36,4.26 13,3.5Z"/>
          </svg>
        </div>
        <div class="sync-source-name">Apple Contacts</div>
        <div class="sync-source-status" id="appleStatus">Pull only (macOS)</div>

        <!-- Apple Sync - Pull Only -->
        <div class="sync-direction-btns">
          <button class="sync-dir-btn pull" onclick="syncApple()" title="Pull from Apple Contacts">
            <span class="icon">&#x2B07;</span>
            <span class="label">Pull</span>
          </button>
          <button class="sync-dir-btn push" disabled style="opacity: 0.4; cursor: not-allowed;" title="Push requires native macOS app">
            <span class="icon">&#x2B06;</span>
            <span class="label">N/A</span>
          </button>
          <button class="sync-dir-btn" onclick="exportToVCard()" title="Export as vCard for manual import">
            <span class="icon">&#x1F4E4;</span>
            <span class="label">Export</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Panel -->
  <div class="ai-panel" id="aiPanel">
    <div class="ai-panel-header">
      <div class="ai-panel-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        AI Contact Intelligence
      </div>
      <button class="sync-close" onclick="toggleAIPanel()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="ai-actions">
      <div class="ai-action-btn" onclick="aiCategorize()" id="aiCategorizeBtn">
        <div class="ai-action-icon">&#x1F3AF;</div>
        <div class="ai-action-title">Auto-Categorize</div>
        <div class="ai-action-desc">AI analyzes and categorizes uncategorized contacts</div>
      </div>
      <div class="ai-action-btn" onclick="aiSmartFilters()" id="aiFiltersBtn">
        <div class="ai-action-icon">&#x1F50D;</div>
        <div class="ai-action-title">Smart Filters</div>
        <div class="ai-action-desc">Generate intelligent filter suggestions</div>
      </div>
      <div class="ai-action-btn" onclick="aiFindDuplicates()" id="aiDedupeBtn">
        <div class="ai-action-icon">&#x1F465;</div>
        <div class="ai-action-title">Find Duplicates</div>
        <div class="ai-action-desc">Detect potential duplicate contacts</div>
      </div>
      <div class="ai-action-btn" onclick="aiEnrich()" id="aiEnrichBtn">
        <div class="ai-action-icon">&#x2728;</div>
        <div class="ai-action-title">Find Incomplete</div>
        <div class="ai-action-desc">Identify contacts missing key info</div>
      </div>
    </div>
    <div class="ai-search-container">
      <input type="text" class="ai-search-input" placeholder="Ask AI: 'executives at tech companies', 'VIP contacts'..." id="aiSearchInput" onkeydown="if(event.key==='Enter') aiSearch()">
      <button class="ai-search-btn" onclick="aiSearch()">Search</button>
    </div>
  </div>

  <!-- Smart Filters (populated by AI) -->
  <div class="smart-filters" id="smartFilters"></div>

  <!-- AI Results Panel -->
  <div class="ai-results" id="aiResults">
    <div class="ai-results-header">
      <div class="ai-results-title" id="aiResultsTitle">AI Results</div>
      <button class="ai-results-close" onclick="closeAIResults()">Close</button>
    </div>
    <div id="aiResultsContent"></div>
  </div>

  <!-- Filter Chips -->
  <div class="filter-chips">
    <div class="filter-chip active" data-filter="all" onclick="setFilter('all', this)">All<span class="count" id="countAll">0</span></div>
    <div class="filter-chip" data-filter="vip" onclick="setFilter('vip', this)">VIP<span class="count" id="countVip">0</span></div>
    <div class="filter-chip" data-filter="recent" onclick="setFilter('recent', this)">Recent</div>
    <div class="filter-chip" data-filter="needs-attention" onclick="setFilter('needs-attention', this)">Needs Attention</div>
  </div>

  <!-- Industry Category Chips -->
  <div class="category-chips-container" id="categoryChips">
    <!-- Dynamically populated -->
  </div>

  <!-- Stats Row -->
  <div class="stats-row">
    <div class="stat-pill">
      <span class="stat-pill-value" id="totalContacts">0</span>
      <span class="stat-pill-label">Contacts</span>
    </div>
    <div class="stat-pill">
      <span class="stat-pill-value" id="avgScore">0</span>
      <span class="stat-pill-label">Avg Score</span>
    </div>
    <div class="stat-pill">
      <span class="stat-pill-value" id="recentInteractions">0</span>
      <span class="stat-pill-label">This Week</span>
    </div>
    <button class="load-all-btn" id="loadAllBtn" onclick="loadAllContacts()" style="display: none;">
      Load All <span id="remainingCount"></span>
    </button>
  </div>

  <!-- Contact List -->
  <div class="contact-list" id="contactList">
    <div class="loading" id="loadingState">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- Bulk Action Bar -->
  <div class="bulk-action-bar" id="bulkActionBar">
    <span class="bulk-count" id="bulkCount">0 selected</span>
    <select class="bulk-category-select" id="bulkCategorySelect">
      <option value="">Select Category...</option>
      <option value="General">General</option>
      <option value="Music Industry">Music Industry</option>
      <option value="TV/Film">TV/Film</option>
      <option value="Tech Industry">Tech Industry</option>
      <option value="Friends">Friends</option>
      <option value="Family">Family</option>
      <option value="Business">Business</option>
      <option value="Finance">Finance</option>
      <option value="Media/Press">Media/Press</option>
      <option value="Legal">Legal</option>
      <option value="Healthcare">Healthcare</option>
      <option value="Real Estate">Real Estate</option>
      <option value="Hospitality">Hospitality</option>
      <option value="Government">Government</option>
      <option value="">-- Clear Category --</option>
    </select>
    <button class="bulk-apply-btn" onclick="applyBulkCategory()">Apply</button>
    <button class="bulk-clear-btn" onclick="clearSelection()">Clear</button>
  </div>

  <!-- Alphabet Index Sidebar -->
  <div class="alphabet-index" id="alphabetIndex"></div>

  <!-- Search Results Count -->
  <div class="search-results-count" id="searchResultsCount" style="display: none;"></div>

  <!-- Contact Detail Modal -->
  <div class="modal-overlay" id="contactModal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <button class="modal-close" onclick="closeModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
        <div class="modal-avatar" id="modalAvatar" onclick="triggerPhotoUpload()" title="Click to upload photo">JD</div>
        <input type="file" id="photoUploadInput" accept="image/*" style="display: none;" onchange="uploadContactPhoto(event)">
        <div class="modal-name" id="modalName">John Doe</div>
        <div class="modal-title" id="modalTitle">CEO at Company</div>
      </div>
      <div class="modal-body">
        <!-- Relationship Nudge (shown when needed) -->
        <div class="relationship-nudge" id="relationshipNudge" style="display: none;">
          <div class="nudge-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
          </div>
          <div class="nudge-content">
            <div class="nudge-title" id="nudgeTitle">Time to reconnect</div>
            <div class="nudge-message" id="nudgeMessage">You haven't talked in a while</div>
          </div>
          <button class="nudge-action" onclick="quickReachOut()">Reach Out</button>
        </div>

        <!-- Relationship Health Ring -->
        <div class="relationship-health" id="relationshipHealth">
          <div class="health-ring">
            <svg width="72" height="72" viewBox="0 0 72 72">
              <circle class="health-ring-bg" cx="36" cy="36" r="30"/>
              <circle class="health-ring-progress" id="healthRingProgress" cx="36" cy="36" r="30"
                stroke="#22c55e" stroke-dasharray="188.5" stroke-dashoffset="47"/>
            </svg>
            <div class="health-score-text" id="healthScoreText">--</div>
          </div>
          <div class="health-details">
            <div class="health-status" id="healthStatus">Loading...</div>
            <div class="health-message" id="healthMessage">Fetching relationship data...</div>
            <div class="health-last-contact" id="healthLastContact"></div>
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Relationship Intelligence</div>
          <div class="intel-grid">
            <div class="intel-item">
              <div class="intel-item-value" id="modalScore">85</div>
              <div class="intel-item-label">Score</div>
            </div>
            <div class="intel-item">
              <div class="intel-item-value" id="modalInteractions">24</div>
              <div class="intel-item-label">Interactions</div>
            </div>
            <div class="intel-item">
              <div class="intel-item-value" id="modalDays">45</div>
              <div class="intel-item-label">Days Known</div>
            </div>
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Log Interaction</div>
          <div class="interaction-quick-add">
            <button class="interaction-type-btn" onclick="logQuickInteraction('call')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
              </svg>
              Call
            </button>
            <button class="interaction-type-btn" onclick="logQuickInteraction('email')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              Email
            </button>
            <button class="interaction-type-btn" onclick="logQuickInteraction('meeting')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              Meeting
            </button>
            <button class="interaction-type-btn" onclick="logQuickInteraction('message')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
              </svg>
              Message
            </button>
            <button class="interaction-type-btn" onclick="openInteractionModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Other
            </button>
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Recent Activity</div>
          <div class="timeline" id="modalTimeline">
            <!-- Timeline items populated by JS -->
          </div>
          <button class="timeline-add-btn" onclick="openInteractionModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Interaction
          </button>
        </div>
      </div>
      <div class="contact-actions">
        <button class="contact-action" onclick="callContact()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
          </svg>
          <span>Call</span>
        </button>
        <button class="contact-action" onclick="emailContact()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
          <span>Email</span>
        </button>
        <button class="contact-action" onclick="messageContact()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
          </svg>
          <span>Message</span>
        </button>
        <button class="contact-action" onclick="editContact()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          <span>Edit</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Interaction Log Modal -->
  <div class="modal-overlay" id="interactionModal" onclick="closeInteractionModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header" style="padding: 16px 20px;">
        <button class="modal-close" onclick="closeInteractionModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
        <div style="font-size: 18px; font-weight: 600;">Log Interaction</div>
      </div>
      <div class="interaction-modal-content">
        <form class="interaction-form" onsubmit="submitInteraction(event)">
          <div class="modal-section-title">Type</div>
          <div class="interaction-types-grid">
            <div class="interaction-type-option" onclick="selectInteractionType('call')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
              </svg>
              Call
            </div>
            <div class="interaction-type-option" onclick="selectInteractionType('email')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              Email
            </div>
            <div class="interaction-type-option" onclick="selectInteractionType('meeting')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              Meeting
            </div>
            <div class="interaction-type-option" onclick="selectInteractionType('message')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
              </svg>
              Message
            </div>
            <div class="interaction-type-option" onclick="selectInteractionType('social')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                <path d="M16 3.13a4 4 0 010 7.75"/>
              </svg>
              Social
            </div>
            <div class="interaction-type-option" onclick="selectInteractionType('gift')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 12 20 22 4 22 4 12"/>
                <rect x="2" y="7" width="20" height="5"/>
                <line x1="12" y1="22" x2="12" y2="7"/>
                <path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/>
                <path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/>
              </svg>
              Gift
            </div>
            <div class="interaction-type-option" onclick="selectInteractionType('deal')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
              </svg>
              Deal
            </div>
            <div class="interaction-type-option" onclick="selectInteractionType('note')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              Note
            </div>
          </div>

          <div class="modal-section-title">Notes</div>
          <textarea class="interaction-note-input" id="interactionNotes" placeholder="What happened? Add context..."></textarea>

          <input type="hidden" id="selectedInteractionType" value="">
          <button type="submit" class="interaction-submit-btn">Log Interaction</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="/" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
      <span class="nav-label">Home</span>
    </a>
    <a href="/viewer" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <line x1="3" y1="9" x2="21" y2="9"/>
        <line x1="9" y1="21" x2="9" y2="9"/>
      </svg>
      <span class="nav-label">Reconcile</span>
    </a>
    <a href="/library" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>
      </svg>
      <span class="nav-label">Library</span>
    </a>
    <a href="/scanner" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <path d="M7 7h3v3H7zM14 7h3v3h-3zM7 14h3v3H7z"/>
      </svg>
      <span class="nav-label">Scan</span>
    </a>
    <a href="/incoming" class="nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
        <path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/>
      </svg>
      <span class="nav-label">Inbox</span>
    </a>
    <a href="/contacts" class="nav-item active">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="8" r="4"/>
        <path d="M4 21v-2a4 4 0 014-4h8a4 4 0 014 4v2"/>
      </svg>
      <span class="nav-label">Contacts</span>
    </a>
  </nav>

  <script>
    // State
    let contacts = [];
    let currentFilter = 'all';
    let currentContact = null;
    let isLoading = false;
    let hasMoreContacts = true;
    let currentOffset = 0;
    const BATCH_SIZE = 10000; // Load ALL contacts at once - no pagination

    // Multi-Select State
    let isSelectMode = false;
    let selectedContacts = new Set();

    // Toggle Select Mode
    function toggleSelectMode() {
      isSelectMode = !isSelectMode;
      const btn = document.getElementById('selectModeBtn');
      const list = document.getElementById('contactList');

      if (isSelectMode) {
        btn.classList.add('active');
        btn.textContent = 'Done';
        list.classList.add('select-mode');
      } else {
        btn.classList.remove('active');
        btn.textContent = 'Select';
        list.classList.remove('select-mode');
        clearSelection();
      }
      renderContacts();
    }

    // Toggle contact selection
    function toggleContactSelection(contactId, event) {
      event.stopPropagation();
      if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
      } else {
        selectedContacts.add(contactId);
      }
      updateBulkActionBar();
      // Update checkbox visually
      const checkbox = document.querySelector(`[data-contact-id="${contactId}"] .contact-checkbox`);
      if (checkbox) {
        checkbox.classList.toggle('selected', selectedContacts.has(contactId));
      }
    }

    // Update bulk action bar visibility and count
    function updateBulkActionBar() {
      const bar = document.getElementById('bulkActionBar');
      const count = document.getElementById('bulkCount');
      if (selectedContacts.size > 0) {
        bar.classList.add('visible');
        count.textContent = `${selectedContacts.size} selected`;
      } else {
        bar.classList.remove('visible');
      }
    }

    // Clear all selections
    function clearSelection() {
      selectedContacts.clear();
      document.querySelectorAll('.contact-checkbox.selected').forEach(cb => {
        cb.classList.remove('selected');
      });
      updateBulkActionBar();
    }

    // Apply bulk category update
    async function applyBulkCategory() {
      const category = document.getElementById('bulkCategorySelect').value;
      if (selectedContacts.size === 0) {
        showToast('No contacts selected', 'warning');
        return;
      }

      const contactIds = Array.from(selectedContacts);

      try {
        const response = await fetch('/api/atlas/contacts/bulk-update?admin_key=tallyups-admin-2024', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contact_ids: contactIds,
            updates: { category: category || null }
          })
        });

        if (response.ok) {
          const result = await response.json();
          showToast(`Updated ${result.updated || contactIds.length} contacts`, 'success');

          // Update local contacts array
          contactIds.forEach(id => {
            const contact = contacts.find(c => c.id === id);
            if (contact) contact.category = category || null;
          });

          clearSelection();
          toggleSelectMode();
          renderContacts();
          renderCategoryChips();
        } else {
          showToast('Failed to update contacts', 'error');
        }
      } catch (e) {
        console.error('Bulk update error:', e);
        showToast('Error updating contacts', 'error');
      }
    }
    let totalContactCount = 0;
    let availableLetters = new Set();
    let currentActiveLetter = '';
    let searchDebounceTimer = null;
    let lastSearchQuery = '';
    let currentCategoryFilter = null;

    // Industry Categories Definition (base categories)
    // These match the actual database category values
    const BASE_CATEGORIES = [
      { id: 'music-industry', name: 'Music Industry', icon: 'ðŸŽµ', keywords: ['music', 'band', 'artist', 'producer', 'label', 'recording', 'songwriter', 'musician', 'dj'] },
      { id: 'executive-leadership', name: 'Executive/Leadership', icon: 'ðŸ‘”', keywords: ['executive', 'leadership', 'ceo', 'cto', 'cfo', 'president', 'vp', 'director', 'manager', 'founder', 'co-founder'] },
      { id: 'technology', name: 'Technology', icon: 'ðŸ’»', keywords: ['tech', 'technology', 'software', 'developer', 'engineer', 'startup', 'app', 'digital', 'it', 'programming', 'ai', 'ml'] },
      { id: 'media', name: 'Media', icon: 'ðŸ“°', keywords: ['media', 'press', 'journalist', 'news', 'reporter', 'editor', 'writer', 'publication', 'content', 'influencer'] },
      { id: 'legal-finance', name: 'Legal/Finance', icon: 'âš–ï¸', keywords: ['legal', 'finance', 'lawyer', 'attorney', 'law', 'counsel', 'bank', 'investment', 'accounting', 'cpa', 'financial'] },
      { id: 'tv-film', name: 'TV/Film', icon: 'ðŸŽ¬', keywords: ['film', 'tv', 'television', 'movie', 'production', 'director', 'actor', 'actress', 'entertainment'] },
      { id: 'friends', name: 'Friends', icon: 'ðŸ‘¥', keywords: ['friend', 'personal'] },
      { id: 'family', name: 'Family', icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦', keywords: ['family', 'mom', 'dad', 'sister', 'brother', 'parent', 'relative'] },
      { id: 'healthcare', name: 'Healthcare', icon: 'ðŸ¥', keywords: ['health', 'medical', 'doctor', 'nurse', 'hospital', 'clinic', 'physician', 'therapy'] },
      { id: 'real-estate', name: 'Real Estate', icon: 'ðŸ ', keywords: ['real estate', 'realtor', 'property', 'broker', 'realty', 'housing'] },
      { id: 'hospitality', name: 'Hospitality', icon: 'ðŸ¨', keywords: ['hotel', 'restaurant', 'hospitality', 'venue', 'catering', 'bar', 'chef'] },
      { id: 'government', name: 'Government', icon: 'ðŸ›ï¸', keywords: ['government', 'federal', 'state', 'city', 'council', 'senator', 'official', 'public'] },
      { id: 'general', name: 'General', icon: 'ðŸ“‹', keywords: [] }
    ];

    // Custom categories stored in localStorage
    let customCategories = JSON.parse(localStorage.getItem('atlas_custom_categories') || '[]');

    // Combined categories (base + custom)
    let INDUSTRY_CATEGORIES = [...BASE_CATEGORIES];
    function refreshCategories() {
      customCategories = JSON.parse(localStorage.getItem('atlas_custom_categories') || '[]');
      INDUSTRY_CATEGORIES = [...BASE_CATEGORIES.filter(c => c.id !== 'general'), ...customCategories, BASE_CATEGORIES.find(c => c.id === 'general')];
    }
    refreshCategories();

    // Add a new custom category
    function addCustomCategory(name, icon = 'ðŸ·ï¸') {
      const id = 'custom-' + name.toLowerCase().replace(/[^a-z0-9]/g, '-');

      // Check if already exists
      if (INDUSTRY_CATEGORIES.find(c => c.id === id || c.name.toLowerCase() === name.toLowerCase())) {
        alert('Category already exists!');
        return false;
      }

      const newCat = { id, name, icon, keywords: [name.toLowerCase()], custom: true };
      customCategories.push(newCat);
      localStorage.setItem('atlas_custom_categories', JSON.stringify(customCategories));
      refreshCategories();
      renderCategoryChips();
      return true;
    }

    // Remove a custom category
    function removeCustomCategory(id) {
      customCategories = customCategories.filter(c => c.id !== id);
      localStorage.setItem('atlas_custom_categories', JSON.stringify(customCategories));
      refreshCategories();
      renderCategoryChips();
    }

    // Show modal to add custom category
    function showAddCategoryModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay visible';
      modal.id = 'addCategoryModal';
      modal.innerHTML = `
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 400px;">
          <div class="modal-header" style="padding-bottom: 10px;">
            <button class="modal-close" onclick="closeAddCategoryModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
            <div class="modal-name" style="font-size: 20px;">Add Custom Category</div>
          </div>
          <div class="modal-body" style="padding: 16px;">
            <div class="form-group">
              <label>Category Name</label>
              <input type="text" id="newCategoryName" class="form-input" placeholder="e.g., Investors, Contractors..." maxlength="30">
            </div>
            <div class="form-group">
              <label>Icon (emoji)</label>
              <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                ${['ðŸ·ï¸', 'â­', 'ðŸ’¼', 'ðŸŽ¯', 'ðŸ”§', 'ðŸ“±', 'ðŸŽ¨', 'ðŸ¢', 'âœˆï¸', 'ðŸŽ“', 'ðŸƒ', 'ðŸŽ­'].map(e =>
                  `<button type="button" class="emoji-pick" onclick="document.getElementById('newCategoryIcon').value='${e}'" style="font-size: 20px; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface); cursor: pointer;">${e}</button>`
                ).join('')}
              </div>
              <input type="text" id="newCategoryIcon" class="form-input" value="ðŸ·ï¸" maxlength="2" style="width: 60px; text-align: center; font-size: 20px;">
            </div>
            <div class="form-actions" style="margin-top: 16px;">
              <button type="button" class="btn-secondary" onclick="closeAddCategoryModal()">Cancel</button>
              <button type="button" class="btn-primary" onclick="saveNewCategory()">Add Category</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) closeAddCategoryModal(); };
      document.getElementById('newCategoryName').focus();
    }

    function closeAddCategoryModal() {
      const modal = document.getElementById('addCategoryModal');
      if (modal) modal.remove();
    }

    function saveNewCategory() {
      const name = document.getElementById('newCategoryName').value.trim();
      const icon = document.getElementById('newCategoryIcon').value.trim() || 'ðŸ·ï¸';

      if (!name) {
        alert('Please enter a category name');
        return;
      }

      if (addCustomCategory(name, icon)) {
        closeAddCategoryModal();
        // Update the edit modal dropdown if it's open
        updateCategoryDropdown();
      }
    }

    // Update the category dropdown in edit modal
    function updateCategoryDropdown() {
      const select = document.getElementById('editCategory');
      if (!select) return;

      const currentValue = select.value;
      select.innerHTML = INDUSTRY_CATEGORIES.map(cat =>
        `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
      ).join('') + '<option value="__add_new__">+ Add New Category...</option>';
      select.value = currentValue;
    }

    // Handle category dropdown change - trigger add category modal if "Add New" selected
    function handleCategoryChange(select) {
      if (select.value === '__add_new__') {
        // Reset to previous value temporarily
        select.value = 'General';
        showAddCategoryModal();
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadContacts();
      checkSyncStatus();
      setupInfiniteScroll();
      renderAlphabetIndex();
      setupAlphabetScrollTracking();
    });

    // Render alphabet index sidebar
    function renderAlphabetIndex() {
      const container = document.getElementById('alphabetIndex');
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('');

      container.innerHTML = letters.map(letter => `
        <span class="alpha-letter" data-letter="${letter}" onclick="jumpToLetter('${letter}')">${letter}</span>
      `).join('');
    }

    // Update alphabet index based on loaded contacts
    function updateAlphabetIndex() {
      availableLetters.clear();

      contacts.forEach(c => {
        const name = c.display_name || c.name || '';
        if (name) {
          const firstChar = name[0].toUpperCase();
          if (/[A-Z]/.test(firstChar)) {
            availableLetters.add(firstChar);
          } else {
            availableLetters.add('#');
          }
        }
      });

      document.querySelectorAll('.alpha-letter').forEach(el => {
        const letter = el.dataset.letter;
        if (availableLetters.has(letter)) {
          el.classList.remove('no-contacts');
          el.classList.add('has-contacts');
        } else {
          el.classList.add('no-contacts');
          el.classList.remove('has-contacts');
        }
      });
    }

    // Jump to letter section
    function jumpToLetter(letter) {
      if (!availableLetters.has(letter)) return;

      const section = document.querySelector(`[data-section="${letter}"]`);
      if (section) {
        const headerOffset = 180;
        const elementPosition = section.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

        window.scrollTo({
          top: offsetPosition,
          behavior: 'smooth'
        });

        setActiveLetter(letter);
      }
    }

    // Set active letter in alphabet index
    function setActiveLetter(letter) {
      currentActiveLetter = letter;
      document.querySelectorAll('.alpha-letter').forEach(el => {
        el.classList.toggle('active', el.dataset.letter === letter);
      });
    }

    // Setup scroll tracking for active letter
    function setupAlphabetScrollTracking() {
      let scrollTimeout;
      window.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          updateActiveLetterOnScroll();
        }, 50);
      });
    }

    // Update active letter based on scroll position
    function updateActiveLetterOnScroll() {
      const sections = document.querySelectorAll('[data-section]');
      const headerOffset = 200;

      for (const section of sections) {
        const rect = section.getBoundingClientRect();
        if (rect.top <= headerOffset && rect.bottom > headerOffset) {
          setActiveLetter(section.dataset.section);
          return;
        }
      }
    }

    // Load all contacts at once
    async function loadAllContacts() {
      if (contacts.length >= totalContactCount) return;

      const btn = document.getElementById('loadAllBtn');
      if (btn) {
        btn.textContent = 'Loading all contacts...';
        btn.disabled = true;
      }

      try {
        const response = await fetch(`/api/atlas/contacts?limit=5000&offset=0`);
        const data = await response.json();

        if (data.contacts && data.contacts.length > 0) {
          contacts = data.contacts;
          totalContactCount = data.total || data.contacts.length;
          hasMoreContacts = false;
          currentOffset = contacts.length;
          renderContacts();
          renderCategoryChips();
          updateStats(data.stats || { total: totalContactCount });
          updateAlphabetIndex();
          updateLoadAllButton();
        }
      } catch (error) {
        console.error('Error loading all contacts:', error);
        if (btn) {
          btn.textContent = 'Retry Load All';
          btn.disabled = false;
        }
      }
    }

    // Update Load All button visibility
    function updateLoadAllButton() {
      const btn = document.getElementById('loadAllBtn');
      if (!btn) return;

      if (contacts.length < totalContactCount) {
        const remaining = totalContactCount - contacts.length;
        document.getElementById('remainingCount').textContent = `(${remaining} more)`;
        btn.style.display = 'block';
      } else {
        btn.style.display = 'none';
      }
    }

    // Setup infinite scroll
    function setupInfiniteScroll() {
      window.addEventListener('scroll', () => {
        if (isLoading || !hasMoreContacts) return;

        const scrollY = window.scrollY;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;

        // Load more when within 300px of bottom
        if (scrollY + windowHeight >= documentHeight - 300) {
          loadMoreContacts();
        }
      });
    }

    // Load contacts (initial load)
    async function loadContacts() {
      contacts = [];
      currentOffset = 0;
      hasMoreContacts = true;

      try {
        isLoading = true;
        const response = await fetch(`/api/atlas/contacts?limit=${BATCH_SIZE}&offset=0`);
        const data = await response.json();

        if (data.contacts && data.contacts.length > 0) {
          contacts = data.contacts;
          totalContactCount = data.total || data.contacts.length;
          hasMoreContacts = contacts.length < totalContactCount;
          currentOffset = contacts.length;
          updateStats(data.stats || { total: totalContactCount });
          renderContacts();
          renderCategoryChips();  // Render category filter chips with counts
          updateLoadAllButton();  // Show Load All button if more contacts available
          updateAlphabetIndex();  // Update alphabet sidebar
        } else {
          showEmptyState();
        }
      } catch (error) {
        console.error('Error loading contacts:', error);
        showEmptyState();
      } finally {
        isLoading = false;
      }
    }

    // Load more contacts (pagination)
    async function loadMoreContacts() {
      if (isLoading || !hasMoreContacts) return;

      try {
        isLoading = true;
        showLoadingMore();

        const response = await fetch(`/api/atlas/contacts?limit=${BATCH_SIZE}&offset=${currentOffset}`);
        const data = await response.json();

        if (data.contacts && data.contacts.length > 0) {
          contacts = [...contacts, ...data.contacts];
          currentOffset += data.contacts.length;
          hasMoreContacts = currentOffset < (data.total || totalContactCount);
          renderContacts();
          renderCategoryChips();  // Update category counts with new contacts
          updateLoadedCount();
          updateLoadAllButton();  // Update Load All button
          updateAlphabetIndex();  // Update alphabet sidebar
        } else {
          hasMoreContacts = false;
          updateLoadAllButton();
        }
      } catch (error) {
        console.error('Error loading more contacts:', error);
      } finally {
        isLoading = false;
        hideLoadingMore();
      }
    }

    // Show loading more indicator
    function showLoadingMore() {
      const existing = document.getElementById('loadingMore');
      if (existing) return;

      const loader = document.createElement('div');
      loader.id = 'loadingMore';
      loader.className = 'loading';
      loader.innerHTML = '<div class="spinner"></div>';
      document.getElementById('contactList').appendChild(loader);
    }

    // Hide loading more indicator
    function hideLoadingMore() {
      const loader = document.getElementById('loadingMore');
      if (loader) loader.remove();
    }

    // Update loaded count display
    function updateLoadedCount() {
      document.getElementById('totalContacts').textContent = `${contacts.length}/${totalContactCount}`;
    }

    // Update stats
    function updateStats(stats) {
      document.getElementById('totalContacts').textContent = totalContactCount || stats.total || contacts.length;
      document.getElementById('avgScore').textContent = stats.avg_score || calculateAvgScore();
      document.getElementById('recentInteractions').textContent = stats.recent_interactions || 0;
      // Show total from server, not just loaded count
      document.getElementById('countAll').textContent = totalContactCount || contacts.length;
      document.getElementById('countVip').textContent = contacts.filter(c => c.is_vip).length;
    }

    function calculateAvgScore() {
      if (contacts.length === 0) return 0;
      const sum = contacts.reduce((acc, c) => acc + (c.relationship_score || 0), 0);
      return Math.round(sum / contacts.length);
    }

    // Render contacts
    function renderContacts() {
      const list = document.getElementById('contactList');
      const loading = document.getElementById('loadingState');
      if (loading) loading.style.display = 'none';
      if (!list) return;

      if (contacts.length === 0) {
        showEmptyState();
        return;
      }

      let filtered = filterContacts(contacts);

      if (filtered.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
            </div>
            <div class="empty-title">No contacts found</div>
            <div class="empty-text">Try adjusting your search or filter</div>
          </div>
        `;
        return;
      }

      // Group by first letter
      const grouped = {};
      filtered.forEach(contact => {
        let letter = (contact.display_name || contact.name || 'Unknown')[0].toUpperCase();
        if (!/[A-Z]/.test(letter)) letter = '#';
        if (!grouped[letter]) grouped[letter] = [];
        grouped[letter].push(contact);
      });

      let html = '';
      Object.keys(grouped).sort().forEach(letter => {
        html += `
          <div class="section-header" data-section="${letter}">
            <span class="section-title">${letter}</span>
            <span class="section-action">${grouped[letter].length}</span>
          </div>
        `;

        grouped[letter].forEach(contact => {
          html += renderContactCard(contact);
        });
      });

      // Add Load All button if there are more contacts to load
      if (hasMoreContacts && contacts.length < totalContactCount) {
        html += `
          <button class="load-all-btn" onclick="loadAllContacts()">
            Load All ${totalContactCount} Contacts
          </button>
        `;
      }

      list.innerHTML = html;
      updateAlphabetIndex();
    }

    // Render contact card
    function renderContactCard(contact) {
      const initials = getInitials(contact.display_name || contact.name || 'Unknown');
      const score = contact.relationship_score || 0; // No fake scores - show actual data only
      const circumference = 2 * Math.PI * 14;
      const offset = circumference - (score / 100) * circumference;

      const tags = [];
      if (contact.is_vip) tags.push('<span class="intel-tag high-value">VIP</span>');
      if (contact.needs_attention) tags.push('<span class="intel-tag needs-attention">Needs attention</span>');
      if (contact.category === 'business') tags.push('<span class="intel-tag connected">Business</span>');

      return `
        <div class="contact-card" data-contact-id="${contact.id}" onclick="${isSelectMode ? `toggleContactSelection(${contact.id}, event)` : `openContact(${contact.id})`}">
          <div class="contact-checkbox ${selectedContacts.has(contact.id) ? 'selected' : ''}" onclick="event.stopPropagation(); toggleContactSelection(${contact.id}, event)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </div>
          <div class="contact-header">
            <div class="contact-avatar">
              ${contact.photo_url ? `<img src="${contact.photo_url}" alt="">` : initials}
            </div>
            <div class="contact-info">
              <div class="contact-name">
                ${contact.display_name || contact.name || 'Unknown'}
                ${contact.is_vip ? '<span class="vip-badge">VIP</span>' : ''}
              </div>
              ${contact.title ? `<div class="contact-title">${contact.title}</div>` : ''}
              ${contact.company ? `<div class="contact-company">${contact.company}</div>` : ''}
            </div>
          </div>
          <div class="intelligence-row">
            <div class="intel-score">
              <div class="intel-score-ring">
                <svg viewBox="0 0 36 36">
                  <circle class="bg" cx="18" cy="18" r="14"/>
                  <circle class="progress" cx="18" cy="18" r="14"
                    stroke-dasharray="${circumference}"
                    stroke-dashoffset="${offset}"/>
                </svg>
                <span class="intel-score-value">${score}</span>
              </div>
              <span class="intel-label">Score</span>
            </div>
            <div class="intel-tags">
              ${tags.join('')}
            </div>
          </div>
          ${contact.last_interaction ? `
            <div class="last-interaction">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              <span>${formatDate(contact.last_interaction)}</span>
              <span class="interaction-type">${contact.last_interaction_type || 'Contact'}</span>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Filter contacts
    function filterContacts(contactsList) {
      const search = document.getElementById('searchInput').value.toLowerCase().trim();

      return contactsList.filter(c => {
        // Build searchable text from all relevant fields
        const name = (c.display_name || c.name || '').toLowerCase();
        const firstName = (c.first_name || '').toLowerCase();
        const lastName = (c.last_name || '').toLowerCase();
        const company = (c.company || '').toLowerCase();
        const title = (c.title || c.job_title || '').toLowerCase();
        const email = (c.email || '').toLowerCase();
        const phone = (c.phone || '').toLowerCase();
        const notes = (c.notes || '').toLowerCase();
        const category = (c.category || '').toLowerCase();

        // Check if search matches any field
        const matchesSearch = !search ||
          name.includes(search) ||
          firstName.includes(search) ||
          lastName.includes(search) ||
          company.includes(search) ||
          title.includes(search) ||
          email.includes(search) ||
          phone.includes(search) ||
          notes.includes(search) ||
          category.includes(search);

        // Quick filter (VIP, Recent, Needs Attention)
        let matchesFilter = true;
        switch (currentFilter) {
          case 'vip': matchesFilter = c.is_vip || c.priority === 'High'; break;
          case 'recent': matchesFilter = c.last_interaction && isRecent(c.last_interaction); break;
          case 'needs-attention': matchesFilter = c.needs_attention; break;
        }

        // Category filter
        let matchesCategory = true;
        if (currentCategoryFilter) {
          const contactCategory = detectContactCategory(c);
          matchesCategory = contactCategory === currentCategoryFilter;
        }

        return matchesSearch && matchesFilter && matchesCategory;
      });
    }

    // Debounced Live Search
    function searchContacts() {
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(() => {
        const query = document.getElementById('searchInput').value.trim();
        if (query !== lastSearchQuery) {
          lastSearchQuery = query;
          renderContacts();
          updateSearchResultsCount();
        }
      }, 150);
    }

    // Immediate search (for programmatic calls)
    function searchContactsImmediate() {
      const query = document.getElementById('searchInput').value.trim();
      lastSearchQuery = query;
      renderContacts();
      updateSearchResultsCount();
    }

    // Update search results count display
    function updateSearchResultsCount() {
      const search = document.getElementById('searchInput').value.trim();
      const resultsDiv = document.getElementById('searchResultsCount');

      if (search) {
        const filtered = filterContacts(contacts);
        resultsDiv.innerHTML = `<span class="highlight">${filtered.length}</span> results for "<span class="query">${escapeHtml(search)}</span>"`;
        resultsDiv.style.display = 'block';
      } else {
        resultsDiv.style.display = 'none';
      }
    }

    // Escape HTML for safe display
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Clear search
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      lastSearchQuery = '';
      document.getElementById('searchResultsCount').style.display = 'none';
      renderContacts();
    }

    // Detect category for a contact based on stored category name or keywords
    function detectContactCategory(contact) {
      // First, check if contact.category directly matches a category name OR id
      if (contact.category) {
        const storedCat = contact.category.toLowerCase().trim();
        for (const cat of INDUSTRY_CATEGORIES) {
          const catNameLower = cat.name.toLowerCase();
          const catIdLower = cat.id.toLowerCase();

          // Match by exact name (case-insensitive)
          if (catNameLower === storedCat) {
            return cat.id;
          }
          // Match by exact id (case-insensitive)
          if (catIdLower === storedCat) {
            return cat.id;
          }
          // Match by id without dashes (e.g., "musicindustry" matches "music-industry")
          if (catIdLower.replace(/-/g, '') === storedCat.replace(/[\s-]/g, '')) {
            return cat.id;
          }
          // Partial match for flexibility (e.g., "Music" matches "Music Industry")
          if (catNameLower.includes(storedCat) || storedCat.includes(catNameLower)) {
            return cat.id;
          }
        }
      }

      // Then check for keyword matches in company, title, notes, AND the category field itself
      const searchText = [
        contact.company || '',
        contact.title || '',
        contact.job_title || '',
        contact.notes || '',
        contact.category || ''
      ].join(' ').toLowerCase();

      for (const cat of INDUSTRY_CATEGORIES) {
        if (cat.id === 'general') continue;
        for (const keyword of cat.keywords || []) {
          if (searchText.includes(keyword.toLowerCase())) {
            return cat.id;
          }
        }
      }
      return 'general';
    }

    // Render category chips with counts
    function renderCategoryChips() {
      const container = document.getElementById('categoryChips');
      if (!container) return;

      // Count contacts per category
      const categoryCounts = {};
      INDUSTRY_CATEGORIES.forEach(cat => categoryCounts[cat.id] = 0);

      contacts.forEach(contact => {
        const catId = detectContactCategory(contact);
        if (categoryCounts[catId] !== undefined) {
          categoryCounts[catId]++;
        }
      });

      // Only show categories with contacts (except general)
      const chipsHtml = INDUSTRY_CATEGORIES
        .filter(cat => categoryCounts[cat.id] > 0 || cat.id === 'general')
        .map(cat => {
          const isActive = currentCategoryFilter === cat.id;
          const count = categoryCounts[cat.id];
          return `
            <div class="category-chip ${isActive ? 'active' : ''}"
                 data-category="${cat.id}"
                 onclick="setCategoryFilter('${cat.id}')">
              <span class="cat-icon">${cat.icon}</span>
              ${cat.name}
              <span class="cat-count">${count}</span>
            </div>
          `;
        }).join('');

      // Add "All Categories" at the beginning and "+ Add" at the end
      const allActive = !currentCategoryFilter;
      container.innerHTML = `
        <div class="category-chip ${allActive ? 'active' : ''}"
             data-category="all"
             onclick="setCategoryFilter(null)">
          <span class="cat-icon">*</span>
          All Categories
        </div>
      ` + chipsHtml + `
        <div class="category-chip add-category-chip" onclick="showAddCategoryModal()">
          <span class="cat-icon">+</span>
          Add
        </div>
      `;
    }

    // Set category filter
    function setCategoryFilter(categoryId) {
      currentCategoryFilter = categoryId;

      // Update visual state
      document.querySelectorAll('.category-chip').forEach(el => el.classList.remove('active'));
      const activeChip = document.querySelector(`.category-chip[data-category="${categoryId || 'all'}"]`);
      if (activeChip) {
        activeChip.classList.add('active');
      }

      // Force re-render
      renderContacts();
    }

    // Filter
    function setFilter(filter, element) {
      currentFilter = filter;
      document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
      element.classList.add('active');
      renderContacts();
    }

    // Open contact detail
    async function openContact(contactId) {
      currentContact = contacts.find(c => c.id === contactId);
      if (!currentContact) return;

      // Try to load full details
      try {
        const response = await fetch(`/api/atlas/contacts/${contactId}`);
        const data = await response.json();
        if (data.contact) {
          currentContact = { ...currentContact, ...data.contact };
        }
      } catch (e) {
        console.log('Using cached contact data');
      }

      const initials = getInitials(currentContact.display_name || currentContact.name || 'Unknown');
      const modalAvatar = document.getElementById('modalAvatar');

      if (currentContact.photo_url) {
        modalAvatar.innerHTML = `<img src="${currentContact.photo_url}" alt="">`;
        modalAvatar.classList.add('has-photo');
      } else {
        modalAvatar.innerHTML = initials;
        modalAvatar.classList.remove('has-photo');
      }
      document.getElementById('modalName').textContent = currentContact.display_name || currentContact.name || 'Unknown';
      document.getElementById('modalTitle').textContent =
        [currentContact.title, currentContact.company].filter(Boolean).join(' at ') || 'No title';

      document.getElementById('modalScore').textContent = currentContact.relationship_score || '--';
      document.getElementById('modalInteractions').textContent = currentContact.interaction_count || 0;
      document.getElementById('modalDays').textContent = currentContact.days_known || calculateDaysKnown(currentContact.created_at);

      // Render timeline
      const timeline = document.getElementById('modalTimeline');
      if (currentContact.interactions && currentContact.interactions.length > 0) {
        timeline.innerHTML = currentContact.interactions.slice(0, 5).map(i => `
          <div class="timeline-item ${i.type}">
            <div class="timeline-date">${formatDate(i.date)}</div>
            <div class="timeline-content">${i.summary}</div>
            <div class="timeline-type">${i.type}</div>
          </div>
        `).join('');
      } else {
        timeline.innerHTML = `
          <div class="timeline-item">
            <div class="timeline-date">No recent activity</div>
            <div class="timeline-content">Start tracking interactions</div>
          </div>
        `;
      }

      document.getElementById('contactModal').classList.add('visible');
    }

    // Close modal
    function closeModal(event) {
      if (event && event.target !== document.getElementById('contactModal')) return;
      document.getElementById('contactModal').classList.remove('visible');
      currentContact = null;
    }

    // Photo upload functions
    function triggerPhotoUpload() {
      if (!currentContact) return;
      document.getElementById('photoUploadInput').click();
    }

    async function uploadContactPhoto(event) {
      const file = event.target.files[0];
      if (!file || !currentContact) return;

      // Validate file type
      const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        showToast('Please select a valid image file (JPEG, PNG, GIF, or WebP)', 'error');
        return;
      }

      // Show loading state
      const avatar = document.getElementById('modalAvatar');
      const originalContent = avatar.innerHTML;
      avatar.innerHTML = '<div class="photo-uploading">...</div>';
      avatar.style.cursor = 'wait';

      try {
        const formData = new FormData();
        formData.append('photo', file);

        const response = await fetch(`/api/atlas/contacts/${currentContact.id}/photo?admin_key=${ADMIN_KEY}`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          // Update avatar with new photo
          avatar.innerHTML = '';
          avatar.style.backgroundImage = `url(${data.photo_url})`;
          avatar.style.backgroundSize = 'cover';
          avatar.style.backgroundPosition = 'center';
          avatar.classList.add('has-photo');

          // Update contact in local data
          currentContact.photo_url = data.photo_url;
          const contactIndex = contacts.findIndex(c => c.id === currentContact.id);
          if (contactIndex >= 0) {
            contacts[contactIndex].photo_url = data.photo_url;
          }

          // Re-render contacts to show updated photo in list
          renderContacts();
          showToast('Photo uploaded successfully', 'success');
        } else {
          avatar.innerHTML = originalContent;
          showToast(data.error || 'Failed to upload photo', 'error');
        }
      } catch (e) {
        avatar.innerHTML = originalContent;
        showToast('Error uploading photo: ' + e.message, 'error');
      }

      avatar.style.cursor = 'pointer';
      event.target.value = ''; // Reset file input
    }

    async function deleteContactPhoto() {
      if (!currentContact || !currentContact.photo_url) return;

      if (!confirm('Remove this contact\'s photo?')) return;

      try {
        const response = await fetch(`/api/atlas/contacts/${currentContact.id}/photo?admin_key=${ADMIN_KEY}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          // Reset avatar to initials
          const avatar = document.getElementById('modalAvatar');
          avatar.style.backgroundImage = '';
          avatar.classList.remove('has-photo');
          avatar.innerHTML = getInitials(currentContact.name || currentContact.first_name);

          // Update contact in local data
          currentContact.photo_url = null;
          const contactIndex = contacts.findIndex(c => c.id === currentContact.id);
          if (contactIndex >= 0) {
            contacts[contactIndex].photo_url = null;
          }

          renderContacts();
          showToast('Photo removed', 'success');
        } else {
          showToast(data.error || 'Failed to remove photo', 'error');
        }
      } catch (e) {
        showToast('Error removing photo: ' + e.message, 'error');
      }
    }

    // Sync panel
    function toggleSyncPanel() {
      const panel = document.getElementById('syncPanel');
      panel.classList.toggle('visible');
    }

    // Check sync status
    async function checkSyncStatus() {
      try {
        const response = await fetch('/api/atlas/sync/status');
        const data = await response.json();

        // Update sync status bar counts
        if (data.synced !== undefined) {
          document.getElementById('syncedCount').textContent = data.synced || 0;
        }
        if (data.pending_push !== undefined) {
          document.getElementById('pendingCount').textContent = data.pending_push || 0;
        }
        if (data.conflicts !== undefined) {
          document.getElementById('conflictCount').textContent = data.conflicts || 0;
        }

        // Update last sync time
        if (data.last_sync) {
          const lastSync = new Date(data.last_sync);
          const now = new Date();
          const diffMs = now - lastSync;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMins / 60);
          const diffDays = Math.floor(diffHours / 24);

          let timeAgo;
          if (diffDays > 0) timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
          else if (diffHours > 0) timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
          else if (diffMins > 0) timeAgo = `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
          else timeAgo = 'Just now';

          document.getElementById('lastSyncTime').textContent = `Last sync: ${timeAgo}`;
        }

        // Update Google status
        if (data.google_linked > 0) {
          document.getElementById('googleStatus').textContent = `${data.google_linked} linked`;
          document.getElementById('googleStatus').classList.add('connected');
        }
      } catch (e) {
        console.log('Sync status not available:', e);
      }
    }

    // Load sync status on page load
    async function loadSyncStatus() {
      await checkSyncStatus();
    }

    // Sync Google
    async function syncGoogle() {
      const btn = document.getElementById('googleSync');
      btn.classList.add('syncing');
      document.getElementById('googleStatus').textContent = 'Syncing...';

      try {
        const response = await fetch('/api/atlas/sync/google', { method: 'POST' });
        const data = await response.json();

        if (data.success || data.ok) {
          const count = data.count || data.synced || 0;
          showToast(`Synced ${count} contacts from Google`, 'success');
          document.getElementById('googleStatus').textContent = `${count} contacts`;
          document.getElementById('googleStatus').classList.add('connected');
          loadContacts();
        } else {
          showToast(data.error || 'Sync failed', 'error');
          document.getElementById('googleStatus').textContent = 'Sync failed';
        }
      } catch (e) {
        showToast('Failed to sync Google contacts', 'error');
        document.getElementById('googleStatus').textContent = 'Error';
      }

      btn.classList.remove('syncing');
    }

    // Sync Apple
    async function syncApple() {
      const btn = document.getElementById('appleSync');
      btn.classList.add('syncing');
      document.getElementById('appleStatus').textContent = 'Syncing...';

      try {
        const response = await fetch('/api/atlas/sync/apple', { method: 'POST' });
        const data = await response.json();

        if (data.success || data.ok) {
          const count = data.count || data.pulled || 0;
          showToast(`Synced ${count} contacts from Apple`, 'success');
          document.getElementById('appleStatus').textContent = `${count} contacts`;
          document.getElementById('appleStatus').classList.add('connected');
          loadContacts();
        } else {
          showToast(data.error || 'Sync failed', 'error');
          document.getElementById('appleStatus').textContent = 'Not available';
        }
      } catch (e) {
        showToast('Failed to sync Apple contacts', 'error');
        document.getElementById('appleStatus').textContent = 'Error';
      }

      btn.classList.remove('syncing');
    }

    // Bidirectional Google Sync - Pull from Google
    async function syncGooglePull() {
      const btn = document.querySelector('.sync-dir-btn.pull');
      btn.classList.add('syncing');
      document.getElementById('googleStatus').textContent = 'Pulling...';

      try {
        const response = await fetch('/api/atlas/sync/google/pull', { method: 'POST' });
        const data = await response.json();

        if (data.ok) {
          showToast(`Pulled ${data.pulled || 0} contacts, merged ${data.merged || 0}`, 'success');
          document.getElementById('googleStatus').textContent = `${data.pulled || 0} pulled`;
          document.getElementById('googleStatus').classList.add('connected');
          loadContacts();
          checkSyncStatus();
        } else {
          showToast(data.error || 'Pull failed', 'error');
          document.getElementById('googleStatus').textContent = 'Pull failed';
        }
      } catch (e) {
        showToast('Failed to pull from Google', 'error');
        document.getElementById('googleStatus').textContent = 'Error';
      }

      btn.classList.remove('syncing');
    }

    // Bidirectional Google Sync - Push to Google
    async function syncGooglePush() {
      const btn = document.querySelector('.sync-dir-btn.push');
      btn.classList.add('syncing');
      document.getElementById('googleStatus').textContent = 'Pushing...';

      try {
        const response = await fetch('/api/atlas/sync/google/push', { method: 'POST' });
        const data = await response.json();

        if (data.ok) {
          showToast(`Pushed ${data.pushed || 0} contacts to Google`, 'success');
          document.getElementById('googleStatus').textContent = `${data.pushed || 0} pushed`;
          document.getElementById('googleStatus').classList.add('connected');
          checkSyncStatus();
        } else {
          showToast(data.error || 'Push failed', 'error');
          document.getElementById('googleStatus').textContent = 'Push failed';
        }
      } catch (e) {
        showToast('Failed to push to Google', 'error');
        document.getElementById('googleStatus').textContent = 'Error';
      }

      btn.classList.remove('syncing');
    }

    // Full Bidirectional Google Sync
    async function syncGoogleFull() {
      const btn = document.querySelector('.sync-dir-btn.full');
      btn.classList.add('syncing');
      document.getElementById('googleStatus').textContent = 'Full sync...';

      try {
        // First pull from Google
        const pullResponse = await fetch('/api/atlas/sync/google/pull', { method: 'POST' });
        const pullData = await pullResponse.json();

        // Then push local changes
        const pushResponse = await fetch('/api/atlas/sync/google/push', { method: 'POST' });
        const pushData = await pushResponse.json();

        if (pullData.ok || pushData.ok) {
          const pulled = pullData.pulled || 0;
          const pushed = pushData.pushed || 0;
          showToast(`Synced: ${pulled} pulled, ${pushed} pushed`, 'success');
          document.getElementById('googleStatus').textContent = `Synced`;
          document.getElementById('googleStatus').classList.add('connected');
          loadContacts();
          checkSyncStatus();
        } else {
          showToast('Full sync had issues', 'error');
          document.getElementById('googleStatus').textContent = 'Sync issues';
        }
      } catch (e) {
        showToast('Full sync failed', 'error');
        document.getElementById('googleStatus').textContent = 'Error';
      }

      btn.classList.remove('syncing');
    }

    // Export contacts to vCard format (for Apple Contacts import)
    async function exportToVCard() {
      try {
        showToast('Preparing vCard export...', 'info');

        // Get all contacts
        const response = await fetch('/api/atlas/contacts?limit=10000');
        const data = await response.json();
        const contacts = data.contacts || [];

        if (contacts.length === 0) {
          showToast('No contacts to export', 'error');
          return;
        }

        // Generate vCard format
        let vCardContent = '';
        contacts.forEach(c => {
          vCardContent += 'BEGIN:VCARD\n';
          vCardContent += 'VERSION:3.0\n';
          vCardContent += `N:${c.last_name || ''};${c.first_name || ''}\n`;
          vCardContent += `FN:${c.name || `${c.first_name || ''} ${c.last_name || ''}`.trim()}\n`;
          if (c.company) vCardContent += `ORG:${c.company}\n`;
          if (c.title) vCardContent += `TITLE:${c.title}\n`;
          if (c.email) vCardContent += `EMAIL:${c.email}\n`;
          if (c.phone) vCardContent += `TEL:${c.phone}\n`;
          if (c.birthday) vCardContent += `BDAY:${c.birthday.split('T')[0]}\n`;
          if (c.notes) vCardContent += `NOTE:${c.notes.replace(/\n/g, '\\n')}\n`;
          if (c.category) vCardContent += `CATEGORIES:${c.category}\n`;
          vCardContent += 'END:VCARD\n\n';
        });

        // Create download
        const blob = new Blob([vCardContent], { type: 'text/vcard' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `atlas_contacts_${new Date().toISOString().split('T')[0]}.vcf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast(`Exported ${contacts.length} contacts to vCard`, 'success');
      } catch (e) {
        showToast('Export failed: ' + e.message, 'error');
      }
    }

    // Contact actions
    function callContact() {
      if (currentContact?.phone) {
        window.location.href = `tel:${currentContact.phone}`;
      } else {
        showToast('No phone number available', 'error');
      }
    }

    function emailContact() {
      if (currentContact?.email) {
        window.location.href = `mailto:${currentContact.email}`;
      } else {
        showToast('No email available', 'error');
      }
    }

    function messageContact() {
      if (currentContact?.phone) {
        window.location.href = `sms:${currentContact.phone}`;
      } else {
        showToast('No phone number available', 'error');
      }
    }

    // Edit contact - open edit modal
    function editContact() {
      if (!currentContact) return;
      openEditModal(currentContact);
    }

    // Open edit modal
    function openEditModal(contact) {
      // Create edit modal if it doesn't exist
      let modal = document.getElementById('editModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'editModal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 85vh;">
            <div class="modal-header" style="padding-bottom: 10px;">
              <button class="modal-close" onclick="closeEditModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
              <div class="modal-name" style="font-size: 20px;">Edit Contact</div>
            </div>
            <div class="modal-body" style="padding: 16px;">
              <form id="editContactForm" onsubmit="saveContact(event)">
                <input type="hidden" id="editContactId">
                <div class="form-group">
                  <label>Name</label>
                  <input type="text" id="editName" class="form-input" required>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="editFirstName" class="form-input">
                  </div>
                  <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="editLastName" class="form-input">
                  </div>
                </div>
                <div class="form-group">
                  <label>Company</label>
                  <input type="text" id="editCompany" class="form-input">
                </div>
                <div class="form-group">
                  <label>Title</label>
                  <input type="text" id="editTitle" class="form-input">
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="editEmail" class="form-input">
                </div>
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" id="editPhone" class="form-input">
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Category</label>
                    <select id="editCategory" class="form-input" onchange="handleCategoryChange(this)">
                      <!-- Dynamically populated -->
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Priority</label>
                    <select id="editPriority" class="form-input">
                      <option value="Normal">Normal</option>
                      <option value="Low">Low</option>
                      <option value="Medium">Medium</option>
                      <option value="High">High</option>
                      <option value="VIP">VIP</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Birthday</label>
                    <input type="date" id="editBirthday" class="form-input">
                    <span class="date-helper" id="birthdayHelper"></span>
                  </div>
                  <div class="form-group">
                    <label>Anniversary</label>
                    <input type="date" id="editAnniversary" class="form-input">
                    <span class="date-helper" id="anniversaryHelper"></span>
                  </div>
                </div>
                <div class="form-group">
                  <label>Notes</label>
                  <textarea id="editNotes" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-actions">
                  <button type="button" class="btn-danger" onclick="deleteContact()">Delete</button>
                  <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                  <button type="submit" class="btn-primary">Save</button>
                </div>
              </form>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // Populate form
      document.getElementById('editContactId').value = contact.id;
      document.getElementById('editName').value = contact.name || contact.display_name || '';
      document.getElementById('editFirstName').value = contact.first_name || '';
      document.getElementById('editLastName').value = contact.last_name || '';
      document.getElementById('editCompany').value = contact.company || '';
      document.getElementById('editTitle').value = contact.title || contact.job_title || '';
      document.getElementById('editEmail').value = contact.email || '';
      document.getElementById('editPhone').value = contact.phone || '';
      // Populate category dropdown dynamically
      const categorySelect = document.getElementById('editCategory');
      const allCategories = [...INDUSTRY_CATEGORIES];
      categorySelect.innerHTML = allCategories.map(cat =>
        `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
      ).join('') + '<option value="__add_new__">+ Add New Category...</option>';
      categorySelect.value = contact.category || 'General';
      document.getElementById('editPriority').value = contact.priority || 'Normal';
      document.getElementById('editNotes').value = contact.notes || '';

      // Populate birthday and anniversary
      const birthdayInput = document.getElementById('editBirthday');
      const anniversaryInput = document.getElementById('editAnniversary');
      birthdayInput.value = contact.birthday ? contact.birthday.split('T')[0] : '';
      anniversaryInput.value = contact.anniversary ? contact.anniversary.split('T')[0] : '';

      // Update helper text
      updateDateHelper('birthday', birthdayInput.value);
      updateDateHelper('anniversary', anniversaryInput.value);

      // Add event listeners for date changes
      birthdayInput.onchange = () => updateDateHelper('birthday', birthdayInput.value);
      anniversaryInput.onchange = () => updateDateHelper('anniversary', anniversaryInput.value);

      modal.classList.add('visible');
      modal.onclick = (e) => { if (e.target === modal) closeEditModal(); };
    }

    // Close edit modal
    function closeEditModal() {
      const modal = document.getElementById('editModal');
      if (modal) modal.classList.remove('visible');
    }

    // Save contact
    async function saveContact(event) {
      event.preventDefault();

      const contactId = document.getElementById('editContactId').value;
      const birthdayVal = document.getElementById('editBirthday').value;
      const anniversaryVal = document.getElementById('editAnniversary').value;
      const data = {
        name: document.getElementById('editName').value,
        first_name: document.getElementById('editFirstName').value,
        last_name: document.getElementById('editLastName').value,
        company: document.getElementById('editCompany').value,
        title: document.getElementById('editTitle').value,
        email: document.getElementById('editEmail').value,
        phone: document.getElementById('editPhone').value,
        category: document.getElementById('editCategory').value,
        priority: document.getElementById('editPriority').value,
        notes: document.getElementById('editNotes').value,
        birthday: birthdayVal || null,
        anniversary: anniversaryVal || null
      };

      try {
        const response = await fetch(`/api/atlas/contacts/${contactId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.ok || response.ok) {
          showToast('Contact saved successfully', 'success');
          closeEditModal();
          closeModal();

          // Update local contact data
          const index = contacts.findIndex(c => c.id == contactId);
          if (index !== -1) {
            contacts[index] = { ...contacts[index], ...data };
            renderContacts();
          }
        } else {
          showToast(result.error || 'Failed to save contact', 'error');
        }
      } catch (error) {
        console.error('Error saving contact:', error);
        showToast('Failed to save contact', 'error');
      }
    }

    // Delete contact
    async function deleteContact() {
      const contactId = document.getElementById('editContactId')?.value || currentContact?.id;
      if (!contactId) return;

      const contactName = currentContact?.name || currentContact?.display_name || 'this contact';

      if (!confirm(`Are you sure you want to delete ${contactName}?`)) return;

      try {
        const response = await fetch(`/api/atlas/contacts/${contactId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.ok || response.ok) {
          showToast('Contact deleted', 'success');
          closeEditModal();
          closeModal();

          // Remove from local data
          contacts = contacts.filter(c => c.id != contactId);
          totalContactCount--;
          renderContacts();
          updateLoadedCount();
        } else {
          showToast(result.error || 'Failed to delete contact', 'error');
        }
      } catch (error) {
        console.error('Error deleting contact:', error);
        showToast('Failed to delete contact', 'error');
      }
    }

    // Add new contact
    function addContact() {
      openEditModal({
        id: 'new',
        name: '',
        first_name: '',
        last_name: '',
        company: '',
        title: '',
        email: '',
        phone: '',
        category: 'General',
        priority: 'Normal',
        notes: ''
      });
    }

    // Override save for new contacts
    const originalSaveContact = saveContact;
    saveContact = async function(event) {
      event.preventDefault();

      const contactId = document.getElementById('editContactId').value;

      if (contactId === 'new') {
        // Create new contact
        const data = {
          name: document.getElementById('editName').value,
          first_name: document.getElementById('editFirstName').value,
          last_name: document.getElementById('editLastName').value,
          company: document.getElementById('editCompany').value,
          title: document.getElementById('editTitle').value,
          email: document.getElementById('editEmail').value,
          phone: document.getElementById('editPhone').value,
          category: document.getElementById('editCategory').value,
          priority: document.getElementById('editPriority').value,
          notes: document.getElementById('editNotes').value
        };

        try {
          const response = await fetch('/api/atlas/contacts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (result.ok || result.id) {
            showToast('Contact created successfully', 'success');
            closeEditModal();
            loadContacts(); // Reload to get new contact
          } else {
            showToast(result.error || 'Failed to create contact', 'error');
          }
        } catch (error) {
          console.error('Error creating contact:', error);
          showToast('Failed to create contact', 'error');
        }
      } else {
        // Update existing contact - call original function logic
        const data = {
          name: document.getElementById('editName').value,
          first_name: document.getElementById('editFirstName').value,
          last_name: document.getElementById('editLastName').value,
          company: document.getElementById('editCompany').value,
          title: document.getElementById('editTitle').value,
          email: document.getElementById('editEmail').value,
          phone: document.getElementById('editPhone').value,
          category: document.getElementById('editCategory').value,
          priority: document.getElementById('editPriority').value,
          notes: document.getElementById('editNotes').value
        };

        try {
          const response = await fetch(`/api/atlas/contacts/${contactId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (result.ok || response.ok) {
            showToast('Contact saved successfully', 'success');
            closeEditModal();
            closeModal();

            const index = contacts.findIndex(c => c.id == contactId);
            if (index !== -1) {
              contacts[index] = { ...contacts[index], ...data };
              renderContacts();
            }
          } else {
            showToast(result.error || 'Failed to save contact', 'error');
          }
        } catch (error) {
          console.error('Error saving contact:', error);
          showToast('Failed to save contact', 'error');
        }
      }
    };

    // Empty state
    function showEmptyState() {
      const list = document.getElementById('contactList');
      document.getElementById('loadingState').style.display = 'none';

      list.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="8" r="4"/>
              <path d="M4 21v-2a4 4 0 014-4h8a4 4 0 014 4v2"/>
            </svg>
          </div>
          <div class="empty-title">No contacts yet</div>
          <div class="empty-text">Sync your contacts from Google or Apple to get started with relationship intelligence</div>
          <button class="empty-btn" onclick="toggleSyncPanel()">Sync Contacts</button>
        </div>
      `;
    }

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast visible ${type}`;
      setTimeout(() => toast.classList.remove('visible'), 3000);
    }

    // Helpers
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));

      if (diff === 0) return 'Today';
      if (diff === 1) return 'Yesterday';
      if (diff < 7) return `${diff} days ago`;
      if (diff < 30) return `${Math.floor(diff / 7)} weeks ago`;
      return date.toLocaleDateString();
    }

    function isRecent(dateStr) {
      if (!dateStr) return false;
      const date = new Date(dateStr);
      const now = new Date();
      const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      return diff <= 7;
    }

    function calculateDaysKnown(createdAt) {
      if (!createdAt) return 0;
      const date = new Date(createdAt);
      const now = new Date();
      return Math.floor((now - date) / (1000 * 60 * 60 * 24));
    }

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // ===========================================
    // AI FEATURES
    // ===========================================

    // Toggle AI Panel
    function toggleAIPanel() {
      const panel = document.getElementById('aiPanel');
      panel.classList.toggle('visible');
      // Close sync panel if open
      document.getElementById('syncPanel').classList.remove('visible');
    }

    // AI Categorize contacts
    async function aiCategorize() {
      const btn = document.getElementById('aiCategorizeBtn');
      btn.classList.add('loading');
      btn.querySelector('.ai-action-title').textContent = 'Analyzing...';

      try {
        const response = await fetch('/api/atlas/ai/organize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'categorize' })
        });

        const data = await response.json();

        if (data.ok) {
          showToast(`Categorized ${data.processed} contacts`, 'success');
          if (data.changes && data.changes.length > 0) {
            showAIResults('AI Categorization Results', data.changes.map(c => ({
              name: c.name,
              detail: `Category: ${c.new_category}, Priority: ${c.new_priority}`
            })));
          }
          loadContacts(); // Refresh to show new categories
        } else {
          showToast(data.error || 'Categorization failed', 'error');
        }
      } catch (e) {
        console.error('AI categorize error:', e);
        showToast('AI categorization failed', 'error');
      }

      btn.classList.remove('loading');
      btn.querySelector('.ai-action-title').textContent = 'Auto-Categorize';
    }

    // AI Smart Filters
    async function aiSmartFilters() {
      const btn = document.getElementById('aiFiltersBtn');
      btn.classList.add('loading');
      btn.querySelector('.ai-action-title').textContent = 'Generating...';

      try {
        const response = await fetch('/api/atlas/ai/smart-filters');
        const data = await response.json();

        if (data.ok && data.filters) {
          renderSmartFilters(data.filters);
          showToast(`Generated ${data.filters.length} smart filters`, 'success');
        } else {
          showToast(data.error || 'Failed to generate filters', 'error');
        }
      } catch (e) {
        console.error('AI filters error:', e);
        showToast('Failed to generate smart filters', 'error');
      }

      btn.classList.remove('loading');
      btn.querySelector('.ai-action-title').textContent = 'Smart Filters';
    }

    // Render smart filters
    function renderSmartFilters(filters) {
      const container = document.getElementById('smartFilters');
      if (!filters || filters.length === 0) {
        container.classList.remove('visible');
        return;
      }

      container.innerHTML = filters.slice(0, 12).map(f => `
        <div class="smart-filter" onclick="applySmartFilter('${f.id}', ${JSON.stringify(f.query).replace(/"/g, '&quot;')})">
          <span>${f.name}</span>
          <span class="count">${f.count}</span>
          <span class="smart-filter-type">${f.type}</span>
        </div>
      `).join('');

      container.classList.add('visible');
    }

    // Apply smart filter
    let activeSmartFilter = null;
    async function applySmartFilter(filterId, query) {
      // Toggle off if same filter
      if (activeSmartFilter === filterId) {
        activeSmartFilter = null;
        document.querySelectorAll('.smart-filter').forEach(el => el.classList.remove('active'));
        renderContacts();
        return;
      }

      activeSmartFilter = filterId;
      document.querySelectorAll('.smart-filter').forEach(el => {
        el.classList.toggle('active', el.onclick.toString().includes(filterId));
      });

      // Build search based on query
      let filtered = contacts;

      if (query.category) {
        filtered = filtered.filter(c => c.category === query.category);
      }
      if (query.company) {
        filtered = filtered.filter(c => c.company === query.company);
      }
      if (query.priority) {
        filtered = filtered.filter(c => c.priority === query.priority);
      }
      if (query.source) {
        filtered = filtered.filter(c => c.source === query.source);
      }
      if (query.email_domain) {
        filtered = filtered.filter(c => c.email && c.email.includes(`@${query.email_domain}`));
      }
      if (query.has_phone) {
        filtered = filtered.filter(c => c.phone && c.phone.trim() !== '');
      }
      if (query.missing_email) {
        filtered = filtered.filter(c => !c.email || c.email.trim() === '');
      }
      if (query.days) {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - query.days);
        filtered = filtered.filter(c => c.created_at && new Date(c.created_at) >= cutoff);
      }

      // Render filtered contacts
      renderFilteredContacts(filtered);
    }

    // Render filtered contacts (for smart filters)
    function renderFilteredContacts(filtered) {
      const list = document.getElementById('contactList');

      if (filtered.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-title">No contacts match this filter</div>
            <div class="empty-text">Try a different filter</div>
          </div>
        `;
        return;
      }

      const grouped = {};
      filtered.forEach(contact => {
        const letter = (contact.display_name || contact.name || 'Unknown')[0].toUpperCase();
        if (!grouped[letter]) grouped[letter] = [];
        grouped[letter].push(contact);
      });

      let html = `<div class="loaded-count">Showing ${filtered.length} contacts</div>`;
      Object.keys(grouped).sort().forEach(letter => {
        html += `<div class="section-header"><span class="section-title">${letter}</span></div>`;
        grouped[letter].forEach(contact => {
          html += renderContactCard(contact);
        });
      });

      list.innerHTML = html;
    }

    // AI Find Duplicates
    async function aiFindDuplicates() {
      const btn = document.getElementById('aiDedupeBtn');
      btn.classList.add('loading');
      btn.querySelector('.ai-action-title').textContent = 'Searching...';

      try {
        const response = await fetch('/api/atlas/ai/organize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'dedupe' })
        });

        const data = await response.json();

        if (data.ok) {
          if (data.changes && data.changes.length > 0) {
            showAIResults('Potential Duplicates Found', data.changes.map(d => ({
              name: `${d.contact1.name} & ${d.contact2.name}`,
              detail: `Emails: ${d.contact1.email || 'none'}, ${d.contact2.email || 'none'}`,
              ids: [d.contact1.id, d.contact2.id]
            })));
            showToast(`Found ${data.changes.length} potential duplicates`, 'success');
          } else {
            showToast('No duplicates found', 'success');
          }
        } else {
          showToast(data.error || 'Duplicate check failed', 'error');
        }
      } catch (e) {
        console.error('AI dedupe error:', e);
        showToast('Duplicate check failed', 'error');
      }

      btn.classList.remove('loading');
      btn.querySelector('.ai-action-title').textContent = 'Find Duplicates';
    }

    // AI Enrich - find incomplete contacts
    async function aiEnrich() {
      const btn = document.getElementById('aiEnrichBtn');
      btn.classList.add('loading');
      btn.querySelector('.ai-action-title').textContent = 'Scanning...';

      try {
        const response = await fetch('/api/atlas/ai/organize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'enrich' })
        });

        const data = await response.json();

        if (data.ok) {
          if (data.changes && data.changes.length > 0) {
            showAIResults('Incomplete Contacts', data.changes.map(c => ({
              name: c.name,
              detail: `Missing: ${c.missing_fields.join(', ')}`,
              id: c.id
            })));
            showToast(`Found ${data.changes.length} incomplete contacts`, 'success');
          } else {
            showToast('All contacts are complete', 'success');
          }
        } else {
          showToast(data.error || 'Enrichment check failed', 'error');
        }
      } catch (e) {
        console.error('AI enrich error:', e);
        showToast('Enrichment check failed', 'error');
      }

      btn.classList.remove('loading');
      btn.querySelector('.ai-action-title').textContent = 'Find Incomplete';
    }

    // AI Search
    async function aiSearch() {
      const query = document.getElementById('aiSearchInput').value.trim();
      if (!query) return;

      document.querySelector('.ai-search-btn').textContent = 'Searching...';

      try {
        const response = await fetch('/api/atlas/ai/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        const data = await response.json();

        if (data.ok && data.contacts) {
          if (data.contacts.length > 0) {
            showAIResults(`AI Search: "${query}"`, data.contacts.map(c => ({
              name: c.name,
              detail: [c.title, c.company].filter(Boolean).join(' at ') || c.email || '',
              id: c.id
            })));
            showToast(`Found ${data.contacts.length} contacts`, 'success');
          } else {
            showToast('No contacts found for that query', 'error');
          }
        } else {
          showToast(data.error || 'Search failed', 'error');
        }
      } catch (e) {
        console.error('AI search error:', e);
        showToast('AI search failed', 'error');
      }

      document.querySelector('.ai-search-btn').textContent = 'Search';
    }

    // Show AI Results
    function showAIResults(title, results) {
      document.getElementById('aiResultsTitle').textContent = title;

      const content = document.getElementById('aiResultsContent');
      content.innerHTML = results.slice(0, 20).map(r => `
        <div class="ai-result-item" ${r.id ? `onclick="openContact(${r.id})"` : ''} style="${r.id ? 'cursor:pointer' : ''}">
          <div class="ai-result-name">${r.name}</div>
          <div class="ai-result-detail">${r.detail}</div>
          ${r.tags ? `<div class="ai-result-tags">${r.tags.map(t => `<span class="ai-result-tag">${t}</span>`).join('')}</div>` : ''}
        </div>
      `).join('');

      if (results.length > 20) {
        content.innerHTML += `<div class="loaded-count">Showing 20 of ${results.length} results</div>`;
      }

      document.getElementById('aiResults').classList.add('visible');
    }

    // Close AI Results
    function closeAIResults() {
      document.getElementById('aiResults').classList.remove('visible');
      // Clear smart filter selection
      activeSmartFilter = null;
      document.querySelectorAll('.smart-filter').forEach(el => el.classList.remove('active'));
    }

    // =============================================================================
    // RELATIONSHIP TRACKING FUNCTIONS
    // =============================================================================

    // Update relationship health display in modal
    function updateRelationshipHealth(contact) {
      const score = contact.relationship_score || 0; // No fake scores - show actual data only
      const lastInteraction = contact.last_interaction ? new Date(contact.last_interaction) : null;
      const daysSinceContact = lastInteraction
        ? Math.floor((new Date() - lastInteraction) / (1000 * 60 * 60 * 24))
        : null;

      // Update health ring
      const circumference = 2 * Math.PI * 30;
      const offset = circumference - (score / 100) * circumference;
      const progressRing = document.getElementById('healthRingProgress');
      progressRing.style.strokeDashoffset = offset;

      // Set color based on score
      let color, status, statusClass;
      if (score >= 80) {
        color = '#22c55e'; status = 'Excellent'; statusClass = 'excellent';
      } else if (score >= 60) {
        color = '#84cc16'; status = 'Good'; statusClass = 'good';
      } else if (score >= 40) {
        color = '#eab308'; status = 'Fair'; statusClass = 'fair';
      } else if (score >= 20) {
        color = '#f97316'; status = 'Needs Attention'; statusClass = 'needs-attention';
      } else {
        color = '#ef4444'; status = 'At Risk'; statusClass = 'at-risk';
      }

      progressRing.style.stroke = color;
      document.getElementById('healthScoreText').textContent = score;
      document.getElementById('healthScoreText').style.color = color;

      const healthStatus = document.getElementById('healthStatus');
      healthStatus.textContent = status;
      healthStatus.className = 'health-status ' + statusClass;

      // Message based on score
      const messages = {
        excellent: 'Strong relationship with regular contact',
        good: 'Healthy relationship, keep it up!',
        fair: 'Consider reaching out more often',
        'needs-attention': 'This relationship needs nurturing',
        'at-risk': 'High priority - reconnect soon!'
      };
      document.getElementById('healthMessage').textContent = messages[statusClass];

      // Last contact
      if (daysSinceContact !== null) {
        let lastContactText;
        if (daysSinceContact === 0) lastContactText = 'Last contact: Today';
        else if (daysSinceContact === 1) lastContactText = 'Last contact: Yesterday';
        else if (daysSinceContact < 7) lastContactText = `Last contact: ${daysSinceContact} days ago`;
        else if (daysSinceContact < 30) lastContactText = `Last contact: ${Math.floor(daysSinceContact / 7)} weeks ago`;
        else lastContactText = `Last contact: ${Math.floor(daysSinceContact / 30)} months ago`;
        document.getElementById('healthLastContact').textContent = lastContactText;
      } else {
        document.getElementById('healthLastContact').textContent = 'No recorded interactions';
      }

      // Show nudge if needed
      const nudge = document.getElementById('relationshipNudge');
      if (daysSinceContact !== null && daysSinceContact > 14 && score < 70) {
        nudge.style.display = 'flex';
        if (daysSinceContact > 60) {
          document.getElementById('nudgeTitle').textContent = 'Time to reconnect!';
          document.getElementById('nudgeMessage').textContent = `It's been ${Math.floor(daysSinceContact / 30)} months since you connected`;
        } else if (daysSinceContact > 30) {
          document.getElementById('nudgeTitle').textContent = 'Stay in touch';
          document.getElementById('nudgeMessage').textContent = `It's been over a month since you talked`;
        } else {
          document.getElementById('nudgeTitle').textContent = 'Check in soon';
          document.getElementById('nudgeMessage').textContent = `It's been ${daysSinceContact} days since contact`;
        }
      } else {
        nudge.style.display = 'none';
      }
    }

    // Load relationship health from API
    async function loadRelationshipHealth(contactId) {
      try {
        const response = await fetch(`/api/atlas/relationship/${contactId}`);
        if (response.ok) {
          const data = await response.json();
          if (data.health) {
            // Map API fields to frontend - API returns overall_score, frontend expects relationship_score
            currentContact.relationship_score = data.health.overall_score || 0;
            currentContact.last_interaction = data.health.last_interaction;
            // Store additional health metrics
            currentContact.health_trend = data.health.trend;
            currentContact.recency_score = data.health.recency_score;
            currentContact.frequency_score = data.health.frequency_score;
            currentContact.insights = data.health.insights;
            updateRelationshipHealth(currentContact);
          }
        }
      } catch (e) {
        console.log('Could not load relationship health:', e);
      }
    }

    // Quick reach out from nudge
    function quickReachOut() {
      if (!currentContact) return;
      openInteractionModal();
    }

    // Log quick interaction (one-click)
    async function logQuickInteraction(type) {
      if (!currentContact) return;

      const btns = document.querySelectorAll('.interaction-type-btn');
      btns.forEach(btn => {
        if (btn.textContent.toLowerCase().includes(type)) {
          btn.classList.add('active');
          setTimeout(() => btn.classList.remove('active'), 500);
        }
      });

      try {
        const response = await fetch('/api/atlas/interactions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contact_id: currentContact.id,
            type: type,
            notes: `Quick ${type} logged`
          })
        });

        if (response.ok) {
          showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} logged!`, 'success');
          loadInteractionTimeline(currentContact.id);
          loadRelationshipHealth(currentContact.id);
          const countEl = document.getElementById('modalInteractions');
          countEl.textContent = parseInt(countEl.textContent) + 1;
        } else {
          showToast('Failed to log interaction', 'error');
        }
      } catch (e) {
        console.error('Error logging interaction:', e);
        showToast('Failed to log interaction', 'error');
      }
    }

    // Open interaction modal
    function openInteractionModal() {
      document.getElementById('interactionModal').classList.add('active');
      document.getElementById('interactionNotes').value = '';
      document.getElementById('selectedInteractionType').value = '';
      document.querySelectorAll('.interaction-type-option').forEach(opt => {
        opt.classList.remove('selected');
      });
    }

    // Close interaction modal
    function closeInteractionModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('interactionModal').classList.remove('active');
    }

    // Select interaction type
    function selectInteractionType(type) {
      document.getElementById('selectedInteractionType').value = type;
      document.querySelectorAll('.interaction-type-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.textContent.toLowerCase().includes(type)) {
          opt.classList.add('selected');
        }
      });
    }

    // Submit interaction
    async function submitInteraction(event) {
      event.preventDefault();

      const type = document.getElementById('selectedInteractionType').value;
      const notes = document.getElementById('interactionNotes').value;

      if (!type) {
        showToast('Please select an interaction type', 'error');
        return;
      }

      if (!currentContact) {
        showToast('No contact selected', 'error');
        return;
      }

      const submitBtn = document.querySelector('.interaction-submit-btn');
      submitBtn.textContent = 'Saving...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/atlas/interactions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contact_id: currentContact.id,
            type: type,
            notes: notes || `${type.charAt(0).toUpperCase() + type.slice(1)} interaction`
          })
        });

        if (response.ok) {
          showToast('Interaction logged!', 'success');
          closeInteractionModal();
          loadInteractionTimeline(currentContact.id);
          loadRelationshipHealth(currentContact.id);
          const countEl = document.getElementById('modalInteractions');
          countEl.textContent = parseInt(countEl.textContent) + 1;
        } else {
          const data = await response.json();
          showToast(data.error || 'Failed to log interaction', 'error');
        }
      } catch (e) {
        console.error('Error logging interaction:', e);
        showToast('Failed to log interaction', 'error');
      }

      submitBtn.textContent = 'Log Interaction';
      submitBtn.disabled = false;
    }

    // Load interaction timeline
    async function loadInteractionTimeline(contactId) {
      const timeline = document.getElementById('modalTimeline');

      try {
        const response = await fetch(`/api/atlas/contacts/${contactId}`);
        if (response.ok) {
          const data = await response.json();
          const interactions = data.interactions || [];

          if (interactions.length === 0) {
            timeline.innerHTML = '<div class="timeline-empty">No interactions recorded yet</div>';
            return;
          }

          timeline.innerHTML = interactions.slice(0, 5).map(interaction => {
            const date = new Date(interaction.interaction_date || interaction.created_at);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const type = interaction.interaction_type || interaction.type || 'note';

            return `
              <div class="timeline-item ${type}">
                <div class="timeline-date">${dateStr}</div>
                <div class="timeline-content">${interaction.notes || type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <div class="timeline-type">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
              </div>
            `;
          }).join('');
        }
      } catch (e) {
        console.log('Could not load timeline:', e);
        timeline.innerHTML = '<div class="timeline-empty">Could not load timeline</div>';
      }
    }

    // Override openContactModal to include relationship tracking
    const originalOpenContactModal = openContactModal;
    openContactModal = function(contact) {
      originalOpenContactModal(contact);
      if (contact.id) {
        updateRelationshipHealth(contact);
        loadRelationshipHealth(contact.id);
        loadInteractionTimeline(contact.id);
      }
    };

    // ============================================
    // BIRTHDAY & ANNIVERSARY HELPERS
    // ============================================

    function updateDateHelper(type, dateStr) {
      const helper = document.getElementById(`${type}Helper`);
      if (!helper) return;

      if (!dateStr) {
        helper.textContent = '';
        return;
      }

      const date = new Date(dateStr);
      const today = new Date();
      const thisYear = today.getFullYear();

      // Calculate age/years
      const birthYear = date.getFullYear();
      let age = thisYear - birthYear;

      // Check if birthday/anniversary has passed this year
      const thisYearDate = new Date(thisYear, date.getMonth(), date.getDate());
      if (thisYearDate > today) {
        age--; // Haven't reached it this year yet
      }

      // Days until next occurrence
      let nextDate = new Date(thisYear, date.getMonth(), date.getDate());
      if (nextDate < today) {
        nextDate = new Date(thisYear + 1, date.getMonth(), date.getDate());
      }
      const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));

      if (type === 'birthday') {
        if (daysUntil === 0) {
          helper.textContent = `${age} years old - Today!`;
          helper.style.color = '#22c55e';
        } else if (daysUntil <= 7) {
          helper.textContent = `Will be ${age + 1} - In ${daysUntil} days`;
          helper.style.color = '#f97316';
        } else if (daysUntil <= 30) {
          helper.textContent = `Will be ${age + 1} - In ${daysUntil} days`;
          helper.style.color = '#eab308';
        } else {
          helper.textContent = `${age} years old`;
          helper.style.color = 'var(--text-secondary)';
        }
      } else {
        // Anniversary
        if (daysUntil === 0) {
          helper.textContent = `${age} years together - Today!`;
          helper.style.color = '#22c55e';
        } else if (daysUntil <= 7) {
          helper.textContent = `${age + 1} years - In ${daysUntil} days`;
          helper.style.color = '#f97316';
        } else if (daysUntil <= 30) {
          helper.textContent = `${age + 1} years - In ${daysUntil} days`;
          helper.style.color = '#eab308';
        } else {
          helper.textContent = `${age} years together`;
          helper.style.color = 'var(--text-secondary)';
        }
      }
    }

    // Filter contacts by upcoming birthdays/anniversaries
    function getUpcomingEvents(eventType, daysAhead = 30) {
      const today = new Date();
      const results = [];

      for (const contact of contacts) {
        const dateField = eventType === 'birthday' ? contact.birthday : contact.anniversary;
        if (!dateField) continue;

        const date = new Date(dateField);
        const thisYear = today.getFullYear();

        // Get this year's occurrence
        let nextDate = new Date(thisYear, date.getMonth(), date.getDate());
        if (nextDate < today) {
          nextDate = new Date(thisYear + 1, date.getMonth(), date.getDate());
        }

        const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
        if (daysUntil <= daysAhead) {
          results.push({
            contact,
            daysUntil,
            nextDate,
            eventType
          });
        }
      }

      // Sort by days until event
      return results.sort((a, b) => a.daysUntil - b.daysUntil);
    }

    // ============================================
    // BATCH CONTACT CLEANUP TOOLS
    // ============================================
    let cleanupData = null;
    let cleanupSelectedIds = new Set();

    async function openCleanupModal() {
      // Create modal if it doesn't exist
      let modal = document.getElementById('cleanupModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'cleanupModal';
        modal.className = 'cleanup-modal-overlay';
        modal.innerHTML = `
          <div class="cleanup-modal">
            <div class="cleanup-header">
              <h2>Contact Cleanup</h2>
              <button class="cleanup-close" onclick="closeCleanupModal()">&times;</button>
            </div>
            <div class="cleanup-loading" id="cleanupLoading">
              <div class="spinner"></div>
              <p>Finding incomplete contacts...</p>
            </div>
            <div class="cleanup-content" id="cleanupContent" style="display:none;">
              <div class="cleanup-tabs" id="cleanupTabs"></div>
              <div class="cleanup-list" id="cleanupList"></div>
              <div class="cleanup-actions">
                <button class="cleanup-btn secondary" onclick="selectAllCleanup()">Select All</button>
                <button class="cleanup-btn secondary" onclick="deselectAllCleanup()">Deselect All</button>
                <button class="cleanup-btn danger" onclick="deleteSelectedContacts()" id="deleteSelectedBtn" disabled>
                  Delete Selected (<span id="selectedCount">0</span>)
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      modal.style.display = 'flex';
      document.getElementById('cleanupLoading').style.display = 'flex';
      document.getElementById('cleanupContent').style.display = 'none';

      // Fetch incomplete contacts
      try {
        const response = await fetch('/api/atlas/contacts/find-incomplete', { method: 'POST' });
        cleanupData = await response.json();

        if (cleanupData.ok) {
          renderCleanupTabs();
          showCleanupCategory('no_contact_info');
        } else {
          alert('Error loading contacts: ' + (cleanupData.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Cleanup error:', error);
        alert('Error loading incomplete contacts');
      }

      document.getElementById('cleanupLoading').style.display = 'none';
      document.getElementById('cleanupContent').style.display = 'flex';
    }

    function closeCleanupModal() {
      const modal = document.getElementById('cleanupModal');
      if (modal) modal.style.display = 'none';
      cleanupSelectedIds.clear();
    }

    function renderCleanupTabs() {
      const tabs = document.getElementById('cleanupTabs');
      const categories = [
        { id: 'no_contact_info', label: 'No Contact Info', icon: '!' },
        { id: 'phone_only', label: 'Phone Only', icon: 'p' },
        { id: 'name_only', label: 'Name Only', icon: 'n' },
        { id: 'uncategorized', label: 'Uncategorized', icon: 'u' }
      ];

      tabs.innerHTML = categories.map(cat => `
        <button class="cleanup-tab" data-category="${cat.id}" onclick="showCleanupCategory('${cat.id}')">
          ${cat.label}
          <span class="cleanup-count">${cleanupData.counts[cat.id] || 0}</span>
        </button>
      `).join('');
    }

    function showCleanupCategory(categoryId) {
      // Update active tab
      document.querySelectorAll('.cleanup-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.category === categoryId);
      });

      // Render contacts for this category
      const list = document.getElementById('cleanupList');
      const contacts = cleanupData.results[categoryId] || [];

      if (contacts.length === 0) {
        list.innerHTML = '<div class="cleanup-empty">No contacts in this category</div>';
        return;
      }

      list.innerHTML = contacts.map(contact => `
        <div class="cleanup-item" data-id="${contact.id}">
          <label class="cleanup-checkbox">
            <input type="checkbox" onchange="toggleCleanupSelection(${contact.id})"
                   ${cleanupSelectedIds.has(contact.id) ? 'checked' : ''}>
            <span class="checkmark"></span>
          </label>
          <div class="cleanup-info">
            <div class="cleanup-name">${escapeHtml(contact.name || 'No Name')}</div>
            <div class="cleanup-details">
              ${contact.phone ? '<span>p: ' + escapeHtml(contact.phone) + '</span>' : ''}
              ${contact.email ? '<span>e: ' + escapeHtml(contact.email) + '</span>' : ''}
              ${contact.company ? '<span>c: ' + escapeHtml(contact.company) + '</span>' : ''}
            </div>
          </div>
          <button class="cleanup-keep" onclick="keepContact(${contact.id})" title="Keep this contact">Keep</button>
        </div>
      `).join('');

      updateSelectedCount();
    }

    function toggleCleanupSelection(id) {
      if (cleanupSelectedIds.has(id)) {
        cleanupSelectedIds.delete(id);
      } else {
        cleanupSelectedIds.add(id);
      }
      updateSelectedCount();
    }

    function selectAllCleanup() {
      const activeTab = document.querySelector('.cleanup-tab.active');
      if (!activeTab) return;
      const categoryId = activeTab.dataset.category;
      const contacts = cleanupData.results[categoryId] || [];
      contacts.forEach(c => cleanupSelectedIds.add(c.id));
      showCleanupCategory(categoryId);
    }

    function deselectAllCleanup() {
      cleanupSelectedIds.clear();
      const activeTab = document.querySelector('.cleanup-tab.active');
      if (activeTab) showCleanupCategory(activeTab.dataset.category);
    }

    function updateSelectedCount() {
      const count = cleanupSelectedIds.size;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('deleteSelectedBtn').disabled = count === 0;
    }

    function keepContact(id) {
      cleanupSelectedIds.delete(id);
      const item = document.querySelector(`.cleanup-item[data-id="${id}"]`);
      if (item) item.remove();
      updateSelectedCount();
    }

    async function deleteSelectedContacts() {
      if (cleanupSelectedIds.size === 0) return;

      const count = cleanupSelectedIds.size;
      if (!confirm(`Are you sure you want to permanently delete ${count} contact(s)? This cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch('/api/atlas/contacts/bulk-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(cleanupSelectedIds) })
        });

        const result = await response.json();
        if (result.ok) {
          alert(`Successfully deleted ${result.deleted_count} contacts`);
          cleanupSelectedIds.clear();
          // Refresh the cleanup data
          closeCleanupModal();
          loadContacts();  // Refresh main contact list
        } else {
          alert('Error deleting contacts: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Error deleting contacts');
      }
    }
  </script>
</body>
</html>
