<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="Tallyups Reports Dashboard - Track and manage your expense reports">
<meta name="theme-color" content="#0a0f14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Reports - Tallyups</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="/static/css/design-system.css">
<link rel="stylesheet" href="/static/tallyups-design.css">
<style>
/* ============================================
   WORLD-CLASS REPORTS DASHBOARD
   Inspired by Ramp, Brex, Expensify
   ============================================ */

:root {
  --brand: #00ff88;
  --brand-dim: rgba(0,255,136,0.15);
  --bg: #0a0f14;
  --bg-card: #12181f;
  --bg-elevated: #1a2028;
  --bg-hover: rgba(255,255,255,0.05);
  --border: rgba(255,255,255,0.08);
  --border-light: rgba(255,255,255,0.12);
  --text: #ffffff;
  --text-secondary: #8b95a5;
  --text-muted: #5a6270;
  --error: #ff5c5c;
  --warning: #ffd85e;
  --info: #6eb5ff;
  --success: #00ff88;
}

* { box-sizing: border-box; }

body {
  background: var(--bg);
  min-height: 100vh;
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  margin: 0;
  padding: 0;
  padding-top: calc(var(--header-height, 64px) + env(safe-area-inset-top, 0px));
  padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px));
}

.reports-container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 24px;
  padding-bottom: 120px;
}

/* ============================================
   PAGE HEADER WITH ACTIONS
   ============================================ */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 32px;
  flex-wrap: wrap;
  gap: 20px;
}

.page-title-section h1 {
  font-size: 32px;
  font-weight: 800;
  margin: 0 0 8px 0;
  background: linear-gradient(135deg, #fff, #ccc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.page-subtitle {
  color: var(--text-secondary);
  font-size: 14px;
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.btn-primary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--brand), #00cc6a);
  color: #000;
  border: none;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 16px rgba(0,255,136,0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(0,255,136,0.4);
}

.btn-secondary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: var(--bg-card);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-secondary:hover {
  background: var(--bg-elevated);
  border-color: var(--border-light);
}

.btn-icon {
  width: 44px;
  height: 44px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-icon:hover {
  background: var(--bg-elevated);
  color: var(--text);
  border-color: var(--border-light);
}

/* ============================================
   QUICK ACTIONS BAR
   ============================================ */
.quick-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 32px;
  flex-wrap: wrap;
}

.quick-action-card {
  flex: 1;
  min-width: 200px;
  max-width: 280px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.quick-action-card:hover {
  border-color: var(--brand);
  transform: translateY(-2px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.quick-action-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--brand), transparent);
  opacity: 0;
  transition: opacity 0.2s;
}

.quick-action-card:hover::before {
  opacity: 1;
}

.quick-action-icon {
  width: 48px;
  height: 48px;
  background: var(--brand-dim);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 16px;
  font-size: 24px;
}

.quick-action-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 4px;
}

.quick-action-desc {
  font-size: 13px;
  color: var(--text-secondary);
}

/* ============================================
   STATS GRID - 4 KPI CARDS
   ============================================ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 32px;
}

@media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } }

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  position: relative;
  overflow: hidden;
}

.stat-card.highlight {
  background: linear-gradient(135deg, rgba(0,255,136,0.1), var(--bg-card));
  border-color: rgba(0,255,136,0.3);
}

.stat-card.highlight::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--brand), #00cc6a);
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.stat-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-icon {
  width: 36px;
  height: 36px;
  background: var(--bg-elevated);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
}

.stat-value {
  font-size: 36px;
  font-weight: 800;
  margin-bottom: 8px;
  font-family: 'SF Mono', Monaco, Consolas, monospace;
}

.stat-card.highlight .stat-value {
  background: linear-gradient(135deg, var(--brand), #00cc6a);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.stat-footer {
  display: flex;
  align-items: center;
  gap: 8px;
}

.stat-change {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
}

.stat-change.up { background: rgba(0,255,136,0.15); color: var(--brand); }
.stat-change.down { background: rgba(255,92,92,0.15); color: var(--error); }
.stat-change.neutral { background: var(--bg-elevated); color: var(--text-secondary); }

.stat-period {
  font-size: 12px;
  color: var(--text-muted);
}

/* ============================================
   CHARTS SECTION - 2 COLUMN
   ============================================ */
.charts-row {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 24px;
  margin-bottom: 32px;
}

@media (max-width: 1024px) { .charts-row { grid-template-columns: 1fr; } }

.chart-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.chart-title {
  font-size: 18px;
  font-weight: 700;
}

.chart-controls {
  display: flex;
  gap: 8px;
}

.chart-toggle {
  display: flex;
  background: var(--bg);
  border-radius: 10px;
  padding: 4px;
}

.chart-toggle-btn {
  padding: 8px 14px;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.chart-toggle-btn:hover { color: var(--text); }
.chart-toggle-btn.active { background: var(--bg-card); color: var(--brand); }

.chart-container {
  position: relative;
  height: 280px;
}

/* ============================================
   BUSINESS BREAKDOWN CARDS
   ============================================ */
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.section-title {
  font-size: 20px;
  font-weight: 700;
}

.section-link {
  color: var(--brand);
  font-size: 14px;
  font-weight: 600;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 4px;
}

.section-link:hover { text-decoration: underline; }

.business-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.business-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.business-card:hover {
  border-color: var(--brand);
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.3);
}

.business-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.business-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.business-logo {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 700;
}

.business-logo.dh { background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000; }
.business-logo.mcr { background: linear-gradient(135deg, #ffd85e, #ffb800); color: #000; }
.business-logo.personal { background: linear-gradient(135deg, #6eb5ff, #4a9eff); color: #000; }
.business-logo.other { background: var(--bg-elevated); color: var(--text-secondary); }

.business-name {
  font-size: 16px;
  font-weight: 700;
}

.business-type {
  font-size: 12px;
  color: var(--text-secondary);
}

.business-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
}

.business-badge.dh { background: rgba(0,255,136,0.15); color: #00ff88; }
.business-badge.mcr { background: rgba(255,216,94,0.15); color: #ffd85e; }
.business-badge.personal { background: rgba(110,181,255,0.15); color: #6eb5ff; }

.business-amount {
  font-size: 32px;
  font-weight: 800;
  margin-bottom: 8px;
  font-family: 'SF Mono', Monaco, monospace;
}

.business-stats {
  display: flex;
  gap: 24px;
}

.business-stat {
  display: flex;
  flex-direction: column;
}

.business-stat-value {
  font-size: 16px;
  font-weight: 700;
}

.business-stat-label {
  font-size: 12px;
  color: var(--text-muted);
}

.business-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--brand), #00cc6a);
  border-radius: 0 4px 0 0;
  transition: width 0.6s ease;
}

/* ============================================
   REPORTS TABLE - ENHANCED
   ============================================ */
.reports-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  overflow: hidden;
  margin-bottom: 32px;
}

.reports-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-elevated);
}

.reports-title {
  font-size: 18px;
  font-weight: 700;
}

.reports-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg);
  border-radius: 10px;
  padding: 4px;
}

.reports-tab {
  padding: 10px 18px;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.reports-tab:hover { color: var(--text); }

.reports-tab.active {
  background: var(--bg-card);
  color: var(--brand);
}

.reports-tab .count {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  background: var(--bg-elevated);
  border-radius: 10px;
  font-size: 11px;
  margin-left: 6px;
  padding: 0 6px;
}

.reports-tab.active .count {
  background: var(--brand-dim);
  color: var(--brand);
}

.reports-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  gap: 16px;
  flex-wrap: wrap;
}

.search-box {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 16px;
  flex: 1;
  max-width: 400px;
  transition: border-color 0.2s;
}

.search-box:focus-within { border-color: var(--brand); }

.search-box input {
  background: transparent;
  border: none;
  color: var(--text);
  font-size: 14px;
  width: 100%;
  outline: none;
}

.search-box input::placeholder { color: var(--text-muted); }

.toolbar-actions {
  display: flex;
  gap: 10px;
}

.toolbar-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.toolbar-btn:hover {
  background: var(--bg-hover);
  color: var(--text);
  border-color: var(--border-light);
}

.toolbar-btn svg { width: 16px; height: 16px; }

/* Reports Table */
.reports-table-container {
  overflow-x: auto;
}

.reports-table {
  width: 100%;
  border-collapse: collapse;
}

.reports-table th {
  text-align: left;
  padding: 14px 24px;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  white-space: nowrap;
}

.reports-table th.sortable {
  cursor: pointer;
  user-select: none;
}

.reports-table th.sortable:hover { color: var(--text-secondary); }

.reports-table td {
  padding: 18px 24px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}

.reports-table tbody tr {
  cursor: pointer;
  transition: background 0.15s;
}

.reports-table tbody tr:hover { background: var(--bg-hover); }

.report-name-cell {
  display: flex;
  align-items: center;
  gap: 14px;
}

.report-icon {
  width: 40px;
  height: 40px;
  background: var(--brand-dim);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--brand);
  flex-shrink: 0;
}

.report-name {
  font-weight: 700;
  color: var(--text);
  margin-bottom: 2px;
}

.report-meta {
  font-size: 12px;
  color: var(--text-muted);
}

.report-amount {
  font-family: 'SF Mono', Monaco, monospace;
  font-weight: 700;
  font-size: 15px;
}

.report-amount.positive { color: var(--brand); }

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
}

.status-badge.draft { background: rgba(255,216,94,0.15); color: #ffd85e; }
.status-badge.submitted { background: rgba(0,255,136,0.15); color: #00ff88; }
.status-badge.approved { background: rgba(110,181,255,0.15); color: #6eb5ff; }
.status-badge.pending { background: rgba(255,165,0,0.15); color: #ffa500; }

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
}

.report-actions {
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.15s;
}

.reports-table tbody tr:hover .report-actions { opacity: 1; }

.action-btn {
  width: 34px;
  height: 34px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: 1px solid transparent;
  border-radius: 8px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}

.action-btn:hover {
  background: var(--bg-elevated);
  border-color: var(--border);
  color: var(--text);
}

.action-btn.danger:hover { color: var(--error); }

/* ============================================
   EXPORT SETTINGS PANEL
   ============================================ */
.export-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  overflow: hidden;
  margin-bottom: 32px;
}

.export-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-elevated);
}

.export-title {
  font-size: 18px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

.export-title-icon {
  width: 36px;
  height: 36px;
  background: var(--brand-dim);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--brand);
}

.export-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1px;
  background: var(--border);
}

.export-option {
  background: var(--bg-card);
  padding: 24px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.export-option:hover {
  background: var(--bg-elevated);
}

.export-option.selected {
  background: var(--brand-dim);
}

.export-option.selected::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  width: 3px;
  background: var(--brand);
}

.export-option-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.export-format {
  display: flex;
  align-items: center;
  gap: 12px;
}

.export-format-icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
}

.export-format-icon.csv { background: rgba(0,255,136,0.15); color: #00ff88; }
.export-format-icon.excel { background: rgba(33,150,83,0.15); color: #21964d; }
.export-format-icon.pdf { background: rgba(255,92,92,0.15); color: #ff5c5c; }
.export-format-icon.zip { background: rgba(255,216,94,0.15); color: #ffd85e; }
.export-format-icon.qbo { background: rgba(110,181,255,0.15); color: #6eb5ff; }
.export-format-icon.api { background: rgba(180,100,255,0.15); color: #b464ff; }

.export-format-name {
  font-size: 16px;
  font-weight: 700;
}

.export-format-type {
  font-size: 12px;
  color: var(--text-muted);
}

.export-check {
  width: 24px;
  height: 24px;
  border: 2px solid var(--border);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.export-option.selected .export-check {
  background: var(--brand);
  border-color: var(--brand);
  color: #000;
}

.export-desc {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
  margin-bottom: 16px;
}

.export-features {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.export-feature {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: var(--bg);
  border-radius: 6px;
  font-size: 11px;
  color: var(--text-secondary);
}

.export-feature svg {
  width: 12px;
  height: 12px;
  color: var(--brand);
}

/* Export Actions */
.export-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-top: 1px solid var(--border);
  background: var(--bg);
}

.export-settings-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.export-settings-btn:hover {
  background: var(--bg-card);
  color: var(--text);
}

.export-main-actions {
  display: flex;
  gap: 12px;
}

/* ============================================
   TEMPLATES SECTION
   ============================================ */
.templates-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.template-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.template-card:hover {
  border-color: var(--brand);
  transform: translateY(-2px);
}

.template-card.featured {
  border-color: var(--brand);
}

.template-card.featured::before {
  content: 'RECOMMENDED';
  position: absolute;
  top: 12px;
  right: 12px;
  padding: 4px 10px;
  background: var(--brand);
  color: #000;
  font-size: 9px;
  font-weight: 800;
  border-radius: 4px;
  letter-spacing: 0.5px;
}

.template-icon {
  width: 52px;
  height: 52px;
  background: var(--brand-dim);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  margin-bottom: 16px;
}

.template-name {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}

.template-desc {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
  margin-bottom: 16px;
}

.template-meta {
  display: flex;
  gap: 16px;
}

.template-meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-muted);
}

/* ============================================
   SCHEDULED REPORTS
   ============================================ */
.schedule-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.schedule-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

.schedule-icon {
  width: 48px;
  height: 48px;
  background: var(--bg-elevated);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.schedule-details h4 {
  font-size: 16px;
  font-weight: 700;
  margin: 0 0 4px 0;
}

.schedule-details p {
  font-size: 13px;
  color: var(--text-secondary);
  margin: 0;
}

.schedule-toggle {
  display: flex;
  align-items: center;
  gap: 12px;
}

.toggle-switch {
  position: relative;
  width: 52px;
  height: 28px;
  background: var(--bg-elevated);
  border-radius: 14px;
  cursor: pointer;
  transition: all 0.3s;
}

.toggle-switch.active {
  background: var(--brand);
}

.toggle-switch::before {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 22px;
  height: 22px;
  background: #fff;
  border-radius: 50%;
  transition: all 0.3s;
}

.toggle-switch.active::before {
  left: 27px;
}

/* ============================================
   INTEGRATIONS
   ============================================ */
.integrations-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}

.integration-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.integration-card:hover {
  border-color: var(--border-light);
  transform: translateY(-2px);
}

.integration-card.connected {
  border-color: var(--brand);
}

.integration-logo {
  width: 56px;
  height: 56px;
  margin: 0 auto 16px;
  background: var(--bg-elevated);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}

.integration-name {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 4px;
}

.integration-status {
  font-size: 12px;
  color: var(--text-muted);
}

.integration-status.connected {
  color: var(--brand);
}

/* ============================================
   MODALS
   ============================================ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
  padding: 20px;
}

.modal-overlay.visible {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 24px;
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow: hidden;
  transform: scale(0.95) translateY(20px);
  transition: transform 0.3s;
}

.modal-overlay.visible .modal {
  transform: scale(1) translateY(0);
}

.modal.large { max-width: 900px; }

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px;
  border-bottom: 1px solid var(--border);
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
}

.modal-close {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 10px;
  transition: all 0.2s;
}

.modal-close:hover {
  background: var(--bg-hover);
  color: var(--text);
}

.modal-body {
  padding: 24px;
  max-height: 60vh;
  overflow-y: auto;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 20px 24px;
  border-top: 1px solid var(--border);
  background: var(--bg);
}

/* Form Elements */
.form-group {
  margin-bottom: 24px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 10px;
}

.form-label-desc {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 400;
  margin-left: 8px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 14px 18px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  font-size: 14px;
  transition: all 0.2s;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 3px var(--brand-dim);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.form-checkbox {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
}

.form-checkbox input {
  width: 20px;
  height: 20px;
  accent-color: var(--brand);
}

.form-checkbox span {
  font-size: 14px;
  color: var(--text-secondary);
}

/* ============================================
   EMPTY & LOADING STATES
   ============================================ */
.empty-state {
  padding: 80px 24px;
  text-align: center;
}

.empty-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 24px;
  background: var(--bg-elevated);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
}

.empty-title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 12px;
}

.empty-text {
  color: var(--text-secondary);
  font-size: 15px;
  margin-bottom: 32px;
  max-width: 400px;
  margin-left: auto;
  margin-right: auto;
  line-height: 1.6;
}

.loading-spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 60px;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
  .reports-container { padding: 16px; }
  .page-title-section h1 { font-size: 24px; }
  .stat-value { font-size: 28px; }
  .quick-actions { flex-direction: column; }
  .quick-action-card { max-width: none; }
  .form-row { grid-template-columns: 1fr; }
  .charts-row { gap: 16px; }
  .chart-container { height: 220px; }
  .modal { max-height: 100vh; border-radius: 20px 20px 0 0; }
}

/* App shell spacing */
body { padding-bottom: 80px; }
</style>
<!-- Design System & App Shell -->
<link rel="stylesheet" href="/static/css/design-system.css">
<script src="/static/js/app-shell.js" defer></script>
<script src="/static/js/design-system.js"></script>
</head>
<body>
  <!-- Site Header -->
  <header class="site-header">
    <div class="site-header-content">
      <div class="site-brand">
        <h1>ðŸ§¾ Tallyups</h1>
        <span class="version">v2.0</span>
      </div>
      <nav class="header-nav">
        <a href="/" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Home
        </a>
        <a href="/viewer" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          Reconcile
        </a>
        <a href="/reports" class="nav-link-btn active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Reports
        </a>
        <a href="/scanner" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
          Scan
        </a>
        <a href="/incoming" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
          Inbox
        </a>
        <a href="/gmail" class="nav-link-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Gmail
        </a>
      </nav>
    </div>
  </header>

  <main class="reports-container">
    <!-- Page Header -->
    <div class="page-header">
      <div class="page-title-section">
        <h1>Expense Reports</h1>
        <p class="page-subtitle">Create, manage, and export your expense reports</p>
      </div>
      <div class="header-actions">
        <button class="btn-icon" onclick="showSettingsModal()" title="Settings">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
        <button class="btn-secondary" onclick="showScheduleModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Schedule
        </button>
        <button class="btn-primary" onclick="showNewReportModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Report
        </button>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <div class="quick-action-card" onclick="createQuickReport('month')">
        <div class="quick-action-icon">ðŸ“…</div>
        <div class="quick-action-title">This Month</div>
        <div class="quick-action-desc">Generate report for current month</div>
      </div>
      <div class="quick-action-card" onclick="createQuickReport('quarter')">
        <div class="quick-action-icon">ðŸ“Š</div>
        <div class="quick-action-title">Q4 2025</div>
        <div class="quick-action-desc">Quarterly expense summary</div>
      </div>
      <div class="quick-action-card" onclick="showTemplatesModal()">
        <div class="quick-action-icon">ðŸ“‹</div>
        <div class="quick-action-title">Templates</div>
        <div class="quick-action-desc">Use a pre-built report template</div>
      </div>
      <div class="quick-action-card" onclick="showExportModal()">
        <div class="quick-action-icon">ðŸ“¤</div>
        <div class="quick-action-title">Bulk Export</div>
        <div class="quick-action-desc">Export multiple reports at once</div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card highlight">
        <div class="stat-header">
          <span class="stat-label">Total Expenses</span>
          <div class="stat-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          </div>
        </div>
        <div class="stat-value" id="stat-total-amount">$0</div>
        <div class="stat-footer">
          <span class="stat-change up" id="stat-change">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
            +12%
          </span>
          <span class="stat-period">vs last month</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Reports Created</span>
          <div class="stat-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          </div>
        </div>
        <div class="stat-value" id="stat-report-count">0</div>
        <div class="stat-footer">
          <span class="stat-change neutral" id="stat-reports-month">0 this month</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Receipt Coverage</span>
          <div class="stat-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          </div>
        </div>
        <div class="stat-value" id="stat-coverage">0%</div>
        <div class="stat-footer">
          <span class="stat-change neutral" id="stat-missing">0 missing receipts</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Pending Review</span>
          <div class="stat-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          </div>
        </div>
        <div class="stat-value" id="stat-pending">0</div>
        <div class="stat-footer">
          <span class="stat-change neutral">Needs attention</span>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Spending Trend</div>
          <div class="chart-controls">
            <div class="chart-toggle">
              <button class="chart-toggle-btn active" data-view="amount">Amount</button>
              <button class="chart-toggle-btn" data-view="count">Count</button>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="spending-chart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">By Category</div>
        </div>
        <div class="chart-container">
          <canvas id="category-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Business Breakdown -->
    <div class="section-header">
      <div class="section-title">By Business Entity</div>
      <a href="/viewer" class="section-link">
        View All Transactions
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </a>
    </div>
    <div class="business-grid" id="business-grid">
      <!-- Populated by JS -->
    </div>

    <!-- Export Settings Panel -->
    <div class="export-panel">
      <div class="export-header">
        <div class="export-title">
          <div class="export-title-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          </div>
          Export Options
        </div>
        <button class="btn-secondary" onclick="showExportSettingsModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings
        </button>
      </div>
      <div class="export-grid">
        <div class="export-option selected" data-format="downhome" onclick="selectExportFormat('downhome')">
          <div class="export-option-header">
            <div class="export-format">
              <div class="export-format-icon" style="background: linear-gradient(135deg, #00ff88, #00cc6a); color: #000;">DH</div>
              <div>
                <div class="export-format-name">Down Home Format</div>
                <div class="export-format-type">Accounting ready</div>
              </div>
            </div>
            <div class="export-check">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>
          <div class="export-desc">CSV format ready for Down Home Media accounting with receipt URLs</div>
          <div class="export-features">
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Receipt URLs</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Categories</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Memo</span>
          </div>
        </div>
        <div class="export-option" data-format="csv" onclick="selectExportFormat('csv')">
          <div class="export-option-header">
            <div class="export-format">
              <div class="export-format-icon csv">CSV</div>
              <div>
                <div class="export-format-name">CSV Spreadsheet</div>
                <div class="export-format-type">Universal format</div>
              </div>
            </div>
            <div class="export-check">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>
          <div class="export-desc">Export to CSV for Excel, Google Sheets, or any spreadsheet software</div>
          <div class="export-features">
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> All fields</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> UTF-8</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Instant</span>
          </div>
        </div>
        <div class="export-option" data-format="excel" onclick="selectExportFormat('excel')">
          <div class="export-option-header">
            <div class="export-format">
              <div class="export-format-icon excel">XLS</div>
              <div>
                <div class="export-format-name">Excel Workbook</div>
                <div class="export-format-type">Microsoft Excel</div>
              </div>
            </div>
            <div class="export-check">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>
          <div class="export-desc">Formatted Excel file with multiple sheets, charts, and summaries</div>
          <div class="export-features">
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Formatted</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Charts</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Multi-sheet</span>
          </div>
        </div>
        <div class="export-option" data-format="pdf" onclick="selectExportFormat('pdf')">
          <div class="export-option-header">
            <div class="export-format">
              <div class="export-format-icon pdf">PDF</div>
              <div>
                <div class="export-format-name">PDF Report</div>
                <div class="export-format-type">Print-ready document</div>
              </div>
            </div>
            <div class="export-check">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>
          <div class="export-desc">Professional PDF with your company branding and receipt images</div>
          <div class="export-features">
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Branded</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Receipts</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Print</span>
          </div>
        </div>
        <div class="export-option" data-format="zip" onclick="selectExportFormat('zip')">
          <div class="export-option-header">
            <div class="export-format">
              <div class="export-format-icon zip">ZIP</div>
              <div>
                <div class="export-format-name">Full Archive</div>
                <div class="export-format-type">Complete package</div>
              </div>
            </div>
            <div class="export-check">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>
          <div class="export-desc">ZIP archive with CSV, PDF summary, and all receipt images</div>
          <div class="export-features">
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Everything</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Images</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Backup</span>
          </div>
        </div>
        <div class="export-option" data-format="qbo" onclick="selectExportFormat('qbo')">
          <div class="export-option-header">
            <div class="export-format">
              <div class="export-format-icon qbo">QBO</div>
              <div>
                <div class="export-format-name">QuickBooks</div>
                <div class="export-format-type">Direct import</div>
              </div>
            </div>
            <div class="export-check">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>
          <div class="export-desc">QBO format for direct import into QuickBooks Online or Desktop</div>
          <div class="export-features">
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> QBO format</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Categories</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Vendors</span>
          </div>
        </div>
        <div class="export-option" data-format="api" onclick="selectExportFormat('api')">
          <div class="export-option-header">
            <div class="export-format">
              <div class="export-format-icon api">API</div>
              <div>
                <div class="export-format-name">API / Webhook</div>
                <div class="export-format-type">Automation</div>
              </div>
            </div>
            <div class="export-check">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>
          <div class="export-desc">Send to your accounting system via API or webhook integration</div>
          <div class="export-features">
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> JSON</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Webhook</span>
            <span class="export-feature"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Real-time</span>
          </div>
        </div>
      </div>
      <div class="export-actions">
        <button class="export-settings-btn" onclick="showExportSettingsModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          Customize columns & formatting
        </button>
        <div class="export-main-actions">
          <button class="btn-secondary" onclick="previewExport()">Preview</button>
          <button class="btn-primary" onclick="runExport()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export Now
          </button>
        </div>
      </div>
    </div>

    <!-- Reports List -->
    <div class="reports-section">
      <div class="reports-header">
        <div class="reports-title">All Reports</div>
        <div class="reports-tabs">
          <button class="reports-tab active" data-tab="all">All <span class="count" id="tab-all-count">0</span></button>
          <button class="reports-tab" data-tab="draft">Drafts <span class="count" id="tab-draft-count">0</span></button>
          <button class="reports-tab" data-tab="submitted">Submitted <span class="count" id="tab-submitted-count">0</span></button>
          <button class="reports-tab" data-tab="approved">Approved <span class="count" id="tab-approved-count">0</span></button>
        </div>
      </div>
      <div class="reports-toolbar">
        <div class="search-box">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input type="text" placeholder="Search reports by name, date, or amount..." id="search-input" oninput="filterReports()">
        </div>
        <div class="toolbar-actions">
          <button class="toolbar-btn" onclick="showFilterModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            Filter
          </button>
          <button class="toolbar-btn" onclick="toggleSort()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="14" y2="12"/><line x1="4" y1="18" x2="10" y2="18"/></svg>
            Sort
          </button>
          <button class="toolbar-btn" onclick="bulkExport()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export Selected
          </button>
        </div>
      </div>
      <div class="reports-table-container">
        <div id="reports-list-container">
          <div class="loading-spinner">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Integrations -->
    <div class="section-header">
      <div class="section-title">Integrations</div>
      <a href="#" class="section-link" onclick="showIntegrationsModal(); return false;">
        Manage All
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </a>
    </div>
    <div class="integrations-grid">
      <div class="integration-card connected" onclick="manageIntegration('quickbooks')">
        <div class="integration-logo">ðŸ“—</div>
        <div class="integration-name">QuickBooks</div>
        <div class="integration-status connected">Connected</div>
      </div>
      <div class="integration-card" onclick="manageIntegration('xero')">
        <div class="integration-logo">ðŸ“˜</div>
        <div class="integration-name">Xero</div>
        <div class="integration-status">Connect</div>
      </div>
      <div class="integration-card" onclick="manageIntegration('freshbooks')">
        <div class="integration-logo">ðŸ“™</div>
        <div class="integration-name">FreshBooks</div>
        <div class="integration-status">Connect</div>
      </div>
      <div class="integration-card connected" onclick="manageIntegration('google')">
        <div class="integration-logo">ðŸ“Š</div>
        <div class="integration-name">Google Sheets</div>
        <div class="integration-status connected">Connected</div>
      </div>
      <div class="integration-card" onclick="manageIntegration('slack')">
        <div class="integration-logo">ðŸ’¬</div>
        <div class="integration-name">Slack</div>
        <div class="integration-status">Connect</div>
      </div>
      <div class="integration-card" onclick="manageIntegration('zapier')">
        <div class="integration-logo">âš¡</div>
        <div class="integration-name">Zapier</div>
        <div class="integration-status">Connect</div>
      </div>
    </div>
  </main>

  <!-- New Report Modal -->
  <div class="modal-overlay" id="new-report-modal">
    <div class="modal large">
      <div class="modal-header">
        <div class="modal-title">Create New Report</div>
        <button class="modal-close" onclick="hideNewReportModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Report Name</label>
          <input type="text" class="form-input" id="report-name" placeholder="e.g., December 2024 Business Expenses">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Business Entity</label>
            <select class="form-select" id="report-business">
              <option value="all">All Entities</option>
              <option value="Down Home">Down Home Media</option>
              <option value="Music City Rodeo">Music City Rodeo</option>
              <option value="Personal">Personal</option>
              <option value="EM.co">EM.co</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Template</label>
            <select class="form-select" id="report-template">
              <option value="">No Template</option>
              <option value="monthly">Monthly Expense Report</option>
              <option value="quarterly">Quarterly Summary</option>
              <option value="tax">Tax Preparation</option>
              <option value="reimbursement">Reimbursement Request</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Date From</label>
            <input type="date" class="form-input" id="report-date-from">
          </div>
          <div class="form-group">
            <label class="form-label">Date To</label>
            <input type="date" class="form-input" id="report-date-to">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Categories <span class="form-label-desc">(optional)</span></label>
          <select class="form-select" id="report-categories" multiple>
            <option value="Software">Software & Subscriptions</option>
            <option value="Travel">Travel</option>
            <option value="Meals">Meals & Entertainment</option>
            <option value="Equipment">Equipment</option>
            <option value="Office">Office Supplies</option>
            <option value="Professional">Professional Services</option>
            <option value="Marketing">Marketing</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notes <span class="form-label-desc">(optional)</span></label>
          <textarea class="form-textarea" id="report-notes" placeholder="Add any notes or description for this report..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="report-receipts-only" checked>
            <span>Only include transactions with receipts</span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="report-ai-notes">
            <span>Generate AI expense descriptions</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="hideNewReportModal()">Cancel</button>
        <button class="btn-primary" onclick="createNewReport()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Create Report
        </button>
      </div>
    </div>
  </div>

  <!-- Export Settings Modal -->
  <div class="modal-overlay" id="export-settings-modal">
    <div class="modal large">
      <div class="modal-header">
        <div class="modal-title">Export Settings</div>
        <button class="modal-close" onclick="hideExportSettingsModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Export Name Format</label>
          <input type="text" class="form-input" id="export-name-format" value="{{business}}_{{date}}_expenses" placeholder="{{business}}_{{date}}_expenses">
          <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Available: {{business}}, {{date}}, {{month}}, {{year}}, {{report_name}}</p>
        </div>
        <div class="form-group">
          <label class="form-label">Date Format</label>
          <select class="form-select" id="export-date-format">
            <option value="YYYY-MM-DD">2024-12-15 (ISO)</option>
            <option value="MM/DD/YYYY">12/15/2024 (US)</option>
            <option value="DD/MM/YYYY">15/12/2024 (EU)</option>
            <option value="MMM DD, YYYY">Dec 15, 2024</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Currency Format</label>
          <select class="form-select" id="export-currency-format">
            <option value="symbol">$1,234.56</option>
            <option value="code">USD 1234.56</option>
            <option value="plain">1234.56</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Columns to Include</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
            <label class="form-checkbox"><input type="checkbox" checked> <span>Date</span></label>
            <label class="form-checkbox"><input type="checkbox" checked> <span>Merchant</span></label>
            <label class="form-checkbox"><input type="checkbox" checked> <span>Amount</span></label>
            <label class="form-checkbox"><input type="checkbox" checked> <span>Category</span></label>
            <label class="form-checkbox"><input type="checkbox" checked> <span>Business Type</span></label>
            <label class="form-checkbox"><input type="checkbox" checked> <span>Receipt URL</span></label>
            <label class="form-checkbox"><input type="checkbox"> <span>Transaction ID</span></label>
            <label class="form-checkbox"><input type="checkbox"> <span>Card Last 4</span></label>
            <label class="form-checkbox"><input type="checkbox" checked> <span>Notes</span></label>
            <label class="form-checkbox"><input type="checkbox"> <span>Tags</span></label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Receipt Images</label>
          <select class="form-select" id="export-receipts">
            <option value="none">Don't include</option>
            <option value="urls">Include URLs only</option>
            <option value="embedded">Embed in PDF</option>
            <option value="separate">Download separately (ZIP)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="export-subtotals" checked>
            <span>Include category subtotals</span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="export-summary">
            <span>Include summary page</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="resetExportSettings()">Reset to Defaults</button>
        <button class="btn-primary" onclick="saveExportSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div class="modal-overlay" id="schedule-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Scheduled Reports</div>
        <button class="modal-close" onclick="hideScheduleModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="schedule-card">
          <div class="schedule-info">
            <div class="schedule-icon">ðŸ“…</div>
            <div class="schedule-details">
              <h4>Monthly Report</h4>
              <p>Auto-generate on the 1st of each month</p>
            </div>
          </div>
          <div class="schedule-toggle">
            <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
          </div>
        </div>
        <div class="schedule-card">
          <div class="schedule-info">
            <div class="schedule-icon">ðŸ“Š</div>
            <div class="schedule-details">
              <h4>Quarterly Summary</h4>
              <p>Generate at end of each quarter</p>
            </div>
          </div>
          <div class="schedule-toggle">
            <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
          </div>
        </div>
        <div class="schedule-card">
          <div class="schedule-info">
            <div class="schedule-icon">ðŸ“§</div>
            <div class="schedule-details">
              <h4>Email Weekly Digest</h4>
              <p>Send spending summary every Monday</p>
            </div>
          </div>
          <div class="schedule-toggle">
            <div class="toggle-switch active" onclick="this.classList.toggle('active')"></div>
          </div>
        </div>
        <button class="btn-secondary" style="width: 100%; margin-top: 16px;" onclick="createNewSchedule()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Create New Schedule
        </button>
      </div>
    </div>
  </div>

  <!-- Templates Modal -->
  <div class="modal-overlay" id="templates-modal">
    <div class="modal large">
      <div class="modal-header">
        <div class="modal-title">Report Templates</div>
        <button class="modal-close" onclick="hideTemplatesModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="templates-grid">
          <div class="template-card featured" onclick="useTemplate('monthly')">
            <div class="template-icon">ðŸ“…</div>
            <div class="template-name">Monthly Expense Report</div>
            <div class="template-desc">Standard monthly expense report grouped by category with receipt attachments</div>
            <div class="template-meta">
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg> PDF + Excel</span>
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Monthly</span>
            </div>
          </div>
          <div class="template-card" onclick="useTemplate('quarterly')">
            <div class="template-icon">ðŸ“Š</div>
            <div class="template-name">Quarterly Summary</div>
            <div class="template-desc">Comprehensive quarterly breakdown with trends and comparisons</div>
            <div class="template-meta">
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg> PDF</span>
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Quarterly</span>
            </div>
          </div>
          <div class="template-card" onclick="useTemplate('tax')">
            <div class="template-icon">ðŸ§¾</div>
            <div class="template-name">Tax Preparation</div>
            <div class="template-desc">IRS-ready format with deductible categories and supporting docs</div>
            <div class="template-meta">
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg> PDF + CSV</span>
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Annual</span>
            </div>
          </div>
          <div class="template-card" onclick="useTemplate('reimbursement')">
            <div class="template-icon">ðŸ’µ</div>
            <div class="template-name">Reimbursement Request</div>
            <div class="template-desc">Employee expense reimbursement with approval workflow</div>
            <div class="template-meta">
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg> PDF</span>
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Approval</span>
            </div>
          </div>
          <div class="template-card" onclick="useTemplate('downhome')">
            <div class="template-icon">ðŸ </div>
            <div class="template-name">Down Home Format</div>
            <div class="template-desc">Custom format for Down Home Media accounting requirements</div>
            <div class="template-meta">
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg> Excel</span>
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Custom</span>
            </div>
          </div>
          <div class="template-card" onclick="useTemplate('mileage')">
            <div class="template-icon">ðŸš—</div>
            <div class="template-name">Mileage Report</div>
            <div class="template-desc">Vehicle mileage tracking with IRS standard rates</div>
            <div class="template-meta">
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg> PDF + CSV</span>
              <span class="template-meta-item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg> Auto-calc</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ============================================
// WORLD-CLASS REPORTS DASHBOARD
// ============================================

let dashboardData = null;
let spendingChart = null;
let categoryChart = null;
let currentTab = 'all';
let selectedExportFormat = 'downhome';

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadDashboard();
  setupEventListeners();
  setDefaultDates();
});

function setupEventListeners() {
  // Tab clicks
  document.querySelectorAll('.reports-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.reports-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentTab = tab.dataset.tab;
      renderReportsList();
    });
  });

  // Chart toggle
  document.querySelectorAll('.chart-toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.chart-toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      updateSpendingChart(btn.dataset.view);
    });
  });

  // Close modals on overlay click
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.classList.remove('visible');
      }
    });
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal-overlay.visible').forEach(m => m.classList.remove('visible'));
    }
    if (e.metaKey && e.key === 'n') {
      e.preventDefault();
      showNewReportModal();
    }
  });
}

function setDefaultDates() {
  const today = new Date();
  const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  document.getElementById('report-date-from').value = firstOfMonth.toISOString().split('T')[0];
  document.getElementById('report-date-to').value = today.toISOString().split('T')[0];
}

async function loadDashboard() {
  try {
    const response = await fetch('/api/reports/dashboard');
    if (!response.ok) throw new Error('Failed to load dashboard');
    dashboardData = await response.json();

    renderStats();
    renderCharts();
    renderBusinessBreakdown();
    renderReportsList();
  } catch (error) {
    console.error('Dashboard load error:', error);
    showErrorState();
  }
}

function renderStats() {
  const ytd = dashboardData.ytd;

  document.getElementById('stat-total-amount').textContent = formatCurrency(ytd.total_amount);
  document.getElementById('stat-report-count').textContent = ytd.report_count;
  document.getElementById('stat-reports-month').textContent = ytd.reports_this_month + ' this month';
  document.getElementById('stat-coverage').textContent = Math.round(ytd.receipt_coverage) + '%';
  document.getElementById('stat-missing').textContent = ytd.missing_receipts + ' missing receipts';
  document.getElementById('stat-pending').textContent = ytd.pending_review;
}

function renderCharts() {
  renderSpendingChart();
  renderCategoryChart();
}

function renderSpendingChart() {
  const ctx = document.getElementById('spending-chart').getContext('2d');
  const data = dashboardData.monthly_trend || [];

  if (spendingChart) spendingChart.destroy();

  const gradient = ctx.createLinearGradient(0, 0, 0, 280);
  gradient.addColorStop(0, 'rgba(0, 255, 136, 0.4)');
  gradient.addColorStop(1, 'rgba(0, 255, 136, 0)');

  spendingChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(d => d.month),
      datasets: [{
        label: 'Spending',
        data: data.map(d => d.amount),
        backgroundColor: gradient,
        borderColor: '#00ff88',
        borderWidth: 2,
        borderRadius: 8,
        barPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1f28',
          titleColor: '#fff',
          bodyColor: '#8b95a5',
          borderColor: '#333',
          borderWidth: 1,
          cornerRadius: 12,
          padding: 12,
          callbacks: {
            label: (ctx) => formatCurrency(ctx.raw)
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#5a6270', font: { size: 12 } }
        },
        y: {
          grid: { color: 'rgba(255,255,255,0.05)' },
          ticks: {
            color: '#5a6270',
            font: { size: 11 },
            callback: (v) => '$' + (v/1000).toFixed(0) + 'k'
          }
        }
      }
    }
  });
}

function updateSpendingChart(view) {
  const data = dashboardData.monthly_trend || [];
  spendingChart.data.datasets[0].data = data.map(d => view === 'count' ? d.count : d.amount);
  spendingChart.options.scales.y.ticks.callback = view === 'count'
    ? (v) => v.toLocaleString()
    : (v) => '$' + (v/1000).toFixed(0) + 'k';
  spendingChart.update();
}

function renderCategoryChart() {
  const ctx = document.getElementById('category-chart').getContext('2d');
  const data = (dashboardData.by_category || []).slice(0, 6);

  if (categoryChart) categoryChart.destroy();

  const colors = ['#00ff88', '#00cc6a', '#ffd85e', '#6eb5ff', '#ff8ea4', '#b388ff'];

  categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.map(d => d.name),
      datasets: [{
        data: data.map(d => d.amount),
        backgroundColor: colors,
        borderWidth: 0,
        spacing: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: {
          position: 'right',
          labels: {
            color: '#8b95a5',
            font: { size: 11 },
            boxWidth: 12,
            padding: 10,
            usePointStyle: true
          }
        },
        tooltip: {
          backgroundColor: '#1a1f28',
          titleColor: '#fff',
          bodyColor: '#8b95a5',
          borderColor: '#333',
          borderWidth: 1,
          cornerRadius: 12,
          callbacks: {
            label: (ctx) => ' ' + formatCurrency(ctx.raw)
          }
        }
      }
    }
  });
}

function renderBusinessBreakdown() {
  const container = document.getElementById('business-grid');
  const byBusiness = dashboardData.by_business || {};

  const total = Object.values(byBusiness).reduce((sum, b) => sum + b.total, 0);

  const businessConfig = {
    'Down Home': { class: 'dh', logo: 'DH', badge: 'dh' },
    'Music City Rodeo': { class: 'mcr', logo: 'MC', badge: 'mcr' },
    'Personal': { class: 'personal', logo: 'P', badge: 'personal' },
  };

  let html = '';
  Object.entries(byBusiness)
    .sort((a, b) => b[1].total - a[1].total)
    .forEach(([name, data]) => {
      const percent = total > 0 ? ((data.total / total) * 100).toFixed(0) : 0;
      const config = businessConfig[name] || { class: 'other', logo: name[0], badge: 'personal' };

      html += `
        <div class="business-card" onclick="filterByBusiness('${name}')">
          <div class="business-header">
            <div class="business-info">
              <div class="business-logo ${config.class}">${config.logo}</div>
              <div>
                <div class="business-name">${name}</div>
                <div class="business-type">Business Entity</div>
              </div>
            </div>
            <span class="business-badge ${config.badge}">${percent}%</span>
          </div>
          <div class="business-amount">${formatCurrency(data.total)}</div>
          <div class="business-stats">
            <div class="business-stat">
              <div class="business-stat-value">${data.count}</div>
              <div class="business-stat-label">Transactions</div>
            </div>
            <div class="business-stat">
              <div class="business-stat-value">${formatCurrency(data.total / (data.count || 1))}</div>
              <div class="business-stat-label">Avg. Amount</div>
            </div>
          </div>
          <div class="business-bar" style="width: ${percent}%"></div>
        </div>
      `;
    });

  container.innerHTML = html || '<p style="color: var(--text-muted); padding: 20px;">No business data available</p>';
}

function renderReportsList() {
  const container = document.getElementById('reports-list-container');
  let reports = dashboardData.recent_reports || [];

  // Filter by tab
  if (currentTab === 'draft') {
    reports = reports.filter(r => r.status === 'draft');
  } else if (currentTab === 'submitted') {
    reports = reports.filter(r => r.status === 'submitted');
  } else if (currentTab === 'approved') {
    reports = reports.filter(r => r.status === 'approved');
  }

  // Update counts
  const allReports = dashboardData.recent_reports || [];
  document.getElementById('tab-all-count').textContent = allReports.length;
  document.getElementById('tab-draft-count').textContent = allReports.filter(r => r.status === 'draft').length;
  document.getElementById('tab-submitted-count').textContent = allReports.filter(r => r.status === 'submitted').length;
  document.getElementById('tab-approved-count').textContent = allReports.filter(r => r.status === 'approved').length;

  if (reports.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ðŸ“Š</div>
        <div class="empty-title">No Reports Yet</div>
        <div class="empty-text">Create your first expense report to start organizing and exporting your business expenses.</div>
        <button class="btn-primary" onclick="showNewReportModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Create Your First Report
        </button>
      </div>
    `;
    return;
  }

  let html = `
    <table class="reports-table">
      <thead>
        <tr>
          <th style="width: 40px;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
          <th class="sortable">Report</th>
          <th class="sortable">Date Range</th>
          <th class="sortable">Amount</th>
          <th>Items</th>
          <th>Status</th>
          <th style="width: 120px;">Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  reports.forEach(report => {
    const statusConfig = {
      draft: { class: 'draft', text: 'Draft' },
      submitted: { class: 'submitted', text: 'Submitted' },
      approved: { class: 'approved', text: 'Approved' },
      pending: { class: 'pending', text: 'Pending' }
    };
    const status = statusConfig[report.status] || statusConfig.draft;
    const date = report.submitted_at || report.created_at;
    const formattedDate = date ? new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '-';

    html += `
      <tr onclick="viewReport('${report.report_id}')">
        <td onclick="event.stopPropagation()"><input type="checkbox" class="report-checkbox" data-id="${report.report_id}"></td>
        <td>
          <div class="report-name-cell">
            <div class="report-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <div>
              <div class="report-name">${report.name || 'Untitled Report'}</div>
              <div class="report-meta">${report.business_type || 'All Entities'}</div>
            </div>
          </div>
        </td>
        <td><span style="color: var(--text-secondary);">${formattedDate}</span></td>
        <td><span class="report-amount positive">${formatCurrency(report.total_amount)}</span></td>
        <td><span style="color: var(--text-secondary);">${report.expense_count} items</span></td>
        <td><span class="status-badge ${status.class}"><span class="status-dot"></span>${status.text}</span></td>
        <td>
          <div class="report-actions" style="opacity: 1;">
            <button class="action-btn" onclick="event.stopPropagation(); viewReport('${report.report_id}')" title="View">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
            <button class="action-btn" onclick="event.stopPropagation(); exportSingleReport('${report.report_id}')" title="Export">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            </button>
            <button class="action-btn danger" onclick="event.stopPropagation(); deleteReport('${report.report_id}')" title="Delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
        </td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// Export functions
function selectExportFormat(format) {
  selectedExportFormat = format;
  document.querySelectorAll('.export-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.format === format);
  });
}

async function runExport() {
  const format = selectedExportFormat;

  // Show loading
  const btn = document.querySelector('.export-main-actions .btn-primary');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> Exporting...';
  btn.disabled = true;

  try {
    // For bulk export, we need to select reports first or export all
    // For now, redirect to the appropriate export endpoint
    if (format === 'downhome') {
      // Down Home format - primary export format
      window.location.href = '/reports/export/downhome';
    } else if (format === 'csv') {
      window.location.href = '/reports/export/csv';
    } else if (format === 'excel') {
      window.location.href = '/reports/export/excel';
    } else if (format === 'pdf') {
      window.location.href = '/reports/export/pdf';
    } else if (format === 'zip') {
      window.location.href = '/reports/export/zip';
    } else if (format === 'qbo') {
      window.location.href = '/reports/export/qbo';
    } else if (format === 'api') {
      alert('API/Webhook Export\n\nConfigure your webhook URL in Settings to enable automatic exports.');
    } else {
      alert('Export format: ' + format + '\n\nThis will export all transactions in ' + format.toUpperCase() + ' format.');
    }
  } catch (error) {
    console.error('Export error:', error);
    alert('Export failed. Please try again.');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

function previewExport() {
  alert('Preview for ' + selectedExportFormat.toUpperCase() + ' export\n\nThis will show you a preview of the exported data before downloading.');
}

function exportSingleReport(reportId) {
  window.location.href = `/reports/${reportId}/export/downhome`;
}

// Modal functions
function showNewReportModal() {
  document.getElementById('new-report-modal').classList.add('visible');
  document.getElementById('report-name').focus();
}

function hideNewReportModal() {
  document.getElementById('new-report-modal').classList.remove('visible');
}

function showExportSettingsModal() {
  document.getElementById('export-settings-modal').classList.add('visible');
}

function hideExportSettingsModal() {
  document.getElementById('export-settings-modal').classList.remove('visible');
}

function showScheduleModal() {
  document.getElementById('schedule-modal').classList.add('visible');
}

function hideScheduleModal() {
  document.getElementById('schedule-modal').classList.remove('visible');
}

function showTemplatesModal() {
  document.getElementById('templates-modal').classList.add('visible');
}

function hideTemplatesModal() {
  document.getElementById('templates-modal').classList.remove('visible');
}

function showSettingsModal() {
  alert('Settings panel coming soon!\n\nThis will include:\n- Default export format\n- Column preferences\n- Notification settings\n- API keys');
}

function showExportModal() {
  // Scroll to export panel
  document.querySelector('.export-panel').scrollIntoView({ behavior: 'smooth' });
}

function showFilterModal() {
  alert('Filter options:\n\n- Date range\n- Business entity\n- Category\n- Amount range\n- Status');
}

function showIntegrationsModal() {
  alert('Manage integrations:\n\n- QuickBooks Online\n- Xero\n- FreshBooks\n- Google Sheets\n- Slack notifications\n- Zapier webhooks');
}

// Report functions
async function createNewReport() {
  const name = document.getElementById('report-name').value;
  const business = document.getElementById('report-business').value;
  const template = document.getElementById('report-template').value;
  const dateFrom = document.getElementById('report-date-from').value;
  const dateTo = document.getElementById('report-date-to').value;
  const receiptsOnly = document.getElementById('report-receipts-only').checked;
  const aiNotes = document.getElementById('report-ai-notes').checked;

  if (!name) {
    alert('Please enter a report name');
    document.getElementById('report-name').focus();
    return;
  }

  try {
    const response = await fetch('/api/reports', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        business_type: business === 'all' ? null : business,
        template,
        date_from: dateFrom,
        date_to: dateTo,
        receipts_only: receiptsOnly,
        ai_notes: aiNotes
      })
    });

    if (!response.ok) throw new Error('Failed to create report');

    const data = await response.json();
    hideNewReportModal();
    window.location.href = `/viewer?report=${data.report_id}`;
  } catch (error) {
    console.error('Create report error:', error);
    alert('Failed to create report. Please try again.');
  }
}

function viewReport(reportId) {
  window.location.href = `/reports/${reportId}/page`;
}

async function deleteReport(reportId) {
  if (!confirm('Are you sure you want to delete this report?\n\nThis action cannot be undone.')) return;

  try {
    const response = await fetch(`/api/reports/${reportId}`, { method: 'DELETE' });
    if (!response.ok) throw new Error('Failed to delete');
    loadDashboard();
  } catch (error) {
    console.error('Delete error:', error);
    alert('Failed to delete report');
  }
}

function filterByBusiness(businessType) {
  window.location.href = `/viewer?business=${encodeURIComponent(businessType)}`;
}

function filterReports() {
  const query = document.getElementById('search-input').value.toLowerCase();
  // Implement search filtering
  renderReportsList();
}

function toggleSort() {
  alert('Sort by:\n\n- Date (newest first)\n- Date (oldest first)\n- Amount (highest)\n- Amount (lowest)\n- Name (A-Z)');
}

function toggleSelectAll() {
  const selectAll = document.getElementById('select-all');
  document.querySelectorAll('.report-checkbox').forEach(cb => {
    cb.checked = selectAll.checked;
  });
}

function bulkExport() {
  const selected = document.querySelectorAll('.report-checkbox:checked');
  if (selected.length === 0) {
    alert('Please select at least one report to export.');
    return;
  }
  alert(`Exporting ${selected.length} selected reports...`);
}

function createQuickReport(type) {
  const today = new Date();
  let dateFrom, dateTo, name;

  if (type === 'month') {
    dateFrom = new Date(today.getFullYear(), today.getMonth(), 1);
    dateTo = today;
    name = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) + ' Expenses';
  } else if (type === 'quarter') {
    const quarter = Math.floor(today.getMonth() / 3);
    dateFrom = new Date(today.getFullYear(), quarter * 3, 1);
    dateTo = today;
    name = `Q${quarter + 1} ${today.getFullYear()} Expenses`;
  }

  document.getElementById('report-name').value = name;
  document.getElementById('report-date-from').value = dateFrom.toISOString().split('T')[0];
  document.getElementById('report-date-to').value = dateTo.toISOString().split('T')[0];
  showNewReportModal();
}

function useTemplate(templateId) {
  hideTemplatesModal();
  document.getElementById('report-template').value = templateId;
  showNewReportModal();
}

function createNewSchedule() {
  alert('Create new scheduled report:\n\n- Frequency (daily, weekly, monthly, quarterly)\n- Recipients\n- Export format\n- Filters');
}

function manageIntegration(integration) {
  alert(`Manage ${integration} integration:\n\n- Configure connection\n- Map categories\n- Set sync frequency\n- View sync history`);
}

function saveExportSettings() {
  alert('Export settings saved!');
  hideExportSettingsModal();
}

function resetExportSettings() {
  if (confirm('Reset all export settings to defaults?')) {
    alert('Settings reset to defaults.');
  }
}

function showErrorState() {
  document.getElementById('reports-list-container').innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">âš ï¸</div>
      <div class="empty-title">Unable to Load Dashboard</div>
      <div class="empty-text">There was an error loading your reports data. Please try refreshing the page.</div>
      <button class="btn-primary" onclick="location.reload()">Refresh Page</button>
    </div>
  `;
}

// Utilities
function formatCurrency(amount) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(amount || 0);
}
</script>
</body>
</html>
