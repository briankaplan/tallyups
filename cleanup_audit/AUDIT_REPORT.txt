
================================================================================
                    RECEIPT SYSTEM AUDIT REPORT
                    Generated: 2025-12-08 15:20:36
================================================================================

EXECUTIVE SUMMARY
-----------------
Total Transactions: 836
Receipts Properly Linked (R2): 677 (81%)
Needs Immediate Fix: 132 (16%)
Deleted: 4

PROBLEM BREAKDOWN
-----------------

1. LOCAL PATH REFERENCES (44 transactions)
   - Files exist locally: 12 → CAN UPLOAD TO R2
   - Files missing locally: 32 → NEED TO FIND IN R2/EMAIL
   
   Action: Upload 12 existing files, search for 32 missing

2. BROKEN R2 URLS (6 transactions)
   - Point to WRONG R2 buckets (old/deleted buckets)
   - Transactions: 404, 420, 466, 573, 639, 775
   - Merchants: Cursor, Sourcegraph (x4), Cloudflare
   
   Action: Find correct receipts in current bucket or email

3. MISSING RECEIPTS (82 transactions)
   - No receipt_url or r2_url at all
   - Many marked as review_status='good' or NULL
   
   Action: Search R2 orphans, Gmail, iMessage for matches

4. OCR MISMATCHES (43 transactions)
   - Receipt attached but OCR says WRONG receipt
   - Likely wrong image linked to transaction
   
   Action: Re-verify and find correct receipt

5. ORPHANED R2 FILES (497 files)
   - receipts/: 409 files (LOTS of potential matches!)
   - downhome/: 38 files
   - missing-receipts/: 45 files (HTML declarations)
   - soho_house/: 3 files
   
   Action: Match to transactions, delete true orphans

STORAGE SUMMARY
---------------
R2 Bucket (bkreceipts):
  - Total files: 1,233
  - Used by transactions: 744
  - Orphaned: 497
  - Total size: 446.8 MB

Local (receipts/):
  - Total files: 1,036
  - Types: .jpg (762), .pdf (145), .png (119), .jpeg (8), .heic (2)

RECOMMENDED FIX ORDER
---------------------
Phase 2: Upload 12 local files that exist → fixes 12 transactions
Phase 3: Fix 6 broken URLs → find in R2/email
Phase 4: Match orphaned R2 to 32 missing local + 82 missing receipts
Phase 5: Re-verify 43 OCR mismatches
Phase 6: Search email/SMS for any still missing
Phase 7: Clean orphaned R2 files

BACKUP FILES CREATED
--------------------
- cleanup_audit/transactions_backup_20251208_151919.csv
- cleanup_audit/incoming_receipts_backup_20251208_151919.csv
- cleanup_audit/r2_catalog_20251208_151924.json
- cleanup_audit/local_files_20251208_151926.json
- cleanup_audit/mapping_analysis.json

================================================================================
